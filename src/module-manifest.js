  "src/App.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState, lazy, Suspense } from './react.js';\nimport { QuestionnaireScreen } from './components/QuestionnaireScreen.jsx';\nimport { SynthesisReport } from './components/SynthesisReport.jsx';\nimport { HomeScreen } from './components/HomeScreen.jsx';\nimport { InspirationForm } from './components/InspirationForm.jsx';\nimport { InspirationDetail } from './components/InspirationDetail.jsx';\nimport { AnnotationLayer } from './components/AnnotationLayer.jsx';\nimport { CheckCircle, Link, Lock, MessageSquare, Settings, Sparkles } from './components/icons.js';\nimport { MandatoryQuestionsSummary } from './components/MandatoryQuestionsSummary.jsx';\nimport { initialQuestions } from './data/questions.js';\nimport { initialRules } from './data/rules.js';\nimport { initialRiskLevelRules } from './data/riskLevelRules.js';\nimport { initialRiskWeights } from './data/riskWeights.js';\nimport { initialTeams } from './data/teams.js';\nimport { initialShowcaseThemes } from './data/showcaseThemes.js';\nimport { initialInspirationProjects } from './data/inspirationProjects.js';\nimport { loadPersistedState, persistState } from './utils/storage.js';\nimport { shouldShowQuestion } from './utils/questions.js';\nimport { analyzeAnswers } from './utils/rules.js';\nimport { extractProjectName } from './utils/projects.js';\nimport { createDemoProject, demoProjectAnswersSnapshot } from './data/demoProject.js';\nimport { exportProjectToFile } from './utils/projectExport.js';\nimport { normalizeRiskWeighting } from './utils/risk.js';\nimport { normalizeProjectEntry, normalizeProjectsCollection } from './utils/projectNormalization.js';\nimport { loadSubmittedProjectsFromDirectory } from './utils/externalProjectsLoader.js';\nimport {\n  createDefaultProjectFiltersConfig,\n  normalizeProjectFilterConfig\n} from './utils/projectFilters.js';\nimport {\n  createDefaultInspirationFiltersConfig,\n  createDefaultInspirationFormConfig,\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig\n} from './utils/inspirationConfig.js';\n\nconst APP_VERSION = 'v1.0.217';\n\nconst loadModule = (modulePath) => {\n  if (typeof window === 'undefined') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  if (!window.ModuleLoader || typeof window.ModuleLoader.import !== 'function') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  return window.ModuleLoader.import(modulePath);\n};\n\nconst LazyBackOffice = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/BackOffice.jsx').BackOffice\n  }))\n);\n\nconst LazyProjectShowcase = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/ProjectShowcase.jsx').ProjectShowcase\n  }))\n);\n\nconst LoadingFallback = ({ label, hint }) => (\n  <div className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n    <div className=\"flex items-center gap-3 text-sm text-gray-600\">\n      <span className=\"loading-spinner\" aria-hidden=\"true\" />\n      <span>{label}</span>\n    </div>\n    {hint && <p className=\"mt-2 text-xs text-gray-400\">{hint}</p>}\n  </div>\n);\n\nconst ANNOTATION_COLORS = [\n  '#2563eb',\n  '#ec4899',\n  '#10b981',\n  '#f59e0b',\n  '#8b5cf6',\n  '#0ea5e9',\n  '#14b8a6',\n  '#ef4444',\n  '#ea580c'\n];\n\nconst BACK_OFFICE_PASSWORD_HASH = '3c5b8c6aaa89db61910cdfe32f1bdb193d1923146dbd6a7b0634a32ab73ac1af';\nconst BACK_OFFICE_PASSWORD_FALLBACK_DIGEST = '86ceec83';\n\nconst computeBackOfficePasswordDigest = async (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return '';\n  }\n\n  const globalCrypto =\n    typeof globalThis !== 'undefined' && typeof globalThis.crypto !== 'undefined'\n      ? globalThis.crypto\n      : undefined;\n\n  const hasSubtleCrypto =\n    !!globalCrypto?.subtle && typeof TextEncoder !== 'undefined';\n\n  if (hasSubtleCrypto) {\n    try {\n      const encoder = new TextEncoder();\n      const data = encoder.encode(value);\n      const digest = await globalCrypto.subtle.digest('SHA-256', data);\n      return Array.from(new Uint8Array(digest))\n        .map(byte => byte.toString(16).padStart(2, '0'))\n        .join('');\n    } catch (error) {\n      // Fallback defined below\n    }\n  }\n\n  let hash = 0;\n  for (let index = 0; index < value.length; index += 1) {\n    hash = (hash * 31 + value.charCodeAt(index)) >>> 0;\n  }\n\n  return hash.toString(16).padStart(8, '0');\n};\n\nconst verifyBackOfficePassword = async (value) => {\n  const digest = await computeBackOfficePasswordDigest(value);\n\n  if (!digest) {\n    return false;\n  }\n\n  if (digest.length === BACK_OFFICE_PASSWORD_HASH.length) {\n    return digest === BACK_OFFICE_PASSWORD_HASH;\n  }\n\n  return digest === BACK_OFFICE_PASSWORD_FALLBACK_DIGEST;\n};\n\nconst cloneDeep = (value) => {\n  if (value === null || value === undefined) {\n    return value;\n  }\n\n  if (typeof structuredClone === 'function') {\n    try {\n      return structuredClone(value);\n    } catch (error) {\n      // Fallback to JSON strategy below\n    }\n  }\n\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst createAnnotationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `note-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst createInspirationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `inspiration-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst buildAnnotationContextKey = ({ screen, projectId, scope }) => {\n  const base = screen === 'showcase' ? `showcase:${projectId || 'unknown'}` : screen;\n\n  if (screen === 'showcase' && scope) {\n    return `${base}:${scope}`;\n  }\n\n  return base || 'global';\n};\n\nconst restoreShowcaseQuestions = (currentQuestions, referenceQuestions = initialQuestions) => {\n  if (!Array.isArray(currentQuestions)) {\n    return referenceQuestions;\n  }\n\n  const nextQuestions = currentQuestions.slice();\n  let changed = false;\n\n  referenceQuestions.forEach((referenceQuestion, referenceIndex) => {\n    if (!referenceQuestion || !referenceQuestion.showcase) {\n      return;\n    }\n\n    const existingIndex = nextQuestions.findIndex((item) => item && item.id === referenceQuestion.id);\n\n    if (existingIndex === -1) {\n      const clonedQuestion = JSON.parse(JSON.stringify(referenceQuestion));\n      const insertionIndex = Math.min(referenceIndex, nextQuestions.length);\n      nextQuestions.splice(insertionIndex, 0, clonedQuestion);\n      changed = true;\n      return;\n    }\n\n    const existingQuestion = nextQuestions[existingIndex];\n    const existingShowcaseMeta = existingQuestion && existingQuestion.showcase;\n    const referenceShowcaseMeta = referenceQuestion.showcase;\n\n    const showcaseMetaDiffers =\n      !existingShowcaseMeta ||\n      JSON.stringify(existingShowcaseMeta) !== JSON.stringify(referenceShowcaseMeta);\n\n    if (showcaseMetaDiffers) {\n      nextQuestions[existingIndex] = {\n        ...existingQuestion,\n        showcase: JSON.parse(JSON.stringify(referenceShowcaseMeta))\n      };\n      changed = true;\n    }\n  });\n\n  return changed ? nextQuestions : currentQuestions;\n};\n\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst areAnswersEqual = (previousValue, nextValue) => {\n  if (previousValue === nextValue) {\n    return true;\n  }\n\n  if (Array.isArray(previousValue) && Array.isArray(nextValue)) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      if (previousValue.length !== nextValue.length) {\n        return false;\n      }\n      return previousValue.every((entry, index) => entry === nextValue[index]);\n    }\n  }\n\n  if (\n    previousValue &&\n    nextValue &&\n    typeof previousValue === 'object' &&\n    typeof nextValue === 'object'\n  ) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      return false;\n    }\n  }\n\n  return false;\n};\n\nconst findQuestionById = (questions, id) => {\n  if (!Array.isArray(questions)) {\n    return null;\n  }\n\n  return questions.find(question => question?.id === id) || null;\n};\n\nconst normalizeMilestoneListValue = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0)\n    .map(entry => ({\n      date: entry.date,\n      description: entry.description\n    }));\n};\n\nconst areMilestoneListsEqual = (previousValue, nextValue) => {\n  if (previousValue.length !== nextValue.length) {\n    return false;\n  }\n\n  return previousValue.every((entry, index) => {\n    const nextEntry = nextValue[index];\n    if (!nextEntry) {\n      return false;\n    }\n\n    return entry.date === nextEntry.date && entry.description === nextEntry.description;\n  });\n};\n\nconst applyAnswerUpdates = (\n  prevAnswers = {},\n  updates,\n  questions,\n  predicate,\n  options = {}\n) => {\n  if (!updates || typeof updates !== 'object') {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const entries = Object.entries(updates);\n  if (entries.length === 0) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const nextAnswers = { ...prevAnswers };\n  let changed = false;\n\n  entries.forEach(([questionId, value]) => {\n    if (!questionId) {\n      return;\n    }\n\n    const question = findQuestionById(questions, questionId);\n    const questionType = question?.type;\n\n    if (questionType === 'milestone_list') {\n      const normalizedValue = normalizeMilestoneListValue(value);\n      const previousRawValue = nextAnswers[questionId];\n      const previousValue = Array.isArray(previousRawValue)\n        ? normalizeMilestoneListValue(previousRawValue)\n        : [];\n      const previousRawJson = JSON.stringify(Array.isArray(previousRawValue) ? previousRawValue : []);\n      const normalizedJson = JSON.stringify(normalizedValue);\n\n      if (normalizedValue.length > 0) {\n        if (!areMilestoneListsEqual(previousValue, normalizedValue) || previousRawJson !== normalizedJson) {\n          changed = true;\n          nextAnswers[questionId] = normalizedValue;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (Array.isArray(value)) {\n      const filtered = value\n        .map(item => (typeof item === 'string' ? item.trim() : item))\n        .filter(item => {\n          if (typeof item === 'string') {\n            return item.length > 0;\n          }\n          return item !== null && item !== undefined;\n        });\n\n      const previousValue = nextAnswers[questionId];\n      const arraysAreEqual = Array.isArray(previousValue)\n        && previousValue.length === filtered.length\n        && previousValue.every((item, index) => item === filtered[index]);\n\n      if (filtered.length > 0) {\n        if (!arraysAreEqual) {\n          changed = true;\n        }\n        nextAnswers[questionId] = filtered;\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (value === null || value === undefined) {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length > 0) {\n        if (nextAnswers[questionId] !== value) {\n          changed = true;\n          nextAnswers[questionId] = value;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (nextAnswers[questionId] !== value) {\n      changed = true;\n      nextAnswers[questionId] = value;\n    }\n  });\n\n  if (!changed) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const canEvaluatePredicate = typeof predicate === 'function';\n  const shouldPreserveQuestion = typeof options.shouldPreserveQuestion === 'function'\n    ? options.shouldPreserveQuestion\n    : null;\n  const questionsToRemove = Array.isArray(questions) && canEvaluatePredicate\n    ? questions\n        .filter(question => {\n          if (!question || !question.id) {\n            return false;\n          }\n\n          const wasVisible = predicate(question, prevAnswers);\n          const isVisible = predicate(question, nextAnswers);\n\n          if (isVisible) {\n            return false;\n          }\n\n          if (shouldPreserveQuestion && shouldPreserveQuestion(question, {\n            prevAnswers,\n            nextAnswers\n          })) {\n            return false;\n          }\n\n          if (wasVisible) {\n            return true;\n          }\n\n          return isAnswerProvided(nextAnswers[question.id]) || isAnswerProvided(prevAnswers[question.id]);\n        })\n        .map(question => question.id)\n    : [];\n\n  if (questionsToRemove.length > 0) {\n    questionsToRemove.forEach(questionId => {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n    });\n  }\n\n  return { nextAnswers, changed };\n};\n\nconst resolveFallbackQuestionsLength = (savedState, currentQuestionsLength = initialQuestions.length) => {\n  if (savedState && Array.isArray(savedState.questions) && savedState.questions.length > 0) {\n    return savedState.questions.length;\n  }\n\n  return currentQuestionsLength;\n};\n\nconst buildInitialProjectsState = () => {\n  const savedState = loadPersistedState();\n\n  if (!savedState) {\n    return [createDemoProject()];\n  }\n\n  const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : initialQuestions;\n  const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : initialRules;\n  const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n    ? savedState.riskLevelRules\n    : initialRiskLevelRules;\n  const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n    ? normalizeRiskWeighting(savedState.riskWeights)\n    : initialRiskWeights;\n  const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n  const normalizedProjects = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength)\n    || normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n\n  if (normalizedProjects && normalizedProjects.length > 0) {\n    return normalizedProjects;\n  }\n\n  return [createDemoProject({\n    questions: fallbackQuestions,\n    rules: fallbackRules,\n    riskLevelRules: fallbackRiskLevelRules,\n    riskWeights: fallbackRiskWeights\n  })];\n};\n\nconst buildInitialInspirationProjectsState = () => {\n  const savedState = loadPersistedState();\n  if (savedState && Array.isArray(savedState.inspirationProjects)) {\n    return cloneDeep(savedState.inspirationProjects);\n  }\n\n  return cloneDeep(initialInspirationProjects);\n};\n\nconst isOnboardingProject = (project) => {\n  if (!project || typeof project !== 'object') {\n    return false;\n  }\n\n  const { id } = project;\n  if (typeof id !== 'string' || id.length === 0) {\n    return false;\n  }\n\n  return id === 'onboarding-demo' || id.startsWith('tour-');\n};\n\nconst sanitizeRestoredProjects = (projects) => {\n  if (!Array.isArray(projects)) {\n    return [];\n  }\n\n  const restored = projects.filter(project => !isOnboardingProject(project));\n\n  if (restored.length === 0) {\n    return [];\n  }\n\n  return cloneDeep(restored);\n};\n\nexport const App = () => {\n  const [mode, setMode] = useState('user');\n  const [screen, setScreen] = useState('home');\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [answers, setAnswers] = useState({});\n  const [analysis, setAnalysis] = useState(null);\n  const [projects, setProjects] = useState(buildInitialProjectsState);\n  const projectsRef = useRef(projects);\n  const [inspirationProjects, setInspirationProjects] = useState(buildInitialInspirationProjectsState);\n  const [activeInspirationId, setActiveInspirationId] = useState(null);\n  const [activeProjectId, setActiveProjectId] = useState(null);\n  const [validationError, setValidationError] = useState(null);\n  const [saveFeedback, setSaveFeedback] = useState(null);\n  const [showcaseProjectContext, setShowcaseProjectContext] = useState(null);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  const [returnToSynthesisAfterEdit, setReturnToSynthesisAfterEdit] = useState(false);\n  const [isOnboardingActive, setIsOnboardingActive] = useState(false);\n  const [onboardingStepId, setOnboardingStepId] = useState(null);\n  const [isTourGuideReady, setIsTourGuideReady] = useState(false);\n  const tourInstanceRef = useRef(null);\n  const onboardingStateRef = useRef(null);\n  const onboardingDemoDataRef = useRef(null);\n  const isOnboardingActiveRef = useRef(false);\n\n  const [questions, setQuestions] = useState(() => restoreShowcaseQuestions(initialQuestions));\n  const [rules, setRules] = useState(initialRules);\n  const [riskLevelRules, setRiskLevelRules] = useState(initialRiskLevelRules);\n  const [riskWeights, setRiskWeights] = useState(() => normalizeRiskWeighting(initialRiskWeights));\n  const [teams, setTeams] = useState(initialTeams);\n  const [showcaseThemes, setShowcaseThemes] = useState(initialShowcaseThemes);\n  const [projectFilters, setProjectFiltersState] = useState(() => createDefaultProjectFiltersConfig());\n  const [inspirationFilters, setInspirationFilters] = useState(() => createDefaultInspirationFiltersConfig());\n  const [inspirationFormFields, setInspirationFormFields] = useState(() => createDefaultInspirationFormConfig());\n  const [homeView, setHomeView] = useState('platform');\n  const [isHydrated, setIsHydrated] = useState(false);\n  const [isBackOfficeUnlocked, setIsBackOfficeUnlocked] = useState(false);\n  const [backOfficeAuthError, setBackOfficeAuthError] = useState(null);\n  const [isBackOfficePromptOpen, setIsBackOfficePromptOpen] = useState(false);\n  const [backOfficePromptValue, setBackOfficePromptValue] = useState('');\n  const [backOfficePromptError, setBackOfficePromptError] = useState('');\n  const backOfficePromptResolverRef = useRef(null);\n  const [adminView, setAdminView] = useState('home');\n  const persistTimeoutRef = useRef(null);\n  const previousScreenRef = useRef(null);\n  const [isAnnotationModeEnabled, setIsAnnotationModeEnabled] = useState(false);\n  const [isAnnotationPaused, setIsAnnotationPaused] = useState(false);\n  const [annotationNotes, setAnnotationNotes] = useState([]);\n  const [annotationSources, setAnnotationSources] = useState({ session: ANNOTATION_COLORS[0] });\n  const [showcaseAnnotationScope, setShowcaseAnnotationScope] = useState('display-full');\n  const [autoFocusAnnotationId, setAutoFocusAnnotationId] = useState(null);\n  const [isShowcaseEditing, setIsShowcaseEditing] = useState(false);\n  const [isShowcaseShareOpen, setIsShowcaseShareOpen] = useState(false);\n  const [showcaseShareFeedback, setShowcaseShareFeedback] = useState('');\n  const annotationNotesRef = useRef(annotationNotes);\n  const annotationFileInputRef = useRef(null);\n  const loadedStylesRef = useRef(new Set());\n  const pendingShowcaseProjectIdRef = useRef(null);\n\n  const ensureStylesheetLoaded = useCallback((href) => {\n    if (typeof document === 'undefined' || !href) {\n      return;\n    }\n\n    if (loadedStylesRef.current.has(href)) {\n      return;\n    }\n\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = href;\n    link.dataset.dynamic = 'true';\n    document.head.appendChild(link);\n    loadedStylesRef.current.add(href);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleBeforeUnload = (event) => {\n      if (!hasUnsavedChanges) {\n        return undefined;\n      }\n\n      const message = 'Avez-vous bien sauvegardé votre projet avant de quitter ?';\n      event.preventDefault();\n      event.returnValue = message;\n      return message;\n    };\n\n    window.addEventListener('beforeunload', handleBeforeUnload);\n\n    return () => {\n      window.removeEventListener('beforeunload', handleBeforeUnload);\n    };\n  }, [hasUnsavedChanges]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const { search, hash } = window.location;\n    const params = new URLSearchParams(search || '');\n    let projectId = params.get('projectId') || params.get('showcase');\n\n    if (!projectId && typeof hash === 'string' && hash.length > 1) {\n      const normalizedHash = hash.slice(1);\n      if (normalizedHash.startsWith('showcase=')) {\n        projectId = normalizedHash.replace(/^showcase=/, '');\n      } else if (normalizedHash.startsWith('showcase:')) {\n        projectId = normalizedHash.replace(/^showcase:/, '');\n      }\n    }\n\n    if (projectId) {\n      pendingShowcaseProjectIdRef.current = projectId;\n    }\n  }, []);\n\n  useEffect(() => {\n    projectsRef.current = projects;\n  }, [projects]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    ensureStylesheetLoaded('./src/styles/project-showcase.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-aurora.css');\n  }, [ensureStylesheetLoaded, showcaseProjectContext]);\n\n  useEffect(() => {\n    annotationNotesRef.current = annotationNotes;\n  }, [annotationNotes]);\n\n  useEffect(() => {\n    isOnboardingActiveRef.current = isOnboardingActive;\n  }, [isOnboardingActive]);\n\n  useEffect(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      if (!Array.isArray(prevProjects) || prevProjects.length === 0) {\n        return prevProjects;\n      }\n\n      const containsOnboardingProjects = prevProjects.some(isOnboardingProject);\n      if (!containsOnboardingProjects) {\n        return prevProjects;\n      }\n\n      const sanitizedProjects = prevProjects.filter(project => !isOnboardingProject(project));\n\n      if (sanitizedProjects.length === 0) {\n        return buildInitialProjectsState();\n      }\n\n      return cloneDeep(sanitizedProjects);\n    });\n  }, [isOnboardingActive, setProjects]);\n\n  useEffect(() => {\n    if (mode !== 'admin') {\n      setAdminView('home');\n    }\n  }, [mode]);\n\nconst updateProjectFilters = useCallback((updater) => {\n  setProjectFiltersState(prevConfig => {\n    const currentConfig = normalizeProjectFilterConfig(prevConfig);\n    const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n    return normalizeProjectFilterConfig(nextConfig);\n  });\n}, []);\n\n  const updateInspirationFilters = useCallback((updater) => {\n    setInspirationFilters(prevConfig => {\n      const currentConfig = normalizeInspirationFiltersConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFiltersConfig(nextConfig);\n    });\n  }, []);\n\n  const updateInspirationFormFields = useCallback((updater) => {\n    setInspirationFormFields(prevConfig => {\n      const currentConfig = normalizeInspirationFormConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFormConfig(nextConfig);\n    });\n  }, []);\n\n  useEffect(() => {\n    if (!Array.isArray(showcaseThemes) || showcaseThemes.length === 0) {\n      return;\n    }\n\n    setQuestions((previousQuestions) => {\n      const nextQuestions = Array.isArray(previousQuestions)\n        ? previousQuestions.slice()\n        : [];\n      const themeQuestionIndex = nextQuestions.findIndex(question => question?.id === 'showcaseTheme');\n\n      if (themeQuestionIndex === -1) {\n        return previousQuestions;\n      }\n\n      const themeOptions = showcaseThemes\n        .map(theme => (typeof theme?.label === 'string' && theme.label.trim().length > 0\n          ? theme.label.trim()\n          : typeof theme?.id === 'string'\n            ? theme.id\n            : ''))\n        .filter(option => option.length > 0);\n\n      const existingOptions = Array.isArray(nextQuestions[themeQuestionIndex]?.options)\n        ? nextQuestions[themeQuestionIndex].options\n        : [];\n\n      if (\n        themeOptions.length === existingOptions.length &&\n        themeOptions.every((option, index) => option === existingOptions[index])\n      ) {\n        return previousQuestions;\n      }\n\n      const existingThemeQuestion = nextQuestions[themeQuestionIndex] || {};\n\n      nextQuestions[themeQuestionIndex] = {\n        ...existingThemeQuestion,\n        options: themeOptions\n      };\n\n      return nextQuestions;\n    });\n  }, [setQuestions, showcaseThemes]);\n\n  const synchronizeExternalProjects = useCallback(async () => {\n    const existingProjects = Array.isArray(projectsRef.current) ? projectsRef.current : [];\n\n    const fallbackQuestionsLength = questions.length;\n\n    const externalProjects = await loadSubmittedProjectsFromDirectory({\n      questions,\n      rules,\n      riskLevelRules,\n      riskWeights,\n      fallbackQuestionsLength,\n      existingProjects\n    });\n\n    const externalSources = new Set(externalProjects.map(entry => entry.sourceId));\n\n    setProjects(prevProjects => {\n      const baseProjects = Array.isArray(prevProjects) ? prevProjects : [];\n      const preserved = baseProjects.filter(project => (\n        !project?.externalSourceId || externalSources.has(project.externalSourceId)\n      ));\n\n      const bySource = new Map();\n      preserved.forEach(project => {\n        if (project && project.externalSourceId) {\n          bySource.set(project.externalSourceId, project);\n        }\n      });\n\n      let changed = preserved.length !== baseProjects.length;\n      const nextProjects = preserved.slice();\n\n      externalProjects.forEach(entry => {\n        const { project, sourceId, checksum } = entry;\n        if (!project || !sourceId) {\n          return;\n        }\n\n        const existing = bySource.get(sourceId);\n        if (!existing) {\n          nextProjects.push(project);\n          changed = true;\n          return;\n        }\n\n        const existingChecksum = existing.externalSourceChecksum;\n        if (existingChecksum && existingChecksum === checksum) {\n          return;\n        }\n\n        const index = nextProjects.findIndex(item => item?.externalSourceId === sourceId);\n        if (index !== -1) {\n          nextProjects[index] = project;\n        } else {\n          nextProjects.push(project);\n        }\n        changed = true;\n      });\n\n      return changed ? nextProjects : baseProjects;\n    });\n  }, [questions, riskLevelRules, riskWeights, rules]);\n\n  useEffect(() => {\n    const loadExternal = async () => {\n      try {\n        await synchronizeExternalProjects();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('Impossible de synchroniser les projets externes :', error);\n        }\n      }\n    };\n\n    loadExternal();\n  }, [synchronizeExternalProjects]);\n\n  useEffect(() => {\n    const savedState = loadPersistedState();\n    if (!savedState) {\n      setIsHydrated(true);\n      return;\n    }\n\n    const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : questions;\n    const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : rules;\n    const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n      ? savedState.riskLevelRules\n      : riskLevelRules;\n    const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n      ? normalizeRiskWeighting(savedState.riskWeights)\n      : riskWeights;\n    const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n    if (savedState.mode === 'admin') {\n      setMode('user');\n    } else if (savedState.mode) {\n      setMode(savedState.mode);\n    }\n    if (savedState.screen) setScreen(savedState.screen);\n    if (typeof savedState.currentQuestionIndex === 'number' && savedState.currentQuestionIndex >= 0) {\n      setCurrentQuestionIndex(savedState.currentQuestionIndex);\n    }\n    if (savedState.answers && typeof savedState.answers === 'object') setAnswers(savedState.answers);\n    if (typeof savedState.analysis !== 'undefined') setAnalysis(savedState.analysis);\n    if (Array.isArray(savedState.projects)) {\n      const normalized = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    } else if (Array.isArray(savedState.submittedProjects)) {\n      const normalized = normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    }\n    if (typeof savedState.activeProjectId === 'string') setActiveProjectId(savedState.activeProjectId);\n    if (typeof savedState.activeInspirationId === 'string') setActiveInspirationId(savedState.activeInspirationId);\n    if (typeof savedState.homeView === 'string') setHomeView(savedState.homeView);\n    if (Array.isArray(savedState.questions)) {\n      setQuestions(restoreShowcaseQuestions(savedState.questions));\n    }\n    if (Array.isArray(savedState.rules)) setRules(savedState.rules);\n    if (Array.isArray(savedState.riskLevelRules)) setRiskLevelRules(savedState.riskLevelRules);\n    if (savedState && typeof savedState.riskWeights === 'object') {\n      setRiskWeights(normalizeRiskWeighting(savedState.riskWeights));\n    }\n    if (Array.isArray(savedState.teams)) setTeams(savedState.teams);\n    if (Array.isArray(savedState.showcaseThemes)) setShowcaseThemes(savedState.showcaseThemes);\n    if (savedState && typeof savedState.projectFilters === 'object') {\n      setProjectFiltersState(normalizeProjectFilterConfig(savedState.projectFilters));\n    }\n    if (Array.isArray(savedState.inspirationProjects)) {\n      setInspirationProjects(cloneDeep(savedState.inspirationProjects));\n    }\n    if (savedState && typeof savedState.inspirationFilters === 'object') {\n      setInspirationFilters(normalizeInspirationFiltersConfig(savedState.inspirationFilters));\n    }\n    if (savedState && typeof savedState.inspirationFormFields === 'object') {\n      setInspirationFormFields(normalizeInspirationFormConfig(savedState.inspirationFormFields));\n    }\n\n    setIsHydrated(true);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    let disposed = false;\n\n    const updateStatus = () => {\n      if (disposed) {\n        return;\n      }\n      setIsTourGuideReady(Boolean(window.TourGuideClient));\n    };\n\n    updateStatus();\n\n    if (window.TourGuideClient) {\n      return () => {\n        disposed = true;\n      };\n    }\n\n    const intervalId = window.setInterval(() => {\n      if (window.TourGuideClient) {\n        updateStatus();\n        window.clearInterval(intervalId);\n      }\n    }, 500);\n\n    return () => {\n      disposed = true;\n      window.clearInterval(intervalId);\n    };\n  }, []);\n\n  const noop = useCallback(() => {}, []);\n\n  const computeDemoData = useCallback(() => {\n    const answers = cloneDeep(demoProjectAnswersSnapshot) || {};\n    const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n    const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    const relevantTeamsList = Array.isArray(teams)\n      ? teams.filter(team => (analysisResult?.teams || []).includes(team.id))\n      : [];\n    const timelineDetails = analysisResult?.timeline?.details || [];\n    const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n      ? answers.projectName.trim()\n      : 'Projet de démonstration';\n\n    return {\n      answers,\n      analysis: analysisResult,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      projectName,\n      relevantTeams: relevantTeamsList,\n      timelineDetails\n    };\n  }, [questions, riskLevelRules, riskWeights, rules, shouldShowQuestion, teams]);\n\n  const getDemoData = useCallback(() => {\n    if (!onboardingDemoDataRef.current) {\n      onboardingDemoDataRef.current = computeDemoData();\n    }\n\n    return onboardingDemoDataRef.current;\n  }, [computeDemoData]);\n\n  const buildOnboardingProjects = useCallback((demoData) => {\n    const baseAnswers = cloneDeep(demoData?.answers || demoProjectAnswersSnapshot || {});\n    const now = Date.now();\n\n    const createEntry = (config) => {\n      const offsetMs = typeof config.offsetMs === 'number' ? config.offsetMs : 0;\n      const timestamp = config.timestamp || new Date(now - offsetMs).toISOString();\n      const answersPatch = config.answers || {};\n      const answers = cloneDeep({ ...baseAnswers, ...answersPatch });\n      if (config.projectName) {\n        answers.projectName = config.projectName;\n      }\n\n      const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n        ? answers.projectName.trim()\n        : 'Projet sans nom';\n\n      const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n      const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n      const totalQuestions = visibleQuestions.length > 0 ? visibleQuestions.length : questions.length;\n      const answeredQuestions = visibleQuestions.filter(question => isAnswerProvided(answers[question.id])).length;\n      const status = config.status || 'draft';\n\n      return {\n        id: config.id,\n        projectName,\n        answers,\n        analysis: analysisResult,\n        status,\n        lastUpdated: config.lastUpdated || timestamp,\n        generatedAt: config.generatedAt || timestamp,\n        submittedAt: status === 'submitted' ? (config.submittedAt || timestamp) : undefined,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex:\n          typeof config.lastQuestionIndex === 'number'\n            ? config.lastQuestionIndex\n            : (status === 'submitted' && totalQuestions > 0\n              ? totalQuestions - 1\n              : Math.max(totalQuestions - 2, 0)),\n        isDemo: true\n      };\n    };\n\n    return [\n      createEntry({\n        id: 'tour-draft-1',\n        projectName: 'Atlas Connect',\n        status: 'draft',\n        offsetMs: 86400000,\n        answers: {\n          teamLead: 'Léa Martin',\n          teamLeadTeam: 'Digital'\n        }\n      }),\n      createEntry({\n        id: 'tour-submitted',\n        projectName: 'Pulse Live',\n        status: 'submitted',\n        offsetMs: 432000000,\n        answers: {\n          teamLead: 'Noah Carpentier',\n          teamLeadTeam: 'Marketing'\n        }\n      }),\n      createEntry({\n        id: 'tour-draft-demo',\n        projectName: demoData?.projectName || 'Plasma 360',\n        status: 'draft',\n        offsetMs: 172800000,\n        answers: {}\n      })\n    ];\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const restoreOnboardingSnapshot = useCallback(() => {\n    const snapshot = onboardingStateRef.current;\n    onboardingStateRef.current = null;\n    onboardingDemoDataRef.current = null;\n\n    if (!snapshot) {\n      setMode('user');\n      setAdminView('home');\n      setScreen('home');\n      setAnswers({});\n      setAnalysis(null);\n      setProjects(buildInitialProjectsState());\n      setProjectFiltersState(createDefaultProjectFiltersConfig());\n      setCurrentQuestionIndex(0);\n      setValidationError(null);\n      setSaveFeedback(null);\n      setActiveProjectId(null);\n      setShowcaseProjectContext(null);\n      setHasUnsavedChanges(false);\n      setBackOfficeAuthError(null);\n      setIsBackOfficeUnlocked(false);\n      return;\n    }\n\n    setMode(snapshot.mode || 'user');\n    setAdminView(snapshot.adminView || 'home');\n    setScreen(snapshot.screen || 'home');\n    setAnswers(snapshot.answers || {});\n    setAnalysis(typeof snapshot.analysis !== 'undefined' ? snapshot.analysis : null);\n    const restoredProjects = sanitizeRestoredProjects(snapshot.projects);\n    setProjects(\n      restoredProjects.length > 0\n        ? restoredProjects\n        : buildInitialProjectsState()\n    );\n    setProjectFiltersState(\n      snapshot.projectFilters\n        ? normalizeProjectFilterConfig(snapshot.projectFilters)\n        : createDefaultProjectFiltersConfig()\n    );\n    setCurrentQuestionIndex(\n      typeof snapshot.currentQuestionIndex === 'number' && snapshot.currentQuestionIndex >= 0\n        ? snapshot.currentQuestionIndex\n        : 0\n    );\n    setValidationError(snapshot.validationError || null);\n    setSaveFeedback(snapshot.saveFeedback || null);\n    setActiveProjectId(typeof snapshot.activeProjectId === 'string' ? snapshot.activeProjectId : null);\n    setShowcaseProjectContext(snapshot.showcaseProjectContext || null);\n    setHasUnsavedChanges(Boolean(snapshot.hasUnsavedChanges));\n    setBackOfficeAuthError(snapshot.backOfficeAuthError || null);\n    setIsBackOfficeUnlocked(Boolean(snapshot.isBackOfficeUnlocked));\n  }, [\n    setActiveProjectId,\n    setAdminView,\n    setAnalysis,\n    setAnswers,\n    setBackOfficeAuthError,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setIsBackOfficeUnlocked,\n    setMode,\n    setProjectFiltersState,\n    setProjects,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const finishOnboarding = useCallback((options = {}) => {\n    const { shouldLoadIndex = false } = options || {};\n    const snapshotExists = Boolean(onboardingStateRef.current);\n    const wasOnboardingActive = isOnboardingActiveRef.current;\n\n    if (!wasOnboardingActive && !snapshotExists) {\n      return;\n    }\n\n    isOnboardingActiveRef.current = false;\n    setIsOnboardingActive(false);\n    setOnboardingStepId(null);\n\n    const tourInstance = tourInstanceRef.current;\n    tourInstanceRef.current = null;\n\n    if (tourInstance && typeof tourInstance.stop === 'function') {\n      try {\n        tourInstance.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Impossible de stopper le guide :', error);\n        }\n      }\n    }\n\n    if (snapshotExists) {\n      restoreOnboardingSnapshot();\n    }\n\n    if (shouldLoadIndex && typeof window !== 'undefined') {\n      const redirect = () => {\n        try {\n          if (window.location) {\n            if (typeof window.location.assign === 'function') {\n              window.location.assign('./index.html');\n            } else {\n              window.location.href = './index.html';\n            }\n          }\n        } catch (error) {\n          if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n            console.warn('[Onboarding] Impossible de charger la page d\\'accueil :', error);\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => redirect());\n      } else if (typeof window.setTimeout === 'function') {\n        window.setTimeout(() => redirect(), 0);\n      }\n    }\n  }, [restoreOnboardingSnapshot]);\n\n  const handleOnboardingStepEnter = useCallback((stepId) => {\n    if (!stepId) {\n      return;\n    }\n\n    const demoData = getDemoData();\n\n    const openDemoShowcase = () => {\n      openProjectShowcase({\n        projectId: null,\n        projectName: demoData.projectName,\n        answers: cloneDeep(demoData.answers),\n        analysis: demoData.analysis,\n        relevantTeams: demoData.relevantTeams,\n        questions: demoData.questions,\n        timelineDetails: demoData.timelineDetails,\n        status: 'draft'\n      });\n      setHasUnsavedChanges(false);\n    };\n\n    const ensureShowcaseTopVisible = () => {\n      if (typeof window === 'undefined') {\n        return;\n      }\n\n      const scrollToTop = () => {\n        try {\n          if (typeof document !== 'undefined') {\n            const topSection = document.querySelector('[data-tour-id=\"showcase-preview\"]');\n            if (topSection && typeof topSection.scrollIntoView === 'function') {\n              topSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });\n              return;\n            }\n          }\n\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n          }\n        } catch (error) {\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0 });\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => {\n          if (typeof window.setTimeout === 'function') {\n            window.setTimeout(scrollToTop, 0);\n          } else {\n            scrollToTop();\n          }\n        });\n        return;\n      }\n\n      if (typeof window.setTimeout === 'function') {\n        window.setTimeout(scrollToTop, 0);\n        return;\n      }\n\n      scrollToTop();\n    };\n\n    switch (stepId) {\n      case 'welcome':\n      case 'create-project': {\n        setScreen('home');\n        setShowcaseProjectContext(null);\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'question-overview':\n      case 'question-guidance':\n      case 'project-save-anytime': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setCurrentQuestionIndex(0);\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'questionnaire-finish': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        const totalQuestionsCount = Array.isArray(demoData.questions) && demoData.questions.length > 0\n          ? demoData.questions.length\n          : questions.length;\n        const lastIndex = totalQuestionsCount > 0 ? totalQuestionsCount - 1 : 0;\n        setCurrentQuestionIndex(lastIndex);\n        break;\n      }\n      case 'compliance-report-top':\n      case 'compliance-teams':\n      case 'compliance-risks':\n      case 'compliance-submit':\n      case 'compliance-save':\n      case 'compliance-showcase-button': {\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(demoData.analysis);\n        setCurrentQuestionIndex(0);\n        setValidationError(null);\n        setScreen('synthesis');\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'showcase-top': {\n        openDemoShowcase();\n        ensureShowcaseTopVisible();\n        break;\n      }\n      case 'showcase-bottom':\n      case 'showcase-edit-trigger':\n      case 'showcase-edit':\n      case 'showcase-save-edits':\n      case 'showcase-back-to-report': {\n        openDemoShowcase();\n        break;\n      }\n      case 'project-import':\n      case 'project-filters': {\n        setShowcaseProjectContext(null);\n        setScreen('home');\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      default:\n        break;\n    }\n  }, [\n    getDemoData,\n    openProjectShowcase,\n    screen,\n    questions,\n    setActiveProjectId,\n    setAnalysis,\n    setAnswers,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const handleStartOnboarding = useCallback(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    if (typeof window === 'undefined' || typeof window.TourGuideClient !== 'function') {\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Le guide interactif est momentanément indisponible.');\n      }\n      return;\n    }\n\n    onboardingStateRef.current = {\n      mode,\n      screen,\n      adminView,\n      answers: cloneDeep(answers),\n      analysis: cloneDeep(analysis),\n      projects: cloneDeep(projects),\n      projectFilters: cloneDeep(projectFilters),\n      currentQuestionIndex,\n      validationError: cloneDeep(validationError),\n      saveFeedback: cloneDeep(saveFeedback),\n      activeProjectId,\n      showcaseProjectContext: cloneDeep(showcaseProjectContext),\n      hasUnsavedChanges,\n      backOfficeAuthError,\n      isBackOfficeUnlocked\n    };\n\n    const demoData = getDemoData();\n    onboardingDemoDataRef.current = demoData;\n    const onboardingProjects = buildOnboardingProjects(demoData);\n\n    isOnboardingActiveRef.current = true;\n    setIsOnboardingActive(true);\n    setOnboardingStepId(null);\n    setMode('user');\n    setAdminView('home');\n    setScreen('home');\n    setShowcaseProjectContext(null);\n    setActiveProjectId(null);\n    setAnswers({});\n    setAnalysis(null);\n    setValidationError(null);\n    setSaveFeedback(null);\n    setHasUnsavedChanges(false);\n    setBackOfficeAuthError(null);\n    setIsBackOfficeUnlocked(false);\n    setProjects(onboardingProjects);\n    setProjectFiltersState(createDefaultProjectFiltersConfig());\n\n    const steps = [\n      {\n        id: 'welcome',\n        target: '#tour-onboarding-anchor',\n        title: 'Bienvenue sur Project Navigator',\n        content: 'Découvrons ensemble comment cadrer votre projet pas à pas.'\n      },\n      {\n        id: 'create-project',\n        target: '[data-tour-id=\"home-create-project\"]',\n        title: 'Lancer un nouveau projet',\n        content: 'Cliquez ici pour démarrer. Nous allons utiliser un projet de démonstration pour l’exemple.',\n        placement: 'bottom'\n      },\n      {\n        id: 'question-overview',\n        target: '[data-tour-id=\"question-main-content\"]',\n        title: 'Répondre aux questions',\n        content: 'Renseignez les informations demandées étape par étape pour qualifier votre initiative.'\n      },\n      {\n        id: 'question-guidance',\n        target: '[data-tour-id=\"question-guidance-toggle\"]',\n        title: 'Comprendre chaque question',\n        content: 'Chaque étape propose des conseils contextualisés pour répondre sereinement.'\n      },\n      {\n        id: 'project-save-anytime',\n        target: '[data-tour-id=\"question-save-draft\"]',\n        title: 'Sauvegarder à tout moment',\n        content: \"Téléchargez un brouillon de votre projet quand vous le souhaitez et rechargez-le depuis l’accueil. Attention, il n'y a pas de sauvegarde automatique.\"\n      },\n      {\n        id: 'questionnaire-finish',\n        target: '[data-tour-id=\"questionnaire-finish\"]',\n        title: 'Fin du formulaire',\n        content: 'Sur la dernière question, cliquez sur “Voir la synthèse” pour accéder au rapport complet.'\n      },\n      {\n        id: 'compliance-report-top',\n        target: '[data-tour-id=\"synthesis-summary\"]',\n        title: 'Lire le rapport de compliance',\n        content: \"Retrouvez ici le résumé du projet avec l'ensemble des informations que vous avez remplies. Vous pouvez revenir en arrière pour les modifier.\",\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'start',\n          inline: 'nearest'\n        }\n      },\n      {\n        id: 'compliance-teams',\n        target: '[data-tour-id=\"synthesis-teams\"]',\n        title: 'Identifier les équipes compliance',\n        content: 'Visualisez les interlocuteurs clés, leurs priorités et les questions à anticiper pour préparer vos échanges.'\n      },\n      {\n        id: 'compliance-risks',\n        target: '[data-tour-id=\"synthesis-risks\"]',\n        title: 'Risques et points de vigilance',\n        content: 'Analysez les risques identifiés et les points de vigilance compliance à adresser en priorité.'\n      },\n      {\n        id: 'compliance-submit',\n        target: '[data-tour-id=\"synthesis-submit\"]',\n        title: 'Soumettre le projet',\n        content: 'Envoyez votre rapport directement par e-mail aux équipes concernées.'\n      },\n      {\n        id: 'compliance-save',\n        target: '[data-tour-id=\"synthesis-save\"]',\n        title: 'Sauvegarder depuis la synthèse',\n        content: 'Téléchargez le fichier du projet pour le partager ou le reprendre ultérieurement.'\n      },\n      {\n        id: 'compliance-showcase-button',\n        target: '[data-tour-id=\"synthesis-showcase\"]',\n        title: 'Ouvrir la vitrine du projet',\n        content: 'Accédez à la vitrine du projet générée automatiquement pour présenter votre initiative.'\n      },\n      {\n        id: 'showcase-top',\n        target: '[data-tour-id=\"showcase-hero\"]',\n        title: 'Présenter votre projet',\n        content:\n          'Parcourez la vitrine présentant votre projet avec une mise en page le mettant en valeur. Parfait pour une présentation à votre manager !',\n         scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 5200\n      },\n      {\n        id: 'showcase-bottom',\n        target: '[data-tour-id=\"showcase-preview-bottom\"]',\n        title: 'Explorer la suite de la vitrine',\n        content: 'Vous retrouvez sur la vitrine les jalons de votre projet mais également les alertes liées à des problématiques de respect de certains délais.',\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 3200\n      },\n      {\n        id: 'showcase-edit-trigger',\n        target: '[data-tour-id=\"showcase-edit-trigger\"]',\n        title: 'Modifier la vitrine',\n        content: 'Activez le mode édition pour ajuster les contenus avant diffusion.'\n      },\n      {\n        id: 'showcase-edit',\n        target: '[data-tour-id=\"showcase-edit-panel\"]',\n        title: 'Personnaliser la vitrine',\n        content: 'Adaptez textes, messages clés et jalons pour refléter fidèlement votre projet. Ses informations sont automatiquement mise à jour dans le rapport de compliance.'\n      },\n      {\n        id: 'showcase-save-edits',\n        target: '[data-tour-id=\"showcase-save-edits\"]',\n        title: 'Enregistrer les modifications',\n        content: 'Validez vos ajustements pour mettre à jour immédiatement la vitrine.'\n      },\n      {\n        id: 'showcase-back-to-report',\n        target: '[data-tour-id=\"showcase-back-to-report\"]',\n        title: 'Retourner à la synthèse',\n        content: 'Revenez au rapport de synthèse pour poursuivre votre préparation et éventuellement enregistrer la dernière version de votre projet.'\n      },\n      {\n        id: 'project-import',\n        target: '[data-tour-id=\"home-import-project\"]',\n        title: 'Charger un projet existant',\n        content: 'Vous pouvez importer un projet enregistrer pour reprendre son édition avant soumission à la compliance.'\n      },\n      {\n        id: 'project-filters',\n        target: '[data-tour-id=\"home-filters\"]',\n        title: 'Découvrir les projets',\n        content: 'Filtrez les initiatives par nom, équipe ou date et laissez vous inspirer.'\n      }\n    ];\n\n    const tour = new window.TourGuideClient({\n      steps,\n      labels: {\n        next: 'Suivant',\n        prev: 'Précédent',\n        close: 'Fermer',\n        finish: 'Terminer'\n      }\n    });\n\n    tour.on('stepChange', ({ step }) => {\n      const stepId = step?.id || null;\n      handleOnboardingStepEnter(stepId);\n      setOnboardingStepId(stepId);\n    });\n\n    tour.on('close', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.on('finish', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.start();\n    tourInstanceRef.current = tour;\n  }, [\n    isOnboardingActive,\n    mode,\n    screen,\n    adminView,\n    answers,\n    analysis,\n    projects,\n    projectFilters,\n    currentQuestionIndex,\n    validationError,\n    saveFeedback,\n    activeProjectId,\n    showcaseProjectContext,\n    hasUnsavedChanges,\n    backOfficeAuthError,\n    isBackOfficeUnlocked,\n    getDemoData,\n    buildOnboardingProjects,\n    handleOnboardingStepEnter,\n    finishOnboarding,\n    setMode,\n    setAdminView,\n    setScreen,\n    setShowcaseProjectContext,\n    setActiveProjectId,\n    setAnswers,\n    setAnalysis,\n    setValidationError,\n    setSaveFeedback,\n    setHasUnsavedChanges,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked,\n    setProjects,\n    setProjectFiltersState\n  ]);\n\n  useEffect(() => () => {\n    if (tourInstanceRef.current && typeof tourInstanceRef.current.stop === 'function') {\n      try {\n        tourInstanceRef.current.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Nettoyage du guide impossible :', error);\n        }\n      }\n    }\n    tourInstanceRef.current = null;\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!isHydrated || isOnboardingActive) return undefined;\n\n    if (persistTimeoutRef.current) {\n      clearTimeout(persistTimeoutRef.current);\n    }\n\n    persistTimeoutRef.current = setTimeout(() => {\n      const modeToPersist = mode === 'admin' ? 'user' : mode;\n\n      persistState({\n        mode: modeToPersist,\n        screen,\n        currentQuestionIndex,\n        answers,\n        analysis,\n        questions,\n        rules,\n        riskLevelRules,\n        riskWeights,\n        teams,\n        showcaseThemes,\n        projects,\n        activeProjectId,\n        projectFilters: normalizeProjectFilterConfig(projectFilters),\n        inspirationProjects,\n        inspirationFilters: normalizeInspirationFiltersConfig(inspirationFilters),\n        inspirationFormFields: normalizeInspirationFormConfig(inspirationFormFields),\n        homeView,\n        activeInspirationId\n      });\n      persistTimeoutRef.current = null;\n    }, 200);\n\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, [\n    mode,\n    screen,\n    currentQuestionIndex,\n    answers,\n    analysis,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    teams,\n    showcaseThemes,\n    projects,\n    activeProjectId,\n    projectFilters,\n    inspirationProjects,\n    inspirationFilters,\n    inspirationFormFields,\n    homeView,\n    activeInspirationId,\n    isHydrated,\n    isOnboardingActive\n  ]);\n\n  const tourContext = useMemo(\n    () => (isOnboardingActive ? { isActive: true, activeStep: onboardingStepId } : null),\n    [isOnboardingActive, onboardingStepId]\n  );\n\n  const activeQuestions = useMemo(\n    () => questions.filter(q => shouldShowQuestion(q, answers)),\n    [questions, answers]\n  );\n\n  const unansweredMandatoryQuestions = useMemo(\n    () =>\n      activeQuestions.filter(question => question.required && !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const pendingMandatoryQuestions = useMemo(\n    () =>\n      unansweredMandatoryQuestions.map(question => ({\n        question,\n        position: activeQuestions.findIndex(item => item.id === question.id) + 1\n      })),\n    [unansweredMandatoryQuestions, activeQuestions]\n  );\n\n  const hasIncompleteAnswers = useMemo(\n    () => activeQuestions.some(question => !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const teamLeadTeamOptions = useMemo(() => {\n    const leadTeamQuestion = questions.find(question => question?.id === 'teamLeadTeam');\n    if (!leadTeamQuestion || !Array.isArray(leadTeamQuestion.options)) {\n      return [];\n    }\n\n    const sanitized = leadTeamQuestion.options\n      .map(option => (typeof option === 'string' ? option.trim() : ''))\n      .filter(option => option.length > 0);\n\n    return Array.from(new Set(sanitized));\n  }, [questions]);\n\n  useEffect(() => {\n    if (!isHydrated) return;\n    if (activeQuestions.length === 0) return;\n    if (currentQuestionIndex >= activeQuestions.length) {\n      setCurrentQuestionIndex(activeQuestions.length - 1);\n    }\n  }, [activeQuestions.length, currentQuestionIndex, isHydrated]);\n\n  useEffect(() => {\n    if (screen !== 'questionnaire' && screen !== 'synthesis') {\n      setSaveFeedback(null);\n    }\n  }, [screen]);\n\n  const activeProject = useMemo(\n    () => projects.find(project => project.id === activeProjectId) || null,\n    [projects, activeProjectId]\n  );\n  const activeInspirationProject = useMemo(\n    () => inspirationProjects.find(project => project.id === activeInspirationId) || null,\n    [inspirationProjects, activeInspirationId]\n  );\n\n  const activeProjectName = useMemo(() => {\n    if (typeof activeProject?.projectName === 'string' && activeProject.projectName.trim().length > 0) {\n      return activeProject.projectName.trim();\n    }\n\n    return extractProjectName(answers, questions);\n  }, [activeProject, answers, questions]);\n\n  const activeShowcaseProjectId = showcaseProjectContext?.projectId || null;\n\n  const activeAnnotationContextKey = useMemo(\n    () => buildAnnotationContextKey({\n      screen,\n      projectId: activeShowcaseProjectId,\n      scope: showcaseAnnotationScope\n    }),\n    [activeShowcaseProjectId, screen, showcaseAnnotationScope]\n  );\n\n  const registerAnnotationSource = useCallback((sourceId, preferredColor) => {\n    if (!sourceId) {\n      return ANNOTATION_COLORS[0];\n    }\n\n    let resolvedColor = ANNOTATION_COLORS[0];\n\n    setAnnotationSources(prevSources => {\n      if (prevSources[sourceId]) {\n        resolvedColor = prevSources[sourceId];\n        return prevSources;\n      }\n\n      const usedColors = new Set(Object.values(prevSources));\n\n      if (preferredColor && !usedColors.has(preferredColor)) {\n        resolvedColor = preferredColor;\n      } else {\n        const availableColor = ANNOTATION_COLORS.find(color => !usedColors.has(color));\n        resolvedColor = availableColor || ANNOTATION_COLORS[0];\n      }\n\n      return { ...prevSources, [sourceId]: resolvedColor };\n    });\n\n    return resolvedColor;\n  }, []);\n\n  const resolveAnnotationTarget = useCallback((clientX, clientY, targetElement = null) => {\n    if (typeof document === 'undefined') {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const activeTarget = targetElement instanceof Element\n      ? targetElement\n      : document.elementFromPoint(clientX, clientY);\n\n    const sectionElement = activeTarget?.closest('[data-showcase-section]');\n\n    if (!sectionElement) {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const rect = sectionElement.getBoundingClientRect();\n    const sectionWidth = rect?.width || 1;\n    const sectionHeight = rect?.height || 1;\n\n    return {\n      sectionId: sectionElement.getAttribute('data-showcase-section') || null,\n      sectionX: clamp01((clientX - rect.left) / sectionWidth),\n      sectionY: clamp01((clientY - rect.top) / sectionHeight)\n    };\n  }, []);\n\n  const handleAddAnnotationNote = useCallback((clientX, clientY, targetElement = null) => {\n    if (screen !== 'showcase' || !showcaseProjectContext || isAnnotationPaused) {\n      return;\n    }\n\n    const width = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const height = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const x = clamp01(clientX / width);\n    const y = clamp01(clientY / height);\n    const sourceId = 'session';\n    const color = registerAnnotationSource(sourceId);\n    const { sectionId, sectionX, sectionY } = resolveAnnotationTarget(clientX, clientY, targetElement);\n\n    const newNoteId = createAnnotationId();\n\n    setAnnotationNotes(prevNotes => [\n      ...prevNotes,\n      {\n        id: newNoteId,\n        x,\n        y,\n        sectionId,\n        sectionX: sectionX ?? x,\n        sectionY: sectionY ?? y,\n        text: '',\n        color,\n        contextId: activeAnnotationContextKey,\n        projectId: showcaseProjectContext.projectId || 'unknown',\n        projectName: showcaseProjectContext.projectName || '',\n        sourceId\n      }\n    ]);\n    setAutoFocusAnnotationId(newNoteId);\n  }, [\n    activeAnnotationContextKey,\n    isAnnotationPaused,\n    registerAnnotationSource,\n    resolveAnnotationTarget,\n    screen,\n    showcaseProjectContext\n  ]);\n\n  const handleAnnotationTextChange = useCallback((noteId, text) => {\n    setAnnotationNotes(prevNotes => prevNotes.map(note => (\n      note?.id === noteId\n        ? { ...note, text }\n        : note\n    )));\n  }, []);\n\n  const handleRemoveAnnotationNote = useCallback((noteId) => {\n    setAnnotationNotes(prevNotes => prevNotes.filter(note => note?.id !== noteId));\n  }, []);\n\n  const handleToggleAnnotationMode = useCallback(() => {\n    setIsAnnotationModeEnabled(prev => {\n      const next = !prev;\n\n      if (!next) {\n        setIsAnnotationPaused(false);\n      }\n\n      return next;\n    });\n  }, []);\n\n  const handleToggleAnnotationPause = useCallback(() => {\n    setIsAnnotationPaused(prev => !prev);\n  }, []);\n\n  const downloadAnnotationFile = useCallback((notesToSave, projectName) => {\n    if (!Array.isArray(notesToSave) || notesToSave.length === 0 || typeof window === 'undefined') {\n      return;\n    }\n\n    const safeName = typeof projectName === 'string' && projectName.trim().length > 0\n      ? projectName.trim()\n      : 'projet';\n\n    const payload = JSON.stringify(notesToSave, null, 2);\n    const blob = new Blob([payload], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = `Commentaire sur le projet ${safeName}.json`;\n    anchor.click();\n    URL.revokeObjectURL(url);\n  }, []);\n\n  const handleSaveAnnotationNotes = useCallback(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    const projectNotes = annotationNotes.filter(note => note?.projectId === showcaseProjectContext.projectId);\n\n    if (projectNotes.length === 0) {\n      return;\n    }\n\n    downloadAnnotationFile(projectNotes, showcaseProjectContext.projectName);\n  }, [annotationNotes, downloadAnnotationFile, showcaseProjectContext]);\n\n  const handleRequestAnnotationFile = useCallback(() => {\n    if (annotationFileInputRef.current) {\n      annotationFileInputRef.current.value = '';\n      annotationFileInputRef.current.click();\n    }\n  }, []);\n\n  const handleAnnotationFileChange = useCallback((event) => {\n    const [file] = event?.target?.files || [];\n    const fileInput = event?.target;\n\n    if (!file) {\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = () => {\n      try {\n        const parsed = JSON.parse(reader.result || '[]');\n        const rawNotes = Array.isArray(parsed)\n          ? parsed\n          : Array.isArray(parsed?.notes)\n            ? parsed.notes\n            : [];\n\n        if (!Array.isArray(rawNotes) || rawNotes.length === 0) {\n          return;\n        }\n\n        const sourceId = file.name || `import-${Date.now()}`;\n        const sourceColor = registerAnnotationSource(sourceId);\n\n        const importedNotes = rawNotes.map(rawNote => {\n          const normalizedX = clamp01(rawNote?.x ?? 0);\n          const normalizedY = clamp01(rawNote?.y ?? 0);\n\n          return {\n            id: rawNote?.id || createAnnotationId(),\n            x: normalizedX,\n            y: normalizedY,\n            sectionId: typeof rawNote?.sectionId === 'string' ? rawNote.sectionId : null,\n            sectionX: clamp01(rawNote?.sectionX ?? normalizedX),\n            sectionY: clamp01(rawNote?.sectionY ?? normalizedY),\n            text: typeof rawNote?.text === 'string' ? rawNote.text : '',\n            color: sourceColor,\n            contextId: rawNote?.contextId || activeAnnotationContextKey,\n            projectId: rawNote?.projectId || showcaseProjectContext?.projectId || 'unknown',\n            projectName: rawNote?.projectName || showcaseProjectContext?.projectName || '',\n            sourceId\n          };\n        });\n\n        setAnnotationNotes(prevNotes => [...prevNotes, ...importedNotes]);\n      } catch (error) {\n        // Malformed file, ignore silently\n      } finally {\n        if (fileInput) {\n          fileInput.value = '';\n        }\n      }\n    };\n\n    reader.readAsText(file);\n  }, [activeAnnotationContextKey, registerAnnotationSource, showcaseProjectContext]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    if (!isAnnotationModeEnabled || isAnnotationPaused || screen !== 'showcase') {\n      return undefined;\n    }\n\n    const handleDocumentClick = (event) => {\n      const target = event?.target;\n\n      if (target instanceof Element && target.closest('[data-annotation-ui=\"true\"]')) {\n        return;\n      }\n\n      handleAddAnnotationNote(event.clientX, event.clientY, target);\n    };\n\n    window.addEventListener('click', handleDocumentClick, true);\n\n    return () => {\n      window.removeEventListener('click', handleDocumentClick, true);\n    };\n  }, [handleAddAnnotationNote, isAnnotationModeEnabled, isAnnotationPaused, screen]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return undefined;\n    }\n\n    const { projectName, projectId } = showcaseProjectContext;\n\n    return () => {\n      const projectNotes = (annotationNotesRef.current || []).filter(note => note?.projectId === projectId);\n\n      if (projectNotes.length > 0) {\n        downloadAnnotationFile(projectNotes, projectName);\n      }\n    };\n  }, [downloadAnnotationFile, showcaseProjectContext]);\n\n  const isAdminMode = mode === 'admin';\n  const isAdminHomeView = isAdminMode && adminView === 'home';\n  const isAdminBackOfficeView = isAdminMode && adminView === 'back-office';\n  const isActiveProjectEditable = isAdminMode || !activeProject || activeProject.status === 'draft';\n  const annotationOffsetClass = isAnnotationModeEnabled && screen === 'showcase'\n    ? 'pt-20 lg:pt-24'\n    : '';\n\n  const handleAnswer = useCallback((questionId, answer) => {\n    let answerChanged = false;\n    let nextAnswersSnapshot = null;\n\n    setAnswers(prevAnswers => {\n      const previousValue = prevAnswers[questionId];\n      if (!areAnswersEqual(previousValue, answer)) {\n        answerChanged = true;\n      }\n\n      const nextAnswers = { ...prevAnswers, [questionId]: answer };\n\n      const questionsToRemove = questions\n        .filter(q => !shouldShowQuestion(q, nextAnswers))\n        .map(q => q.id);\n\n      if (questionsToRemove.length === 0) {\n        if (answerChanged) {\n          nextAnswersSnapshot = nextAnswers;\n        }\n        return answerChanged ? nextAnswers : prevAnswers;\n      }\n\n      const sanitizedAnswers = { ...nextAnswers };\n      let removedExistingAnswer = false;\n      questionsToRemove.forEach(qId => {\n        if (Object.prototype.hasOwnProperty.call(sanitizedAnswers, qId)) {\n          if (Object.prototype.hasOwnProperty.call(prevAnswers, qId)) {\n            removedExistingAnswer = true;\n          }\n          delete sanitizedAnswers[qId];\n        }\n      });\n\n      if (!answerChanged) {\n        if (removedExistingAnswer) {\n          answerChanged = true;\n        } else {\n          const prevKeys = Object.keys(prevAnswers);\n          const nextKeys = Object.keys(sanitizedAnswers);\n          if (prevKeys.length !== nextKeys.length) {\n            answerChanged = true;\n          } else if (nextKeys.some(key => !areAnswersEqual(prevAnswers[key], sanitizedAnswers[key]))) {\n            answerChanged = true;\n          }\n        }\n      }\n\n      if (answerChanged) {\n        nextAnswersSnapshot = sanitizedAnswers;\n      }\n\n      return answerChanged ? sanitizedAnswers : prevAnswers;\n    });\n\n    if (!answerChanged || !nextAnswersSnapshot) {\n      setValidationError(prev => {\n        if (!prev) return null;\n        return prev.questionId === questionId ? null : prev;\n      });\n      return;\n    }\n\n    setHasUnsavedChanges(true);\n\n    const updatedAnalysis = Object.keys(nextAnswersSnapshot).length > 0\n      ? analyzeAnswers(nextAnswersSnapshot, rules, riskLevelRules, riskWeights)\n      : null;\n\n    setAnalysis(updatedAnalysis);\n\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswersSnapshot));\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => isAnswerProvided(nextAnswersSnapshot[question.id])).length\n      : Object.keys(nextAnswersSnapshot).length;\n    const inferredName = extractProjectName(nextAnswersSnapshot, questions);\n    const normalizedInferredName = typeof inferredName === 'string' ? inferredName.trim() : '';\n\n    if (activeProjectId && isActiveProjectEditable) {\n      setProjects(prevProjects => {\n        const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n        if (projectIndex === -1) {\n          return prevProjects;\n        }\n\n        const project = prevProjects[projectIndex];\n        if (!project) {\n          return prevProjects;\n        }\n\n        const canUpdateProject = project.status === 'draft' || isAdminMode;\n        if (!canUpdateProject) {\n          return prevProjects;\n        }\n\n        const totalQuestions = relevantQuestions.length > 0\n          ? relevantQuestions.length\n          : project.totalQuestions || questions.length || 0;\n        const sanitizedName = normalizedInferredName.length > 0\n          ? normalizedInferredName\n          : project.projectName;\n        const lastQuestionIndex = totalQuestions > 0\n          ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n          : project.lastQuestionIndex ?? 0;\n\n        const updatedProject = {\n          ...project,\n          answers: nextAnswersSnapshot,\n          analysis: updatedAnalysis,\n          projectName: sanitizedName,\n          totalQuestions,\n          answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n          lastQuestionIndex,\n          lastUpdated: new Date().toISOString()\n        };\n\n        const nextProjects = prevProjects.slice();\n        nextProjects[projectIndex] = updatedProject;\n        return nextProjects;\n      });\n    }\n\n    setValidationError(prev => {\n      if (!prev) return null;\n      return prev.questionId === questionId ? null : prev;\n    });\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion\n  ]);\n\n  const handleUpdateAnswers = useCallback((updates) => {\n    if (!isActiveProjectEditable) {\n      return;\n    }\n\n    let sanitizedResult = null;\n\n    setAnswers(prevAnswers => {\n      const { nextAnswers, changed } = applyAnswerUpdates(prevAnswers, updates, questions, shouldShowQuestion);\n      if (!changed) {\n        return prevAnswers;\n      }\n      sanitizedResult = nextAnswers;\n      return nextAnswers;\n    });\n\n    if (sanitizedResult) {\n      const updatedAnalysis = analyzeAnswers(sanitizedResult, rules, riskLevelRules, riskWeights);\n      setAnalysis(updatedAnalysis);\n      setValidationError(null);\n      setHasUnsavedChanges(true);\n\n      if (activeProjectId) {\n        setProjects(prevProjects => {\n          const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n          if (projectIndex === -1) {\n            return prevProjects;\n          }\n\n          const project = prevProjects[projectIndex];\n          if (!project) {\n            return prevProjects;\n          }\n\n          const canUpdateProject = project.status === 'draft' || isAdminMode;\n          if (!canUpdateProject) {\n            return prevProjects;\n          }\n\n          const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedResult));\n          const totalQuestions = relevantQuestions.length > 0\n            ? relevantQuestions.length\n            : project.totalQuestions || questions.length || 0;\n          const answeredQuestionsCount = relevantQuestions.length > 0\n            ? relevantQuestions.filter(question => isAnswerProvided(sanitizedResult[question.id])).length\n            : Object.keys(sanitizedResult).length;\n          const inferredName = extractProjectName(sanitizedResult, questions);\n          const sanitizedName = inferredName && inferredName.trim().length > 0\n            ? inferredName.trim()\n            : project.projectName;\n          const lastQuestionIndex = totalQuestions > 0\n            ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n            : project.lastQuestionIndex ?? 0;\n\n          const updatedProject = {\n            ...project,\n            answers: sanitizedResult,\n            analysis: updatedAnalysis,\n            projectName: sanitizedName,\n            totalQuestions,\n            answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n            lastQuestionIndex,\n            lastUpdated: new Date().toISOString()\n          };\n\n          const nextProjects = prevProjects.slice();\n          nextProjects[projectIndex] = updatedProject;\n          return nextProjects;\n        });\n      }\n    }\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const resetProjectState = useCallback(() => {\n    setAnswers({});\n    setCurrentQuestionIndex(0);\n    setAnalysis(null);\n    setValidationError(null);\n    setActiveProjectId(null);\n    setHasUnsavedChanges(false);\n    setReturnToSynthesisAfterEdit(false);\n  }, [setHasUnsavedChanges]);\n\n  const openBackOfficePrompt = useCallback(() => new Promise((resolve) => {\n    backOfficePromptResolverRef.current = resolve;\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    setIsBackOfficePromptOpen(true);\n  }), []);\n\n  const closeBackOfficePrompt = useCallback((result = false) => {\n    setIsBackOfficePromptOpen(false);\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    const resolver = backOfficePromptResolverRef.current;\n    backOfficePromptResolverRef.current = null;\n    if (typeof resolver === 'function') {\n      resolver(result);\n    }\n  }, []);\n\n  const handleBackOfficePromptSubmit = useCallback(async (event) => {\n    event.preventDefault();\n    const trimmed = backOfficePromptValue.trim();\n    if (!trimmed) {\n      setBackOfficePromptError('Veuillez saisir un mot de passe.');\n      return;\n    }\n\n    const isValid = await verifyBackOfficePassword(trimmed);\n\n    if (isValid) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      closeBackOfficePrompt(true);\n      return;\n    }\n\n    setIsBackOfficeUnlocked(false);\n    setBackOfficeAuthError('Mot de passe incorrect. Veuillez réessayer.');\n    setBackOfficePromptError('Mot de passe incorrect. Veuillez réessayer.');\n  }, [backOfficePromptValue, closeBackOfficePrompt]);\n\n  const requestAdminAccess = useCallback(async () => {\n    if (isAdminMode) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    if (isBackOfficeUnlocked) {\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    setBackOfficeAuthError(null);\n    return openBackOfficePrompt();\n  }, [\n    isAdminMode,\n    isBackOfficeUnlocked,\n    openBackOfficePrompt,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked\n  ]);\n\n  const handleBackOfficeClick = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('back-office');\n  }, [requestAdminAccess, setMode]);\n\n  const handleActivateAdminOnHome = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('home');\n    setScreen('home');\n  }, [requestAdminAccess, setMode, setScreen]);\n\n  const handleReturnToProjectMode = useCallback(() => {\n    setMode('user');\n    setAdminView('home');\n    setBackOfficeAuthError(null);\n  }, [setBackOfficeAuthError, setMode]);\n\n  const handleCreateNewProject = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleStartInspirationProject = useCallback(() => {\n    setScreen('inspiration-form');\n  }, []);\n\n  const handleSaveInspirationProject = useCallback((payload) => {\n    const project = {\n      id: createInspirationId(),\n      ...payload\n    };\n    setInspirationProjects((prev) => [project, ...(Array.isArray(prev) ? prev : [])]);\n    setHomeView('inspiration');\n    setScreen('home');\n  }, []);\n\n  const handleOpenInspirationProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n    setActiveInspirationId(projectId);\n    setScreen('inspiration-detail');\n  }, []);\n\n  const handleUpdateInspirationProject = useCallback((projectId, updates) => {\n    if (!projectId || !updates) {\n      return;\n    }\n\n    setInspirationProjects((prev) => (Array.isArray(prev) ? prev : []).map((project) => {\n      if (!project || project.id !== projectId) {\n        return project;\n      }\n\n      return { ...project, ...updates };\n    }));\n  }, []);\n\n  const handleImportProject = useCallback((file) => {\n    if (!file) {\n      return;\n    }\n\n    if (typeof FileReader === 'undefined') {\n      if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n        console.warn('[projectImport] FileReader API indisponible dans cet environnement.');\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Votre navigateur ne permet pas d\\'importer un projet depuis un fichier.');\n      }\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = (event) => {\n      try {\n        const content = typeof event?.target?.result === 'string' ? event.target.result : '';\n\n        if (!content) {\n          throw new Error('EMPTY_FILE');\n        }\n\n        const parsed = JSON.parse(content);\n        const projectData = parsed?.project && typeof parsed.project === 'object' ? parsed.project : parsed;\n\n        if (!projectData || typeof projectData !== 'object') {\n          throw new Error('INVALID_PROJECT');\n        }\n\n        const importedAnswers = projectData.answers && typeof projectData.answers === 'object'\n          ? projectData.answers\n          : {};\n        const importedAnalysis = projectData.analysis && typeof projectData.analysis === 'object'\n          ? projectData.analysis\n          : null;\n        const importedName = typeof projectData.name === 'string' ? projectData.name.trim() : '';\n        const projectName = importedName.length > 0 ? importedName : 'Projet importé';\n        const importedTotalQuestions = Array.isArray(projectData?.questionnaire?.questionIds)\n          ? projectData.questionnaire.questionIds.length\n          : undefined;\n\n        const entry = handleSaveProject({\n          id: `project-${Date.now()}`,\n          projectName,\n          answers: importedAnswers,\n          analysis: importedAnalysis,\n          status: 'draft',\n          totalQuestions: importedTotalQuestions,\n          lastQuestionIndex: 0\n        });\n\n        if (!entry) {\n          throw new Error('SAVE_FAILED');\n        }\n\n        const relevantQuestions = questions.filter(question => shouldShowQuestion(question, importedAnswers));\n        const missingMandatory = relevantQuestions.filter(question => question.required && !isAnswerProvided(importedAnswers[question.id]));\n        const firstMissingId = missingMandatory[0]?.id;\n        const derivedAnalysis = entry.analysis\n          || (Object.keys(importedAnswers).length > 0 ? analyzeAnswers(importedAnswers, rules, riskLevelRules, riskWeights) : null);\n\n        const nextIndex = firstMissingId\n          ? Math.max(relevantQuestions.findIndex(question => question.id === firstMissingId), 0)\n          : relevantQuestions.length > 0\n            ? Math.min(entry.lastQuestionIndex ?? 0, relevantQuestions.length - 1)\n            : 0;\n        const hasPendingMandatory = missingMandatory.length > 0;\n\n        setAnswers(importedAnswers);\n        setAnalysis(derivedAnalysis);\n        setCurrentQuestionIndex(nextIndex);\n        setValidationError(null);\n        setActiveProjectId(entry.id);\n        setScreen('synthesis');\n        setSaveFeedback({\n          status: 'success',\n          message: hasPendingMandatory\n            ? 'Projet importé. La synthèse est disponible. Complétez les questions obligatoires avant de soumettre.'\n            : 'Projet importé. La synthèse est disponible.'\n        });\n        setHasUnsavedChanges(false);\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.error === 'function') {\n          console.error('[projectImport] Impossible de charger le projet :', error);\n        }\n        if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n          window.alert('Le fichier sélectionné est invalide. Veuillez vérifier le JSON exporté.');\n        }\n      }\n    };\n\n    reader.onerror = () => {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Échec de la lecture du fichier :', reader.error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Impossible de lire le fichier sélectionné. Veuillez réessayer.');\n      }\n    };\n\n    try {\n      reader.readAsText(file, 'utf-8');\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Erreur inattendue lors de la lecture du fichier :', error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Une erreur est survenue lors de l\\'import du projet.');\n      }\n    }\n  }, [\n    handleSaveProject,\n    setHasUnsavedChanges,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    shouldShowQuestion,\n    analyzeAnswers\n  ]);\n\n  const navigateToSynthesis = useCallback(() => {\n    const result = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    setAnalysis(result);\n    setValidationError(null);\n    setReturnToSynthesisAfterEdit(false);\n    setScreen('synthesis');\n  }, [analyzeAnswers, answers, riskLevelRules, riskWeights, rules]);\n\n  const handleNext = useCallback(() => {\n    if (currentQuestionIndex < activeQuestions.length - 1) {\n      setCurrentQuestionIndex(currentQuestionIndex + 1);\n      setValidationError(null);\n      return;\n    }\n\n    navigateToSynthesis();\n  }, [activeQuestions, currentQuestionIndex, navigateToSynthesis]);\n\n  const handleBack = useCallback(() => {\n    if (currentQuestionIndex > 0) {\n      setCurrentQuestionIndex(currentQuestionIndex - 1);\n    }\n    setValidationError(null);\n  }, [currentQuestionIndex]);\n\n  const handleRestart = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleOpenProject = useCallback((projectId, options = {}) => {\n    if (!projectId) {\n      return;\n    }\n\n    const project = projects.find(item => item.id === projectId);\n    if (!project) {\n      return;\n    }\n\n    const projectAnswers = project.answers || {};\n    const derivedQuestions = questions.filter(q => shouldShowQuestion(q, projectAnswers));\n    const derivedAnalysis = Object.keys(projectAnswers).length > 0\n      ? analyzeAnswers(projectAnswers, rules, riskLevelRules, riskWeights)\n      : null;\n    const answeredQuestionsCount = derivedQuestions.length > 0\n      ? derivedQuestions.filter(question => isAnswerProvided(projectAnswers[question.id])).length\n      : Object.keys(projectAnswers).length;\n    const missingMandatory = derivedQuestions.filter(question => question.required && !isAnswerProvided(projectAnswers[question.id]));\n    const totalQuestions = derivedQuestions.length;\n    const rawIndex = typeof project.lastQuestionIndex === 'number' ? project.lastQuestionIndex : 0;\n    const sanitizedIndex = totalQuestions > 0 ? Math.min(Math.max(rawIndex, 0), totalQuestions - 1) : 0;\n    const firstMissingId = missingMandatory[0]?.id;\n    const missingIndex = firstMissingId\n      ? derivedQuestions.findIndex(question => question.id === firstMissingId)\n      : -1;\n    const startingIndex = missingIndex >= 0 ? missingIndex : project.status === 'draft' ? sanitizedIndex : 0;\n\n    setAnswers(projectAnswers);\n    setAnalysis(derivedAnalysis);\n    setCurrentQuestionIndex(startingIndex);\n    setValidationError(null);\n    setActiveProjectId(project.id);\n\n    setProjects(prevProjects => prevProjects.map(entry => {\n      if (entry.id !== project.id) {\n        return entry;\n      }\n\n      return {\n        ...entry,\n        analysis: derivedAnalysis,\n        totalQuestions,\n        answeredQuestions: Math.min(\n          answeredQuestionsCount,\n          totalQuestions || answeredQuestionsCount\n        ),\n        lastQuestionIndex: sanitizedIndex\n      };\n    }));\n\n    const forcedView = typeof options?.view === 'string' ? options.view : null;\n\n    let targetScreen = null;\n    if (forcedView === 'synthesis' || forcedView === 'questionnaire' || forcedView === 'mandatory-summary') {\n      targetScreen = forcedView;\n    }\n\n    if (!targetScreen) {\n      targetScreen = project.status === 'draft' ? 'questionnaire' : 'synthesis';\n    }\n\n    setScreen(targetScreen);\n    setHasUnsavedChanges(false);\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    setHasUnsavedChanges,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const handleDeleteProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.filter(project => project.id !== projectId));\n    setActiveProjectId(prev => (prev === projectId ? null : prev));\n  }, []);\n\n  const handleDuplicateProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      const sourceProject = prevProjects.find(project => project.id === projectId);\n      if (!sourceProject) {\n        return prevProjects;\n      }\n\n      const answersClone = sourceProject.answers && typeof sourceProject.answers === 'object'\n        ? JSON.parse(JSON.stringify(sourceProject.answers))\n        : {};\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, answersClone));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : typeof sourceProject.totalQuestions === 'number' && sourceProject.totalQuestions > 0\n          ? sourceProject.totalQuestions\n          : questions.length;\n\n      const answeredQuestionsCount = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(answersClone[question.id])).length\n        : typeof sourceProject.answeredQuestions === 'number'\n          ? Math.min(sourceProject.answeredQuestions, totalQuestions || sourceProject.answeredQuestions)\n          : Object.keys(answersClone).length;\n\n      const computedAnalysis = Object.keys(answersClone).length > 0\n        ? analyzeAnswers(answersClone, rules, riskLevelRules, riskWeights)\n        : null;\n\n      const baseName = typeof sourceProject.projectName === 'string' && sourceProject.projectName.trim().length > 0\n        ? sourceProject.projectName.trim()\n        : 'Projet sans nom';\n      const nameWithoutCopyPrefix = baseName.replace(/^\\[Copie\\]\\s*/i, '').trim();\n      const duplicateBaseName = nameWithoutCopyPrefix.length > 0 ? nameWithoutCopyPrefix : baseName;\n\n      const duplicateEntry = {\n        id: `project-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n        projectName: `[Copie] ${duplicateBaseName}`,\n        answers: answersClone,\n        analysis: computedAnalysis,\n        status: 'draft',\n        lastUpdated: new Date().toISOString(),\n        lastQuestionIndex: 0,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n      };\n\n      return [duplicateEntry, ...prevProjects];\n    });\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const openProjectShowcase = useCallback((context = {}) => {\n    const {\n      projectId = null,\n      projectName: providedProjectName,\n      status: providedStatus,\n      answers: providedAnswers,\n      analysis: providedAnalysis,\n      relevantTeams: providedRelevantTeams,\n      questions: providedQuestions,\n      timelineDetails: providedTimelineDetails\n    } = context || {};\n\n    const project = projectId ? projects.find(item => item.id === projectId) : null;\n    const answersSource = providedAnswers || project?.answers || {};\n    const visibleQuestions = Array.isArray(providedQuestions) && providedQuestions.length > 0\n      ? providedQuestions\n      : questions.filter(question => shouldShowQuestion(question, answersSource));\n    const computedAnalysis = providedAnalysis\n      || (Object.keys(answersSource).length > 0\n        ? analyzeAnswers(answersSource, rules, riskLevelRules, riskWeights)\n        : null);\n    const relevantTeamsList = Array.isArray(providedRelevantTeams) && providedRelevantTeams.length > 0\n      ? providedRelevantTeams\n      : teams.filter(team => (computedAnalysis?.teams || []).includes(team.id));\n    const timelineDetailsList = Array.isArray(providedTimelineDetails)\n      ? providedTimelineDetails\n      : computedAnalysis?.timeline?.details || [];\n\n    const normalizedProjectName = typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : (typeof project?.projectName === 'string' && project.projectName.trim().length > 0\n        ? project.projectName.trim()\n        : extractProjectName(answersSource, questions));\n\n    const resolvedProjectName = normalizedProjectName && normalizedProjectName.length > 0\n      ? normalizedProjectName\n      : 'Projet sans nom';\n    const resolvedStatus = providedStatus || project?.status || 'draft';\n\n    const answeredQuestionsCount = visibleQuestions.length > 0\n      ? visibleQuestions.filter(question => isAnswerProvided(answersSource[question.id])).length\n      : Object.keys(answersSource).length;\n\n    const hasShowcaseIncompleteAnswers = visibleQuestions.length > 0\n      ? visibleQuestions.some(question => !isAnswerProvided(answersSource[question.id]))\n      : Object.keys(answersSource).length === 0;\n\n    const totalQuestions = visibleQuestions.length > 0\n      ? visibleQuestions.length\n      : project?.totalQuestions || questions.length || 0;\n\n    if (projectId) {\n      setProjects(prevProjects => prevProjects.map(entry => {\n        if (entry.id !== projectId) {\n          return entry;\n        }\n\n        return {\n          ...entry,\n          analysis: computedAnalysis,\n          totalQuestions,\n          answeredQuestions: Math.min(\n            answeredQuestionsCount,\n            totalQuestions || answeredQuestionsCount\n          )\n        };\n      }));\n    }\n\n    setShowcaseProjectContext({\n      projectId: projectId || null,\n      projectName: resolvedProjectName,\n      status: resolvedStatus,\n      answers: answersSource,\n      analysis: computedAnalysis,\n      relevantTeams: relevantTeamsList,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      timelineDetails: timelineDetailsList,\n      hasIncompleteAnswers: hasShowcaseIncompleteAnswers\n    });\n    previousScreenRef.current = screen;\n    setScreen('showcase');\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    screen,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  useEffect(() => {\n    if (!isHydrated) {\n      return;\n    }\n\n    const pendingProjectId = pendingShowcaseProjectIdRef.current;\n    if (!pendingProjectId) {\n      return;\n    }\n\n    const matchingProject = projects.find(project => project?.id === pendingProjectId);\n    if (!matchingProject) {\n      return;\n    }\n\n    pendingShowcaseProjectIdRef.current = null;\n    openProjectShowcase({ projectId: pendingProjectId });\n  }, [isHydrated, openProjectShowcase, projects]);\n\n  const handleShowProjectShowcase = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    openProjectShowcase({ projectId });\n  }, [openProjectShowcase]);\n\n  const handleOpenActiveProjectShowcase = useCallback((payload = {}) => {\n    const projectId = payload?.projectId || activeProjectId || null;\n\n    openProjectShowcase({\n      ...payload,\n      projectId\n    });\n  }, [activeProjectId, openProjectShowcase]);\n\n  const handleCloseProjectShowcase = useCallback(() => {\n    setShowcaseProjectContext(null);\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('home');\n    }\n    previousScreenRef.current = null;\n  }, []);\n\n  const handleReturnToComplianceReport = useCallback(() => {\n    if (showcaseProjectContext?.projectId) {\n      const { projectId } = showcaseProjectContext;\n      setShowcaseProjectContext(null);\n      previousScreenRef.current = null;\n      handleOpenProject(projectId, { view: 'synthesis' });\n      return;\n    }\n\n    setShowcaseProjectContext(null);\n\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('synthesis');\n    }\n\n    previousScreenRef.current = null;\n  }, [handleOpenProject, showcaseProjectContext, setScreen]);\n\n  const handleUpdateProjectShowcaseAnswers = useCallback((updates) => {\n    if (\n      !showcaseProjectContext ||\n      !showcaseProjectContext.projectId ||\n      (showcaseProjectContext.status !== 'draft' && !isAdminMode)\n    ) {\n      return;\n    }\n\n    const projectId = showcaseProjectContext.projectId;\n    let contextPatch = null;\n    let hasProjectChanges = false;\n\n    setProjects(prevProjects => {\n      const project = prevProjects.find(entry => entry.id === projectId);\n      if (!project || (project.status !== 'draft' && !isAdminMode)) {\n        return prevProjects;\n      }\n\n      const { nextAnswers, changed } = applyAnswerUpdates(\n        project.answers || {},\n        updates,\n        questions,\n        shouldShowQuestion,\n        {\n          shouldPreserveQuestion: (question) => !question?.showcase\n        }\n      );\n      if (!changed) {\n        return prevProjects;\n      }\n\n      hasProjectChanges = true;\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswers));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : project.totalQuestions || questions.length || 0;\n      const answeredQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(nextAnswers[question.id])).length\n        : Object.keys(nextAnswers).length;\n\n      const updatedAnalysis = analyzeAnswers(nextAnswers, rules, riskLevelRules, riskWeights);\n      const timelineDetails = updatedAnalysis?.timeline?.details || [];\n      const relevantTeamsIds = Array.isArray(updatedAnalysis?.teams) ? updatedAnalysis.teams : [];\n      const relevantTeams = teams.filter(team => relevantTeamsIds.includes(team.id));\n      const inferredName = extractProjectName(nextAnswers, questions);\n      const sanitizedName = inferredName && inferredName.trim().length > 0\n        ? inferredName.trim()\n        : project.projectName;\n\n      const lastQuestionIndex = totalQuestions > 0\n        ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n        : project.lastQuestionIndex ?? 0;\n\n      contextPatch = {\n        projectName: sanitizedName,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        relevantTeams,\n        timelineDetails,\n        questions: relevantQuestions.length > 0 ? relevantQuestions : null\n      };\n\n      const now = new Date().toISOString();\n\n      const updatedProject = {\n        ...project,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        projectName: sanitizedName,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex,\n        lastUpdated: now\n      };\n\n      return [updatedProject, ...prevProjects.filter(entry => entry.id !== projectId)];\n    });\n\n    if (contextPatch) {\n      setShowcaseProjectContext(prev => {\n        if (!prev || prev.projectId !== projectId) {\n          return prev;\n        }\n\n        return {\n          ...prev,\n          ...contextPatch,\n          questions: contextPatch.questions ? contextPatch.questions : prev.questions\n        };\n      });\n    }\n\n    if (hasProjectChanges) {\n      setHasUnsavedChanges(true);\n    }\n  }, [\n    analyzeAnswers,\n    extractProjectName,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    showcaseProjectContext,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  const upsertProject = useCallback((entry) => {\n    return prevProjects => {\n      if (!entry || !entry.id) {\n        return prevProjects;\n      }\n\n      const filtered = prevProjects.filter(project => project.id !== entry.id);\n      return [entry, ...filtered];\n    };\n  }, []);\n\n  const handleSaveProject = useCallback((payload = {}) => {\n    const baseAnswers = payload.answers && typeof payload.answers === 'object' ? payload.answers : answers;\n    const sanitizedAnswers = baseAnswers || {};\n    const status = payload.status === 'submitted' ? 'submitted' : 'draft';\n    const projectId = activeProjectId || payload.id || `project-${Date.now()}`;\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedAnswers));\n    const computedTotalQuestions = payload.totalQuestions\n      || (relevantQuestions.length > 0 ? relevantQuestions.length : activeQuestions.length);\n    const totalQuestions = computedTotalQuestions > 0 ? computedTotalQuestions : activeQuestions.length;\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => {\n        const value = sanitizedAnswers[question.id];\n        if (Array.isArray(value)) {\n          return value.length > 0;\n        }\n        if (typeof value === 'string') {\n          return value.trim().length > 0;\n        }\n        return value !== null && value !== undefined;\n      }).length\n      : Object.keys(sanitizedAnswers).length;\n    const now = new Date().toISOString();\n\n    let computedAnalysis = null;\n    if (payload.analysis && typeof payload.analysis === 'object') {\n      computedAnalysis = payload.analysis;\n    } else if (Object.keys(sanitizedAnswers).length > 0) {\n      computedAnalysis = analyzeAnswers(sanitizedAnswers, rules, riskLevelRules, riskWeights);\n    }\n\n    if (status === 'submitted' && !computedAnalysis) {\n      return null;\n    }\n\n    const inferredName = extractProjectName(sanitizedAnswers, questions);\n    const projectNameRaw = typeof payload.projectName === 'string' ? payload.projectName : inferredName;\n    const sanitizedName =\n      projectNameRaw && projectNameRaw.trim().length > 0 ? projectNameRaw.trim() : 'Projet sans nom';\n\n    let lastQuestionIndex =\n      typeof payload.lastQuestionIndex === 'number' ? payload.lastQuestionIndex : currentQuestionIndex;\n    if (status === 'submitted' && totalQuestions > 0) {\n      lastQuestionIndex = totalQuestions - 1;\n    }\n\n    const clampedLastIndex = totalQuestions > 0\n      ? Math.min(Math.max(lastQuestionIndex, 0), totalQuestions - 1)\n      : 0;\n\n    const entry = {\n      id: projectId,\n      projectName: sanitizedName,\n      answers: sanitizedAnswers,\n      analysis: computedAnalysis,\n      status,\n      lastUpdated: now,\n      lastQuestionIndex: clampedLastIndex,\n      totalQuestions,\n      answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n    };\n\n    if (status === 'submitted') {\n      entry.submittedAt = now;\n    }\n\n    setProjects(upsertProject(entry));\n    setActiveProjectId(projectId);\n\n    if (computedAnalysis) {\n      setAnalysis(computedAnalysis);\n    }\n\n    setHasUnsavedChanges(false);\n\n    return entry;\n  }, [\n    activeProjectId,\n    activeQuestions.length,\n    analyzeAnswers,\n    answers,\n    currentQuestionIndex,\n    extractProjectName,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion,\n    upsertProject\n  ]);\n\n  const handleSubmitProject = useCallback((payload = {}) => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      setSaveFeedback({\n        status: 'error',\n        message: 'Impossible de soumettre : complétez les questions obligatoires avant l’envoi.'\n      });\n      setScreen('synthesis');\n      return null;\n    }\n\n    const entry = handleSaveProject({ ...payload, status: 'submitted' });\n    if (entry) {\n      setValidationError(null);\n      setScreen('home');\n    }\n  }, [handleSaveProject, unansweredMandatoryQuestions]);\n\n  const handleSaveDraft = useCallback((payload = {}) => {\n    const { lastQuestionIndex: payloadLastQuestionIndex, ...otherPayload } = payload || {};\n\n    const entry = handleSaveProject({\n      ...otherPayload,\n      lastQuestionIndex:\n        typeof payloadLastQuestionIndex === 'number'\n          ? payloadLastQuestionIndex\n          : currentQuestionIndex,\n      status: 'draft'\n    });\n\n    if (entry) {\n      setValidationError(null);\n\n      const exported = exportProjectToFile({\n        projectName: entry.projectName,\n        answers: entry.answers\n      });\n\n      setSaveFeedback(\n        exported\n          ? {\n              status: 'success',\n              message: 'Votre projet a bien été enregistré dans vos téléchargements'\n            }\n          : {\n              status: 'error',\n              message: 'Projet enregistré mais le téléchargement a échoué. Veuillez réessayer.'\n            }\n      );\n    }\n  }, [currentQuestionIndex, handleSaveProject]);\n\n  const handleDismissSaveFeedback = useCallback(() => {\n    setSaveFeedback(null);\n  }, []);\n\n  const handleBackToQuestionnaire = useCallback(() => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      const firstMissingId = unansweredMandatoryQuestions[0].id;\n      const targetIndex = activeQuestions.findIndex(question => question.id === firstMissingId);\n      if (targetIndex >= 0) {\n        setCurrentQuestionIndex(targetIndex);\n      }\n    } else if (activeQuestions.length > 0) {\n      const lastIndex = activeQuestions.length - 1;\n      setCurrentQuestionIndex(prevIndex => {\n        if (prevIndex > lastIndex) {\n          return lastIndex;\n        }\n        return prevIndex;\n      });\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions, unansweredMandatoryQuestions]);\n\n  const handleNavigateToQuestion = useCallback((questionId) => {\n    const targetIndex = activeQuestions.findIndex(question => question.id === questionId);\n    if (targetIndex >= 0) {\n      setCurrentQuestionIndex(targetIndex);\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions]);\n\n  const handleNavigateToQuestionFromReport = useCallback((questionId) => {\n    setReturnToSynthesisAfterEdit(true);\n    handleNavigateToQuestion(questionId);\n  }, [handleNavigateToQuestion]);\n\n  const handleReturnToSynthesisFromQuestionnaire = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const handleProceedToSynthesis = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const showcaseProjectId = showcaseProjectContext?.projectId || '';\n  const showcaseShareUrl = useMemo(() => {\n    if (!showcaseProjectId || typeof window === 'undefined') {\n      return '';\n    }\n\n    const url = new URL(window.location.href);\n    url.searchParams.set('projectId', showcaseProjectId);\n    url.hash = 'showcase';\n    return url.toString();\n  }, [showcaseProjectId]);\n\n  const handleOpenShowcaseShare = useCallback(() => {\n    if (!showcaseProjectId) {\n      return;\n    }\n\n    setIsShowcaseShareOpen(true);\n    setShowcaseShareFeedback('');\n  }, [showcaseProjectId]);\n\n  const handleCloseShowcaseShare = useCallback(() => {\n    setIsShowcaseShareOpen(false);\n    setShowcaseShareFeedback('');\n  }, []);\n\n  const handleCopyShowcaseLink = useCallback(async () => {\n    if (!showcaseShareUrl) {\n      return;\n    }\n\n    try {\n      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n        await navigator.clipboard.writeText(showcaseShareUrl);\n        setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n        return;\n      }\n    } catch (error) {\n      // Fallback below.\n    }\n\n    if (typeof document !== 'undefined') {\n      const input = document.getElementById('showcase-share-link');\n      if (input && typeof input.select === 'function') {\n        input.select();\n        const copied = document.execCommand && document.execCommand('copy');\n        if (copied) {\n          setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n          return;\n        }\n      }\n    }\n\n    setShowcaseShareFeedback('Impossible de copier automatiquement le lien.');\n  }, [showcaseShareUrl]);\n\n  const handleDownloadShowcaseShortcut = useCallback(() => {\n    if (!showcaseShareUrl || typeof window === 'undefined') {\n      return;\n    }\n\n    const shortcutContent = `[InternetShortcut]\\nURL=${showcaseShareUrl}\\n`;\n    const blob = new Blob([shortcutContent], { type: 'text/plain' });\n    const fileName = `raccourci-showcase-${showcaseProjectId || 'projet'}.url`;\n    const downloadUrl = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n\n    anchor.href = downloadUrl;\n    anchor.download = fileName;\n    document.body.appendChild(anchor);\n    anchor.click();\n    anchor.remove();\n    URL.revokeObjectURL(downloadUrl);\n    setShowcaseShareFeedback('Raccourci téléchargé.');\n  }, [showcaseProjectId, showcaseShareUrl]);\n\n  return (\n    <div className={`min-h-screen ${annotationOffsetClass}`}>\n      <AnnotationLayer\n        isActive={isAnnotationModeEnabled && screen === 'showcase'}\n        isPaused={isAnnotationPaused}\n        isEditing={isShowcaseEditing}\n        notes={annotationNotes}\n        activeContextId={activeAnnotationContextKey}\n        sourceColors={annotationSources}\n        projectName={showcaseProjectContext?.projectName || ''}\n        autoFocusNoteId={autoFocusAnnotationId}\n        onAutoFocusComplete={() => setAutoFocusAnnotationId(null)}\n        onTogglePause={handleToggleAnnotationPause}\n        onRequestSave={handleSaveAnnotationNotes}\n        onRequestLoad={handleRequestAnnotationFile}\n        onExit={handleToggleAnnotationMode}\n        onNoteChange={handleAnnotationTextChange}\n        onNoteRemove={handleRemoveAnnotationNote}\n      />\n\n      <input\n        ref={annotationFileInputRef}\n        type=\"file\"\n        accept=\"application/json\"\n        className=\"sr-only\"\n        onChange={handleAnnotationFileChange}\n        data-annotation-ui=\"true\"\n      />\n\n      <div id=\"tour-onboarding-anchor\" className=\"sr-only\" aria-hidden=\"true\">\n        Guide interactif\n      </div>\n      <nav className=\"bg-white shadow-sm border-b border-gray-200 hv-surface\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-8 py-4\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-lg font-bold text-gray-800 sm:text-xl\">Project Navigator</h1>\n                <p className=\"text-xs text-gray-500\">Outil d'aide à la décision</p>\n              </div>\n            </div>\n\n            <div\n              className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 lg:justify-end\"\n              role=\"group\"\n              aria-label=\"Sélection du mode d'utilisation\"\n            >\n              {screen === 'showcase' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleToggleAnnotationMode}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      isAnnotationModeEnabled ? 'bg-blue-50 border-blue-200' : 'bg-white border-blue-100'\n                    }`}\n                    aria-pressed={isAnnotationModeEnabled}\n                    aria-label={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    title={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    data-annotation-ui=\"true\"\n                  >\n                    <MessageSquare className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Annotation</span>\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleOpenShowcaseShare}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      showcaseProjectId ? 'bg-white border-blue-100' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'\n                    }`}\n                    aria-label=\"Partager la vitrine du projet\"\n                    title={showcaseProjectId ? 'Partager la vitrine du projet' : 'Aucun projet vitrine disponible'}\n                    disabled={!showcaseProjectId}\n                  >\n                    <Link className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Partager</span>\n                  </button>\n                </>\n              )}\n              {mode === 'user' && screen === 'showcase' && showcaseProjectContext && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToComplianceReport}\n                  className=\"w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-blue-600 text-white hv-button-primary\"\n                  aria-label=\"Revenir à la synthèse du projet\"\n                  title=\"Revenir à la synthèse du projet\"\n                  data-tour-id=\"showcase-back-to-report\"\n                >\n                  Synthèse\n                </button>\n              )}\n              {mode === 'user' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleStartOnboarding}\n                    className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-2 ${\n                      isOnboardingActive\n                        ? 'bg-blue-600 text-white hv-button-primary'\n                        : isTourGuideReady\n                          ? 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 hv-focus-ring'\n                          : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'\n                    }`}\n                    disabled={!isTourGuideReady || isOnboardingActive}\n                    data-tour-id=\"nav-onboarding-trigger\"\n                    aria-label=\"Lancer le guide interactif\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Guide interactif</span>\n                  </button>\n                  {screen !== 'home' && (\n                    <button\n                      type=\"button\"\n                      onClick={() => setScreen('home')}\n                      className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-gray-100 text-gray-700 hover:bg-gray-200`}\n                      aria-pressed={false}\n                      aria-label=\"Retourner à l'accueil des projets\"\n                    >\n                      Accueil projets\n                    </button>\n                  )}\n                  <a\n                    href=\"https://forms.office.com/e/p6PYB1gbpM\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button text-white bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 hover:from-pink-600 hover:via-red-600 hover:to-yellow-600 focus-visible:ring-pink-400 hv-focus-ring\"\n                    aria-label=\"Partagez votre avis sur Project Navigator (nouvelle fenêtre)\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Partagez votre avis</span>\n                  </a>\n                </>\n              )}\n              {mode === 'admin' && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToProjectMode}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button ${\n                    mode === 'user'\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={mode === 'user'}\n                  aria-label=\"Basculer vers le mode chef de projet\"\n                >\n                  Mode Chef de Projet\n                </button>\n              )}\n              {!isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleActivateAdminOnHome}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center ${\n                    isAdminHomeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminHomeView}\n                  aria-label=\"Activer le mode administrateur sur la page d'accueil\"\n                  title=\"Activer le mode administrateur sur l'accueil\"\n                >\n                  <Lock className=\"text-lg sm:text-xl\" />\n                  <span className=\"sr-only\">Mode Administrateur (Accueil)</span>\n                </button>\n              )}\n              {isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleBackOfficeClick}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-3 ${\n                    isAdminBackOfficeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminBackOfficeView}\n                  aria-label=\"Accéder au Back-office\"\n                  title=\"Accéder au Back-office\"\n                >\n                  <span>Accéder au Back-office</span>\n                  <Settings className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                </button>\n              )}\n              {backOfficeAuthError && (\n                <p className=\"w-full text-sm text-red-600 sm:w-auto\" role=\"alert\">\n                  {backOfficeAuthError}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      {isShowcaseShareOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"showcase-share-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"text-center\">\n              <h2 id=\"showcase-share-title\" className=\"text-xl font-semibold text-gray-800\">\n                Partager la vitrine du projet\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Copiez le lien ou téléchargez un raccourci pour ouvrir directement cette vitrine.\n              </p>\n            </div>\n            <div className=\"space-y-3\">\n              <label htmlFor=\"showcase-share-link\" className=\"text-sm font-medium text-gray-700\">\n                Lien à partager\n              </label>\n              <input\n                id=\"showcase-share-link\"\n                type=\"text\"\n                value={showcaseShareUrl}\n                readOnly\n                className=\"w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-800\"\n              />\n              {showcaseShareFeedback && (\n                <p className=\"text-sm text-blue-600\">{showcaseShareFeedback}</p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCopyShowcaseLink}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Copier le lien\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadShowcaseShortcut}\n                className=\"px-5 py-2 bg-white text-blue-700 font-medium rounded-lg border border-blue-200 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button\"\n              >\n                Télécharger le raccourci\n              </button>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCloseShowcaseShare}\n                className=\"text-sm text-gray-500 hover:text-gray-700\"\n              >\n                Fermer\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {isBackOfficePromptOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"backoffice-auth-title\"\n        >\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={() => closeBackOfficePrompt(false)} aria-hidden=\"true\" />\n          <form\n            onSubmit={handleBackOfficePromptSubmit}\n            className=\"relative w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl hv-surface\"\n          >\n            <div className=\"text-center\">\n              <h2 id=\"backoffice-auth-title\" className=\"text-xl font-semibold text-gray-800\">\n                Accès back-office\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Saisissez le mot de passe administrateur pour continuer.\n              </p>\n            </div>\n            <div className=\"mt-5 space-y-3\">\n              <label htmlFor=\"backoffice-password\" className=\"text-sm font-medium text-gray-700\">\n                Mot de passe\n              </label>\n              <input\n                id=\"backoffice-password\"\n                type=\"password\"\n                value={backOfficePromptValue}\n                onChange={(event) => setBackOfficePromptValue(event.target.value)}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                placeholder=\"Mot de passe\"\n              />\n              {backOfficePromptError && (\n                <p className=\"text-sm text-red-600\" role=\"alert\">\n                  {backOfficePromptError}\n                </p>\n              )}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={() => closeBackOfficePrompt(false)}\n                className=\"px-5 py-2 bg-white text-gray-700 font-medium rounded-lg border border-gray-200 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700\"\n              >\n                Déverrouiller\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n\n      <main id=\"main-content\" tabIndex=\"-1\" className=\"focus:outline-none hv-background\">\n        {!isHydrated ? (\n          <div className=\"flex min-h-[60vh] items-center justify-center\">\n            <LoadingFallback\n              label=\"Chargement de l’accueil…\"\n              hint=\"Préparation de votre espace.\"\n            />\n          </div>\n        ) : isAdminBackOfficeView ? (\n          <Suspense\n            fallback={(\n              <LoadingFallback\n                label=\"Chargement du back-office…\"\n                hint=\"Préparation des données administratives en cours.\"\n              />\n            )}\n          >\n            <LazyBackOffice\n              projects={projects}\n              questions={questions}\n              setQuestions={setQuestions}\n              rules={rules}\n              setRules={setRules}\n              riskLevelRules={riskLevelRules}\n              setRiskLevelRules={setRiskLevelRules}\n              riskWeights={riskWeights}\n              setRiskWeights={setRiskWeights}\n              teams={teams}\n              setTeams={setTeams}\n              showcaseThemes={showcaseThemes}\n              setShowcaseThemes={setShowcaseThemes}\n              projectFilters={projectFilters}\n              setProjectFilters={updateProjectFilters}\n              inspirationFilters={inspirationFilters}\n              setInspirationFilters={updateInspirationFilters}\n              inspirationFormFields={inspirationFormFields}\n              setInspirationFormFields={updateInspirationFormFields}\n            />\n          </Suspense>\n        ) : screen === 'home' ? (\n          <HomeScreen\n            projects={projects}\n            projectFilters={projectFilters}\n            teamLeadOptions={teamLeadTeamOptions}\n            inspirationProjects={inspirationProjects}\n            inspirationFilters={inspirationFilters}\n            homeView={homeView}\n            onHomeViewChange={setHomeView}\n            onStartInspirationProject={handleStartInspirationProject}\n            onOpenInspirationProject={handleOpenInspirationProject}\n            onStartNewProject={handleCreateNewProject}\n            onOpenProject={handleOpenProject}\n            onDeleteProject={handleDeleteProject}\n            onShowProjectShowcase={handleShowProjectShowcase}\n            onImportProject={handleImportProject}\n            onDuplicateProject={handleDuplicateProject}\n            isAdminMode={isAdminMode}\n            tourContext={tourContext}\n          />\n        ) : screen === 'inspiration-form' ? (\n          <InspirationForm\n            formConfig={inspirationFormFields}\n            existingProjects={inspirationProjects}\n            onSubmit={handleSaveInspirationProject}\n            onCancel={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n          />\n        ) : screen === 'inspiration-detail' ? (\n          <InspirationDetail\n            project={activeInspirationProject}\n            formConfig={inspirationFormFields}\n            onBack={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n            onUpdate={handleUpdateInspirationProject}\n          />\n        ) : screen === 'questionnaire' ? (\n          <QuestionnaireScreen\n            questions={activeQuestions}\n            currentIndex={currentQuestionIndex}\n            answers={answers}\n            onAnswer={handleAnswer}\n            onNext={handleNext}\n            onBack={handleBack}\n            allQuestions={questions}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onSaveDraft={isOnboardingActive ? noop : handleSaveDraft}\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            validationError={validationError}\n            onReturnToSynthesis={\n              returnToSynthesisAfterEdit ? handleReturnToSynthesisFromQuestionnaire : undefined\n            }\n            isReturnToSynthesisRequested={returnToSynthesisAfterEdit}\n            tourContext={tourContext}\n            onFinish={navigateToSynthesis}\n          />\n        ) : screen === 'mandatory-summary' ? (\n          <MandatoryQuestionsSummary\n            pendingQuestions={pendingMandatoryQuestions}\n            totalQuestions={activeQuestions.length}\n            onBackToQuestionnaire={handleBackToQuestionnaire}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onProceedToSynthesis={handleProceedToSynthesis}\n          />\n        ) : screen === 'synthesis' ? (\n          <SynthesisReport\n            answers={answers}\n            analysis={analysis}\n            teams={teams}\n            questions={activeQuestions}\n            projectStatus={activeProject?.status || null}\n            projectId={activeProjectId}\n            projectName={activeProjectName}\n            onOpenProjectShowcase={handleOpenActiveProjectShowcase}\n            isProjectEditable={isActiveProjectEditable}\n            onRestart={handleRestart}\n            onBack={isActiveProjectEditable ? handleBackToQuestionnaire : undefined}\n            onUpdateAnswers={isActiveProjectEditable ? handleUpdateAnswers : undefined}\n            onSubmitProject={handleSubmitProject}\n            onNavigateToQuestion={handleNavigateToQuestionFromReport}\n            isExistingProject={Boolean(activeProjectId)}\n            onSaveDraft={\n              isOnboardingActive\n                ? noop\n                : isActiveProjectEditable\n                  ? handleSaveDraft\n                  : undefined\n            }\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            isAdminMode={isAdminMode}\n            hasIncompleteAnswers={hasIncompleteAnswers}\n            tourContext={tourContext}\n          />\n        ) : screen === 'showcase' ? (\n          showcaseProjectContext ? (\n            <div className=\"space-y-4\">\n              {showcaseProjectContext.status !== 'draft' && (\n                <div className=\"rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800 hv-surface\">\n                  {isAdminMode\n                    ? 'Ce projet a été soumis. Vous pouvez le modifier car vous êtes en mode administrateur.'\n                    : 'Ce projet a été soumis. La vitrine est consultable en lecture seule.'}\n                </div>\n              )}\n              <Suspense\n                fallback={(\n                  <LoadingFallback\n                    label=\"Chargement de la vitrine du projet…\"\n                    hint=\"Nous construisons la synthèse visuelle du projet.\"\n                  />\n                )}\n              >\n                <LazyProjectShowcase\n                  projectName={showcaseProjectContext.projectName}\n                  onClose={handleCloseProjectShowcase}\n                  analysis={showcaseProjectContext.analysis}\n                  relevantTeams={showcaseProjectContext.relevantTeams}\n                  questions={showcaseProjectContext.questions}\n                  answers={showcaseProjectContext.answers}\n                  timelineDetails={showcaseProjectContext.timelineDetails}\n                  showcaseThemes={showcaseThemes}\n                  hasIncompleteAnswers={Boolean(showcaseProjectContext.hasIncompleteAnswers)}\n                  onUpdateAnswers={\n                    isOnboardingActive\n                      ? noop\n                      : showcaseProjectContext.status === 'draft' || isAdminMode\n                        ? handleUpdateProjectShowcaseAnswers\n                        : undefined\n                  }\n                  tourContext={tourContext}\n                  onAnnotationScopeChange={setShowcaseAnnotationScope}\n                  onEditingStateChange={setIsShowcaseEditing}\n                />\n              </Suspense>\n            </div>\n          ) : null\n        ) : null}\n      </main>\n\n      <footer className=\"bg-white border-t border-gray-200 mt-10\" aria-label=\"Pied de page\">\n        <p className=\"text-xs text-gray-400 text-center py-4\">\n          Project Navigator · Version {APP_VERSION} ·{' '}\n          <a\n            href=\"./mentions-legales.html\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"underline hover:text-gray-500\"\n          >\n            Mentions légales\n          </a>\n        </p>\n      </footer>\n    </div>\n  );\n};\n",
  "src/components/AnnotationLayer.jsx": "import React, { useEffect, useMemo, useRef, useState } from '../react.js';\nimport { Close, Pause, Play, Save, Upload } from './icons.js';\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst escapeAttributeValue = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  if (typeof CSS !== 'undefined' && typeof CSS.escape === 'function') {\n    return CSS.escape(value);\n  }\n\n  return value.replace(/\"/g, '\\\\\"');\n};\n\nconst STATUS_BADGE = {\n  active: 'bg-emerald-500 text-white',\n  paused: 'bg-amber-500 text-white'\n};\n\nconst SOURCE_PALETTE_KEYS = ['palette-0', 'palette-1', 'palette-2', 'palette-3', 'palette-4'];\n\nconst getFeedbackPaletteKey = (note, sourcePalette) => {\n  if (note?.sourceId && note.sourceId !== 'session') {\n    return sourcePalette.get(note.sourceId) || 'palette-0';\n  }\n\n  return 'base';\n};\n\nexport const AnnotationLayer = ({\n  isActive = false,\n  isPaused = false,\n  isEditing = false,\n  notes = [],\n  activeContextId = '',\n  projectName = '',\n  autoFocusNoteId = null,\n  onTogglePause,\n  onRequestSave,\n  onRequestLoad,\n  onExit,\n  onNoteChange,\n  onNoteRemove,\n  onAutoFocusComplete\n}) => {\n  const [, setLayoutVersion] = useState(0);\n  const visibleNotes = useMemo(\n    () => notes.filter(note => note && note.contextId === activeContextId),\n    [activeContextId, notes]\n  );\n  const sourcePalette = useMemo(() => {\n    const palette = new Map();\n    let paletteIndex = 0;\n\n    visibleNotes.forEach((note) => {\n      if (!note?.sourceId || note.sourceId === 'session' || palette.has(note.sourceId)) {\n        return;\n      }\n\n      const key = SOURCE_PALETTE_KEYS[paletteIndex % SOURCE_PALETTE_KEYS.length] || 'palette-0';\n      palette.set(note.sourceId, key);\n      paletteIndex += 1;\n    });\n\n    return palette;\n  }, [visibleNotes]);\n\n  const textareaRefs = useRef(new Map());\n\n  const registerTextareaRef = (noteId) => (node) => {\n    if (!noteId) {\n      return;\n    }\n\n    if (node) {\n      textareaRefs.current.set(noteId, node);\n    } else {\n      textareaRefs.current.delete(noteId);\n    }\n  };\n\n  useEffect(() => {\n    if (!autoFocusNoteId) {\n      return;\n    }\n\n    const target = textareaRefs.current.get(autoFocusNoteId);\n    if (target && typeof target.focus === 'function') {\n      target.focus();\n      if (typeof target.setSelectionRange === 'function') {\n        const length = target.value?.length ?? 0;\n        target.setSelectionRange(length, length);\n      }\n      if (typeof onAutoFocusComplete === 'function') {\n        onAutoFocusComplete(autoFocusNoteId);\n      }\n    }\n  }, [autoFocusNoteId, onAutoFocusComplete]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleLayoutRefresh = () => {\n      setLayoutVersion(previous => previous + 1);\n    };\n\n    window.addEventListener('resize', handleLayoutRefresh);\n    window.addEventListener('scroll', handleLayoutRefresh, true);\n\n    return () => {\n      window.removeEventListener('resize', handleLayoutRefresh);\n      window.removeEventListener('scroll', handleLayoutRefresh, true);\n    };\n  }, []);\n\n  const getAnnotationAnchor = (note) => {\n    if (typeof document === 'undefined' || !note?.sectionId) {\n      return null;\n    }\n\n    const escapedSectionId = escapeAttributeValue(note.sectionId);\n\n    if (escapedSectionId && isEditing) {\n      const editAnchor = document.querySelector(`[data-annotation-target-section=\"${escapedSectionId}\"]`);\n      if (editAnchor) {\n        return editAnchor;\n      }\n    }\n\n    if (escapedSectionId) {\n      const displayAnchor = document.querySelector(`[data-showcase-section=\"${escapedSectionId}\"]`);\n      if (displayAnchor) {\n        return displayAnchor;\n      }\n    }\n\n    return null;\n  };\n\n  const computeNotePosition = (note) => {\n    const viewportWidth = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const viewportHeight = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const anchor = getAnnotationAnchor(note);\n\n    if (anchor && typeof anchor.getBoundingClientRect === 'function') {\n      const rect = anchor.getBoundingClientRect();\n      const relativeX = clamp01(note?.sectionX ?? note?.x ?? 0.5);\n      const relativeY = clamp01(note?.sectionY ?? note?.y ?? 0.5);\n\n      return {\n        left: rect.left + rect.width * relativeX,\n        top: rect.top + rect.height * relativeY\n      };\n    }\n\n    const fallbackX = clamp01(note?.x ?? 0.5);\n    const fallbackY = clamp01(note?.y ?? 0.5);\n\n    return {\n      left: fallbackX * viewportWidth,\n      top: fallbackY * viewportHeight\n    };\n  };\n\n  if (!isActive) {\n    return null;\n  }\n\n  return (\n    <React.Fragment>\n      <div className=\"fixed top-0 inset-x-0 z-[99999]\" data-annotation-ui=\"true\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-8\">\n          <div className=\"mt-2 rounded-b-xl bg-white border border-slate-200 text-slate-900 shadow-2xl px-4 py-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"flex items-center gap-2 text-sm text-slate-800\">\n              <span className=\"font-semibold\">Mode annotation</span>\n              <span className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold ${\n                isPaused ? STATUS_BADGE.paused : STATUS_BADGE.active\n              }`}>\n                <span className=\"w-2 h-2 rounded-full bg-white\" aria-hidden=\"true\" />\n                {isPaused ? 'En pause' : 'Actif'}\n              </span>\n              {projectName ? (\n                <span className=\"text-xs text-slate-600\">Projet : {projectName}</span>\n              ) : null}\n            </div>\n\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <button\n                type=\"button\"\n                onClick={onExit}\n                className=\"inline-flex items-center justify-center rounded-full border border-slate-200 bg-white p-2 text-slate-600 hover:text-slate-900 hover:border-slate-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n                aria-label=\"Quitter le mode annotation\"\n                title=\"Quitter le mode annotation\"\n              >\n                <Close className=\"h-4 w-4\" />\n              </button>\n              <button\n                type=\"button\"\n                onClick={onRequestSave}\n                className=\"inline-flex items-center gap-2 rounded-lg bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n              >\n                <Save className=\"h-4 w-4\" />\n                Sauvegarder\n              </button>\n              <button\n                type=\"button\"\n                onClick={onRequestLoad}\n                className=\"inline-flex items-center gap-2 rounded-lg bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n              >\n                <Upload className=\"h-4 w-4\" />\n                Charger\n              </button>\n              <button\n                type=\"button\"\n                onClick={onTogglePause}\n                className=\"inline-flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n              >\n                {isPaused ? <Play className=\"h-4 w-4\" /> : <Pause className=\"h-4 w-4\" />}\n                {isPaused ? 'Relancer' : 'Mettre en pause'}\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"annotation-sticky-layer\" data-annotation-ui=\"true\">\n        {visibleNotes.map((note, index) => {\n          const position = computeNotePosition(note);\n          const label = note.sourceId && note.sourceId !== 'session' ? note.sourceId : `#${index + 1}`;\n          const paletteKey = getFeedbackPaletteKey(note, sourcePalette);\n\n          return (\n            <div\n              key={note.id}\n              className=\"annotation-sticky feedback-note\"\n              style={{ left: `${position.left}px`, top: `${position.top}px` }}\n              data-annotation-ui=\"true\"\n              data-feedback-source-color={paletteKey}\n            >\n              <div className=\"feedback-note-header\">\n                <span className=\"feedback-note-number\">{label}</span>\n                {onNoteRemove ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => onNoteRemove(note.id)}\n                    className=\"feedback-note-delete\"\n                    aria-label=\"Supprimer le sticky note\"\n                  >\n                    <Close className=\"h-4 w-4\" />\n                  </button>\n                ) : null}\n              </div>\n              <textarea\n                value={note.text || ''}\n                onChange={(event) => onNoteChange && onNoteChange(note.id, event.target.value)}\n                ref={registerTextareaRef(note.id)}\n                className=\"feedback-note-text\"\n                rows={4}\n                placeholder=\"Ajoutez votre remarque ici...\"\n                data-annotation-ui=\"true\"\n              />\n            </div>\n          );\n        })}\n      </div>\n    </React.Fragment>\n  );\n};\n",
  "src/components/InspirationForm.jsx": "import React, { useEffect, useMemo, useState } from '../react.js';\nimport { Plus, Save, Close } from './icons.js';\nimport { normalizeInspirationFormConfig } from '../utils/inspirationConfig.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\n\nconst buildInitialFormState = (config) => {\n  const fields = Array.isArray(config?.fields) ? config.fields : [];\n  const initialState = {};\n\n  fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.type === 'documents') {\n      initialState[field.id] = [{ name: '', url: '' }];\n      return;\n    }\n\n    if (field.type === 'multi_select') {\n      initialState[field.id] = [];\n      return;\n    }\n\n    initialState[field.id] = '';\n  });\n\n  return initialState;\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeMultiSelect = (value) =>\n  Array.isArray(value)\n    ? value\n        .map((item) => (typeof item === 'string' ? item.trim() : ''))\n        .filter(Boolean)\n    : [];\n\nconst renderFieldLabel = (field) => {\n  if (!field) {\n    return '';\n  }\n\n  return field.required ? `${field.label} *` : field.label;\n};\n\nexport const InspirationForm = ({\n  formConfig,\n  existingProjects = [],\n  onSubmit,\n  onCancel\n}) => {\n  const normalizedConfig = useMemo(\n    () => normalizeInspirationFormConfig(formConfig),\n    [formConfig]\n  );\n  const [formState, setFormState] = useState(() => buildInitialFormState(normalizedConfig));\n  const [errors, setErrors] = useState({});\n\n  const labSuggestions = useMemo(() => {\n    const suggestions = new Set();\n    existingProjects.forEach((project) => {\n      const name = typeof project?.labName === 'string' ? project.labName.trim() : '';\n      if (name.length > 0) {\n        suggestions.add(name);\n      }\n    });\n    return Array.from(suggestions).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));\n  }, [existingProjects]);\n\n  useEffect(() => {\n    setFormState((prev) => {\n      const baseState = buildInitialFormState(normalizedConfig);\n      const merged = { ...baseState, ...prev };\n\n      normalizedConfig.fields.forEach((field) => {\n        if (field.type !== 'documents') {\n          if (field.type === 'multi_select' && !Array.isArray(merged[field.id])) {\n            merged[field.id] = baseState[field.id];\n          }\n          return;\n        }\n\n        if (!Array.isArray(merged[field.id]) || merged[field.id].length === 0) {\n          merged[field.id] = baseState[field.id];\n        }\n      });\n\n      return merged;\n    });\n  }, [normalizedConfig]);\n\n  const updateField = (fieldId, value) => {\n    setFormState((prev) => ({ ...prev, [fieldId]: value }));\n  };\n\n  const handleDocumentChange = (fieldId, index, key, value) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      const target = nextDocuments[index] || { name: '', url: '' };\n      nextDocuments[index] = { ...target, [key]: value };\n      return { ...prev, [fieldId]: nextDocuments };\n    });\n  };\n\n  const handleAddDocument = (fieldId) => {\n    setFormState((prev) => ({\n      ...prev,\n      [fieldId]: [...(prev[fieldId] || []), { name: '', url: '' }]\n    }));\n  };\n\n  const handleRemoveDocument = (fieldId, index) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      nextDocuments.splice(index, 1);\n      return {\n        ...prev,\n        [fieldId]: nextDocuments.length > 0 ? nextDocuments : [{ name: '', url: '' }]\n      };\n    });\n  };\n\n  const validate = () => {\n    const nextErrors = {};\n\n    normalizedConfig.fields.forEach((field) => {\n      if (!field.enabled || !field.required) {\n        return;\n      }\n\n      const value = formState[field.id];\n      if (field.type === 'documents') {\n        const normalizedDocs = normalizeDocuments(value);\n        if (normalizedDocs.length === 0) {\n          nextErrors[field.id] = 'Veuillez renseigner au moins un document.';\n        }\n        return;\n      }\n\n      if (field.type === 'multi_select') {\n        const normalizedSelections = normalizeMultiSelect(value);\n        if (normalizedSelections.length === 0) {\n          nextErrors[field.id] = 'Veuillez sélectionner au moins une option.';\n        }\n        return;\n      }\n\n      if (value == null || (typeof value === 'string' && value.trim().length === 0)) {\n        nextErrors[field.id] = 'Ce champ est requis.';\n      }\n    });\n\n    setErrors(nextErrors);\n    return Object.keys(nextErrors).length === 0;\n  };\n\n  const handleSubmit = (event) => {\n    event.preventDefault();\n    if (!validate()) {\n      return;\n    }\n\n    const now = new Date().toISOString();\n    const payload = normalizedConfig.fields.reduce((acc, field) => {\n      if (!field.enabled) {\n        return acc;\n      }\n\n      if (field.type === 'documents') {\n        acc[field.id] = normalizeDocuments(formState[field.id]);\n        return acc;\n      }\n\n      if (field.type === 'multi_select') {\n        acc[field.id] = normalizeMultiSelect(formState[field.id]);\n        return acc;\n      }\n\n      const value = formState[field.id];\n      if (typeof value === 'string') {\n        acc[field.id] = value.trim();\n        return acc;\n      }\n\n      acc[field.id] = value ?? '';\n      return acc;\n    }, {});\n\n    payload.visibility = 'personal';\n    payload.createdAt = now;\n    payload.updatedAt = now;\n\n    if (typeof onSubmit === 'function') {\n      onSubmit(payload);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8\">\n      <div className=\"max-w-4xl mx-auto\">\n        <header className=\"mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-600\">\n              Nouvel exemple inspirant\n            </p>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Questionnaire projet inspiration</h1>\n            <p className=\"mt-2 text-sm text-gray-600\">\n              Documentez un projet inspirant issu d'un autre laboratoire afin d'enrichir la base d'exemples.\n            </p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={onCancel}\n            className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n          >\n            <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n            Retour\n          </button>\n        </header>\n\n        <form\n          onSubmit={handleSubmit}\n          className=\"space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-lg\"\n        >\n          <p className=\"text-xs italic text-gray-400\">\n            Le LFB traite les données recueillies pour gérer les projets à soumettre aux équipes compliance.{' '}\n            <a\n              href=\"./mentions-legales.html\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"underline hover:text-gray-500\"\n            >\n              En savoir plus sur vos données et vos droits\n            </a>\n          </p>\n          <div className=\"grid grid-cols-1 gap-6 md:grid-cols-2\">\n            {normalizedConfig.fields\n              .filter((field) => field.enabled && field.type !== 'long_text' && field.type !== 'documents')\n              .map((field) => {\n                if (field.type === 'select') {\n                  const emptyOptionLabel = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'Sélectionner...';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        value={formState[field.id] || ''}\n                        onChange={(event) => updateField(field.id, event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">{emptyOptionLabel}</option>\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.type === 'multi_select') {\n                  const selectedValues = Array.isArray(formState[field.id]) ? formState[field.id] : [];\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        multiple\n                        value={selectedValues}\n                        onChange={(event) =>\n                          updateField(\n                            field.id,\n                            Array.from(event.target.selectedOptions).map((option) => option.value)\n                          )}\n                        className=\"min-h-[120px] rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.id === 'labName') {\n                  const placeholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'Nom du laboratoire';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <input\n                        type=\"text\"\n                        list=\"inspiration-labs\"\n                        value={formState.labName}\n                        onChange={(event) => updateField('labName', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        placeholder={placeholder}\n                      />\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                const inputType = field.type === 'url' ? 'url' : 'text';\n                const inputPlaceholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                  ? field.placeholder.trim()\n                  : field.type === 'url'\n                    ? 'https://...'\n                    : '';\n\n                return (\n                  <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                    <span>{renderFieldLabel(field)}</span>\n                    <input\n                      type={inputType}\n                      value={formState[field.id] || ''}\n                      onChange={(event) => updateField(field.id, event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder={inputPlaceholder}\n                    />\n                    {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                  </label>\n                );\n              })}\n          </div>\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'long_text')\n            .map((field) => (\n              <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                <span>{renderFieldLabel(field)}</span>\n                <RichTextEditor\n                  id={`inspiration-${field.id}`}\n                  value={formState[field.id] || ''}\n                  onChange={(value) => updateField(field.id, value)}\n                  ariaLabel={`${field.label} (édition riche)`}\n                  placeholder={\n                    typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                      ? field.placeholder.trim()\n                      : field.id === 'review'\n                        ? 'Ajoutez votre avis détaillé sur ce projet inspirant...'\n                        : 'Saisir une description détaillée...'\n                  }\n                  compact\n                />\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </label>\n            ))}\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'documents')\n            .map((field) => (\n              <div key={field.id} className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-gray-700\">{renderFieldLabel(field)}</p>\n                    <p className=\"text-xs text-gray-500\">\n                      Ajoutez plusieurs documents (nom + URL).\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={() => handleAddDocument(field.id)}\n                    className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n                  >\n                    <Plus className=\"h-4 w-4\" aria-hidden=\"true\" />\n                    Ajouter\n                  </button>\n                </div>\n                <div className=\"space-y-3\">\n                  {(formState[field.id] || []).map((doc, index) => (\n                    <div\n                      key={`doc-${index}`}\n                      className=\"grid grid-cols-1 gap-3 rounded-xl border border-gray-200 bg-gray-50 p-3 md:grid-cols-[1fr_1fr_auto]\"\n                    >\n                      <input\n                        type=\"text\"\n                        value={doc.name}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'name', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"Nom du document\"\n                      />\n                      <input\n                        type=\"url\"\n                        value={doc.url}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'url', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"https://...\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemoveDocument(field.id, index)}\n                        className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-100\"\n                      >\n                        Retirer\n                      </button>\n                    </div>\n                  ))}\n                </div>\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </div>\n            ))}\n\n          <datalist id=\"inspiration-labs\">\n            {labSuggestions.map((suggestion) => (\n              <option key={suggestion} value={suggestion} />\n            ))}\n          </datalist>\n\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-end\">\n            <button\n              type=\"button\"\n              onClick={onCancel}\n              className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n            >\n              Annuler\n            </button>\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n            >\n              <Save className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Enregistrer le projet\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/RichTextEditor.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport { sanitizeRichText } from '../utils/richText.js';\n\nconst BUTTON_BASE_CLASSES =\n  'inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1';\n\nconst commandIsAvailable = () => typeof document !== 'undefined' && typeof document.execCommand === 'function';\n\nconst normalizeValue = (value) => (typeof value === 'string' ? value : '');\n\nexport const RichTextEditor = ({\n  id,\n  value,\n  onChange,\n  placeholder = 'Commencez votre saisie (texte riche et liens autorisés)',\n  compact = false,\n  ariaLabel\n}) => {\n  const editorRef = useRef(null);\n  const linkTextInputRef = useRef(null);\n  const selectionRangeRef = useRef(null);\n  const selectedTextRef = useRef('');\n  const [htmlValue, setHtmlValue] = useState(() => normalizeValue(value));\n  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);\n  const [linkText, setLinkText] = useState('');\n  const [linkUrl, setLinkUrl] = useState('https://');\n  const [linkError, setLinkError] = useState('');\n\n  useEffect(() => {\n    setHtmlValue(normalizeValue(value));\n  }, [value]);\n\n  useEffect(() => {\n    const normalized = normalizeValue(value);\n    setHtmlValue(normalized);\n\n    if (!editorRef.current) {\n      return;\n    }\n\n    const isFocused =\n      typeof document !== 'undefined' && document.activeElement === editorRef.current;\n\n    if (isFocused) {\n      return;\n    }\n\n    if (editorRef.current.innerHTML !== normalized) {\n      editorRef.current.innerHTML = normalized || '';\n    }\n  }, [value]);\n\n  useEffect(() => {\n    if (isLinkModalOpen && linkTextInputRef.current) {\n      linkTextInputRef.current.focus();\n    }\n  }, [isLinkModalOpen]);\n\n  const emitChange = useCallback(\n    (nextValue) => {\n      const sanitized = sanitizeRichText(nextValue || '');\n      setHtmlValue(sanitized);\n      onChange?.(sanitized);\n      return sanitized;\n    },\n    [onChange]\n  );\n\n  const syncEditorHtml = useCallback((sanitized) => {\n    if (!editorRef.current) {\n      return;\n    }\n\n    if (editorRef.current.innerHTML === sanitized) {\n      return;\n    }\n\n    editorRef.current.innerHTML = sanitized || '';\n\n    if (typeof document !== 'undefined' && document.activeElement === editorRef.current) {\n      const selection = typeof window !== 'undefined' && typeof window.getSelection === 'function'\n        ? window.getSelection()\n        : null;\n      if (selection) {\n        const range = document.createRange();\n        range.selectNodeContents(editorRef.current);\n        range.collapse(false);\n        selection.removeAllRanges();\n        selection.addRange(range);\n      }\n    }\n  }, []);\n\n  const handleInput = useCallback(() => {\n    const sanitized = emitChange(editorRef.current?.innerHTML || '');\n    syncEditorHtml(sanitized);\n  }, [emitChange, syncEditorHtml]);\n\n  const handleBlur = useCallback(() => {\n    const sanitized = emitChange(editorRef.current?.innerHTML || '');\n\n    if (editorRef.current && editorRef.current.innerHTML !== sanitized) {\n      editorRef.current.innerHTML = sanitized || '';\n    }\n  }, [emitChange]);\n\n  const handlePaste = useCallback(\n    (event) => {\n      if (!event?.clipboardData) {\n        return;\n      }\n\n      const text = event.clipboardData.getData('text/plain');\n      if (commandIsAvailable()) {\n        event.preventDefault();\n        document.execCommand('insertText', false, text);\n        handleInput();\n      }\n    },\n    [handleInput]\n  );\n\n  const applyCommand = useCallback(\n    (command, argument = null) => {\n      if (!commandIsAvailable()) {\n        return;\n      }\n\n      document.execCommand(command, false, argument);\n      handleInput();\n    },\n    [handleInput]\n  );\n\n  const handleAddLink = useCallback(() => {\n    if (typeof window === 'undefined' || !commandIsAvailable()) {\n      return;\n    }\n\n    const selection = typeof window.getSelection === 'function' ? window.getSelection() : null;\n    const selectedText = selection?.toString() || '';\n    selectionRangeRef.current =\n      selection && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;\n    selectedTextRef.current = selectedText;\n    setLinkText(selectedText);\n    setLinkUrl('https://');\n    setLinkError('');\n    setIsLinkModalOpen(true);\n  }, [applyCommand]);\n\n  const handleCloseLinkModal = useCallback(() => {\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, []);\n\n  const handleConfirmLink = useCallback((event) => {\n    event?.preventDefault?.();\n\n    const trimmedUrl = linkUrl.trim();\n    if (!/^https?:\\/\\//i.test(trimmedUrl)) {\n      setLinkError('Veuillez saisir une URL valide (https://...)');\n      return;\n    }\n\n    const normalizedDisplayText = linkText.trim() || selectedTextRef.current || trimmedUrl;\n    const linkHtml = `<a href=\"${trimmedUrl}\" target=\"_blank\" rel=\"noopener noreferrer\">${normalizedDisplayText}</a>`;\n\n    if (typeof window !== 'undefined' && selectionRangeRef.current && typeof window.getSelection === 'function') {\n      const selection = window.getSelection();\n      if (selection) {\n        selection.removeAllRanges();\n        selection.addRange(selectionRangeRef.current);\n      }\n    }\n\n    applyCommand('insertHTML', linkHtml);\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, [applyCommand, linkText, linkUrl]);\n\n  const minHeight = useMemo(() => (compact ? 120 : 180), [compact]);\n  const showPlaceholder = !htmlValue;\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex flex-wrap gap-2\">\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('bold')}>\n          <span className=\"font-semibold\">G</span>\n          <span className=\"sr-only\">Mettre en gras</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('italic')}>\n          <span className=\"italic\">I</span>\n          <span className=\"sr-only\">Italique</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('underline')}>\n          <span className=\"underline\">U</span>\n          <span className=\"sr-only\">Souligner</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('insertUnorderedList')}>\n          <span aria-hidden=\"true\">• • •</span>\n          <span className=\"sr-only\">Liste à puces</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={handleAddLink}>\n          <span aria-hidden=\"true\">🔗</span>\n          <span className=\"sr-only\">Insérer un lien</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('removeFormat')}>\n          <span aria-hidden=\"true\">⟲</span>\n          <span className=\"sr-only\">Nettoyer la mise en forme</span>\n        </button>\n      </div>\n      <div className=\"relative\">\n        {showPlaceholder && (\n          <div\n            className=\"pointer-events-none absolute inset-0 px-4 py-3 text-sm text-gray-400 select-none leading-relaxed\"\n            style={{ pointerEvents: 'none', userSelect: 'none' }}\n          >\n            {placeholder}\n          </div>\n        )}\n        <div\n          id={id}\n          ref={editorRef}\n          className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[120px] prose prose-sm max-w-none hv-focus-ring hv-richtext\"\n          style={{ minHeight }}\n          contentEditable={true}\n          suppressContentEditableWarning\n          onInput={handleInput}\n          onBlur={handleBlur}\n          onPaste={handlePaste}\n          onKeyUp={handleInput}\n          onCompositionEnd={handleInput}\n          tabIndex={0}\n          role=\"textbox\"\n          aria-label={ariaLabel || placeholder}\n        />\n      </div>\n      {isLinkModalOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={handleCloseLinkModal} aria-hidden=\"true\" />\n          <form\n            className=\"relative w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl\"\n            onSubmit={handleConfirmLink}\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby={`${id}-link-modal-title`}\n          >\n            <h3 id={`${id}-link-modal-title`} className=\"text-lg font-semibold text-gray-900\">\n              Insérer un lien\n            </h3>\n            <p className=\"mt-1 text-sm text-gray-500\">\n              Renseignez le texte à afficher et l’URL complète (https://).\n            </p>\n            <div className=\"mt-4 space-y-4\">\n              <div>\n                <label htmlFor={`${id}-link-text`} className=\"block text-sm font-medium text-gray-700\">\n                  Texte du lien\n                </label>\n                <input\n                  id={`${id}-link-text`}\n                  ref={linkTextInputRef}\n                  type=\"text\"\n                  value={linkText}\n                  onChange={(event) => setLinkText(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"Ex : Découvrir le document\"\n                />\n              </div>\n              <div>\n                <label htmlFor={`${id}-link-url`} className=\"block text-sm font-medium text-gray-700\">\n                  URL\n                </label>\n                <input\n                  id={`${id}-link-url`}\n                  type=\"url\"\n                  value={linkUrl}\n                  onChange={(event) => setLinkUrl(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"https://exemple.com\"\n                />\n                {linkError && <p className=\"mt-2 text-sm text-red-600\">{linkError}</p>}\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-wrap justify-end gap-3\">\n              <button\n                type=\"button\"\n                onClick={handleCloseLinkModal}\n                className=\"rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700\"\n              >\n                Insérer le lien\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/utils/linkify.js": "import React from '../react.js';\nimport { sanitizeRichText } from './richText.js';\n\nconst URL_REGEX = /(https?:\\/\\/[^\\s]+)/g;\nconst TRAILING_PUNCTUATION_REGEX = /[)\\]\\}.,;!?]+$/;\n\nconst renderWithDomSanitizer = (text) => {\n  if (typeof DOMParser === 'undefined' || typeof document === 'undefined') {\n    return null;\n  }\n\n  const sanitized = sanitizeRichText(text);\n\n  if (typeof sanitized !== 'string' || sanitized.length === 0) {\n    return null;\n  }\n\n  return <span className=\"hv-richtext\" dangerouslySetInnerHTML={{ __html: sanitized }} />;\n};\n\nconst renderWithoutDomParser = (text) => {\n  const matches = Array.from(text.matchAll(URL_REGEX));\n\n  if (matches.length === 0) {\n    return text;\n  }\n\n  const elements = [];\n  let lastIndex = 0;\n\n  matches.forEach((match, matchIdx) => {\n    const fullMatch = match[0];\n    const offset = match.index ?? 0;\n\n    if (offset > lastIndex) {\n      elements.push(text.slice(lastIndex, offset));\n    }\n\n    let url = fullMatch;\n    const trailingMatch = url.match(TRAILING_PUNCTUATION_REGEX);\n    let trailing = '';\n\n    if (trailingMatch) {\n      url = url.slice(0, -trailingMatch[0].length);\n      trailing = trailingMatch[0];\n    }\n\n    elements.push(\n      <a\n        key={`link-${offset}-${matchIdx}`}\n        href={url}\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        className=\"text-blue-600 underline\"\n      >\n        {url}\n      </a>\n    );\n\n    if (trailing) {\n      elements.push(trailing);\n    }\n\n    lastIndex = offset + fullMatch.length;\n  });\n\n  if (lastIndex < text.length) {\n    elements.push(text.slice(lastIndex));\n  }\n\n  return elements;\n};\n\nexport const renderTextWithLinks = (text) => {\n  if (typeof text !== 'string' || text.length === 0) {\n    return text;\n  }\n\n  const rendered = renderWithDomSanitizer(text);\n\n  if (rendered !== null) {\n    return rendered;\n  }\n\n  return renderWithoutDomParser(text);\n};\n",
  "src/utils/richText.js": "import React from '../react.js';\n\nconst URL_REGEX = /(https?:\\/\\/[^\\s<]+)/gi;\nconst TRAILING_PUNCTUATION_REGEX = /[)\\]\\}.,;!?]+$/;\nconst ALLOWED_TAGS = new Set(['b', 'strong', 'i', 'em', 'u', 'p', 'br', 'ul', 'ol', 'li', 'a']);\n\nconst ensureAllowedAnchor = (node) => {\n  if (!node || node.nodeName?.toLowerCase() !== 'a') {\n    return;\n  }\n\n  const href = node.getAttribute('href') || '';\n  const isHttpLink = /^https?:\\/\\//i.test(href);\n\n  if (!isHttpLink) {\n    node.removeAttribute('href');\n  } else {\n    node.setAttribute('href', href);\n  }\n\n  node.setAttribute('target', '_blank');\n  node.setAttribute('rel', 'noopener noreferrer');\n\n  Array.from(node.attributes || []).forEach(attribute => {\n    const name = attribute?.name?.toLowerCase();\n    if (!['href', 'target', 'rel'].includes(name)) {\n      node.removeAttribute(attribute.name);\n    }\n  });\n};\n\nconst linkifyTextNode = (node, documentContext) => {\n  if (!node || node.nodeType !== 3) {\n    return;\n  }\n\n  const textContent = node.textContent || '';\n  const matches = Array.from(textContent.matchAll(URL_REGEX));\n\n  if (matches.length === 0) {\n    return;\n  }\n\n  const fragment = documentContext.createDocumentFragment();\n  let lastIndex = 0;\n\n  matches.forEach(match => {\n    const fullMatch = match[0];\n    const offset = match.index ?? 0;\n\n    if (offset > lastIndex) {\n      fragment.appendChild(documentContext.createTextNode(textContent.slice(lastIndex, offset)));\n    }\n\n    let url = fullMatch;\n    const trailingMatch = url.match(TRAILING_PUNCTUATION_REGEX);\n    let trailing = '';\n\n    if (trailingMatch) {\n      url = url.slice(0, -trailingMatch[0].length);\n      trailing = trailingMatch[0];\n    }\n\n    const anchor = documentContext.createElement('a');\n    anchor.textContent = url;\n    anchor.href = url;\n    anchor.target = '_blank';\n    anchor.rel = 'noopener noreferrer';\n    fragment.appendChild(anchor);\n\n    if (trailing) {\n      fragment.appendChild(documentContext.createTextNode(trailing));\n    }\n\n    lastIndex = offset + fullMatch.length;\n  });\n\n  if (lastIndex < textContent.length) {\n    fragment.appendChild(documentContext.createTextNode(textContent.slice(lastIndex)));\n  }\n\n  node.replaceWith(fragment);\n};\n\nconst sanitizeNode = (node, documentContext) => {\n  if (!node) {\n    return;\n  }\n\n  const nodeType = node.nodeType;\n\n  if (nodeType === 3) {\n    linkifyTextNode(node, documentContext);\n    return;\n  }\n\n  if (nodeType !== 1) {\n    node.remove();\n    return;\n  }\n\n  const tagName = node.nodeName?.toLowerCase();\n\n  if (!ALLOWED_TAGS.has(tagName)) {\n    const parent = node.parentNode;\n    if (!parent) {\n      return;\n    }\n\n    while (node.firstChild) {\n      parent.insertBefore(node.firstChild, node);\n    }\n    parent.removeChild(node);\n    return;\n  }\n\n  if (tagName === 'a') {\n    ensureAllowedAnchor(node);\n  } else {\n    Array.from(node.attributes || []).forEach(attribute => {\n      node.removeAttribute(attribute.name);\n    });\n  }\n\n  Array.from(node.childNodes || []).forEach(child => sanitizeNode(child, documentContext));\n};\n\nexport const sanitizeRichText = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  const trimmed = value.trim();\n  if (trimmed.length === 0) {\n    return '';\n  }\n\n  if (typeof DOMParser === 'undefined' || typeof document === 'undefined') {\n    return trimmed;\n  }\n\n  const parser = new DOMParser();\n  const parsedDocument = parser.parseFromString('<div></div>', 'text/html');\n  const container = parsedDocument.createElement('div');\n  const hasHtmlTags = /<\\/?[a-z][\\s\\S]*>/i.test(trimmed);\n  const normalizedInput = hasHtmlTags\n    ? trimmed\n    : trimmed.replace(/\\r\\n/g, '\\n').split('\\n').join('<br />');\n\n  container.innerHTML = normalizedInput;\n\n  Array.from(container.childNodes || []).forEach(child => sanitizeNode(child, parsedDocument));\n\n  return container.innerHTML;\n};\n\nexport const renderRichText = (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return value;\n  }\n\n  const sanitizedHtml = sanitizeRichText(value);\n\n  if (!sanitizedHtml) {\n    return '';\n  }\n\n  return <span className=\"hv-richtext\" dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />;\n};\n",
