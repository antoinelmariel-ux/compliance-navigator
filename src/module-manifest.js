  "src/App.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState, lazy, Suspense } from './react.js';\nimport { QuestionnaireScreen } from './components/QuestionnaireScreen.jsx';\nimport { SynthesisReport } from './components/SynthesisReport.jsx';\nimport { HomeScreen } from './components/HomeScreen.jsx';\nimport { InspirationForm } from './components/InspirationForm.jsx';\nimport { InspirationDetail } from './components/InspirationDetail.jsx';\nimport { AnnotationLayer } from './components/AnnotationLayer.jsx';\nimport { CheckCircle, Link, Lock, MessageSquare, Settings, Sparkles } from './components/icons.js';\nimport { MandatoryQuestionsSummary } from './components/MandatoryQuestionsSummary.jsx';\nimport { initialQuestions } from './data/questions.js';\nimport { initialRules } from './data/rules.js';\nimport { initialRiskLevelRules } from './data/riskLevelRules.js';\nimport { initialRiskWeights } from './data/riskWeights.js';\nimport { initialTeams } from './data/teams.js';\nimport { initialShowcaseThemes } from './data/showcaseThemes.js';\nimport { initialInspirationProjects } from './data/inspirationProjects.js';\nimport { loadPersistedState, persistState } from './utils/storage.js';\nimport { shouldShowQuestion } from './utils/questions.js';\nimport { analyzeAnswers } from './utils/rules.js';\nimport { extractProjectName } from './utils/projects.js';\nimport { createDemoProject, demoProjectAnswersSnapshot } from './data/demoProject.js';\nimport { exportProjectToFile } from './utils/projectExport.js';\nimport { normalizeRiskWeighting } from './utils/risk.js';\nimport { normalizeProjectEntry, normalizeProjectsCollection } from './utils/projectNormalization.js';\nimport { loadSubmittedProjectsFromDirectory } from './utils/externalProjectsLoader.js';\nimport {\n  createDefaultProjectFiltersConfig,\n  normalizeProjectFilterConfig\n} from './utils/projectFilters.js';\nimport {\n  createDefaultInspirationFiltersConfig,\n  createDefaultInspirationFormConfig,\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig\n} from './utils/inspirationConfig.js';\n\nconst APP_VERSION = 'v1.0.219';\n\nconst loadModule = (modulePath) => {\n  if (typeof window === 'undefined') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  if (!window.ModuleLoader || typeof window.ModuleLoader.import !== 'function') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  return window.ModuleLoader.import(modulePath);\n};\n\nconst LazyBackOffice = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/BackOffice.jsx').BackOffice\n  }))\n);\n\nconst LazyProjectShowcase = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/ProjectShowcase.jsx').ProjectShowcase\n  }))\n);\n\nconst LoadingFallback = ({ label, hint }) => (\n  <div className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n    <div className=\"flex items-center gap-3 text-sm text-gray-600\">\n      <span className=\"loading-spinner\" aria-hidden=\"true\" />\n      <span>{label}</span>\n    </div>\n    {hint && <p className=\"mt-2 text-xs text-gray-400\">{hint}</p>}\n  </div>\n);\n\nconst ANNOTATION_COLORS = [\n  '#2563eb',\n  '#ec4899',\n  '#10b981',\n  '#f59e0b',\n  '#8b5cf6',\n  '#0ea5e9',\n  '#14b8a6',\n  '#ef4444',\n  '#ea580c'\n];\n\nconst BACK_OFFICE_PASSWORD_HASH = '3c5b8c6aaa89db61910cdfe32f1bdb193d1923146dbd6a7b0634a32ab73ac1af';\nconst BACK_OFFICE_PASSWORD_FALLBACK_DIGEST = '86ceec83';\n\nconst computeBackOfficePasswordDigest = async (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return '';\n  }\n\n  const globalCrypto =\n    typeof globalThis !== 'undefined' && typeof globalThis.crypto !== 'undefined'\n      ? globalThis.crypto\n      : undefined;\n\n  const hasSubtleCrypto =\n    !!globalCrypto?.subtle && typeof TextEncoder !== 'undefined';\n\n  if (hasSubtleCrypto) {\n    try {\n      const encoder = new TextEncoder();\n      const data = encoder.encode(value);\n      const digest = await globalCrypto.subtle.digest('SHA-256', data);\n      return Array.from(new Uint8Array(digest))\n        .map(byte => byte.toString(16).padStart(2, '0'))\n        .join('');\n    } catch (error) {\n      // Fallback defined below\n    }\n  }\n\n  let hash = 0;\n  for (let index = 0; index < value.length; index += 1) {\n    hash = (hash * 31 + value.charCodeAt(index)) >>> 0;\n  }\n\n  return hash.toString(16).padStart(8, '0');\n};\n\nconst verifyBackOfficePassword = async (value) => {\n  const digest = await computeBackOfficePasswordDigest(value);\n\n  if (!digest) {\n    return false;\n  }\n\n  if (digest.length === BACK_OFFICE_PASSWORD_HASH.length) {\n    return digest === BACK_OFFICE_PASSWORD_HASH;\n  }\n\n  return digest === BACK_OFFICE_PASSWORD_FALLBACK_DIGEST;\n};\n\nconst cloneDeep = (value) => {\n  if (value === null || value === undefined) {\n    return value;\n  }\n\n  if (typeof structuredClone === 'function') {\n    try {\n      return structuredClone(value);\n    } catch (error) {\n      // Fallback to JSON strategy below\n    }\n  }\n\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst createAnnotationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `note-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst createInspirationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `inspiration-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst buildAnnotationContextKey = ({ screen, projectId, scope }) => {\n  const base = screen === 'showcase' ? `showcase:${projectId || 'unknown'}` : screen;\n\n  if (screen === 'showcase' && scope) {\n    return `${base}:${scope}`;\n  }\n\n  return base || 'global';\n};\n\nconst restoreShowcaseQuestions = (currentQuestions, referenceQuestions = initialQuestions) => {\n  if (!Array.isArray(currentQuestions)) {\n    return referenceQuestions;\n  }\n\n  const nextQuestions = currentQuestions.slice();\n  let changed = false;\n\n  referenceQuestions.forEach((referenceQuestion, referenceIndex) => {\n    if (!referenceQuestion || !referenceQuestion.showcase) {\n      return;\n    }\n\n    const existingIndex = nextQuestions.findIndex((item) => item && item.id === referenceQuestion.id);\n\n    if (existingIndex === -1) {\n      const clonedQuestion = JSON.parse(JSON.stringify(referenceQuestion));\n      const insertionIndex = Math.min(referenceIndex, nextQuestions.length);\n      nextQuestions.splice(insertionIndex, 0, clonedQuestion);\n      changed = true;\n      return;\n    }\n\n    const existingQuestion = nextQuestions[existingIndex];\n    const existingShowcaseMeta = existingQuestion && existingQuestion.showcase;\n    const referenceShowcaseMeta = referenceQuestion.showcase;\n\n    const showcaseMetaDiffers =\n      !existingShowcaseMeta ||\n      JSON.stringify(existingShowcaseMeta) !== JSON.stringify(referenceShowcaseMeta);\n\n    if (showcaseMetaDiffers) {\n      nextQuestions[existingIndex] = {\n        ...existingQuestion,\n        showcase: JSON.parse(JSON.stringify(referenceShowcaseMeta))\n      };\n      changed = true;\n    }\n  });\n\n  return changed ? nextQuestions : currentQuestions;\n};\n\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst areAnswersEqual = (previousValue, nextValue) => {\n  if (previousValue === nextValue) {\n    return true;\n  }\n\n  if (Array.isArray(previousValue) && Array.isArray(nextValue)) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      if (previousValue.length !== nextValue.length) {\n        return false;\n      }\n      return previousValue.every((entry, index) => entry === nextValue[index]);\n    }\n  }\n\n  if (\n    previousValue &&\n    nextValue &&\n    typeof previousValue === 'object' &&\n    typeof nextValue === 'object'\n  ) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      return false;\n    }\n  }\n\n  return false;\n};\n\nconst findQuestionById = (questions, id) => {\n  if (!Array.isArray(questions)) {\n    return null;\n  }\n\n  return questions.find(question => question?.id === id) || null;\n};\n\nconst normalizeMilestoneListValue = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0)\n    .map(entry => ({\n      date: entry.date,\n      description: entry.description\n    }));\n};\n\nconst areMilestoneListsEqual = (previousValue, nextValue) => {\n  if (previousValue.length !== nextValue.length) {\n    return false;\n  }\n\n  return previousValue.every((entry, index) => {\n    const nextEntry = nextValue[index];\n    if (!nextEntry) {\n      return false;\n    }\n\n    return entry.date === nextEntry.date && entry.description === nextEntry.description;\n  });\n};\n\nconst applyAnswerUpdates = (\n  prevAnswers = {},\n  updates,\n  questions,\n  predicate,\n  options = {}\n) => {\n  if (!updates || typeof updates !== 'object') {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const entries = Object.entries(updates);\n  if (entries.length === 0) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const nextAnswers = { ...prevAnswers };\n  let changed = false;\n\n  entries.forEach(([questionId, value]) => {\n    if (!questionId) {\n      return;\n    }\n\n    const question = findQuestionById(questions, questionId);\n    const questionType = question?.type;\n\n    if (questionType === 'milestone_list') {\n      const normalizedValue = normalizeMilestoneListValue(value);\n      const previousRawValue = nextAnswers[questionId];\n      const previousValue = Array.isArray(previousRawValue)\n        ? normalizeMilestoneListValue(previousRawValue)\n        : [];\n      const previousRawJson = JSON.stringify(Array.isArray(previousRawValue) ? previousRawValue : []);\n      const normalizedJson = JSON.stringify(normalizedValue);\n\n      if (normalizedValue.length > 0) {\n        if (!areMilestoneListsEqual(previousValue, normalizedValue) || previousRawJson !== normalizedJson) {\n          changed = true;\n          nextAnswers[questionId] = normalizedValue;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (Array.isArray(value)) {\n      const filtered = value\n        .map(item => (typeof item === 'string' ? item.trim() : item))\n        .filter(item => {\n          if (typeof item === 'string') {\n            return item.length > 0;\n          }\n          return item !== null && item !== undefined;\n        });\n\n      const previousValue = nextAnswers[questionId];\n      const arraysAreEqual = Array.isArray(previousValue)\n        && previousValue.length === filtered.length\n        && previousValue.every((item, index) => item === filtered[index]);\n\n      if (filtered.length > 0) {\n        if (!arraysAreEqual) {\n          changed = true;\n        }\n        nextAnswers[questionId] = filtered;\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (value === null || value === undefined) {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length > 0) {\n        if (nextAnswers[questionId] !== value) {\n          changed = true;\n          nextAnswers[questionId] = value;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (nextAnswers[questionId] !== value) {\n      changed = true;\n      nextAnswers[questionId] = value;\n    }\n  });\n\n  if (!changed) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const canEvaluatePredicate = typeof predicate === 'function';\n  const shouldPreserveQuestion = typeof options.shouldPreserveQuestion === 'function'\n    ? options.shouldPreserveQuestion\n    : null;\n  const questionsToRemove = Array.isArray(questions) && canEvaluatePredicate\n    ? questions\n        .filter(question => {\n          if (!question || !question.id) {\n            return false;\n          }\n\n          const wasVisible = predicate(question, prevAnswers);\n          const isVisible = predicate(question, nextAnswers);\n\n          if (isVisible) {\n            return false;\n          }\n\n          if (shouldPreserveQuestion && shouldPreserveQuestion(question, {\n            prevAnswers,\n            nextAnswers\n          })) {\n            return false;\n          }\n\n          if (wasVisible) {\n            return true;\n          }\n\n          return isAnswerProvided(nextAnswers[question.id]) || isAnswerProvided(prevAnswers[question.id]);\n        })\n        .map(question => question.id)\n    : [];\n\n  if (questionsToRemove.length > 0) {\n    questionsToRemove.forEach(questionId => {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n    });\n  }\n\n  return { nextAnswers, changed };\n};\n\nconst resolveFallbackQuestionsLength = (savedState, currentQuestionsLength = initialQuestions.length) => {\n  if (savedState && Array.isArray(savedState.questions) && savedState.questions.length > 0) {\n    return savedState.questions.length;\n  }\n\n  return currentQuestionsLength;\n};\n\nconst buildInitialProjectsState = () => {\n  const savedState = loadPersistedState();\n\n  if (!savedState) {\n    return [createDemoProject()];\n  }\n\n  const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : initialQuestions;\n  const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : initialRules;\n  const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n    ? savedState.riskLevelRules\n    : initialRiskLevelRules;\n  const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n    ? normalizeRiskWeighting(savedState.riskWeights)\n    : initialRiskWeights;\n  const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n  const normalizedProjects = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength)\n    || normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n\n  if (normalizedProjects && normalizedProjects.length > 0) {\n    return normalizedProjects;\n  }\n\n  return [createDemoProject({\n    questions: fallbackQuestions,\n    rules: fallbackRules,\n    riskLevelRules: fallbackRiskLevelRules,\n    riskWeights: fallbackRiskWeights\n  })];\n};\n\nconst buildInitialInspirationProjectsState = () => {\n  const savedState = loadPersistedState();\n  if (savedState && Array.isArray(savedState.inspirationProjects)) {\n    return cloneDeep(savedState.inspirationProjects);\n  }\n\n  return cloneDeep(initialInspirationProjects);\n};\n\nconst isOnboardingProject = (project) => {\n  if (!project || typeof project !== 'object') {\n    return false;\n  }\n\n  const { id } = project;\n  if (typeof id !== 'string' || id.length === 0) {\n    return false;\n  }\n\n  return id === 'onboarding-demo' || id.startsWith('tour-');\n};\n\nconst sanitizeRestoredProjects = (projects) => {\n  if (!Array.isArray(projects)) {\n    return [];\n  }\n\n  const restored = projects.filter(project => !isOnboardingProject(project));\n\n  if (restored.length === 0) {\n    return [];\n  }\n\n  return cloneDeep(restored);\n};\n\nexport const App = () => {\n  const [mode, setMode] = useState('user');\n  const [screen, setScreen] = useState('home');\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [answers, setAnswers] = useState({});\n  const [analysis, setAnalysis] = useState(null);\n  const [projects, setProjects] = useState(buildInitialProjectsState);\n  const projectsRef = useRef(projects);\n  const [inspirationProjects, setInspirationProjects] = useState(buildInitialInspirationProjectsState);\n  const [activeInspirationId, setActiveInspirationId] = useState(null);\n  const [activeProjectId, setActiveProjectId] = useState(null);\n  const [validationError, setValidationError] = useState(null);\n  const [saveFeedback, setSaveFeedback] = useState(null);\n  const [showcaseProjectContext, setShowcaseProjectContext] = useState(null);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  const [returnToSynthesisAfterEdit, setReturnToSynthesisAfterEdit] = useState(false);\n  const [isOnboardingActive, setIsOnboardingActive] = useState(false);\n  const [onboardingStepId, setOnboardingStepId] = useState(null);\n  const [isTourGuideReady, setIsTourGuideReady] = useState(false);\n  const tourInstanceRef = useRef(null);\n  const onboardingStateRef = useRef(null);\n  const onboardingDemoDataRef = useRef(null);\n  const isOnboardingActiveRef = useRef(false);\n\n  const [questions, setQuestions] = useState(() => restoreShowcaseQuestions(initialQuestions));\n  const [rules, setRules] = useState(initialRules);\n  const [riskLevelRules, setRiskLevelRules] = useState(initialRiskLevelRules);\n  const [riskWeights, setRiskWeights] = useState(() => normalizeRiskWeighting(initialRiskWeights));\n  const [teams, setTeams] = useState(initialTeams);\n  const [showcaseThemes, setShowcaseThemes] = useState(initialShowcaseThemes);\n  const [projectFilters, setProjectFiltersState] = useState(() => createDefaultProjectFiltersConfig());\n  const [inspirationFilters, setInspirationFilters] = useState(() => createDefaultInspirationFiltersConfig());\n  const [inspirationFormFields, setInspirationFormFields] = useState(() => createDefaultInspirationFormConfig());\n  const [homeView, setHomeView] = useState('platform');\n  const [isHydrated, setIsHydrated] = useState(false);\n  const [isBackOfficeUnlocked, setIsBackOfficeUnlocked] = useState(false);\n  const [backOfficeAuthError, setBackOfficeAuthError] = useState(null);\n  const [isBackOfficePromptOpen, setIsBackOfficePromptOpen] = useState(false);\n  const [backOfficePromptValue, setBackOfficePromptValue] = useState('');\n  const [backOfficePromptError, setBackOfficePromptError] = useState('');\n  const backOfficePromptResolverRef = useRef(null);\n  const [adminView, setAdminView] = useState('home');\n  const showcaseShareInputRef = useRef(null);\n  const persistTimeoutRef = useRef(null);\n  const previousScreenRef = useRef(null);\n  const [isAnnotationModeEnabled, setIsAnnotationModeEnabled] = useState(false);\n  const [isAnnotationPaused, setIsAnnotationPaused] = useState(false);\n  const [annotationNotes, setAnnotationNotes] = useState([]);\n  const [annotationSources, setAnnotationSources] = useState({ session: ANNOTATION_COLORS[0] });\n  const [showcaseAnnotationScope, setShowcaseAnnotationScope] = useState('display-full');\n  const [autoFocusAnnotationId, setAutoFocusAnnotationId] = useState(null);\n  const [isShowcaseEditing, setIsShowcaseEditing] = useState(false);\n  const [isShowcaseShareOpen, setIsShowcaseShareOpen] = useState(false);\n  const [showcaseShareFeedback, setShowcaseShareFeedback] = useState('');\n  const annotationNotesRef = useRef(annotationNotes);\n  const annotationFileInputRef = useRef(null);\n  const loadedStylesRef = useRef(new Set());\n  const pendingShowcaseProjectIdRef = useRef(null);\n\n  const ensureStylesheetLoaded = useCallback((href) => {\n    if (typeof document === 'undefined' || !href) {\n      return;\n    }\n\n    if (loadedStylesRef.current.has(href)) {\n      return;\n    }\n\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = href;\n    link.dataset.dynamic = 'true';\n    document.head.appendChild(link);\n    loadedStylesRef.current.add(href);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleBeforeUnload = (event) => {\n      if (!hasUnsavedChanges) {\n        return undefined;\n      }\n\n      const message = 'Avez-vous bien sauvegardé votre projet avant de quitter ?';\n      event.preventDefault();\n      event.returnValue = message;\n      return message;\n    };\n\n    window.addEventListener('beforeunload', handleBeforeUnload);\n\n    return () => {\n      window.removeEventListener('beforeunload', handleBeforeUnload);\n    };\n  }, [hasUnsavedChanges]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const { search, hash } = window.location;\n    const params = new URLSearchParams(search || '');\n    let projectId = params.get('projectId') || params.get('showcase');\n\n    if (!projectId && typeof hash === 'string' && hash.length > 1) {\n      const normalizedHash = hash.slice(1);\n      if (normalizedHash.startsWith('showcase=')) {\n        projectId = normalizedHash.replace(/^showcase=/, '');\n      } else if (normalizedHash.startsWith('showcase:')) {\n        projectId = normalizedHash.replace(/^showcase:/, '');\n      }\n    }\n\n    if (projectId) {\n      pendingShowcaseProjectIdRef.current = projectId;\n    }\n  }, []);\n\n  useEffect(() => {\n    projectsRef.current = projects;\n  }, [projects]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    ensureStylesheetLoaded('./src/styles/project-showcase.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-aurora.css');\n  }, [ensureStylesheetLoaded, showcaseProjectContext]);\n\n  useEffect(() => {\n    annotationNotesRef.current = annotationNotes;\n  }, [annotationNotes]);\n\n  useEffect(() => {\n    isOnboardingActiveRef.current = isOnboardingActive;\n  }, [isOnboardingActive]);\n\n  useEffect(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      if (!Array.isArray(prevProjects) || prevProjects.length === 0) {\n        return prevProjects;\n      }\n\n      const containsOnboardingProjects = prevProjects.some(isOnboardingProject);\n      if (!containsOnboardingProjects) {\n        return prevProjects;\n      }\n\n      const sanitizedProjects = prevProjects.filter(project => !isOnboardingProject(project));\n\n      if (sanitizedProjects.length === 0) {\n        return buildInitialProjectsState();\n      }\n\n      return cloneDeep(sanitizedProjects);\n    });\n  }, [isOnboardingActive, setProjects]);\n\n  useEffect(() => {\n    if (mode !== 'admin') {\n      setAdminView('home');\n    }\n  }, [mode]);\n\nconst updateProjectFilters = useCallback((updater) => {\n  setProjectFiltersState(prevConfig => {\n    const currentConfig = normalizeProjectFilterConfig(prevConfig);\n    const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n    return normalizeProjectFilterConfig(nextConfig);\n  });\n}, []);\n\n  const updateInspirationFilters = useCallback((updater) => {\n    setInspirationFilters(prevConfig => {\n      const currentConfig = normalizeInspirationFiltersConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFiltersConfig(nextConfig);\n    });\n  }, []);\n\n  const updateInspirationFormFields = useCallback((updater) => {\n    setInspirationFormFields(prevConfig => {\n      const currentConfig = normalizeInspirationFormConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFormConfig(nextConfig);\n    });\n  }, []);\n\n  useEffect(() => {\n    if (!Array.isArray(showcaseThemes) || showcaseThemes.length === 0) {\n      return;\n    }\n\n    setQuestions((previousQuestions) => {\n      const nextQuestions = Array.isArray(previousQuestions)\n        ? previousQuestions.slice()\n        : [];\n      const themeQuestionIndex = nextQuestions.findIndex(question => question?.id === 'showcaseTheme');\n\n      if (themeQuestionIndex === -1) {\n        return previousQuestions;\n      }\n\n      const themeOptions = showcaseThemes\n        .map(theme => (typeof theme?.label === 'string' && theme.label.trim().length > 0\n          ? theme.label.trim()\n          : typeof theme?.id === 'string'\n            ? theme.id\n            : ''))\n        .filter(option => option.length > 0);\n\n      const existingOptions = Array.isArray(nextQuestions[themeQuestionIndex]?.options)\n        ? nextQuestions[themeQuestionIndex].options\n        : [];\n\n      if (\n        themeOptions.length === existingOptions.length &&\n        themeOptions.every((option, index) => option === existingOptions[index])\n      ) {\n        return previousQuestions;\n      }\n\n      const existingThemeQuestion = nextQuestions[themeQuestionIndex] || {};\n\n      nextQuestions[themeQuestionIndex] = {\n        ...existingThemeQuestion,\n        options: themeOptions\n      };\n\n      return nextQuestions;\n    });\n  }, [setQuestions, showcaseThemes]);\n\n  const synchronizeExternalProjects = useCallback(async () => {\n    const existingProjects = Array.isArray(projectsRef.current) ? projectsRef.current : [];\n\n    const fallbackQuestionsLength = questions.length;\n\n    const externalProjects = await loadSubmittedProjectsFromDirectory({\n      questions,\n      rules,\n      riskLevelRules,\n      riskWeights,\n      fallbackQuestionsLength,\n      existingProjects\n    });\n\n    const externalSources = new Set(externalProjects.map(entry => entry.sourceId));\n\n    setProjects(prevProjects => {\n      const baseProjects = Array.isArray(prevProjects) ? prevProjects : [];\n      const preserved = baseProjects.filter(project => (\n        !project?.externalSourceId || externalSources.has(project.externalSourceId)\n      ));\n\n      const bySource = new Map();\n      preserved.forEach(project => {\n        if (project && project.externalSourceId) {\n          bySource.set(project.externalSourceId, project);\n        }\n      });\n\n      let changed = preserved.length !== baseProjects.length;\n      const nextProjects = preserved.slice();\n\n      externalProjects.forEach(entry => {\n        const { project, sourceId, checksum } = entry;\n        if (!project || !sourceId) {\n          return;\n        }\n\n        const existing = bySource.get(sourceId);\n        if (!existing) {\n          nextProjects.push(project);\n          changed = true;\n          return;\n        }\n\n        const existingChecksum = existing.externalSourceChecksum;\n        if (existingChecksum && existingChecksum === checksum) {\n          return;\n        }\n\n        const index = nextProjects.findIndex(item => item?.externalSourceId === sourceId);\n        if (index !== -1) {\n          nextProjects[index] = project;\n        } else {\n          nextProjects.push(project);\n        }\n        changed = true;\n      });\n\n      return changed ? nextProjects : baseProjects;\n    });\n  }, [questions, riskLevelRules, riskWeights, rules]);\n\n  useEffect(() => {\n    const loadExternal = async () => {\n      try {\n        await synchronizeExternalProjects();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('Impossible de synchroniser les projets externes :', error);\n        }\n      }\n    };\n\n    loadExternal();\n  }, [synchronizeExternalProjects]);\n\n  useEffect(() => {\n    const savedState = loadPersistedState();\n    if (!savedState) {\n      setIsHydrated(true);\n      return;\n    }\n\n    const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : questions;\n    const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : rules;\n    const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n      ? savedState.riskLevelRules\n      : riskLevelRules;\n    const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n      ? normalizeRiskWeighting(savedState.riskWeights)\n      : riskWeights;\n    const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n    if (savedState.mode === 'admin') {\n      setMode('user');\n    } else if (savedState.mode) {\n      setMode(savedState.mode);\n    }\n    if (savedState.screen) setScreen(savedState.screen);\n    if (typeof savedState.currentQuestionIndex === 'number' && savedState.currentQuestionIndex >= 0) {\n      setCurrentQuestionIndex(savedState.currentQuestionIndex);\n    }\n    if (savedState.answers && typeof savedState.answers === 'object') setAnswers(savedState.answers);\n    if (typeof savedState.analysis !== 'undefined') setAnalysis(savedState.analysis);\n    if (Array.isArray(savedState.projects)) {\n      const normalized = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    } else if (Array.isArray(savedState.submittedProjects)) {\n      const normalized = normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    }\n    if (typeof savedState.activeProjectId === 'string') setActiveProjectId(savedState.activeProjectId);\n    if (typeof savedState.activeInspirationId === 'string') setActiveInspirationId(savedState.activeInspirationId);\n    if (typeof savedState.homeView === 'string') setHomeView(savedState.homeView);\n    if (Array.isArray(savedState.questions)) {\n      setQuestions(restoreShowcaseQuestions(savedState.questions));\n    }\n    if (Array.isArray(savedState.rules)) setRules(savedState.rules);\n    if (Array.isArray(savedState.riskLevelRules)) setRiskLevelRules(savedState.riskLevelRules);\n    if (savedState && typeof savedState.riskWeights === 'object') {\n      setRiskWeights(normalizeRiskWeighting(savedState.riskWeights));\n    }\n    if (Array.isArray(savedState.teams)) setTeams(savedState.teams);\n    if (Array.isArray(savedState.showcaseThemes)) setShowcaseThemes(savedState.showcaseThemes);\n    if (savedState && typeof savedState.projectFilters === 'object') {\n      setProjectFiltersState(normalizeProjectFilterConfig(savedState.projectFilters));\n    }\n    if (Array.isArray(savedState.inspirationProjects)) {\n      setInspirationProjects(cloneDeep(savedState.inspirationProjects));\n    }\n    if (savedState && typeof savedState.inspirationFilters === 'object') {\n      setInspirationFilters(normalizeInspirationFiltersConfig(savedState.inspirationFilters));\n    }\n    if (savedState && typeof savedState.inspirationFormFields === 'object') {\n      setInspirationFormFields(normalizeInspirationFormConfig(savedState.inspirationFormFields));\n    }\n\n    setIsHydrated(true);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    let disposed = false;\n\n    const updateStatus = () => {\n      if (disposed) {\n        return;\n      }\n      setIsTourGuideReady(Boolean(window.TourGuideClient));\n    };\n\n    updateStatus();\n\n    if (window.TourGuideClient) {\n      return () => {\n        disposed = true;\n      };\n    }\n\n    const intervalId = window.setInterval(() => {\n      if (window.TourGuideClient) {\n        updateStatus();\n        window.clearInterval(intervalId);\n      }\n    }, 500);\n\n    return () => {\n      disposed = true;\n      window.clearInterval(intervalId);\n    };\n  }, []);\n\n  const noop = useCallback(() => {}, []);\n\n  const computeDemoData = useCallback(() => {\n    const answers = cloneDeep(demoProjectAnswersSnapshot) || {};\n    const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n    const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    const relevantTeamsList = Array.isArray(teams)\n      ? teams.filter(team => (analysisResult?.teams || []).includes(team.id))\n      : [];\n    const timelineDetails = analysisResult?.timeline?.details || [];\n    const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n      ? answers.projectName.trim()\n      : 'Projet de démonstration';\n\n    return {\n      answers,\n      analysis: analysisResult,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      projectName,\n      relevantTeams: relevantTeamsList,\n      timelineDetails\n    };\n  }, [questions, riskLevelRules, riskWeights, rules, shouldShowQuestion, teams]);\n\n  const getDemoData = useCallback(() => {\n    if (!onboardingDemoDataRef.current) {\n      onboardingDemoDataRef.current = computeDemoData();\n    }\n\n    return onboardingDemoDataRef.current;\n  }, [computeDemoData]);\n\n  const buildOnboardingProjects = useCallback((demoData) => {\n    const baseAnswers = cloneDeep(demoData?.answers || demoProjectAnswersSnapshot || {});\n    const now = Date.now();\n\n    const createEntry = (config) => {\n      const offsetMs = typeof config.offsetMs === 'number' ? config.offsetMs : 0;\n      const timestamp = config.timestamp || new Date(now - offsetMs).toISOString();\n      const answersPatch = config.answers || {};\n      const answers = cloneDeep({ ...baseAnswers, ...answersPatch });\n      if (config.projectName) {\n        answers.projectName = config.projectName;\n      }\n\n      const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n        ? answers.projectName.trim()\n        : 'Projet sans nom';\n\n      const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n      const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n      const totalQuestions = visibleQuestions.length > 0 ? visibleQuestions.length : questions.length;\n      const answeredQuestions = visibleQuestions.filter(question => isAnswerProvided(answers[question.id])).length;\n      const status = config.status || 'draft';\n\n      return {\n        id: config.id,\n        projectName,\n        answers,\n        analysis: analysisResult,\n        status,\n        lastUpdated: config.lastUpdated || timestamp,\n        generatedAt: config.generatedAt || timestamp,\n        submittedAt: status === 'submitted' ? (config.submittedAt || timestamp) : undefined,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex:\n          typeof config.lastQuestionIndex === 'number'\n            ? config.lastQuestionIndex\n            : (status === 'submitted' && totalQuestions > 0\n              ? totalQuestions - 1\n              : Math.max(totalQuestions - 2, 0)),\n        isDemo: true\n      };\n    };\n\n    return [\n      createEntry({\n        id: 'tour-draft-1',\n        projectName: 'Atlas Connect',\n        status: 'draft',\n        offsetMs: 86400000,\n        answers: {\n          teamLead: 'Léa Martin',\n          teamLeadTeam: 'Digital'\n        }\n      }),\n      createEntry({\n        id: 'tour-submitted',\n        projectName: 'Pulse Live',\n        status: 'submitted',\n        offsetMs: 432000000,\n        answers: {\n          teamLead: 'Noah Carpentier',\n          teamLeadTeam: 'Marketing'\n        }\n      }),\n      createEntry({\n        id: 'tour-draft-demo',\n        projectName: demoData?.projectName || 'Plasma 360',\n        status: 'draft',\n        offsetMs: 172800000,\n        answers: {}\n      })\n    ];\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const restoreOnboardingSnapshot = useCallback(() => {\n    const snapshot = onboardingStateRef.current;\n    onboardingStateRef.current = null;\n    onboardingDemoDataRef.current = null;\n\n    if (!snapshot) {\n      setMode('user');\n      setAdminView('home');\n      setScreen('home');\n      setAnswers({});\n      setAnalysis(null);\n      setProjects(buildInitialProjectsState());\n      setProjectFiltersState(createDefaultProjectFiltersConfig());\n      setCurrentQuestionIndex(0);\n      setValidationError(null);\n      setSaveFeedback(null);\n      setActiveProjectId(null);\n      setShowcaseProjectContext(null);\n      setHasUnsavedChanges(false);\n      setBackOfficeAuthError(null);\n      setIsBackOfficeUnlocked(false);\n      return;\n    }\n\n    setMode(snapshot.mode || 'user');\n    setAdminView(snapshot.adminView || 'home');\n    setScreen(snapshot.screen || 'home');\n    setAnswers(snapshot.answers || {});\n    setAnalysis(typeof snapshot.analysis !== 'undefined' ? snapshot.analysis : null);\n    const restoredProjects = sanitizeRestoredProjects(snapshot.projects);\n    setProjects(\n      restoredProjects.length > 0\n        ? restoredProjects\n        : buildInitialProjectsState()\n    );\n    setProjectFiltersState(\n      snapshot.projectFilters\n        ? normalizeProjectFilterConfig(snapshot.projectFilters)\n        : createDefaultProjectFiltersConfig()\n    );\n    setCurrentQuestionIndex(\n      typeof snapshot.currentQuestionIndex === 'number' && snapshot.currentQuestionIndex >= 0\n        ? snapshot.currentQuestionIndex\n        : 0\n    );\n    setValidationError(snapshot.validationError || null);\n    setSaveFeedback(snapshot.saveFeedback || null);\n    setActiveProjectId(typeof snapshot.activeProjectId === 'string' ? snapshot.activeProjectId : null);\n    setShowcaseProjectContext(snapshot.showcaseProjectContext || null);\n    setHasUnsavedChanges(Boolean(snapshot.hasUnsavedChanges));\n    setBackOfficeAuthError(snapshot.backOfficeAuthError || null);\n    setIsBackOfficeUnlocked(Boolean(snapshot.isBackOfficeUnlocked));\n  }, [\n    setActiveProjectId,\n    setAdminView,\n    setAnalysis,\n    setAnswers,\n    setBackOfficeAuthError,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setIsBackOfficeUnlocked,\n    setMode,\n    setProjectFiltersState,\n    setProjects,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const finishOnboarding = useCallback((options = {}) => {\n    const { shouldLoadIndex = false } = options || {};\n    const snapshotExists = Boolean(onboardingStateRef.current);\n    const wasOnboardingActive = isOnboardingActiveRef.current;\n\n    if (!wasOnboardingActive && !snapshotExists) {\n      return;\n    }\n\n    isOnboardingActiveRef.current = false;\n    setIsOnboardingActive(false);\n    setOnboardingStepId(null);\n\n    const tourInstance = tourInstanceRef.current;\n    tourInstanceRef.current = null;\n\n    if (tourInstance && typeof tourInstance.stop === 'function') {\n      try {\n        tourInstance.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Impossible de stopper le guide :', error);\n        }\n      }\n    }\n\n    if (snapshotExists) {\n      restoreOnboardingSnapshot();\n    }\n\n    if (shouldLoadIndex && typeof window !== 'undefined') {\n      const redirect = () => {\n        try {\n          if (window.location) {\n            if (typeof window.location.assign === 'function') {\n              window.location.assign('./index.html');\n            } else {\n              window.location.href = './index.html';\n            }\n          }\n        } catch (error) {\n          if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n            console.warn('[Onboarding] Impossible de charger la page d\\'accueil :', error);\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => redirect());\n      } else if (typeof window.setTimeout === 'function') {\n        window.setTimeout(() => redirect(), 0);\n      }\n    }\n  }, [restoreOnboardingSnapshot]);\n\n  const handleOnboardingStepEnter = useCallback((stepId) => {\n    if (!stepId) {\n      return;\n    }\n\n    const demoData = getDemoData();\n\n    const openDemoShowcase = () => {\n      openProjectShowcase({\n        projectId: null,\n        projectName: demoData.projectName,\n        answers: cloneDeep(demoData.answers),\n        analysis: demoData.analysis,\n        relevantTeams: demoData.relevantTeams,\n        questions: demoData.questions,\n        timelineDetails: demoData.timelineDetails,\n        status: 'draft'\n      });\n      setHasUnsavedChanges(false);\n    };\n\n    const ensureShowcaseTopVisible = () => {\n      if (typeof window === 'undefined') {\n        return;\n      }\n\n      const scrollToTop = () => {\n        try {\n          if (typeof document !== 'undefined') {\n            const topSection = document.querySelector('[data-tour-id=\"showcase-preview\"]');\n            if (topSection && typeof topSection.scrollIntoView === 'function') {\n              topSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });\n              return;\n            }\n          }\n\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n          }\n        } catch (error) {\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0 });\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => {\n          if (typeof window.setTimeout === 'function') {\n            window.setTimeout(scrollToTop, 0);\n          } else {\n            scrollToTop();\n          }\n        });\n        return;\n      }\n\n      if (typeof window.setTimeout === 'function') {\n        window.setTimeout(scrollToTop, 0);\n        return;\n      }\n\n      scrollToTop();\n    };\n\n    switch (stepId) {\n      case 'welcome':\n      case 'create-project': {\n        setScreen('home');\n        setShowcaseProjectContext(null);\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'question-overview':\n      case 'question-guidance':\n      case 'project-save-anytime': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setCurrentQuestionIndex(0);\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'questionnaire-finish': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        const totalQuestionsCount = Array.isArray(demoData.questions) && demoData.questions.length > 0\n          ? demoData.questions.length\n          : questions.length;\n        const lastIndex = totalQuestionsCount > 0 ? totalQuestionsCount - 1 : 0;\n        setCurrentQuestionIndex(lastIndex);\n        break;\n      }\n      case 'compliance-report-top':\n      case 'compliance-teams':\n      case 'compliance-risks':\n      case 'compliance-submit':\n      case 'compliance-save':\n      case 'compliance-showcase-button': {\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(demoData.analysis);\n        setCurrentQuestionIndex(0);\n        setValidationError(null);\n        setScreen('synthesis');\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'showcase-top': {\n        openDemoShowcase();\n        ensureShowcaseTopVisible();\n        break;\n      }\n      case 'showcase-bottom':\n      case 'showcase-edit-trigger':\n      case 'showcase-edit':\n      case 'showcase-save-edits':\n      case 'showcase-back-to-report': {\n        openDemoShowcase();\n        break;\n      }\n      case 'project-import':\n      case 'project-filters': {\n        setShowcaseProjectContext(null);\n        setScreen('home');\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      default:\n        break;\n    }\n  }, [\n    getDemoData,\n    openProjectShowcase,\n    screen,\n    questions,\n    setActiveProjectId,\n    setAnalysis,\n    setAnswers,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const handleStartOnboarding = useCallback(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    if (typeof window === 'undefined' || typeof window.TourGuideClient !== 'function') {\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Le guide interactif est momentanément indisponible.');\n      }\n      return;\n    }\n\n    onboardingStateRef.current = {\n      mode,\n      screen,\n      adminView,\n      answers: cloneDeep(answers),\n      analysis: cloneDeep(analysis),\n      projects: cloneDeep(projects),\n      projectFilters: cloneDeep(projectFilters),\n      currentQuestionIndex,\n      validationError: cloneDeep(validationError),\n      saveFeedback: cloneDeep(saveFeedback),\n      activeProjectId,\n      showcaseProjectContext: cloneDeep(showcaseProjectContext),\n      hasUnsavedChanges,\n      backOfficeAuthError,\n      isBackOfficeUnlocked\n    };\n\n    const demoData = getDemoData();\n    onboardingDemoDataRef.current = demoData;\n    const onboardingProjects = buildOnboardingProjects(demoData);\n\n    isOnboardingActiveRef.current = true;\n    setIsOnboardingActive(true);\n    setOnboardingStepId(null);\n    setMode('user');\n    setAdminView('home');\n    setScreen('home');\n    setShowcaseProjectContext(null);\n    setActiveProjectId(null);\n    setAnswers({});\n    setAnalysis(null);\n    setValidationError(null);\n    setSaveFeedback(null);\n    setHasUnsavedChanges(false);\n    setBackOfficeAuthError(null);\n    setIsBackOfficeUnlocked(false);\n    setProjects(onboardingProjects);\n    setProjectFiltersState(createDefaultProjectFiltersConfig());\n\n    const steps = [\n      {\n        id: 'welcome',\n        target: '#tour-onboarding-anchor',\n        title: 'Bienvenue sur Project Navigator',\n        content: 'Découvrons ensemble comment cadrer votre projet pas à pas.'\n      },\n      {\n        id: 'create-project',\n        target: '[data-tour-id=\"home-create-project\"]',\n        title: 'Lancer un nouveau projet',\n        content: 'Cliquez ici pour démarrer. Nous allons utiliser un projet de démonstration pour l’exemple.',\n        placement: 'bottom'\n      },\n      {\n        id: 'question-overview',\n        target: '[data-tour-id=\"question-main-content\"]',\n        title: 'Répondre aux questions',\n        content: 'Renseignez les informations demandées étape par étape pour qualifier votre initiative.'\n      },\n      {\n        id: 'question-guidance',\n        target: '[data-tour-id=\"question-guidance-toggle\"]',\n        title: 'Comprendre chaque question',\n        content: 'Chaque étape propose des conseils contextualisés pour répondre sereinement.'\n      },\n      {\n        id: 'project-save-anytime',\n        target: '[data-tour-id=\"question-save-draft\"]',\n        title: 'Sauvegarder à tout moment',\n        content: \"Téléchargez un brouillon de votre projet quand vous le souhaitez et rechargez-le depuis l’accueil. Attention, il n'y a pas de sauvegarde automatique.\"\n      },\n      {\n        id: 'questionnaire-finish',\n        target: '[data-tour-id=\"questionnaire-finish\"]',\n        title: 'Fin du formulaire',\n        content: 'Sur la dernière question, cliquez sur “Voir la synthèse” pour accéder au rapport complet.'\n      },\n      {\n        id: 'compliance-report-top',\n        target: '[data-tour-id=\"synthesis-summary\"]',\n        title: 'Lire le rapport de compliance',\n        content: \"Retrouvez ici le résumé du projet avec l'ensemble des informations que vous avez remplies. Vous pouvez revenir en arrière pour les modifier.\",\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'start',\n          inline: 'nearest'\n        }\n      },\n      {\n        id: 'compliance-teams',\n        target: '[data-tour-id=\"synthesis-teams\"]',\n        title: 'Identifier les équipes compliance',\n        content: 'Visualisez les interlocuteurs clés, leurs priorités et les questions à anticiper pour préparer vos échanges.'\n      },\n      {\n        id: 'compliance-risks',\n        target: '[data-tour-id=\"synthesis-risks\"]',\n        title: 'Risques et points de vigilance',\n        content: 'Analysez les risques identifiés et les points de vigilance compliance à adresser en priorité.'\n      },\n      {\n        id: 'compliance-submit',\n        target: '[data-tour-id=\"synthesis-submit\"]',\n        title: 'Soumettre le projet',\n        content: 'Envoyez votre rapport directement par e-mail aux équipes concernées.'\n      },\n      {\n        id: 'compliance-save',\n        target: '[data-tour-id=\"synthesis-save\"]',\n        title: 'Sauvegarder depuis la synthèse',\n        content: 'Téléchargez le fichier du projet pour le partager ou le reprendre ultérieurement.'\n      },\n      {\n        id: 'compliance-showcase-button',\n        target: '[data-tour-id=\"synthesis-showcase\"]',\n        title: 'Ouvrir la vitrine du projet',\n        content: 'Accédez à la vitrine du projet générée automatiquement pour présenter votre initiative.'\n      },\n      {\n        id: 'showcase-top',\n        target: '[data-tour-id=\"showcase-hero\"]',\n        title: 'Présenter votre projet',\n        content:\n          'Parcourez la vitrine présentant votre projet avec une mise en page le mettant en valeur. Parfait pour une présentation à votre manager !',\n         scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 5200\n      },\n      {\n        id: 'showcase-bottom',\n        target: '[data-tour-id=\"showcase-preview-bottom\"]',\n        title: 'Explorer la suite de la vitrine',\n        content: 'Vous retrouvez sur la vitrine les jalons de votre projet mais également les alertes liées à des problématiques de respect de certains délais.',\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 3200\n      },\n      {\n        id: 'showcase-edit-trigger',\n        target: '[data-tour-id=\"showcase-edit-trigger\"]',\n        title: 'Modifier la vitrine',\n        content: 'Activez le mode édition pour ajuster les contenus avant diffusion.'\n      },\n      {\n        id: 'showcase-edit',\n        target: '[data-tour-id=\"showcase-edit-panel\"]',\n        title: 'Personnaliser la vitrine',\n        content: 'Adaptez textes, messages clés et jalons pour refléter fidèlement votre projet. Ses informations sont automatiquement mise à jour dans le rapport de compliance.'\n      },\n      {\n        id: 'showcase-save-edits',\n        target: '[data-tour-id=\"showcase-save-edits\"]',\n        title: 'Enregistrer les modifications',\n        content: 'Validez vos ajustements pour mettre à jour immédiatement la vitrine.'\n      },\n      {\n        id: 'showcase-back-to-report',\n        target: '[data-tour-id=\"showcase-back-to-report\"]',\n        title: 'Retourner à la synthèse',\n        content: 'Revenez au rapport de synthèse pour poursuivre votre préparation et éventuellement enregistrer la dernière version de votre projet.'\n      },\n      {\n        id: 'project-import',\n        target: '[data-tour-id=\"home-import-project\"]',\n        title: 'Charger un projet existant',\n        content: 'Vous pouvez importer un projet enregistrer pour reprendre son édition avant soumission à la compliance.'\n      },\n      {\n        id: 'project-filters',\n        target: '[data-tour-id=\"home-filters\"]',\n        title: 'Découvrir les projets',\n        content: 'Filtrez les initiatives par nom, équipe ou date et laissez vous inspirer.'\n      }\n    ];\n\n    const tour = new window.TourGuideClient({\n      steps,\n      labels: {\n        next: 'Suivant',\n        prev: 'Précédent',\n        close: 'Fermer',\n        finish: 'Terminer'\n      }\n    });\n\n    tour.on('stepChange', ({ step }) => {\n      const stepId = step?.id || null;\n      handleOnboardingStepEnter(stepId);\n      setOnboardingStepId(stepId);\n    });\n\n    tour.on('close', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.on('finish', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.start();\n    tourInstanceRef.current = tour;\n  }, [\n    isOnboardingActive,\n    mode,\n    screen,\n    adminView,\n    answers,\n    analysis,\n    projects,\n    projectFilters,\n    currentQuestionIndex,\n    validationError,\n    saveFeedback,\n    activeProjectId,\n    showcaseProjectContext,\n    hasUnsavedChanges,\n    backOfficeAuthError,\n    isBackOfficeUnlocked,\n    getDemoData,\n    buildOnboardingProjects,\n    handleOnboardingStepEnter,\n    finishOnboarding,\n    setMode,\n    setAdminView,\n    setScreen,\n    setShowcaseProjectContext,\n    setActiveProjectId,\n    setAnswers,\n    setAnalysis,\n    setValidationError,\n    setSaveFeedback,\n    setHasUnsavedChanges,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked,\n    setProjects,\n    setProjectFiltersState\n  ]);\n\n  useEffect(() => () => {\n    if (tourInstanceRef.current && typeof tourInstanceRef.current.stop === 'function') {\n      try {\n        tourInstanceRef.current.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Nettoyage du guide impossible :', error);\n        }\n      }\n    }\n    tourInstanceRef.current = null;\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!isHydrated || isOnboardingActive) return undefined;\n\n    if (persistTimeoutRef.current) {\n      clearTimeout(persistTimeoutRef.current);\n    }\n\n    persistTimeoutRef.current = setTimeout(() => {\n      const modeToPersist = mode === 'admin' ? 'user' : mode;\n\n      persistState({\n        mode: modeToPersist,\n        screen,\n        currentQuestionIndex,\n        answers,\n        analysis,\n        questions,\n        rules,\n        riskLevelRules,\n        riskWeights,\n        teams,\n        showcaseThemes,\n        projects,\n        activeProjectId,\n        projectFilters: normalizeProjectFilterConfig(projectFilters),\n        inspirationProjects,\n        inspirationFilters: normalizeInspirationFiltersConfig(inspirationFilters),\n        inspirationFormFields: normalizeInspirationFormConfig(inspirationFormFields),\n        homeView,\n        activeInspirationId\n      });\n      persistTimeoutRef.current = null;\n    }, 200);\n\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, [\n    mode,\n    screen,\n    currentQuestionIndex,\n    answers,\n    analysis,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    teams,\n    showcaseThemes,\n    projects,\n    activeProjectId,\n    projectFilters,\n    inspirationProjects,\n    inspirationFilters,\n    inspirationFormFields,\n    homeView,\n    activeInspirationId,\n    isHydrated,\n    isOnboardingActive\n  ]);\n\n  const tourContext = useMemo(\n    () => (isOnboardingActive ? { isActive: true, activeStep: onboardingStepId } : null),\n    [isOnboardingActive, onboardingStepId]\n  );\n\n  const activeQuestions = useMemo(\n    () => questions.filter(q => shouldShowQuestion(q, answers)),\n    [questions, answers]\n  );\n\n  const unansweredMandatoryQuestions = useMemo(\n    () =>\n      activeQuestions.filter(question => question.required && !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const pendingMandatoryQuestions = useMemo(\n    () =>\n      unansweredMandatoryQuestions.map(question => ({\n        question,\n        position: activeQuestions.findIndex(item => item.id === question.id) + 1\n      })),\n    [unansweredMandatoryQuestions, activeQuestions]\n  );\n\n  const hasIncompleteAnswers = useMemo(\n    () => activeQuestions.some(question => !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const teamLeadTeamOptions = useMemo(() => {\n    const leadTeamQuestion = questions.find(question => question?.id === 'teamLeadTeam');\n    if (!leadTeamQuestion || !Array.isArray(leadTeamQuestion.options)) {\n      return [];\n    }\n\n    const sanitized = leadTeamQuestion.options\n      .map(option => (typeof option === 'string' ? option.trim() : ''))\n      .filter(option => option.length > 0);\n\n    return Array.from(new Set(sanitized));\n  }, [questions]);\n\n  useEffect(() => {\n    if (!isHydrated) return;\n    if (activeQuestions.length === 0) return;\n    if (currentQuestionIndex >= activeQuestions.length) {\n      setCurrentQuestionIndex(activeQuestions.length - 1);\n    }\n  }, [activeQuestions.length, currentQuestionIndex, isHydrated]);\n\n  useEffect(() => {\n    if (screen !== 'questionnaire' && screen !== 'synthesis') {\n      setSaveFeedback(null);\n    }\n  }, [screen]);\n\n  const activeProject = useMemo(\n    () => projects.find(project => project.id === activeProjectId) || null,\n    [projects, activeProjectId]\n  );\n  const activeInspirationProject = useMemo(\n    () => inspirationProjects.find(project => project.id === activeInspirationId) || null,\n    [inspirationProjects, activeInspirationId]\n  );\n\n  const activeProjectName = useMemo(() => {\n    if (typeof activeProject?.projectName === 'string' && activeProject.projectName.trim().length > 0) {\n      return activeProject.projectName.trim();\n    }\n\n    return extractProjectName(answers, questions);\n  }, [activeProject, answers, questions]);\n\n  const activeShowcaseProjectId = showcaseProjectContext?.projectId || null;\n\n  const activeAnnotationContextKey = useMemo(\n    () => buildAnnotationContextKey({\n      screen,\n      projectId: activeShowcaseProjectId,\n      scope: showcaseAnnotationScope\n    }),\n    [activeShowcaseProjectId, screen, showcaseAnnotationScope]\n  );\n\n  const registerAnnotationSource = useCallback((sourceId, preferredColor) => {\n    if (!sourceId) {\n      return ANNOTATION_COLORS[0];\n    }\n\n    let resolvedColor = ANNOTATION_COLORS[0];\n\n    setAnnotationSources(prevSources => {\n      if (prevSources[sourceId]) {\n        resolvedColor = prevSources[sourceId];\n        return prevSources;\n      }\n\n      const usedColors = new Set(Object.values(prevSources));\n\n      if (preferredColor && !usedColors.has(preferredColor)) {\n        resolvedColor = preferredColor;\n      } else {\n        const availableColor = ANNOTATION_COLORS.find(color => !usedColors.has(color));\n        resolvedColor = availableColor || ANNOTATION_COLORS[0];\n      }\n\n      return { ...prevSources, [sourceId]: resolvedColor };\n    });\n\n    return resolvedColor;\n  }, []);\n\n  const resolveAnnotationTarget = useCallback((clientX, clientY, targetElement = null) => {\n    if (typeof document === 'undefined') {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const activeTarget = targetElement instanceof Element\n      ? targetElement\n      : document.elementFromPoint(clientX, clientY);\n\n    const sectionElement = activeTarget?.closest('[data-showcase-section]');\n\n    if (!sectionElement) {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const rect = sectionElement.getBoundingClientRect();\n    const sectionWidth = rect?.width || 1;\n    const sectionHeight = rect?.height || 1;\n\n    return {\n      sectionId: sectionElement.getAttribute('data-showcase-section') || null,\n      sectionX: clamp01((clientX - rect.left) / sectionWidth),\n      sectionY: clamp01((clientY - rect.top) / sectionHeight)\n    };\n  }, []);\n\n  const handleAddAnnotationNote = useCallback((clientX, clientY, targetElement = null) => {\n    if (screen !== 'showcase' || !showcaseProjectContext || isAnnotationPaused) {\n      return;\n    }\n\n    const width = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const height = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const x = clamp01(clientX / width);\n    const y = clamp01(clientY / height);\n    const sourceId = 'session';\n    const color = registerAnnotationSource(sourceId);\n    const { sectionId, sectionX, sectionY } = resolveAnnotationTarget(clientX, clientY, targetElement);\n\n    const newNoteId = createAnnotationId();\n\n    setAnnotationNotes(prevNotes => [\n      ...prevNotes,\n      {\n        id: newNoteId,\n        x,\n        y,\n        sectionId,\n        sectionX: sectionX ?? x,\n        sectionY: sectionY ?? y,\n        text: '',\n        color,\n        contextId: activeAnnotationContextKey,\n        projectId: showcaseProjectContext.projectId || 'unknown',\n        projectName: showcaseProjectContext.projectName || '',\n        sourceId\n      }\n    ]);\n    setAutoFocusAnnotationId(newNoteId);\n  }, [\n    activeAnnotationContextKey,\n    isAnnotationPaused,\n    registerAnnotationSource,\n    resolveAnnotationTarget,\n    screen,\n    showcaseProjectContext\n  ]);\n\n  const handleAnnotationTextChange = useCallback((noteId, text) => {\n    setAnnotationNotes(prevNotes => prevNotes.map(note => (\n      note?.id === noteId\n        ? { ...note, text }\n        : note\n    )));\n  }, []);\n\n  const handleRemoveAnnotationNote = useCallback((noteId) => {\n    setAnnotationNotes(prevNotes => prevNotes.filter(note => note?.id !== noteId));\n  }, []);\n\n  const handleToggleAnnotationMode = useCallback(() => {\n    setIsAnnotationModeEnabled(prev => {\n      const next = !prev;\n\n      if (!next) {\n        setIsAnnotationPaused(false);\n      }\n\n      return next;\n    });\n  }, []);\n\n  const handleToggleAnnotationPause = useCallback(() => {\n    setIsAnnotationPaused(prev => !prev);\n  }, []);\n\n  const downloadAnnotationFile = useCallback((notesToSave, projectName) => {\n    if (!Array.isArray(notesToSave) || notesToSave.length === 0 || typeof window === 'undefined') {\n      return;\n    }\n\n    const safeName = typeof projectName === 'string' && projectName.trim().length > 0\n      ? projectName.trim()\n      : 'projet';\n\n    const payload = JSON.stringify(notesToSave, null, 2);\n    const blob = new Blob([payload], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = `Commentaire sur le projet ${safeName}.json`;\n    anchor.click();\n    URL.revokeObjectURL(url);\n  }, []);\n\n  const handleSaveAnnotationNotes = useCallback(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    const projectNotes = annotationNotes.filter(note => note?.projectId === showcaseProjectContext.projectId);\n\n    if (projectNotes.length === 0) {\n      return;\n    }\n\n    downloadAnnotationFile(projectNotes, showcaseProjectContext.projectName);\n  }, [annotationNotes, downloadAnnotationFile, showcaseProjectContext]);\n\n  const handleRequestAnnotationFile = useCallback(() => {\n    if (annotationFileInputRef.current) {\n      annotationFileInputRef.current.value = '';\n      annotationFileInputRef.current.click();\n    }\n  }, []);\n\n  const handleAnnotationFileChange = useCallback((event) => {\n    const [file] = event?.target?.files || [];\n    const fileInput = event?.target;\n\n    if (!file) {\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = () => {\n      try {\n        const parsed = JSON.parse(reader.result || '[]');\n        const rawNotes = Array.isArray(parsed)\n          ? parsed\n          : Array.isArray(parsed?.notes)\n            ? parsed.notes\n            : [];\n\n        if (!Array.isArray(rawNotes) || rawNotes.length === 0) {\n          return;\n        }\n\n        const sourceId = file.name || `import-${Date.now()}`;\n        const sourceColor = registerAnnotationSource(sourceId);\n\n        const importedNotes = rawNotes.map(rawNote => {\n          const normalizedX = clamp01(rawNote?.x ?? 0);\n          const normalizedY = clamp01(rawNote?.y ?? 0);\n\n          return {\n            id: rawNote?.id || createAnnotationId(),\n            x: normalizedX,\n            y: normalizedY,\n            sectionId: typeof rawNote?.sectionId === 'string' ? rawNote.sectionId : null,\n            sectionX: clamp01(rawNote?.sectionX ?? normalizedX),\n            sectionY: clamp01(rawNote?.sectionY ?? normalizedY),\n            text: typeof rawNote?.text === 'string' ? rawNote.text : '',\n            color: sourceColor,\n            contextId: rawNote?.contextId || activeAnnotationContextKey,\n            projectId: rawNote?.projectId || showcaseProjectContext?.projectId || 'unknown',\n            projectName: rawNote?.projectName || showcaseProjectContext?.projectName || '',\n            sourceId\n          };\n        });\n\n        setAnnotationNotes(prevNotes => [...prevNotes, ...importedNotes]);\n      } catch (error) {\n        // Malformed file, ignore silently\n      } finally {\n        if (fileInput) {\n          fileInput.value = '';\n        }\n      }\n    };\n\n    reader.readAsText(file);\n  }, [activeAnnotationContextKey, registerAnnotationSource, showcaseProjectContext]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    if (!isAnnotationModeEnabled || isAnnotationPaused || screen !== 'showcase') {\n      return undefined;\n    }\n\n    const handleDocumentClick = (event) => {\n      const target = event?.target;\n\n      if (target instanceof Element && target.closest('[data-annotation-ui=\"true\"]')) {\n        return;\n      }\n\n      handleAddAnnotationNote(event.clientX, event.clientY, target);\n    };\n\n    window.addEventListener('click', handleDocumentClick, true);\n\n    return () => {\n      window.removeEventListener('click', handleDocumentClick, true);\n    };\n  }, [handleAddAnnotationNote, isAnnotationModeEnabled, isAnnotationPaused, screen]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return undefined;\n    }\n\n    const { projectName, projectId } = showcaseProjectContext;\n\n    return () => {\n      const projectNotes = (annotationNotesRef.current || []).filter(note => note?.projectId === projectId);\n\n      if (projectNotes.length > 0) {\n        downloadAnnotationFile(projectNotes, projectName);\n      }\n    };\n  }, [downloadAnnotationFile, showcaseProjectContext]);\n\n  const isAdminMode = mode === 'admin';\n  const isAdminHomeView = isAdminMode && adminView === 'home';\n  const isAdminBackOfficeView = isAdminMode && adminView === 'back-office';\n  const isActiveProjectEditable = isAdminMode || !activeProject || activeProject.status === 'draft';\n  const annotationOffsetClass = isAnnotationModeEnabled && screen === 'showcase'\n    ? 'pt-20 lg:pt-24'\n    : '';\n\n  const handleAnswer = useCallback((questionId, answer) => {\n    let answerChanged = false;\n    let nextAnswersSnapshot = null;\n\n    setAnswers(prevAnswers => {\n      const previousValue = prevAnswers[questionId];\n      if (!areAnswersEqual(previousValue, answer)) {\n        answerChanged = true;\n      }\n\n      const nextAnswers = { ...prevAnswers, [questionId]: answer };\n\n      const questionsToRemove = questions\n        .filter(q => !shouldShowQuestion(q, nextAnswers))\n        .map(q => q.id);\n\n      if (questionsToRemove.length === 0) {\n        if (answerChanged) {\n          nextAnswersSnapshot = nextAnswers;\n        }\n        return answerChanged ? nextAnswers : prevAnswers;\n      }\n\n      const sanitizedAnswers = { ...nextAnswers };\n      let removedExistingAnswer = false;\n      questionsToRemove.forEach(qId => {\n        if (Object.prototype.hasOwnProperty.call(sanitizedAnswers, qId)) {\n          if (Object.prototype.hasOwnProperty.call(prevAnswers, qId)) {\n            removedExistingAnswer = true;\n          }\n          delete sanitizedAnswers[qId];\n        }\n      });\n\n      if (!answerChanged) {\n        if (removedExistingAnswer) {\n          answerChanged = true;\n        } else {\n          const prevKeys = Object.keys(prevAnswers);\n          const nextKeys = Object.keys(sanitizedAnswers);\n          if (prevKeys.length !== nextKeys.length) {\n            answerChanged = true;\n          } else if (nextKeys.some(key => !areAnswersEqual(prevAnswers[key], sanitizedAnswers[key]))) {\n            answerChanged = true;\n          }\n        }\n      }\n\n      if (answerChanged) {\n        nextAnswersSnapshot = sanitizedAnswers;\n      }\n\n      return answerChanged ? sanitizedAnswers : prevAnswers;\n    });\n\n    if (!answerChanged || !nextAnswersSnapshot) {\n      setValidationError(prev => {\n        if (!prev) return null;\n        return prev.questionId === questionId ? null : prev;\n      });\n      return;\n    }\n\n    setHasUnsavedChanges(true);\n\n    const updatedAnalysis = Object.keys(nextAnswersSnapshot).length > 0\n      ? analyzeAnswers(nextAnswersSnapshot, rules, riskLevelRules, riskWeights)\n      : null;\n\n    setAnalysis(updatedAnalysis);\n\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswersSnapshot));\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => isAnswerProvided(nextAnswersSnapshot[question.id])).length\n      : Object.keys(nextAnswersSnapshot).length;\n    const inferredName = extractProjectName(nextAnswersSnapshot, questions);\n    const normalizedInferredName = typeof inferredName === 'string' ? inferredName.trim() : '';\n\n    if (activeProjectId && isActiveProjectEditable) {\n      setProjects(prevProjects => {\n        const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n        if (projectIndex === -1) {\n          return prevProjects;\n        }\n\n        const project = prevProjects[projectIndex];\n        if (!project) {\n          return prevProjects;\n        }\n\n        const canUpdateProject = project.status === 'draft' || isAdminMode;\n        if (!canUpdateProject) {\n          return prevProjects;\n        }\n\n        const totalQuestions = relevantQuestions.length > 0\n          ? relevantQuestions.length\n          : project.totalQuestions || questions.length || 0;\n        const sanitizedName = normalizedInferredName.length > 0\n          ? normalizedInferredName\n          : project.projectName;\n        const lastQuestionIndex = totalQuestions > 0\n          ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n          : project.lastQuestionIndex ?? 0;\n\n        const updatedProject = {\n          ...project,\n          answers: nextAnswersSnapshot,\n          analysis: updatedAnalysis,\n          projectName: sanitizedName,\n          totalQuestions,\n          answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n          lastQuestionIndex,\n          lastUpdated: new Date().toISOString()\n        };\n\n        const nextProjects = prevProjects.slice();\n        nextProjects[projectIndex] = updatedProject;\n        return nextProjects;\n      });\n    }\n\n    setValidationError(prev => {\n      if (!prev) return null;\n      return prev.questionId === questionId ? null : prev;\n    });\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion\n  ]);\n\n  const handleUpdateAnswers = useCallback((updates) => {\n    if (!isActiveProjectEditable) {\n      return;\n    }\n\n    let sanitizedResult = null;\n\n    setAnswers(prevAnswers => {\n      const { nextAnswers, changed } = applyAnswerUpdates(prevAnswers, updates, questions, shouldShowQuestion);\n      if (!changed) {\n        return prevAnswers;\n      }\n      sanitizedResult = nextAnswers;\n      return nextAnswers;\n    });\n\n    if (sanitizedResult) {\n      const updatedAnalysis = analyzeAnswers(sanitizedResult, rules, riskLevelRules, riskWeights);\n      setAnalysis(updatedAnalysis);\n      setValidationError(null);\n      setHasUnsavedChanges(true);\n\n      if (activeProjectId) {\n        setProjects(prevProjects => {\n          const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n          if (projectIndex === -1) {\n            return prevProjects;\n          }\n\n          const project = prevProjects[projectIndex];\n          if (!project) {\n            return prevProjects;\n          }\n\n          const canUpdateProject = project.status === 'draft' || isAdminMode;\n          if (!canUpdateProject) {\n            return prevProjects;\n          }\n\n          const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedResult));\n          const totalQuestions = relevantQuestions.length > 0\n            ? relevantQuestions.length\n            : project.totalQuestions || questions.length || 0;\n          const answeredQuestionsCount = relevantQuestions.length > 0\n            ? relevantQuestions.filter(question => isAnswerProvided(sanitizedResult[question.id])).length\n            : Object.keys(sanitizedResult).length;\n          const inferredName = extractProjectName(sanitizedResult, questions);\n          const sanitizedName = inferredName && inferredName.trim().length > 0\n            ? inferredName.trim()\n            : project.projectName;\n          const lastQuestionIndex = totalQuestions > 0\n            ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n            : project.lastQuestionIndex ?? 0;\n\n          const updatedProject = {\n            ...project,\n            answers: sanitizedResult,\n            analysis: updatedAnalysis,\n            projectName: sanitizedName,\n            totalQuestions,\n            answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n            lastQuestionIndex,\n            lastUpdated: new Date().toISOString()\n          };\n\n          const nextProjects = prevProjects.slice();\n          nextProjects[projectIndex] = updatedProject;\n          return nextProjects;\n        });\n      }\n    }\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const resetProjectState = useCallback(() => {\n    setAnswers({});\n    setCurrentQuestionIndex(0);\n    setAnalysis(null);\n    setValidationError(null);\n    setActiveProjectId(null);\n    setHasUnsavedChanges(false);\n    setReturnToSynthesisAfterEdit(false);\n  }, [setHasUnsavedChanges]);\n\n  const openBackOfficePrompt = useCallback(() => new Promise((resolve) => {\n    backOfficePromptResolverRef.current = resolve;\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    setIsBackOfficePromptOpen(true);\n  }), []);\n\n  const closeBackOfficePrompt = useCallback((result = false) => {\n    setIsBackOfficePromptOpen(false);\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    const resolver = backOfficePromptResolverRef.current;\n    backOfficePromptResolverRef.current = null;\n    if (typeof resolver === 'function') {\n      resolver(result);\n    }\n  }, []);\n\n  const handleBackOfficePromptSubmit = useCallback(async (event) => {\n    event.preventDefault();\n    const trimmed = backOfficePromptValue.trim();\n    if (!trimmed) {\n      setBackOfficePromptError('Veuillez saisir un mot de passe.');\n      return;\n    }\n\n    const isValid = await verifyBackOfficePassword(trimmed);\n\n    if (isValid) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      closeBackOfficePrompt(true);\n      return;\n    }\n\n    setIsBackOfficeUnlocked(false);\n    setBackOfficeAuthError('Mot de passe incorrect. Veuillez réessayer.');\n    setBackOfficePromptError('Mot de passe incorrect. Veuillez réessayer.');\n  }, [backOfficePromptValue, closeBackOfficePrompt]);\n\n  const requestAdminAccess = useCallback(async () => {\n    if (isAdminMode) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    if (isBackOfficeUnlocked) {\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    setBackOfficeAuthError(null);\n    return openBackOfficePrompt();\n  }, [\n    isAdminMode,\n    isBackOfficeUnlocked,\n    openBackOfficePrompt,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked\n  ]);\n\n  const handleBackOfficeClick = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('back-office');\n  }, [requestAdminAccess, setMode]);\n\n  const handleActivateAdminOnHome = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('home');\n    setScreen('home');\n  }, [requestAdminAccess, setMode, setScreen]);\n\n  const handleReturnToProjectMode = useCallback(() => {\n    setMode('user');\n    setAdminView('home');\n    setBackOfficeAuthError(null);\n  }, [setBackOfficeAuthError, setMode]);\n\n  const handleCreateNewProject = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleStartInspirationProject = useCallback(() => {\n    setScreen('inspiration-form');\n  }, []);\n\n  const handleSaveInspirationProject = useCallback((payload) => {\n    const project = {\n      id: createInspirationId(),\n      ...payload\n    };\n    setInspirationProjects((prev) => [project, ...(Array.isArray(prev) ? prev : [])]);\n    setHomeView('inspiration');\n    setScreen('home');\n  }, []);\n\n  const handleOpenInspirationProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n    setActiveInspirationId(projectId);\n    setScreen('inspiration-detail');\n  }, []);\n\n  const handleUpdateInspirationProject = useCallback((projectId, updates) => {\n    if (!projectId || !updates) {\n      return;\n    }\n\n    setInspirationProjects((prev) => (Array.isArray(prev) ? prev : []).map((project) => {\n      if (!project || project.id !== projectId) {\n        return project;\n      }\n\n      return { ...project, ...updates };\n    }));\n  }, []);\n\n  const handleImportProject = useCallback((file) => {\n    if (!file) {\n      return;\n    }\n\n    if (typeof FileReader === 'undefined') {\n      if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n        console.warn('[projectImport] FileReader API indisponible dans cet environnement.');\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Votre navigateur ne permet pas d\\'importer un projet depuis un fichier.');\n      }\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = (event) => {\n      try {\n        const content = typeof event?.target?.result === 'string' ? event.target.result : '';\n\n        if (!content) {\n          throw new Error('EMPTY_FILE');\n        }\n\n        const parsed = JSON.parse(content);\n        const projectData = parsed?.project && typeof parsed.project === 'object' ? parsed.project : parsed;\n\n        if (!projectData || typeof projectData !== 'object') {\n          throw new Error('INVALID_PROJECT');\n        }\n\n        const importedAnswers = projectData.answers && typeof projectData.answers === 'object'\n          ? projectData.answers\n          : {};\n        const importedAnalysis = projectData.analysis && typeof projectData.analysis === 'object'\n          ? projectData.analysis\n          : null;\n        const importedName = typeof projectData.name === 'string' ? projectData.name.trim() : '';\n        const projectName = importedName.length > 0 ? importedName : 'Projet importé';\n        const importedTotalQuestions = Array.isArray(projectData?.questionnaire?.questionIds)\n          ? projectData.questionnaire.questionIds.length\n          : undefined;\n\n        const entry = handleSaveProject({\n          id: `project-${Date.now()}`,\n          projectName,\n          answers: importedAnswers,\n          analysis: importedAnalysis,\n          status: 'draft',\n          totalQuestions: importedTotalQuestions,\n          lastQuestionIndex: 0\n        });\n\n        if (!entry) {\n          throw new Error('SAVE_FAILED');\n        }\n\n        const relevantQuestions = questions.filter(question => shouldShowQuestion(question, importedAnswers));\n        const missingMandatory = relevantQuestions.filter(question => question.required && !isAnswerProvided(importedAnswers[question.id]));\n        const firstMissingId = missingMandatory[0]?.id;\n        const derivedAnalysis = entry.analysis\n          || (Object.keys(importedAnswers).length > 0 ? analyzeAnswers(importedAnswers, rules, riskLevelRules, riskWeights) : null);\n\n        const nextIndex = firstMissingId\n          ? Math.max(relevantQuestions.findIndex(question => question.id === firstMissingId), 0)\n          : relevantQuestions.length > 0\n            ? Math.min(entry.lastQuestionIndex ?? 0, relevantQuestions.length - 1)\n            : 0;\n        const hasPendingMandatory = missingMandatory.length > 0;\n\n        setAnswers(importedAnswers);\n        setAnalysis(derivedAnalysis);\n        setCurrentQuestionIndex(nextIndex);\n        setValidationError(null);\n        setActiveProjectId(entry.id);\n        setScreen('synthesis');\n        setSaveFeedback({\n          status: 'success',\n          message: hasPendingMandatory\n            ? 'Projet importé. La synthèse est disponible. Complétez les questions obligatoires avant de soumettre.'\n            : 'Projet importé. La synthèse est disponible.'\n        });\n        setHasUnsavedChanges(false);\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.error === 'function') {\n          console.error('[projectImport] Impossible de charger le projet :', error);\n        }\n        if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n          window.alert('Le fichier sélectionné est invalide. Veuillez vérifier le JSON exporté.');\n        }\n      }\n    };\n\n    reader.onerror = () => {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Échec de la lecture du fichier :', reader.error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Impossible de lire le fichier sélectionné. Veuillez réessayer.');\n      }\n    };\n\n    try {\n      reader.readAsText(file, 'utf-8');\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Erreur inattendue lors de la lecture du fichier :', error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Une erreur est survenue lors de l\\'import du projet.');\n      }\n    }\n  }, [\n    handleSaveProject,\n    setHasUnsavedChanges,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    shouldShowQuestion,\n    analyzeAnswers\n  ]);\n\n  const navigateToSynthesis = useCallback(() => {\n    const result = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    setAnalysis(result);\n    setValidationError(null);\n    setReturnToSynthesisAfterEdit(false);\n    setScreen('synthesis');\n  }, [analyzeAnswers, answers, riskLevelRules, riskWeights, rules]);\n\n  const handleNext = useCallback(() => {\n    if (currentQuestionIndex < activeQuestions.length - 1) {\n      setCurrentQuestionIndex(currentQuestionIndex + 1);\n      setValidationError(null);\n      return;\n    }\n\n    navigateToSynthesis();\n  }, [activeQuestions, currentQuestionIndex, navigateToSynthesis]);\n\n  const handleBack = useCallback(() => {\n    if (currentQuestionIndex > 0) {\n      setCurrentQuestionIndex(currentQuestionIndex - 1);\n    }\n    setValidationError(null);\n  }, [currentQuestionIndex]);\n\n  const handleRestart = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleOpenProject = useCallback((projectId, options = {}) => {\n    if (!projectId) {\n      return;\n    }\n\n    const project = projects.find(item => item.id === projectId);\n    if (!project) {\n      return;\n    }\n\n    const projectAnswers = project.answers || {};\n    const derivedQuestions = questions.filter(q => shouldShowQuestion(q, projectAnswers));\n    const derivedAnalysis = Object.keys(projectAnswers).length > 0\n      ? analyzeAnswers(projectAnswers, rules, riskLevelRules, riskWeights)\n      : null;\n    const answeredQuestionsCount = derivedQuestions.length > 0\n      ? derivedQuestions.filter(question => isAnswerProvided(projectAnswers[question.id])).length\n      : Object.keys(projectAnswers).length;\n    const missingMandatory = derivedQuestions.filter(question => question.required && !isAnswerProvided(projectAnswers[question.id]));\n    const totalQuestions = derivedQuestions.length;\n    const rawIndex = typeof project.lastQuestionIndex === 'number' ? project.lastQuestionIndex : 0;\n    const sanitizedIndex = totalQuestions > 0 ? Math.min(Math.max(rawIndex, 0), totalQuestions - 1) : 0;\n    const firstMissingId = missingMandatory[0]?.id;\n    const missingIndex = firstMissingId\n      ? derivedQuestions.findIndex(question => question.id === firstMissingId)\n      : -1;\n    const startingIndex = missingIndex >= 0 ? missingIndex : project.status === 'draft' ? sanitizedIndex : 0;\n\n    setAnswers(projectAnswers);\n    setAnalysis(derivedAnalysis);\n    setCurrentQuestionIndex(startingIndex);\n    setValidationError(null);\n    setActiveProjectId(project.id);\n\n    setProjects(prevProjects => prevProjects.map(entry => {\n      if (entry.id !== project.id) {\n        return entry;\n      }\n\n      return {\n        ...entry,\n        analysis: derivedAnalysis,\n        totalQuestions,\n        answeredQuestions: Math.min(\n          answeredQuestionsCount,\n          totalQuestions || answeredQuestionsCount\n        ),\n        lastQuestionIndex: sanitizedIndex\n      };\n    }));\n\n    const forcedView = typeof options?.view === 'string' ? options.view : null;\n\n    let targetScreen = null;\n    if (forcedView === 'synthesis' || forcedView === 'questionnaire' || forcedView === 'mandatory-summary') {\n      targetScreen = forcedView;\n    }\n\n    if (!targetScreen) {\n      targetScreen = project.status === 'draft' ? 'questionnaire' : 'synthesis';\n    }\n\n    setScreen(targetScreen);\n    setHasUnsavedChanges(false);\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    setHasUnsavedChanges,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const handleDeleteProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.filter(project => project.id !== projectId));\n    setActiveProjectId(prev => (prev === projectId ? null : prev));\n  }, []);\n\n  const handleDuplicateProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      const sourceProject = prevProjects.find(project => project.id === projectId);\n      if (!sourceProject) {\n        return prevProjects;\n      }\n\n      const answersClone = sourceProject.answers && typeof sourceProject.answers === 'object'\n        ? JSON.parse(JSON.stringify(sourceProject.answers))\n        : {};\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, answersClone));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : typeof sourceProject.totalQuestions === 'number' && sourceProject.totalQuestions > 0\n          ? sourceProject.totalQuestions\n          : questions.length;\n\n      const answeredQuestionsCount = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(answersClone[question.id])).length\n        : typeof sourceProject.answeredQuestions === 'number'\n          ? Math.min(sourceProject.answeredQuestions, totalQuestions || sourceProject.answeredQuestions)\n          : Object.keys(answersClone).length;\n\n      const computedAnalysis = Object.keys(answersClone).length > 0\n        ? analyzeAnswers(answersClone, rules, riskLevelRules, riskWeights)\n        : null;\n\n      const baseName = typeof sourceProject.projectName === 'string' && sourceProject.projectName.trim().length > 0\n        ? sourceProject.projectName.trim()\n        : 'Projet sans nom';\n      const nameWithoutCopyPrefix = baseName.replace(/^\\[Copie\\]\\s*/i, '').trim();\n      const duplicateBaseName = nameWithoutCopyPrefix.length > 0 ? nameWithoutCopyPrefix : baseName;\n\n      const duplicateEntry = {\n        id: `project-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n        projectName: `[Copie] ${duplicateBaseName}`,\n        answers: answersClone,\n        analysis: computedAnalysis,\n        status: 'draft',\n        lastUpdated: new Date().toISOString(),\n        lastQuestionIndex: 0,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n      };\n\n      return [duplicateEntry, ...prevProjects];\n    });\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const openProjectShowcase = useCallback((context = {}) => {\n    const {\n      projectId = null,\n      projectName: providedProjectName,\n      status: providedStatus,\n      answers: providedAnswers,\n      analysis: providedAnalysis,\n      relevantTeams: providedRelevantTeams,\n      questions: providedQuestions,\n      timelineDetails: providedTimelineDetails\n    } = context || {};\n\n    const project = projectId ? projects.find(item => item.id === projectId) : null;\n    const answersSource = providedAnswers || project?.answers || {};\n    const visibleQuestions = Array.isArray(providedQuestions) && providedQuestions.length > 0\n      ? providedQuestions\n      : questions.filter(question => shouldShowQuestion(question, answersSource));\n    const computedAnalysis = providedAnalysis\n      || (Object.keys(answersSource).length > 0\n        ? analyzeAnswers(answersSource, rules, riskLevelRules, riskWeights)\n        : null);\n    const relevantTeamsList = Array.isArray(providedRelevantTeams) && providedRelevantTeams.length > 0\n      ? providedRelevantTeams\n      : teams.filter(team => (computedAnalysis?.teams || []).includes(team.id));\n    const timelineDetailsList = Array.isArray(providedTimelineDetails)\n      ? providedTimelineDetails\n      : computedAnalysis?.timeline?.details || [];\n\n    const normalizedProjectName = typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : (typeof project?.projectName === 'string' && project.projectName.trim().length > 0\n        ? project.projectName.trim()\n        : extractProjectName(answersSource, questions));\n\n    const resolvedProjectName = normalizedProjectName && normalizedProjectName.length > 0\n      ? normalizedProjectName\n      : 'Projet sans nom';\n    const resolvedStatus = providedStatus || project?.status || 'draft';\n\n    const answeredQuestionsCount = visibleQuestions.length > 0\n      ? visibleQuestions.filter(question => isAnswerProvided(answersSource[question.id])).length\n      : Object.keys(answersSource).length;\n\n    const hasShowcaseIncompleteAnswers = visibleQuestions.length > 0\n      ? visibleQuestions.some(question => !isAnswerProvided(answersSource[question.id]))\n      : Object.keys(answersSource).length === 0;\n\n    const totalQuestions = visibleQuestions.length > 0\n      ? visibleQuestions.length\n      : project?.totalQuestions || questions.length || 0;\n\n    if (projectId) {\n      setProjects(prevProjects => prevProjects.map(entry => {\n        if (entry.id !== projectId) {\n          return entry;\n        }\n\n        return {\n          ...entry,\n          analysis: computedAnalysis,\n          totalQuestions,\n          answeredQuestions: Math.min(\n            answeredQuestionsCount,\n            totalQuestions || answeredQuestionsCount\n          )\n        };\n      }));\n    }\n\n    setShowcaseProjectContext({\n      projectId: projectId || null,\n      projectName: resolvedProjectName,\n      status: resolvedStatus,\n      answers: answersSource,\n      analysis: computedAnalysis,\n      relevantTeams: relevantTeamsList,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      timelineDetails: timelineDetailsList,\n      hasIncompleteAnswers: hasShowcaseIncompleteAnswers\n    });\n    previousScreenRef.current = screen;\n    setScreen('showcase');\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    screen,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  useEffect(() => {\n    if (!isHydrated) {\n      return;\n    }\n\n    const pendingProjectId = pendingShowcaseProjectIdRef.current;\n    if (!pendingProjectId) {\n      return;\n    }\n\n    const matchingProject = projects.find(project => project?.id === pendingProjectId);\n    if (!matchingProject) {\n      return;\n    }\n\n    pendingShowcaseProjectIdRef.current = null;\n    openProjectShowcase({ projectId: pendingProjectId });\n  }, [isHydrated, openProjectShowcase, projects]);\n\n  const handleShowProjectShowcase = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    openProjectShowcase({ projectId });\n  }, [openProjectShowcase]);\n\n  const handleOpenActiveProjectShowcase = useCallback((payload = {}) => {\n    const projectId = payload?.projectId || activeProjectId || null;\n\n    openProjectShowcase({\n      ...payload,\n      projectId\n    });\n  }, [activeProjectId, openProjectShowcase]);\n\n  const handleCloseProjectShowcase = useCallback(() => {\n    setShowcaseProjectContext(null);\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('home');\n    }\n    previousScreenRef.current = null;\n  }, []);\n\n  const handleReturnToComplianceReport = useCallback(() => {\n    if (showcaseProjectContext?.projectId) {\n      const { projectId } = showcaseProjectContext;\n      setShowcaseProjectContext(null);\n      previousScreenRef.current = null;\n      handleOpenProject(projectId, { view: 'synthesis' });\n      return;\n    }\n\n    setShowcaseProjectContext(null);\n\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('synthesis');\n    }\n\n    previousScreenRef.current = null;\n  }, [handleOpenProject, showcaseProjectContext, setScreen]);\n\n  const handleUpdateProjectShowcaseAnswers = useCallback((updates) => {\n    if (\n      !showcaseProjectContext ||\n      !showcaseProjectContext.projectId ||\n      (showcaseProjectContext.status !== 'draft' && !isAdminMode)\n    ) {\n      return;\n    }\n\n    const projectId = showcaseProjectContext.projectId;\n    let contextPatch = null;\n    let hasProjectChanges = false;\n\n    setProjects(prevProjects => {\n      const project = prevProjects.find(entry => entry.id === projectId);\n      if (!project || (project.status !== 'draft' && !isAdminMode)) {\n        return prevProjects;\n      }\n\n      const { nextAnswers, changed } = applyAnswerUpdates(\n        project.answers || {},\n        updates,\n        questions,\n        shouldShowQuestion,\n        {\n          shouldPreserveQuestion: (question) => !question?.showcase\n        }\n      );\n      if (!changed) {\n        return prevProjects;\n      }\n\n      hasProjectChanges = true;\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswers));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : project.totalQuestions || questions.length || 0;\n      const answeredQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(nextAnswers[question.id])).length\n        : Object.keys(nextAnswers).length;\n\n      const updatedAnalysis = analyzeAnswers(nextAnswers, rules, riskLevelRules, riskWeights);\n      const timelineDetails = updatedAnalysis?.timeline?.details || [];\n      const relevantTeamsIds = Array.isArray(updatedAnalysis?.teams) ? updatedAnalysis.teams : [];\n      const relevantTeams = teams.filter(team => relevantTeamsIds.includes(team.id));\n      const inferredName = extractProjectName(nextAnswers, questions);\n      const sanitizedName = inferredName && inferredName.trim().length > 0\n        ? inferredName.trim()\n        : project.projectName;\n\n      const lastQuestionIndex = totalQuestions > 0\n        ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n        : project.lastQuestionIndex ?? 0;\n\n      contextPatch = {\n        projectName: sanitizedName,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        relevantTeams,\n        timelineDetails,\n        questions: relevantQuestions.length > 0 ? relevantQuestions : null\n      };\n\n      const now = new Date().toISOString();\n\n      const updatedProject = {\n        ...project,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        projectName: sanitizedName,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex,\n        lastUpdated: now\n      };\n\n      return [updatedProject, ...prevProjects.filter(entry => entry.id !== projectId)];\n    });\n\n    if (contextPatch) {\n      setShowcaseProjectContext(prev => {\n        if (!prev || prev.projectId !== projectId) {\n          return prev;\n        }\n\n        return {\n          ...prev,\n          ...contextPatch,\n          questions: contextPatch.questions ? contextPatch.questions : prev.questions\n        };\n      });\n    }\n\n    if (hasProjectChanges) {\n      setHasUnsavedChanges(true);\n    }\n  }, [\n    analyzeAnswers,\n    extractProjectName,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    showcaseProjectContext,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  const upsertProject = useCallback((entry) => {\n    return prevProjects => {\n      if (!entry || !entry.id) {\n        return prevProjects;\n      }\n\n      const filtered = prevProjects.filter(project => project.id !== entry.id);\n      return [entry, ...filtered];\n    };\n  }, []);\n\n  const handleSaveProject = useCallback((payload = {}) => {\n    const baseAnswers = payload.answers && typeof payload.answers === 'object' ? payload.answers : answers;\n    const sanitizedAnswers = baseAnswers || {};\n    const status = payload.status === 'submitted' ? 'submitted' : 'draft';\n    const projectId = activeProjectId || payload.id || `project-${Date.now()}`;\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedAnswers));\n    const computedTotalQuestions = payload.totalQuestions\n      || (relevantQuestions.length > 0 ? relevantQuestions.length : activeQuestions.length);\n    const totalQuestions = computedTotalQuestions > 0 ? computedTotalQuestions : activeQuestions.length;\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => {\n        const value = sanitizedAnswers[question.id];\n        if (Array.isArray(value)) {\n          return value.length > 0;\n        }\n        if (typeof value === 'string') {\n          return value.trim().length > 0;\n        }\n        return value !== null && value !== undefined;\n      }).length\n      : Object.keys(sanitizedAnswers).length;\n    const now = new Date().toISOString();\n\n    let computedAnalysis = null;\n    if (payload.analysis && typeof payload.analysis === 'object') {\n      computedAnalysis = payload.analysis;\n    } else if (Object.keys(sanitizedAnswers).length > 0) {\n      computedAnalysis = analyzeAnswers(sanitizedAnswers, rules, riskLevelRules, riskWeights);\n    }\n\n    if (status === 'submitted' && !computedAnalysis) {\n      return null;\n    }\n\n    const inferredName = extractProjectName(sanitizedAnswers, questions);\n    const projectNameRaw = typeof payload.projectName === 'string' ? payload.projectName : inferredName;\n    const sanitizedName =\n      projectNameRaw && projectNameRaw.trim().length > 0 ? projectNameRaw.trim() : 'Projet sans nom';\n\n    let lastQuestionIndex =\n      typeof payload.lastQuestionIndex === 'number' ? payload.lastQuestionIndex : currentQuestionIndex;\n    if (status === 'submitted' && totalQuestions > 0) {\n      lastQuestionIndex = totalQuestions - 1;\n    }\n\n    const clampedLastIndex = totalQuestions > 0\n      ? Math.min(Math.max(lastQuestionIndex, 0), totalQuestions - 1)\n      : 0;\n\n    const entry = {\n      id: projectId,\n      projectName: sanitizedName,\n      answers: sanitizedAnswers,\n      analysis: computedAnalysis,\n      status,\n      lastUpdated: now,\n      lastQuestionIndex: clampedLastIndex,\n      totalQuestions,\n      answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n    };\n\n    if (status === 'submitted') {\n      entry.submittedAt = now;\n    }\n\n    setProjects(upsertProject(entry));\n    setActiveProjectId(projectId);\n\n    if (computedAnalysis) {\n      setAnalysis(computedAnalysis);\n    }\n\n    setHasUnsavedChanges(false);\n\n    return entry;\n  }, [\n    activeProjectId,\n    activeQuestions.length,\n    analyzeAnswers,\n    answers,\n    currentQuestionIndex,\n    extractProjectName,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion,\n    upsertProject\n  ]);\n\n  const handleSubmitProject = useCallback((payload = {}) => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      setSaveFeedback({\n        status: 'error',\n        message: 'Impossible de soumettre : complétez les questions obligatoires avant l’envoi.'\n      });\n      setScreen('synthesis');\n      return null;\n    }\n\n    const entry = handleSaveProject({ ...payload, status: 'submitted' });\n    if (entry) {\n      setValidationError(null);\n      setScreen('home');\n    }\n  }, [handleSaveProject, unansweredMandatoryQuestions]);\n\n  const handleSaveDraft = useCallback((payload = {}) => {\n    const { lastQuestionIndex: payloadLastQuestionIndex, ...otherPayload } = payload || {};\n\n    const entry = handleSaveProject({\n      ...otherPayload,\n      lastQuestionIndex:\n        typeof payloadLastQuestionIndex === 'number'\n          ? payloadLastQuestionIndex\n          : currentQuestionIndex,\n      status: 'draft'\n    });\n\n    if (entry) {\n      setValidationError(null);\n\n      const exported = exportProjectToFile({\n        projectName: entry.projectName,\n        answers: entry.answers\n      });\n\n      setSaveFeedback(\n        exported\n          ? {\n              status: 'success',\n              message: 'Votre projet a bien été enregistré dans vos téléchargements'\n            }\n          : {\n              status: 'error',\n              message: 'Projet enregistré mais le téléchargement a échoué. Veuillez réessayer.'\n            }\n      );\n    }\n  }, [currentQuestionIndex, handleSaveProject]);\n\n  const handleDismissSaveFeedback = useCallback(() => {\n    setSaveFeedback(null);\n  }, []);\n\n  const handleBackToQuestionnaire = useCallback(() => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      const firstMissingId = unansweredMandatoryQuestions[0].id;\n      const targetIndex = activeQuestions.findIndex(question => question.id === firstMissingId);\n      if (targetIndex >= 0) {\n        setCurrentQuestionIndex(targetIndex);\n      }\n    } else if (activeQuestions.length > 0) {\n      const lastIndex = activeQuestions.length - 1;\n      setCurrentQuestionIndex(prevIndex => {\n        if (prevIndex > lastIndex) {\n          return lastIndex;\n        }\n        return prevIndex;\n      });\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions, unansweredMandatoryQuestions]);\n\n  const handleNavigateToQuestion = useCallback((questionId) => {\n    const targetIndex = activeQuestions.findIndex(question => question.id === questionId);\n    if (targetIndex >= 0) {\n      setCurrentQuestionIndex(targetIndex);\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions]);\n\n  const handleNavigateToQuestionFromReport = useCallback((questionId) => {\n    setReturnToSynthesisAfterEdit(true);\n    handleNavigateToQuestion(questionId);\n  }, [handleNavigateToQuestion]);\n\n  const handleReturnToSynthesisFromQuestionnaire = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const handleProceedToSynthesis = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const showcaseProjectId = showcaseProjectContext?.projectId || '';\n  const showcaseShareUrl = useMemo(() => {\n    if (!showcaseProjectId || typeof window === 'undefined') {\n      return '';\n    }\n\n    const url = new URL(window.location.href);\n    url.searchParams.set('projectId', showcaseProjectId);\n    url.hash = 'showcase';\n    return url.toString();\n  }, [showcaseProjectId]);\n\n  const handleOpenShowcaseShare = useCallback(() => {\n    if (!showcaseProjectId) {\n      return;\n    }\n\n    setIsShowcaseShareOpen(true);\n    setShowcaseShareFeedback('');\n  }, [showcaseProjectId]);\n\n  const handleCloseShowcaseShare = useCallback(() => {\n    setIsShowcaseShareOpen(false);\n    setShowcaseShareFeedback('');\n  }, []);\n\n  useEffect(() => {\n    if (!isShowcaseShareOpen) {\n      return;\n    }\n\n    if (showcaseShareInputRef.current && typeof showcaseShareInputRef.current.focus === 'function') {\n      showcaseShareInputRef.current.focus();\n    }\n  }, [isShowcaseShareOpen]);\n\n  const handleCopyShowcaseLink = useCallback(async () => {\n    if (!showcaseShareUrl) {\n      return;\n    }\n\n    try {\n      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n        await navigator.clipboard.writeText(showcaseShareUrl);\n        setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n        return;\n      }\n    } catch (error) {\n      // Fallback below.\n    }\n\n    if (typeof document !== 'undefined') {\n      const input = document.getElementById('showcase-share-link');\n      if (input && typeof input.select === 'function') {\n        input.select();\n        const copied = document.execCommand && document.execCommand('copy');\n        if (copied) {\n          setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n          return;\n        }\n      }\n    }\n\n    setShowcaseShareFeedback('Impossible de copier automatiquement le lien.');\n  }, [showcaseShareUrl]);\n\n  const handleDownloadShowcaseShortcut = useCallback(() => {\n    if (!showcaseShareUrl || typeof window === 'undefined') {\n      return;\n    }\n\n    const shortcutContent = `[InternetShortcut]\\nURL=${showcaseShareUrl}\\n`;\n    const blob = new Blob([shortcutContent], { type: 'text/plain' });\n    const fileName = `raccourci-showcase-${showcaseProjectId || 'projet'}.url`;\n    const downloadUrl = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n\n    anchor.href = downloadUrl;\n    anchor.download = fileName;\n    document.body.appendChild(anchor);\n    anchor.click();\n    anchor.remove();\n    URL.revokeObjectURL(downloadUrl);\n    setShowcaseShareFeedback('Raccourci téléchargé.');\n  }, [showcaseProjectId, showcaseShareUrl]);\n\n  return (\n    <div className={`min-h-screen ${annotationOffsetClass}`}>\n      <AnnotationLayer\n        isActive={isAnnotationModeEnabled && screen === 'showcase'}\n        isPaused={isAnnotationPaused}\n        isEditing={isShowcaseEditing}\n        notes={annotationNotes}\n        activeContextId={activeAnnotationContextKey}\n        sourceColors={annotationSources}\n        projectName={showcaseProjectContext?.projectName || ''}\n        autoFocusNoteId={autoFocusAnnotationId}\n        onAutoFocusComplete={() => setAutoFocusAnnotationId(null)}\n        onTogglePause={handleToggleAnnotationPause}\n        onRequestSave={handleSaveAnnotationNotes}\n        onRequestLoad={handleRequestAnnotationFile}\n        onExit={handleToggleAnnotationMode}\n        onNoteChange={handleAnnotationTextChange}\n        onNoteRemove={handleRemoveAnnotationNote}\n      />\n\n      <input\n        ref={annotationFileInputRef}\n        type=\"file\"\n        accept=\"application/json\"\n        className=\"sr-only\"\n        onChange={handleAnnotationFileChange}\n        data-annotation-ui=\"true\"\n      />\n\n      <div id=\"tour-onboarding-anchor\" className=\"sr-only\" aria-hidden=\"true\">\n        Guide interactif\n      </div>\n      <nav className=\"bg-white shadow-sm border-b border-gray-200 hv-surface\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-8 py-4\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-lg font-bold text-gray-800 sm:text-xl\">Project Navigator</h1>\n                <p className=\"text-xs text-gray-500\">Outil d'aide à la décision</p>\n              </div>\n            </div>\n\n            <div\n              className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 lg:justify-end\"\n              role=\"group\"\n              aria-label=\"Sélection du mode d'utilisation\"\n            >\n              {screen === 'showcase' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleToggleAnnotationMode}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      isAnnotationModeEnabled ? 'bg-blue-50 border-blue-200' : 'bg-white border-blue-100'\n                    }`}\n                    aria-pressed={isAnnotationModeEnabled}\n                    aria-label={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    title={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    data-annotation-ui=\"true\"\n                  >\n                    <MessageSquare className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Annotation</span>\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleOpenShowcaseShare}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      showcaseProjectId ? 'bg-white border-blue-100' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'\n                    }`}\n                    aria-label=\"Partager la vitrine du projet\"\n                    title={showcaseProjectId ? 'Partager la vitrine du projet' : 'Aucun projet vitrine disponible'}\n                    disabled={!showcaseProjectId}\n                  >\n                    <Link className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Partager</span>\n                  </button>\n                </>\n              )}\n              {mode === 'user' && screen === 'showcase' && showcaseProjectContext && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToComplianceReport}\n                  className=\"w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-blue-600 text-white hv-button-primary\"\n                  aria-label=\"Revenir à la synthèse du projet\"\n                  title=\"Revenir à la synthèse du projet\"\n                  data-tour-id=\"showcase-back-to-report\"\n                >\n                  Synthèse\n                </button>\n              )}\n              {mode === 'user' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleStartOnboarding}\n                    className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-2 ${\n                      isOnboardingActive\n                        ? 'bg-blue-600 text-white hv-button-primary'\n                        : isTourGuideReady\n                          ? 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 hv-focus-ring'\n                          : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'\n                    }`}\n                    disabled={!isTourGuideReady || isOnboardingActive}\n                    data-tour-id=\"nav-onboarding-trigger\"\n                    aria-label=\"Lancer le guide interactif\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Guide interactif</span>\n                  </button>\n                  {screen !== 'home' && (\n                    <button\n                      type=\"button\"\n                      onClick={() => setScreen('home')}\n                      className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-gray-100 text-gray-700 hover:bg-gray-200`}\n                      aria-pressed={false}\n                      aria-label=\"Retourner à l'accueil des projets\"\n                    >\n                      Accueil projets\n                    </button>\n                  )}\n                  <a\n                    href=\"https://forms.office.com/e/p6PYB1gbpM\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button text-white bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 hover:from-pink-600 hover:via-red-600 hover:to-yellow-600 focus-visible:ring-pink-400 hv-focus-ring\"\n                    aria-label=\"Partagez votre avis sur Project Navigator (nouvelle fenêtre)\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Partagez votre avis</span>\n                  </a>\n                </>\n              )}\n              {mode === 'admin' && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToProjectMode}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button ${\n                    mode === 'user'\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={mode === 'user'}\n                  aria-label=\"Basculer vers le mode chef de projet\"\n                >\n                  Mode Chef de Projet\n                </button>\n              )}\n              {!isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleActivateAdminOnHome}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center ${\n                    isAdminHomeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminHomeView}\n                  aria-label=\"Activer le mode administrateur sur la page d'accueil\"\n                  title=\"Activer le mode administrateur sur l'accueil\"\n                >\n                  <Lock className=\"text-lg sm:text-xl\" />\n                  <span className=\"sr-only\">Mode Administrateur (Accueil)</span>\n                </button>\n              )}\n              {isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleBackOfficeClick}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-3 ${\n                    isAdminBackOfficeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminBackOfficeView}\n                  aria-label=\"Accéder au Back-office\"\n                  title=\"Accéder au Back-office\"\n                >\n                  <span>Accéder au Back-office</span>\n                  <Settings className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                </button>\n              )}\n              {backOfficeAuthError && (\n                <p className=\"w-full text-sm text-red-600 sm:w-auto\" role=\"alert\">\n                  {backOfficeAuthError}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      {isShowcaseShareOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"showcase-share-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"text-center\">\n              <h2 id=\"showcase-share-title\" className=\"text-xl font-semibold text-gray-800\">\n                Partager la vitrine du projet\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Copiez le lien ou téléchargez un raccourci pour ouvrir directement cette vitrine.\n              </p>\n            </div>\n            <div className=\"space-y-3\">\n              <label htmlFor=\"showcase-share-link\" className=\"text-sm font-medium text-gray-700\">\n                Lien à partager\n              </label>\n              <input\n                id=\"showcase-share-link\"\n                type=\"text\"\n                value={showcaseShareUrl}\n                ref={showcaseShareInputRef}\n                readOnly\n                className=\"w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-800\"\n              />\n              {showcaseShareFeedback && (\n                <p className=\"text-sm text-blue-600\">{showcaseShareFeedback}</p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCopyShowcaseLink}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Copier le lien\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadShowcaseShortcut}\n                className=\"px-5 py-2 bg-white text-blue-700 font-medium rounded-lg border border-blue-200 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button\"\n              >\n                Télécharger le raccourci\n              </button>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCloseShowcaseShare}\n                className=\"text-sm text-gray-500 hover:text-gray-700\"\n              >\n                Fermer\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {isBackOfficePromptOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"backoffice-auth-title\"\n        >\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={() => closeBackOfficePrompt(false)} aria-hidden=\"true\" />\n          <form\n            onSubmit={handleBackOfficePromptSubmit}\n            className=\"relative w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl hv-surface\"\n          >\n            <div className=\"text-center\">\n              <h2 id=\"backoffice-auth-title\" className=\"text-xl font-semibold text-gray-800\">\n                Accès back-office\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Saisissez le mot de passe administrateur pour continuer.\n              </p>\n            </div>\n            <div className=\"mt-5 space-y-3\">\n              <label htmlFor=\"backoffice-password\" className=\"text-sm font-medium text-gray-700\">\n                Mot de passe\n              </label>\n              <input\n                id=\"backoffice-password\"\n                type=\"password\"\n                value={backOfficePromptValue}\n                onChange={(event) => setBackOfficePromptValue(event.target.value)}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                placeholder=\"Mot de passe\"\n              />\n              {backOfficePromptError && (\n                <p className=\"text-sm text-red-600\" role=\"alert\">\n                  {backOfficePromptError}\n                </p>\n              )}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={() => closeBackOfficePrompt(false)}\n                className=\"px-5 py-2 bg-white text-gray-700 font-medium rounded-lg border border-gray-200 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700\"\n              >\n                Déverrouiller\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n\n      <main id=\"main-content\" tabIndex=\"-1\" className=\"focus:outline-none hv-background\">\n        {!isHydrated ? (\n          <div className=\"flex min-h-[60vh] items-center justify-center\">\n            <LoadingFallback\n              label=\"Chargement de l’accueil…\"\n              hint=\"Préparation de votre espace.\"\n            />\n          </div>\n        ) : isAdminBackOfficeView ? (\n          <Suspense\n            fallback={(\n              <LoadingFallback\n                label=\"Chargement du back-office…\"\n                hint=\"Préparation des données administratives en cours.\"\n              />\n            )}\n          >\n            <LazyBackOffice\n              projects={projects}\n              questions={questions}\n              setQuestions={setQuestions}\n              rules={rules}\n              setRules={setRules}\n              riskLevelRules={riskLevelRules}\n              setRiskLevelRules={setRiskLevelRules}\n              riskWeights={riskWeights}\n              setRiskWeights={setRiskWeights}\n              teams={teams}\n              setTeams={setTeams}\n              showcaseThemes={showcaseThemes}\n              setShowcaseThemes={setShowcaseThemes}\n              projectFilters={projectFilters}\n              setProjectFilters={updateProjectFilters}\n              inspirationFilters={inspirationFilters}\n              setInspirationFilters={updateInspirationFilters}\n              inspirationFormFields={inspirationFormFields}\n              setInspirationFormFields={updateInspirationFormFields}\n            />\n          </Suspense>\n        ) : screen === 'home' ? (\n          <HomeScreen\n            projects={projects}\n            projectFilters={projectFilters}\n            teamLeadOptions={teamLeadTeamOptions}\n            inspirationProjects={inspirationProjects}\n            inspirationFilters={inspirationFilters}\n            homeView={homeView}\n            onHomeViewChange={setHomeView}\n            onStartInspirationProject={handleStartInspirationProject}\n            onOpenInspirationProject={handleOpenInspirationProject}\n            onStartNewProject={handleCreateNewProject}\n            onOpenProject={handleOpenProject}\n            onDeleteProject={handleDeleteProject}\n            onShowProjectShowcase={handleShowProjectShowcase}\n            onImportProject={handleImportProject}\n            onDuplicateProject={handleDuplicateProject}\n            isAdminMode={isAdminMode}\n            tourContext={tourContext}\n          />\n        ) : screen === 'inspiration-form' ? (\n          <InspirationForm\n            formConfig={inspirationFormFields}\n            existingProjects={inspirationProjects}\n            onSubmit={handleSaveInspirationProject}\n            onCancel={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n          />\n        ) : screen === 'inspiration-detail' ? (\n          <InspirationDetail\n            project={activeInspirationProject}\n            formConfig={inspirationFormFields}\n            onBack={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n            onUpdate={handleUpdateInspirationProject}\n          />\n        ) : screen === 'questionnaire' ? (\n          <QuestionnaireScreen\n            questions={activeQuestions}\n            currentIndex={currentQuestionIndex}\n            answers={answers}\n            onAnswer={handleAnswer}\n            onNext={handleNext}\n            onBack={handleBack}\n            allQuestions={questions}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onSaveDraft={isOnboardingActive ? noop : handleSaveDraft}\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            validationError={validationError}\n            onReturnToSynthesis={\n              returnToSynthesisAfterEdit ? handleReturnToSynthesisFromQuestionnaire : undefined\n            }\n            isReturnToSynthesisRequested={returnToSynthesisAfterEdit}\n            tourContext={tourContext}\n            onFinish={navigateToSynthesis}\n          />\n        ) : screen === 'mandatory-summary' ? (\n          <MandatoryQuestionsSummary\n            pendingQuestions={pendingMandatoryQuestions}\n            totalQuestions={activeQuestions.length}\n            onBackToQuestionnaire={handleBackToQuestionnaire}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onProceedToSynthesis={handleProceedToSynthesis}\n          />\n        ) : screen === 'synthesis' ? (\n          <SynthesisReport\n            answers={answers}\n            analysis={analysis}\n            teams={teams}\n            questions={activeQuestions}\n            projectStatus={activeProject?.status || null}\n            projectId={activeProjectId}\n            projectName={activeProjectName}\n            onOpenProjectShowcase={handleOpenActiveProjectShowcase}\n            isProjectEditable={isActiveProjectEditable}\n            onRestart={handleRestart}\n            onBack={isActiveProjectEditable ? handleBackToQuestionnaire : undefined}\n            onUpdateAnswers={isActiveProjectEditable ? handleUpdateAnswers : undefined}\n            onSubmitProject={handleSubmitProject}\n            onNavigateToQuestion={handleNavigateToQuestionFromReport}\n            isExistingProject={Boolean(activeProjectId)}\n            onSaveDraft={\n              isOnboardingActive\n                ? noop\n                : isActiveProjectEditable\n                  ? handleSaveDraft\n                  : undefined\n            }\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            isAdminMode={isAdminMode}\n            hasIncompleteAnswers={hasIncompleteAnswers}\n            tourContext={tourContext}\n          />\n        ) : screen === 'showcase' ? (\n          showcaseProjectContext ? (\n            <div className=\"space-y-4\">\n              {showcaseProjectContext.status !== 'draft' && (\n                <div className=\"rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800 hv-surface\">\n                  {isAdminMode\n                    ? 'Ce projet a été soumis. Vous pouvez le modifier car vous êtes en mode administrateur.'\n                    : 'Ce projet a été soumis. La vitrine est consultable en lecture seule.'}\n                </div>\n              )}\n              <Suspense\n                fallback={(\n                  <LoadingFallback\n                    label=\"Chargement de la vitrine du projet…\"\n                    hint=\"Nous construisons la synthèse visuelle du projet.\"\n                  />\n                )}\n              >\n                <LazyProjectShowcase\n                  projectName={showcaseProjectContext.projectName}\n                  onClose={handleCloseProjectShowcase}\n                  analysis={showcaseProjectContext.analysis}\n                  relevantTeams={showcaseProjectContext.relevantTeams}\n                  questions={showcaseProjectContext.questions}\n                  answers={showcaseProjectContext.answers}\n                  timelineDetails={showcaseProjectContext.timelineDetails}\n                  showcaseThemes={showcaseThemes}\n                  hasIncompleteAnswers={Boolean(showcaseProjectContext.hasIncompleteAnswers)}\n                  onUpdateAnswers={\n                    isOnboardingActive\n                      ? noop\n                      : showcaseProjectContext.status === 'draft' || isAdminMode\n                        ? handleUpdateProjectShowcaseAnswers\n                        : undefined\n                  }\n                  tourContext={tourContext}\n                  onAnnotationScopeChange={setShowcaseAnnotationScope}\n                  onEditingStateChange={setIsShowcaseEditing}\n                />\n              </Suspense>\n            </div>\n          ) : null\n        ) : null}\n      </main>\n\n      <footer className=\"bg-white border-t border-gray-200 mt-10\" aria-label=\"Pied de page\">\n        <p className=\"text-xs text-gray-400 text-center py-4\">\n          Project Navigator · Version {APP_VERSION} ·{' '}\n          <a\n            href=\"./mentions-legales.html\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"underline hover:text-gray-500\"\n          >\n            Mentions légales\n          </a>\n        </p>\n      </footer>\n    </div>\n  );\n};\n",
  "src/components/HomeScreen.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  Plus,\n  Target,\n  Rocket,\n  Compass,\n  Users,\n  Calendar,\n  CheckCircle,\n  Eye,\n  AlertTriangle,\n  Edit,\n  Save,\n  Upload,\n  Copy,\n  Trash2,\n  Sparkles\n} from './icons.js';\nimport { VirtualizedList } from './VirtualizedList.jsx';\nimport { normalizeProjectFilterConfig } from '../utils/projectFilters.js';\nimport { normalizeInspirationFiltersConfig } from '../utils/inspirationConfig.js';\n\nconst formatDate = (isoDate) => {\n  if (!isoDate) {\n    return 'Date inconnue';\n  }\n\n  try {\n    return new Date(isoDate).toLocaleString('fr-FR', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  } catch (error) {\n    return 'Date inconnue';\n  }\n};\n\nconst getSafeString = (value) => (typeof value === 'string' ? value : '');\n\nconst normalizeInspirationFieldValues = (value) => {\n  if (Array.isArray(value)) {\n    return value\n      .map((item) => (typeof item === 'string' ? item.trim() : ''))\n      .filter(Boolean);\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    return trimmed.length > 0 ? [trimmed] : [];\n  }\n\n  return [];\n};\n\nconst DEFAULT_SELECT_FILTER_VALUE = 'all';\nconst DEFAULT_TEXT_FILTER_VALUE = '';\n\nconst PROJECT_FILTER_VALUE_EXTRACTORS = {\n  projectName: (project) => {\n    if (!project) {\n      return '';\n    }\n\n    const directName = getSafeString(project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    return getSafeString(project.answers?.projectName);\n  },\n  teamLead: (project) => getSafeString(project?.answers?.teamLead),\n  teamLeadTeam: (project) => getSafeString(project?.answers?.teamLeadTeam)\n};\n\nconst formatAnswerValue = (value) => {\n  if (Array.isArray(value)) {\n    return value.map((item) => (item == null ? '' : String(item))).filter(Boolean).join(', ');\n  }\n\n  if (value == null) {\n    return '';\n  }\n\n  return String(value);\n};\n\nconst getProjectFilterValue = (field, project) => {\n  if (!field || !project) {\n    return '';\n  }\n\n  const extractor = PROJECT_FILTER_VALUE_EXTRACTORS[field.id];\n  if (typeof extractor === 'function') {\n    const extracted = extractor(project);\n    if (typeof extracted === 'string' && extracted.trim().length > 0) {\n      return extracted;\n    }\n  }\n\n  const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n    ? field.sourceQuestionId\n    : field.id;\n\n  const answerValue = project?.answers?.[sourceId];\n  if (typeof answerValue === 'string') {\n    return answerValue;\n  }\n\n  const formattedAnswer = formatAnswerValue(answerValue);\n  if (formattedAnswer.trim().length > 0) {\n    return formattedAnswer;\n  }\n\n  const directValue = project[sourceId];\n  if (typeof directValue === 'string') {\n    return directValue;\n  }\n\n  return formatAnswerValue(directValue);\n};\n\nconst getProjectTimestamp = (project) => {\n  if (!project) {\n    return 0;\n  }\n\n  const candidates = [project.lastUpdated, project.submittedAt, project.generatedAt];\n\n  for (let index = 0; index < candidates.length; index += 1) {\n    const candidate = candidates[index];\n    if (!candidate) {\n      continue;\n    }\n\n    const parsed = new Date(candidate).getTime();\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return 0;\n};\n\nconst buildInitialFiltersState = (config) => {\n  const initial = {\n    sortOrder: 'desc',\n    sortOrderDefault: 'desc'\n  };\n\n  if (!config || !Array.isArray(config.fields)) {\n    return initial;\n  }\n\n  config.fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.id === 'dateOrder') {\n      const defaultValue = field.defaultValue === 'asc' ? 'asc' : 'desc';\n      initial.sortOrder = defaultValue;\n      initial.sortOrderDefault = defaultValue;\n      return;\n    }\n\n    if (field.type === 'select') {\n      initial[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n    } else {\n      initial[field.id] = '';\n    }\n  });\n\n  return initial;\n};\n\nconst SORT_LABELS = {\n  desc: 'Les plus récents en premier',\n  asc: 'Les plus anciens en premier'\n};\n\nconst complexityColors = {\n  Faible: 'text-green-600',\n  Modérée: 'text-yellow-600',\n  Élevée: 'text-red-600'\n};\n\nconst statusStyles = {\n  draft: {\n    label: 'Brouillon en cours',\n    className: 'bg-yellow-50 border-yellow-200 text-yellow-600'\n  },\n  submitted: {\n    label: 'Synthèse finalisée',\n    className: 'bg-emerald-50 border-emerald-200 text-emerald-600'\n  }\n};\n\nconst computeRemainingQuestions = (project) => {\n  if (!project || typeof project.totalQuestions !== 'number' || project.totalQuestions <= 0) {\n    return null;\n  }\n\n  const answeredCountRaw =\n    typeof project.answeredQuestions === 'number'\n      ? project.answeredQuestions\n      : Math.max((project.lastQuestionIndex ?? 0) + 1, 0);\n\n  const answeredCount = Math.min(answeredCountRaw, project.totalQuestions);\n  const remainingCount = Math.max(project.totalQuestions - answeredCount, 0);\n\n  return remainingCount;\n};\n\nexport const HomeScreen = ({\n  projects = [],\n  projectFilters,\n  teamLeadOptions = [],\n  inspirationProjects = [],\n  inspirationFilters,\n  homeView = 'platform',\n  onHomeViewChange,\n  onStartInspirationProject,\n  onOpenInspirationProject,\n  onStartNewProject,\n  onOpenProject,\n  onDeleteProject,\n  onShowProjectShowcase,\n  onImportProject,\n  onDuplicateProject,\n  isAdminMode = false,\n  tourContext = null\n}) => {\n  const normalizedFilters = useMemo(\n    () => normalizeProjectFilterConfig(projectFilters),\n    [projectFilters]\n  );\n  const [filtersState, setFiltersState] = useState(() => buildInitialFiltersState(normalizedFilters));\n  const normalizedInspirationFilters = useMemo(\n    () => normalizeInspirationFiltersConfig(inspirationFilters),\n    [inspirationFilters]\n  );\n  const [inspirationFiltersState, setInspirationFiltersState] = useState(() =>\n    buildInitialFiltersState(normalizedInspirationFilters)\n  );\n  const fileInputRef = useRef(null);\n  const [deleteDialogState, setDeleteDialogState] = useState(() => ({\n    isOpen: false,\n    project: null\n  }));\n  const deleteCancelButtonRef = useRef(null);\n  const deleteConfirmButtonRef = useRef(null);\n  const previouslyFocusedElementRef = useRef(null);\n\n  const closeDeleteDialog = useCallback(() => {\n    setDeleteDialogState({ isOpen: false, project: null });\n  }, []);\n\n  const handleCancelDeleteProject = useCallback(() => {\n    closeDeleteDialog();\n  }, [closeDeleteDialog]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    let selector = null;\n\n    if (activeStep === 'create-project') {\n      selector = '[data-tour-id=\"home-create-project\"]';\n    } else if (activeStep === 'project-import') {\n      selector = '[data-tour-id=\"home-import-project\"]';\n    } else if (activeStep === 'project-filters') {\n      selector = '[data-tour-id=\"home-filters\"]';\n    }\n\n    if (selector) {\n      const element = document.querySelector(selector);\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      }\n    }\n  }, [tourContext]);\n\n  const handleRequestProjectDeletion = useCallback((project) => {\n    if (!project || !project.id || typeof onDeleteProject !== 'function') {\n      return;\n    }\n\n    if (typeof document !== 'undefined' && document.activeElement instanceof HTMLElement) {\n      previouslyFocusedElementRef.current = document.activeElement;\n    } else {\n      previouslyFocusedElementRef.current = null;\n    }\n\n    setDeleteDialogState({\n      isOpen: true,\n      project\n    });\n  }, [onDeleteProject]);\n\n  const handleConfirmDeleteProject = useCallback(() => {\n    if (!deleteDialogState.project || typeof onDeleteProject !== 'function') {\n      closeDeleteDialog();\n      return;\n    }\n\n    onDeleteProject(deleteDialogState.project.id);\n    closeDeleteDialog();\n  }, [closeDeleteDialog, deleteDialogState.project, onDeleteProject]);\n\n  useEffect(() => {\n    if (!deleteDialogState.isOpen) {\n      if (\n        previouslyFocusedElementRef.current &&\n        typeof previouslyFocusedElementRef.current.focus === 'function'\n      ) {\n        const shouldRestoreFocus =\n          typeof document === 'undefined' ||\n          document.contains(previouslyFocusedElementRef.current);\n\n        if (shouldRestoreFocus) {\n          previouslyFocusedElementRef.current.focus();\n        }\n\n        previouslyFocusedElementRef.current = null;\n      }\n      return undefined;\n    }\n\n    const timeoutId = typeof window !== 'undefined'\n      ? window.setTimeout(() => {\n        if (deleteCancelButtonRef.current && typeof deleteCancelButtonRef.current.focus === 'function') {\n          deleteCancelButtonRef.current.focus();\n        }\n      }, 0)\n      : null;\n\n    const handleKeyDown = (event) => {\n      if (event.key === 'Escape') {\n        event.preventDefault();\n        handleCancelDeleteProject();\n        return;\n      }\n\n      if (event.key === 'Tab') {\n        const focusableElements = [deleteCancelButtonRef.current, deleteConfirmButtonRef.current].filter(\n          (element) => element && typeof element.focus === 'function'\n        );\n\n        if (focusableElements.length === 0) {\n          return;\n        }\n\n        const activeElement = typeof document !== 'undefined' ? document.activeElement : null;\n        const currentIndex = focusableElements.indexOf(activeElement);\n        let nextIndex = currentIndex;\n\n        if (event.shiftKey) {\n          nextIndex = currentIndex <= 0 ? focusableElements.length - 1 : currentIndex - 1;\n        } else {\n          nextIndex = currentIndex === focusableElements.length - 1 ? 0 : currentIndex + 1;\n        }\n\n        event.preventDefault();\n        focusableElements[nextIndex]?.focus();\n      }\n    };\n\n    if (typeof document !== 'undefined') {\n      document.addEventListener('keydown', handleKeyDown);\n    }\n\n    return () => {\n      if (typeof document !== 'undefined') {\n        document.removeEventListener('keydown', handleKeyDown);\n      }\n      if (timeoutId !== null && typeof window !== 'undefined') {\n        window.clearTimeout(timeoutId);\n      }\n    };\n  }, [deleteDialogState.isOpen, handleCancelDeleteProject]);\n\n  useEffect(() => {\n    setFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      if (typeof prevState.sortOrder === 'undefined') {\n        nextState.sortOrder = initialState.sortOrder;\n        changed = true;\n      }\n      if (typeof prevState.sortOrderDefault === 'undefined') {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      if (prevState.sortOrder === prevState.sortOrderDefault) {\n        if (prevState.sortOrder !== initialState.sortOrder) {\n          nextState.sortOrder = initialState.sortOrder;\n          changed = true;\n        }\n      }\n      if (prevState.sortOrderDefault !== initialState.sortOrderDefault) {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      normalizedFilters.fields.forEach((field) => {\n        if (!field || field.id === 'dateOrder') {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = '';\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== '') {\n            nextState[field.id] = '';\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        if (key === 'sortOrder' || key === 'sortOrderDefault') {\n          return;\n        }\n\n        const stillExists = normalizedFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedFilters]);\n\n  useEffect(() => {\n    setInspirationFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedInspirationFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      normalizedInspirationFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_TEXT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        const stillExists = normalizedInspirationFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedInspirationFilters]);\n\n  const selectFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (field.id === 'teamLeadTeam' && Array.isArray(teamLeadOptions)) {\n        teamLeadOptions.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      projects.forEach((project) => {\n        const value = getProjectFilterValue(field, project).trim();\n        if (value.length > 0) {\n          options.add(value);\n        }\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [normalizedFilters.fields, projects, teamLeadOptions]);\n\n  const inspirationFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields) ? normalizedInspirationFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      inspirationProjects.forEach((project) => {\n        const values = normalizeInspirationFieldValues(project?.[field.id]);\n        values.forEach((value) => {\n          if (value.length > 0) {\n            options.add(value);\n          }\n        });\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [normalizedInspirationFilters.fields, inspirationProjects]);\n\n  const filteredProjects = useMemo(() => {\n    if (!Array.isArray(projects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    const selection = projects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled || field.id === 'dateOrder') {\n          continue;\n        }\n\n        const value = filtersState[field.id];\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            const projectValue = getProjectFilterValue(field, project);\n            if (projectValue !== value) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const projectValue = getProjectFilterValue(field, project);\n        if (projectValue.toLowerCase().indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n\n    const sortField = activeFields.find((field) => field && field.id === 'dateOrder');\n    const selectedOrder = filtersState.sortOrder || sortField?.defaultValue || 'desc';\n    const direction = selectedOrder === 'asc' ? 'asc' : 'desc';\n\n    return selection.slice().sort((a, b) => {\n      const timeA = getProjectTimestamp(a);\n      const timeB = getProjectTimestamp(b);\n      const diff = timeA - timeB;\n\n      return direction === 'asc' ? diff : -diff;\n    });\n  }, [projects, normalizedFilters, filtersState]);\n\n  const filteredInspirationProjects = useMemo(() => {\n    if (!Array.isArray(inspirationProjects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    return inspirationProjects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled) {\n          continue;\n        }\n\n        const value = inspirationFiltersState[field.id];\n        const projectValues = normalizeInspirationFieldValues(project?.[field.id]);\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            if (!projectValues.includes(value)) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const haystack = projectValues.join(' ').toLowerCase();\n        if (haystack.indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n  }, [inspirationProjects, normalizedInspirationFilters.fields, inspirationFiltersState]);\n  const projectRows = useMemo(() => {\n    const rows = [];\n    for (let index = 0; index < filteredProjects.length; index += 2) {\n      rows.push(filteredProjects.slice(index, index + 2));\n    }\n    return rows;\n  }, [filteredProjects]);\n  const shouldVirtualizeProjects = projectRows.length > 6;\n\n  const hasProjects = projects.length > 0;\n  const hasFilteredProjects = filteredProjects.length > 0;\n  const hasInspirationProjects = inspirationProjects.length > 0;\n  const hasFilteredInspirationProjects = filteredInspirationProjects.length > 0;\n  const pendingDeletionProjectName = useMemo(() => {\n    if (!deleteDialogState.project) {\n      return '';\n    }\n\n    const directName = getSafeString(deleteDialogState.project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    const answerName = getSafeString(deleteDialogState.project.answers?.projectName);\n    if (answerName.trim().length > 0) {\n      return answerName;\n    }\n\n    return 'Projet sans nom';\n  }, [deleteDialogState.project]);\n\n  const hasActiveFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      if (field.id === 'dateOrder') {\n        if (filtersState.sortOrder !== filtersState.sortOrderDefault) {\n          return true;\n        }\n        continue;\n      }\n\n      const value = filtersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedFilters, filtersState]);\n\n  const hasActiveInspirationFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      const value = inspirationFiltersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedInspirationFilters.fields, inspirationFiltersState]);\n\n  const displayedProjectsCount = filteredProjects.length;\n  const totalProjectsCount = projects.length;\n  const sortFilterConfig = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.find(field => field && field.id === 'dateOrder')\n    : null;\n  const enabledFilterFields = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.filter(field => field && field.enabled && field.id !== 'dateOrder')\n    : [];\n  const shouldShowFiltersCard = hasProjects && (enabledFilterFields.length > 0 || (sortFilterConfig && sortFilterConfig.enabled));\n  const currentSortOrder = filtersState.sortOrder || sortFilterConfig?.defaultValue || 'desc';\n  const inspirationFilterFields = Array.isArray(normalizedInspirationFilters.fields)\n    ? normalizedInspirationFilters.fields.filter((field) => field && field.enabled)\n    : [];\n  const shouldShowInspirationFiltersCard = hasInspirationProjects && inspirationFilterFields.length > 0;\n\n  const handleResetFilters = () => {\n    setFiltersState(buildInitialFiltersState(normalizedFilters));\n  };\n\n  const handleResetInspirationFilters = () => {\n    setInspirationFiltersState(buildInitialFiltersState(normalizedInspirationFilters));\n  };\n\n  const handleTriggerImport = () => {\n    if (fileInputRef.current) {\n      fileInputRef.current.click();\n    }\n  };\n\n  const handleFileChange = (event) => {\n    const file = event?.target?.files?.[0];\n    if (file && typeof onImportProject === 'function') {\n      onImportProject(file);\n    }\n\n    if (event?.target) {\n      event.target.value = '';\n    }\n  };\n\n  const renderProjectCard = (project) => {\n    const complexity = project.analysis?.complexity;\n    const risksCount = project.analysis?.risks?.length ?? 0;\n    const projectStatus = statusStyles[project.status] || statusStyles.submitted;\n    const remainingQuestions = computeRemainingQuestions(project);\n    const isDraft = project.status === 'draft';\n    const adminCanEditSubmitted = isAdminMode && !isDraft;\n    const leadName = getSafeString(project?.answers?.teamLead).trim();\n    const leadTeam = getSafeString(project?.answers?.teamLeadTeam).trim();\n    const leadDisplay = leadName.length > 0\n      ? `${leadName}${leadTeam.length > 0 ? ` (${leadTeam})` : ''}`\n      : leadTeam.length > 0\n        ? `(${leadTeam})`\n        : 'Lead du projet non renseigné';\n    const projectTypeRaw = project?.answers?.ProjectType;\n    const projectType = Array.isArray(projectTypeRaw)\n      ? projectTypeRaw\n          .map(item => (typeof item === 'string' ? item.trim() : ''))\n          .filter(item => item.length > 0)\n          .join(', ')\n      : getSafeString(projectTypeRaw).trim();\n    const projectTypeDisplay = projectType.length > 0\n      ? projectType\n      : 'Type de projet non renseigné';\n\n    return (\n      <article\n        key={project.id}\n        className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n        role=\"listitem\"\n        aria-label={`Projet ${project.projectName || 'sans nom'}`}\n      >\n        <div className=\"flex items-start justify-between gap-4\">\n          <div>\n            <h3 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2 flex-wrap\">\n              <span>{project.projectName || 'Projet sans nom'}</span>\n              {project.isDemo && (\n                <span className=\"inline-flex items-center px-2 py-0.5 text-xs font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full\">\n                  Projet démo\n                </span>\n              )}\n            </h3>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              Dernière mise à jour : {formatDate(project.lastUpdated || project.submittedAt)}\n            </p>\n          </div>\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex flex-col items-end gap-2\">\n              <span\n                className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${projectStatus.className}`.trim()}\n              >\n                {projectStatus.label}\n              </span>\n              {complexity && (\n                <span className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${complexityColors[complexity] || 'text-blue-600'}`}>\n                  {complexity}\n                </span>\n              )}\n            </div>\n            {typeof onDuplicateProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => onDuplicateProject(project.id)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-blue-200 text-blue-600 hover:bg-blue-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Dupliquer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Dupliquer le projet\"\n              >\n                <Copy className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n            {isDraft && typeof onDeleteProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => handleRequestProjectDeletion(project)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Supprimer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Supprimer le projet\"\n              >\n                <Trash2 className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n          </div>\n        </div>\n\n        <dl className=\"mt-4 grid grid-cols-1 gap-3 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"w-4 h-4\" />\n            <span className=\"font-medium text-gray-700\">{leadDisplay}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{projectTypeDisplay}</span>\n          </div>\n          {remainingQuestions !== null && (\n            <div className=\"flex items-center gap-2\">\n              <Save className=\"w-4 h-4\" />\n              <span>\n                {remainingQuestions === 0\n                  ? 'Aucune question restante'\n                  : `${remainingQuestions} question${remainingQuestions > 1 ? 's' : ''} restante${remainingQuestions > 1 ? 's' : ''}`}\n              </span>\n            </div>\n          )}\n          <div className=\"flex items-center gap-2\">\n            <AlertTriangle className=\"w-4 h-4\" />\n            <span>{risksCount} risque{risksCount > 1 ? 's' : ''} identifié{risksCount > 1 ? 's' : ''}</span>\n          </div>\n        </dl>\n\n        <div className=\"mt-6 flex flex-wrap gap-3\">\n          <button\n            type=\"button\"\n            onClick={() => {\n              if (isDraft) {\n                onOpenProject(project.id);\n                return;\n              }\n\n              if (adminCanEditSubmitted) {\n                onOpenProject(project.id, { view: 'questionnaire' });\n                return;\n              }\n\n              onOpenProject(project.id);\n            }}\n            className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button ${\n              isDraft || adminCanEditSubmitted\n                ? 'hv-button-draft text-white'\n                : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n            }`}\n          >\n            {isDraft ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Continuer l'édition</span>\n              </>\n            ) : adminCanEditSubmitted ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Modifier le projet</span>\n              </>\n            ) : (\n              <>\n                <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Consulter la synthèse</span>\n              </>\n            )}\n          </button>\n          {adminCanEditSubmitted && (\n            <button\n              type=\"button\"\n              onClick={() => onOpenProject(project.id, { view: 'synthesis' })}\n              className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n            >\n              <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n              <span>Consulter la synthèse</span>\n            </button>\n          )}\n          {onShowProjectShowcase && (\n            <button\n              type=\"button\"\n              onClick={() => onShowProjectShowcase(project.id)}\n              className=\"inline-flex items-center px-4 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all hv-button hv-focus-ring\"\n            >\n              <Sparkles className=\"w-4 h-4 mr-2\" /> Vitrine du projet\n            </button>\n          )}\n        </div>\n      </article>\n    );\n  };\n\n  const renderInspirationCard = (project) => (\n    <article\n      key={project.id}\n      className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n      role=\"listitem\"\n      aria-label={`Projet inspirant ${project.title || 'sans titre'}`}\n    >\n      <div className=\"space-y-3\">\n        <div>\n          <h3 className=\"text-xl font-semibold text-gray-900\">{project.title || 'Projet sans titre'}</h3>\n          <p className=\"text-sm text-gray-500\">{project.labName || 'Laboratoire non renseigné'}</p>\n        </div>\n        <dl className=\"grid grid-cols-1 gap-2 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Compass className=\"w-4 h-4\" />\n            <span>{project.country || 'Pays non renseigné'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{project.target || 'Cible non renseignée'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Sparkles className=\"w-4 h-4\" />\n            <span>{project.therapeuticArea || 'Aire thérapeutique non renseignée'}</span>\n          </div>\n        </dl>\n      </div>\n      <div className=\"mt-5 flex flex-wrap gap-3\">\n        <button\n          type=\"button\"\n          onClick={() => onOpenInspirationProject?.(project.id)}\n          className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n        >\n          <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n          <span>Fiche complète</span>\n        </button>\n      </div>\n    </article>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8 hv-background\">\n      <div className=\"max-w-6xl mx-auto space-y-12\">\n        <header className=\"bg-white border border-blue-100 rounded-3xl shadow-xl p-6 sm:p-10 hv-surface\" role=\"banner\">\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6\">\n            <div className=\"space-y-4\">\n              <span className=\"inline-flex items-center px-3 py-1 text-sm font-semibold text-blue-700 bg-blue-100 rounded-full border border-blue-200\">\n                <Target className=\"w-4 h-4 mr-2\" /> Votre copilote compliance\n              </span>\n              <h1 className=\"text-3xl sm:text-4xl font-bold text-gray-900 leading-tight\">\n                Anticipez les besoins compliance de vos projets en quelques minutes\n              </h1>\n              <p className=\"text-lg text-gray-600 leading-relaxed max-w-2xl\">\n                Project Navigator vous guide pas à pas pour qualifier votre initiative, identifier les interlocuteurs à mobiliser et sécuriser vos délais réglementaires.\n              </p>\n              <div className=\"flex flex-col sm:flex-row gap-3\" role=\"group\" aria-label=\"Actions principales\">\n                <button\n                  type=\"button\"\n                  onClick={onStartNewProject}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-xl shadow-md transition-all hv-button hv-button-primary\"\n                  data-tour-id=\"home-create-project\"\n                >\n                  <Plus className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>Créer un nouveau</span>\n                    <span>projet</span>\n                  </span>\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleTriggerImport}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-blue-600 bg-white hover:bg-blue-50 rounded-xl border border-blue-200 transition-all hv-button hv-focus-ring\"\n                  data-tour-id=\"home-import-project\"\n                >\n                  <Upload className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>Charger</span>\n                    <span>un projet</span>\n                  </span>\n                </button>\n              </div>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\"application/json\"\n                onChange={handleFileChange}\n                className=\"hidden\"\n                tabIndex={-1}\n                aria-hidden=\"true\"\n              />\n            </div>\n            <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 text-sm text-gray-600\">\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Rocket className=\"w-5 h-5 mr-2\" /> Démarrez simplement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Un questionnaire dynamique pour cadrer votre projet et qualifier les impacts compliance.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Compass className=\"w-5 h-5 mr-2\" /> Visualisez la feuille de route\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Une synthèse claire avec le niveau de complexité, les équipes à mobiliser et les délais recommandés.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Users className=\"w-5 h-5 mr-2\" /> Collaborez efficacement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Partagez la synthèse avec les parties prenantes pour sécuriser vos points de passage.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Calendar className=\"w-5 h-5 mr-2\" /> Gardez une trace\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Retrouvez à tout moment les projets déjà soumis et mettez-les à jour si nécessaire.\n                </p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        <section aria-labelledby=\"projects-heading\" className=\"space-y-6\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div>\n              <h2 id=\"projects-heading\" className=\"text-2xl font-bold text-gray-900\">\n                {homeView === 'inspiration' ? 'Projets inspirants' : 'Vos projets enregistrés'}\n              </h2>\n              <p className=\"text-sm text-gray-600\">\n                {homeView === 'inspiration'\n                  ? 'Découvrez les initiatives d’autres laboratoires et gérez vos projets inspirants.'\n                  : 'Accédez aux brouillons et aux synthèses finalisées pour les reprendre à tout moment.'}\n              </p>\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n              <div\n                className=\"inline-flex items-center rounded-full border border-blue-200 bg-blue-50 p-1\"\n                role=\"group\"\n                aria-label=\"Sélection du bloc projet\"\n              >\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('platform')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView !== 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Projets LFB\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('inspiration')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView === 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Inspiration\n                </button>\n              </div>\n              {homeView === 'inspiration' ? (\n                <button\n                  type=\"button\"\n                  onClick={onStartInspirationProject}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n                >\n                  <Plus className=\"w-4 h-4\" aria-hidden=\"true\" />\n                  Ajouter un projet inspirant\n                </button>\n              ) : (\n                <span className=\"inline-flex items-center text-sm font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full px-3 py-1\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" /> {displayedProjectsCount} projet{displayedProjectsCount > 1 ? 's' : ''}\n                  {hasActiveFilters ? ` sur ${totalProjectsCount}` : ''}\n                </span>\n              )}\n            </div>\n          </div>\n\n          {homeView !== 'inspiration' && !hasProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet enregistré pour le moment.</p>\n              <p className=\"mt-2\">Lancez-vous dès maintenant pour préparer votre première synthèse compliance.</p>\n              <button\n                type=\"button\"\n                onClick={onStartNewProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> Créer un projet\n              </button>\n            </div>\n          )}\n\n          {homeView !== 'inspiration' && hasProjects && (\n            <>\n              {shouldShowFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets\"\n                  data-tour-id=\"home-filters\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres disponibles\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveFilters}\n                    >\n                      Réinitialiser\n                    </button>\n                  </div>\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                    {enabledFilterFields.map((field) => {\n                      const fieldId = `project-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = filtersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = selectFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof filtersState[field.id] === 'string' ? filtersState[field.id] : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                    {sortFilterConfig && sortFilterConfig.enabled && (\n                      <div className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                        <label htmlFor=\"project-sort-order\" className=\"font-semibold text-gray-700\">\n                          {sortFilterConfig.label}\n                        </label>\n                        <select\n                          id=\"project-sort-order\"\n                          value={currentSortOrder}\n                          onChange={(event) =>\n                            setFiltersState(prev => ({\n                              ...prev,\n                              sortOrder: event.target.value === 'asc' ? 'asc' : 'desc'\n                            }))\n                          }\n                          className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        >\n                          <option value=\"desc\">{SORT_LABELS.desc}</option>\n                          <option value=\"asc\">{SORT_LABELS.asc}</option>\n                        </select>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredProjects ? (\n                shouldVirtualizeProjects ? (\n                  <VirtualizedList\n                    items={projectRows}\n                    itemKey={(_row, index) => `project-row-${index}`}\n                    estimatedItemHeight={420}\n                    overscan={3}\n                    role=\"list\"\n                    className=\"relative\"\n                    renderItem={(row) => (\n                      <div className=\"pb-6\">\n                        <div className=\"flex flex-col md:flex-row gap-6\">\n                          {row.map(project => renderProjectCard(project))}\n                        </div>\n                      </div>\n                    )}\n                  />\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                    {filteredProjects.map(project => renderProjectCard(project))}\n                  </div>\n                )\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond à vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critères ou réinitialisez les filtres pour afficher tous les projets.</p>\n                  {hasActiveFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Réinitialiser les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n\n          {homeView === 'inspiration' && !hasInspirationProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet inspirant enregistré.</p>\n              <p className=\"mt-2\">Ajoutez des exemples pour nourrir vos réflexions.</p>\n              <button\n                type=\"button\"\n                onClick={onStartInspirationProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> Créer un projet inspirant\n              </button>\n            </div>\n          )}\n\n          {homeView === 'inspiration' && hasInspirationProjects && (\n            <>\n              {shouldShowInspirationFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets inspirants\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres Inspiration\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveInspirationFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveInspirationFilters}\n                    >\n                      Réinitialiser\n                    </button>\n                  </div>\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5\">\n                    {inspirationFilterFields.map((field) => {\n                      const fieldId = `inspiration-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = inspirationFiltersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = inspirationFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof inspirationFiltersState[field.id] === 'string'\n                        ? inspirationFiltersState[field.id]\n                        : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredInspirationProjects ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                  {filteredInspirationProjects.map(project => renderInspirationCard(project))}\n                </div>\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond à vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critères ou réinitialisez les filtres.</p>\n                  {hasActiveInspirationFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Réinitialiser les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n        </section>\n      </div>\n      {deleteDialogState.isOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div\n            className=\"absolute inset-0 bg-gray-900 bg-opacity-60\"\n            aria-hidden=\"true\"\n            onClick={handleCancelDeleteProject}\n          />\n          <div\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby=\"delete-project-dialog-title\"\n            aria-describedby=\"delete-project-dialog-description\"\n            className=\"relative z-10 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl focus:outline-none hv-surface\"\n          >\n            <div className=\"flex items-start gap-3\">\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600\">\n                <Trash2 className=\"h-6 w-6\" aria-hidden=\"true\" />\n              </div>\n              <div>\n                <h2 id=\"delete-project-dialog-title\" className=\"text-xl font-semibold text-gray-900\">\n                  Supprimer le projet ?\n                </h2>\n                <p id=\"delete-project-dialog-description\" className=\"mt-2 text-sm text-gray-600\">\n                  Vous êtes sur le point de supprimer « {pendingDeletionProjectName || 'Projet sans nom'} ». Cette action est\n                  définitive et le projet ne pourra pas être restauré.\n                </p>\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end sm:gap-3\">\n              <button\n                type=\"button\"\n                ref={deleteCancelButtonRef}\n                onClick={handleCancelDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors hv-button hv-focus-ring\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                ref={deleteConfirmButtonRef}\n                onClick={handleConfirmDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-red-200 bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition-colors hv-button hv-button-danger\"\n              >\n                Supprimer définitivement\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/QuestionnaireScreen.jsx": "import React, { useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  Info,\n  Calendar,\n  CheckCircle,\n  ChevronLeft,\n  ChevronRight,\n  AlertTriangle,\n  Save,\n  Plus,\n  Trash2\n} from './icons.js';\nimport { formatAnswer } from '../utils/questions.js';\nimport { normalizeConditionGroups } from '../utils/conditionGroups.js';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\nimport { normalizeRankingConfig } from '../utils/ranking.js';\n\nconst OPERATOR_LABELS = {\n  equals: 'est égal à',\n  not_equals: 'est différent de',\n  contains: 'contient',\n  lt: 'est inférieur à',\n  lte: 'est inférieur ou égal à',\n  gt: 'est supérieur à',\n  gte: 'est supérieur ou égal à'\n};\n\nconst normalizeMilestoneDrafts = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value.map(item => ({\n    date: typeof item?.date === 'string' ? item.date : '',\n    description: typeof item?.description === 'string' ? item.description : ''\n  }));\n};\n\nconst isMilestoneDraftEmpty = (entry) => {\n  const date = typeof entry?.date === 'string' ? entry.date.trim() : '';\n  const description = typeof entry?.description === 'string' ? entry.description.trim() : '';\n\n  return date.length === 0 && description.length === 0;\n};\n\nconst areMilestoneDraftsEqual = (first, second) => {\n  if (!Array.isArray(first) || !Array.isArray(second)) {\n    return false;\n  }\n\n  if (first.length !== second.length) {\n    return false;\n  }\n\n  return first.every((entry, index) => {\n    const counterpart = second[index];\n\n    if (!counterpart) {\n      return false;\n    }\n\n    const entryDate = typeof entry?.date === 'string' ? entry.date : '';\n    const entryDescription = typeof entry?.description === 'string' ? entry.description : '';\n    const counterpartDate = typeof counterpart?.date === 'string' ? counterpart.date : '';\n    const counterpartDescription =\n      typeof counterpart?.description === 'string' ? counterpart.description : '';\n\n    return entryDate === counterpartDate && entryDescription === counterpartDescription;\n  });\n};\n\nconst sanitizeMilestonesForAnswer = (drafts) => {\n  if (!Array.isArray(drafts)) {\n    return [];\n  }\n\n  return drafts\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0);\n};\n\nexport const QuestionnaireScreen = ({\n  questions,\n  currentIndex,\n  answers,\n  onAnswer,\n  onNext,\n  onBack,\n  allQuestions,\n  onNavigateToQuestion,\n  onSaveDraft,\n  saveFeedback,\n  onDismissSaveFeedback,\n  validationError,\n  tourContext = null,\n  onReturnToSynthesis,\n  isReturnToSynthesisRequested = false,\n  onFinish\n}) => {\n  const currentQuestion = questions[currentIndex];\n  const questionBank = allQuestions || questions;\n\n  if (!currentQuestion) {\n    return null;\n  }\n\n  const progress = ((currentIndex + 1) / questions.length) * 100;\n  const remainingQuestions = Math.max(questions.length - (currentIndex + 1), 0);\n  const remainingLabel = remainingQuestions === 0\n    ? 'Aucune question restante'\n    : `${remainingQuestions} question${remainingQuestions > 1 ? 's' : ''} restante${remainingQuestions > 1 ? 's' : ''}`;\n  const questionType = currentQuestion.type || 'choice';\n  const currentAnswer = answers[currentQuestion.id];\n  const multiSelection = Array.isArray(currentAnswer) ? currentAnswer : [];\n  const rankingConfig = useMemo(\n    () => normalizeRankingConfig(currentQuestion.rankingConfig || {}),\n    [currentQuestion.rankingConfig]\n  );\n  const rankingAnswer = useMemo(() => {\n    const rawPrioritized = Array.isArray(currentAnswer?.prioritized) ? currentAnswer.prioritized : [];\n    const rawIgnored = Array.isArray(currentAnswer?.ignored) ? currentAnswer.ignored : [];\n\n    const validCriteria = rankingConfig.criteria.map(item => item.id);\n    const prioritized = rawPrioritized.filter(id => validCriteria.includes(id));\n    const ignored = rawIgnored.filter(id => validCriteria.includes(id));\n\n    return {\n      prioritized,\n      ignored\n    };\n  }, [currentAnswer, rankingConfig]);\n  const [showGuidance, setShowGuidance] = useState(false);\n  const [milestoneDrafts, setMilestoneDrafts] = useState(() => normalizeMilestoneDrafts(currentAnswer));\n  const milestoneQuestionIdRef = useRef(questionType === 'milestone_list' ? currentQuestion.id : null);\n  const questionTextId = `question-${currentQuestion.id}`;\n  const instructionsId = `instructions-${currentQuestion.id}`;\n  const guidancePanelId = `guidance-${currentQuestion.id}`;\n  const progressLabelId = `progress-label-${currentQuestion.id}`;\n  const hasValidationError = validationError?.questionId === currentQuestion.id;\n  const hasSaveFeedback = Boolean(saveFeedback?.message);\n  const isSaveSuccess = saveFeedback?.status === 'success';\n  const relatedQuestionEntries = useMemo(() => {\n    if (!isReturnToSynthesisRequested) {\n      return [];\n    }\n\n    const currentQuestionId = currentQuestion.id;\n\n    return questions\n      .map((question, index) => ({ question, index }))\n      .filter(({ question }) => question?.id && question.id !== currentQuestionId)\n      .filter(({ question }) => normalizeConditionGroups(question).some(group =>\n        group.conditions.some(condition => condition.question === currentQuestionId)\n      ))\n      .filter(({ index }) => index > currentIndex);\n  }, [currentIndex, currentQuestion.id, isReturnToSynthesisRequested, questions]);\n  const hasLinkedQuestions = relatedQuestionEntries.length > 0;\n  const nextLinkedQuestion = relatedQuestionEntries[0]?.question || null;\n  const shouldShowNextButton = !isReturnToSynthesisRequested || hasLinkedQuestions;\n  const shouldShowFinishButton = !isReturnToSynthesisRequested || hasLinkedQuestions;\n  const handleLinkedQuestionNext = () => {\n    if (nextLinkedQuestion && typeof onNavigateToQuestion === 'function') {\n      onNavigateToQuestion(nextLinkedQuestion.id);\n      return;\n    }\n\n    onNext();\n  };\n\n  useEffect(() => {\n    setShowGuidance(false);\n  }, [currentQuestion.id]);\n\n  useEffect(() => {\n    if (questionType !== 'milestone_list') {\n      milestoneQuestionIdRef.current = null;\n      setMilestoneDrafts([]);\n      return;\n    }\n\n    const normalizedAnswer = normalizeMilestoneDrafts(currentAnswer);\n    const previousQuestionId = milestoneQuestionIdRef.current;\n    milestoneQuestionIdRef.current = currentQuestion.id;\n\n    setMilestoneDrafts(previousDrafts => {\n      if (previousQuestionId !== currentQuestion.id) {\n        return normalizedAnswer;\n      }\n\n      if (\n        normalizedAnswer.length === 0 &&\n        Array.isArray(previousDrafts) &&\n        previousDrafts.length > 0 &&\n        previousDrafts.every(isMilestoneDraftEmpty)\n      ) {\n        return previousDrafts;\n      }\n\n      const normalizedPreviousDrafts = normalizeMilestoneDrafts(previousDrafts);\n\n      if (\n        normalizedPreviousDrafts.length > normalizedAnswer.length &&\n        areMilestoneDraftsEqual(\n          sanitizeMilestonesForAnswer(normalizedPreviousDrafts),\n          normalizedAnswer\n        )\n      ) {\n        return previousDrafts;\n      }\n\n      if (areMilestoneDraftsEqual(normalizedPreviousDrafts, normalizedAnswer)) {\n        return previousDrafts;\n      }\n\n      return normalizedAnswer;\n    });\n  }, [currentAnswer, currentQuestion.id, questionType]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (tourContext.activeStep === 'question-guidance') {\n      setShowGuidance(true);\n    } else if (tourContext.activeStep !== 'question-guidance' && showGuidance) {\n      setShowGuidance(false);\n    }\n  }, [tourContext, showGuidance]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    let selector = null;\n\n    if (activeStep === 'question-guidance') {\n      selector = '[data-tour-id=\"question-guidance-toggle\"]';\n    } else if (activeStep === 'question-save') {\n      selector = '[data-tour-id=\"question-save-draft\"]';\n    }\n\n    if (selector) {\n      const element = document.querySelector(selector);\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      }\n    }\n  }, [tourContext]);\n\n  const guidance = currentQuestion.guidance || {};\n  const guidanceTips = useMemo(() => (\n    Array.isArray(guidance.tips)\n      ? guidance.tips.filter(tip => typeof tip === 'string' && tip.trim() !== '')\n      : []\n  ), [guidance]);\n\n  const conditionSummaries = useMemo(() => {\n    const conditionGroups = normalizeConditionGroups(currentQuestion);\n    return conditionGroups.map((group, groupIdx) => {\n      const logic = group.logic === 'any' ? 'any' : 'all';\n      const conditions = (group.conditions || []).map(condition => {\n        const referenceQuestion = questionBank.find(q => q.id === condition.question);\n        const label = referenceQuestion?.question || `Question ${condition.question}`;\n        const formattedAnswer = formatAnswer(referenceQuestion, answers[condition.question]);\n\n        return {\n          label,\n          operator: OPERATOR_LABELS[condition.operator] || condition.operator,\n          value: condition.value,\n          answer: formattedAnswer\n        };\n      });\n\n      return {\n        logic,\n        conditions,\n        groupIdx\n      };\n    });\n  }, [answers, currentQuestion, questionBank]);\n\n  const hasConditions = useMemo(\n    () => conditionSummaries.some(summary => summary.conditions.length > 0),\n    [conditionSummaries]\n  );\n\n  const hasGuidanceContent = useMemo(() => {\n    const hasObjective = typeof guidance.objective === 'string' && guidance.objective.trim() !== '';\n    const hasDetails = typeof guidance.details === 'string' && guidance.details.trim() !== '';\n\n    return hasObjective || hasDetails || guidanceTips.length > 0 || hasConditions;\n  }, [guidance, guidanceTips, hasConditions]);\n\n  const rankingPrioritized = useMemo(() => {\n    if (questionType !== 'ranking') {\n      return [];\n    }\n\n    const defaultOrder = rankingConfig.criteria.map(item => item.id);\n    return rankingAnswer.prioritized.length > 0 ? rankingAnswer.prioritized : defaultOrder;\n  }, [questionType, rankingAnswer.prioritized, rankingConfig.criteria]);\n\n  const rankingIgnoredSet = useMemo(() => new Set(questionType === 'ranking' ? rankingAnswer.ignored : []), [questionType, rankingAnswer.ignored]);\n\n  const handleRankingMove = (criterionId, direction) => {\n    const currentOrder = rankingPrioritized;\n    const currentIndex = currentOrder.indexOf(criterionId);\n    if (currentIndex === -1) return;\n\n    const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;\n    if (targetIndex < 0 || targetIndex >= currentOrder.length) return;\n\n    const nextOrder = [...currentOrder];\n    const [moved] = nextOrder.splice(currentIndex, 1);\n    nextOrder.splice(targetIndex, 0, moved);\n\n    onAnswer(currentQuestion.id, {\n      prioritized: nextOrder,\n      ignored: rankingAnswer.ignored\n    });\n  };\n\n  const handleRankingToggleIgnored = (criterionId) => {\n    const isIgnored = rankingIgnoredSet.has(criterionId);\n    const nextIgnored = isIgnored\n      ? rankingAnswer.ignored.filter(id => id !== criterionId)\n      : [...rankingAnswer.ignored, criterionId];\n\n    const nextPrioritized = isIgnored\n      ? (rankingAnswer.prioritized.length > 0\n        ? rankingAnswer.prioritized\n        : rankingConfig.criteria.map(item => item.id))\n      : rankingPrioritized.filter(id => id !== criterionId);\n\n    if (!isIgnored && nextPrioritized.length === 0) {\n      nextPrioritized.push(...rankingConfig.criteria.map(item => item.id).filter(id => id !== criterionId));\n    }\n\n    onAnswer(currentQuestion.id, {\n      prioritized: nextPrioritized,\n      ignored: nextIgnored\n    });\n  };\n\n  const handleRankingReset = () => {\n    const defaultOrder = rankingConfig.criteria.map(item => item.id);\n    onAnswer(currentQuestion.id, { prioritized: defaultOrder, ignored: [] });\n  };\n\n  const renderQuestionInput = () => {\n    switch (questionType) {\n      case 'date':\n        return (\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-date`}>\n              <span className=\"flex items-center\">\n                <Calendar className=\"w-4 h-4 mr-2\" />\n                Sélectionnez une date\n              </span>\n            </label>\n            <input\n              type=\"date\"\n              value={currentAnswer ?? ''}\n              onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n              id={`${currentQuestion.id}-date`}\n              aria-describedby={currentIndex === 0 ? instructionsId : undefined}\n              className=\"w-full px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Utilisez le sélecteur ou le format AAAA-MM-JJ pour garantir une analyse correcte.\n            </p>\n          </div>\n        );\n      case 'choice':\n        return (\n          <fieldset className=\"space-y-3 mb-8\" aria-describedby={currentIndex === 0 ? instructionsId : undefined}>\n            <legend className=\"sr-only\">{currentQuestion.question}</legend>\n            {currentQuestion.options.map((option, idx) => {\n              const isSelected = answers[currentQuestion.id] === option;\n              const optionId = `${currentQuestion.id}-option-${idx}`;\n\n              return (\n                <label\n                  key={idx}\n                  htmlFor={optionId}\n                  className={`w-full p-3 sm:p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between rounded-xl border-2 transition-all duration-200 cursor-pointer hv-focus-ring ${\n                    isSelected\n                      ? 'border-blue-600 bg-blue-50 text-blue-900'\n                      : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'\n                  }`}\n                >\n                  <div className=\"flex items-center\">\n                    <input\n                      type=\"radio\"\n                      id={optionId}\n                      name={currentQuestion.id}\n                      value={option}\n                      checked={isSelected}\n                      onChange={() => onAnswer(currentQuestion.id, option)}\n                      className=\"w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500 hv-focus-ring\"\n                    />\n                    <span className=\"ml-3 font-medium text-sm sm:text-base\">{option}</span>\n                  </div>\n                  {isSelected && <CheckCircle className=\"w-5 h-5 text-blue-600 self-end sm:self-auto\" />}\n                </label>\n              );\n            })}\n          </fieldset>\n        );\n      case 'multi_choice':\n        return (\n          <div className=\"space-y-3 mb-8\">\n            {currentQuestion.options.map((option, idx) => {\n              const isSelected = multiSelection.includes(option);\n              const optionId = `${currentQuestion.id}-multi-option-${idx}`;\n\n              const toggleOption = () => {\n                if (isSelected) {\n                  onAnswer(\n                    currentQuestion.id,\n                    multiSelection.filter(item => item !== option)\n                  );\n                } else {\n                  onAnswer(currentQuestion.id, [...multiSelection, option]);\n                }\n              };\n\n              return (\n                <label\n                  key={idx}\n                  htmlFor={optionId}\n                  className={`w-full p-3 sm:p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between rounded-xl border-2 transition-all duration-200 cursor-pointer hv-focus-ring ${\n                    isSelected\n                      ? 'border-blue-600 bg-blue-50 text-blue-900'\n                      : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'\n                  }`}\n                >\n                  <div className=\"flex items-center\">\n                    <input\n                      type=\"checkbox\"\n                      checked={isSelected}\n                      onChange={toggleOption}\n                      id={optionId}\n                      className=\"w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 hv-focus-ring\"\n                    />\n                    <span className=\"ml-3 font-medium text-sm sm:text-base\">{option}</span>\n                  </div>\n                  {isSelected && <CheckCircle className=\"w-5 h-5 text-blue-600 self-end sm:self-auto\" />}\n                </label>\n              );\n            })}\n          </div>\n        );\n      case 'ranking': {\n        const orderedCriteria = rankingPrioritized\n          .map(id => rankingConfig.criteria.find(criterion => criterion.id === id))\n          .filter(Boolean);\n        const ignoredCriteria = rankingConfig.criteria.filter(criterion => rankingIgnoredSet.has(criterion.id));\n\n        return (\n          <div className=\"space-y-4 mb-8\" data-tour-id=\"question-main-content\">\n            <p className=\"text-sm text-gray-600\">\n              Classez les critères du plus important au moins important et indiquez ceux qui sont sans importance pour vous.\n            </p>\n\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\n              <span className=\"text-xs text-gray-500\">Utilisez les flèches pour ajuster l'ordre.</span>\n              <button\n                type=\"button\"\n                onClick={handleRankingReset}\n                className=\"inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50\"\n              >\n                Réinitialiser l'ordre\n              </button>\n            </div>\n\n            <div className=\"space-y-3\">\n              {orderedCriteria.map((criterion, index) => {\n                const isFirst = index === 0;\n                const isLast = index === orderedCriteria.length - 1;\n\n                return (\n                  <div\n                    key={criterion.id}\n                    className=\"flex items-center gap-3 p-3 rounded-xl border-2 border-gray-200 bg-white hover:border-blue-200 hv-focus-ring\"\n                  >\n                    <div className=\"flex flex-col gap-1\">\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRankingMove(criterion.id, 'up')}\n                        disabled={isFirst}\n                        className=\"px-2 py-1 text-xs font-semibold border rounded-lg disabled:opacity-40 hover:bg-blue-50\"\n                        aria-label={`Monter ${criterion.label}`}\n                      >\n                        ↑\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRankingMove(criterion.id, 'down')}\n                        disabled={isLast}\n                        className=\"px-2 py-1 text-xs font-semibold border rounded-lg disabled:opacity-40 hover:bg-blue-50\"\n                        aria-label={`Descendre ${criterion.label}`}\n                      >\n                        ↓\n                      </button>\n                    </div>\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-semibold text-gray-800\">{index + 1}. {criterion.label}</p>\n                      {criterion.description && <p className=\"text-xs text-gray-500\">{criterion.description}</p>}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleRankingToggleIgnored(criterion.id)}\n                      className={`text-xs font-medium px-3 py-2 rounded-lg border transition ${\n                        rankingIgnoredSet.has(criterion.id)\n                          ? 'border-gray-300 text-gray-600 bg-gray-50'\n                          : 'border-red-200 text-red-600 hover:bg-red-50'\n                      }`}\n                    >\n                      {rankingIgnoredSet.has(criterion.id) ? 'Reprendre en compte' : 'Sans importance'}\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n\n            {ignoredCriteria.length > 0 && (\n              <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-3\">\n                <p className=\"text-sm font-semibold text-gray-700 mb-2\">Critères sans importance</p>\n                <div className=\"flex flex-wrap gap-2\">\n                  {ignoredCriteria.map(criterion => (\n                    <button\n                      key={criterion.id}\n                      type=\"button\"\n                      onClick={() => handleRankingToggleIgnored(criterion.id)}\n                      className=\"inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded-full bg-white hover:border-blue-300\"\n                    >\n                      {criterion.label}\n                      <span className=\"text-blue-600\">(réintégrer)</span>\n                    </button>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n      }\n      case 'milestone_list': {\n        const handleMilestoneUpdate = (updater) => {\n          setMilestoneDrafts(prev => {\n            const nextDrafts = typeof updater === 'function' ? updater(prev) : updater;\n            const sanitized = sanitizeMilestonesForAnswer(nextDrafts);\n            onAnswer(currentQuestion.id, sanitized);\n            return nextDrafts;\n          });\n        };\n\n        const handleMilestoneFieldChange = (index, field, value) => {\n          handleMilestoneUpdate(prev => {\n            const nextDrafts = prev.map((entry, entryIndex) => {\n              if (entryIndex !== index) {\n                return entry;\n              }\n\n              return {\n                ...entry,\n                [field]: value\n              };\n            });\n\n            return nextDrafts;\n          });\n        };\n\n        const handleMilestoneRemoval = (index) => {\n          handleMilestoneUpdate(prev => prev.filter((_, entryIndex) => entryIndex !== index));\n        };\n\n        const handleAddMilestone = () => {\n          handleMilestoneUpdate(prev => [...prev, { date: '', description: '' }]);\n        };\n\n        const emptyState = milestoneDrafts.length === 0;\n\n        return (\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <fieldset className=\"space-y-4\" aria-describedby={currentIndex === 0 ? instructionsId : undefined}>\n              <legend className=\"sr-only\">{currentQuestion.question}</legend>\n              {emptyState && (\n                <p className=\"text-sm text-gray-600\">\n                  Ajoutez vos prochains jalons pour préparer la feuille de route.\n                </p>\n              )}\n              {milestoneDrafts.map((entry, index) => {\n                const dateInputId = `${currentQuestion.id}-milestone-${index}-date`;\n                const descriptionInputId = `${currentQuestion.id}-milestone-${index}-description`;\n\n                return (\n                  <div\n                    key={`milestone-${index}`}\n                    className=\"p-4 border-2 border-gray-200 rounded-xl space-y-4 sm:space-y-0 sm:flex sm:items-end sm:gap-4\"\n                  >\n                    <div className=\"sm:w-40\">\n                      <label htmlFor={dateInputId} className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        Date du jalon\n                      </label>\n                      <input\n                        id={dateInputId}\n                        type=\"date\"\n                        value={entry.date || ''}\n                        onChange={(event) => handleMilestoneFieldChange(index, 'date', event.target.value)}\n                        className=\"w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n                      />\n                    </div>\n                    <div className=\"flex-1\">\n                      <label htmlFor={descriptionInputId} className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        Description\n                      </label>\n                      <input\n                        id={descriptionInputId}\n                        type=\"text\"\n                        value={entry.description || ''}\n                        onChange={(event) => handleMilestoneFieldChange(index, 'description', event.target.value)}\n                        className=\"w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n                      />\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleMilestoneRemoval(index)}\n                      className=\"inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-red-600 border border-red-200 rounded-lg hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2\"\n                    >\n                      <Trash2 className=\"w-4 h-4 mr-2\" />\n                      Supprimer\n                    </button>\n                  </div>\n                );\n              })}\n            </fieldset>\n            <button\n              type=\"button\"\n              onClick={handleAddMilestone}\n              className=\"mt-4 inline-flex items-center px-4 py-2 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Ajouter un jalon\n            </button>\n          </div>\n        );\n      }\n      case 'text':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-text`}>\n              Renseignez votre réponse\n            </label>\n            <RichTextEditor\n              id={`${currentQuestion.id}-text`}\n              value={currentAnswer ?? ''}\n              onChange={(nextValue) => onAnswer(currentQuestion.id, nextValue)}\n              placeholder={\n                typeof currentQuestion.placeholder === 'string' && currentQuestion.placeholder.trim() !== ''\n                  ? currentQuestion.placeholder.trim()\n                  : 'Saisissez une réponse enrichie (liens cliquables)'\n              }\n              compact\n              ariaLabel=\"Zone de réponse en texte libre\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">Utilisez ce champ pour des réponses courtes avec mise en forme.</p>\n          </div>\n        );\n      case 'long_text':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-long-text`}>\n              Décrivez les éléments pertinents\n            </label>\n            <RichTextEditor\n              id={`${currentQuestion.id}-long-text`}\n              value={currentAnswer ?? ''}\n              onChange={(nextValue) => onAnswer(currentQuestion.id, nextValue)}\n              placeholder={\n                typeof currentQuestion.placeholder === 'string' && currentQuestion.placeholder.trim() !== ''\n                  ? currentQuestion.placeholder.trim()\n                  : 'Renseignez ici les informations détaillées (liens HTML autorisés)'\n              }\n              ariaLabel=\"Zone de texte long en édition riche\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">Ce champ accepte plusieurs lignes et vos liens restent cliquables.</p>\n          </div>\n        );\n      case 'number': {\n        const unitLabel =\n          typeof currentQuestion.numberUnit === 'string' && currentQuestion.numberUnit.trim() !== ''\n            ? currentQuestion.numberUnit.trim()\n            : '';\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-number`}>\n              Renseignez une valeur numérique\n            </label>\n            <div className={`flex items-center gap-3 ${unitLabel ? 'flex-wrap sm:flex-nowrap' : ''}`}>\n              <input\n                type=\"number\"\n                inputMode=\"decimal\"\n                value={currentAnswer ?? ''}\n                onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n                id={`${currentQuestion.id}-number`}\n                className=\"w-full flex-1 min-w-0 px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n              />\n              {unitLabel && (\n                <span className=\"inline-flex items-center px-4 py-2.5 sm:py-3 border-2 border-blue-100 bg-blue-50 text-sm font-semibold text-blue-700 rounded-xl whitespace-nowrap\">\n                  {unitLabel}\n                </span>\n              )}\n            </div>\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Vous pouvez saisir un nombre entier ou décimal.\n            </p>\n          </div>\n        );\n      }\n      case 'url':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-url`}>\n              Indiquez une adresse URL\n            </label>\n            <input\n              type=\"url\"\n              value={currentAnswer ?? ''}\n              onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n              placeholder=\"https://exemple.com\"\n              id={`${currentQuestion.id}-url`}\n              className=\"w-full px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Incluez le protocole (https://) pour une URL valide.\n            </p>\n          </div>\n        );\n      case 'file':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-file`}>\n              Téléversez un fichier de référence\n            </label>\n            <input\n              type=\"file\"\n              onChange={(e) => {\n                const file = e.target.files && e.target.files[0];\n                if (file) {\n                  onAnswer(currentQuestion.id, {\n                    name: file.name,\n                    size: file.size,\n                    type: file.type\n                  });\n                } else {\n                  onAnswer(currentQuestion.id, null);\n                }\n              }}\n              id={`${currentQuestion.id}-file`}\n              className=\"w-full focus:outline-none hv-focus-ring\"\n            />\n            {currentAnswer && (\n              <p className=\"text-xs text-gray-500 mt-2\">\n                {(() => {\n                  const size = typeof currentAnswer.size === 'number'\n                    ? ` (${Math.round(currentAnswer.size / 1024)} Ko)`\n                    : '';\n                  return `Fichier sélectionné : ${currentAnswer.name}${size}`;\n                })()}\n              </p>\n            )}\n          </div>\n        );\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 px-4 py-6 sm:px-8 sm:py-10 hv-background\">\n      <div className=\"max-w-3xl mx-auto\">\n        <div className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 hv-surface\">\n          <div className=\"mb-8\">\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-2\">\n              <span id={progressLabelId} className=\"text-sm font-medium text-gray-600 hv-text-muted\" aria-live=\"polite\">\n                Question {currentIndex + 1} sur {questions.length}\n              </span>\n              <span className=\"text-sm font-medium text-blue-600 sm:text-right\" aria-live=\"polite\">\n                {remainingLabel}\n              </span>\n            </div>\n            <div\n              className=\"w-full bg-gray-200 rounded-full h-2 hv-progress\"\n              role=\"progressbar\"\n              aria-valuenow={Math.round(progress)}\n              aria-valuemin={0}\n              aria-valuemax={100}\n              aria-valuetext={remainingLabel}\n              aria-labelledby={progressLabelId}\n            >\n              <span\n                className=\"block bg-blue-600 h-2 rounded-full transition-all duration-300 hv-progress-indicator\"\n                style={{ width: `${progress}%` }}\n              />\n            </div>\n            {currentIndex === 0 && (\n              <p id={instructionsId} className=\"text-xs text-gray-500 mt-2 flex items-center hv-text-muted\">\n                <Info className=\"w-3 h-3 mr-1\" />\n                Certaines questions peuvent apparaître en fonction de vos réponses\n              </p>\n            )}\n            {currentIndex === 0 && (\n              <p className=\"mt-4 text-xs italic text-gray-400\">\n                Le LFB traite les données recueillies pour gérer les projets à soumettre aux équipes compliance.{' '}\n                <a\n                  href=\"./mentions-legales.html\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"underline hover:text-gray-500\"\n                >\n                  En savoir plus sur vos données et vos droits\n                </a>\n              </p>\n            )}\n          </div>\n\n          {hasSaveFeedback && (\n            <div className=\"mb-6\" role=\"status\" aria-live=\"polite\">\n              <div\n                className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${\n                  isSaveSuccess\n                    ? 'border-emerald-200 bg-emerald-50 text-emerald-700'\n                    : 'border-red-200 bg-red-50 text-red-700'\n                }`}\n              >\n                {isSaveSuccess ? (\n                  <CheckCircle className=\"mt-0.5 h-5 w-5\" />\n                ) : (\n                  <AlertTriangle className=\"mt-0.5 h-5 w-5\" />\n                )}\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\">{saveFeedback.message}</p>\n                </div>\n                {typeof onDismissSaveFeedback === 'function' && (\n                  <button\n                    type=\"button\"\n                    onClick={onDismissSaveFeedback}\n                    className=\"text-xs font-semibold uppercase tracking-wide text-current hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-current rounded\"\n                  >\n                    Fermer\n                  </button>\n                )}\n              </div>\n            </div>\n          )}\n\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\n              <h2 id={questionTextId} className=\"text-2xl font-bold text-gray-800 sm:text-3xl\">\n                {currentQuestion.question}\n              </h2>\n              {!currentQuestion.required && (\n                <span className=\"inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-wide bg-gray-100 text-gray-600 rounded-full border border-gray-200 hv-badge self-start\">\n                  Réponse facultative\n                </span>\n              )}\n              {hasGuidanceContent && (\n                <button\n                  type=\"button\"\n                  onClick={() => setShowGuidance(prev => !prev)}\n                  className={`inline-flex items-center justify-center w-full sm:w-auto px-4 py-2 text-sm font-medium rounded-lg border transition-all hv-button hv-focus-ring ${\n                    showGuidance\n                      ? 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700'\n                      : 'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100'\n                  }`}\n                  aria-expanded={showGuidance}\n                  aria-controls={guidancePanelId}\n                  data-tour-id=\"question-guidance-toggle\"\n                >\n                  <Info className=\"w-4 h-4 mr-2\" />\n                  {showGuidance ? \"Masquer l'aide\" : 'Comprendre cette question'}\n                </button>\n              )}\n            </div>\n\n            {hasGuidanceContent && showGuidance && (\n              <div\n                id={guidancePanelId}\n                className=\"mt-4 bg-blue-50 border border-blue-200 rounded-2xl p-5 text-sm text-gray-700 hv-surface\"\n                role=\"region\"\n                aria-label=\"Aide contextuelle\"\n              >\n                <div className=\"flex items-start\">\n                  <div className=\"mr-3 mt-0.5 text-blue-600\">\n                    <Info className=\"w-5 h-5\" />\n                  </div>\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h3 className=\"text-base font-semibold text-blue-700\">Guidage contextuel</h3>\n                      {guidance.objective && (\n                        <p className=\"mt-1 text-gray-700\">{renderTextWithLinks(guidance.objective)}</p>\n                      )}\n                    </div>\n\n                    {guidance.details && (\n                      <p className=\"text-gray-700 leading-relaxed\">{renderTextWithLinks(guidance.details)}</p>\n                    )}\n\n                    {hasConditions && (\n                      <div>\n                        <h4 className=\"text-xs font-semibold uppercase tracking-wide text-blue-700\">Pourquoi cette question apparaît</h4>\n                        {conditionSummaries.length === 1 ? (\n                          (() => {\n                            const logic = conditionSummaries[0].logic === 'any' ? 'any' : 'all';\n                            return (\n                              <p className=\"text-xs text-blue-600 mt-1\">\n                                Elle s'affiche lorsque {logic === 'any'\n                                  ? \"au moins une des conditions suivantes est remplie\"\n                                  : 'toutes les conditions suivantes sont remplies'}.\n                              </p>\n                            );\n                          })()\n                        ) : (\n                          <div className=\"text-xs text-blue-600 mt-1 space-y-1\">\n                            <p>\n                              Cette question apparaît lorsque{' '}\n                              <strong className=\"text-blue-700\">chaque groupe de conditions</strong> ci-dessous est vérifié.\n                            </p>\n                            <p>\n                              À l'intérieur de chaque groupe, suivez la logique indiquée (ET ou OU) pour les conditions listées.\n                            </p>\n                          </div>\n                        )}\n                        <div className=\"mt-3 space-y-3\">\n                          {conditionSummaries.map((groupSummary, idx) => {\n                            const logicLabel = groupSummary.logic === 'any' ? 'OU' : 'ET';\n                            const connectorLabel = groupSummary.logic === 'any' ? 'OU' : 'ET';\n\n                            if (groupSummary.conditions.length === 0) {\n                              return null;\n                            }\n\n                            return (\n                              <div key={`condition-group-${idx}`} className=\"bg-white border border-blue-100 rounded-xl p-3 hv-surface\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                  <span className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">\n                                    Groupe {idx + 1}\n                                  </span>\n                                  <span className=\"text-[11px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full\">\n                                    Logique {logicLabel}\n                                  </span>\n                                  {idx > 0 && (\n                                    <span className=\"ml-auto text-[11px] font-semibold text-blue-600 uppercase tracking-wide\">\n                                      ET avec précédent\n                                    </span>\n                                  )}\n                                </div>\n                                <ul className=\"space-y-2\">\n                                  {groupSummary.conditions.map((item, conditionIdx) => (\n                                    <li key={`${item.label}-${conditionIdx}`} className=\"text-sm text-gray-700\">\n                                      <p className=\"font-medium text-gray-800\">\n                                        {conditionIdx > 0 && (\n                                          <span className=\"inline-flex items-center px-2 py-0.5 mr-2 text-[11px] font-semibold uppercase tracking-wide rounded-full bg-blue-100 text-blue-700\">\n                                            {connectorLabel}\n                                          </span>\n                                        )}\n                                        {item.label} {item.operator} \"{item.value}\"\n                                      </p>\n                                      {item.answer && (\n                                        <p className=\"text-xs text-gray-500 mt-1\">\n                                          Votre réponse :{' '}\n                                          <span className=\"font-medium text-gray-700\">\n                                            {renderTextWithLinks(item.answer)}\n                                          </span>\n                                        </p>\n                                      )}\n                                    </li>\n                                  ))}\n                                </ul>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      </div>\n                    )}\n\n                    {guidanceTips.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-semibold uppercase tracking-wide text-blue-700\">Conseils pratiques</h4>\n                        <ul className=\"mt-2 space-y-2 list-disc list-inside text-sm text-gray-700\">\n                          {guidanceTips.map((tip, idx) => (\n                            <li key={idx}>{renderTextWithLinks(tip)}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {hasValidationError && (\n            <div className=\"mb-6\" role=\"alert\" aria-live=\"assertive\">\n              <div className=\"flex items-start space-x-3 rounded-xl border border-red-200 bg-red-50 p-4 text-red-700 hv-surface\">\n                <AlertTriangle className=\"w-5 h-5 mt-0.5\" />\n                <div>\n                  <p className=\"text-sm font-semibold\">Réponse obligatoire manquante</p>\n                  <p className=\"text-sm\">{validationError?.message}</p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {isReturnToSynthesisRequested && (\n            <div\n              className=\"mb-4 flex items-start gap-3 rounded-xl border border-blue-200 bg-blue-50 p-4 text-sm text-blue-800\"\n              role=\"status\"\n              aria-live=\"polite\"\n            >\n              <Info className=\"mt-0.5 h-5 w-5\" />\n              <p>Modification depuis le rapport Compliance. Validez vos changements pour y retourner.</p>\n            </div>\n          )}\n\n          {renderQuestionInput()}\n\n          <div\n            className={`flex flex-col-reverse gap-3 sm:flex-row sm:items-center ${\n              currentIndex === 0 && !onSaveDraft\n                ? 'sm:justify-end'\n                : 'sm:justify-between'\n            }`}\n            data-tour-id=\"questionnaire-finish\"\n          >\n            {currentIndex > 0 && (\n              <button\n                type=\"button\"\n                onClick={onBack}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                <ChevronLeft className=\"w-5 h-5 mr-2\" />\n                Précédent\n              </button>\n            )}\n\n            {onSaveDraft && (\n              <button\n                type=\"button\"\n                onClick={onSaveDraft}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"question-save-draft\"\n              >\n                <Save className=\"w-5 h-5 mr-2\" />\n                Enregistrer le projet\n              </button>\n            )}\n\n            {onReturnToSynthesis && (\n              <button\n                type=\"button\"\n                onClick={onReturnToSynthesis}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                <CheckCircle className=\"w-5 h-5 mr-2\" />\n                Valider et revenir au rapport\n              </button>\n            )}\n\n            {shouldShowNextButton && (\n              <button\n                type=\"button\"\n                onClick={isReturnToSynthesisRequested ? handleLinkedQuestionNext : onNext}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n              >\n                {currentIndex === questions.length - 1 ? 'Voir la synthèse' : 'Suivant'}\n                <ChevronRight className=\"w-5 h-5 ml-2\" />\n              </button>\n            )}\n\n            {currentIndex < questions.length - 1 && onFinish && shouldShowFinishButton && (\n              <button\n                type=\"button\"\n                onClick={onFinish}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                Fin\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n",
