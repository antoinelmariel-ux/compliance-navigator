  "src/App.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState, lazy, Suspense } from './react.js';\nimport { QuestionnaireScreen } from './components/QuestionnaireScreen.jsx';\nimport { SynthesisReport } from './components/SynthesisReport.jsx';\nimport { HomeScreen } from './components/HomeScreen.jsx';\nimport { InspirationForm } from './components/InspirationForm.jsx';\nimport { InspirationDetail } from './components/InspirationDetail.jsx';\nimport { AnnotationLayer } from './components/AnnotationLayer.jsx';\nimport { CheckCircle, Link, Lock, MessageSquare, Settings, Sparkles } from './components/icons.js';\nimport { MandatoryQuestionsSummary } from './components/MandatoryQuestionsSummary.jsx';\nimport { initialQuestions } from './data/questions.js';\nimport { initialRules } from './data/rules.js';\nimport { initialRiskLevelRules } from './data/riskLevelRules.js';\nimport { initialRiskWeights } from './data/riskWeights.js';\nimport { initialTeams } from './data/teams.js';\nimport { initialShowcaseThemes } from './data/showcaseThemes.js';\nimport { initialInspirationProjects } from './data/inspirationProjects.js';\nimport { loadPersistedState, persistState } from './utils/storage.js';\nimport { shouldShowQuestion } from './utils/questions.js';\nimport { analyzeAnswers } from './utils/rules.js';\nimport { extractProjectName } from './utils/projects.js';\nimport { createDemoProject, demoProjectAnswersSnapshot } from './data/demoProject.js';\nimport { exportProjectToFile } from './utils/projectExport.js';\nimport { normalizeRiskWeighting } from './utils/risk.js';\nimport { normalizeProjectEntry, normalizeProjectsCollection } from './utils/projectNormalization.js';\nimport { loadSubmittedProjectsFromDirectory } from './utils/externalProjectsLoader.js';\nimport {\n  createDefaultProjectFiltersConfig,\n  normalizeProjectFilterConfig\n} from './utils/projectFilters.js';\nimport {\n  createDefaultInspirationFiltersConfig,\n  createDefaultInspirationFormConfig,\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig\n} from './utils/inspirationConfig.js';\n\nconst APP_VERSION = 'v1.0.214';\n\nconst loadModule = (modulePath) => {\n  if (typeof window === 'undefined') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  if (!window.ModuleLoader || typeof window.ModuleLoader.import !== 'function') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  return window.ModuleLoader.import(modulePath);\n};\n\nconst LazyBackOffice = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/BackOffice.jsx').BackOffice\n  }))\n);\n\nconst LazyProjectShowcase = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/ProjectShowcase.jsx').ProjectShowcase\n  }))\n);\n\nconst LoadingFallback = ({ label, hint }) => (\n  <div className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n    <div className=\"flex items-center gap-3 text-sm text-gray-600\">\n      <span className=\"loading-spinner\" aria-hidden=\"true\" />\n      <span>{label}</span>\n    </div>\n    {hint && <p className=\"mt-2 text-xs text-gray-400\">{hint}</p>}\n  </div>\n);\n\nconst ANNOTATION_COLORS = [\n  '#2563eb',\n  '#ec4899',\n  '#10b981',\n  '#f59e0b',\n  '#8b5cf6',\n  '#0ea5e9',\n  '#14b8a6',\n  '#ef4444',\n  '#ea580c'\n];\n\nconst BACK_OFFICE_PASSWORD_HASH = '3c5b8c6aaa89db61910cdfe32f1bdb193d1923146dbd6a7b0634a32ab73ac1af';\nconst BACK_OFFICE_PASSWORD_FALLBACK_DIGEST = '86ceec83';\n\nconst computeBackOfficePasswordDigest = async (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return '';\n  }\n\n  const globalCrypto =\n    typeof globalThis !== 'undefined' && typeof globalThis.crypto !== 'undefined'\n      ? globalThis.crypto\n      : undefined;\n\n  const hasSubtleCrypto =\n    !!globalCrypto?.subtle && typeof TextEncoder !== 'undefined';\n\n  if (hasSubtleCrypto) {\n    try {\n      const encoder = new TextEncoder();\n      const data = encoder.encode(value);\n      const digest = await globalCrypto.subtle.digest('SHA-256', data);\n      return Array.from(new Uint8Array(digest))\n        .map(byte => byte.toString(16).padStart(2, '0'))\n        .join('');\n    } catch (error) {\n      // Fallback defined below\n    }\n  }\n\n  let hash = 0;\n  for (let index = 0; index < value.length; index += 1) {\n    hash = (hash * 31 + value.charCodeAt(index)) >>> 0;\n  }\n\n  return hash.toString(16).padStart(8, '0');\n};\n\nconst verifyBackOfficePassword = async (value) => {\n  const digest = await computeBackOfficePasswordDigest(value);\n\n  if (!digest) {\n    return false;\n  }\n\n  if (digest.length === BACK_OFFICE_PASSWORD_HASH.length) {\n    return digest === BACK_OFFICE_PASSWORD_HASH;\n  }\n\n  return digest === BACK_OFFICE_PASSWORD_FALLBACK_DIGEST;\n};\n\nconst cloneDeep = (value) => {\n  if (value === null || value === undefined) {\n    return value;\n  }\n\n  if (typeof structuredClone === 'function') {\n    try {\n      return structuredClone(value);\n    } catch (error) {\n      // Fallback to JSON strategy below\n    }\n  }\n\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst createAnnotationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `note-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst createInspirationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `inspiration-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst buildAnnotationContextKey = ({ screen, projectId, scope }) => {\n  const base = screen === 'showcase' ? `showcase:${projectId || 'unknown'}` : screen;\n\n  if (screen === 'showcase' && scope) {\n    return `${base}:${scope}`;\n  }\n\n  return base || 'global';\n};\n\nconst restoreShowcaseQuestions = (currentQuestions, referenceQuestions = initialQuestions) => {\n  if (!Array.isArray(currentQuestions)) {\n    return referenceQuestions;\n  }\n\n  const nextQuestions = currentQuestions.slice();\n  let changed = false;\n\n  referenceQuestions.forEach((referenceQuestion, referenceIndex) => {\n    if (!referenceQuestion || !referenceQuestion.showcase) {\n      return;\n    }\n\n    const existingIndex = nextQuestions.findIndex((item) => item && item.id === referenceQuestion.id);\n\n    if (existingIndex === -1) {\n      const clonedQuestion = JSON.parse(JSON.stringify(referenceQuestion));\n      const insertionIndex = Math.min(referenceIndex, nextQuestions.length);\n      nextQuestions.splice(insertionIndex, 0, clonedQuestion);\n      changed = true;\n      return;\n    }\n\n    const existingQuestion = nextQuestions[existingIndex];\n    const existingShowcaseMeta = existingQuestion && existingQuestion.showcase;\n    const referenceShowcaseMeta = referenceQuestion.showcase;\n\n    const showcaseMetaDiffers =\n      !existingShowcaseMeta ||\n      JSON.stringify(existingShowcaseMeta) !== JSON.stringify(referenceShowcaseMeta);\n\n    if (showcaseMetaDiffers) {\n      nextQuestions[existingIndex] = {\n        ...existingQuestion,\n        showcase: JSON.parse(JSON.stringify(referenceShowcaseMeta))\n      };\n      changed = true;\n    }\n  });\n\n  return changed ? nextQuestions : currentQuestions;\n};\n\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst areAnswersEqual = (previousValue, nextValue) => {\n  if (previousValue === nextValue) {\n    return true;\n  }\n\n  if (Array.isArray(previousValue) && Array.isArray(nextValue)) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      if (previousValue.length !== nextValue.length) {\n        return false;\n      }\n      return previousValue.every((entry, index) => entry === nextValue[index]);\n    }\n  }\n\n  if (\n    previousValue &&\n    nextValue &&\n    typeof previousValue === 'object' &&\n    typeof nextValue === 'object'\n  ) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      return false;\n    }\n  }\n\n  return false;\n};\n\nconst findQuestionById = (questions, id) => {\n  if (!Array.isArray(questions)) {\n    return null;\n  }\n\n  return questions.find(question => question?.id === id) || null;\n};\n\nconst normalizeMilestoneListValue = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0)\n    .map(entry => ({\n      date: entry.date,\n      description: entry.description\n    }));\n};\n\nconst areMilestoneListsEqual = (previousValue, nextValue) => {\n  if (previousValue.length !== nextValue.length) {\n    return false;\n  }\n\n  return previousValue.every((entry, index) => {\n    const nextEntry = nextValue[index];\n    if (!nextEntry) {\n      return false;\n    }\n\n    return entry.date === nextEntry.date && entry.description === nextEntry.description;\n  });\n};\n\nconst applyAnswerUpdates = (\n  prevAnswers = {},\n  updates,\n  questions,\n  predicate,\n  options = {}\n) => {\n  if (!updates || typeof updates !== 'object') {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const entries = Object.entries(updates);\n  if (entries.length === 0) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const nextAnswers = { ...prevAnswers };\n  let changed = false;\n\n  entries.forEach(([questionId, value]) => {\n    if (!questionId) {\n      return;\n    }\n\n    const question = findQuestionById(questions, questionId);\n    const questionType = question?.type;\n\n    if (questionType === 'milestone_list') {\n      const normalizedValue = normalizeMilestoneListValue(value);\n      const previousRawValue = nextAnswers[questionId];\n      const previousValue = Array.isArray(previousRawValue)\n        ? normalizeMilestoneListValue(previousRawValue)\n        : [];\n      const previousRawJson = JSON.stringify(Array.isArray(previousRawValue) ? previousRawValue : []);\n      const normalizedJson = JSON.stringify(normalizedValue);\n\n      if (normalizedValue.length > 0) {\n        if (!areMilestoneListsEqual(previousValue, normalizedValue) || previousRawJson !== normalizedJson) {\n          changed = true;\n          nextAnswers[questionId] = normalizedValue;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (Array.isArray(value)) {\n      const filtered = value\n        .map(item => (typeof item === 'string' ? item.trim() : item))\n        .filter(item => {\n          if (typeof item === 'string') {\n            return item.length > 0;\n          }\n          return item !== null && item !== undefined;\n        });\n\n      const previousValue = nextAnswers[questionId];\n      const arraysAreEqual = Array.isArray(previousValue)\n        && previousValue.length === filtered.length\n        && previousValue.every((item, index) => item === filtered[index]);\n\n      if (filtered.length > 0) {\n        if (!arraysAreEqual) {\n          changed = true;\n        }\n        nextAnswers[questionId] = filtered;\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (value === null || value === undefined) {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length > 0) {\n        if (nextAnswers[questionId] !== value) {\n          changed = true;\n          nextAnswers[questionId] = value;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (nextAnswers[questionId] !== value) {\n      changed = true;\n      nextAnswers[questionId] = value;\n    }\n  });\n\n  if (!changed) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const canEvaluatePredicate = typeof predicate === 'function';\n  const shouldPreserveQuestion = typeof options.shouldPreserveQuestion === 'function'\n    ? options.shouldPreserveQuestion\n    : null;\n  const questionsToRemove = Array.isArray(questions) && canEvaluatePredicate\n    ? questions\n        .filter(question => {\n          if (!question || !question.id) {\n            return false;\n          }\n\n          const wasVisible = predicate(question, prevAnswers);\n          const isVisible = predicate(question, nextAnswers);\n\n          if (isVisible) {\n            return false;\n          }\n\n          if (shouldPreserveQuestion && shouldPreserveQuestion(question, {\n            prevAnswers,\n            nextAnswers\n          })) {\n            return false;\n          }\n\n          if (wasVisible) {\n            return true;\n          }\n\n          return isAnswerProvided(nextAnswers[question.id]) || isAnswerProvided(prevAnswers[question.id]);\n        })\n        .map(question => question.id)\n    : [];\n\n  if (questionsToRemove.length > 0) {\n    questionsToRemove.forEach(questionId => {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n    });\n  }\n\n  return { nextAnswers, changed };\n};\n\nconst resolveFallbackQuestionsLength = (savedState, currentQuestionsLength = initialQuestions.length) => {\n  if (savedState && Array.isArray(savedState.questions) && savedState.questions.length > 0) {\n    return savedState.questions.length;\n  }\n\n  return currentQuestionsLength;\n};\n\nconst buildInitialProjectsState = () => {\n  const savedState = loadPersistedState();\n\n  if (!savedState) {\n    return [createDemoProject()];\n  }\n\n  const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : initialQuestions;\n  const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : initialRules;\n  const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n    ? savedState.riskLevelRules\n    : initialRiskLevelRules;\n  const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n    ? normalizeRiskWeighting(savedState.riskWeights)\n    : initialRiskWeights;\n  const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n  const normalizedProjects = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength)\n    || normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n\n  if (normalizedProjects && normalizedProjects.length > 0) {\n    return normalizedProjects;\n  }\n\n  return [createDemoProject({\n    questions: fallbackQuestions,\n    rules: fallbackRules,\n    riskLevelRules: fallbackRiskLevelRules,\n    riskWeights: fallbackRiskWeights\n  })];\n};\n\nconst buildInitialInspirationProjectsState = () => {\n  const savedState = loadPersistedState();\n  if (savedState && Array.isArray(savedState.inspirationProjects)) {\n    return cloneDeep(savedState.inspirationProjects);\n  }\n\n  return cloneDeep(initialInspirationProjects);\n};\n\nconst isOnboardingProject = (project) => {\n  if (!project || typeof project !== 'object') {\n    return false;\n  }\n\n  const { id } = project;\n  if (typeof id !== 'string' || id.length === 0) {\n    return false;\n  }\n\n  return id === 'onboarding-demo' || id.startsWith('tour-');\n};\n\nconst sanitizeRestoredProjects = (projects) => {\n  if (!Array.isArray(projects)) {\n    return [];\n  }\n\n  const restored = projects.filter(project => !isOnboardingProject(project));\n\n  if (restored.length === 0) {\n    return [];\n  }\n\n  return cloneDeep(restored);\n};\n\nexport const App = () => {\n  const [mode, setMode] = useState('user');\n  const [screen, setScreen] = useState('home');\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [answers, setAnswers] = useState({});\n  const [analysis, setAnalysis] = useState(null);\n  const [projects, setProjects] = useState(buildInitialProjectsState);\n  const projectsRef = useRef(projects);\n  const [inspirationProjects, setInspirationProjects] = useState(buildInitialInspirationProjectsState);\n  const [activeInspirationId, setActiveInspirationId] = useState(null);\n  const [activeProjectId, setActiveProjectId] = useState(null);\n  const [validationError, setValidationError] = useState(null);\n  const [saveFeedback, setSaveFeedback] = useState(null);\n  const [showcaseProjectContext, setShowcaseProjectContext] = useState(null);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  const [returnToSynthesisAfterEdit, setReturnToSynthesisAfterEdit] = useState(false);\n  const [isOnboardingActive, setIsOnboardingActive] = useState(false);\n  const [onboardingStepId, setOnboardingStepId] = useState(null);\n  const [isTourGuideReady, setIsTourGuideReady] = useState(false);\n  const tourInstanceRef = useRef(null);\n  const onboardingStateRef = useRef(null);\n  const onboardingDemoDataRef = useRef(null);\n  const isOnboardingActiveRef = useRef(false);\n\n  const [questions, setQuestions] = useState(() => restoreShowcaseQuestions(initialQuestions));\n  const [rules, setRules] = useState(initialRules);\n  const [riskLevelRules, setRiskLevelRules] = useState(initialRiskLevelRules);\n  const [riskWeights, setRiskWeights] = useState(() => normalizeRiskWeighting(initialRiskWeights));\n  const [teams, setTeams] = useState(initialTeams);\n  const [showcaseThemes, setShowcaseThemes] = useState(initialShowcaseThemes);\n  const [projectFilters, setProjectFiltersState] = useState(() => createDefaultProjectFiltersConfig());\n  const [inspirationFilters, setInspirationFilters] = useState(() => createDefaultInspirationFiltersConfig());\n  const [inspirationFormFields, setInspirationFormFields] = useState(() => createDefaultInspirationFormConfig());\n  const [homeView, setHomeView] = useState('platform');\n  const [isHydrated, setIsHydrated] = useState(false);\n  const [isBackOfficeUnlocked, setIsBackOfficeUnlocked] = useState(false);\n  const [backOfficeAuthError, setBackOfficeAuthError] = useState(null);\n  const [isBackOfficePromptOpen, setIsBackOfficePromptOpen] = useState(false);\n  const [backOfficePromptValue, setBackOfficePromptValue] = useState('');\n  const [backOfficePromptError, setBackOfficePromptError] = useState('');\n  const backOfficePromptResolverRef = useRef(null);\n  const [adminView, setAdminView] = useState('home');\n  const persistTimeoutRef = useRef(null);\n  const previousScreenRef = useRef(null);\n  const [isAnnotationModeEnabled, setIsAnnotationModeEnabled] = useState(false);\n  const [isAnnotationPaused, setIsAnnotationPaused] = useState(false);\n  const [annotationNotes, setAnnotationNotes] = useState([]);\n  const [annotationSources, setAnnotationSources] = useState({ session: ANNOTATION_COLORS[0] });\n  const [showcaseAnnotationScope, setShowcaseAnnotationScope] = useState('display-full');\n  const [autoFocusAnnotationId, setAutoFocusAnnotationId] = useState(null);\n  const [isShowcaseEditing, setIsShowcaseEditing] = useState(false);\n  const [isShowcaseShareOpen, setIsShowcaseShareOpen] = useState(false);\n  const [showcaseShareFeedback, setShowcaseShareFeedback] = useState('');\n  const annotationNotesRef = useRef(annotationNotes);\n  const annotationFileInputRef = useRef(null);\n  const loadedStylesRef = useRef(new Set());\n  const pendingShowcaseProjectIdRef = useRef(null);\n\n  const ensureStylesheetLoaded = useCallback((href) => {\n    if (typeof document === 'undefined' || !href) {\n      return;\n    }\n\n    if (loadedStylesRef.current.has(href)) {\n      return;\n    }\n\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = href;\n    link.dataset.dynamic = 'true';\n    document.head.appendChild(link);\n    loadedStylesRef.current.add(href);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleBeforeUnload = (event) => {\n      if (!hasUnsavedChanges) {\n        return undefined;\n      }\n\n      const message = 'Avez-vous bien sauvegardé votre projet avant de quitter ?';\n      event.preventDefault();\n      event.returnValue = message;\n      return message;\n    };\n\n    window.addEventListener('beforeunload', handleBeforeUnload);\n\n    return () => {\n      window.removeEventListener('beforeunload', handleBeforeUnload);\n    };\n  }, [hasUnsavedChanges]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const { search, hash } = window.location;\n    const params = new URLSearchParams(search || '');\n    let projectId = params.get('projectId') || params.get('showcase');\n\n    if (!projectId && typeof hash === 'string' && hash.length > 1) {\n      const normalizedHash = hash.slice(1);\n      if (normalizedHash.startsWith('showcase=')) {\n        projectId = normalizedHash.replace(/^showcase=/, '');\n      } else if (normalizedHash.startsWith('showcase:')) {\n        projectId = normalizedHash.replace(/^showcase:/, '');\n      }\n    }\n\n    if (projectId) {\n      pendingShowcaseProjectIdRef.current = projectId;\n    }\n  }, []);\n\n  useEffect(() => {\n    projectsRef.current = projects;\n  }, [projects]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    ensureStylesheetLoaded('./src/styles/project-showcase.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-aurora.css');\n  }, [ensureStylesheetLoaded, showcaseProjectContext]);\n\n  useEffect(() => {\n    annotationNotesRef.current = annotationNotes;\n  }, [annotationNotes]);\n\n  useEffect(() => {\n    isOnboardingActiveRef.current = isOnboardingActive;\n  }, [isOnboardingActive]);\n\n  useEffect(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      if (!Array.isArray(prevProjects) || prevProjects.length === 0) {\n        return prevProjects;\n      }\n\n      const containsOnboardingProjects = prevProjects.some(isOnboardingProject);\n      if (!containsOnboardingProjects) {\n        return prevProjects;\n      }\n\n      const sanitizedProjects = prevProjects.filter(project => !isOnboardingProject(project));\n\n      if (sanitizedProjects.length === 0) {\n        return buildInitialProjectsState();\n      }\n\n      return cloneDeep(sanitizedProjects);\n    });\n  }, [isOnboardingActive, setProjects]);\n\n  useEffect(() => {\n    if (mode !== 'admin') {\n      setAdminView('home');\n    }\n  }, [mode]);\n\nconst updateProjectFilters = useCallback((updater) => {\n  setProjectFiltersState(prevConfig => {\n    const currentConfig = normalizeProjectFilterConfig(prevConfig);\n    const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n    return normalizeProjectFilterConfig(nextConfig);\n  });\n}, []);\n\n  const updateInspirationFilters = useCallback((updater) => {\n    setInspirationFilters(prevConfig => {\n      const currentConfig = normalizeInspirationFiltersConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFiltersConfig(nextConfig);\n    });\n  }, []);\n\n  const updateInspirationFormFields = useCallback((updater) => {\n    setInspirationFormFields(prevConfig => {\n      const currentConfig = normalizeInspirationFormConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFormConfig(nextConfig);\n    });\n  }, []);\n\n  useEffect(() => {\n    if (!Array.isArray(showcaseThemes) || showcaseThemes.length === 0) {\n      return;\n    }\n\n    setQuestions((previousQuestions) => {\n      const nextQuestions = Array.isArray(previousQuestions)\n        ? previousQuestions.slice()\n        : [];\n      const themeQuestionIndex = nextQuestions.findIndex(question => question?.id === 'showcaseTheme');\n\n      if (themeQuestionIndex === -1) {\n        return previousQuestions;\n      }\n\n      const themeOptions = showcaseThemes\n        .map(theme => (typeof theme?.label === 'string' && theme.label.trim().length > 0\n          ? theme.label.trim()\n          : typeof theme?.id === 'string'\n            ? theme.id\n            : ''))\n        .filter(option => option.length > 0);\n\n      const existingOptions = Array.isArray(nextQuestions[themeQuestionIndex]?.options)\n        ? nextQuestions[themeQuestionIndex].options\n        : [];\n\n      if (\n        themeOptions.length === existingOptions.length &&\n        themeOptions.every((option, index) => option === existingOptions[index])\n      ) {\n        return previousQuestions;\n      }\n\n      const existingThemeQuestion = nextQuestions[themeQuestionIndex] || {};\n\n      nextQuestions[themeQuestionIndex] = {\n        ...existingThemeQuestion,\n        options: themeOptions\n      };\n\n      return nextQuestions;\n    });\n  }, [setQuestions, showcaseThemes]);\n\n  const synchronizeExternalProjects = useCallback(async () => {\n    const existingProjects = Array.isArray(projectsRef.current) ? projectsRef.current : [];\n\n    const fallbackQuestionsLength = questions.length;\n\n    const externalProjects = await loadSubmittedProjectsFromDirectory({\n      questions,\n      rules,\n      riskLevelRules,\n      riskWeights,\n      fallbackQuestionsLength,\n      existingProjects\n    });\n\n    const externalSources = new Set(externalProjects.map(entry => entry.sourceId));\n\n    setProjects(prevProjects => {\n      const baseProjects = Array.isArray(prevProjects) ? prevProjects : [];\n      const preserved = baseProjects.filter(project => (\n        !project?.externalSourceId || externalSources.has(project.externalSourceId)\n      ));\n\n      const bySource = new Map();\n      preserved.forEach(project => {\n        if (project && project.externalSourceId) {\n          bySource.set(project.externalSourceId, project);\n        }\n      });\n\n      let changed = preserved.length !== baseProjects.length;\n      const nextProjects = preserved.slice();\n\n      externalProjects.forEach(entry => {\n        const { project, sourceId, checksum } = entry;\n        if (!project || !sourceId) {\n          return;\n        }\n\n        const existing = bySource.get(sourceId);\n        if (!existing) {\n          nextProjects.push(project);\n          changed = true;\n          return;\n        }\n\n        const existingChecksum = existing.externalSourceChecksum;\n        if (existingChecksum && existingChecksum === checksum) {\n          return;\n        }\n\n        const index = nextProjects.findIndex(item => item?.externalSourceId === sourceId);\n        if (index !== -1) {\n          nextProjects[index] = project;\n        } else {\n          nextProjects.push(project);\n        }\n        changed = true;\n      });\n\n      return changed ? nextProjects : baseProjects;\n    });\n  }, [questions, riskLevelRules, riskWeights, rules]);\n\n  useEffect(() => {\n    const loadExternal = async () => {\n      try {\n        await synchronizeExternalProjects();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('Impossible de synchroniser les projets externes :', error);\n        }\n      }\n    };\n\n    loadExternal();\n  }, [synchronizeExternalProjects]);\n\n  useEffect(() => {\n    const savedState = loadPersistedState();\n    if (!savedState) {\n      setIsHydrated(true);\n      return;\n    }\n\n    const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : questions;\n    const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : rules;\n    const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n      ? savedState.riskLevelRules\n      : riskLevelRules;\n    const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n      ? normalizeRiskWeighting(savedState.riskWeights)\n      : riskWeights;\n    const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n    if (savedState.mode === 'admin') {\n      setMode('user');\n    } else if (savedState.mode) {\n      setMode(savedState.mode);\n    }\n    if (savedState.screen) setScreen(savedState.screen);\n    if (typeof savedState.currentQuestionIndex === 'number' && savedState.currentQuestionIndex >= 0) {\n      setCurrentQuestionIndex(savedState.currentQuestionIndex);\n    }\n    if (savedState.answers && typeof savedState.answers === 'object') setAnswers(savedState.answers);\n    if (typeof savedState.analysis !== 'undefined') setAnalysis(savedState.analysis);\n    if (Array.isArray(savedState.projects)) {\n      const normalized = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    } else if (Array.isArray(savedState.submittedProjects)) {\n      const normalized = normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    }\n    if (typeof savedState.activeProjectId === 'string') setActiveProjectId(savedState.activeProjectId);\n    if (typeof savedState.activeInspirationId === 'string') setActiveInspirationId(savedState.activeInspirationId);\n    if (typeof savedState.homeView === 'string') setHomeView(savedState.homeView);\n    if (Array.isArray(savedState.questions)) {\n      setQuestions(restoreShowcaseQuestions(savedState.questions));\n    }\n    if (Array.isArray(savedState.rules)) setRules(savedState.rules);\n    if (Array.isArray(savedState.riskLevelRules)) setRiskLevelRules(savedState.riskLevelRules);\n    if (savedState && typeof savedState.riskWeights === 'object') {\n      setRiskWeights(normalizeRiskWeighting(savedState.riskWeights));\n    }\n    if (Array.isArray(savedState.teams)) setTeams(savedState.teams);\n    if (Array.isArray(savedState.showcaseThemes)) setShowcaseThemes(savedState.showcaseThemes);\n    if (savedState && typeof savedState.projectFilters === 'object') {\n      setProjectFiltersState(normalizeProjectFilterConfig(savedState.projectFilters));\n    }\n    if (Array.isArray(savedState.inspirationProjects)) {\n      setInspirationProjects(cloneDeep(savedState.inspirationProjects));\n    }\n    if (savedState && typeof savedState.inspirationFilters === 'object') {\n      setInspirationFilters(normalizeInspirationFiltersConfig(savedState.inspirationFilters));\n    }\n    if (savedState && typeof savedState.inspirationFormFields === 'object') {\n      setInspirationFormFields(normalizeInspirationFormConfig(savedState.inspirationFormFields));\n    }\n\n    setIsHydrated(true);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    let disposed = false;\n\n    const updateStatus = () => {\n      if (disposed) {\n        return;\n      }\n      setIsTourGuideReady(Boolean(window.TourGuideClient));\n    };\n\n    updateStatus();\n\n    if (window.TourGuideClient) {\n      return () => {\n        disposed = true;\n      };\n    }\n\n    const intervalId = window.setInterval(() => {\n      if (window.TourGuideClient) {\n        updateStatus();\n        window.clearInterval(intervalId);\n      }\n    }, 500);\n\n    return () => {\n      disposed = true;\n      window.clearInterval(intervalId);\n    };\n  }, []);\n\n  const noop = useCallback(() => {}, []);\n\n  const computeDemoData = useCallback(() => {\n    const answers = cloneDeep(demoProjectAnswersSnapshot) || {};\n    const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n    const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    const relevantTeamsList = Array.isArray(teams)\n      ? teams.filter(team => (analysisResult?.teams || []).includes(team.id))\n      : [];\n    const timelineDetails = analysisResult?.timeline?.details || [];\n    const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n      ? answers.projectName.trim()\n      : 'Projet de démonstration';\n\n    return {\n      answers,\n      analysis: analysisResult,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      projectName,\n      relevantTeams: relevantTeamsList,\n      timelineDetails\n    };\n  }, [questions, riskLevelRules, riskWeights, rules, shouldShowQuestion, teams]);\n\n  const getDemoData = useCallback(() => {\n    if (!onboardingDemoDataRef.current) {\n      onboardingDemoDataRef.current = computeDemoData();\n    }\n\n    return onboardingDemoDataRef.current;\n  }, [computeDemoData]);\n\n  const buildOnboardingProjects = useCallback((demoData) => {\n    const baseAnswers = cloneDeep(demoData?.answers || demoProjectAnswersSnapshot || {});\n    const now = Date.now();\n\n    const createEntry = (config) => {\n      const offsetMs = typeof config.offsetMs === 'number' ? config.offsetMs : 0;\n      const timestamp = config.timestamp || new Date(now - offsetMs).toISOString();\n      const answersPatch = config.answers || {};\n      const answers = cloneDeep({ ...baseAnswers, ...answersPatch });\n      if (config.projectName) {\n        answers.projectName = config.projectName;\n      }\n\n      const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n        ? answers.projectName.trim()\n        : 'Projet sans nom';\n\n      const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n      const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n      const totalQuestions = visibleQuestions.length > 0 ? visibleQuestions.length : questions.length;\n      const answeredQuestions = visibleQuestions.filter(question => isAnswerProvided(answers[question.id])).length;\n      const status = config.status || 'draft';\n\n      return {\n        id: config.id,\n        projectName,\n        answers,\n        analysis: analysisResult,\n        status,\n        lastUpdated: config.lastUpdated || timestamp,\n        generatedAt: config.generatedAt || timestamp,\n        submittedAt: status === 'submitted' ? (config.submittedAt || timestamp) : undefined,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex:\n          typeof config.lastQuestionIndex === 'number'\n            ? config.lastQuestionIndex\n            : (status === 'submitted' && totalQuestions > 0\n              ? totalQuestions - 1\n              : Math.max(totalQuestions - 2, 0)),\n        isDemo: true\n      };\n    };\n\n    return [\n      createEntry({\n        id: 'tour-draft-1',\n        projectName: 'Atlas Connect',\n        status: 'draft',\n        offsetMs: 86400000,\n        answers: {\n          teamLead: 'Léa Martin',\n          teamLeadTeam: 'Digital'\n        }\n      }),\n      createEntry({\n        id: 'tour-submitted',\n        projectName: 'Pulse Live',\n        status: 'submitted',\n        offsetMs: 432000000,\n        answers: {\n          teamLead: 'Noah Carpentier',\n          teamLeadTeam: 'Marketing'\n        }\n      }),\n      createEntry({\n        id: 'tour-draft-demo',\n        projectName: demoData?.projectName || 'Plasma 360',\n        status: 'draft',\n        offsetMs: 172800000,\n        answers: {}\n      })\n    ];\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const restoreOnboardingSnapshot = useCallback(() => {\n    const snapshot = onboardingStateRef.current;\n    onboardingStateRef.current = null;\n    onboardingDemoDataRef.current = null;\n\n    if (!snapshot) {\n      setMode('user');\n      setAdminView('home');\n      setScreen('home');\n      setAnswers({});\n      setAnalysis(null);\n      setProjects(buildInitialProjectsState());\n      setProjectFiltersState(createDefaultProjectFiltersConfig());\n      setCurrentQuestionIndex(0);\n      setValidationError(null);\n      setSaveFeedback(null);\n      setActiveProjectId(null);\n      setShowcaseProjectContext(null);\n      setHasUnsavedChanges(false);\n      setBackOfficeAuthError(null);\n      setIsBackOfficeUnlocked(false);\n      return;\n    }\n\n    setMode(snapshot.mode || 'user');\n    setAdminView(snapshot.adminView || 'home');\n    setScreen(snapshot.screen || 'home');\n    setAnswers(snapshot.answers || {});\n    setAnalysis(typeof snapshot.analysis !== 'undefined' ? snapshot.analysis : null);\n    const restoredProjects = sanitizeRestoredProjects(snapshot.projects);\n    setProjects(\n      restoredProjects.length > 0\n        ? restoredProjects\n        : buildInitialProjectsState()\n    );\n    setProjectFiltersState(\n      snapshot.projectFilters\n        ? normalizeProjectFilterConfig(snapshot.projectFilters)\n        : createDefaultProjectFiltersConfig()\n    );\n    setCurrentQuestionIndex(\n      typeof snapshot.currentQuestionIndex === 'number' && snapshot.currentQuestionIndex >= 0\n        ? snapshot.currentQuestionIndex\n        : 0\n    );\n    setValidationError(snapshot.validationError || null);\n    setSaveFeedback(snapshot.saveFeedback || null);\n    setActiveProjectId(typeof snapshot.activeProjectId === 'string' ? snapshot.activeProjectId : null);\n    setShowcaseProjectContext(snapshot.showcaseProjectContext || null);\n    setHasUnsavedChanges(Boolean(snapshot.hasUnsavedChanges));\n    setBackOfficeAuthError(snapshot.backOfficeAuthError || null);\n    setIsBackOfficeUnlocked(Boolean(snapshot.isBackOfficeUnlocked));\n  }, [\n    setActiveProjectId,\n    setAdminView,\n    setAnalysis,\n    setAnswers,\n    setBackOfficeAuthError,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setIsBackOfficeUnlocked,\n    setMode,\n    setProjectFiltersState,\n    setProjects,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const finishOnboarding = useCallback((options = {}) => {\n    const { shouldLoadIndex = false } = options || {};\n    const snapshotExists = Boolean(onboardingStateRef.current);\n    const wasOnboardingActive = isOnboardingActiveRef.current;\n\n    if (!wasOnboardingActive && !snapshotExists) {\n      return;\n    }\n\n    isOnboardingActiveRef.current = false;\n    setIsOnboardingActive(false);\n    setOnboardingStepId(null);\n\n    const tourInstance = tourInstanceRef.current;\n    tourInstanceRef.current = null;\n\n    if (tourInstance && typeof tourInstance.stop === 'function') {\n      try {\n        tourInstance.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Impossible de stopper le guide :', error);\n        }\n      }\n    }\n\n    if (snapshotExists) {\n      restoreOnboardingSnapshot();\n    }\n\n    if (shouldLoadIndex && typeof window !== 'undefined') {\n      const redirect = () => {\n        try {\n          if (window.location) {\n            if (typeof window.location.assign === 'function') {\n              window.location.assign('./index.html');\n            } else {\n              window.location.href = './index.html';\n            }\n          }\n        } catch (error) {\n          if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n            console.warn('[Onboarding] Impossible de charger la page d\\'accueil :', error);\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => redirect());\n      } else if (typeof window.setTimeout === 'function') {\n        window.setTimeout(() => redirect(), 0);\n      }\n    }\n  }, [restoreOnboardingSnapshot]);\n\n  const handleOnboardingStepEnter = useCallback((stepId) => {\n    if (!stepId) {\n      return;\n    }\n\n    const demoData = getDemoData();\n\n    const openDemoShowcase = () => {\n      openProjectShowcase({\n        projectId: null,\n        projectName: demoData.projectName,\n        answers: cloneDeep(demoData.answers),\n        analysis: demoData.analysis,\n        relevantTeams: demoData.relevantTeams,\n        questions: demoData.questions,\n        timelineDetails: demoData.timelineDetails,\n        status: 'draft'\n      });\n      setHasUnsavedChanges(false);\n    };\n\n    const ensureShowcaseTopVisible = () => {\n      if (typeof window === 'undefined') {\n        return;\n      }\n\n      const scrollToTop = () => {\n        try {\n          if (typeof document !== 'undefined') {\n            const topSection = document.querySelector('[data-tour-id=\"showcase-preview\"]');\n            if (topSection && typeof topSection.scrollIntoView === 'function') {\n              topSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });\n              return;\n            }\n          }\n\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n          }\n        } catch (error) {\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0 });\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => {\n          if (typeof window.setTimeout === 'function') {\n            window.setTimeout(scrollToTop, 0);\n          } else {\n            scrollToTop();\n          }\n        });\n        return;\n      }\n\n      if (typeof window.setTimeout === 'function') {\n        window.setTimeout(scrollToTop, 0);\n        return;\n      }\n\n      scrollToTop();\n    };\n\n    switch (stepId) {\n      case 'welcome':\n      case 'create-project': {\n        setScreen('home');\n        setShowcaseProjectContext(null);\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'question-overview':\n      case 'question-guidance':\n      case 'project-save-anytime': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setCurrentQuestionIndex(0);\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'questionnaire-finish': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        const totalQuestionsCount = Array.isArray(demoData.questions) && demoData.questions.length > 0\n          ? demoData.questions.length\n          : questions.length;\n        const lastIndex = totalQuestionsCount > 0 ? totalQuestionsCount - 1 : 0;\n        setCurrentQuestionIndex(lastIndex);\n        break;\n      }\n      case 'compliance-report-top':\n      case 'compliance-teams':\n      case 'compliance-risks':\n      case 'compliance-submit':\n      case 'compliance-save':\n      case 'compliance-showcase-button': {\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(demoData.analysis);\n        setCurrentQuestionIndex(0);\n        setValidationError(null);\n        setScreen('synthesis');\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'showcase-top': {\n        openDemoShowcase();\n        ensureShowcaseTopVisible();\n        break;\n      }\n      case 'showcase-bottom':\n      case 'showcase-edit-trigger':\n      case 'showcase-edit':\n      case 'showcase-save-edits':\n      case 'showcase-back-to-report': {\n        openDemoShowcase();\n        break;\n      }\n      case 'project-import':\n      case 'project-filters': {\n        setShowcaseProjectContext(null);\n        setScreen('home');\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      default:\n        break;\n    }\n  }, [\n    getDemoData,\n    openProjectShowcase,\n    screen,\n    questions,\n    setActiveProjectId,\n    setAnalysis,\n    setAnswers,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError\n  ]);\n\n  const handleStartOnboarding = useCallback(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    if (typeof window === 'undefined' || typeof window.TourGuideClient !== 'function') {\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Le guide interactif est momentanément indisponible.');\n      }\n      return;\n    }\n\n    onboardingStateRef.current = {\n      mode,\n      screen,\n      adminView,\n      answers: cloneDeep(answers),\n      analysis: cloneDeep(analysis),\n      projects: cloneDeep(projects),\n      projectFilters: cloneDeep(projectFilters),\n      currentQuestionIndex,\n      validationError: cloneDeep(validationError),\n      saveFeedback: cloneDeep(saveFeedback),\n      activeProjectId,\n      showcaseProjectContext: cloneDeep(showcaseProjectContext),\n      hasUnsavedChanges,\n      backOfficeAuthError,\n      isBackOfficeUnlocked\n    };\n\n    const demoData = getDemoData();\n    onboardingDemoDataRef.current = demoData;\n    const onboardingProjects = buildOnboardingProjects(demoData);\n\n    isOnboardingActiveRef.current = true;\n    setIsOnboardingActive(true);\n    setOnboardingStepId(null);\n    setMode('user');\n    setAdminView('home');\n    setScreen('home');\n    setShowcaseProjectContext(null);\n    setActiveProjectId(null);\n    setAnswers({});\n    setAnalysis(null);\n    setValidationError(null);\n    setSaveFeedback(null);\n    setHasUnsavedChanges(false);\n    setBackOfficeAuthError(null);\n    setIsBackOfficeUnlocked(false);\n    setProjects(onboardingProjects);\n    setProjectFiltersState(createDefaultProjectFiltersConfig());\n\n    const steps = [\n      {\n        id: 'welcome',\n        target: '#tour-onboarding-anchor',\n        title: 'Bienvenue sur Project Navigator',\n        content: 'Découvrons ensemble comment cadrer votre projet pas à pas.'\n      },\n      {\n        id: 'create-project',\n        target: '[data-tour-id=\"home-create-project\"]',\n        title: 'Lancer un nouveau projet',\n        content: 'Cliquez ici pour démarrer. Nous allons utiliser un projet de démonstration pour l’exemple.',\n        placement: 'bottom'\n      },\n      {\n        id: 'question-overview',\n        target: '[data-tour-id=\"question-main-content\"]',\n        title: 'Répondre aux questions',\n        content: 'Renseignez les informations demandées étape par étape pour qualifier votre initiative.'\n      },\n      {\n        id: 'question-guidance',\n        target: '[data-tour-id=\"question-guidance-toggle\"]',\n        title: 'Comprendre chaque question',\n        content: 'Chaque étape propose des conseils contextualisés pour répondre sereinement.'\n      },\n      {\n        id: 'project-save-anytime',\n        target: '[data-tour-id=\"question-save-draft\"]',\n        title: 'Sauvegarder à tout moment',\n        content: \"Téléchargez un brouillon de votre projet quand vous le souhaitez et rechargez-le depuis l’accueil. Attention, il n'y a pas de sauvegarde automatique.\"\n      },\n      {\n        id: 'questionnaire-finish',\n        target: '[data-tour-id=\"questionnaire-finish\"]',\n        title: 'Fin du formulaire',\n        content: 'Sur la dernière question, cliquez sur “Voir la synthèse” pour accéder au rapport complet.'\n      },\n      {\n        id: 'compliance-report-top',\n        target: '[data-tour-id=\"synthesis-summary\"]',\n        title: 'Lire le rapport de compliance',\n        content: \"Retrouvez ici le résumé du projet avec l'ensemble des informations que vous avez remplies. Vous pouvez revenir en arrière pour les modifier.\",\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'start',\n          inline: 'nearest'\n        }\n      },\n      {\n        id: 'compliance-teams',\n        target: '[data-tour-id=\"synthesis-teams\"]',\n        title: 'Identifier les équipes compliance',\n        content: 'Visualisez les interlocuteurs clés, leurs priorités et les questions à anticiper pour préparer vos échanges.'\n      },\n      {\n        id: 'compliance-risks',\n        target: '[data-tour-id=\"synthesis-risks\"]',\n        title: 'Risques et points de vigilance',\n        content: 'Analysez les risques identifiés et les points de vigilance compliance à adresser en priorité.'\n      },\n      {\n        id: 'compliance-submit',\n        target: '[data-tour-id=\"synthesis-submit\"]',\n        title: 'Soumettre le projet',\n        content: 'Envoyez votre rapport directement par e-mail aux équipes concernées.'\n      },\n      {\n        id: 'compliance-save',\n        target: '[data-tour-id=\"synthesis-save\"]',\n        title: 'Sauvegarder depuis la synthèse',\n        content: 'Téléchargez le fichier du projet pour le partager ou le reprendre ultérieurement.'\n      },\n      {\n        id: 'compliance-showcase-button',\n        target: '[data-tour-id=\"synthesis-showcase\"]',\n        title: 'Ouvrir la vitrine du projet',\n        content: 'Accédez à la vitrine du projet générée automatiquement pour présenter votre initiative.'\n      },\n      {\n        id: 'showcase-top',\n        target: '[data-tour-id=\"showcase-hero\"]',\n        title: 'Présenter votre projet',\n        content:\n          'Parcourez la vitrine présentant votre projet avec une mise en page le mettant en valeur. Parfait pour une présentation à votre manager !',\n         scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 5200\n      },\n      {\n        id: 'showcase-bottom',\n        target: '[data-tour-id=\"showcase-preview-bottom\"]',\n        title: 'Explorer la suite de la vitrine',\n        content: 'Vous retrouvez sur la vitrine les jalons de votre projet mais également les alertes liées à des problématiques de respect de certains délais.',\n        scrollIntoViewOptions: {\n          behavior: 'smooth',\n          block: 'center',\n          inline: 'nearest'\n        },\n        scrollDuration: 3200\n      },\n      {\n        id: 'showcase-edit-trigger',\n        target: '[data-tour-id=\"showcase-edit-trigger\"]',\n        title: 'Modifier la vitrine',\n        content: 'Activez le mode édition pour ajuster les contenus avant diffusion.'\n      },\n      {\n        id: 'showcase-edit',\n        target: '[data-tour-id=\"showcase-edit-panel\"]',\n        title: 'Personnaliser la vitrine',\n        content: 'Adaptez textes, messages clés et jalons pour refléter fidèlement votre projet. Ses informations sont automatiquement mise à jour dans le rapport de compliance.'\n      },\n      {\n        id: 'showcase-save-edits',\n        target: '[data-tour-id=\"showcase-save-edits\"]',\n        title: 'Enregistrer les modifications',\n        content: 'Validez vos ajustements pour mettre à jour immédiatement la vitrine.'\n      },\n      {\n        id: 'showcase-back-to-report',\n        target: '[data-tour-id=\"showcase-back-to-report\"]',\n        title: 'Retourner à la synthèse',\n        content: 'Revenez au rapport de synthèse pour poursuivre votre préparation et éventuellement enregistrer la dernière version de votre projet.'\n      },\n      {\n        id: 'project-import',\n        target: '[data-tour-id=\"home-import-project\"]',\n        title: 'Charger un projet existant',\n        content: 'Vous pouvez importer un projet enregistrer pour reprendre son édition avant soumission à la compliance.'\n      },\n      {\n        id: 'project-filters',\n        target: '[data-tour-id=\"home-filters\"]',\n        title: 'Découvrir les projets',\n        content: 'Filtrez les initiatives par nom, équipe ou date et laissez vous inspirer.'\n      }\n    ];\n\n    const tour = new window.TourGuideClient({\n      steps,\n      labels: {\n        next: 'Suivant',\n        prev: 'Précédent',\n        close: 'Fermer',\n        finish: 'Terminer'\n      }\n    });\n\n    tour.on('stepChange', ({ step }) => {\n      const stepId = step?.id || null;\n      handleOnboardingStepEnter(stepId);\n      setOnboardingStepId(stepId);\n    });\n\n    tour.on('close', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.on('finish', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.start();\n    tourInstanceRef.current = tour;\n  }, [\n    isOnboardingActive,\n    mode,\n    screen,\n    adminView,\n    answers,\n    analysis,\n    projects,\n    projectFilters,\n    currentQuestionIndex,\n    validationError,\n    saveFeedback,\n    activeProjectId,\n    showcaseProjectContext,\n    hasUnsavedChanges,\n    backOfficeAuthError,\n    isBackOfficeUnlocked,\n    getDemoData,\n    buildOnboardingProjects,\n    handleOnboardingStepEnter,\n    finishOnboarding,\n    setMode,\n    setAdminView,\n    setScreen,\n    setShowcaseProjectContext,\n    setActiveProjectId,\n    setAnswers,\n    setAnalysis,\n    setValidationError,\n    setSaveFeedback,\n    setHasUnsavedChanges,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked,\n    setProjects,\n    setProjectFiltersState\n  ]);\n\n  useEffect(() => () => {\n    if (tourInstanceRef.current && typeof tourInstanceRef.current.stop === 'function') {\n      try {\n        tourInstanceRef.current.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Nettoyage du guide impossible :', error);\n        }\n      }\n    }\n    tourInstanceRef.current = null;\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!isHydrated || isOnboardingActive) return undefined;\n\n    if (persistTimeoutRef.current) {\n      clearTimeout(persistTimeoutRef.current);\n    }\n\n    persistTimeoutRef.current = setTimeout(() => {\n      const modeToPersist = mode === 'admin' ? 'user' : mode;\n\n      persistState({\n        mode: modeToPersist,\n        screen,\n        currentQuestionIndex,\n        answers,\n        analysis,\n        questions,\n        rules,\n        riskLevelRules,\n        riskWeights,\n        teams,\n        showcaseThemes,\n        projects,\n        activeProjectId,\n        projectFilters: normalizeProjectFilterConfig(projectFilters),\n        inspirationProjects,\n        inspirationFilters: normalizeInspirationFiltersConfig(inspirationFilters),\n        inspirationFormFields: normalizeInspirationFormConfig(inspirationFormFields),\n        homeView,\n        activeInspirationId\n      });\n      persistTimeoutRef.current = null;\n    }, 200);\n\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, [\n    mode,\n    screen,\n    currentQuestionIndex,\n    answers,\n    analysis,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    teams,\n    showcaseThemes,\n    projects,\n    activeProjectId,\n    projectFilters,\n    inspirationProjects,\n    inspirationFilters,\n    inspirationFormFields,\n    homeView,\n    activeInspirationId,\n    isHydrated,\n    isOnboardingActive\n  ]);\n\n  const tourContext = useMemo(\n    () => (isOnboardingActive ? { isActive: true, activeStep: onboardingStepId } : null),\n    [isOnboardingActive, onboardingStepId]\n  );\n\n  const activeQuestions = useMemo(\n    () => questions.filter(q => shouldShowQuestion(q, answers)),\n    [questions, answers]\n  );\n\n  const unansweredMandatoryQuestions = useMemo(\n    () =>\n      activeQuestions.filter(question => question.required && !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const pendingMandatoryQuestions = useMemo(\n    () =>\n      unansweredMandatoryQuestions.map(question => ({\n        question,\n        position: activeQuestions.findIndex(item => item.id === question.id) + 1\n      })),\n    [unansweredMandatoryQuestions, activeQuestions]\n  );\n\n  const hasIncompleteAnswers = useMemo(\n    () => activeQuestions.some(question => !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const teamLeadTeamOptions = useMemo(() => {\n    const leadTeamQuestion = questions.find(question => question?.id === 'teamLeadTeam');\n    if (!leadTeamQuestion || !Array.isArray(leadTeamQuestion.options)) {\n      return [];\n    }\n\n    const sanitized = leadTeamQuestion.options\n      .map(option => (typeof option === 'string' ? option.trim() : ''))\n      .filter(option => option.length > 0);\n\n    return Array.from(new Set(sanitized));\n  }, [questions]);\n\n  useEffect(() => {\n    if (!isHydrated) return;\n    if (activeQuestions.length === 0) return;\n    if (currentQuestionIndex >= activeQuestions.length) {\n      setCurrentQuestionIndex(activeQuestions.length - 1);\n    }\n  }, [activeQuestions.length, currentQuestionIndex, isHydrated]);\n\n  useEffect(() => {\n    if (screen !== 'questionnaire' && screen !== 'synthesis') {\n      setSaveFeedback(null);\n    }\n  }, [screen]);\n\n  const activeProject = useMemo(\n    () => projects.find(project => project.id === activeProjectId) || null,\n    [projects, activeProjectId]\n  );\n  const activeInspirationProject = useMemo(\n    () => inspirationProjects.find(project => project.id === activeInspirationId) || null,\n    [inspirationProjects, activeInspirationId]\n  );\n\n  const activeProjectName = useMemo(() => {\n    if (typeof activeProject?.projectName === 'string' && activeProject.projectName.trim().length > 0) {\n      return activeProject.projectName.trim();\n    }\n\n    return extractProjectName(answers, questions);\n  }, [activeProject, answers, questions]);\n\n  const activeShowcaseProjectId = showcaseProjectContext?.projectId || null;\n\n  const activeAnnotationContextKey = useMemo(\n    () => buildAnnotationContextKey({\n      screen,\n      projectId: activeShowcaseProjectId,\n      scope: showcaseAnnotationScope\n    }),\n    [activeShowcaseProjectId, screen, showcaseAnnotationScope]\n  );\n\n  const registerAnnotationSource = useCallback((sourceId, preferredColor) => {\n    if (!sourceId) {\n      return ANNOTATION_COLORS[0];\n    }\n\n    let resolvedColor = ANNOTATION_COLORS[0];\n\n    setAnnotationSources(prevSources => {\n      if (prevSources[sourceId]) {\n        resolvedColor = prevSources[sourceId];\n        return prevSources;\n      }\n\n      const usedColors = new Set(Object.values(prevSources));\n\n      if (preferredColor && !usedColors.has(preferredColor)) {\n        resolvedColor = preferredColor;\n      } else {\n        const availableColor = ANNOTATION_COLORS.find(color => !usedColors.has(color));\n        resolvedColor = availableColor || ANNOTATION_COLORS[0];\n      }\n\n      return { ...prevSources, [sourceId]: resolvedColor };\n    });\n\n    return resolvedColor;\n  }, []);\n\n  const resolveAnnotationTarget = useCallback((clientX, clientY, targetElement = null) => {\n    if (typeof document === 'undefined') {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const activeTarget = targetElement instanceof Element\n      ? targetElement\n      : document.elementFromPoint(clientX, clientY);\n\n    const sectionElement = activeTarget?.closest('[data-showcase-section]');\n\n    if (!sectionElement) {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const rect = sectionElement.getBoundingClientRect();\n    const sectionWidth = rect?.width || 1;\n    const sectionHeight = rect?.height || 1;\n\n    return {\n      sectionId: sectionElement.getAttribute('data-showcase-section') || null,\n      sectionX: clamp01((clientX - rect.left) / sectionWidth),\n      sectionY: clamp01((clientY - rect.top) / sectionHeight)\n    };\n  }, []);\n\n  const handleAddAnnotationNote = useCallback((clientX, clientY, targetElement = null) => {\n    if (screen !== 'showcase' || !showcaseProjectContext || isAnnotationPaused) {\n      return;\n    }\n\n    const width = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const height = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const x = clamp01(clientX / width);\n    const y = clamp01(clientY / height);\n    const sourceId = 'session';\n    const color = registerAnnotationSource(sourceId);\n    const { sectionId, sectionX, sectionY } = resolveAnnotationTarget(clientX, clientY, targetElement);\n\n    const newNoteId = createAnnotationId();\n\n    setAnnotationNotes(prevNotes => [\n      ...prevNotes,\n      {\n        id: newNoteId,\n        x,\n        y,\n        sectionId,\n        sectionX: sectionX ?? x,\n        sectionY: sectionY ?? y,\n        text: '',\n        color,\n        contextId: activeAnnotationContextKey,\n        projectId: showcaseProjectContext.projectId || 'unknown',\n        projectName: showcaseProjectContext.projectName || '',\n        sourceId\n      }\n    ]);\n    setAutoFocusAnnotationId(newNoteId);\n  }, [\n    activeAnnotationContextKey,\n    isAnnotationPaused,\n    registerAnnotationSource,\n    resolveAnnotationTarget,\n    screen,\n    showcaseProjectContext\n  ]);\n\n  const handleAnnotationTextChange = useCallback((noteId, text) => {\n    setAnnotationNotes(prevNotes => prevNotes.map(note => (\n      note?.id === noteId\n        ? { ...note, text }\n        : note\n    )));\n  }, []);\n\n  const handleRemoveAnnotationNote = useCallback((noteId) => {\n    setAnnotationNotes(prevNotes => prevNotes.filter(note => note?.id !== noteId));\n  }, []);\n\n  const handleToggleAnnotationMode = useCallback(() => {\n    setIsAnnotationModeEnabled(prev => {\n      const next = !prev;\n\n      if (!next) {\n        setIsAnnotationPaused(false);\n      }\n\n      return next;\n    });\n  }, []);\n\n  const handleToggleAnnotationPause = useCallback(() => {\n    setIsAnnotationPaused(prev => !prev);\n  }, []);\n\n  const downloadAnnotationFile = useCallback((notesToSave, projectName) => {\n    if (!Array.isArray(notesToSave) || notesToSave.length === 0 || typeof window === 'undefined') {\n      return;\n    }\n\n    const safeName = typeof projectName === 'string' && projectName.trim().length > 0\n      ? projectName.trim()\n      : 'projet';\n\n    const payload = JSON.stringify(notesToSave, null, 2);\n    const blob = new Blob([payload], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = `Commentaire sur le projet ${safeName}.json`;\n    anchor.click();\n    URL.revokeObjectURL(url);\n  }, []);\n\n  const handleSaveAnnotationNotes = useCallback(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    const projectNotes = annotationNotes.filter(note => note?.projectId === showcaseProjectContext.projectId);\n\n    if (projectNotes.length === 0) {\n      return;\n    }\n\n    downloadAnnotationFile(projectNotes, showcaseProjectContext.projectName);\n  }, [annotationNotes, downloadAnnotationFile, showcaseProjectContext]);\n\n  const handleRequestAnnotationFile = useCallback(() => {\n    if (annotationFileInputRef.current) {\n      annotationFileInputRef.current.value = '';\n      annotationFileInputRef.current.click();\n    }\n  }, []);\n\n  const handleAnnotationFileChange = useCallback((event) => {\n    const [file] = event?.target?.files || [];\n    const fileInput = event?.target;\n\n    if (!file) {\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = () => {\n      try {\n        const parsed = JSON.parse(reader.result || '[]');\n        const rawNotes = Array.isArray(parsed)\n          ? parsed\n          : Array.isArray(parsed?.notes)\n            ? parsed.notes\n            : [];\n\n        if (!Array.isArray(rawNotes) || rawNotes.length === 0) {\n          return;\n        }\n\n        const sourceId = file.name || `import-${Date.now()}`;\n        const sourceColor = registerAnnotationSource(sourceId);\n\n        const importedNotes = rawNotes.map(rawNote => {\n          const normalizedX = clamp01(rawNote?.x ?? 0);\n          const normalizedY = clamp01(rawNote?.y ?? 0);\n\n          return {\n            id: rawNote?.id || createAnnotationId(),\n            x: normalizedX,\n            y: normalizedY,\n            sectionId: typeof rawNote?.sectionId === 'string' ? rawNote.sectionId : null,\n            sectionX: clamp01(rawNote?.sectionX ?? normalizedX),\n            sectionY: clamp01(rawNote?.sectionY ?? normalizedY),\n            text: typeof rawNote?.text === 'string' ? rawNote.text : '',\n            color: sourceColor,\n            contextId: rawNote?.contextId || activeAnnotationContextKey,\n            projectId: rawNote?.projectId || showcaseProjectContext?.projectId || 'unknown',\n            projectName: rawNote?.projectName || showcaseProjectContext?.projectName || '',\n            sourceId\n          };\n        });\n\n        setAnnotationNotes(prevNotes => [...prevNotes, ...importedNotes]);\n      } catch (error) {\n        // Malformed file, ignore silently\n      } finally {\n        if (fileInput) {\n          fileInput.value = '';\n        }\n      }\n    };\n\n    reader.readAsText(file);\n  }, [activeAnnotationContextKey, registerAnnotationSource, showcaseProjectContext]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    if (!isAnnotationModeEnabled || isAnnotationPaused || screen !== 'showcase') {\n      return undefined;\n    }\n\n    const handleDocumentClick = (event) => {\n      const target = event?.target;\n\n      if (target instanceof Element && target.closest('[data-annotation-ui=\"true\"]')) {\n        return;\n      }\n\n      handleAddAnnotationNote(event.clientX, event.clientY, target);\n    };\n\n    window.addEventListener('click', handleDocumentClick, true);\n\n    return () => {\n      window.removeEventListener('click', handleDocumentClick, true);\n    };\n  }, [handleAddAnnotationNote, isAnnotationModeEnabled, isAnnotationPaused, screen]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return undefined;\n    }\n\n    const { projectName, projectId } = showcaseProjectContext;\n\n    return () => {\n      const projectNotes = (annotationNotesRef.current || []).filter(note => note?.projectId === projectId);\n\n      if (projectNotes.length > 0) {\n        downloadAnnotationFile(projectNotes, projectName);\n      }\n    };\n  }, [downloadAnnotationFile, showcaseProjectContext]);\n\n  const isAdminMode = mode === 'admin';\n  const isAdminHomeView = isAdminMode && adminView === 'home';\n  const isAdminBackOfficeView = isAdminMode && adminView === 'back-office';\n  const isActiveProjectEditable = isAdminMode || !activeProject || activeProject.status === 'draft';\n  const annotationOffsetClass = isAnnotationModeEnabled && screen === 'showcase'\n    ? 'pt-20 lg:pt-24'\n    : '';\n\n  const handleAnswer = useCallback((questionId, answer) => {\n    let answerChanged = false;\n    let nextAnswersSnapshot = null;\n\n    setAnswers(prevAnswers => {\n      const previousValue = prevAnswers[questionId];\n      if (!areAnswersEqual(previousValue, answer)) {\n        answerChanged = true;\n      }\n\n      const nextAnswers = { ...prevAnswers, [questionId]: answer };\n\n      const questionsToRemove = questions\n        .filter(q => !shouldShowQuestion(q, nextAnswers))\n        .map(q => q.id);\n\n      if (questionsToRemove.length === 0) {\n        if (answerChanged) {\n          nextAnswersSnapshot = nextAnswers;\n        }\n        return answerChanged ? nextAnswers : prevAnswers;\n      }\n\n      const sanitizedAnswers = { ...nextAnswers };\n      let removedExistingAnswer = false;\n      questionsToRemove.forEach(qId => {\n        if (Object.prototype.hasOwnProperty.call(sanitizedAnswers, qId)) {\n          if (Object.prototype.hasOwnProperty.call(prevAnswers, qId)) {\n            removedExistingAnswer = true;\n          }\n          delete sanitizedAnswers[qId];\n        }\n      });\n\n      if (!answerChanged) {\n        if (removedExistingAnswer) {\n          answerChanged = true;\n        } else {\n          const prevKeys = Object.keys(prevAnswers);\n          const nextKeys = Object.keys(sanitizedAnswers);\n          if (prevKeys.length !== nextKeys.length) {\n            answerChanged = true;\n          } else if (nextKeys.some(key => !areAnswersEqual(prevAnswers[key], sanitizedAnswers[key]))) {\n            answerChanged = true;\n          }\n        }\n      }\n\n      if (answerChanged) {\n        nextAnswersSnapshot = sanitizedAnswers;\n      }\n\n      return answerChanged ? sanitizedAnswers : prevAnswers;\n    });\n\n    if (!answerChanged || !nextAnswersSnapshot) {\n      setValidationError(prev => {\n        if (!prev) return null;\n        return prev.questionId === questionId ? null : prev;\n      });\n      return;\n    }\n\n    setHasUnsavedChanges(true);\n\n    const updatedAnalysis = Object.keys(nextAnswersSnapshot).length > 0\n      ? analyzeAnswers(nextAnswersSnapshot, rules, riskLevelRules, riskWeights)\n      : null;\n\n    setAnalysis(updatedAnalysis);\n\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswersSnapshot));\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => isAnswerProvided(nextAnswersSnapshot[question.id])).length\n      : Object.keys(nextAnswersSnapshot).length;\n    const inferredName = extractProjectName(nextAnswersSnapshot, questions);\n    const normalizedInferredName = typeof inferredName === 'string' ? inferredName.trim() : '';\n\n    if (activeProjectId && isActiveProjectEditable) {\n      setProjects(prevProjects => {\n        const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n        if (projectIndex === -1) {\n          return prevProjects;\n        }\n\n        const project = prevProjects[projectIndex];\n        if (!project) {\n          return prevProjects;\n        }\n\n        const canUpdateProject = project.status === 'draft' || isAdminMode;\n        if (!canUpdateProject) {\n          return prevProjects;\n        }\n\n        const totalQuestions = relevantQuestions.length > 0\n          ? relevantQuestions.length\n          : project.totalQuestions || questions.length || 0;\n        const sanitizedName = normalizedInferredName.length > 0\n          ? normalizedInferredName\n          : project.projectName;\n        const lastQuestionIndex = totalQuestions > 0\n          ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n          : project.lastQuestionIndex ?? 0;\n\n        const updatedProject = {\n          ...project,\n          answers: nextAnswersSnapshot,\n          analysis: updatedAnalysis,\n          projectName: sanitizedName,\n          totalQuestions,\n          answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n          lastQuestionIndex,\n          lastUpdated: new Date().toISOString()\n        };\n\n        const nextProjects = prevProjects.slice();\n        nextProjects[projectIndex] = updatedProject;\n        return nextProjects;\n      });\n    }\n\n    setValidationError(prev => {\n      if (!prev) return null;\n      return prev.questionId === questionId ? null : prev;\n    });\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion\n  ]);\n\n  const handleUpdateAnswers = useCallback((updates) => {\n    if (!isActiveProjectEditable) {\n      return;\n    }\n\n    let sanitizedResult = null;\n\n    setAnswers(prevAnswers => {\n      const { nextAnswers, changed } = applyAnswerUpdates(prevAnswers, updates, questions, shouldShowQuestion);\n      if (!changed) {\n        return prevAnswers;\n      }\n      sanitizedResult = nextAnswers;\n      return nextAnswers;\n    });\n\n    if (sanitizedResult) {\n      const updatedAnalysis = analyzeAnswers(sanitizedResult, rules, riskLevelRules, riskWeights);\n      setAnalysis(updatedAnalysis);\n      setValidationError(null);\n      setHasUnsavedChanges(true);\n\n      if (activeProjectId) {\n        setProjects(prevProjects => {\n          const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n          if (projectIndex === -1) {\n            return prevProjects;\n          }\n\n          const project = prevProjects[projectIndex];\n          if (!project) {\n            return prevProjects;\n          }\n\n          const canUpdateProject = project.status === 'draft' || isAdminMode;\n          if (!canUpdateProject) {\n            return prevProjects;\n          }\n\n          const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedResult));\n          const totalQuestions = relevantQuestions.length > 0\n            ? relevantQuestions.length\n            : project.totalQuestions || questions.length || 0;\n          const answeredQuestionsCount = relevantQuestions.length > 0\n            ? relevantQuestions.filter(question => isAnswerProvided(sanitizedResult[question.id])).length\n            : Object.keys(sanitizedResult).length;\n          const inferredName = extractProjectName(sanitizedResult, questions);\n          const sanitizedName = inferredName && inferredName.trim().length > 0\n            ? inferredName.trim()\n            : project.projectName;\n          const lastQuestionIndex = totalQuestions > 0\n            ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n            : project.lastQuestionIndex ?? 0;\n\n          const updatedProject = {\n            ...project,\n            answers: sanitizedResult,\n            analysis: updatedAnalysis,\n            projectName: sanitizedName,\n            totalQuestions,\n            answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n            lastQuestionIndex,\n            lastUpdated: new Date().toISOString()\n          };\n\n          const nextProjects = prevProjects.slice();\n          nextProjects[projectIndex] = updatedProject;\n          return nextProjects;\n        });\n      }\n    }\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const resetProjectState = useCallback(() => {\n    setAnswers({});\n    setCurrentQuestionIndex(0);\n    setAnalysis(null);\n    setValidationError(null);\n    setActiveProjectId(null);\n    setHasUnsavedChanges(false);\n    setReturnToSynthesisAfterEdit(false);\n  }, [setHasUnsavedChanges]);\n\n  const openBackOfficePrompt = useCallback(() => new Promise((resolve) => {\n    backOfficePromptResolverRef.current = resolve;\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    setIsBackOfficePromptOpen(true);\n  }), []);\n\n  const closeBackOfficePrompt = useCallback((result = false) => {\n    setIsBackOfficePromptOpen(false);\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    const resolver = backOfficePromptResolverRef.current;\n    backOfficePromptResolverRef.current = null;\n    if (typeof resolver === 'function') {\n      resolver(result);\n    }\n  }, []);\n\n  const handleBackOfficePromptSubmit = useCallback(async (event) => {\n    event.preventDefault();\n    const trimmed = backOfficePromptValue.trim();\n    if (!trimmed) {\n      setBackOfficePromptError('Veuillez saisir un mot de passe.');\n      return;\n    }\n\n    const isValid = await verifyBackOfficePassword(trimmed);\n\n    if (isValid) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      closeBackOfficePrompt(true);\n      return;\n    }\n\n    setIsBackOfficeUnlocked(false);\n    setBackOfficeAuthError('Mot de passe incorrect. Veuillez réessayer.');\n    setBackOfficePromptError('Mot de passe incorrect. Veuillez réessayer.');\n  }, [backOfficePromptValue, closeBackOfficePrompt]);\n\n  const requestAdminAccess = useCallback(async () => {\n    if (isAdminMode) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    if (isBackOfficeUnlocked) {\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    setBackOfficeAuthError(null);\n    return openBackOfficePrompt();\n  }, [\n    isAdminMode,\n    isBackOfficeUnlocked,\n    openBackOfficePrompt,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked\n  ]);\n\n  const handleBackOfficeClick = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('back-office');\n  }, [requestAdminAccess, setMode]);\n\n  const handleActivateAdminOnHome = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('home');\n    setScreen('home');\n  }, [requestAdminAccess, setMode, setScreen]);\n\n  const handleReturnToProjectMode = useCallback(() => {\n    setMode('user');\n    setAdminView('home');\n    setBackOfficeAuthError(null);\n  }, [setBackOfficeAuthError, setMode]);\n\n  const handleCreateNewProject = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleStartInspirationProject = useCallback(() => {\n    setScreen('inspiration-form');\n  }, []);\n\n  const handleSaveInspirationProject = useCallback((payload) => {\n    const project = {\n      id: createInspirationId(),\n      ...payload\n    };\n    setInspirationProjects((prev) => [project, ...(Array.isArray(prev) ? prev : [])]);\n    setHomeView('inspiration');\n    setScreen('home');\n  }, []);\n\n  const handleOpenInspirationProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n    setActiveInspirationId(projectId);\n    setScreen('inspiration-detail');\n  }, []);\n\n  const handleUpdateInspirationProject = useCallback((projectId, updates) => {\n    if (!projectId || !updates) {\n      return;\n    }\n\n    setInspirationProjects((prev) => (Array.isArray(prev) ? prev : []).map((project) => {\n      if (!project || project.id !== projectId) {\n        return project;\n      }\n\n      return { ...project, ...updates };\n    }));\n  }, []);\n\n  const handleImportProject = useCallback((file) => {\n    if (!file) {\n      return;\n    }\n\n    if (typeof FileReader === 'undefined') {\n      if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n        console.warn('[projectImport] FileReader API indisponible dans cet environnement.');\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Votre navigateur ne permet pas d\\'importer un projet depuis un fichier.');\n      }\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = (event) => {\n      try {\n        const content = typeof event?.target?.result === 'string' ? event.target.result : '';\n\n        if (!content) {\n          throw new Error('EMPTY_FILE');\n        }\n\n        const parsed = JSON.parse(content);\n        const projectData = parsed?.project && typeof parsed.project === 'object' ? parsed.project : parsed;\n\n        if (!projectData || typeof projectData !== 'object') {\n          throw new Error('INVALID_PROJECT');\n        }\n\n        const importedAnswers = projectData.answers && typeof projectData.answers === 'object'\n          ? projectData.answers\n          : {};\n        const importedAnalysis = projectData.analysis && typeof projectData.analysis === 'object'\n          ? projectData.analysis\n          : null;\n        const importedName = typeof projectData.name === 'string' ? projectData.name.trim() : '';\n        const projectName = importedName.length > 0 ? importedName : 'Projet importé';\n        const importedTotalQuestions = Array.isArray(projectData?.questionnaire?.questionIds)\n          ? projectData.questionnaire.questionIds.length\n          : undefined;\n\n        const entry = handleSaveProject({\n          id: `project-${Date.now()}`,\n          projectName,\n          answers: importedAnswers,\n          analysis: importedAnalysis,\n          status: 'draft',\n          totalQuestions: importedTotalQuestions,\n          lastQuestionIndex: 0\n        });\n\n        if (!entry) {\n          throw new Error('SAVE_FAILED');\n        }\n\n        const relevantQuestions = questions.filter(question => shouldShowQuestion(question, importedAnswers));\n        const missingMandatory = relevantQuestions.filter(question => question.required && !isAnswerProvided(importedAnswers[question.id]));\n        const firstMissingId = missingMandatory[0]?.id;\n        const derivedAnalysis = entry.analysis\n          || (Object.keys(importedAnswers).length > 0 ? analyzeAnswers(importedAnswers, rules, riskLevelRules, riskWeights) : null);\n\n        const nextIndex = firstMissingId\n          ? Math.max(relevantQuestions.findIndex(question => question.id === firstMissingId), 0)\n          : relevantQuestions.length > 0\n            ? Math.min(entry.lastQuestionIndex ?? 0, relevantQuestions.length - 1)\n            : 0;\n        const hasPendingMandatory = missingMandatory.length > 0;\n\n        setAnswers(importedAnswers);\n        setAnalysis(derivedAnalysis);\n        setCurrentQuestionIndex(nextIndex);\n        setValidationError(null);\n        setActiveProjectId(entry.id);\n        setScreen('synthesis');\n        setSaveFeedback({\n          status: 'success',\n          message: hasPendingMandatory\n            ? 'Projet importé. La synthèse est disponible. Complétez les questions obligatoires avant de soumettre.'\n            : 'Projet importé. La synthèse est disponible.'\n        });\n        setHasUnsavedChanges(false);\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.error === 'function') {\n          console.error('[projectImport] Impossible de charger le projet :', error);\n        }\n        if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n          window.alert('Le fichier sélectionné est invalide. Veuillez vérifier le JSON exporté.');\n        }\n      }\n    };\n\n    reader.onerror = () => {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Échec de la lecture du fichier :', reader.error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Impossible de lire le fichier sélectionné. Veuillez réessayer.');\n      }\n    };\n\n    try {\n      reader.readAsText(file, 'utf-8');\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Erreur inattendue lors de la lecture du fichier :', error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Une erreur est survenue lors de l\\'import du projet.');\n      }\n    }\n  }, [\n    handleSaveProject,\n    setHasUnsavedChanges,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    shouldShowQuestion,\n    analyzeAnswers\n  ]);\n\n  const navigateToSynthesis = useCallback(() => {\n    const result = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    setAnalysis(result);\n    setValidationError(null);\n    setReturnToSynthesisAfterEdit(false);\n    setScreen('synthesis');\n  }, [analyzeAnswers, answers, riskLevelRules, riskWeights, rules]);\n\n  const handleNext = useCallback(() => {\n    if (currentQuestionIndex < activeQuestions.length - 1) {\n      setCurrentQuestionIndex(currentQuestionIndex + 1);\n      setValidationError(null);\n      return;\n    }\n\n    navigateToSynthesis();\n  }, [activeQuestions, currentQuestionIndex, navigateToSynthesis]);\n\n  const handleBack = useCallback(() => {\n    if (currentQuestionIndex > 0) {\n      setCurrentQuestionIndex(currentQuestionIndex - 1);\n    }\n    setValidationError(null);\n  }, [currentQuestionIndex]);\n\n  const handleRestart = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleOpenProject = useCallback((projectId, options = {}) => {\n    if (!projectId) {\n      return;\n    }\n\n    const project = projects.find(item => item.id === projectId);\n    if (!project) {\n      return;\n    }\n\n    const projectAnswers = project.answers || {};\n    const derivedQuestions = questions.filter(q => shouldShowQuestion(q, projectAnswers));\n    const derivedAnalysis = Object.keys(projectAnswers).length > 0\n      ? analyzeAnswers(projectAnswers, rules, riskLevelRules, riskWeights)\n      : null;\n    const answeredQuestionsCount = derivedQuestions.length > 0\n      ? derivedQuestions.filter(question => isAnswerProvided(projectAnswers[question.id])).length\n      : Object.keys(projectAnswers).length;\n    const missingMandatory = derivedQuestions.filter(question => question.required && !isAnswerProvided(projectAnswers[question.id]));\n    const totalQuestions = derivedQuestions.length;\n    const rawIndex = typeof project.lastQuestionIndex === 'number' ? project.lastQuestionIndex : 0;\n    const sanitizedIndex = totalQuestions > 0 ? Math.min(Math.max(rawIndex, 0), totalQuestions - 1) : 0;\n    const firstMissingId = missingMandatory[0]?.id;\n    const missingIndex = firstMissingId\n      ? derivedQuestions.findIndex(question => question.id === firstMissingId)\n      : -1;\n    const startingIndex = missingIndex >= 0 ? missingIndex : project.status === 'draft' ? sanitizedIndex : 0;\n\n    setAnswers(projectAnswers);\n    setAnalysis(derivedAnalysis);\n    setCurrentQuestionIndex(startingIndex);\n    setValidationError(null);\n    setActiveProjectId(project.id);\n\n    setProjects(prevProjects => prevProjects.map(entry => {\n      if (entry.id !== project.id) {\n        return entry;\n      }\n\n      return {\n        ...entry,\n        analysis: derivedAnalysis,\n        totalQuestions,\n        answeredQuestions: Math.min(\n          answeredQuestionsCount,\n          totalQuestions || answeredQuestionsCount\n        ),\n        lastQuestionIndex: sanitizedIndex\n      };\n    }));\n\n    const forcedView = typeof options?.view === 'string' ? options.view : null;\n\n    let targetScreen = null;\n    if (forcedView === 'synthesis' || forcedView === 'questionnaire' || forcedView === 'mandatory-summary') {\n      targetScreen = forcedView;\n    }\n\n    if (!targetScreen) {\n      targetScreen = project.status === 'draft' ? 'questionnaire' : 'synthesis';\n    }\n\n    setScreen(targetScreen);\n    setHasUnsavedChanges(false);\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    setHasUnsavedChanges,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const handleDeleteProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.filter(project => project.id !== projectId));\n    setActiveProjectId(prev => (prev === projectId ? null : prev));\n  }, []);\n\n  const handleDuplicateProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      const sourceProject = prevProjects.find(project => project.id === projectId);\n      if (!sourceProject) {\n        return prevProjects;\n      }\n\n      const answersClone = sourceProject.answers && typeof sourceProject.answers === 'object'\n        ? JSON.parse(JSON.stringify(sourceProject.answers))\n        : {};\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, answersClone));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : typeof sourceProject.totalQuestions === 'number' && sourceProject.totalQuestions > 0\n          ? sourceProject.totalQuestions\n          : questions.length;\n\n      const answeredQuestionsCount = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(answersClone[question.id])).length\n        : typeof sourceProject.answeredQuestions === 'number'\n          ? Math.min(sourceProject.answeredQuestions, totalQuestions || sourceProject.answeredQuestions)\n          : Object.keys(answersClone).length;\n\n      const computedAnalysis = Object.keys(answersClone).length > 0\n        ? analyzeAnswers(answersClone, rules, riskLevelRules, riskWeights)\n        : null;\n\n      const baseName = typeof sourceProject.projectName === 'string' && sourceProject.projectName.trim().length > 0\n        ? sourceProject.projectName.trim()\n        : 'Projet sans nom';\n      const nameWithoutCopyPrefix = baseName.replace(/^\\[Copie\\]\\s*/i, '').trim();\n      const duplicateBaseName = nameWithoutCopyPrefix.length > 0 ? nameWithoutCopyPrefix : baseName;\n\n      const duplicateEntry = {\n        id: `project-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n        projectName: `[Copie] ${duplicateBaseName}`,\n        answers: answersClone,\n        analysis: computedAnalysis,\n        status: 'draft',\n        lastUpdated: new Date().toISOString(),\n        lastQuestionIndex: 0,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n      };\n\n      return [duplicateEntry, ...prevProjects];\n    });\n  }, [analyzeAnswers, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const openProjectShowcase = useCallback((context = {}) => {\n    const {\n      projectId = null,\n      projectName: providedProjectName,\n      status: providedStatus,\n      answers: providedAnswers,\n      analysis: providedAnalysis,\n      relevantTeams: providedRelevantTeams,\n      questions: providedQuestions,\n      timelineDetails: providedTimelineDetails\n    } = context || {};\n\n    const project = projectId ? projects.find(item => item.id === projectId) : null;\n    const answersSource = providedAnswers || project?.answers || {};\n    const visibleQuestions = Array.isArray(providedQuestions) && providedQuestions.length > 0\n      ? providedQuestions\n      : questions.filter(question => shouldShowQuestion(question, answersSource));\n    const computedAnalysis = providedAnalysis\n      || (Object.keys(answersSource).length > 0\n        ? analyzeAnswers(answersSource, rules, riskLevelRules, riskWeights)\n        : null);\n    const relevantTeamsList = Array.isArray(providedRelevantTeams) && providedRelevantTeams.length > 0\n      ? providedRelevantTeams\n      : teams.filter(team => (computedAnalysis?.teams || []).includes(team.id));\n    const timelineDetailsList = Array.isArray(providedTimelineDetails)\n      ? providedTimelineDetails\n      : computedAnalysis?.timeline?.details || [];\n\n    const normalizedProjectName = typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : (typeof project?.projectName === 'string' && project.projectName.trim().length > 0\n        ? project.projectName.trim()\n        : extractProjectName(answersSource, questions));\n\n    const resolvedProjectName = normalizedProjectName && normalizedProjectName.length > 0\n      ? normalizedProjectName\n      : 'Projet sans nom';\n    const resolvedStatus = providedStatus || project?.status || 'draft';\n\n    const answeredQuestionsCount = visibleQuestions.length > 0\n      ? visibleQuestions.filter(question => isAnswerProvided(answersSource[question.id])).length\n      : Object.keys(answersSource).length;\n\n    const hasShowcaseIncompleteAnswers = visibleQuestions.length > 0\n      ? visibleQuestions.some(question => !isAnswerProvided(answersSource[question.id]))\n      : Object.keys(answersSource).length === 0;\n\n    const totalQuestions = visibleQuestions.length > 0\n      ? visibleQuestions.length\n      : project?.totalQuestions || questions.length || 0;\n\n    if (projectId) {\n      setProjects(prevProjects => prevProjects.map(entry => {\n        if (entry.id !== projectId) {\n          return entry;\n        }\n\n        return {\n          ...entry,\n          analysis: computedAnalysis,\n          totalQuestions,\n          answeredQuestions: Math.min(\n            answeredQuestionsCount,\n            totalQuestions || answeredQuestionsCount\n          )\n        };\n      }));\n    }\n\n    setShowcaseProjectContext({\n      projectId: projectId || null,\n      projectName: resolvedProjectName,\n      status: resolvedStatus,\n      answers: answersSource,\n      analysis: computedAnalysis,\n      relevantTeams: relevantTeamsList,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      timelineDetails: timelineDetailsList,\n      hasIncompleteAnswers: hasShowcaseIncompleteAnswers\n    });\n    previousScreenRef.current = screen;\n    setScreen('showcase');\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    screen,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  useEffect(() => {\n    if (!isHydrated) {\n      return;\n    }\n\n    const pendingProjectId = pendingShowcaseProjectIdRef.current;\n    if (!pendingProjectId) {\n      return;\n    }\n\n    const matchingProject = projects.find(project => project?.id === pendingProjectId);\n    if (!matchingProject) {\n      return;\n    }\n\n    pendingShowcaseProjectIdRef.current = null;\n    openProjectShowcase({ projectId: pendingProjectId });\n  }, [isHydrated, openProjectShowcase, projects]);\n\n  const handleShowProjectShowcase = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    openProjectShowcase({ projectId });\n  }, [openProjectShowcase]);\n\n  const handleOpenActiveProjectShowcase = useCallback((payload = {}) => {\n    const projectId = payload?.projectId || activeProjectId || null;\n\n    openProjectShowcase({\n      ...payload,\n      projectId\n    });\n  }, [activeProjectId, openProjectShowcase]);\n\n  const handleCloseProjectShowcase = useCallback(() => {\n    setShowcaseProjectContext(null);\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('home');\n    }\n    previousScreenRef.current = null;\n  }, []);\n\n  const handleReturnToComplianceReport = useCallback(() => {\n    if (showcaseProjectContext?.projectId) {\n      const { projectId } = showcaseProjectContext;\n      setShowcaseProjectContext(null);\n      previousScreenRef.current = null;\n      handleOpenProject(projectId, { view: 'synthesis' });\n      return;\n    }\n\n    setShowcaseProjectContext(null);\n\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('synthesis');\n    }\n\n    previousScreenRef.current = null;\n  }, [handleOpenProject, showcaseProjectContext, setScreen]);\n\n  const handleUpdateProjectShowcaseAnswers = useCallback((updates) => {\n    if (\n      !showcaseProjectContext ||\n      !showcaseProjectContext.projectId ||\n      (showcaseProjectContext.status !== 'draft' && !isAdminMode)\n    ) {\n      return;\n    }\n\n    const projectId = showcaseProjectContext.projectId;\n    let contextPatch = null;\n    let hasProjectChanges = false;\n\n    setProjects(prevProjects => {\n      const project = prevProjects.find(entry => entry.id === projectId);\n      if (!project || (project.status !== 'draft' && !isAdminMode)) {\n        return prevProjects;\n      }\n\n      const { nextAnswers, changed } = applyAnswerUpdates(\n        project.answers || {},\n        updates,\n        questions,\n        shouldShowQuestion,\n        {\n          shouldPreserveQuestion: (question) => !question?.showcase\n        }\n      );\n      if (!changed) {\n        return prevProjects;\n      }\n\n      hasProjectChanges = true;\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswers));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : project.totalQuestions || questions.length || 0;\n      const answeredQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(nextAnswers[question.id])).length\n        : Object.keys(nextAnswers).length;\n\n      const updatedAnalysis = analyzeAnswers(nextAnswers, rules, riskLevelRules, riskWeights);\n      const timelineDetails = updatedAnalysis?.timeline?.details || [];\n      const relevantTeamsIds = Array.isArray(updatedAnalysis?.teams) ? updatedAnalysis.teams : [];\n      const relevantTeams = teams.filter(team => relevantTeamsIds.includes(team.id));\n      const inferredName = extractProjectName(nextAnswers, questions);\n      const sanitizedName = inferredName && inferredName.trim().length > 0\n        ? inferredName.trim()\n        : project.projectName;\n\n      const lastQuestionIndex = totalQuestions > 0\n        ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n        : project.lastQuestionIndex ?? 0;\n\n      contextPatch = {\n        projectName: sanitizedName,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        relevantTeams,\n        timelineDetails,\n        questions: relevantQuestions.length > 0 ? relevantQuestions : null\n      };\n\n      const now = new Date().toISOString();\n\n      const updatedProject = {\n        ...project,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        projectName: sanitizedName,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex,\n        lastUpdated: now\n      };\n\n      return [updatedProject, ...prevProjects.filter(entry => entry.id !== projectId)];\n    });\n\n    if (contextPatch) {\n      setShowcaseProjectContext(prev => {\n        if (!prev || prev.projectId !== projectId) {\n          return prev;\n        }\n\n        return {\n          ...prev,\n          ...contextPatch,\n          questions: contextPatch.questions ? contextPatch.questions : prev.questions\n        };\n      });\n    }\n\n    if (hasProjectChanges) {\n      setHasUnsavedChanges(true);\n    }\n  }, [\n    analyzeAnswers,\n    extractProjectName,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    showcaseProjectContext,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  const upsertProject = useCallback((entry) => {\n    return prevProjects => {\n      if (!entry || !entry.id) {\n        return prevProjects;\n      }\n\n      const filtered = prevProjects.filter(project => project.id !== entry.id);\n      return [entry, ...filtered];\n    };\n  }, []);\n\n  const handleSaveProject = useCallback((payload = {}) => {\n    const baseAnswers = payload.answers && typeof payload.answers === 'object' ? payload.answers : answers;\n    const sanitizedAnswers = baseAnswers || {};\n    const status = payload.status === 'submitted' ? 'submitted' : 'draft';\n    const projectId = activeProjectId || payload.id || `project-${Date.now()}`;\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedAnswers));\n    const computedTotalQuestions = payload.totalQuestions\n      || (relevantQuestions.length > 0 ? relevantQuestions.length : activeQuestions.length);\n    const totalQuestions = computedTotalQuestions > 0 ? computedTotalQuestions : activeQuestions.length;\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => {\n        const value = sanitizedAnswers[question.id];\n        if (Array.isArray(value)) {\n          return value.length > 0;\n        }\n        if (typeof value === 'string') {\n          return value.trim().length > 0;\n        }\n        return value !== null && value !== undefined;\n      }).length\n      : Object.keys(sanitizedAnswers).length;\n    const now = new Date().toISOString();\n\n    let computedAnalysis = null;\n    if (payload.analysis && typeof payload.analysis === 'object') {\n      computedAnalysis = payload.analysis;\n    } else if (Object.keys(sanitizedAnswers).length > 0) {\n      computedAnalysis = analyzeAnswers(sanitizedAnswers, rules, riskLevelRules, riskWeights);\n    }\n\n    if (status === 'submitted' && !computedAnalysis) {\n      return null;\n    }\n\n    const inferredName = extractProjectName(sanitizedAnswers, questions);\n    const projectNameRaw = typeof payload.projectName === 'string' ? payload.projectName : inferredName;\n    const sanitizedName =\n      projectNameRaw && projectNameRaw.trim().length > 0 ? projectNameRaw.trim() : 'Projet sans nom';\n\n    let lastQuestionIndex =\n      typeof payload.lastQuestionIndex === 'number' ? payload.lastQuestionIndex : currentQuestionIndex;\n    if (status === 'submitted' && totalQuestions > 0) {\n      lastQuestionIndex = totalQuestions - 1;\n    }\n\n    const clampedLastIndex = totalQuestions > 0\n      ? Math.min(Math.max(lastQuestionIndex, 0), totalQuestions - 1)\n      : 0;\n\n    const entry = {\n      id: projectId,\n      projectName: sanitizedName,\n      answers: sanitizedAnswers,\n      analysis: computedAnalysis,\n      status,\n      lastUpdated: now,\n      lastQuestionIndex: clampedLastIndex,\n      totalQuestions,\n      answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount)\n    };\n\n    if (status === 'submitted') {\n      entry.submittedAt = now;\n    }\n\n    setProjects(upsertProject(entry));\n    setActiveProjectId(projectId);\n\n    if (computedAnalysis) {\n      setAnalysis(computedAnalysis);\n    }\n\n    setHasUnsavedChanges(false);\n\n    return entry;\n  }, [\n    activeProjectId,\n    activeQuestions.length,\n    analyzeAnswers,\n    answers,\n    currentQuestionIndex,\n    extractProjectName,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion,\n    upsertProject\n  ]);\n\n  const handleSubmitProject = useCallback((payload = {}) => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      setSaveFeedback({\n        status: 'error',\n        message: 'Impossible de soumettre : complétez les questions obligatoires avant l’envoi.'\n      });\n      setScreen('synthesis');\n      return null;\n    }\n\n    const entry = handleSaveProject({ ...payload, status: 'submitted' });\n    if (entry) {\n      setValidationError(null);\n      setScreen('home');\n    }\n  }, [handleSaveProject, unansweredMandatoryQuestions]);\n\n  const handleSaveDraft = useCallback((payload = {}) => {\n    const { lastQuestionIndex: payloadLastQuestionIndex, ...otherPayload } = payload || {};\n\n    const entry = handleSaveProject({\n      ...otherPayload,\n      lastQuestionIndex:\n        typeof payloadLastQuestionIndex === 'number'\n          ? payloadLastQuestionIndex\n          : currentQuestionIndex,\n      status: 'draft'\n    });\n\n    if (entry) {\n      setValidationError(null);\n\n      const exported = exportProjectToFile({\n        projectName: entry.projectName,\n        answers: entry.answers\n      });\n\n      setSaveFeedback(\n        exported\n          ? {\n              status: 'success',\n              message: 'Votre projet a bien été enregistré dans vos téléchargements'\n            }\n          : {\n              status: 'error',\n              message: 'Projet enregistré mais le téléchargement a échoué. Veuillez réessayer.'\n            }\n      );\n    }\n  }, [currentQuestionIndex, handleSaveProject]);\n\n  const handleDismissSaveFeedback = useCallback(() => {\n    setSaveFeedback(null);\n  }, []);\n\n  const handleBackToQuestionnaire = useCallback(() => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      const firstMissingId = unansweredMandatoryQuestions[0].id;\n      const targetIndex = activeQuestions.findIndex(question => question.id === firstMissingId);\n      if (targetIndex >= 0) {\n        setCurrentQuestionIndex(targetIndex);\n      }\n    } else if (activeQuestions.length > 0) {\n      const lastIndex = activeQuestions.length - 1;\n      setCurrentQuestionIndex(prevIndex => {\n        if (prevIndex > lastIndex) {\n          return lastIndex;\n        }\n        return prevIndex;\n      });\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions, unansweredMandatoryQuestions]);\n\n  const handleNavigateToQuestion = useCallback((questionId) => {\n    const targetIndex = activeQuestions.findIndex(question => question.id === questionId);\n    if (targetIndex >= 0) {\n      setCurrentQuestionIndex(targetIndex);\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions]);\n\n  const handleNavigateToQuestionFromReport = useCallback((questionId) => {\n    setReturnToSynthesisAfterEdit(true);\n    handleNavigateToQuestion(questionId);\n  }, [handleNavigateToQuestion]);\n\n  const handleReturnToSynthesisFromQuestionnaire = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const handleProceedToSynthesis = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const showcaseProjectId = showcaseProjectContext?.projectId || '';\n  const showcaseShareUrl = useMemo(() => {\n    if (!showcaseProjectId || typeof window === 'undefined') {\n      return '';\n    }\n\n    const url = new URL(window.location.href);\n    url.searchParams.set('projectId', showcaseProjectId);\n    url.hash = 'showcase';\n    return url.toString();\n  }, [showcaseProjectId]);\n\n  const handleOpenShowcaseShare = useCallback(() => {\n    if (!showcaseProjectId) {\n      return;\n    }\n\n    setIsShowcaseShareOpen(true);\n    setShowcaseShareFeedback('');\n  }, [showcaseProjectId]);\n\n  const handleCloseShowcaseShare = useCallback(() => {\n    setIsShowcaseShareOpen(false);\n    setShowcaseShareFeedback('');\n  }, []);\n\n  const handleCopyShowcaseLink = useCallback(async () => {\n    if (!showcaseShareUrl) {\n      return;\n    }\n\n    try {\n      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n        await navigator.clipboard.writeText(showcaseShareUrl);\n        setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n        return;\n      }\n    } catch (error) {\n      // Fallback below.\n    }\n\n    if (typeof document !== 'undefined') {\n      const input = document.getElementById('showcase-share-link');\n      if (input && typeof input.select === 'function') {\n        input.select();\n        const copied = document.execCommand && document.execCommand('copy');\n        if (copied) {\n          setShowcaseShareFeedback('Lien copié dans le presse-papiers.');\n          return;\n        }\n      }\n    }\n\n    setShowcaseShareFeedback('Impossible de copier automatiquement le lien.');\n  }, [showcaseShareUrl]);\n\n  const handleDownloadShowcaseShortcut = useCallback(() => {\n    if (!showcaseShareUrl || typeof window === 'undefined') {\n      return;\n    }\n\n    const shortcutContent = `[InternetShortcut]\\nURL=${showcaseShareUrl}\\n`;\n    const blob = new Blob([shortcutContent], { type: 'text/plain' });\n    const fileName = `raccourci-showcase-${showcaseProjectId || 'projet'}.url`;\n    const downloadUrl = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n\n    anchor.href = downloadUrl;\n    anchor.download = fileName;\n    document.body.appendChild(anchor);\n    anchor.click();\n    anchor.remove();\n    URL.revokeObjectURL(downloadUrl);\n    setShowcaseShareFeedback('Raccourci téléchargé.');\n  }, [showcaseProjectId, showcaseShareUrl]);\n\n  return (\n    <div className={`min-h-screen ${annotationOffsetClass}`}>\n      <AnnotationLayer\n        isActive={isAnnotationModeEnabled && screen === 'showcase'}\n        isPaused={isAnnotationPaused}\n        isEditing={isShowcaseEditing}\n        notes={annotationNotes}\n        activeContextId={activeAnnotationContextKey}\n        sourceColors={annotationSources}\n        projectName={showcaseProjectContext?.projectName || ''}\n        autoFocusNoteId={autoFocusAnnotationId}\n        onAutoFocusComplete={() => setAutoFocusAnnotationId(null)}\n        onTogglePause={handleToggleAnnotationPause}\n        onRequestSave={handleSaveAnnotationNotes}\n        onRequestLoad={handleRequestAnnotationFile}\n        onExit={handleToggleAnnotationMode}\n        onNoteChange={handleAnnotationTextChange}\n        onNoteRemove={handleRemoveAnnotationNote}\n      />\n\n      <input\n        ref={annotationFileInputRef}\n        type=\"file\"\n        accept=\"application/json\"\n        className=\"sr-only\"\n        onChange={handleAnnotationFileChange}\n        data-annotation-ui=\"true\"\n      />\n\n      <div id=\"tour-onboarding-anchor\" className=\"sr-only\" aria-hidden=\"true\">\n        Guide interactif\n      </div>\n      <nav className=\"bg-white shadow-sm border-b border-gray-200 hv-surface\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-8 py-4\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-lg font-bold text-gray-800 sm:text-xl\">Project Navigator</h1>\n                <p className=\"text-xs text-gray-500\">Outil d'aide à la décision</p>\n              </div>\n            </div>\n\n            <div\n              className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 lg:justify-end\"\n              role=\"group\"\n              aria-label=\"Sélection du mode d'utilisation\"\n            >\n              {screen === 'showcase' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleToggleAnnotationMode}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      isAnnotationModeEnabled ? 'bg-blue-50 border-blue-200' : 'bg-white border-blue-100'\n                    }`}\n                    aria-pressed={isAnnotationModeEnabled}\n                    aria-label={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    title={isAnnotationModeEnabled ? 'Désactiver le mode annotation' : 'Activer le mode annotation'}\n                    data-annotation-ui=\"true\"\n                  >\n                    <MessageSquare className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Annotation</span>\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleOpenShowcaseShare}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex min-h-[44px] h-11 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      showcaseProjectId ? 'bg-white border-blue-100' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'\n                    }`}\n                    aria-label=\"Partager la vitrine du projet\"\n                    title={showcaseProjectId ? 'Partager la vitrine du projet' : 'Aucun projet vitrine disponible'}\n                    disabled={!showcaseProjectId}\n                  >\n                    <Link className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Partager</span>\n                  </button>\n                </>\n              )}\n              {mode === 'user' && screen === 'showcase' && showcaseProjectContext && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToComplianceReport}\n                  className=\"w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-blue-600 text-white hv-button-primary\"\n                  aria-label=\"Revenir à la synthèse du projet\"\n                  title=\"Revenir à la synthèse du projet\"\n                  data-tour-id=\"showcase-back-to-report\"\n                >\n                  Synthèse\n                </button>\n              )}\n              {mode === 'user' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleStartOnboarding}\n                    className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-2 ${\n                      isOnboardingActive\n                        ? 'bg-blue-600 text-white hv-button-primary'\n                        : isTourGuideReady\n                          ? 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 hv-focus-ring'\n                          : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'\n                    }`}\n                    disabled={!isTourGuideReady || isOnboardingActive}\n                    data-tour-id=\"nav-onboarding-trigger\"\n                    aria-label=\"Lancer le guide interactif\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Guide interactif</span>\n                  </button>\n                  {screen !== 'home' && (\n                    <button\n                      type=\"button\"\n                      onClick={() => setScreen('home')}\n                      className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-gray-100 text-gray-700 hover:bg-gray-200`}\n                      aria-pressed={false}\n                      aria-label=\"Retourner à l'accueil des projets\"\n                    >\n                      Accueil projets\n                    </button>\n                  )}\n                  <a\n                    href=\"https://forms.office.com/e/p6PYB1gbpM\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button text-white bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 hover:from-pink-600 hover:via-red-600 hover:to-yellow-600 focus-visible:ring-pink-400 hv-focus-ring\"\n                    aria-label=\"Partagez votre avis sur Project Navigator (nouvelle fenêtre)\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Partagez votre avis</span>\n                  </a>\n                </>\n              )}\n              {mode === 'admin' && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToProjectMode}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button ${\n                    mode === 'user'\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={mode === 'user'}\n                  aria-label=\"Basculer vers le mode chef de projet\"\n                >\n                  Mode Chef de Projet\n                </button>\n              )}\n              {!isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleActivateAdminOnHome}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center ${\n                    isAdminHomeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminHomeView}\n                  aria-label=\"Activer le mode administrateur sur la page d'accueil\"\n                  title=\"Activer le mode administrateur sur l'accueil\"\n                >\n                  <Lock className=\"text-lg sm:text-xl\" />\n                  <span className=\"sr-only\">Mode Administrateur (Accueil)</span>\n                </button>\n              )}\n              {isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleBackOfficeClick}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-3 ${\n                    isAdminBackOfficeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminBackOfficeView}\n                  aria-label=\"Accéder au Back-office\"\n                  title=\"Accéder au Back-office\"\n                >\n                  <span>Accéder au Back-office</span>\n                  <Settings className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                </button>\n              )}\n              {backOfficeAuthError && (\n                <p className=\"w-full text-sm text-red-600 sm:w-auto\" role=\"alert\">\n                  {backOfficeAuthError}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      {isShowcaseShareOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"showcase-share-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"text-center\">\n              <h2 id=\"showcase-share-title\" className=\"text-xl font-semibold text-gray-800\">\n                Partager la vitrine du projet\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Copiez le lien ou téléchargez un raccourci pour ouvrir directement cette vitrine.\n              </p>\n            </div>\n            <div className=\"space-y-3\">\n              <label htmlFor=\"showcase-share-link\" className=\"text-sm font-medium text-gray-700\">\n                Lien à partager\n              </label>\n              <input\n                id=\"showcase-share-link\"\n                type=\"text\"\n                value={showcaseShareUrl}\n                readOnly\n                className=\"w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-800\"\n              />\n              {showcaseShareFeedback && (\n                <p className=\"text-sm text-blue-600\">{showcaseShareFeedback}</p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCopyShowcaseLink}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Copier le lien\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadShowcaseShortcut}\n                className=\"px-5 py-2 bg-white text-blue-700 font-medium rounded-lg border border-blue-200 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button\"\n              >\n                Télécharger le raccourci\n              </button>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCloseShowcaseShare}\n                className=\"text-sm text-gray-500 hover:text-gray-700\"\n              >\n                Fermer\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {isBackOfficePromptOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"backoffice-auth-title\"\n        >\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={() => closeBackOfficePrompt(false)} aria-hidden=\"true\" />\n          <form\n            onSubmit={handleBackOfficePromptSubmit}\n            className=\"relative w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl hv-surface\"\n          >\n            <div className=\"text-center\">\n              <h2 id=\"backoffice-auth-title\" className=\"text-xl font-semibold text-gray-800\">\n                Accès back-office\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Saisissez le mot de passe administrateur pour continuer.\n              </p>\n            </div>\n            <div className=\"mt-5 space-y-3\">\n              <label htmlFor=\"backoffice-password\" className=\"text-sm font-medium text-gray-700\">\n                Mot de passe\n              </label>\n              <input\n                id=\"backoffice-password\"\n                type=\"password\"\n                value={backOfficePromptValue}\n                onChange={(event) => setBackOfficePromptValue(event.target.value)}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                placeholder=\"Mot de passe\"\n              />\n              {backOfficePromptError && (\n                <p className=\"text-sm text-red-600\" role=\"alert\">\n                  {backOfficePromptError}\n                </p>\n              )}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={() => closeBackOfficePrompt(false)}\n                className=\"px-5 py-2 bg-white text-gray-700 font-medium rounded-lg border border-gray-200 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700\"\n              >\n                Déverrouiller\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n\n      <main id=\"main-content\" tabIndex=\"-1\" className=\"focus:outline-none hv-background\">\n        {!isHydrated ? (\n          <div className=\"flex min-h-[60vh] items-center justify-center\">\n            <LoadingFallback\n              label=\"Chargement de l’accueil…\"\n              hint=\"Préparation de votre espace.\"\n            />\n          </div>\n        ) : isAdminBackOfficeView ? (\n          <Suspense\n            fallback={(\n              <LoadingFallback\n                label=\"Chargement du back-office…\"\n                hint=\"Préparation des données administratives en cours.\"\n              />\n            )}\n          >\n            <LazyBackOffice\n              projects={projects}\n              questions={questions}\n              setQuestions={setQuestions}\n              rules={rules}\n              setRules={setRules}\n              riskLevelRules={riskLevelRules}\n              setRiskLevelRules={setRiskLevelRules}\n              riskWeights={riskWeights}\n              setRiskWeights={setRiskWeights}\n              teams={teams}\n              setTeams={setTeams}\n              showcaseThemes={showcaseThemes}\n              setShowcaseThemes={setShowcaseThemes}\n              projectFilters={projectFilters}\n              setProjectFilters={updateProjectFilters}\n              inspirationFilters={inspirationFilters}\n              setInspirationFilters={updateInspirationFilters}\n              inspirationFormFields={inspirationFormFields}\n              setInspirationFormFields={updateInspirationFormFields}\n            />\n          </Suspense>\n        ) : screen === 'home' ? (\n          <HomeScreen\n            projects={projects}\n            projectFilters={projectFilters}\n            teamLeadOptions={teamLeadTeamOptions}\n            inspirationProjects={inspirationProjects}\n            inspirationFilters={inspirationFilters}\n            homeView={homeView}\n            onHomeViewChange={setHomeView}\n            onStartInspirationProject={handleStartInspirationProject}\n            onOpenInspirationProject={handleOpenInspirationProject}\n            onStartNewProject={handleCreateNewProject}\n            onOpenProject={handleOpenProject}\n            onDeleteProject={handleDeleteProject}\n            onShowProjectShowcase={handleShowProjectShowcase}\n            onImportProject={handleImportProject}\n            onDuplicateProject={handleDuplicateProject}\n            isAdminMode={isAdminMode}\n            tourContext={tourContext}\n          />\n        ) : screen === 'inspiration-form' ? (\n          <InspirationForm\n            formConfig={inspirationFormFields}\n            existingProjects={inspirationProjects}\n            onSubmit={handleSaveInspirationProject}\n            onCancel={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n          />\n        ) : screen === 'inspiration-detail' ? (\n          <InspirationDetail\n            project={activeInspirationProject}\n            formConfig={inspirationFormFields}\n            onBack={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n            onUpdate={handleUpdateInspirationProject}\n          />\n        ) : screen === 'questionnaire' ? (\n          <QuestionnaireScreen\n            questions={activeQuestions}\n            currentIndex={currentQuestionIndex}\n            answers={answers}\n            onAnswer={handleAnswer}\n            onNext={handleNext}\n            onBack={handleBack}\n            allQuestions={questions}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onSaveDraft={isOnboardingActive ? noop : handleSaveDraft}\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            validationError={validationError}\n            onReturnToSynthesis={\n              returnToSynthesisAfterEdit ? handleReturnToSynthesisFromQuestionnaire : undefined\n            }\n            isReturnToSynthesisRequested={returnToSynthesisAfterEdit}\n            tourContext={tourContext}\n            onFinish={navigateToSynthesis}\n          />\n        ) : screen === 'mandatory-summary' ? (\n          <MandatoryQuestionsSummary\n            pendingQuestions={pendingMandatoryQuestions}\n            totalQuestions={activeQuestions.length}\n            onBackToQuestionnaire={handleBackToQuestionnaire}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onProceedToSynthesis={handleProceedToSynthesis}\n          />\n        ) : screen === 'synthesis' ? (\n          <SynthesisReport\n            answers={answers}\n            analysis={analysis}\n            teams={teams}\n            questions={activeQuestions}\n            projectStatus={activeProject?.status || null}\n            projectId={activeProjectId}\n            projectName={activeProjectName}\n            onOpenProjectShowcase={handleOpenActiveProjectShowcase}\n            isProjectEditable={isActiveProjectEditable}\n            onRestart={handleRestart}\n            onBack={isActiveProjectEditable ? handleBackToQuestionnaire : undefined}\n            onUpdateAnswers={isActiveProjectEditable ? handleUpdateAnswers : undefined}\n            onSubmitProject={handleSubmitProject}\n            onNavigateToQuestion={handleNavigateToQuestionFromReport}\n            isExistingProject={Boolean(activeProjectId)}\n            onSaveDraft={\n              isOnboardingActive\n                ? noop\n                : isActiveProjectEditable\n                  ? handleSaveDraft\n                  : undefined\n            }\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            isAdminMode={isAdminMode}\n            hasIncompleteAnswers={hasIncompleteAnswers}\n            tourContext={tourContext}\n          />\n        ) : screen === 'showcase' ? (\n          showcaseProjectContext ? (\n            <div className=\"space-y-4\">\n              {showcaseProjectContext.status !== 'draft' && (\n                <div className=\"rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800 hv-surface\">\n                  {isAdminMode\n                    ? 'Ce projet a été soumis. Vous pouvez le modifier car vous êtes en mode administrateur.'\n                    : 'Ce projet a été soumis. La vitrine est consultable en lecture seule.'}\n                </div>\n              )}\n              <Suspense\n                fallback={(\n                  <LoadingFallback\n                    label=\"Chargement de la vitrine du projet…\"\n                    hint=\"Nous construisons la synthèse visuelle du projet.\"\n                  />\n                )}\n              >\n                <LazyProjectShowcase\n                  projectName={showcaseProjectContext.projectName}\n                  onClose={handleCloseProjectShowcase}\n                  analysis={showcaseProjectContext.analysis}\n                  relevantTeams={showcaseProjectContext.relevantTeams}\n                  questions={showcaseProjectContext.questions}\n                  answers={showcaseProjectContext.answers}\n                  timelineDetails={showcaseProjectContext.timelineDetails}\n                  showcaseThemes={showcaseThemes}\n                  hasIncompleteAnswers={Boolean(showcaseProjectContext.hasIncompleteAnswers)}\n                  onUpdateAnswers={\n                    isOnboardingActive\n                      ? noop\n                      : showcaseProjectContext.status === 'draft' || isAdminMode\n                        ? handleUpdateProjectShowcaseAnswers\n                        : undefined\n                  }\n                  tourContext={tourContext}\n                  onAnnotationScopeChange={setShowcaseAnnotationScope}\n                  onEditingStateChange={setIsShowcaseEditing}\n                />\n              </Suspense>\n            </div>\n          ) : null\n        ) : null}\n      </main>\n\n      <footer className=\"bg-white border-t border-gray-200 mt-10\" aria-label=\"Pied de page\">\n        <p className=\"text-xs text-gray-400 text-center py-4\">\n          Project Navigator · Version {APP_VERSION} ·{' '}\n          <a\n            href=\"./mentions-legales.html\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"underline hover:text-gray-500\"\n          >\n            Mentions légales\n          </a>\n        </p>\n      </footer>\n    </div>\n  );\n};\n",
  "src/components/BackOffice.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport { normalizeRiskWeighting } from '../utils/risk.js';\nimport {\n  Settings,\n  Plus,\n  Edit,\n  Trash2,\n  Eye,\n  Info,\n  GripVertical,\n  Download,\n  ArrowUp,\n  ArrowDown,\n  Copy,\n  AlertTriangle,\n  CheckCircle,\n  ChevronRight,\n  ChevronLeft\n} from './icons.js';\nimport { QuestionEditor } from './QuestionEditor.jsx';\nimport { RuleEditor } from './RuleEditor.jsx';\nimport { BackOfficeDashboard } from './BackOfficeDashboard.jsx';\nimport { VirtualizedList } from './VirtualizedList.jsx';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { normalizeConditionGroups } from '../utils/conditionGroups.js';\nimport {\n  normalizeTimingRequirement,\n  sanitizeRiskTimingConstraint,\n  sanitizeTeamQuestionEntry\n} from '../utils/rules.js';\nimport { sanitizeRuleCondition } from '../utils/ruleConditions.js';\nimport {\n  normalizeProjectFilterConfig,\n  resetProjectFiltersConfig,\n  updateProjectFilterField\n} from '../utils/projectFilters.js';\nimport {\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig,\n  resetInspirationFiltersConfig,\n  resetInspirationFormConfig,\n  updateInspirationFilterField,\n  updateInspirationFormField\n} from '../utils/inspirationConfig.js';\nimport { initialShowcaseThemes } from '../data/showcaseThemes.js';\n\nconst QUESTION_TYPE_META = {\n  choice: {\n    label: 'Liste de choix',\n    description: \"Affiche une liste d'options exclusives.\"\n  },\n  multi_choice: {\n    label: 'Choix multiples',\n    description: 'Permet de sélectionner plusieurs réponses.'\n  },\n  milestone_list: {\n    label: 'Liste de jalons',\n    description: 'Collecte des jalons avec une date et une description.'\n  },\n  date: {\n    label: 'Date',\n    description: 'Attend la sélection d\\'une date précise.'\n  },\n  number: {\n    label: 'Valeur numérique',\n    description: 'Attend un nombre entier ou décimal.'\n  },\n  url: {\n    label: 'Lien URL',\n    description: 'Attend un lien complet (https://...).'\n  },\n  file: {\n    label: 'Fichier',\n    description: 'Permet de téléverser un document de référence.'\n  },\n  text: {\n    label: 'Texte libre (1 ligne)',\n    description: 'Attend une réponse texte courte.'\n  },\n  long_text: {\n    label: 'Texte libre (plusieurs lignes)',\n    description: 'Attend une réponse texte détaillée.'\n  }\n};\n\nconst PROTECTED_QUESTION_IDS = new Set(['ProjectType']);\n\nconst getQuestionTypeMeta = (type) => {\n  const key = type || 'choice';\n  return QUESTION_TYPE_META[key] || QUESTION_TYPE_META.choice;\n};\n\nconst formatOperatorSymbol = (operator) => {\n  switch (operator) {\n    case 'equals':\n      return '=';\n    case 'not_equals':\n      return '≠';\n    case 'contains':\n      return 'contient';\n    case 'lt':\n      return '<';\n    case 'lte':\n      return '≤';\n    case 'gt':\n      return '>';\n    case 'gte':\n      return '≥';\n    default:\n      return operator || '=';\n  }\n};\n\nconst buildConditionSummary = (question, allQuestions) => {\n  const conditionGroups = normalizeConditionGroups(question);\n  const summaries = [];\n\n  for (let groupIndex = 0; groupIndex < conditionGroups.length; groupIndex += 1) {\n    const group = conditionGroups[groupIndex];\n    const conditions = Array.isArray(group && group.conditions) ? group.conditions : [];\n\n    if (conditions.length === 0) {\n      continue;\n    }\n\n    const parts = [];\n    for (let conditionIndex = 0; conditionIndex < conditions.length; conditionIndex += 1) {\n      const condition = conditions[conditionIndex];\n      if (!condition) {\n        continue;\n      }\n\n      const refQuestion = allQuestions.find((item) => item.id === condition.question);\n      const label = refQuestion ? refQuestion.question : `Question ${condition.question}`;\n      const operator = formatOperatorSymbol(condition.operator);\n\n      const value = typeof condition.value === 'string' ? condition.value : JSON.stringify(condition.value);\n      const connector = conditionIndex > 0 ? (group.logic === 'any' ? 'OU' : 'ET') : '';\n      parts.push({ label, operator, value, connector });\n    }\n\n    if (parts.length > 0) {\n      summaries.push({\n        index: groupIndex + 1,\n        logic: group.logic === 'any' ? 'OU' : 'ET',\n        parts\n      });\n    }\n  }\n\n  return summaries;\n};\n\nconst buildRuleConditionSummary = (rule, questions) => {\n  const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n  const formatted = [];\n\n  for (let groupIndex = 0; groupIndex < groups.length; groupIndex += 1) {\n    const group = groups[groupIndex];\n    const conditions = Array.isArray(group && group.conditions) ? group.conditions : [];\n\n    if (conditions.length === 0) {\n      continue;\n    }\n\n    const items = [];\n    for (let conditionIndex = 0; conditionIndex < conditions.length; conditionIndex += 1) {\n      const condition = conditions[conditionIndex];\n      if (!condition) {\n        continue;\n      }\n\n      if (condition.type === 'timing') {\n        const requirement = normalizeTimingRequirement(condition);\n        const start = condition.startQuestion || 'début ?';\n        const end = condition.endQuestion || 'fin ?';\n        const constraintParts = [];\n\n        if (typeof requirement.minimumWeeks === 'number') {\n          constraintParts.push(`≥ ${requirement.minimumWeeks} sem.`);\n        }\n        if (typeof requirement.maximumWeeks === 'number') {\n          constraintParts.push(`≤ ${requirement.maximumWeeks} sem.`);\n        }\n        if (typeof requirement.minimumDays === 'number') {\n          constraintParts.push(`≥ ${requirement.minimumDays} j.`);\n        }\n        if (typeof requirement.maximumDays === 'number') {\n          constraintParts.push(`≤ ${requirement.maximumDays} j.`);\n        }\n\n        const constraint = constraintParts.length > 0 ? constraintParts.join(' / ') : 'plage personnalisée';\n        items.push({\n          type: 'timing',\n          description: `Fenêtre entre « ${start} » et « ${end} » (${constraint})`\n        });\n        continue;\n      }\n\n      const refQuestion = questions.find((item) => item.id === condition.question);\n      const label = refQuestion ? `${refQuestion.id} – ${refQuestion.question}` : `Question ${condition.question}`;\n      const operator = formatOperatorSymbol(condition.operator);\n      const value = typeof condition.value === 'string' ? condition.value : JSON.stringify(condition.value);\n\n      items.push({\n        type: 'question',\n        description: `${label} ${operator} « ${value} »`\n      });\n    }\n\n    if (items.length > 0) {\n      formatted.push({\n        index: groupIndex + 1,\n        logic: group.logic === 'any' ? 'OU' : 'ET',\n        items\n      });\n    }\n  }\n\n  return formatted;\n};\n\nconst collectRuleTeamIds = (rule) => {\n  const teamIds = new Set();\n\n  if (!rule || typeof rule !== 'object') {\n    return teamIds;\n  }\n\n  const baseTeams = Array.isArray(rule?.teams) ? rule.teams : [];\n  baseTeams.forEach((teamId) => {\n    if (typeof teamId === 'string' && teamId.trim() !== '') {\n      teamIds.add(teamId);\n    }\n  });\n\n  if (rule?.questions && typeof rule.questions === 'object') {\n    Object.keys(rule.questions).forEach((teamId) => {\n      if (typeof teamId === 'string' && teamId.trim() !== '') {\n        teamIds.add(teamId);\n      }\n    });\n  }\n\n  const risks = Array.isArray(rule?.risks) ? rule.risks : [];\n  risks.forEach((risk) => {\n    if (risk && typeof risk.teamId === 'string' && risk.teamId.trim() !== '') {\n      teamIds.add(risk.teamId);\n    }\n  });\n\n  return teamIds;\n};\n\nconst formatGuidanceTips = (guidance) => {\n  if (!guidance || !Array.isArray(guidance.tips)) {\n    return [];\n  }\n\n  const tips = [];\n  for (let index = 0; index < guidance.tips.length; index += 1) {\n    const tip = guidance.tips[index];\n    if (typeof tip === 'string' && tip.trim() !== '') {\n      tips.push(tip);\n    }\n  }\n\n  return tips;\n};\n\nconst getTeamLabel = (teamId, teams) => {\n  for (let index = 0; index < teams.length; index += 1) {\n    const team = teams[index];\n    if (team && team.id === teamId) {\n      return `${team.name || team.id}`;\n    }\n  }\n  return teamId;\n};\n\nconst PRIORITY_WEIGHTS = {\n  'A particulièrement anticiper': 3,\n  'A anticiper': 2,\n  'A réaliser': 1\n};\n\nconst RISK_WEIGHT_FIELDS = [\n  {\n    key: 'low',\n    label: 'Risque faible',\n    description: 'Poids appliqué aux risques de criticité faible.'\n  },\n  {\n    key: 'medium',\n    label: 'Risque moyen',\n    description: 'Poids appliqué aux risques de criticité moyenne.'\n  },\n  {\n    key: 'high',\n    label: 'Risque élevé',\n    description: 'Poids appliqué aux risques de criticité élevée.'\n  }\n];\n\nconst parseScoreValue = (value, fallback, { allowNull = false } = {}) => {\n  if (allowNull && (value === null || value === undefined || value === '')) {\n    return null;\n  }\n\n  const parsed = Number(value);\n\n  if (!Number.isFinite(parsed)) {\n    return fallback;\n  }\n\n  return parsed < 0 ? 0 : parsed;\n};\n\nconst getRuleMinScoreValue = (rule) => parseScoreValue(\n  rule?.minScore !== undefined ? rule.minScore : rule?.minRisks,\n  0\n);\n\nconst getRuleMaxScoreValue = (rule) => parseScoreValue(\n  rule?.maxScore !== undefined ? rule.maxScore : rule?.maxRisks,\n  null,\n  { allowNull: true }\n);\n\nconst formatScoreValue = (value) => {\n  if (!Number.isFinite(value)) {\n    return '0';\n  }\n\n  if (Number.isInteger(value)) {\n    return value.toString();\n  }\n\n  return value.toLocaleString('fr-FR', {\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 2\n  });\n};\n\nconst getPointUnit = (value) => (Math.abs(value - 1) < 1e-9 ? 'point' : 'points');\n\nconst getHighestRiskPriority = (risks = []) => {\n  if (!Array.isArray(risks) || risks.length === 0) {\n    return null;\n  }\n\n  let bestPriority = null;\n\n  risks.forEach((risk) => {\n    const priority = risk?.priority;\n    if (!priority) {\n      return;\n    }\n\n    const currentWeight = PRIORITY_WEIGHTS[priority] || 0;\n    const bestWeight = PRIORITY_WEIGHTS[bestPriority] || 0;\n\n    if (!bestPriority || currentWeight > bestWeight) {\n      bestPriority = priority;\n    }\n  });\n\n  return bestPriority;\n};\n\nconst getPriorityBadgeClasses = (priority) => {\n  switch (priority) {\n    case 'A particulièrement anticiper':\n      return 'bg-red-100 text-red-800 border border-red-200';\n    case 'A anticiper':\n      return 'bg-orange-100 text-orange-800 border border-orange-200';\n    case 'A réaliser':\n      return 'bg-blue-100 text-blue-800 border border-blue-200';\n    default:\n      return 'bg-gray-100 text-gray-700 border border-gray-200';\n  }\n};\n\nconst PROJECT_FILTER_TYPE_LABELS = {\n  text: 'Champ texte',\n  select: 'Liste déroulante',\n  sort: 'Tri par date'\n};\n\nconst FILTER_COMPATIBLE_QUESTION_TYPES = new Set([\n  'choice',\n  'multi_choice',\n  'text',\n  'long_text',\n  'number',\n  'url',\n  'date'\n]);\n\nconst INSPIRATION_FILTER_TYPE_LABELS = {\n  text: 'Champ texte',\n  select: 'Liste déroulante'\n};\n\nconst INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES = new Set([\n  'select',\n  'multi_select',\n  'text',\n  'long_text',\n  'number',\n  'url',\n  'date'\n]);\n\nconst INSPIRATION_FORM_FIELD_TYPE_LABELS = {\n  text: 'Texte (1 ligne)',\n  long_text: 'Texte long',\n  select: 'Liste déroulante',\n  multi_select: 'Sélection multiple',\n  url: 'URL',\n  documents: 'Documents'\n};\n\nconst INSPIRATION_FORM_FIELD_TYPE_OPTIONS = [\n  { value: 'text', label: 'Texte (1 ligne)' },\n  { value: 'long_text', label: 'Texte long' },\n  { value: 'select', label: 'Liste déroulante' },\n  { value: 'multi_select', label: 'Sélection multiple' },\n  { value: 'url', label: 'URL' },\n  { value: 'documents', label: 'Documents' }\n];\n\nconst INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES = new Set([\n  'text',\n  'long_text',\n  'select',\n  'url'\n]);\n\nconst PROJECT_FILTER_FIELD_DESCRIPTIONS = {\n  projectName:\n    'Permet de rechercher un projet par le titre saisi lors de la qualification.',\n  teamLead:\n    'Filtre les projets en fonction du nom du lead renseigné dans le questionnaire.',\n  teamLeadTeam:\n    'Affiche une liste des équipes possibles pour retrouver rapidement les initiatives associées.',\n  dateOrder:\n    \"Définit l'ordre d'affichage par défaut des projets (du plus récent au plus ancien ou inversement).\"\n};\n\nconst SHOWCASE_THEME_PALETTE_FIELDS = [\n  { key: 'backgroundStart', label: 'Fond (début)', description: 'Couleur de départ du dégradé principal en arrière-plan.' },\n  { key: 'backgroundMid', label: 'Fond (milieu)', description: 'Couleur intermédiaire du dégradé principal.' },\n  { key: 'backgroundEnd', label: 'Fond (fin)', description: 'Couleur de fermeture du dégradé principal.' },\n  { key: 'glowPrimary', label: 'Halo principal', description: 'Teinte du halo radial principal utilisé pour la lumière de fond.' },\n  { key: 'glowSecondary', label: 'Halo secondaire', description: 'Teinte du halo secondaire pour adoucir les bords.' },\n  { key: 'accentPrimary', label: 'Accent principal', description: 'Première couleur du dégradé des boutons et badges.' },\n  { key: 'accentSecondary', label: 'Accent secondaire', description: 'Seconde couleur du dégradé des boutons et badges.' },\n  { key: 'surface', label: 'Surface', description: 'Couleur des panneaux de saisie et cartes (avec transparence appliquée).' },\n  { key: 'border', label: 'Contours', description: 'Base utilisée pour les bordures et lignes de séparation.' },\n  { key: 'textPrimary', label: 'Texte principal', description: 'Couleur du texte principal de la vitrine.' },\n  { key: 'textSecondary', label: 'Texte secondaire', description: 'Couleur du texte secondaire et des éléments discrets.' },\n  { key: 'highlight', label: 'Mise en avant', description: 'Couleur des petits accents (étiquettes, survols, repères visuels).' }\n];\n\nconst createEmptyInspirationFormField = () => ({\n  id: '',\n  label: '',\n  type: 'text',\n  placeholder: '',\n  options: '',\n  required: false,\n  enabled: true\n});\n\nexport const BackOffice = ({\n  projects,\n  questions,\n  setQuestions,\n  rules,\n  setRules,\n  riskLevelRules,\n  setRiskLevelRules,\n  riskWeights,\n  setRiskWeights,\n  teams,\n  setTeams,\n  showcaseThemes,\n  setShowcaseThemes,\n  projectFilters,\n  setProjectFilters,\n  inspirationFilters,\n  setInspirationFilters,\n  inspirationFormFields,\n  setInspirationFormFields\n}) => {\n  const [activeTab, setActiveTab] = useState('dashboard');\n  const [editingRule, setEditingRule] = useState(null);\n  const [editingQuestion, setEditingQuestion] = useState(null);\n  const [draggedQuestionIndex, setDraggedQuestionIndex] = useState(null);\n  const [dragOverIndex, setDragOverIndex] = useState(null);\n  const [reorderAnnouncement, setReorderAnnouncement] = useState('');\n  const [questionTitleFilter, setQuestionTitleFilter] = useState('');\n  const [questionTeamFilter, setQuestionTeamFilter] = useState('all');\n  const [ruleTitleFilter, setRuleTitleFilter] = useState('');\n  const [ruleTeamFilter, setRuleTeamFilter] = useState('all');\n  const [expandedQuestionIds, setExpandedQuestionIds] = useState(() => new Set());\n  const [expandedRuleIds, setExpandedRuleIds] = useState(() => new Set());\n  const [selectedFilterQuestionId, setSelectedFilterQuestionId] = useState('');\n  const [selectedInspirationFilterQuestionId, setSelectedInspirationFilterQuestionId] = useState('');\n  const [newInspirationFormField, setNewInspirationFormField] = useState(() => createEmptyInspirationFormField());\n  const undoStackRef = useRef([]);\n  const [canUndo, setCanUndo] = useState(false);\n  const [undoMessage, setUndoMessage] = useState('');\n  const safeRiskLevelRules = Array.isArray(riskLevelRules) ? riskLevelRules : [];\n  const riskLevelRuleCount = safeRiskLevelRules.length;\n  const normalizedRiskWeights = useMemo(\n    () => normalizeRiskWeighting(riskWeights),\n    [riskWeights]\n  );\n  const safeShowcaseThemes = Array.isArray(showcaseThemes) && showcaseThemes.length > 0\n    ? showcaseThemes\n    : initialShowcaseThemes;\n  const showcaseThemeCount = safeShowcaseThemes.length;\n\n  const normalizeColorValue = useCallback((value, fallback = '#000000') => {\n    if (typeof value !== 'string') {\n      return fallback;\n    }\n\n    const trimmed = value.trim();\n    if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(trimmed)) {\n      return trimmed;\n    }\n\n    return fallback;\n  }, []);\n\n  const updateShowcaseThemeField = useCallback((themeIndex, field, value) => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      const targetTheme = nextThemes[themeIndex];\n\n      if (!targetTheme) {\n        return previousThemes;\n      }\n\n      const aliases = Array.isArray(targetTheme.aliases) ? targetTheme.aliases.slice() : [];\n      if (field === 'label' && typeof targetTheme.label === 'string' && targetTheme.label.trim().length > 0) {\n        const currentLabel = targetTheme.label.trim();\n        if (!aliases.includes(currentLabel)) {\n          aliases.push(currentLabel);\n        }\n      }\n\n      nextThemes[themeIndex] = {\n        ...targetTheme,\n        [field]: value,\n        aliases\n      };\n\n      return nextThemes;\n    });\n  }, [setShowcaseThemes]);\n\n  const updateShowcaseThemePalette = useCallback((themeIndex, key, value) => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      const targetTheme = nextThemes[themeIndex];\n\n      if (!targetTheme) {\n        return previousThemes;\n      }\n\n      const nextPalette = {\n        ...(targetTheme.palette || {}),\n        [key]: normalizeColorValue(value, targetTheme.palette?.[key] || '#000000')\n      };\n\n      nextThemes[themeIndex] = {\n        ...targetTheme,\n        palette: nextPalette\n      };\n\n      return nextThemes;\n    });\n  }, [normalizeColorValue, setShowcaseThemes]);\n\n  const addShowcaseTheme = useCallback(() => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    const basePalette = safeShowcaseThemes[0]?.palette || initialShowcaseThemes[0]?.palette || {};\n    const nextIndex = Array.isArray(showcaseThemes) ? showcaseThemes.length + 1 : safeShowcaseThemes.length + 1;\n    const newTheme = {\n      id: `theme-${nextIndex}-${Date.now().toString(36).slice(2, 6)}`,\n      label: 'Nouveau thème',\n      description: 'Palette personnalisable via les color-pickers.',\n      aliases: ['Nouveau thème'],\n      palette: { ...basePalette }\n    };\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      nextThemes.push(newTheme);\n      return nextThemes;\n    });\n  }, [safeShowcaseThemes, setShowcaseThemes, showcaseThemes]);\n\n  const deleteShowcaseTheme = useCallback((themeId) => {\n    if (typeof setShowcaseThemes !== 'function' || !themeId || showcaseThemeCount <= 1) {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes)\n        ? previousThemes.filter(theme => theme?.id !== themeId)\n        : [];\n\n      return nextThemes.length > 0 ? nextThemes : previousThemes;\n    });\n  }, [setShowcaseThemes, showcaseThemeCount]);\n\n  const handleUndo = useCallback(() => {\n    const stack = undoStackRef.current;\n    if (!stack || stack.length === 0) {\n      setUndoMessage('');\n      setCanUndo(false);\n      return;\n    }\n\n    const entry = stack[stack.length - 1];\n    undoStackRef.current = stack.slice(0, -1);\n    setCanUndo(undoStackRef.current.length > 0);\n\n    if (!entry) {\n      setUndoMessage('');\n      return;\n    }\n\n    switch (entry.type) {\n      case 'question': {\n        if (typeof setQuestions === 'function') {\n          setQuestions((prevQuestions) => {\n            const next = Array.isArray(prevQuestions) ? prevQuestions.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`La question « ${entry.item?.question || entry.item?.id || 'question'} » a été restaurée.`);\n        setReorderAnnouncement('Suppression de question annulée.');\n        break;\n      }\n      case 'rule': {\n        if (typeof setRules === 'function') {\n          setRules((prevRules) => {\n            const next = Array.isArray(prevRules) ? prevRules.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`La règle « ${entry.item?.name || entry.item?.id || 'règle'} » a été restaurée.`);\n        setReorderAnnouncement('Suppression de règle annulée.');\n        break;\n      }\n      case 'riskLevelRule': {\n        if (typeof setRiskLevelRules === 'function') {\n          setRiskLevelRules((prevRules) => {\n            const base = Array.isArray(prevRules) ? prevRules.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? base.length, base.length));\n            base.splice(insertIndex, 0, entry.item);\n            return base;\n          });\n        }\n        setUndoMessage(`Le niveau « ${entry.item?.label || entry.item?.id || 'niveau'} » a été restauré.`);\n        setReorderAnnouncement('Suppression de niveau de complexité annulée.');\n        break;\n      }\n      case 'team': {\n        if (typeof setTeams === 'function') {\n          setTeams((prevTeams) => {\n            const next = Array.isArray(prevTeams) ? prevTeams.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`L'équipe « ${entry.item?.name || entry.item?.id || 'équipe'} » a été restaurée.`);\n        setReorderAnnouncement('Suppression d’équipe annulée.');\n        break;\n      }\n      case 'projectFilter': {\n        if (typeof setProjectFilters === 'function') {\n          setProjectFilters((prevFilters) => {\n            const normalized = normalizeProjectFilterConfig(prevFilters);\n            const fields = Array.isArray(normalized.fields) ? normalized.fields.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? fields.length, fields.length));\n            fields.splice(insertIndex, 0, entry.item);\n            return {\n              ...normalized,\n              fields\n            };\n          });\n        }\n        setUndoMessage(`Le filtre « ${entry.item?.label || entry.item?.id || 'filtre'} » a été restauré.`);\n        setReorderAnnouncement('Suppression de filtre annulée.');\n        break;\n      }\n      case 'inspirationFilter': {\n        if (typeof setInspirationFilters === 'function') {\n          setInspirationFilters((prevFilters) => {\n            const normalized = normalizeInspirationFiltersConfig(prevFilters);\n            const fields = Array.isArray(normalized.fields) ? normalized.fields.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? fields.length, fields.length));\n            fields.splice(insertIndex, 0, entry.item);\n            return {\n              ...normalized,\n              fields\n            };\n          });\n        }\n        setUndoMessage(`Le filtre « ${entry.item?.label || entry.item?.id || 'filtre'} » a été restauré.`);\n        setReorderAnnouncement('Suppression de filtre annulée.');\n        break;\n      }\n      default:\n        setUndoMessage('Dernière action annulée.');\n        break;\n    }\n  }, [\n    setQuestions,\n    setRules,\n    setRiskLevelRules,\n    setTeams,\n    setProjectFilters,\n    setInspirationFilters,\n    setReorderAnnouncement\n  ]);\n\n  const confirmDeletion = useCallback((message) => {\n    if (typeof window === 'undefined') {\n      return true;\n    }\n\n    return window.confirm(message);\n  }, []);\n\n  const pushUndoEntry = useCallback((entry) => {\n    undoStackRef.current = [...undoStackRef.current.slice(-19), entry];\n    setCanUndo(true);\n    if (entry && entry.message) {\n      setUndoMessage(entry.message);\n    } else {\n      setUndoMessage('Dernière suppression enregistrée. Vous pouvez utiliser Ctrl+Z pour annuler.');\n    }\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const keydownHandler = (event) => {\n      if ((event.ctrlKey || event.metaKey) && !event.shiftKey && event.key.toLowerCase() === 'z') {\n        const target = event.target;\n        if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable)) {\n          return;\n        }\n\n        if (!undoStackRef.current.length) {\n          return;\n        }\n\n        event.preventDefault();\n        handleUndo();\n      }\n    };\n\n    window.addEventListener('keydown', keydownHandler);\n\n    return () => {\n      window.removeEventListener('keydown', keydownHandler);\n    };\n  }, [handleUndo]);\n\n  const questionTeamAssignments = useMemo(() => {\n    const setMap = new Map();\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    const addTeamsForQuestion = (questionId, teamIds) => {\n      if (!questionId) {\n        return;\n      }\n\n      const normalizedQuestionId = typeof questionId === 'string' ? questionId : String(questionId);\n      const candidates = Array.isArray(teamIds) ? teamIds : [];\n      const validTeamIds = candidates.filter((teamId) => typeof teamId === 'string' && teamId.trim() !== '');\n\n      if (validTeamIds.length === 0) {\n        return;\n      }\n\n      const existing = setMap.get(normalizedQuestionId);\n      if (existing) {\n        validTeamIds.forEach((teamId) => existing.add(teamId));\n        return;\n      }\n\n      setMap.set(normalizedQuestionId, new Set(validTeamIds));\n    };\n\n    safeRules.forEach((rule) => {\n      const aggregatedTeamIds = collectRuleTeamIds(rule);\n      const teamsForRule = Array.from(aggregatedTeamIds);\n\n      if (teamsForRule.length === 0) {\n        return;\n      }\n\n      const baseConditions = Array.isArray(rule?.conditions) ? rule.conditions : [];\n      baseConditions.forEach((condition) => {\n        if (!condition) {\n          return;\n        }\n\n        if (condition.type === 'question' && condition.question) {\n          addTeamsForQuestion(condition.question, teamsForRule);\n          return;\n        }\n\n        if (condition.type === 'timing') {\n          if (condition.startQuestion) {\n            addTeamsForQuestion(condition.startQuestion, teamsForRule);\n          }\n          if (condition.endQuestion) {\n            addTeamsForQuestion(condition.endQuestion, teamsForRule);\n          }\n        }\n      });\n\n      const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n      groups.forEach((group) => {\n        const groupConditions = Array.isArray(group?.conditions) ? group.conditions : [];\n        groupConditions.forEach((condition) => {\n          if (!condition) {\n            return;\n          }\n\n          if (condition.type === 'question' && condition.question) {\n            addTeamsForQuestion(condition.question, teamsForRule);\n            return;\n          }\n\n          if (condition.type === 'timing') {\n            if (condition.startQuestion) {\n              addTeamsForQuestion(condition.startQuestion, teamsForRule);\n            }\n            if (condition.endQuestion) {\n              addTeamsForQuestion(condition.endQuestion, teamsForRule);\n            }\n          }\n        });\n      });\n\n      const risks = Array.isArray(rule?.risks) ? rule.risks : [];\n      risks.forEach((risk) => {\n        const timingConstraint = sanitizeRiskTimingConstraint(risk?.timingConstraint);\n\n        if (!timingConstraint.enabled) {\n          return;\n        }\n\n        const relatedTeams = new Set(teamsForRule);\n        if (risk && typeof risk.teamId === 'string' && risk.teamId.trim() !== '') {\n          relatedTeams.add(risk.teamId);\n        }\n\n        if (timingConstraint.startQuestion) {\n          addTeamsForQuestion(timingConstraint.startQuestion, Array.from(relatedTeams));\n        }\n        if (timingConstraint.endQuestion) {\n          addTeamsForQuestion(timingConstraint.endQuestion, Array.from(relatedTeams));\n        }\n      });\n\n      if (rule?.questions && typeof rule.questions === 'object') {\n        Object.entries(rule.questions).forEach(([teamId, entries]) => {\n          if (typeof teamId !== 'string' || teamId.trim() === '') {\n            return;\n          }\n\n          const sanitizedEntries = Array.isArray(entries) ? entries : [];\n          sanitizedEntries.forEach((entry) => {\n            const sanitizedEntry = sanitizeTeamQuestionEntry(entry);\n            const timingConstraint = sanitizeRiskTimingConstraint(sanitizedEntry?.timingConstraint);\n\n            if (!timingConstraint.enabled) {\n              return;\n            }\n\n            if (timingConstraint.startQuestion) {\n              addTeamsForQuestion(timingConstraint.startQuestion, [teamId]);\n            }\n            if (timingConstraint.endQuestion) {\n              addTeamsForQuestion(timingConstraint.endQuestion, [teamId]);\n            }\n          });\n        });\n      }\n    });\n\n    return new Map(\n      Array.from(setMap.entries()).map(([questionId, teamSet]) => [\n        questionId,\n        Array.from(teamSet)\n      ])\n    );\n  }, [rules]);\n\n  const availableTeamFilterOptions = useMemo(() => {\n    const options = [];\n    const seen = new Set();\n    const safeTeams = Array.isArray(teams) ? teams : [];\n\n    safeTeams.forEach((team) => {\n      if (!team || typeof team.id !== 'string' || team.id.trim() === '' || seen.has(team.id)) {\n        return;\n      }\n\n      options.push({ value: team.id, label: getTeamLabel(team.id, safeTeams) });\n      seen.add(team.id);\n    });\n\n    const safeRules = Array.isArray(rules) ? rules : [];\n    safeRules.forEach((rule) => {\n      collectRuleTeamIds(rule).forEach((teamId) => {\n        if (!teamId || seen.has(teamId)) {\n          return;\n        }\n\n        options.push({ value: teamId, label: getTeamLabel(teamId, safeTeams) });\n        seen.add(teamId);\n      });\n    });\n\n    return options;\n  }, [teams, rules]);\n\n  const visibleQuestionIds = useMemo(() => {\n    const ids = [];\n    const normalizedTitle = questionTitleFilter.trim().toLowerCase();\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n\n    safeQuestions.forEach((question) => {\n      if (!question) {\n        return;\n      }\n\n      const questionId = typeof question.id === 'string' ? question.id : String(question.id || '');\n      if (!questionId) {\n        return;\n      }\n\n      const label = typeof question.question === 'string' ? question.question : '';\n      const titleMatches =\n        normalizedTitle === '' ||\n        label.toLowerCase().includes(normalizedTitle) ||\n        questionId.toLowerCase().includes(normalizedTitle);\n\n      if (!titleMatches) {\n        return;\n      }\n\n      const teamsForQuestion = questionTeamAssignments.get(questionId) || [];\n      let teamMatches = true;\n\n      if (questionTeamFilter === 'none') {\n        teamMatches = teamsForQuestion.length === 0;\n      } else if (questionTeamFilter !== 'all') {\n        teamMatches = teamsForQuestion.includes(questionTeamFilter);\n      }\n\n      if (teamMatches) {\n        ids.push(questionId);\n      }\n    });\n\n    return ids;\n  }, [questions, questionTitleFilter, questionTeamFilter, questionTeamAssignments]);\n\n  const visibleQuestionIdSet = useMemo(() => new Set(visibleQuestionIds), [visibleQuestionIds]);\n  const visibleQuestionEntries = useMemo(() => {\n    const entries = [];\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n\n    safeQuestions.forEach((question, index) => {\n      if (!question || !visibleQuestionIdSet.has(question.id)) {\n        return;\n      }\n\n      entries.push({ question, index });\n    });\n\n    return entries;\n  }, [questions, visibleQuestionIdSet]);\n  const shouldVirtualizeQuestions = visibleQuestionEntries.length > 12;\n\n  const visibleRuleIds = useMemo(() => {\n    const ids = [];\n    const normalizedTitle = ruleTitleFilter.trim().toLowerCase();\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    safeRules.forEach((rule) => {\n      if (!rule) {\n        return;\n      }\n\n      const ruleId = typeof rule.id === 'string' ? rule.id : String(rule.id || '');\n      if (!ruleId) {\n        return;\n      }\n\n      const name = typeof rule.name === 'string' ? rule.name : '';\n      const titleMatches =\n        normalizedTitle === '' ||\n        name.toLowerCase().includes(normalizedTitle) ||\n        ruleId.toLowerCase().includes(normalizedTitle);\n\n      if (!titleMatches) {\n        return;\n      }\n\n      const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n      let teamMatches = true;\n\n      if (ruleTeamFilter === 'none') {\n        teamMatches = associatedTeamIds.length === 0;\n      } else if (ruleTeamFilter !== 'all') {\n        teamMatches = associatedTeamIds.includes(ruleTeamFilter);\n      }\n\n      if (teamMatches) {\n        ids.push(ruleId);\n      }\n    });\n\n    return ids;\n  }, [rules, ruleTitleFilter, ruleTeamFilter]);\n\n  const visibleRuleIdSet = useMemo(() => new Set(visibleRuleIds), [visibleRuleIds]);\n  const visibleRuleEntries = useMemo(() => {\n    const entries = [];\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    safeRules.forEach((rule) => {\n      if (!rule || !visibleRuleIdSet.has(rule.id)) {\n        return;\n      }\n\n      entries.push(rule);\n    });\n\n    return entries;\n  }, [rules, visibleRuleIdSet]);\n  const shouldVirtualizeRules = visibleRuleEntries.length > 8;\n\n  useEffect(() => {\n    if (questionTeamFilter === 'all' || questionTeamFilter === 'none') {\n      return;\n    }\n\n    const availableValues = new Set(availableTeamFilterOptions.map((option) => option.value));\n    if (!availableValues.has(questionTeamFilter)) {\n      setQuestionTeamFilter('all');\n    }\n  }, [questionTeamFilter, availableTeamFilterOptions]);\n\n  useEffect(() => {\n    if (ruleTeamFilter === 'all' || ruleTeamFilter === 'none') {\n      return;\n    }\n\n    const availableValues = new Set(availableTeamFilterOptions.map((option) => option.value));\n    if (!availableValues.has(ruleTeamFilter)) {\n      setRuleTeamFilter('all');\n    }\n  }, [ruleTeamFilter, availableTeamFilterOptions]);\n\n  const normalizedProjectFilters = useMemo(\n    () => normalizeProjectFilterConfig(projectFilters),\n    [projectFilters]\n  );\n\n  const defaultProjectFiltersConfig = useMemo(\n    () => normalizeProjectFilterConfig(resetProjectFiltersConfig()),\n    []\n  );\n\n  const projectFiltersAreDefault = useMemo(\n    () => JSON.stringify(normalizedProjectFilters) === JSON.stringify(defaultProjectFiltersConfig),\n    [normalizedProjectFilters, defaultProjectFiltersConfig]\n  );\n\n  const filterFields = Array.isArray(normalizedProjectFilters.fields)\n    ? normalizedProjectFilters.fields\n    : [];\n\n  const normalizedInspirationFilters = useMemo(\n    () => normalizeInspirationFiltersConfig(inspirationFilters),\n    [inspirationFilters]\n  );\n  const normalizedInspirationFormFields = useMemo(\n    () => normalizeInspirationFormConfig(inspirationFormFields),\n    [inspirationFormFields]\n  );\n  const defaultInspirationFiltersConfig = useMemo(\n    () => normalizeInspirationFiltersConfig(resetInspirationFiltersConfig()),\n    []\n  );\n  const defaultInspirationFormConfig = useMemo(\n    () => normalizeInspirationFormConfig(resetInspirationFormConfig()),\n    []\n  );\n  const inspirationFiltersAreDefault = useMemo(\n    () => JSON.stringify(normalizedInspirationFilters) === JSON.stringify(defaultInspirationFiltersConfig),\n    [normalizedInspirationFilters, defaultInspirationFiltersConfig]\n  );\n  const inspirationFormAreDefault = useMemo(\n    () => JSON.stringify(normalizedInspirationFormFields) === JSON.stringify(defaultInspirationFormConfig),\n    [normalizedInspirationFormFields, defaultInspirationFormConfig]\n  );\n  const inspirationFilterFields = Array.isArray(normalizedInspirationFilters.fields)\n    ? normalizedInspirationFilters.fields\n    : [];\n  const inspirationFormFieldEntries = Array.isArray(normalizedInspirationFormFields.fields)\n    ? normalizedInspirationFormFields.fields\n    : [];\n  const inspirationFieldIds = useMemo(\n    () => new Set(inspirationFormFieldEntries.map((field) => field.id)),\n    [inspirationFormFieldEntries]\n  );\n\n  const availableFilterQuestionOptions = useMemo(() => {\n    const usedQuestionIds = new Set();\n    if (Array.isArray(normalizedProjectFilters.fields)) {\n      normalizedProjectFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n          ? field.sourceQuestionId.trim()\n          : field.id;\n\n        if (sourceId) {\n          usedQuestionIds.add(sourceId);\n        }\n      });\n    }\n\n    const options = Array.isArray(questions)\n      ? questions\n          .filter((question) => question && FILTER_COMPATIBLE_QUESTION_TYPES.has(question.type))\n          .map((question) => ({\n            value: question.id,\n            label: question.question || question.id,\n            disabled: usedQuestionIds.has(question.id),\n            type: question.type\n          }))\n      : [];\n\n    return options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }));\n  }, [questions, normalizedProjectFilters]);\n\n  const selectedFilterOption = useMemo(() => {\n    if (!selectedFilterQuestionId) {\n      return null;\n    }\n\n    return availableFilterQuestionOptions.find((option) => option.value === selectedFilterQuestionId) || null;\n  }, [availableFilterQuestionOptions, selectedFilterQuestionId]);\n\n  const canAddProjectFilter = Boolean(selectedFilterOption && !selectedFilterOption.disabled);\n\n  const availableInspirationFilterQuestionOptions = useMemo(() => {\n    const usedQuestionIds = new Set();\n\n    if (Array.isArray(normalizedInspirationFilters.fields)) {\n      normalizedInspirationFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n          ? field.sourceQuestionId.trim()\n          : field.id;\n\n        if (sourceId) {\n          usedQuestionIds.add(sourceId);\n        }\n      });\n    }\n\n    const options = Array.isArray(inspirationFormFieldEntries)\n      ? inspirationFormFieldEntries\n          .filter((field) => field && INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES.has(field.type))\n          .map((field) => ({\n            value: field.id,\n            label: field.label || field.id,\n            disabled: usedQuestionIds.has(field.id),\n            type: field.type\n          }))\n      : [];\n\n    return options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }));\n  }, [inspirationFormFieldEntries, normalizedInspirationFilters.fields]);\n\n  const selectedInspirationFilterOption = useMemo(() => {\n    if (!selectedInspirationFilterQuestionId) {\n      return null;\n    }\n\n    return availableInspirationFilterQuestionOptions.find(\n      (option) => option.value === selectedInspirationFilterQuestionId\n    ) || null;\n  }, [availableInspirationFilterQuestionOptions, selectedInspirationFilterQuestionId]);\n\n  const canAddInspirationFilter = Boolean(\n    selectedInspirationFilterOption && !selectedInspirationFilterOption.disabled\n  );\n\n  const handleProjectFilterToggle = useCallback((fieldId, enabled) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(prev => updateProjectFilterField(prev, fieldId, { enabled }));\n  }, [setProjectFilters]);\n\n  const handleProjectFilterLabelChange = useCallback((fieldId, label) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(prev => updateProjectFilterField(prev, fieldId, { label }));\n  }, [setProjectFilters]);\n\n  const handleAddProjectFilter = useCallback(() => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    const questionId = typeof selectedFilterQuestionId === 'string'\n      ? selectedFilterQuestionId.trim()\n      : '';\n\n    if (questionId.length === 0) {\n      return;\n    }\n\n    const question = Array.isArray(questions)\n      ? questions.find((item) => item && item.id === questionId)\n      : null;\n\n    if (!question || !FILTER_COMPATIBLE_QUESTION_TYPES.has(question.type)) {\n      return;\n    }\n\n    setProjectFilters((prev) => {\n      const normalized = normalizeProjectFilterConfig(prev);\n      const existing = Array.isArray(normalized.fields)\n        ? normalized.fields.some((field) => {\n            if (!field) {\n              return false;\n            }\n\n            const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n              ? field.sourceQuestionId.trim()\n              : field.id;\n\n            return sourceId === questionId;\n          })\n        : false;\n\n      if (existing) {\n        return normalized;\n      }\n\n      const type = question.type === 'choice' ? 'select' : 'text';\n      const newField = {\n        id: question.id,\n        label: question.question || question.id,\n        type,\n        enabled: true,\n        sourceQuestionId: question.id\n      };\n\n      if (type === 'select') {\n        newField.emptyOptionLabel = question.id === 'teamLeadTeam' ? 'Toutes les équipes' : 'Toutes les valeurs';\n      }\n\n      const fields = Array.isArray(normalized.fields) ? [...normalized.fields, newField] : [newField];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n\n    setSelectedFilterQuestionId('');\n  }, [questions, selectedFilterQuestionId, setProjectFilters]);\n\n  const handleAddInspirationFilter = useCallback(() => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const fieldId = typeof selectedInspirationFilterQuestionId === 'string'\n      ? selectedInspirationFilterQuestionId.trim()\n      : '';\n\n    if (fieldId.length === 0) {\n      return;\n    }\n\n    const formField = Array.isArray(inspirationFormFieldEntries)\n      ? inspirationFormFieldEntries.find((field) => field && field.id === fieldId)\n      : null;\n\n    if (!formField || !INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES.has(formField.type)) {\n      return;\n    }\n\n    setInspirationFilters((prev) => {\n      const normalized = normalizeInspirationFiltersConfig(prev);\n      const existing = Array.isArray(normalized.fields)\n        ? normalized.fields.some((field) => {\n            if (!field) {\n              return false;\n            }\n\n            const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n              ? field.sourceQuestionId.trim()\n              : field.id;\n\n            return sourceId === fieldId;\n          })\n        : false;\n\n      if (existing) {\n        return normalized;\n      }\n\n      const type = formField.type === 'select' || formField.type === 'multi_select' ? 'select' : 'text';\n      const newField = {\n        id: formField.id,\n        label: formField.label || formField.id,\n        type,\n        enabled: true,\n        sourceQuestionId: formField.id\n      };\n\n      if (type === 'select') {\n        newField.emptyOptionLabel = 'Toutes les valeurs';\n        if (Array.isArray(formField.options)) {\n          newField.options = formField.options;\n        }\n      }\n\n      const fields = Array.isArray(normalized.fields) ? [...normalized.fields, newField] : [newField];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n\n    setSelectedInspirationFilterQuestionId('');\n  }, [\n    inspirationFormFieldEntries,\n    selectedInspirationFilterQuestionId,\n    setInspirationFilters\n  ]);\n\n  const handleRemoveProjectFilter = useCallback((field) => {\n    if (!field || typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    if (field.id === 'dateOrder') {\n      return;\n    }\n\n    const label = field.label || field.id || 'filtre';\n    const confirmationMessage = `Voulez-vous vraiment supprimer le filtre « ${label} » ?`;\n    const shouldDelete = confirmDeletion(confirmationMessage);\n\n    if (!shouldDelete) {\n      return;\n    }\n\n    const currentFields = Array.isArray(normalizedProjectFilters.fields)\n      ? normalizedProjectFilters.fields\n      : [];\n\n    const index = currentFields.findIndex((item) => item && item.id === field.id);\n    if (index === -1) {\n      return;\n    }\n\n    const removedField = currentFields[index];\n    pushUndoEntry({\n      type: 'projectFilter',\n      item: removedField,\n      index,\n      message: `Le filtre « ${removedField.label || removedField.id || 'filtre'} » a été supprimé. Appuyez sur Ctrl+Z pour annuler.`\n    });\n\n    setProjectFilters((prev) => {\n      const normalized = normalizeProjectFilterConfig(prev);\n      const fields = Array.isArray(normalized.fields)\n        ? normalized.fields.filter((item) => item && item.id !== field.id)\n        : [];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n  }, [confirmDeletion, normalizedProjectFilters, pushUndoEntry, setProjectFilters]);\n\n  const handleRemoveInspirationFilter = useCallback((field) => {\n    if (!field || typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const label = field.label || field.id || 'filtre';\n    const confirmationMessage = `Voulez-vous vraiment supprimer le filtre « ${label} » ?`;\n    const shouldDelete = confirmDeletion(confirmationMessage);\n\n    if (!shouldDelete) {\n      return;\n    }\n\n    const currentFields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    const index = currentFields.findIndex((item) => item && item.id === field.id);\n    if (index === -1) {\n      return;\n    }\n\n    const removedField = currentFields[index];\n    pushUndoEntry({\n      type: 'inspirationFilter',\n      item: removedField,\n      index,\n      message: `Le filtre « ${removedField.label || removedField.id || 'filtre'} » a été supprimé. Appuyez sur Ctrl+Z pour annuler.`\n    });\n\n    setInspirationFilters((prev) => {\n      const normalized = normalizeInspirationFiltersConfig(prev);\n      const fields = Array.isArray(normalized.fields)\n        ? normalized.fields.filter((item) => item && item.id !== field.id)\n        : [];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n  }, [confirmDeletion, normalizedInspirationFilters, pushUndoEntry, setInspirationFilters]);\n\n  const handleProjectFilterDefaultSortChange = useCallback((value) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    const direction = value === 'asc' ? 'asc' : 'desc';\n    setProjectFilters(prev => {\n      const updated = updateProjectFilterField(prev, 'dateOrder', { defaultValue: direction });\n      return {\n        ...updated,\n        sortOrder: direction\n      };\n    });\n  }, [setProjectFilters]);\n\n  const handleResetProjectFilters = useCallback(() => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(resetProjectFiltersConfig());\n  }, [setProjectFilters]);\n\n  const formatOptionList = (options) => (Array.isArray(options) ? options.join(', ') : '');\n\n  const parseOptionList = (value) => {\n    if (typeof value !== 'string') {\n      return [];\n    }\n\n    return value\n      .split(',')\n      .map((option) => option.trim())\n      .filter((option) => option.length > 0);\n  };\n\n  const sanitizeInspirationFieldId = (value) => {\n    if (typeof value !== 'string') {\n      return '';\n    }\n\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return '';\n    }\n\n    return trimmed\n      .replace(/\\s+/g, '_')\n      .replace(/[^a-zA-Z0-9_-]/g, '');\n  };\n\n  const suggestedNewInspirationFieldId = useMemo(() => {\n    const directId = sanitizeInspirationFieldId(newInspirationFormField.id);\n    if (directId) {\n      return directId;\n    }\n\n    return sanitizeInspirationFieldId(newInspirationFormField.label);\n  }, [newInspirationFormField.id, newInspirationFormField.label]);\n\n  const isNewInspirationFieldIdDuplicate =\n    suggestedNewInspirationFieldId.length > 0 && inspirationFieldIds.has(suggestedNewInspirationFieldId);\n\n  const canAddInspirationFormField =\n    suggestedNewInspirationFieldId.length > 0\n    && newInspirationFormField.label.trim().length > 0\n    && !isNewInspirationFieldIdDuplicate;\n\n  const handleInspirationFilterToggle = useCallback((fieldId, enabled) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { enabled }));\n  }, [setInspirationFilters]);\n\n  const handleInspirationFilterLabelChange = useCallback((fieldId, label) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { label }));\n  }, [setInspirationFilters]);\n\n  const handleInspirationFilterOptionsChange = useCallback((fieldId, rawValue) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const options = parseOptionList(rawValue);\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { options }));\n  }, [setInspirationFilters]);\n\n  const handleResetInspirationFilters = useCallback(() => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters(resetInspirationFiltersConfig());\n  }, [setInspirationFilters]);\n\n  const handleInspirationFormFieldToggle = useCallback((fieldId, enabled) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { enabled }));\n  }, [setInspirationFilters, setInspirationFormFields]);\n\n  const handleInspirationFormFieldLabelChange = useCallback((fieldId, label) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { label }));\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldTypeChange = useCallback((fieldId, nextType) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const normalizedType = INSPIRATION_FORM_FIELD_TYPE_OPTIONS.some((option) => option.value === nextType)\n      ? nextType\n      : 'text';\n\n    setInspirationFormFields((prev) => {\n      const normalized = normalizeInspirationFormConfig(prev);\n      const currentField = normalized.fields.find((field) => field.id === fieldId);\n      const nextOptions = normalizedType === 'select' || normalizedType === 'multi_select'\n        ? (Array.isArray(currentField?.options) && currentField.options.length > 0\n          ? currentField.options\n          : ['Option 1', 'Option 2'])\n        : undefined;\n\n      return updateInspirationFormField(prev, fieldId, {\n        type: normalizedType,\n        options: nextOptions\n      });\n    });\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldPlaceholderChange = useCallback((fieldId, placeholder) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { placeholder }));\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldOptionsChange = useCallback((fieldId, rawValue) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const options = parseOptionList(rawValue);\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { options }));\n    if (typeof setInspirationFilters === 'function') {\n      setInspirationFilters((prev) => {\n        const normalized = normalizeInspirationFiltersConfig(prev);\n        let nextConfig = normalized;\n\n        normalized.fields.forEach((field) => {\n          const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n            ? field.sourceQuestionId.trim()\n            : field.id;\n\n          if (sourceId === fieldId && field.type === 'select') {\n            nextConfig = updateInspirationFilterField(nextConfig, field.id, { options });\n          }\n        });\n\n        return nextConfig;\n      });\n    }\n  }, [setInspirationFormFields]);\n\n  const handleAddInspirationFormField = useCallback(() => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const label = newInspirationFormField.label.trim();\n    if (!label) {\n      return;\n    }\n\n    const fieldId = suggestedNewInspirationFieldId;\n    if (!fieldId || inspirationFieldIds.has(fieldId)) {\n      return;\n    }\n\n    const normalizedType = INSPIRATION_FORM_FIELD_TYPE_OPTIONS.some((option) => option.value === newInspirationFormField.type)\n      ? newInspirationFormField.type\n      : 'text';\n\n    const nextField = {\n      id: fieldId,\n      label,\n      type: normalizedType,\n      enabled: Boolean(newInspirationFormField.enabled),\n      required: Boolean(newInspirationFormField.required)\n    };\n\n    const placeholder = newInspirationFormField.placeholder.trim();\n    if (INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(normalizedType) && placeholder.length > 0) {\n      nextField.placeholder = placeholder;\n    }\n\n    if (normalizedType === 'select' || normalizedType === 'multi_select') {\n      const parsedOptions = parseOptionList(newInspirationFormField.options);\n      nextField.options = parsedOptions.length > 0 ? parsedOptions : ['Option 1', 'Option 2'];\n    }\n\n    setInspirationFormFields((prev) => {\n      const normalized = normalizeInspirationFormConfig(prev);\n      return {\n        ...normalized,\n        fields: [...normalized.fields, nextField]\n      };\n    });\n\n    setNewInspirationFormField(createEmptyInspirationFormField());\n  }, [\n    inspirationFieldIds,\n    newInspirationFormField,\n    setInspirationFormFields,\n    suggestedNewInspirationFieldId\n  ]);\n\n  const handleInspirationFormFieldRequiredChange = useCallback((fieldId, required) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { required }));\n  }, [setInspirationFormFields]);\n\n  const handleResetInspirationFormFields = useCallback(() => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields(resetInspirationFormConfig());\n  }, [setInspirationFormFields]);\n\n  const toggleQuestionExpansion = useCallback((questionId) => {\n    if (!questionId && questionId !== 0) {\n      return;\n    }\n\n    const normalizedId = typeof questionId === 'string' ? questionId : String(questionId);\n    setExpandedQuestionIds((prev) => {\n      const next = new Set(prev);\n      if (next.has(normalizedId)) {\n        next.delete(normalizedId);\n      } else {\n        next.add(normalizedId);\n      }\n      return next;\n    });\n  }, []);\n\n  const toggleRuleExpansion = useCallback((ruleId) => {\n    if (!ruleId && ruleId !== 0) {\n      return;\n    }\n\n    const normalizedId = typeof ruleId === 'string' ? ruleId : String(ruleId);\n    setExpandedRuleIds((prev) => {\n      const next = new Set(prev);\n      if (next.has(normalizedId)) {\n        next.delete(normalizedId);\n      } else {\n        next.add(normalizedId);\n      }\n      return next;\n    });\n  }, []);\n\n  const handleRiskWeightChange = (key, rawValue) => {\n    if (typeof setRiskWeights !== 'function') {\n      return;\n    }\n\n    setRiskWeights(prevWeights => {\n      const base = typeof prevWeights === 'object' && prevWeights !== null\n        ? { ...prevWeights }\n        : {};\n\n      const parsed = Number.parseFloat(rawValue);\n\n      if (Number.isNaN(parsed)) {\n        return prevWeights;\n      }\n\n      const sanitized = parsed < 0 ? 0 : parsed;\n\n      if (base[key] === sanitized) {\n        return prevWeights;\n      }\n\n      base[key] = sanitized;\n      return base;\n    });\n  };\n\n  const dataIntegrityIssues = useMemo(() => {\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n    const safeRules = Array.isArray(rules) ? rules : [];\n    const safeTeams = Array.isArray(teams) ? teams : [];\n\n    const questionMap = new Map();\n    safeQuestions.forEach((question) => {\n      if (question?.id) {\n        questionMap.set(question.id, question);\n      }\n    });\n\n    const questionIds = new Set(questionMap.keys());\n\n    const questionOptionMap = new Map();\n    questionMap.forEach((question, id) => {\n      if (Array.isArray(question?.options) && question.options.length > 0) {\n        const normalizedOptions = question.options\n          .map((option) => {\n            if (\n              typeof option === 'string' ||\n              typeof option === 'number' ||\n              typeof option === 'boolean'\n            ) {\n              return String(option);\n            }\n            return null;\n          })\n          .filter(Boolean);\n\n        if (normalizedOptions.length > 0) {\n          questionOptionMap.set(id, new Set(normalizedOptions));\n        }\n      }\n    });\n\n    const teamIds = new Set(\n      safeTeams\n        .map((team) => (team?.id ? team.id : null))\n        .filter(Boolean)\n    );\n    const teamNameMap = new Map();\n    safeTeams.forEach(team => {\n      if (team?.id) {\n        teamNameMap.set(team.id, team?.name || team.id);\n      }\n    });\n\n    const issues = [];\n    let issueIndex = 0;\n\n    const pushIssue = ({ scope, context, message, severity = 'warning' }) => {\n      issueIndex += 1;\n      issues.push({\n        id: `integrity-${issueIndex}`,\n        scope,\n        context,\n        message,\n        severity\n      });\n    };\n\n    const formatConditionPosition = (groupIndex, conditionIndex) => {\n      return `groupe ${groupIndex + 1}, condition ${conditionIndex + 1}`;\n    };\n\n    const getQuestionLabel = (questionId) => {\n      const reference = questionMap.get(questionId);\n      if (!reference) {\n        return questionId || 'Question inconnue';\n      }\n      return reference.question || reference.id || questionId;\n    };\n\n    const collectInvalidOptionValues = (value, optionsSet) => {\n      if (!optionsSet || optionsSet.size === 0) {\n        return [];\n      }\n\n      const invalidValues = [];\n      const inspectValue = (candidate) => {\n        if (candidate === null || candidate === undefined) {\n          return;\n        }\n        if (\n          typeof candidate !== 'string' &&\n          typeof candidate !== 'number' &&\n          typeof candidate !== 'boolean'\n        ) {\n          return;\n        }\n\n        const normalizedCandidate = String(candidate);\n        if (!optionsSet.has(normalizedCandidate)) {\n          invalidValues.push(normalizedCandidate);\n        }\n      };\n\n      if (Array.isArray(value)) {\n        value.forEach(inspectValue);\n      } else {\n        inspectValue(value);\n      }\n\n      return invalidValues;\n    };\n\n    safeQuestions.forEach((question) => {\n      const groups = normalizeConditionGroups(question);\n      const context = `Question « ${question.question || question.id || 'Sans titre'} »`;\n\n      groups.forEach((group, groupIndex) => {\n        const conditions = Array.isArray(group?.conditions) ? group.conditions : [];\n\n        conditions.forEach((condition, conditionIndex) => {\n          if (!condition) {\n            return;\n          }\n\n          const position = formatConditionPosition(groupIndex, conditionIndex);\n          const targetId = condition.question;\n\n          if (!targetId) {\n            pushIssue({\n              scope: 'questions',\n              context,\n              message: `La condition ${position} n'indique aucune question de référence. Sélectionnez une question cible ou retirez cette condition.`\n            });\n            return;\n          }\n\n          if (!questionIds.has(targetId)) {\n            pushIssue({\n              scope: 'questions',\n              context,\n              message: `La condition ${position} référence la question « ${targetId} » qui n'existe plus. Mettez à jour le ciblage ou supprimez cette condition.`\n            });\n            return;\n          }\n\n          const optionsSet = questionOptionMap.get(targetId);\n          if (optionsSet && optionsSet.size > 0) {\n            const invalidValues = collectInvalidOptionValues(condition.value, optionsSet);\n\n            if (invalidValues.length > 0) {\n              const formattedValues = invalidValues.map((value) => `« ${value} »`).join(', ');\n              const targetLabel = getQuestionLabel(targetId);\n\n              pushIssue({\n                scope: 'questions',\n                context,\n                message: `La condition ${position} utilise ${formattedValues} qui ne fait pas partie des options disponibles pour « ${targetLabel} ». Ajustez la valeur attendue.`\n              });\n            }\n          }\n        });\n      });\n    });\n\n    safeRules.forEach((rule) => {\n      const ruleLabel = rule?.name || rule?.id || 'Règle';\n      const context = `Règle « ${ruleLabel} »`;\n      const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n\n      groups.forEach((group, groupIndex) => {\n        const conditions = Array.isArray(group?.conditions) ? group.conditions : [];\n\n        conditions.forEach((condition, conditionIndex) => {\n          if (!condition) {\n            return;\n          }\n\n          const position = formatConditionPosition(groupIndex, conditionIndex);\n\n          if (condition.type === 'timing') {\n            if (!condition.startQuestion) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition temporelle ${position} ne définit pas de question de départ. Sélectionnez une question d'origine.`\n              });\n            } else if (!questionIds.has(condition.startQuestion)) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La question de départ « ${condition.startQuestion} » utilisée dans la condition temporelle ${position} n'existe plus.`\n              });\n            }\n\n            if (!condition.endQuestion) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition temporelle ${position} ne définit pas de question d'arrivée. Sélectionnez une question de fin.`\n              });\n            } else if (!questionIds.has(condition.endQuestion)) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La question de fin « ${condition.endQuestion} » utilisée dans la condition temporelle ${position} n'existe plus.`\n              });\n            }\n\n            return;\n          }\n\n          const targetId = condition.question;\n\n          if (!targetId) {\n            pushIssue({\n              scope: 'rules',\n              context,\n              message: `La condition ${position} n'indique aucune question de référence. Complétez la configuration ou supprimez cette condition.`\n            });\n            return;\n          }\n\n          if (!questionIds.has(targetId)) {\n            pushIssue({\n              scope: 'rules',\n              context,\n              message: `La condition ${position} référence la question « ${targetId} » qui n'existe plus. Mettez à jour la condition.`\n            });\n            return;\n          }\n\n          const optionsSet = questionOptionMap.get(targetId);\n          if (optionsSet && optionsSet.size > 0) {\n            const invalidValues = collectInvalidOptionValues(condition.value, optionsSet);\n\n            if (invalidValues.length > 0) {\n              const formattedValues = invalidValues.map((value) => `« ${value} »`).join(', ');\n              const targetLabel = getQuestionLabel(targetId);\n\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition ${position} utilise ${formattedValues} qui ne sont pas proposés par « ${targetLabel} ». Ajustez la valeur ou les options.`\n              });\n            }\n          }\n        });\n      });\n\n      const ruleTeams = Array.isArray(rule?.teams) ? rule.teams : [];\n      ruleTeams.forEach((teamId) => {\n        if (!teamId) {\n          return;\n        }\n\n        if (!teamIds.has(teamId)) {\n          pushIssue({\n            scope: 'teams',\n            context,\n            message: `L'équipe « ${teamId} » n'existe plus dans le référentiel. Retirez-la de la règle ou ajoutez l'équipe correspondante.`\n          });\n        }\n      });\n\n      if (rule?.questions && typeof rule.questions === 'object') {\n        Object.entries(rule.questions).forEach(([teamId, teamQuestions]) => {\n          if (!teamIds.has(teamId)) {\n            pushIssue({\n              scope: 'teams',\n              context,\n              message: `La section d'accompagnement « ${teamId} » n'est associée à aucune équipe existante. Renommez la clé ou créez l'équipe correspondante.`\n            });\n            return;\n          }\n\n          const entries = Array.isArray(teamQuestions) ? teamQuestions : [];\n          entries.forEach((questionEntry, questionIndex) => {\n            const sanitizedEntry = sanitizeTeamQuestionEntry(questionEntry);\n            const questionLabel = sanitizedEntry.text ? sanitizedEntry.text : `Question ${questionIndex + 1}`;\n            const questionContext = `Règle « ${ruleLabel} » · ${teamNameMap.get(teamId) || teamId} · ${questionLabel}`;\n            const timingConstraint = sanitizeRiskTimingConstraint(sanitizedEntry.timingConstraint);\n\n            if (timingConstraint.enabled) {\n              if (!timingConstraint.startQuestion) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `Le contrôle de délai ne définit pas de question de départ. Sélectionnez une question de début.`\n                });\n              } else if (!questionIds.has(timingConstraint.startQuestion)) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `La question de départ « ${timingConstraint.startQuestion} » utilisée pour le délai n'existe plus.`\n                });\n              } else {\n                const startQuestion = questionMap.get(timingConstraint.startQuestion);\n                if ((startQuestion?.type || 'choice') !== 'date') {\n                  pushIssue({\n                    scope: 'rules',\n                    context: questionContext,\n                    message: `La question de départ « ${timingConstraint.startQuestion} » n'est pas de type date. Choisissez une question de type date.`\n                  });\n                }\n              }\n\n              if (!timingConstraint.endQuestion) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `Le contrôle de délai ne définit pas de question d'arrivée. Sélectionnez une question de fin.`\n                });\n              } else if (!questionIds.has(timingConstraint.endQuestion)) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `La question de fin « ${timingConstraint.endQuestion} » utilisée pour le délai n'existe plus.`\n                });\n              } else {\n                const endQuestion = questionMap.get(timingConstraint.endQuestion);\n                if ((endQuestion?.type || 'choice') !== 'date') {\n                  pushIssue({\n                    scope: 'rules',\n                    context: questionContext,\n                    message: `La question de fin « ${timingConstraint.endQuestion} » n'est pas de type date. Choisissez une question de type date.`\n                  });\n                }\n              }\n            }\n          });\n        });\n      }\n    });\n\n    return issues;\n  }, [questions, rules, teams]);\n\n  const dataIntegritySummary = useMemo(() => {\n    if (!dataIntegrityIssues || dataIntegrityIssues.length === 0) {\n      return [];\n    }\n\n    const labels = {\n      questions: 'Questions',\n      rules: 'Règles',\n      teams: 'Équipes',\n      general: 'Général'\n    };\n\n    const counts = dataIntegrityIssues.reduce((accumulator, issue) => {\n      const key = issue.scope || 'general';\n      const current = accumulator[key] || 0;\n      return { ...accumulator, [key]: current + 1 };\n    }, {});\n\n    return Object.entries(counts).map(([scope, count]) => ({\n      scope,\n      count,\n      label: labels[scope] || 'Autres'\n    }));\n  }, [dataIntegrityIssues]);\n\n  useEffect(() => {\n    if (!reorderAnnouncement || typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const timeout = window.setTimeout(() => {\n      setReorderAnnouncement('');\n    }, 2000);\n\n    return () => {\n      window.clearTimeout(timeout);\n    };\n  }, [reorderAnnouncement]);\n\n  const moveQuestion = (fromIndex, toIndex) => {\n    if (fromIndex === toIndex) {\n      return;\n    }\n\n    setQuestions(prevQuestions => {\n      if (\n        fromIndex < 0 ||\n        fromIndex >= prevQuestions.length ||\n        toIndex < 0 ||\n        toIndex >= prevQuestions.length\n      ) {\n        return prevQuestions;\n      }\n\n      const updated = [...prevQuestions];\n      const [movedQuestion] = updated.splice(fromIndex, 1);\n      updated.splice(toIndex, 0, movedQuestion);\n\n      if (movedQuestion) {\n        const label = movedQuestion.question || movedQuestion.id || 'Question';\n        setReorderAnnouncement(`La question « ${label} » est maintenant en position ${toIndex + 1} sur ${updated.length}.`);\n      }\n\n      return updated;\n    });\n  };\n\n  const handleDragStart = (event, index) => {\n    if (event?.dataTransfer) {\n      event.dataTransfer.effectAllowed = 'move';\n      event.dataTransfer.setData('text/plain', String(index));\n    }\n    setDraggedQuestionIndex(index);\n    setDragOverIndex(index);\n  };\n\n  const handleDragOver = (event, index) => {\n    event.preventDefault();\n    if (dragOverIndex !== index) {\n      setDragOverIndex(index);\n    }\n  };\n\n  const handleDrop = (event, index) => {\n    event.preventDefault();\n\n    let fromIndex = draggedQuestionIndex;\n    if (fromIndex === null) {\n      const transferIndex = Number.parseInt(event?.dataTransfer?.getData('text/plain'), 10);\n      if (Number.isFinite(transferIndex)) {\n        fromIndex = transferIndex;\n      }\n    }\n\n    if (fromIndex !== null) {\n      moveQuestion(fromIndex, index);\n    }\n\n    setDraggedQuestionIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedQuestionIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleKeyboardReorder = (event, index) => {\n    if (questions.length <= 1) {\n      return;\n    }\n\n    if (event.key === 'ArrowUp' && index > 0) {\n      event.preventDefault();\n      moveQuestion(index, index - 1);\n    } else if (event.key === 'ArrowDown' && index < questions.length - 1) {\n      event.preventDefault();\n      moveQuestion(index, index + 1);\n    } else if (event.key === 'Home') {\n      event.preventDefault();\n      moveQuestion(index, 0);\n    } else if (event.key === 'End') {\n      event.preventDefault();\n      moveQuestion(index, questions.length - 1);\n    }\n  };\n\n  const getNextId = (items, prefix) => {\n    const ids = new Set(items.map((item) => item.id));\n    const maxNumericSuffix = items\n      .map((item) => item.id)\n      .filter((id) => typeof id === 'string' && id.startsWith(prefix))\n      .map((id) => Number.parseInt(id.slice(prefix.length), 10))\n      .filter((value) => Number.isFinite(value))\n      .reduce((max, value) => Math.max(max, value), 0);\n\n    let counter = maxNumericSuffix + 1;\n    let candidate = `${prefix}${counter}`;\n    while (ids.has(candidate)) {\n      counter += 1;\n      candidate = `${prefix}${counter}`;\n    }\n    return candidate;\n  };\n\n  const cloneData = (value) => {\n    if (Array.isArray(value)) {\n      return value.map((item) => cloneData(item));\n    }\n    if (value && typeof value === 'object') {\n      const cloned = {};\n      Object.keys(value).forEach((key) => {\n        cloned[key] = cloneData(value[key]);\n      });\n      return cloned;\n    }\n    return value;\n  };\n\n  const getDuplicateId = (items, baseId, fallbackPrefix) => {\n    const existingIds = new Set(items.map((item) => item.id));\n    const rawBase = typeof baseId === 'string' ? baseId.trim() : '';\n    const sanitizedBase = rawBase !== '' ? rawBase.replace(/\\s+/g, '_') : '';\n\n    if (sanitizedBase) {\n      let candidate = `${sanitizedBase}_copy`;\n      let counter = 2;\n\n      while (existingIds.has(candidate)) {\n        candidate = `${sanitizedBase}_copy${counter}`;\n        counter += 1;\n      }\n\n      return candidate;\n    }\n\n    return getNextId(items, fallbackPrefix);\n  };\n\n  const addRiskLevelRule = () => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    const nextId = getNextId(safeRiskLevelRules, 'risk_level_');\n    const lastRule = safeRiskLevelRules[safeRiskLevelRules.length - 1];\n    const baseMinimum = lastRule\n      ? Math.max(\n        0,\n        (() => {\n          const lastMax = getRuleMaxScoreValue(lastRule);\n          if (lastMax !== null) {\n            return lastMax + 1;\n          }\n          const lastMin = getRuleMinScoreValue(lastRule);\n          return lastMin + 1;\n        })()\n      )\n      : 0;\n\n    const newRule = {\n      id: nextId,\n      label: 'Nouveau niveau',\n      minRisks: baseMinimum,\n      maxRisks: null,\n      minScore: baseMinimum,\n      maxScore: null,\n      description: ''\n    };\n\n    setRiskLevelRules([...safeRiskLevelRules, newRule]);\n    setActiveTab('riskLevels');\n    setReorderAnnouncement(`Niveau de risque ajouté en position ${safeRiskLevelRules.length + 1}.`);\n  };\n\n  const updateRiskLevelRuleField = (index, field, value) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (!baseRules[index]) {\n        return prevRules;\n      }\n\n      const updatedRule = { ...baseRules[index] };\n\n      if (field === 'label') {\n        updatedRule.label = value;\n      } else if (field === 'description') {\n        updatedRule.description = value;\n      } else if (field === 'minRisks' || field === 'minScore') {\n        const parsed = Number.parseFloat(value);\n        const sanitized = Number.isNaN(parsed) ? 0 : Math.max(0, parsed);\n        updatedRule.minRisks = sanitized;\n        updatedRule.minScore = sanitized;\n      } else if (field === 'maxRisks' || field === 'maxScore') {\n        if (value === '' || value === null) {\n          updatedRule.maxRisks = null;\n          updatedRule.maxScore = null;\n        } else {\n          const parsed = Number.parseFloat(value);\n          if (Number.isNaN(parsed)) {\n            updatedRule.maxRisks = null;\n            updatedRule.maxScore = null;\n          } else {\n            const sanitized = Math.max(0, parsed);\n            updatedRule.maxRisks = sanitized;\n            updatedRule.maxScore = sanitized;\n          }\n        }\n      }\n\n      baseRules[index] = updatedRule;\n      return baseRules;\n    });\n  };\n\n  const deleteRiskLevelRule = (id, index) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    if (safeRiskLevelRules.length <= 1) {\n      setReorderAnnouncement('Au moins un niveau de risque doit être conservé.');\n      return;\n    }\n\n    const normalizedIndex = Number.isInteger(index) && index >= 0\n      ? index\n      : safeRiskLevelRules.findIndex((rule) => rule?.id === id);\n\n    if (normalizedIndex < 0 || normalizedIndex >= safeRiskLevelRules.length) {\n      return;\n    }\n\n    const targetRule = safeRiskLevelRules[normalizedIndex];\n    const label = targetRule?.label || targetRule?.id || `Niveau ${normalizedIndex + 1}`;\n\n    if (!confirmDeletion(`Êtes-vous sûr de vouloir supprimer le niveau de complexité « ${label} » ? Cette action peut être annulée (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'riskLevelRule',\n      index: normalizedIndex,\n      item: cloneData(targetRule),\n      message: `Le niveau « ${label} » a été supprimé. Cliquez sur « Annuler » ou utilisez Ctrl+Z pour le restaurer.`,\n    });\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (normalizedIndex < 0 || normalizedIndex >= baseRules.length) {\n        return baseRules;\n      }\n      baseRules.splice(normalizedIndex, 1);\n      return baseRules;\n    });\n\n    setReorderAnnouncement(`Niveau de risque supprimé. ${Math.max(safeRiskLevelRules.length - 1, 0)} niveau(x) restant(s).`);\n  };\n\n  const moveRiskLevelRule = (fromIndex, toIndex) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    if (\n      fromIndex === toIndex ||\n      fromIndex < 0 ||\n      toIndex < 0 ||\n      fromIndex >= safeRiskLevelRules.length ||\n      toIndex >= safeRiskLevelRules.length\n    ) {\n      return;\n    }\n\n    const movedRule = safeRiskLevelRules[fromIndex];\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (\n        fromIndex < 0 ||\n        fromIndex >= baseRules.length ||\n        toIndex < 0 ||\n        toIndex >= baseRules.length\n      ) {\n        return prevRules;\n      }\n\n      const next = [...baseRules];\n      const [extracted] = next.splice(fromIndex, 1);\n      next.splice(toIndex, 0, extracted);\n      return next;\n    });\n\n    if (movedRule) {\n      const label = movedRule.label || movedRule.id || 'Niveau de risque';\n      setReorderAnnouncement(`Le niveau « ${label} » est maintenant en position ${toIndex + 1} sur ${safeRiskLevelRules.length}.`);\n    }\n  };\n\n  const formatRiskRangeLabel = (rule) => {\n    const minScore = getRuleMinScoreValue(rule);\n    const maxScore = getRuleMaxScoreValue(rule);\n\n    const minLabel = formatScoreValue(minScore);\n    const minUnit = getPointUnit(minScore);\n\n    if (maxScore === null) {\n      return `≥ ${minLabel} ${minUnit}`;\n    }\n\n    if (minScore === maxScore) {\n      return `${minLabel} ${getPointUnit(minScore)}`;\n    }\n\n    const maxLabel = formatScoreValue(maxScore);\n    return `${minLabel} à ${maxLabel} points`;\n  };\n\n  const getRiskLevelRuleIssues = (rule, index, rulesList) => {\n    const issues = [];\n    const min = getRuleMinScoreValue(rule);\n    const max = getRuleMaxScoreValue(rule);\n\n    if (max !== null && max < min) {\n      issues.push('Le score maximal doit être supérieur ou égal au score minimal.');\n    }\n\n    if (index > 0) {\n      const previous = rulesList[index - 1];\n      const previousMax = getRuleMaxScoreValue(previous);\n\n      if (previousMax === null) {\n        issues.push('Le niveau précédent couvre déjà tous les scores (maximum illimité). Ajustez-le avant d’ajouter ce palier.');\n      } else if (min <= previousMax) {\n        issues.push(`Le score minimal doit être strictement supérieur à ${formatScoreValue(previousMax)}, le maximum du niveau précédent.`);\n      }\n    }\n\n    return issues;\n  };\n\n  const downloadDataModule = (filename, exportName, data) => {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    const serialized = JSON.stringify(data, null, 2);\n    const moduleContent = `export const ${exportName} = ${serialized};\\n`;\n    const blob = new Blob([moduleContent], { type: 'application/javascript;charset=utf-8' });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    window.URL.revokeObjectURL(url);\n  };\n\n  const handleDownloadDataFiles = () => {\n    downloadDataModule('questions.js', 'initialQuestions', questions);\n    downloadDataModule('rules.js', 'initialRules', rules);\n    downloadDataModule('riskLevelRules.js', 'initialRiskLevelRules', safeRiskLevelRules);\n    downloadDataModule('teams.js', 'initialTeams', teams);\n  };\n\n  const inspirationFilterCount = inspirationFilterFields.length;\n  const inspirationFormCount = inspirationFormFieldEntries.length;\n\n  const tabDefinitions = [\n    {\n      id: 'dashboard',\n      label: 'Dashboard',\n      panelId: 'backoffice-tabpanel-dashboard'\n    },\n    {\n      id: 'filters',\n      label: `Filtres d'accueil (${filterFields.length})`,\n      panelId: 'backoffice-tabpanel-filters'\n    },\n    {\n      id: 'inspiration',\n      label: `Inspiration (${inspirationFilterCount + inspirationFormCount})`,\n      panelId: 'backoffice-tabpanel-inspiration'\n    },\n    {\n      id: 'themes',\n      label: `Thèmes vitrine (${showcaseThemeCount})`,\n      panelId: 'backoffice-tabpanel-themes'\n    },\n    {\n      id: 'questions',\n      label: `Questions (${questions.length})`,\n      panelId: 'backoffice-tabpanel-questions'\n    },\n    {\n      id: 'rules',\n      label: `Règles (${rules.length})`,\n      panelId: 'backoffice-tabpanel-rules'\n    },\n    {\n      id: 'riskLevels',\n      label: `Niveaux de complexité (${riskLevelRuleCount})`,\n      panelId: 'backoffice-tabpanel-risk-levels'\n    },\n    {\n      id: 'teams',\n      label: `Équipes (${teams.length})`,\n      panelId: 'backoffice-tabpanel-teams'\n    }\n  ];\n\n  const createDefaultQuestion = (existingQuestions) => ({\n    id: getNextId(existingQuestions, 'q'),\n    type: 'choice',\n    question: 'Nouvelle question',\n    options: ['Option 1', 'Option 2'],\n    required: true,\n    conditions: [],\n    conditionLogic: 'all',\n    conditionGroups: [],\n    placeholder: '',\n    numberUnit: '',\n    guidance: {\n      objective: '',\n      details: '',\n      tips: []\n    }\n  });\n\n  const addQuestion = () => {\n    const newQuestion = createDefaultQuestion(questions);\n\n    setQuestions([...questions, newQuestion]);\n    setEditingQuestion(newQuestion);\n    if (newQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const next = new Set(prev);\n        next.add(newQuestion.id);\n        return next;\n      });\n    }\n  };\n\n  const addQuestionAtIndex = (targetIndex) => {\n    const newQuestion = createDefaultQuestion(questions);\n    const next = questions.slice();\n    next.splice(targetIndex, 0, newQuestion);\n\n    setQuestions(next);\n    setEditingQuestion(newQuestion);\n    setReorderAnnouncement(`Nouvelle question ajoutée en position ${targetIndex + 1} sur ${next.length}.`);\n    if (newQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const updated = new Set(prev);\n        updated.add(newQuestion.id);\n        return updated;\n      });\n    }\n  };\n\n  const deleteQuestion = (id) => {\n    if (PROTECTED_QUESTION_IDS.has(id)) {\n      return;\n    }\n\n    const targetIndex = questions.findIndex((question) => question.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = questions[targetIndex];\n    if (target && target.showcase) {\n      return;\n    }\n\n    const label = target?.question || target?.id || 'cette question';\n\n    if (!confirmDeletion(`Êtes-vous sûr de vouloir supprimer la question « ${label} » ? Cette action peut être annulée (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'question',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `La question « ${label} » a été supprimée. Cliquez sur « Annuler » ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setQuestions((prevQuestions) => prevQuestions.filter((question) => question.id !== id));\n  };\n\n  const duplicateQuestion = (id) => {\n    const originalIndex = questions.findIndex((question) => question.id === id);\n    if (originalIndex < 0) {\n      return;\n    }\n\n    const originalQuestion = questions[originalIndex];\n    const duplicateId = getDuplicateId(questions, originalQuestion?.id, 'q');\n    const copiedQuestion = cloneData(originalQuestion || {});\n\n    copiedQuestion.id = duplicateId;\n    copiedQuestion.question = typeof originalQuestion?.question === 'string' && originalQuestion.question.trim() !== ''\n      ? `${originalQuestion.question} (copie)`\n      : `Copie de ${duplicateId}`;\n\n    const updatedQuestions = questions.slice();\n    updatedQuestions.splice(originalIndex + 1, 0, copiedQuestion);\n\n    setQuestions(updatedQuestions);\n    setEditingQuestion(copiedQuestion);\n    if (copiedQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const next = new Set(prev);\n        next.add(copiedQuestion.id);\n        return next;\n      });\n    }\n\n    const sourceLabel = originalQuestion?.id || 'question d’origine';\n    setReorderAnnouncement(`La question ${duplicateId} a été créée à partir de ${sourceLabel} et placée en position ${originalIndex + 2} sur ${updatedQuestions.length}.`);\n  };\n\n  const saveQuestion = (updatedQuestion) => {\n    const index = questions.findIndex((question) => question.id === updatedQuestion.id);\n\n    if (index >= 0) {\n      const next = questions.slice();\n      next[index] = updatedQuestion;\n      setQuestions(next);\n    } else {\n      setQuestions([...questions, updatedQuestion]);\n    }\n    setEditingQuestion(null);\n  };\n\n  const addRule = () => {\n    const newRule = {\n      id: getNextId(rules, 'rule'),\n      name: 'Nouvelle règle',\n      conditions: [],\n      conditionGroups: [],\n      conditionLogic: 'all',\n      teams: [],\n      questions: {},\n      risks: []\n    };\n\n    setRules([...rules, newRule]);\n    setEditingRule(newRule);\n    if (newRule?.id) {\n      setExpandedRuleIds((prev) => {\n        const next = new Set(prev);\n        next.add(newRule.id);\n        return next;\n      });\n    }\n  };\n\n  const deleteRule = (id) => {\n    const targetIndex = rules.findIndex((rule) => rule.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = rules[targetIndex];\n    const label = target?.name || target?.id || 'cette règle';\n\n    if (!confirmDeletion(`Êtes-vous sûr de vouloir supprimer la règle « ${label} » ? Cette action peut être annulée (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'rule',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `La règle « ${label} » a été supprimée. Cliquez sur « Annuler » ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setRules((prevRules) => prevRules.filter((ruleItem) => ruleItem.id !== id));\n    if (editingRule && editingRule.id === id) {\n      setEditingRule(null);\n    }\n  };\n\n  const duplicateRule = (id) => {\n    const originalIndex = rules.findIndex((rule) => rule.id === id);\n    if (originalIndex < 0) {\n      return;\n    }\n\n    const originalRule = rules[originalIndex];\n    const duplicateId = getDuplicateId(rules, originalRule?.id, 'rule');\n    const copiedRule = cloneData(originalRule || {});\n\n    copiedRule.id = duplicateId;\n    copiedRule.name = typeof originalRule?.name === 'string' && originalRule.name.trim() !== ''\n      ? `${originalRule.name} (copie)`\n      : `Copie de ${duplicateId}`;\n    delete copiedRule.priority;\n\n    const updatedRules = rules.slice();\n    updatedRules.splice(originalIndex + 1, 0, copiedRule);\n\n    setRules(updatedRules);\n    setEditingRule(copiedRule);\n    if (copiedRule?.id) {\n      setExpandedRuleIds((prev) => {\n        const next = new Set(prev);\n        next.add(copiedRule.id);\n        return next;\n      });\n    }\n  };\n\n  const saveRule = (updatedRule) => {\n    const index = rules.findIndex((rule) => rule.id === updatedRule.id);\n\n    if (index >= 0) {\n      const next = rules.slice();\n      next[index] = updatedRule;\n      setRules(next);\n    } else {\n      setRules([...rules, updatedRule]);\n    }\n    setEditingRule(null);\n  };\n\n  const addTeam = () => {\n    const newTeam = {\n      id: getNextId(teams, 'team'),\n      name: 'Nouvelle équipe',\n      contact: 'email@company.com',\n      expertise: \"Domaine d'expertise\"\n    };\n\n    setTeams([...teams, newTeam]);\n  };\n\n  const updateTeamField = (index, field, value) => {\n    const next = teams.slice();\n    if (!next[index]) {\n      return;\n    }\n    next[index] = { ...next[index], [field]: value };\n    setTeams(next);\n  };\n\n  const deleteTeam = (id) => {\n    const targetIndex = teams.findIndex((team) => team.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = teams[targetIndex];\n    const label = target?.name || target?.id || 'cette équipe';\n\n    if (!confirmDeletion(`Êtes-vous sûr de vouloir supprimer l'équipe « ${label} » ? Cette action peut être annulée (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'team',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `L'équipe « ${label} » a été supprimée. Cliquez sur « Annuler » ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setTeams((prevTeams) => prevTeams.filter((team) => team.id !== id));\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 px-4 py-6 sm:px-6 lg:px-8 hv-background\">\n      <div className=\"max-w-7xl mx-auto space-y-6\">\n        <div className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 hv-surface\" role=\"region\" aria-label=\"Back-office\">\n          <header className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-8\">\n            <div className=\"flex items-center space-x-3\">\n              <span className=\"inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-xl\">\n                <Settings className=\"w-6 h-6\" />\n              </span>\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-800 sm:text-3xl\">Back-office</h1>\n                <p className=\"text-sm text-gray-500\">Configurez vos référentiels et automatisations</p>\n              </div>\n            </div>\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2 w-full lg:w-auto\">\n              <button\n                type=\"button\"\n                onClick={handleUndo}\n                disabled={!canUndo}\n                title=\"Annuler la dernière suppression (Ctrl+Z)\"\n                className=\"inline-flex items-center justify-center px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-60 hv-button hv-focus-ring text-sm sm:text-base\"\n              >\n                <ChevronLeft className=\"w-5 h-5 mr-2\" />\n                Annuler (Ctrl+Z)\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadDataFiles}\n                className=\"inline-flex items-center justify-center px-4 py-2 bg-white border border-blue-200 text-blue-700 rounded-lg shadow-sm hover:bg-blue-50 hv-button hv-focus-ring text-sm sm:text-base\"\n              >\n                <Download className=\"w-5 h-5 mr-2\" />\n                Télécharger les fichiers (questions, règles, équipes)\n              </button>\n            </div>\n          </header>\n\n          {undoMessage ? (\n            <div\n              className=\"mb-6 rounded-2xl border border-blue-200 bg-blue-50/80 p-4 text-sm text-blue-800\"\n              role=\"status\"\n              aria-live=\"polite\"\n            >\n              {undoMessage}\n            </div>\n          ) : null}\n\n          <section\n            className=\"mb-6\"\n            aria-label=\"Détection des incohérences\"\n            aria-live=\"polite\"\n          >\n            {dataIntegrityIssues.length > 0 ? (\n              <div className=\"rounded-2xl border border-yellow-200 bg-yellow-50/80 p-4\">\n                <div className=\"flex items-start gap-3\">\n                  <AlertTriangle className=\"w-6 h-6 text-yellow-600 mt-1\" />\n                  <div className=\"flex-1 space-y-3\">\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <p className=\"text-sm font-semibold text-yellow-900\">\n                        {dataIntegrityIssues.length} incohérence\n                        {dataIntegrityIssues.length > 1 ? 's' : ''} détectée\n                        {dataIntegrityIssues.length > 1 ? 's' : ''} dans la configuration.\n                      </p>\n                      {dataIntegritySummary.map((entry) => (\n                        <span\n                          key={entry.scope}\n                          className=\"inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800\"\n                        >\n                          {entry.label} · {entry.count}\n                        </span>\n                      ))}\n                    </div>\n                    <ul className=\"space-y-2 text-sm text-yellow-900\">\n                      {dataIntegrityIssues.map((issue) => (\n                        <li\n                          key={issue.id}\n                          className=\"rounded-lg border border-yellow-200 bg-white/60 p-3\"\n                        >\n                          <p className=\"font-medium\">{issue.context}</p>\n                          <p className=\"mt-1 leading-snug\">{issue.message}</p>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"flex items-start gap-3 rounded-2xl border border-emerald-200 bg-emerald-50 p-4\">\n                <CheckCircle className=\"w-6 h-6 text-emerald-600 mt-1\" />\n                <div>\n                  <p className=\"text-sm font-semibold text-emerald-800\">\n                    Aucune incohérence détectée dans les données de configuration.\n                  </p>\n                  <p className=\"mt-1 text-xs text-emerald-700\">\n                    Les conditions, équipes et références sont alignées.\n                  </p>\n                </div>\n              </div>\n            )}\n          </section>\n\n          <nav className=\"flex flex-wrap gap-2 border-b border-gray-200 pb-2 mb-6\" role=\"tablist\" aria-label=\"Navigation back-office\">\n            {tabDefinitions.map((tab) => (\n              <button\n                key={tab.id}\n                type=\"button\"\n                id={`backoffice-tab-${tab.id}`}\n                role=\"tab\"\n                aria-controls={tab.panelId}\n                aria-selected={activeTab === tab.id}\n                onClick={() => setActiveTab(tab.id)}\n                className={`px-4 py-2 rounded-t-md text-sm font-medium hv-focus-ring ${\n                  activeTab === tab.id\n                    ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-600'\n                    : 'text-gray-600 hover:text-gray-800'\n                }`}\n              >\n                {tab.label}\n              </button>\n            ))}\n          </nav>\n\n          {activeTab === 'dashboard' && (\n            <section\n              id=\"backoffice-tabpanel-dashboard\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-dashboard\"\n              className=\"space-y-6\"\n            >\n              <BackOfficeDashboard projects={projects} teams={teams} />\n            </section>\n          )}\n\n          {activeTab === 'filters' && (\n            <section\n              id=\"backoffice-tabpanel-filters\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-filters\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Filtres de la page d'accueil</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Activez, ajoutez ou personnalisez les filtres mis à disposition des chefs de projet sur l'écran d'accueil.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetProjectFilters}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      projectFiltersAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={projectFiltersAreDefault}\n                  >\n                    Réinitialiser les filtres\n                  </button>\n                </header>\n\n                <div className=\"flex flex-col gap-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4 md:flex md:items-end md:justify-between md:gap-4\">\n                    <div className=\"flex-1 space-y-2\">\n                      <label htmlFor=\"new-filter-question\" className=\"text-sm font-medium text-blue-900\">\n                        Ajouter un filtre basé sur une question\n                      </label>\n                      <select\n                        id=\"new-filter-question\"\n                        value={selectedFilterQuestionId}\n                        onChange={(event) => setSelectedFilterQuestionId(event.target.value)}\n                        className=\"w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">Sélectionnez une question…</option>\n                        {availableFilterQuestionOptions.map((option) => (\n                          <option key={option.value} value={option.value} disabled={option.disabled}>\n                            {option.label}{option.disabled ? ' (déjà utilisé)' : ''}\n                          </option>\n                        ))}\n                      </select>\n                      <p className=\"text-xs text-blue-700\">\n                        Les champs texte et listes à choix unique du questionnaire peuvent être transformés en filtres.\n                      </p>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={handleAddProjectFilter}\n                      disabled={!canAddProjectFilter}\n                      className={`mt-4 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button md:mt-0 ${\n                        canAddProjectFilter\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                    >\n                      <Plus className=\"w-4 h-4\" /> Ajouter le filtre\n                    </button>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    {filterFields.length === 0 ? (\n                      <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                        Aucun filtre n'est configuré pour le moment. Utilisez le menu ci-dessus pour en ajouter.\n                      </div>\n                    ) : (\n                      filterFields.map((field) => {\n                        const typeLabel = PROJECT_FILTER_TYPE_LABELS[field.type] || 'Paramètre';\n                        const description = PROJECT_FILTER_FIELD_DESCRIPTIONS[field.id] || '';\n                        const labelInputId = `project-filter-label-${field.id}`;\n                        const sortDefault = field.type === 'sort' && field.defaultValue === 'asc' ? 'asc' : 'desc';\n                        const sourceQuestionId = field.sourceQuestionId || field.id;\n                        const sourceQuestion = Array.isArray(questions)\n                          ? questions.find((question) => question && question.id === sourceQuestionId)\n                          : null;\n                        const sourceLabel = sourceQuestion?.question;\n                        const canRemoveFilter = field.id !== 'dateOrder';\n\n                        return (\n                          <article\n                            key={field.id}\n                            className=\"border border-gray-200 rounded-xl bg-white p-5 shadow-sm hv-surface\"\n                          >\n                            <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                                  <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                    {typeLabel}\n                                  </span>\n                                  <span\n                                    className={`rounded-full px-2 py-1 ${\n                                      field.enabled\n                                        ? 'bg-emerald-100 text-emerald-700'\n                                        : 'bg-gray-100 text-gray-600'\n                                    }`}\n                                  >\n                                    {field.enabled ? 'Activé' : 'Désactivé'}\n                                  </span>\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{field.label}</h3>\n                                {description && <p className=\"text-sm text-gray-600\">{description}</p>}\n                                {sourceQuestionId && (\n                                  <p className=\"text-xs text-gray-500\">\n                                    Source : <span className=\"font-medium\">{sourceQuestionId}</span>\n                                    {sourceLabel ? ` – ${sourceLabel}` : ''}\n                                  </p>\n                                )}\n                              </div>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <label className=\"inline-flex items-center gap-2 text-sm font-medium text-gray-700\">\n                                  <input\n                                    type=\"checkbox\"\n                                    checked={field.enabled}\n                                    onChange={(event) => handleProjectFilterToggle(field.id, event.target.checked)}\n                                    className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                  />\n                                  <span>Activer</span>\n                                </label>\n                                {canRemoveFilter && (\n                                  <button\n                                    type=\"button\"\n                                    onClick={() => handleRemoveProjectFilter(field)}\n                                    className=\"inline-flex items-center gap-1 rounded-lg border border-red-100 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-100 hv-button\"\n                                  >\n                                    <Trash2 className=\"w-4 h-4\" /> Supprimer\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                              <div className=\"flex flex-col gap-2\">\n                                <label htmlFor={labelInputId} className=\"text-sm font-medium text-gray-700\">\n                                  Libellé affiché\n                                </label>\n                                <input\n                                  id={labelInputId}\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleProjectFilterLabelChange(field.id, event.target.value)}\n                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                                <p className=\"text-xs text-gray-500\">\n                                  Ce titre s'affiche sur la page d'accueil à côté du champ de filtre.\n                                </p>\n                              </div>\n\n                              {field.type === 'sort' ? (\n                                <fieldset className=\"flex flex-col gap-2\">\n                                  <legend className=\"text-sm font-medium text-gray-700\">Ordre par défaut</legend>\n                                  <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                                    <input\n                                      type=\"radio\"\n                                      name={`project-filter-sort-order-${field.id}`}\n                                      value=\"desc\"\n                                      checked={sortDefault === 'desc'}\n                                      onChange={() => handleProjectFilterDefaultSortChange('desc')}\n                                      className=\"h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                    />\n                                    <span>Les plus récents en premier</span>\n                                  </label>\n                                  <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                                    <input\n                                      type=\"radio\"\n                                      name={`project-filter-sort-order-${field.id}`}\n                                      value=\"asc\"\n                                      checked={sortDefault === 'asc'}\n                                      onChange={() => handleProjectFilterDefaultSortChange('asc')}\n                                      className=\"h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                    />\n                                    <span>Les plus anciens en premier</span>\n                                  </label>\n                                </fieldset>\n                              ) : field.type === 'select' ? (\n                                <div className=\"flex flex-col gap-2\">\n                                  <label\n                                    htmlFor={`project-filter-empty-option-${field.id}`}\n                                    className=\"text-sm font-medium text-gray-700\"\n                                  >\n                                    Libellé de l'option « toutes »\n                                  </label>\n                                  <input\n                                    id={`project-filter-empty-option-${field.id}`}\n                                    type=\"text\"\n                                    value={field.emptyOptionLabel || 'Toutes les valeurs'}\n                                    onChange={(event) =>\n                                      setProjectFilters((prev) =>\n                                        updateProjectFilterField(prev, field.id, {\n                                          emptyOptionLabel: event.target.value\n                                        })\n                                      )\n                                    }\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  />\n                                  <p className=\"text-xs text-gray-500\">\n                                    Texte affiché pour représenter l'ensemble des valeurs disponibles.\n                                  </p>\n                                </div>\n                              ) : (\n                                <div className=\"flex flex-col gap-2 text-sm text-gray-600\">\n                                  <span className=\"font-medium text-gray-700\">Comportement</span>\n                                  <p className=\"text-xs text-gray-500\">\n                                    Recherche plein texte sur la réponse saisie par le chef de projet.\n                                  </p>\n                                </div>\n                              )}\n                            </div>\n                          </article>\n                        );\n                      })\n                    )}\n                  </div>\n                </div>\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'inspiration' && (\n            <section\n              id=\"backoffice-tabpanel-inspiration\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-inspiration\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Filtres Inspiration</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Ajustez les filtres disponibles pour trier les projets inspirants.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetInspirationFilters}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      inspirationFiltersAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={inspirationFiltersAreDefault}\n                  >\n                    Réinitialiser\n                  </button>\n                </header>\n\n                <div className=\"flex flex-col gap-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4 md:flex md:items-end md:justify-between md:gap-4\">\n                    <div className=\"flex-1 space-y-2\">\n                      <label htmlFor=\"new-inspiration-filter-question\" className=\"text-sm font-medium text-blue-900\">\n                        Ajouter un filtre basé sur un champ du questionnaire\n                      </label>\n                      <select\n                        id=\"new-inspiration-filter-question\"\n                        value={selectedInspirationFilterQuestionId}\n                        onChange={(event) => setSelectedInspirationFilterQuestionId(event.target.value)}\n                        className=\"w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">Sélectionnez un champ…</option>\n                        {availableInspirationFilterQuestionOptions.map((option) => (\n                          <option key={option.value} value={option.value} disabled={option.disabled}>\n                            {option.label}{option.disabled ? ' (déjà utilisé)' : ''}\n                          </option>\n                        ))}\n                      </select>\n                      <p className=\"text-xs text-blue-700\">\n                        Les champs texte et les listes du formulaire peuvent être transformés en filtres Inspiration.\n                      </p>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={handleAddInspirationFilter}\n                      disabled={!canAddInspirationFilter}\n                      className={`mt-4 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button md:mt-0 ${\n                        canAddInspirationFilter\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                    >\n                      <Plus className=\"w-4 h-4\" /> Ajouter le filtre\n                    </button>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    {inspirationFilterFields.length === 0 ? (\n                      <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                        Aucun filtre n'est configuré pour le moment. Utilisez le menu ci-dessus pour en ajouter.\n                      </div>\n                    ) : (\n                      inspirationFilterFields.map((field) => {\n                        const typeLabel = INSPIRATION_FILTER_TYPE_LABELS[field.type] || 'Paramètre';\n                        const labelInputId = `inspiration-filter-label-${field.id}`;\n                        const sourceQuestionId = field.sourceQuestionId || field.id;\n                        const sourceQuestion = inspirationFormFieldEntries.find(\n                          (item) => item && item.id === sourceQuestionId\n                        );\n                        const sourceLabel = sourceQuestion?.label;\n\n                        return (\n                          <article key={field.id} className=\"rounded-xl border border-gray-200 bg-white p-5 shadow-sm hv-surface\">\n                            <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                                  <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                    {typeLabel}\n                                  </span>\n                                  <span\n                                    className={`rounded-full px-2 py-1 ${\n                                      field.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'\n                                    }`}\n                                  >\n                                    {field.enabled ? 'Activé' : 'Désactivé'}\n                                  </span>\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{field.label}</h3>\n                                {sourceQuestionId && (\n                                  <p className=\"text-xs text-gray-500\">\n                                    Source : <span className=\"font-medium\">{sourceQuestionId}</span>\n                                    {sourceLabel ? ` – ${sourceLabel}` : ''}\n                                  </p>\n                                )}\n                              </div>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <label className=\"inline-flex items-center gap-2 text-sm font-medium text-gray-700\">\n                                  <input\n                                    type=\"checkbox\"\n                                    checked={field.enabled}\n                                    onChange={(event) => handleInspirationFilterToggle(field.id, event.target.checked)}\n                                    className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                  />\n                                  <span>Activer</span>\n                                </label>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => handleRemoveInspirationFilter(field)}\n                                  className=\"inline-flex items-center gap-1 rounded-lg border border-red-100 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-100 hv-button\"\n                                >\n                                  <Trash2 className=\"w-4 h-4\" /> Supprimer\n                                </button>\n                              </div>\n                            </div>\n\n                            <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                              <div className=\"flex flex-col gap-2\">\n                                <label htmlFor={labelInputId} className=\"text-sm font-medium text-gray-700\">\n                                  Libellé affiché\n                                </label>\n                                <input\n                                  id={labelInputId}\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleInspirationFilterLabelChange(field.id, event.target.value)}\n                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                                <p className=\"text-xs text-gray-500\">\n                                  Ce titre s'affiche sur la page d'accueil pour les projets inspiration.\n                                </p>\n                              </div>\n\n                              {field.type === 'select' ? (\n                                <div className=\"flex flex-col gap-2\">\n                                  <label\n                                    htmlFor={`inspiration-filter-empty-option-${field.id}`}\n                                    className=\"text-sm font-medium text-gray-700\"\n                                  >\n                                    Libellé de l'option « toutes »\n                                  </label>\n                                  <input\n                                    id={`inspiration-filter-empty-option-${field.id}`}\n                                    type=\"text\"\n                                    value={field.emptyOptionLabel || 'Toutes les valeurs'}\n                                    onChange={(event) =>\n                                      setInspirationFilters((prev) =>\n                                        updateInspirationFilterField(prev, field.id, {\n                                          emptyOptionLabel: event.target.value\n                                        })\n                                      )\n                                    }\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  />\n                                  <p className=\"text-xs text-gray-500\">\n                                    Texte affiché pour représenter l'ensemble des valeurs disponibles.\n                                  </p>\n                                </div>\n                              ) : (\n                                <div className=\"flex flex-col gap-2 text-sm text-gray-600\">\n                                  <span className=\"font-medium text-gray-700\">Comportement</span>\n                                  <p className=\"text-xs text-gray-500\">\n                                    Recherche plein texte sur les champs du projet inspirant.\n                                  </p>\n                                </div>\n                              )}\n                            </div>\n                          </article>\n                        );\n                      })\n                    )}\n                  </div>\n                </div>\n              </article>\n\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Champs du formulaire</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Définissez les champs visibles dans le questionnaire de création d'un projet inspirant.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetInspirationFormFields}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      inspirationFormAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={inspirationFormAreDefault}\n                  >\n                    Réinitialiser\n                  </button>\n                </header>\n\n                <div className=\"space-y-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-5\">\n                    <div className=\"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between\">\n                      <div className=\"flex-1 space-y-4\">\n                        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-label\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              Libellé du champ\n                            </label>\n                            <input\n                              id=\"new-inspiration-field-label\"\n                              type=\"text\"\n                              value={newInspirationFormField.label}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  label: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder=\"Ex : Contexte du projet\"\n                            />\n                          </div>\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-id\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              Identifiant technique\n                            </label>\n                            <input\n                              id=\"new-inspiration-field-id\"\n                              type=\"text\"\n                              value={newInspirationFormField.id}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  id: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder=\"ex : contexteProjet\"\n                            />\n                            <p className=\"mt-1 text-xs text-blue-700\">\n                              {isNewInspirationFieldIdDuplicate\n                                ? 'Cet identifiant est déjà utilisé.'\n                                : suggestedNewInspirationFieldId\n                                  ? `Identifiant utilisé : ${suggestedNewInspirationFieldId}`\n                                  : 'Laissez vide pour générer automatiquement à partir du libellé.'}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-3\">\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-type\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              Type de champ\n                            </label>\n                            <select\n                              id=\"new-inspiration-field-type\"\n                              value={newInspirationFormField.type}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  type: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              {INSPIRATION_FORM_FIELD_TYPE_OPTIONS.map((option) => (\n                                <option key={option.value} value={option.value}>\n                                  {option.label}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                          {newInspirationFormField.type === 'select' || newInspirationFormField.type === 'multi_select' ? (\n                            <div className=\"md:col-span-2 space-y-3\">\n                              <div>\n                                <label\n                                  htmlFor=\"new-inspiration-field-options\"\n                                  className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                                >\n                                  Options (séparées par des virgules)\n                                </label>\n                                <input\n                                  id=\"new-inspiration-field-options\"\n                                  type=\"text\"\n                                  value={newInspirationFormField.options}\n                                  onChange={(event) =>\n                                    setNewInspirationFormField((prev) => ({\n                                      ...prev,\n                                      options: event.target.value\n                                    }))\n                                  }\n                                  className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  placeholder=\"Ex : Patient, Professionnels, Grand public\"\n                                />\n                              </div>\n                              {newInspirationFormField.type === 'select' && (\n                                <div>\n                                  <label\n                                    htmlFor=\"new-inspiration-field-select-placeholder\"\n                                    className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                                  >\n                                    Libellé de sélection par défaut\n                                  </label>\n                                  <input\n                                    id=\"new-inspiration-field-select-placeholder\"\n                                    type=\"text\"\n                                    value={newInspirationFormField.placeholder}\n                                    onChange={(event) =>\n                                      setNewInspirationFormField((prev) => ({\n                                        ...prev,\n                                        placeholder: event.target.value\n                                      }))\n                                    }\n                                    className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Ex : Sélectionner...\"\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          ) : INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(newInspirationFormField.type) ? (\n                            <div className=\"md:col-span-2\">\n                              <label\n                                htmlFor=\"new-inspiration-field-placeholder\"\n                                className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                              >\n                                Placeholder / texte indicatif\n                              </label>\n                              <input\n                                id=\"new-inspiration-field-placeholder\"\n                                type=\"text\"\n                                value={newInspirationFormField.placeholder}\n                                onChange={(event) =>\n                                  setNewInspirationFormField((prev) => ({\n                                    ...prev,\n                                    placeholder: event.target.value\n                                  }))\n                                }\n                                className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Texte affiché dans le champ\"\n                              />\n                            </div>\n                          ) : (\n                            <div className=\"md:col-span-2 flex items-center text-xs text-blue-700\">\n                              Ce type de champ ne nécessite pas de placeholder.\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"flex flex-wrap gap-4 text-sm text-blue-900\">\n                          <label className=\"inline-flex items-center gap-2\">\n                            <input\n                              type=\"checkbox\"\n                              checked={newInspirationFormField.required}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  required: event.target.checked\n                                }))\n                              }\n                              className=\"h-4 w-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500\"\n                            />\n                            Champ requis\n                          </label>\n                          <label className=\"inline-flex items-center gap-2\">\n                            <input\n                              type=\"checkbox\"\n                              checked={newInspirationFormField.enabled}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  enabled: event.target.checked\n                                }))\n                              }\n                              className=\"h-4 w-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500\"\n                            />\n                            Champ actif\n                          </label>\n                        </div>\n                      </div>\n                      <button\n                        type=\"button\"\n                        onClick={handleAddInspirationFormField}\n                        disabled={!canAddInspirationFormField}\n                        className={`inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                          canAddInspirationFormField\n                            ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                            : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        }`}\n                      >\n                        <Plus className=\"w-4 h-4\" />\n                        Ajouter le champ\n                      </button>\n                    </div>\n                  </div>\n\n                  {inspirationFormFieldEntries.length === 0 ? (\n                    <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                      Aucun champ n'est configuré.\n                    </div>\n                  ) : (\n                    inspirationFormFieldEntries.map((field) => (\n                      <article key={field.id} className=\"rounded-xl border border-gray-200 bg-white p-5 shadow-sm hv-surface\">\n                        <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                          <div className=\"space-y-2\">\n                            <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                              <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                {INSPIRATION_FORM_FIELD_TYPE_LABELS[field.type] || field.type}\n                              </span>\n                              <span\n                                className={`rounded-full px-2 py-1 ${\n                                  field.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'\n                                }`}\n                              >\n                                {field.enabled ? 'Activé' : 'Désactivé'}\n                              </span>\n                              {field.required && (\n                                <span className=\"rounded-full bg-purple-100 px-2 py-1 text-purple-700\">Requis</span>\n                              )}\n                            </div>\n                            <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">Libellé</span>\n                                <input\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleInspirationFormFieldLabelChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                              </label>\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">Type de champ</span>\n                                <select\n                                  value={field.type}\n                                  onChange={(event) => handleInspirationFormFieldTypeChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                >\n                                  {INSPIRATION_FORM_FIELD_TYPE_OPTIONS.map((option) => (\n                                    <option key={option.value} value={option.value}>\n                                      {option.label}\n                                    </option>\n                                  ))}\n                                </select>\n                              </label>\n                            </div>\n                            {INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(field.type) && (\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">\n                                  {field.type === 'select' ? 'Libellé de sélection' : 'Placeholder'}\n                                </span>\n                                {field.type === 'long_text' ? (\n                                  <textarea\n                                    rows={2}\n                                    value={field.placeholder || ''}\n                                    onChange={(event) => handleInspirationFormFieldPlaceholderChange(field.id, event.target.value)}\n                                    className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Texte indicatif affiché dans le champ\"\n                                  />\n                                ) : (\n                                  <input\n                                    type=\"text\"\n                                    value={field.placeholder || ''}\n                                    onChange={(event) => handleInspirationFormFieldPlaceholderChange(field.id, event.target.value)}\n                                    className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Texte indicatif affiché dans le champ\"\n                                  />\n                                )}\n                              </label>\n                            )}\n                            {field.type === 'select' || field.type === 'multi_select' ? (\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">Options (séparées par des virgules)</span>\n                                <input\n                                  type=\"text\"\n                                  value={formatOptionList(field.options)}\n                                  onChange={(event) => handleInspirationFormFieldOptionsChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                              </label>\n                            ) : null}\n                            <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                              <input\n                                type=\"checkbox\"\n                                checked={Boolean(field.required)}\n                                onChange={(event) => handleInspirationFormFieldRequiredChange(field.id, event.target.checked)}\n                                className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                              />\n                              Champ requis\n                            </label>\n                          </div>\n                          <button\n                            type=\"button\"\n                            onClick={() => handleInspirationFormFieldToggle(field.id, !field.enabled)}\n                            className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                              field.enabled\n                                ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                                : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                            }`}\n                          >\n                            {field.enabled ? 'Désactiver' : 'Activer'}\n                          </button>\n                        </div>\n                      </article>\n                    ))\n                  )}\n                </div>\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'themes' && (\n            <section\n              id=\"backoffice-tabpanel-themes\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-themes\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Thèmes de la vitrine</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Pilotez les palettes couleurs utilisées dans la vitrine. Chaque couleur est éditable via un color-picker\n                      pour ajuster les dégradés, halos et surfaces principales.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={addShowcaseTheme}\n                    className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700 hv-button hv-button-primary\"\n                  >\n                    <Plus className=\"w-5 h-5\" />\n                    Ajouter un thème\n                  </button>\n                </div>\n\n                {safeShowcaseThemes.length === 0 ? (\n                  <div className=\"rounded-xl border border-dashed border-gray-300 p-6 text-center text-gray-500\">\n                    Aucun thème configuré.\n                  </div>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {safeShowcaseThemes.map((theme, index) => {\n                      const palette = theme?.palette || {};\n                      const themeId = theme?.id || `theme-${index + 1}`;\n                      const disableDelete = showcaseThemeCount <= 1;\n\n                      return (\n                        <article key={themeId} className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4 shadow-sm\">\n                          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                            <div className=\"flex-1 space-y-3\">\n                              <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                                <div>\n                                  <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-label`}>\n                                    Nom affiché\n                                  </label>\n                                  <input\n                                    id={`${themeId}-label`}\n                                    type=\"text\"\n                                    value={theme?.label || ''}\n                                    onChange={(event) => updateShowcaseThemeField(index, 'label', event.target.value)}\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm hv-focus-ring\"\n                                    placeholder=\"Nom du thème\"\n                                  />\n                                </div>\n                                <div>\n                                  <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-id`}>\n                                    Clé technique\n                                  </label>\n                                  <input\n                                    id={`${themeId}-id`}\n                                    type=\"text\"\n                                    value={themeId}\n                                    readOnly\n                                    className=\"w-full cursor-not-allowed rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-sm text-gray-600\"\n                                  />\n                                  <p className=\"mt-1 text-xs text-gray-500\">Utilisée pour identifier le thème dans les réponses.</p>\n                                </div>\n                              </div>\n\n                              <div>\n                                <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-description`}>\n                                  Description\n                                </label>\n                                <textarea\n                                  id={`${themeId}-description`}\n                                  rows={2}\n                                  value={theme?.description || ''}\n                                  onChange={(event) => updateShowcaseThemeField(index, 'description', event.target.value)}\n                                  className=\"w-full resize-y rounded-lg border border-gray-300 px-3 py-2 text-sm hv-focus-ring\"\n                                  placeholder=\"Décrivez l'esprit du thème (tonalité, usage, cible)\"\n                                />\n                              </div>\n                            </div>\n\n                            <div className=\"flex justify-end gap-2 lg:flex-col lg:items-end\">\n                              <span className=\"rounded-full bg-gray-200 px-3 py-1 text-xs font-semibold text-gray-700\">#{index + 1}</span>\n                              <button\n                                type=\"button\"\n                                onClick={() => deleteShowcaseTheme(themeId)}\n                                disabled={disableDelete}\n                                className=\"inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-red-600 transition-colors hover:bg-red-50 hv-button disabled:cursor-not-allowed disabled:opacity-50\"\n                                aria-disabled={disableDelete}\n                              >\n                                <Trash2 className=\"w-5 h-5\" />\n                                Supprimer\n                              </button>\n                            </div>\n                          </div>\n\n                          <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3\">\n                            {SHOWCASE_THEME_PALETTE_FIELDS.map((field) => (\n                              <div key={`${themeId}-${field.key}`} className=\"rounded-lg border border-gray-200 bg-white p-3 shadow-sm\">\n                                <label className=\"mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-${field.key}`}>\n                                  {field.label}\n                                </label>\n                                <div className=\"flex items-center gap-3\">\n                                  <input\n                                    id={`${themeId}-${field.key}`}\n                                    type=\"color\"\n                                    value={normalizeColorValue(palette[field.key], '#000000')}\n                                    onChange={(event) => updateShowcaseThemePalette(index, field.key, event.target.value)}\n                                    className=\"h-10 w-16 cursor-pointer rounded border border-gray-300 bg-white\"\n                                    aria-label={`Sélectionner ${field.label.toLowerCase()}`}\n                                  />\n                                  <input\n                                    type=\"text\"\n                                    value={palette[field.key] || ''}\n                                    onChange={(event) => updateShowcaseThemePalette(index, field.key, event.target.value)}\n                                    className=\"flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm font-mono hv-focus-ring\"\n                                    placeholder=\"#000000\"\n                                  />\n                                </div>\n                                <p className=\"mt-1 text-xs text-gray-500\">{field.description}</p>\n                              </div>\n                            ))}\n                          </div>\n                        </article>\n                      );\n                    })}\n                  </div>\n                )}\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'questions' && (\n            <section id=\"backoffice-tabpanel-questions\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-questions\" className=\"space-y-4\">\n              <div className=\"sr-only\" aria-live=\"polite\">{reorderAnnouncement}</div>\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des questions</h2>\n                  <p className=\"text-sm text-gray-600\">Définissez les questions et leur logique d'affichage conditionnel.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addQuestion}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une question\n                </button>\n              </div>\n\n              <div className=\"rounded-lg border border-blue-100 bg-blue-50/60 px-4 py-3 text-sm text-blue-900\">\n                <p className=\"font-medium\">Questions vitrine du projet</p>\n                <p className=\"mt-1 text-blue-800\">\n                  Les questions marquées «&nbsp;Vitrine du projet&nbsp;» alimentent automatiquement la vitrine du projet.\n                  Elles sont obligatoires pour compléter le showcase et ne peuvent pas être supprimées.\n                </p>\n              </div>\n\n              <div className=\"rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4\">\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  <div>\n                    <label\n                      htmlFor=\"question-title-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par titre ou identifiant\n                    </label>\n                    <input\n                      id=\"question-title-filter\"\n                      type=\"text\"\n                      value={questionTitleFilter}\n                      onChange={(event) => setQuestionTitleFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder=\"Ex. audience, q12...\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"question-team-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par équipe impliquée\n                    </label>\n                    <select\n                      id=\"question-team-filter\"\n                      value={questionTeamFilter}\n                      onChange={(event) => setQuestionTeamFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    >\n                      <option value=\"all\">Toutes les équipes</option>\n                      <option value=\"none\">Sans équipe identifiée</option>\n                      {availableTeamFilterOptions.map((option) => (\n                        <option key={`question-team-filter-${option.value}`} value={option.value}>\n                          {option.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div className=\"md:col-span-2 lg:col-span-1 flex items-end\">\n                    <p className=\"text-xs text-gray-500\">\n                      {questions.length === 0\n                        ? 'Aucune question configurée.'\n                        : visibleQuestionIds.length === questions.length\n                          ? 'Toutes les questions sont affichées.'\n                          : visibleQuestionIds.length === 0\n                            ? 'Aucune question ne correspond aux filtres.'\n                            : `${visibleQuestionIds.length} question${visibleQuestionIds.length > 1 ? 's' : ''} correspond${visibleQuestionIds.length > 1 ? 'ent' : ''} aux filtres.`}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {questions.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune question configurée pour le moment.\n                </div>\n              ) : visibleQuestionIds.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune question ne correspond aux filtres sélectionnés.\n                </div>\n              ) : (\n                shouldVirtualizeQuestions ? (\n                  <VirtualizedList\n                    items={visibleQuestionEntries}\n                    itemKey={(entry) => entry.question.id}\n                    estimatedItemHeight={360}\n                    overscan={4}\n                    className=\"relative\"\n                    renderItem={(entry) => {\n                      const { question, index } = entry;\n                      const typeMeta = getQuestionTypeMeta(question.type);\n                      const conditionSummary = buildConditionSummary(question, questions);\n                      const guidance = question.guidance || {};\n                      const tips = formatGuidanceTips(guidance);\n                      const numberUnitLabel =\n                        question.type === 'number' && typeof question.numberUnit === 'string'\n                          ? question.numberUnit.trim()\n                          : '';\n                      const isShowcaseQuestion = Boolean(question && question.showcase);\n                      const isProtectedQuestion = question?.id === 'ProjectType';\n                      const deleteButtonDisabled = isShowcaseQuestion || isProtectedQuestion;\n                      const deleteButtonClasses = deleteButtonDisabled\n                        ? 'p-2 text-gray-300 bg-gray-100 cursor-not-allowed rounded hv-button'\n                        : 'p-2 text-red-600 hover:bg-red-50 rounded hv-button';\n                      const deleteButtonTitle = isShowcaseQuestion\n                        ? 'Cette question alimente la vitrine du projet et ne peut pas être supprimée.'\n                        : isProtectedQuestion\n                          ? 'Cette question est indispensable pour identifier le type de projet et ne peut pas être supprimée.'\n                          : `Supprimer la question ${question.id}`;\n                      const questionTeams = questionTeamAssignments.get(question.id) || [];\n                      const questionTeamLabels = questionTeams.map((teamId) => getTeamLabel(teamId, teams));\n                      const isExpanded = expandedQuestionIds.has(question.id);\n                      const detailsId = `question-details-${question.id}`;\n                      const toggleLabel = isExpanded\n                        ? `Masquer les détails de la question ${question.id}`\n                        : `Afficher les détails de la question ${question.id}`;\n\n                      return (\n                        <div className=\"pb-6\">\n                          <article\n                            className={`border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface transition-shadow ${\n                              dragOverIndex === index ? 'ring-2 ring-blue-400 ring-offset-2' : ''\n                            } ${\n                              draggedQuestionIndex === index ? 'opacity-75' : ''\n                            }`}\n                            aria-label={`Question ${question.id}`}\n                            onDragOver={(event) => handleDragOver(event, index)}\n                            onDrop={(event) => handleDrop(event, index)}\n                          >\n                            <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                              <div className=\"flex items-start gap-3 flex-1\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => toggleQuestionExpansion(question.id)}\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                  aria-expanded={isExpanded}\n                                  aria-controls={detailsId}\n                                >\n                                  <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                  <span className=\"sr-only\">{toggleLabel}</span>\n                                </button>\n                                <div className=\"space-y-2 flex-1\">\n                                  <div className=\"flex flex-wrap items-center gap-2\">\n                                    <span className=\"text-xs font-semibold uppercase tracking-wide bg-blue-100 text-blue-700 px-2 py-1 rounded-full\">\n                                      {question.id}\n                                    </span>\n                                    <span className=\"text-sm bg-gray-100 text-gray-700 px-2 py-1 rounded-full\">\n                                      {typeMeta.label}\n                                    </span>\n                                    {isShowcaseQuestion && (\n                                      <span className=\"text-xs text-blue-800 bg-blue-100 px-2 py-1 rounded-full font-medium\">\n                                        Vitrine du projet\n                                      </span>\n                                    )}\n                                    {question.required && (\n                                      <span className=\"text-xs text-red-700 bg-red-100 px-2 py-1 rounded-full\">Obligatoire</span>\n                                    )}\n                                  </div>\n                                  <h3 className=\"text-lg font-semibold text-gray-800\">{question.question}</h3>\n                                  <div className=\"flex flex-wrap items-center gap-3 text-xs text-gray-500\">\n                                    <span id={`question-${question.id}-position`}>\n                                      Position {index + 1} sur {questions.length}\n                                    </span>\n                                  </div>\n                                  {questionTeamLabels.length > 0 && (\n                                    <div className=\"flex flex-wrap gap-2\">\n                                      {questionTeamLabels.map((label) => (\n                                        <span\n                                          key={`${question.id}-team-${label}`}\n                                          className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs border border-blue-100\"\n                                        >\n                                          {label}\n                                        </span>\n                                      ))}\n                                    </div>\n                                  )}\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-2\">\n                                <button\n                                  type=\"button\"\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 rounded hv-button cursor-move\"\n                                  aria-label={`Réorganiser la question ${question.id}. Position ${index + 1} sur ${questions.length}. Utilisez les flèches haut et bas.`}\n                                  aria-describedby={`question-${question.id}-position`}\n                                  draggable\n                                  onDragStart={(event) => handleDragStart(event, index)}\n                                  onDragOver={(event) => handleDragOver(event, index)}\n                                  onDrop={(event) => handleDrop(event, index)}\n                                  onDragEnd={handleDragEnd}\n                                  onKeyDown={(event) => handleKeyboardReorder(event, index)}\n                                >\n                                  <GripVertical className=\"w-4 h-4\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => duplicateQuestion(question.id)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Dupliquer la question ${question.id}`}\n                                  title={`Dupliquer la question ${question.id}`}\n                                >\n                                  <Copy className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => setEditingQuestion(question)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Modifier la question ${question.id}`}\n                                >\n                                  <Edit className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => {\n                                    if (deleteButtonDisabled) {\n                                      return;\n                                    }\n\n                                    const confirmationMessage = `Voulez-vous vraiment supprimer la question ${question.id} ?`;\n                                    const shouldDelete = typeof window === 'undefined'\n                                      ? true\n                                      : window.confirm(confirmationMessage);\n\n                                    if (shouldDelete) {\n                                      deleteQuestion(question.id);\n                                    }\n                                  }}\n                                  className={deleteButtonClasses}\n                                  aria-label={deleteButtonTitle}\n                                  aria-disabled={deleteButtonDisabled}\n                                  disabled={deleteButtonDisabled}\n                                  title={deleteButtonTitle}\n                                >\n                                  <Trash2 className=\"w-5 h-5\" />\n                                </button>\n                              </div>\n                            </div>\n\n                            {isExpanded && (\n                              <div id={detailsId} className=\"mt-4 space-y-6\">\n                                <div className=\"space-y-2 text-sm text-gray-600\">\n                                  <p>{typeMeta.description}</p>\n                                  {numberUnitLabel && (\n                                    <p className=\"inline-flex items-center gap-2 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1 rounded-full\">\n                                      <Info className=\"w-4 h-4\" />\n                                      Unité affichée : {numberUnitLabel}\n                                    </p>\n                                  )}\n                                </div>\n\n                                {(Array.isArray(question.options) && question.options.length > 0) && (\n                                  <div>\n                                    <h4 className=\"text-sm font-semibold text-gray-700 flex items-center\">\n                                      <Info className=\"w-4 h-4 mr-2\" /> Options proposées\n                                    </h4>\n                                    <ul className=\"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-700\">\n                                      {question.options.map((option, optionIndex) => (\n                                        <li key={`${question.id}-option-${optionIndex}`} className=\"px-3 py-2 bg-gray-50 rounded-lg border border-gray-200\">\n                                          {option}\n                                        </li>\n                                      ))}\n                                    </ul>\n                                  </div>\n                                )}\n\n                                {conditionSummary.length > 0 ? (\n                                  <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-gray-700\">\n                                    <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions d'affichage</h4>\n                                    <ol className=\"space-y-3\">\n                                      {conditionSummary.map((group) => (\n                                        <li key={`${question.id}-condition-group-${group.index}`} className=\"space-y-2\">\n                                          <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                            Groupe {group.index} – logique {group.logic === 'OU' ? 'OU (au moins une)' : 'ET (toutes)'}\n                                          </div>\n                                          <ul className=\"space-y-1\">\n                                            {group.parts.map((part, partIndex) => (\n                                              <li key={`${question.id}-part-${group.index}-${partIndex}`} className=\"flex items-baseline space-x-2\">\n                                                {part.connector && <span className=\"text-xs text-blue-500\">{part.connector}</span>}\n                                                <span className=\"font-mono bg-white px-2 py-0.5 rounded border border-blue-100\">{part.label}</span>\n                                                <span>{part.operator}</span>\n                                                <span className=\"font-semibold text-blue-700\">« {part.value} »</span>\n                                              </li>\n                                            ))}\n                                          </ul>\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Cette question est toujours affichée.</p>\n                                )}\n\n                                {(guidance.objective || guidance.details || tips.length > 0) && (\n                                  <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm text-gray-700 space-y-2\">\n                                    {guidance.objective && (\n                                      <p>\n                                        <strong className=\"text-gray-800\">Objectif :</strong>{' '}\n                                        {renderTextWithLinks(guidance.objective)}\n                                      </p>\n                                    )}\n                                    {guidance.details && (\n                                      <p>{renderTextWithLinks(guidance.details)}</p>\n                                    )}\n                                    {tips.length > 0 && (\n                                      <div>\n                                        <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-600 mb-1\">Conseils pratiques</p>\n                                        <ul className=\"list-disc list-inside space-y-1\">\n                                          {tips.map((tip, tipIndex) => (\n                                            <li key={`${question.id}-tip-${tipIndex}`}>{renderTextWithLinks(tip)}</li>\n                                          ))}\n                                        </ul>\n                                      </div>\n                                    )}\n                                  </div>\n                                )}\n                              </div>\n                            )}\n                          </article>\n                          {index < questions.length - 1 && (\n                            <div className=\"flex justify-center my-3\">\n                              <button\n                                type=\"button\"\n                                onClick={() => addQuestionAtIndex(index + 1)}\n                                className=\"w-10 h-10 rounded-full border-2 border-dashed border-blue-300 text-blue-600 bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 hv-button\"\n                                aria-label={`Insérer une nouvelle question après la question ${question.id}`}\n                              >\n                                <Plus className=\"w-5 h-5\" />\n                                <span className=\"sr-only\">Ajouter une question à cet emplacement</span>\n                              </button>\n                            </div>\n                          )}\n                        </div>\n                      );\n                    }}\n                  />\n                ) : (\n                  visibleQuestionEntries.map((entry) => {\n                    const { question, index } = entry;\n                    const typeMeta = getQuestionTypeMeta(question.type);\n                    const conditionSummary = buildConditionSummary(question, questions);\n                    const guidance = question.guidance || {};\n                    const tips = formatGuidanceTips(guidance);\n                    const numberUnitLabel =\n                      question.type === 'number' && typeof question.numberUnit === 'string'\n                        ? question.numberUnit.trim()\n                        : '';\n                    const isShowcaseQuestion = Boolean(question && question.showcase);\n                    const isProtectedQuestion = question?.id === 'ProjectType';\n                    const deleteButtonDisabled = isShowcaseQuestion || isProtectedQuestion;\n                    const deleteButtonClasses = deleteButtonDisabled\n                      ? 'p-2 text-gray-300 bg-gray-100 cursor-not-allowed rounded hv-button'\n                      : 'p-2 text-red-600 hover:bg-red-50 rounded hv-button';\n                    const deleteButtonTitle = isShowcaseQuestion\n                      ? 'Cette question alimente la vitrine du projet et ne peut pas être supprimée.'\n                      : isProtectedQuestion\n                        ? 'Cette question est indispensable pour identifier le type de projet et ne peut pas être supprimée.'\n                        : `Supprimer la question ${question.id}`;\n                    const questionTeams = questionTeamAssignments.get(question.id) || [];\n                    const questionTeamLabels = questionTeams.map((teamId) => getTeamLabel(teamId, teams));\n                    const isExpanded = expandedQuestionIds.has(question.id);\n                    const detailsId = `question-details-${question.id}`;\n                    const toggleLabel = isExpanded\n                      ? `Masquer les détails de la question ${question.id}`\n                      : `Afficher les détails de la question ${question.id}`;\n\n                    return (\n                      <React.Fragment key={question.id}>\n                        <article\n                          className={`border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface transition-shadow ${\n                            dragOverIndex === index ? 'ring-2 ring-blue-400 ring-offset-2' : ''\n                          } ${\n                            draggedQuestionIndex === index ? 'opacity-75' : ''\n                          }`}\n                          aria-label={`Question ${question.id}`}\n                          onDragOver={(event) => handleDragOver(event, index)}\n                          onDrop={(event) => handleDrop(event, index)}\n                        >\n                          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                            <div className=\"flex items-start gap-3 flex-1\">\n                              <button\n                                type=\"button\"\n                                onClick={() => toggleQuestionExpansion(question.id)}\n                                className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                aria-expanded={isExpanded}\n                                aria-controls={detailsId}\n                              >\n                                <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                <span className=\"sr-only\">{toggleLabel}</span>\n                              </button>\n                              <div className=\"space-y-2 flex-1\">\n                                <div className=\"flex flex-wrap items-center gap-2\">\n                                  <span className=\"text-xs font-semibold uppercase tracking-wide bg-blue-100 text-blue-700 px-2 py-1 rounded-full\">\n                                    {question.id}\n                                  </span>\n                                  <span className=\"text-sm bg-gray-100 text-gray-700 px-2 py-1 rounded-full\">\n                                    {typeMeta.label}\n                                  </span>\n                                  {isShowcaseQuestion && (\n                                    <span className=\"text-xs text-blue-800 bg-blue-100 px-2 py-1 rounded-full font-medium\">\n                                      Vitrine du projet\n                                    </span>\n                                  )}\n                                  {question.required && (\n                                    <span className=\"text-xs text-red-700 bg-red-100 px-2 py-1 rounded-full\">Obligatoire</span>\n                                  )}\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{question.question}</h3>\n                                <div className=\"flex flex-wrap items-center gap-3 text-xs text-gray-500\">\n                                  <span id={`question-${question.id}-position`}>\n                                    Position {index + 1} sur {questions.length}\n                                  </span>\n                                </div>\n                                {questionTeamLabels.length > 0 && (\n                                  <div className=\"flex flex-wrap gap-2\">\n                                    {questionTeamLabels.map((label) => (\n                                      <span\n                                        key={`${question.id}-team-${label}`}\n                                        className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs border border-blue-100\"\n                                      >\n                                        {label}\n                                      </span>\n                                    ))}\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"flex flex-wrap gap-2\">\n                              <button\n                                type=\"button\"\n                                className=\"p-2 text-gray-500 hover:text-blue-600 rounded hv-button cursor-move\"\n                                aria-label={`Réorganiser la question ${question.id}. Position ${index + 1} sur ${questions.length}. Utilisez les flèches haut et bas.`}\n                                aria-describedby={`question-${question.id}-position`}\n                                draggable\n                                onDragStart={(event) => handleDragStart(event, index)}\n                                onDragOver={(event) => handleDragOver(event, index)}\n                                onDrop={(event) => handleDrop(event, index)}\n                                onDragEnd={handleDragEnd}\n                                onKeyDown={(event) => handleKeyboardReorder(event, index)}\n                              >\n                                <GripVertical className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => duplicateQuestion(question.id)}\n                                className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                aria-label={`Dupliquer la question ${question.id}`}\n                                title={`Dupliquer la question ${question.id}`}\n                              >\n                                <Copy className=\"w-5 h-5\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => setEditingQuestion(question)}\n                                className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                aria-label={`Modifier la question ${question.id}`}\n                              >\n                                <Edit className=\"w-5 h-5\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => {\n                                  if (deleteButtonDisabled) {\n                                    return;\n                                  }\n\n                                  const confirmationMessage = `Voulez-vous vraiment supprimer la question ${question.id} ?`;\n                                  const shouldDelete = typeof window === 'undefined'\n                                    ? true\n                                    : window.confirm(confirmationMessage);\n\n                                  if (shouldDelete) {\n                                    deleteQuestion(question.id);\n                                  }\n                                }}\n                                className={deleteButtonClasses}\n                                aria-label={deleteButtonTitle}\n                                aria-disabled={deleteButtonDisabled}\n                                disabled={deleteButtonDisabled}\n                                title={deleteButtonTitle}\n                              >\n                                <Trash2 className=\"w-5 h-5\" />\n                              </button>\n                            </div>\n                          </div>\n\n                          {isExpanded && (\n                            <div id={detailsId} className=\"mt-4 space-y-6\">\n                              <div className=\"space-y-2 text-sm text-gray-600\">\n                                <p>{typeMeta.description}</p>\n                                {numberUnitLabel && (\n                                  <p className=\"inline-flex items-center gap-2 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1 rounded-full\">\n                                    <Info className=\"w-4 h-4\" />\n                                    Unité affichée : {numberUnitLabel}\n                                  </p>\n                                )}\n                              </div>\n\n                              {(Array.isArray(question.options) && question.options.length > 0) && (\n                                <div>\n                                  <h4 className=\"text-sm font-semibold text-gray-700 flex items-center\">\n                                    <Info className=\"w-4 h-4 mr-2\" /> Options proposées\n                                  </h4>\n                                  <ul className=\"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-700\">\n                                    {question.options.map((option, optionIndex) => (\n                                      <li key={`${question.id}-option-${optionIndex}`} className=\"px-3 py-2 bg-gray-50 rounded-lg border border-gray-200\">\n                                        {option}\n                                      </li>\n                                    ))}\n                                  </ul>\n                                </div>\n                              )}\n\n                              {conditionSummary.length > 0 ? (\n                                <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-gray-700\">\n                                  <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions d'affichage</h4>\n                                  <ol className=\"space-y-3\">\n                                    {conditionSummary.map((group) => (\n                                      <li key={`${question.id}-condition-group-${group.index}`} className=\"space-y-2\">\n                                        <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                          Groupe {group.index} – logique {group.logic === 'OU' ? 'OU (au moins une)' : 'ET (toutes)'}\n                                        </div>\n                                        <ul className=\"space-y-1\">\n                                          {group.parts.map((part, partIndex) => (\n                                            <li key={`${question.id}-part-${group.index}-${partIndex}`} className=\"flex items-baseline space-x-2\">\n                                              {part.connector && <span className=\"text-xs text-blue-500\">{part.connector}</span>}\n                                              <span className=\"font-mono bg-white px-2 py-0.5 rounded border border-blue-100\">{part.label}</span>\n                                              <span>{part.operator}</span>\n                                              <span className=\"font-semibold text-blue-700\">« {part.value} »</span>\n                                            </li>\n                                          ))}\n                                        </ul>\n                                      </li>\n                                    ))}\n                                  </ol>\n                                </div>\n                              ) : (\n                                <p className=\"text-xs text-gray-500 italic\">Cette question est toujours affichée.</p>\n                              )}\n\n                              {(guidance.objective || guidance.details || tips.length > 0) && (\n                                <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm text-gray-700 space-y-2\">\n                                  {guidance.objective && (\n                                    <p>\n                                      <strong className=\"text-gray-800\">Objectif :</strong>{' '}\n                                      {renderTextWithLinks(guidance.objective)}\n                                    </p>\n                                  )}\n                                  {guidance.details && (\n                                    <p>{renderTextWithLinks(guidance.details)}</p>\n                                  )}\n                                  {tips.length > 0 && (\n                                    <div>\n                                      <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-600 mb-1\">Conseils pratiques</p>\n                                      <ul className=\"list-disc list-inside space-y-1\">\n                                        {tips.map((tip, tipIndex) => (\n                                          <li key={`${question.id}-tip-${tipIndex}`}>{renderTextWithLinks(tip)}</li>\n                                        ))}\n                                      </ul>\n                                    </div>\n                                  )}\n                                </div>\n                              )}\n                            </div>\n                          )}\n                        </article>\n                        {index < questions.length - 1 && (\n                          <div className=\"flex justify-center my-3\">\n                            <button\n                              type=\"button\"\n                              onClick={() => addQuestionAtIndex(index + 1)}\n                              className=\"w-10 h-10 rounded-full border-2 border-dashed border-blue-300 text-blue-600 bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 hv-button\"\n                              aria-label={`Insérer une nouvelle question après la question ${question.id}`}\n                            >\n                              <Plus className=\"w-5 h-5\" />\n                              <span className=\"sr-only\">Ajouter une question à cet emplacement</span>\n                            </button>\n                          </div>\n                        )}\n                      </React.Fragment>\n                    );\n                  })\n                )\n              )}\n            </section>\n          )}\n\n          {activeTab === 'rules' && (\n            <section id=\"backoffice-tabpanel-rules\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-rules\" className=\"space-y-4\">\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des règles</h2>\n                  <p className=\"text-sm text-gray-600\">Identifiez les combinaisons à risque et les équipes concernées.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addRule}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une règle\n                </button>\n              </div>\n\n              <div className=\"rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4\">\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  <div>\n                    <label\n                      htmlFor=\"rule-title-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par titre ou identifiant\n                    </label>\n                    <input\n                      id=\"rule-title-filter\"\n                      type=\"text\"\n                      value={ruleTitleFilter}\n                      onChange={(event) => setRuleTitleFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder=\"Ex. données, rule3...\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"rule-team-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par équipe impliquée\n                    </label>\n                    <select\n                      id=\"rule-team-filter\"\n                      value={ruleTeamFilter}\n                      onChange={(event) => setRuleTeamFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    >\n                      <option value=\"all\">Toutes les équipes</option>\n                      <option value=\"none\">Sans équipe identifiée</option>\n                      {availableTeamFilterOptions.map((option) => (\n                        <option key={`rule-team-filter-${option.value}`} value={option.value}>\n                          {option.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div className=\"md:col-span-2 lg:col-span-1 flex items-end\">\n                    <p className=\"text-xs text-gray-500\">\n                      {rules.length === 0\n                        ? 'Aucune règle métier n\\'est configurée.'\n                        : visibleRuleIds.length === rules.length\n                          ? 'Toutes les règles sont affichées.'\n                          : visibleRuleIds.length === 0\n                            ? 'Aucune règle ne correspond aux filtres.'\n                            : `${visibleRuleIds.length} règle${visibleRuleIds.length > 1 ? 's' : ''} correspond${visibleRuleIds.length > 1 ? 'ent' : ''} aux filtres.`}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {rules.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune règle métier n'est configurée.\n                </div>\n              ) : visibleRuleIds.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune règle ne correspond aux filtres sélectionnés.\n                </div>\n              ) : (\n                shouldVirtualizeRules ? (\n                  <VirtualizedList\n                    items={visibleRuleEntries}\n                    itemKey={(rule) => rule.id}\n                    estimatedItemHeight={320}\n                    overscan={3}\n                    className=\"relative\"\n                    renderItem={(rule) => {\n                      const conditionSummary = buildRuleConditionSummary(rule, questions);\n                      const risks = Array.isArray(rule.risks) ? rule.risks : [];\n                      const highestRiskPriority = getHighestRiskPriority(risks);\n                      const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n                      const associatedTeamLabels = associatedTeamIds.map((teamId) => getTeamLabel(teamId, teams));\n                      const isExpanded = expandedRuleIds.has(rule.id);\n                      const detailsId = `rule-details-${rule.id}`;\n                      const ruleDisplayName = typeof rule.name === 'string' && rule.name.trim() !== '' ? rule.name : rule.id;\n                      const toggleLabel = isExpanded\n                        ? `Masquer les détails de la règle ${ruleDisplayName}`\n                        : `Afficher les détails de la règle ${ruleDisplayName}`;\n\n                      return (\n                        <div className=\"pb-6\">\n                          <article className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                            <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                              <div className=\"flex items-start gap-3 flex-1\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => toggleRuleExpansion(rule.id)}\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                  aria-expanded={isExpanded}\n                                  aria-controls={detailsId}\n                                >\n                                  <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                  <span className=\"sr-only\">{toggleLabel}</span>\n                                </button>\n                                <div className=\"space-y-2 flex-1\">\n                                  <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-500\">\n                                    <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold\">{rule.id}</span>\n                                    <span className={`px-2 py-1 rounded-full font-semibold ${getPriorityBadgeClasses(highestRiskPriority)}`}>\n                                      {highestRiskPriority\n                                        ? `Priorité principale : ${highestRiskPriority}`\n                                        : 'Priorité non renseignée'}\n                                    </span>\n                                  </div>\n                                  <h3 className=\"text-lg font-semibold text-gray-800\">{ruleDisplayName}</h3>\n                                  {associatedTeamLabels.length > 0 && (\n                                    <div className=\"flex flex-wrap gap-2 text-xs\">\n                                      {associatedTeamLabels.map((label) => (\n                                        <span\n                                          key={`${rule.id}-team-${label}`}\n                                          className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100\"\n                                        >\n                                          {label}\n                                        </span>\n                                      ))}\n                                    </div>\n                                  )}\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-2\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => setEditingRule(rule)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Afficher la règle ${ruleDisplayName}`}\n                                >\n                                  <Eye className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => duplicateRule(rule.id)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Dupliquer la règle ${ruleDisplayName}`}\n                                  title={`Dupliquer la règle ${ruleDisplayName}`}\n                                >\n                                  <Copy className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => deleteRule(rule.id)}\n                                  className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                                  aria-label={`Supprimer la règle ${ruleDisplayName}`}\n                                >\n                                  <Trash2 className=\"w-5 h-5\" />\n                                </button>\n                              </div>\n                            </div>\n\n                            {isExpanded && (\n                              <div id={detailsId} className=\"mt-4 space-y-6 text-sm text-gray-700\">\n                                {conditionSummary.length > 0 ? (\n                                  <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4\">\n                                    <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions de déclenchement</h4>\n                                    <ol className=\"space-y-3\">\n                                      {conditionSummary.map((group) => (\n                                        <li key={`${rule.id}-group-${group.index}`} className=\"space-y-2\">\n                                          <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                            Groupe {group.index} – logique {group.logic === 'OU' ? 'OU' : 'ET'}\n                                          </div>\n                                          <ul className=\"space-y-1\">\n                                            {group.items.map((item, idx) => (\n                                              <li key={`${rule.id}-item-${group.index}-${idx}`} className=\"flex items-start space-x-2\">\n                                                <span className=\"text-blue-500 mt-1\">•</span>\n                                                <span>{item.description}</span>\n                                              </li>\n                                            ))}\n                                          </ul>\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">\n                                    Cette règle est toujours active (aucune condition configurée).\n                                  </p>\n                                )}\n\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                                  <div className=\"space-y-2\">\n                                    <h4 className=\"font-semibold text-gray-800\">Équipes impliquées</h4>\n                                    {associatedTeamLabels.length > 0 ? (\n                                      <ul className=\"flex flex-wrap gap-2\">\n                                        {associatedTeamLabels.map((label) => (\n                                          <li key={`${rule.id}-details-team-${label}`} className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded border border-blue-100\">\n                                            {label}\n                                          </li>\n                                        ))}\n                                      </ul>\n                                    ) : (\n                                      <p className=\"text-xs text-gray-500 italic\">Aucune équipe associée.</p>\n                                    )}\n                                  </div>\n\n                                  <div className=\"space-y-2\">\n                                    <h4 className=\"font-semibold text-gray-800\">Risques identifiés</h4>\n                                    {risks.length > 0 ? (\n                                      <ul className=\"space-y-1\">\n                                        {risks.map((risk, index) => {\n                                          const riskDescription = risk && risk.description ? risk.description : 'Risque non renseigné';\n                                          const riskPriority = risk?.priority || 'A réaliser';\n                                          const riskTeamLabel = risk?.teamId ? getTeamLabel(risk.teamId, teams) : 'Équipe non renseignée';\n\n                                          return (\n                                            <li key={`${rule.id}-risk-${index}`} className=\"space-y-1\">\n                                              <div className=\"flex items-start space-x-2\">\n                                                <span className=\"text-red-500 mt-1\">•</span>\n                                                <span>{riskDescription}</span>\n                                              </div>\n                                              <div className=\"text-xs text-gray-500 flex flex-wrap gap-2 pl-4\">\n                                                <span className=\"inline-flex items-center gap-1\">\n                                                  <strong className=\"font-semibold text-gray-600\">Équipe :</strong>\n                                                  <span>{riskTeamLabel}</span>\n                                                </span>\n                                                <span className=\"inline-flex items-center gap-1\">\n                                                  <strong className=\"font-semibold text-gray-600\">Priorité :</strong>\n                                                  <span>{riskPriority}</span>\n                                                </span>\n                                              </div>\n                                            </li>\n                                          );\n                                        })}\n                                      </ul>\n                                    ) : (\n                                      <p className=\"text-xs text-gray-500 italic\">Aucun risque documenté.</p>\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            )}\n                          </article>\n                        </div>\n                      );\n                    }}\n                  />\n                ) : (\n                  visibleRuleEntries.map((rule) => {\n                    const conditionSummary = buildRuleConditionSummary(rule, questions);\n                    const risks = Array.isArray(rule.risks) ? rule.risks : [];\n                    const highestRiskPriority = getHighestRiskPriority(risks);\n                    const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n                    const associatedTeamLabels = associatedTeamIds.map((teamId) => getTeamLabel(teamId, teams));\n                    const isExpanded = expandedRuleIds.has(rule.id);\n                    const detailsId = `rule-details-${rule.id}`;\n                    const ruleDisplayName = typeof rule.name === 'string' && rule.name.trim() !== '' ? rule.name : rule.id;\n                    const toggleLabel = isExpanded\n                      ? `Masquer les détails de la règle ${ruleDisplayName}`\n                      : `Afficher les détails de la règle ${ruleDisplayName}`;\n\n                    return (\n                      <article key={rule.id} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                        <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                          <div className=\"flex items-start gap-3 flex-1\">\n                            <button\n                              type=\"button\"\n                              onClick={() => toggleRuleExpansion(rule.id)}\n                              className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                              aria-expanded={isExpanded}\n                              aria-controls={detailsId}\n                            >\n                              <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                              <span className=\"sr-only\">{toggleLabel}</span>\n                            </button>\n                            <div className=\"space-y-2 flex-1\">\n                              <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-500\">\n                                <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold\">{rule.id}</span>\n                                <span className={`px-2 py-1 rounded-full font-semibold ${getPriorityBadgeClasses(highestRiskPriority)}`}>\n                                  {highestRiskPriority\n                                    ? `Priorité principale : ${highestRiskPriority}`\n                                    : 'Priorité non renseignée'}\n                                </span>\n                              </div>\n                              <h3 className=\"text-lg font-semibold text-gray-800\">{ruleDisplayName}</h3>\n                              {associatedTeamLabels.length > 0 && (\n                                <div className=\"flex flex-wrap gap-2 text-xs\">\n                                  {associatedTeamLabels.map((label) => (\n                                    <span\n                                      key={`${rule.id}-team-${label}`}\n                                      className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100\"\n                                    >\n                                      {label}\n                                    </span>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex flex-wrap gap-2\">\n                            <button\n                              type=\"button\"\n                              onClick={() => setEditingRule(rule)}\n                              className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                              aria-label={`Afficher la règle ${ruleDisplayName}`}\n                            >\n                              <Eye className=\"w-5 h-5\" />\n                            </button>\n                            <button\n                              type=\"button\"\n                              onClick={() => duplicateRule(rule.id)}\n                              className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                              aria-label={`Dupliquer la règle ${ruleDisplayName}`}\n                              title={`Dupliquer la règle ${ruleDisplayName}`}\n                            >\n                              <Copy className=\"w-5 h-5\" />\n                            </button>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteRule(rule.id)}\n                              className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                              aria-label={`Supprimer la règle ${ruleDisplayName}`}\n                            >\n                              <Trash2 className=\"w-5 h-5\" />\n                            </button>\n                          </div>\n                        </div>\n\n                        {isExpanded && (\n                          <div id={detailsId} className=\"mt-4 space-y-6 text-sm text-gray-700\">\n                            {conditionSummary.length > 0 ? (\n                              <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4\">\n                                <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions de déclenchement</h4>\n                                <ol className=\"space-y-3\">\n                                  {conditionSummary.map((group) => (\n                                    <li key={`${rule.id}-group-${group.index}`} className=\"space-y-2\">\n                                      <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                        Groupe {group.index} – logique {group.logic === 'OU' ? 'OU' : 'ET'}\n                                      </div>\n                                      <ul className=\"space-y-1\">\n                                        {group.items.map((item, idx) => (\n                                          <li key={`${rule.id}-item-${group.index}-${idx}`} className=\"flex items-start space-x-2\">\n                                            <span className=\"text-blue-500 mt-1\">•</span>\n                                            <span>{item.description}</span>\n                                          </li>\n                                        ))}\n                                      </ul>\n                                    </li>\n                                  ))}\n                                </ol>\n                              </div>\n                            ) : (\n                              <p className=\"text-xs text-gray-500 italic\">\n                                Cette règle est toujours active (aucune condition configurée).\n                              </p>\n                            )}\n\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                              <div className=\"space-y-2\">\n                                <h4 className=\"font-semibold text-gray-800\">Équipes impliquées</h4>\n                                {associatedTeamLabels.length > 0 ? (\n                                  <ul className=\"flex flex-wrap gap-2\">\n                                    {associatedTeamLabels.map((label) => (\n                                      <li key={`${rule.id}-details-team-${label}`} className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded border border-blue-100\">\n                                        {label}\n                                      </li>\n                                    ))}\n                                  </ul>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Aucune équipe associée.</p>\n                                )}\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <h4 className=\"font-semibold text-gray-800\">Risques identifiés</h4>\n                                {risks.length > 0 ? (\n                                  <ul className=\"space-y-1\">\n                                    {risks.map((risk, index) => {\n                                      const riskDescription = risk && risk.description ? risk.description : 'Risque non renseigné';\n                                      const riskPriority = risk?.priority || 'A réaliser';\n                                      const riskTeamLabel = risk?.teamId ? getTeamLabel(risk.teamId, teams) : 'Équipe non renseignée';\n\n                                      return (\n                                        <li key={`${rule.id}-risk-${index}`} className=\"space-y-1\">\n                                          <div className=\"flex items-start space-x-2\">\n                                            <span className=\"text-red-500 mt-1\">•</span>\n                                            <span>{riskDescription}</span>\n                                          </div>\n                                          <div className=\"text-xs text-gray-500 flex flex-wrap gap-2 pl-4\">\n                                            <span className=\"inline-flex items-center gap-1\">\n                                              <strong className=\"font-semibold text-gray-600\">Équipe :</strong>\n                                              <span>{riskTeamLabel}</span>\n                                            </span>\n                                            <span className=\"inline-flex items-center gap-1\">\n                                              <strong className=\"font-semibold text-gray-600\">Priorité :</strong>\n                                              <span>{riskPriority}</span>\n                                            </span>\n                                          </div>\n                                        </li>\n                                      );\n                                    })}\n                                  </ul>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Aucun risque documenté.</p>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        )}\n                      </article>\n                    );\n                  })\n                )\n              )}\n            </section>\n          )}\n\n          {activeTab === 'riskLevels' && (\n            <section\n              id=\"backoffice-tabpanel-risk-levels\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-riskLevels\"\n              className=\"space-y-4\"\n            >\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Niveaux de risque</h2>\n                  <p className=\"text-sm text-gray-600\">\n                    Ajustez les seuils utilisés pour calculer la complexité compliance affichée aux équipes.\n                  </p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addRiskLevelRule}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter un niveau\n                </button>\n              </div>\n\n              <div className=\"bg-blue-50 border border-blue-100 rounded-xl p-4 text-sm text-blue-900 space-y-2\">\n                <p className=\"flex items-start gap-2\">\n                  <Info className=\"w-5 h-5 mt-0.5\" />\n                  <span>\n                    Les niveaux sont évalués du haut vers le bas : le premier palier correspondant au score de risque total s’applique.\n                  </span>\n                </p>\n                <p className=\"text-xs text-blue-700\">\n                  Le score de risque additionne le poids de chaque risque selon sa criticité. Laissez la borne maximale vide pour couvrir toutes les valeurs supérieures à la borne minimale.\n                </p>\n              </div>\n\n              <div className=\"bg-white border border-gray-200 rounded-xl p-6 shadow-sm hv-surface space-y-4\">\n                <div>\n                  <h3 className=\"text-lg font-semibold text-gray-800\">Pondération des criticités</h3>\n                  <p className=\"text-sm text-gray-600\">\n                    Ajustez la valeur attribuée à chaque niveau de criticité pour recalculer le score de risque des projets.\n                  </p>\n                </div>\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-3\">\n                  {RISK_WEIGHT_FIELDS.map((field) => (\n                    <div key={field.key} className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\">\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\" htmlFor={`risk-weight-${field.key}`}>\n                        {field.label}\n                      </label>\n                      <input\n                        id={`risk-weight-${field.key}`}\n                        type=\"number\"\n                        min=\"0\"\n                        step=\"0.5\"\n                        value={normalizedRiskWeights[field.key] ?? 0}\n                        onChange={(event) => handleRiskWeightChange(field.key, event.target.value)}\n                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                      />\n                      <p className=\"mt-2 text-xs text-gray-500\">{field.description}</p>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {riskLevelRuleCount === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucun niveau de risque n'est configuré.\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {safeRiskLevelRules.map((rule, index) => {\n                    const ruleId = rule?.id || `risk-level-${index + 1}`;\n                    const labelInputId = `${ruleId}-label`;\n                    const minInputId = `${ruleId}-min`;\n                    const maxInputId = `${ruleId}-max`;\n                    const descriptionId = `${ruleId}-description`;\n                    const rangeLabel = formatRiskRangeLabel(rule);\n                    const issues = getRiskLevelRuleIssues(rule, index, safeRiskLevelRules);\n                    const disableDelete = riskLevelRuleCount <= 1;\n                    const minValue = getRuleMinScoreValue(rule);\n                    const maxScoreValue = getRuleMaxScoreValue(rule);\n                    const maxValue = maxScoreValue === null ? '' : maxScoreValue;\n\n                    return (\n                      <article key={ruleId} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                        <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                          <div className=\"space-y-3 flex-1\">\n                            <div className=\"flex flex-wrap items-center gap-2 text-xs text-gray-500\">\n                              <span className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full font-semibold\">{ruleId}</span>\n                              <span className=\"px-2 py-1 bg-gray-100 text-gray-700 rounded-full\">{rangeLabel}</span>\n                              <span className=\"px-2 py-1 bg-gray-100 text-gray-700 rounded-full\">Palier {index + 1}</span>\n                            </div>\n                            <div>\n                              <label\n                                className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                                htmlFor={labelInputId}\n                              >\n                                Intitulé du niveau\n                              </label>\n                              <input\n                                id={labelInputId}\n                                type=\"text\"\n                                value={rule?.label || ''}\n                                onChange={(event) => updateRiskLevelRuleField(index, 'label', event.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                              />\n                            </div>\n                          </div>\n                          <div className=\"flex items-start gap-2 self-stretch md:self-start\">\n                            <div className=\"flex flex-col gap-2\" role=\"group\" aria-label={`Réordonner le niveau ${rule?.label || index + 1}`}>\n                              <button\n                                type=\"button\"\n                                onClick={() => moveRiskLevelRule(index, index - 1)}\n                                disabled={index === 0}\n                                className=\"p-2 text-gray-600 bg-white border border-gray-200 rounded hover:bg-gray-100 hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                                aria-label={`Monter le niveau ${rule?.label || ruleId}`}\n                              >\n                                <ArrowUp className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => moveRiskLevelRule(index, index + 1)}\n                                disabled={index === riskLevelRuleCount - 1}\n                                className=\"p-2 text-gray-600 bg-white border border-gray-200 rounded hover:bg-gray-100 hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                                aria-label={`Descendre le niveau ${rule?.label || ruleId}`}\n                              >\n                                <ArrowDown className=\"w-4 h-4\" />\n                              </button>\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteRiskLevelRule(ruleId, index)}\n                              disabled={disableDelete}\n                              className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                              aria-label={`Supprimer le niveau ${rule?.label || ruleId}`}\n                            >\n                              <Trash2 className=\"w-5 h-5\" />\n                            </button>\n                          </div>\n                        </div>\n\n                        <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-4\">\n                          <div>\n                            <label\n                              className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                              htmlFor={minInputId}\n                            >\n                              Score minimal\n                            </label>\n                            <input\n                              id={minInputId}\n                              type=\"number\"\n                              min=\"0\"\n                              step=\"0.5\"\n                              value={minValue}\n                              onChange={(event) => updateRiskLevelRuleField(index, 'minScore', event.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                            />\n                          </div>\n                          <div>\n                            <label\n                              className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                              htmlFor={maxInputId}\n                            >\n                              Score maximal (optionnel)\n                            </label>\n                            <input\n                              id={maxInputId}\n                              type=\"number\"\n                              min=\"0\"\n                              step=\"0.5\"\n                              placeholder=\"Illimitée\"\n                              value={maxValue}\n                              onChange={(event) => updateRiskLevelRuleField(index, 'maxScore', event.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                            />\n                            <p className=\"mt-1 text-xs text-gray-500\">\n                              Laisser vide pour couvrir tous les scores au-delà du minimum.\n                            </p>\n                          </div>\n                          <div>\n                            <span className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\">\n                              Résumé automatique\n                            </span>\n                            <div className=\"px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm text-gray-700\">\n                              {rangeLabel}\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className=\"mt-4\">\n                          <label\n                            className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                            htmlFor={descriptionId}\n                          >\n                            Message de contexte\n                          </label>\n                          <textarea\n                            id={descriptionId}\n                            rows={3}\n                            value={rule?.description || ''}\n                            onChange={(event) => updateRiskLevelRuleField(index, 'description', event.target.value)}\n                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y hv-focus-ring\"\n                          />\n                        </div>\n\n                        {issues.length > 0 && (\n                          <div className=\"mt-4 bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-700 space-y-1\">\n                            {issues.map((issue, issueIndex) => (\n                              <p key={`${ruleId}-issue-${issueIndex}`}>• {issue}</p>\n                            ))}\n                          </div>\n                        )}\n                      </article>\n                    );\n                  })}\n                </div>\n              )}\n            </section>\n          )}\n\n          {activeTab === 'teams' && (\n            <section id=\"backoffice-tabpanel-teams\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-teams\" className=\"space-y-4\">\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des équipes</h2>\n                  <p className=\"text-sm text-gray-600\">Définissez les équipes contactées selon les scénarios identifiés.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addTeam}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une équipe\n                </button>\n              </div>\n\n              {teams.length === 0 && (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune équipe renseignée.\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {teams.map((team, index) => (\n                  <article key={team.id} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\" aria-label={`Équipe ${team.name}`}>\n                    <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between mb-4\">\n                      <input\n                        type=\"text\"\n                        value={team.name}\n                        onChange={(event) => updateTeamField(index, 'name', event.target.value)}\n                        className=\"text-lg font-semibold text-gray-800 border-b border-transparent focus:border-blue-600 focus:outline-none flex-1 hv-focus-ring\"\n                        aria-label={`Nom de l'équipe ${team.id}`}\n                      />\n                      <div className=\"flex justify-end sm:justify-start\">\n                        <button\n                          type=\"button\"\n                          onClick={() => deleteTeam(team.id)}\n                          className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                          aria-label={`Supprimer l'équipe ${team.name}`}\n                        >\n                          <Trash2 className=\"w-5 h-5\" />\n                        </button>\n                      </div>\n                    </div>\n\n                    <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\" htmlFor={`${team.id}-contact`}>\n                      Contact principal\n                    </label>\n                    <input\n                      id={`${team.id}-contact`}\n                      type=\"text\"\n                      value={team.contact}\n                      onChange={(event) => updateTeamField(index, 'contact', event.target.value)}\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-4 hv-focus-ring\"\n                    />\n\n                    <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\" htmlFor={`${team.id}-expertise`}>\n                      Domaine d'expertise\n                    </label>\n                    <textarea\n                      id={`${team.id}-expertise`}\n                      value={team.expertise}\n                      onChange={(event) => updateTeamField(index, 'expertise', event.target.value)}\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y hv-focus-ring\"\n                      rows={3}\n                    />\n                  </article>\n                ))}\n              </div>\n            </section>\n          )}\n        </div>\n\n        {editingQuestion && (\n          <QuestionEditor\n            question={editingQuestion}\n            onSave={saveQuestion}\n            onCancel={() => setEditingQuestion(null)}\n            allQuestions={questions}\n          />\n        )}\n\n        {editingRule && (\n          <RuleEditor\n            rule={editingRule}\n            onSave={saveRule}\n            onCancel={() => setEditingRule(null)}\n            questions={questions}\n            teams={teams}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n",
  "src/components/HomeScreen.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  Plus,\n  Target,\n  Rocket,\n  Compass,\n  Users,\n  Calendar,\n  CheckCircle,\n  Eye,\n  AlertTriangle,\n  Edit,\n  Save,\n  Upload,\n  Copy,\n  Trash2,\n  Sparkles\n} from './icons.js';\nimport { VirtualizedList } from './VirtualizedList.jsx';\nimport { normalizeProjectFilterConfig } from '../utils/projectFilters.js';\nimport { normalizeInspirationFiltersConfig } from '../utils/inspirationConfig.js';\n\nconst formatDate = (isoDate) => {\n  if (!isoDate) {\n    return 'Date inconnue';\n  }\n\n  try {\n    return new Date(isoDate).toLocaleString('fr-FR', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  } catch (error) {\n    return 'Date inconnue';\n  }\n};\n\nconst getSafeString = (value) => (typeof value === 'string' ? value : '');\n\nconst normalizeInspirationFieldValues = (value) => {\n  if (Array.isArray(value)) {\n    return value\n      .map((item) => (typeof item === 'string' ? item.trim() : ''))\n      .filter(Boolean);\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    return trimmed.length > 0 ? [trimmed] : [];\n  }\n\n  return [];\n};\n\nconst DEFAULT_SELECT_FILTER_VALUE = 'all';\nconst DEFAULT_TEXT_FILTER_VALUE = '';\n\nconst PROJECT_FILTER_VALUE_EXTRACTORS = {\n  projectName: (project) => {\n    if (!project) {\n      return '';\n    }\n\n    const directName = getSafeString(project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    return getSafeString(project.answers?.projectName);\n  },\n  teamLead: (project) => getSafeString(project?.answers?.teamLead),\n  teamLeadTeam: (project) => getSafeString(project?.answers?.teamLeadTeam)\n};\n\nconst formatAnswerValue = (value) => {\n  if (Array.isArray(value)) {\n    return value.map((item) => (item == null ? '' : String(item))).filter(Boolean).join(', ');\n  }\n\n  if (value == null) {\n    return '';\n  }\n\n  return String(value);\n};\n\nconst getProjectFilterValue = (field, project) => {\n  if (!field || !project) {\n    return '';\n  }\n\n  const extractor = PROJECT_FILTER_VALUE_EXTRACTORS[field.id];\n  if (typeof extractor === 'function') {\n    const extracted = extractor(project);\n    if (typeof extracted === 'string' && extracted.trim().length > 0) {\n      return extracted;\n    }\n  }\n\n  const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n    ? field.sourceQuestionId\n    : field.id;\n\n  const answerValue = project?.answers?.[sourceId];\n  if (typeof answerValue === 'string') {\n    return answerValue;\n  }\n\n  const formattedAnswer = formatAnswerValue(answerValue);\n  if (formattedAnswer.trim().length > 0) {\n    return formattedAnswer;\n  }\n\n  const directValue = project[sourceId];\n  if (typeof directValue === 'string') {\n    return directValue;\n  }\n\n  return formatAnswerValue(directValue);\n};\n\nconst getProjectTimestamp = (project) => {\n  if (!project) {\n    return 0;\n  }\n\n  const candidates = [project.lastUpdated, project.submittedAt, project.generatedAt];\n\n  for (let index = 0; index < candidates.length; index += 1) {\n    const candidate = candidates[index];\n    if (!candidate) {\n      continue;\n    }\n\n    const parsed = new Date(candidate).getTime();\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return 0;\n};\n\nconst buildInitialFiltersState = (config) => {\n  const initial = {\n    sortOrder: 'desc',\n    sortOrderDefault: 'desc'\n  };\n\n  if (!config || !Array.isArray(config.fields)) {\n    return initial;\n  }\n\n  config.fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.id === 'dateOrder') {\n      const defaultValue = field.defaultValue === 'asc' ? 'asc' : 'desc';\n      initial.sortOrder = defaultValue;\n      initial.sortOrderDefault = defaultValue;\n      return;\n    }\n\n    if (field.type === 'select') {\n      initial[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n    } else {\n      initial[field.id] = '';\n    }\n  });\n\n  return initial;\n};\n\nconst SORT_LABELS = {\n  desc: 'Les plus récents en premier',\n  asc: 'Les plus anciens en premier'\n};\n\nconst complexityColors = {\n  Faible: 'text-green-600',\n  Modérée: 'text-yellow-600',\n  Élevée: 'text-red-600'\n};\n\nconst statusStyles = {\n  draft: {\n    label: 'Brouillon en cours',\n    className: 'bg-yellow-50 border-yellow-200 text-yellow-600'\n  },\n  submitted: {\n    label: 'Synthèse finalisée',\n    className: 'bg-emerald-50 border-emerald-200 text-emerald-600'\n  }\n};\n\nconst computeProgress = (project) => {\n  if (!project || typeof project.totalQuestions !== 'number' || project.totalQuestions <= 0) {\n    return null;\n  }\n\n  const answeredCountRaw =\n    typeof project.answeredQuestions === 'number'\n      ? project.answeredQuestions\n      : Math.max((project.lastQuestionIndex ?? 0) + 1, 0);\n\n  const answeredCount = Math.min(answeredCountRaw, project.totalQuestions);\n\n  return Math.round((answeredCount / project.totalQuestions) * 100);\n};\n\nexport const HomeScreen = ({\n  projects = [],\n  projectFilters,\n  teamLeadOptions = [],\n  inspirationProjects = [],\n  inspirationFilters,\n  homeView = 'platform',\n  onHomeViewChange,\n  onStartInspirationProject,\n  onOpenInspirationProject,\n  onStartNewProject,\n  onOpenProject,\n  onDeleteProject,\n  onShowProjectShowcase,\n  onImportProject,\n  onDuplicateProject,\n  isAdminMode = false,\n  tourContext = null\n}) => {\n  const normalizedFilters = useMemo(\n    () => normalizeProjectFilterConfig(projectFilters),\n    [projectFilters]\n  );\n  const [filtersState, setFiltersState] = useState(() => buildInitialFiltersState(normalizedFilters));\n  const normalizedInspirationFilters = useMemo(\n    () => normalizeInspirationFiltersConfig(inspirationFilters),\n    [inspirationFilters]\n  );\n  const [inspirationFiltersState, setInspirationFiltersState] = useState(() =>\n    buildInitialFiltersState(normalizedInspirationFilters)\n  );\n  const fileInputRef = useRef(null);\n  const [deleteDialogState, setDeleteDialogState] = useState(() => ({\n    isOpen: false,\n    project: null\n  }));\n  const deleteCancelButtonRef = useRef(null);\n  const deleteConfirmButtonRef = useRef(null);\n  const previouslyFocusedElementRef = useRef(null);\n\n  const closeDeleteDialog = useCallback(() => {\n    setDeleteDialogState({ isOpen: false, project: null });\n  }, []);\n\n  const handleCancelDeleteProject = useCallback(() => {\n    closeDeleteDialog();\n  }, [closeDeleteDialog]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    let selector = null;\n\n    if (activeStep === 'create-project') {\n      selector = '[data-tour-id=\"home-create-project\"]';\n    } else if (activeStep === 'project-import') {\n      selector = '[data-tour-id=\"home-import-project\"]';\n    } else if (activeStep === 'project-filters') {\n      selector = '[data-tour-id=\"home-filters\"]';\n    }\n\n    if (selector) {\n      const element = document.querySelector(selector);\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      }\n    }\n  }, [tourContext]);\n\n  const handleRequestProjectDeletion = useCallback((project) => {\n    if (!project || !project.id || typeof onDeleteProject !== 'function') {\n      return;\n    }\n\n    if (typeof document !== 'undefined' && document.activeElement instanceof HTMLElement) {\n      previouslyFocusedElementRef.current = document.activeElement;\n    } else {\n      previouslyFocusedElementRef.current = null;\n    }\n\n    setDeleteDialogState({\n      isOpen: true,\n      project\n    });\n  }, [onDeleteProject]);\n\n  const handleConfirmDeleteProject = useCallback(() => {\n    if (!deleteDialogState.project || typeof onDeleteProject !== 'function') {\n      closeDeleteDialog();\n      return;\n    }\n\n    onDeleteProject(deleteDialogState.project.id);\n    closeDeleteDialog();\n  }, [closeDeleteDialog, deleteDialogState.project, onDeleteProject]);\n\n  useEffect(() => {\n    if (!deleteDialogState.isOpen) {\n      if (\n        previouslyFocusedElementRef.current &&\n        typeof previouslyFocusedElementRef.current.focus === 'function'\n      ) {\n        const shouldRestoreFocus =\n          typeof document === 'undefined' ||\n          document.contains(previouslyFocusedElementRef.current);\n\n        if (shouldRestoreFocus) {\n          previouslyFocusedElementRef.current.focus();\n        }\n\n        previouslyFocusedElementRef.current = null;\n      }\n      return undefined;\n    }\n\n    const timeoutId = typeof window !== 'undefined'\n      ? window.setTimeout(() => {\n        if (deleteCancelButtonRef.current && typeof deleteCancelButtonRef.current.focus === 'function') {\n          deleteCancelButtonRef.current.focus();\n        }\n      }, 0)\n      : null;\n\n    const handleKeyDown = (event) => {\n      if (event.key === 'Escape') {\n        event.preventDefault();\n        handleCancelDeleteProject();\n        return;\n      }\n\n      if (event.key === 'Tab') {\n        const focusableElements = [deleteCancelButtonRef.current, deleteConfirmButtonRef.current].filter(\n          (element) => element && typeof element.focus === 'function'\n        );\n\n        if (focusableElements.length === 0) {\n          return;\n        }\n\n        const activeElement = typeof document !== 'undefined' ? document.activeElement : null;\n        const currentIndex = focusableElements.indexOf(activeElement);\n        let nextIndex = currentIndex;\n\n        if (event.shiftKey) {\n          nextIndex = currentIndex <= 0 ? focusableElements.length - 1 : currentIndex - 1;\n        } else {\n          nextIndex = currentIndex === focusableElements.length - 1 ? 0 : currentIndex + 1;\n        }\n\n        event.preventDefault();\n        focusableElements[nextIndex]?.focus();\n      }\n    };\n\n    if (typeof document !== 'undefined') {\n      document.addEventListener('keydown', handleKeyDown);\n    }\n\n    return () => {\n      if (typeof document !== 'undefined') {\n        document.removeEventListener('keydown', handleKeyDown);\n      }\n      if (timeoutId !== null && typeof window !== 'undefined') {\n        window.clearTimeout(timeoutId);\n      }\n    };\n  }, [deleteDialogState.isOpen, handleCancelDeleteProject]);\n\n  useEffect(() => {\n    setFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      if (typeof prevState.sortOrder === 'undefined') {\n        nextState.sortOrder = initialState.sortOrder;\n        changed = true;\n      }\n      if (typeof prevState.sortOrderDefault === 'undefined') {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      if (prevState.sortOrder === prevState.sortOrderDefault) {\n        if (prevState.sortOrder !== initialState.sortOrder) {\n          nextState.sortOrder = initialState.sortOrder;\n          changed = true;\n        }\n      }\n      if (prevState.sortOrderDefault !== initialState.sortOrderDefault) {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      normalizedFilters.fields.forEach((field) => {\n        if (!field || field.id === 'dateOrder') {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = '';\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== '') {\n            nextState[field.id] = '';\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        if (key === 'sortOrder' || key === 'sortOrderDefault') {\n          return;\n        }\n\n        const stillExists = normalizedFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedFilters]);\n\n  useEffect(() => {\n    setInspirationFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedInspirationFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      normalizedInspirationFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_TEXT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        const stillExists = normalizedInspirationFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedInspirationFilters]);\n\n  const selectFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (field.id === 'teamLeadTeam' && Array.isArray(teamLeadOptions)) {\n        teamLeadOptions.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      projects.forEach((project) => {\n        const value = getProjectFilterValue(field, project).trim();\n        if (value.length > 0) {\n          options.add(value);\n        }\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [normalizedFilters.fields, projects, teamLeadOptions]);\n\n  const inspirationFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields) ? normalizedInspirationFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      inspirationProjects.forEach((project) => {\n        const values = normalizeInspirationFieldValues(project?.[field.id]);\n        values.forEach((value) => {\n          if (value.length > 0) {\n            options.add(value);\n          }\n        });\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [normalizedInspirationFilters.fields, inspirationProjects]);\n\n  const filteredProjects = useMemo(() => {\n    if (!Array.isArray(projects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    const selection = projects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled || field.id === 'dateOrder') {\n          continue;\n        }\n\n        const value = filtersState[field.id];\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            const projectValue = getProjectFilterValue(field, project);\n            if (projectValue !== value) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const projectValue = getProjectFilterValue(field, project);\n        if (projectValue.toLowerCase().indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n\n    const sortField = activeFields.find((field) => field && field.id === 'dateOrder');\n    const selectedOrder = filtersState.sortOrder || sortField?.defaultValue || 'desc';\n    const direction = selectedOrder === 'asc' ? 'asc' : 'desc';\n\n    return selection.slice().sort((a, b) => {\n      const timeA = getProjectTimestamp(a);\n      const timeB = getProjectTimestamp(b);\n      const diff = timeA - timeB;\n\n      return direction === 'asc' ? diff : -diff;\n    });\n  }, [projects, normalizedFilters, filtersState]);\n\n  const filteredInspirationProjects = useMemo(() => {\n    if (!Array.isArray(inspirationProjects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    return inspirationProjects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled) {\n          continue;\n        }\n\n        const value = inspirationFiltersState[field.id];\n        const projectValues = normalizeInspirationFieldValues(project?.[field.id]);\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            if (!projectValues.includes(value)) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const haystack = projectValues.join(' ').toLowerCase();\n        if (haystack.indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n  }, [inspirationProjects, normalizedInspirationFilters.fields, inspirationFiltersState]);\n  const projectRows = useMemo(() => {\n    const rows = [];\n    for (let index = 0; index < filteredProjects.length; index += 2) {\n      rows.push(filteredProjects.slice(index, index + 2));\n    }\n    return rows;\n  }, [filteredProjects]);\n  const shouldVirtualizeProjects = projectRows.length > 6;\n\n  const hasProjects = projects.length > 0;\n  const hasFilteredProjects = filteredProjects.length > 0;\n  const hasInspirationProjects = inspirationProjects.length > 0;\n  const hasFilteredInspirationProjects = filteredInspirationProjects.length > 0;\n  const pendingDeletionProjectName = useMemo(() => {\n    if (!deleteDialogState.project) {\n      return '';\n    }\n\n    const directName = getSafeString(deleteDialogState.project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    const answerName = getSafeString(deleteDialogState.project.answers?.projectName);\n    if (answerName.trim().length > 0) {\n      return answerName;\n    }\n\n    return 'Projet sans nom';\n  }, [deleteDialogState.project]);\n\n  const hasActiveFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      if (field.id === 'dateOrder') {\n        if (filtersState.sortOrder !== filtersState.sortOrderDefault) {\n          return true;\n        }\n        continue;\n      }\n\n      const value = filtersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedFilters, filtersState]);\n\n  const hasActiveInspirationFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      const value = inspirationFiltersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedInspirationFilters.fields, inspirationFiltersState]);\n\n  const displayedProjectsCount = filteredProjects.length;\n  const totalProjectsCount = projects.length;\n  const sortFilterConfig = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.find(field => field && field.id === 'dateOrder')\n    : null;\n  const enabledFilterFields = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.filter(field => field && field.enabled && field.id !== 'dateOrder')\n    : [];\n  const shouldShowFiltersCard = hasProjects && (enabledFilterFields.length > 0 || (sortFilterConfig && sortFilterConfig.enabled));\n  const currentSortOrder = filtersState.sortOrder || sortFilterConfig?.defaultValue || 'desc';\n  const inspirationFilterFields = Array.isArray(normalizedInspirationFilters.fields)\n    ? normalizedInspirationFilters.fields.filter((field) => field && field.enabled)\n    : [];\n  const shouldShowInspirationFiltersCard = hasInspirationProjects && inspirationFilterFields.length > 0;\n\n  const handleResetFilters = () => {\n    setFiltersState(buildInitialFiltersState(normalizedFilters));\n  };\n\n  const handleResetInspirationFilters = () => {\n    setInspirationFiltersState(buildInitialFiltersState(normalizedInspirationFilters));\n  };\n\n  const handleTriggerImport = () => {\n    if (fileInputRef.current) {\n      fileInputRef.current.click();\n    }\n  };\n\n  const handleFileChange = (event) => {\n    const file = event?.target?.files?.[0];\n    if (file && typeof onImportProject === 'function') {\n      onImportProject(file);\n    }\n\n    if (event?.target) {\n      event.target.value = '';\n    }\n  };\n\n  const renderProjectCard = (project) => {\n    const complexity = project.analysis?.complexity;\n    const risksCount = project.analysis?.risks?.length ?? 0;\n    const projectStatus = statusStyles[project.status] || statusStyles.submitted;\n    const progress = computeProgress(project);\n    const isDraft = project.status === 'draft';\n    const adminCanEditSubmitted = isAdminMode && !isDraft;\n    const leadName = getSafeString(project?.answers?.teamLead).trim();\n    const leadTeam = getSafeString(project?.answers?.teamLeadTeam).trim();\n    const leadDisplay = leadName.length > 0\n      ? `${leadName}${leadTeam.length > 0 ? ` (${leadTeam})` : ''}`\n      : leadTeam.length > 0\n        ? `(${leadTeam})`\n        : 'Lead du projet non renseigné';\n    const projectTypeRaw = project?.answers?.ProjectType;\n    const projectType = Array.isArray(projectTypeRaw)\n      ? projectTypeRaw\n          .map(item => (typeof item === 'string' ? item.trim() : ''))\n          .filter(item => item.length > 0)\n          .join(', ')\n      : getSafeString(projectTypeRaw).trim();\n    const projectTypeDisplay = projectType.length > 0\n      ? projectType\n      : 'Type de projet non renseigné';\n\n    return (\n      <article\n        key={project.id}\n        className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n        role=\"listitem\"\n        aria-label={`Projet ${project.projectName || 'sans nom'}`}\n      >\n        <div className=\"flex items-start justify-between gap-4\">\n          <div>\n            <h3 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2 flex-wrap\">\n              <span>{project.projectName || 'Projet sans nom'}</span>\n              {project.isDemo && (\n                <span className=\"inline-flex items-center px-2 py-0.5 text-xs font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full\">\n                  Projet démo\n                </span>\n              )}\n            </h3>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              Dernière mise à jour : {formatDate(project.lastUpdated || project.submittedAt)}\n            </p>\n          </div>\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex flex-col items-end gap-2\">\n              <span\n                className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${projectStatus.className}`.trim()}\n              >\n                {projectStatus.label}\n              </span>\n              {complexity && (\n                <span className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${complexityColors[complexity] || 'text-blue-600'}`}>\n                  {complexity}\n                </span>\n              )}\n            </div>\n            {typeof onDuplicateProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => onDuplicateProject(project.id)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-blue-200 text-blue-600 hover:bg-blue-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Dupliquer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Dupliquer le projet\"\n              >\n                <Copy className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n            {isDraft && typeof onDeleteProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => handleRequestProjectDeletion(project)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Supprimer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Supprimer le projet\"\n              >\n                <Trash2 className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n          </div>\n        </div>\n\n        <dl className=\"mt-4 grid grid-cols-1 gap-3 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"w-4 h-4\" />\n            <span className=\"font-medium text-gray-700\">{leadDisplay}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{projectTypeDisplay}</span>\n          </div>\n          {progress !== null && (\n            <div className=\"flex items-center gap-2\">\n              <Save className=\"w-4 h-4\" />\n              <span>{progress}% du questionnaire complété</span>\n            </div>\n          )}\n          <div className=\"flex items-center gap-2\">\n            <AlertTriangle className=\"w-4 h-4\" />\n            <span>{risksCount} risque{risksCount > 1 ? 's' : ''} identifié{risksCount > 1 ? 's' : ''}</span>\n          </div>\n        </dl>\n\n        <div className=\"mt-6 flex flex-wrap gap-3\">\n          <button\n            type=\"button\"\n            onClick={() => {\n              if (isDraft) {\n                onOpenProject(project.id);\n                return;\n              }\n\n              if (adminCanEditSubmitted) {\n                onOpenProject(project.id, { view: 'questionnaire' });\n                return;\n              }\n\n              onOpenProject(project.id);\n            }}\n            className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button ${\n              isDraft || adminCanEditSubmitted\n                ? 'hv-button-draft text-white'\n                : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n            }`}\n          >\n            {isDraft ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Continuer l'édition</span>\n              </>\n            ) : adminCanEditSubmitted ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Modifier le projet</span>\n              </>\n            ) : (\n              <>\n                <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Consulter la synthèse</span>\n              </>\n            )}\n          </button>\n          {adminCanEditSubmitted && (\n            <button\n              type=\"button\"\n              onClick={() => onOpenProject(project.id, { view: 'synthesis' })}\n              className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n            >\n              <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n              <span>Consulter la synthèse</span>\n            </button>\n          )}\n          {onShowProjectShowcase && (\n            <button\n              type=\"button\"\n              onClick={() => onShowProjectShowcase(project.id)}\n              className=\"inline-flex items-center px-4 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all hv-button hv-focus-ring\"\n            >\n              <Sparkles className=\"w-4 h-4 mr-2\" /> Vitrine du projet\n            </button>\n          )}\n        </div>\n      </article>\n    );\n  };\n\n  const renderInspirationCard = (project) => (\n    <article\n      key={project.id}\n      className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n      role=\"listitem\"\n      aria-label={`Projet inspirant ${project.title || 'sans titre'}`}\n    >\n      <div className=\"space-y-3\">\n        <div>\n          <h3 className=\"text-xl font-semibold text-gray-900\">{project.title || 'Projet sans titre'}</h3>\n          <p className=\"text-sm text-gray-500\">{project.labName || 'Laboratoire non renseigné'}</p>\n        </div>\n        <dl className=\"grid grid-cols-1 gap-2 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Compass className=\"w-4 h-4\" />\n            <span>{project.country || 'Pays non renseigné'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{project.target || 'Cible non renseignée'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Sparkles className=\"w-4 h-4\" />\n            <span>{project.therapeuticArea || 'Aire thérapeutique non renseignée'}</span>\n          </div>\n        </dl>\n      </div>\n      <div className=\"mt-5 flex flex-wrap gap-3\">\n        <button\n          type=\"button\"\n          onClick={() => onOpenInspirationProject?.(project.id)}\n          className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n        >\n          <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n          <span>Fiche complète</span>\n        </button>\n      </div>\n    </article>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8 hv-background\">\n      <div className=\"max-w-6xl mx-auto space-y-12\">\n        <header className=\"bg-white border border-blue-100 rounded-3xl shadow-xl p-6 sm:p-10 hv-surface\" role=\"banner\">\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6\">\n            <div className=\"space-y-4\">\n              <span className=\"inline-flex items-center px-3 py-1 text-sm font-semibold text-blue-700 bg-blue-100 rounded-full border border-blue-200\">\n                <Target className=\"w-4 h-4 mr-2\" /> Votre copilote compliance\n              </span>\n              <h1 className=\"text-3xl sm:text-4xl font-bold text-gray-900 leading-tight\">\n                Anticipez les besoins compliance de vos projets en quelques minutes\n              </h1>\n              <p className=\"text-lg text-gray-600 leading-relaxed max-w-2xl\">\n                Project Navigator vous guide pas à pas pour qualifier votre initiative, identifier les interlocuteurs à mobiliser et sécuriser vos délais réglementaires.\n              </p>\n              <div className=\"flex flex-col sm:flex-row gap-3\" role=\"group\" aria-label=\"Actions principales\">\n                <button\n                  type=\"button\"\n                  onClick={onStartNewProject}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-xl shadow-md transition-all hv-button hv-button-primary\"\n                  data-tour-id=\"home-create-project\"\n                >\n                  <Plus className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>Créer un nouveau</span>\n                    <span>projet</span>\n                  </span>\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleTriggerImport}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-blue-600 bg-white hover:bg-blue-50 rounded-xl border border-blue-200 transition-all hv-button hv-focus-ring\"\n                  data-tour-id=\"home-import-project\"\n                >\n                  <Upload className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>Charger</span>\n                    <span>un projet</span>\n                  </span>\n                </button>\n              </div>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\"application/json\"\n                onChange={handleFileChange}\n                className=\"hidden\"\n                tabIndex={-1}\n                aria-hidden=\"true\"\n              />\n            </div>\n            <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 text-sm text-gray-600\">\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Rocket className=\"w-5 h-5 mr-2\" /> Démarrez simplement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Un questionnaire dynamique pour cadrer votre projet et qualifier les impacts compliance.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Compass className=\"w-5 h-5 mr-2\" /> Visualisez la feuille de route\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Une synthèse claire avec le niveau de complexité, les équipes à mobiliser et les délais recommandés.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Users className=\"w-5 h-5 mr-2\" /> Collaborez efficacement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Partagez la synthèse avec les parties prenantes pour sécuriser vos points de passage.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Calendar className=\"w-5 h-5 mr-2\" /> Gardez une trace\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Retrouvez à tout moment les projets déjà soumis et mettez-les à jour si nécessaire.\n                </p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        <section aria-labelledby=\"projects-heading\" className=\"space-y-6\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div>\n              <h2 id=\"projects-heading\" className=\"text-2xl font-bold text-gray-900\">\n                {homeView === 'inspiration' ? 'Projets inspirants' : 'Vos projets enregistrés'}\n              </h2>\n              <p className=\"text-sm text-gray-600\">\n                {homeView === 'inspiration'\n                  ? 'Découvrez les initiatives d’autres laboratoires et gérez vos projets inspirants.'\n                  : 'Accédez aux brouillons et aux synthèses finalisées pour les reprendre à tout moment.'}\n              </p>\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n              <div\n                className=\"inline-flex items-center rounded-full border border-blue-200 bg-blue-50 p-1\"\n                role=\"group\"\n                aria-label=\"Sélection du bloc projet\"\n              >\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('platform')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView !== 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Projets LFB\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('inspiration')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView === 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Inspiration\n                </button>\n              </div>\n              {homeView === 'inspiration' ? (\n                <button\n                  type=\"button\"\n                  onClick={onStartInspirationProject}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n                >\n                  <Plus className=\"w-4 h-4\" aria-hidden=\"true\" />\n                  Ajouter un projet inspirant\n                </button>\n              ) : (\n                <span className=\"inline-flex items-center text-sm font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full px-3 py-1\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" /> {displayedProjectsCount} projet{displayedProjectsCount > 1 ? 's' : ''}\n                  {hasActiveFilters ? ` sur ${totalProjectsCount}` : ''}\n                </span>\n              )}\n            </div>\n          </div>\n\n          {homeView !== 'inspiration' && !hasProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet enregistré pour le moment.</p>\n              <p className=\"mt-2\">Lancez-vous dès maintenant pour préparer votre première synthèse compliance.</p>\n              <button\n                type=\"button\"\n                onClick={onStartNewProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> Créer un projet\n              </button>\n            </div>\n          )}\n\n          {homeView !== 'inspiration' && hasProjects && (\n            <>\n              {shouldShowFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets\"\n                  data-tour-id=\"home-filters\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres disponibles\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveFilters}\n                    >\n                      Réinitialiser\n                    </button>\n                  </div>\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                    {enabledFilterFields.map((field) => {\n                      const fieldId = `project-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = filtersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = selectFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof filtersState[field.id] === 'string' ? filtersState[field.id] : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                    {sortFilterConfig && sortFilterConfig.enabled && (\n                      <div className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                        <label htmlFor=\"project-sort-order\" className=\"font-semibold text-gray-700\">\n                          {sortFilterConfig.label}\n                        </label>\n                        <select\n                          id=\"project-sort-order\"\n                          value={currentSortOrder}\n                          onChange={(event) =>\n                            setFiltersState(prev => ({\n                              ...prev,\n                              sortOrder: event.target.value === 'asc' ? 'asc' : 'desc'\n                            }))\n                          }\n                          className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        >\n                          <option value=\"desc\">{SORT_LABELS.desc}</option>\n                          <option value=\"asc\">{SORT_LABELS.asc}</option>\n                        </select>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredProjects ? (\n                shouldVirtualizeProjects ? (\n                  <VirtualizedList\n                    items={projectRows}\n                    itemKey={(_row, index) => `project-row-${index}`}\n                    estimatedItemHeight={420}\n                    overscan={3}\n                    role=\"list\"\n                    className=\"relative\"\n                    renderItem={(row) => (\n                      <div className=\"pb-6\">\n                        <div className=\"flex flex-col md:flex-row gap-6\">\n                          {row.map(project => renderProjectCard(project))}\n                        </div>\n                      </div>\n                    )}\n                  />\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                    {filteredProjects.map(project => renderProjectCard(project))}\n                  </div>\n                )\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond à vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critères ou réinitialisez les filtres pour afficher tous les projets.</p>\n                  {hasActiveFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Réinitialiser les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n\n          {homeView === 'inspiration' && !hasInspirationProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet inspirant enregistré.</p>\n              <p className=\"mt-2\">Ajoutez des exemples pour nourrir vos réflexions.</p>\n              <button\n                type=\"button\"\n                onClick={onStartInspirationProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> Créer un projet inspirant\n              </button>\n            </div>\n          )}\n\n          {homeView === 'inspiration' && hasInspirationProjects && (\n            <>\n              {shouldShowInspirationFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets inspirants\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres Inspiration\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveInspirationFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveInspirationFilters}\n                    >\n                      Réinitialiser\n                    </button>\n                  </div>\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5\">\n                    {inspirationFilterFields.map((field) => {\n                      const fieldId = `inspiration-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = inspirationFiltersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = inspirationFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof inspirationFiltersState[field.id] === 'string'\n                        ? inspirationFiltersState[field.id]\n                        : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredInspirationProjects ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                  {filteredInspirationProjects.map(project => renderInspirationCard(project))}\n                </div>\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond à vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critères ou réinitialisez les filtres.</p>\n                  {hasActiveInspirationFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Réinitialiser les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n        </section>\n      </div>\n      {deleteDialogState.isOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div\n            className=\"absolute inset-0 bg-gray-900 bg-opacity-60\"\n            aria-hidden=\"true\"\n            onClick={handleCancelDeleteProject}\n          />\n          <div\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby=\"delete-project-dialog-title\"\n            aria-describedby=\"delete-project-dialog-description\"\n            className=\"relative z-10 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl focus:outline-none hv-surface\"\n          >\n            <div className=\"flex items-start gap-3\">\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600\">\n                <Trash2 className=\"h-6 w-6\" aria-hidden=\"true\" />\n              </div>\n              <div>\n                <h2 id=\"delete-project-dialog-title\" className=\"text-xl font-semibold text-gray-900\">\n                  Supprimer le projet ?\n                </h2>\n                <p id=\"delete-project-dialog-description\" className=\"mt-2 text-sm text-gray-600\">\n                  Vous êtes sur le point de supprimer « {pendingDeletionProjectName || 'Projet sans nom'} ». Cette action est\n                  définitive et le projet ne pourra pas être restauré.\n                </p>\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end sm:gap-3\">\n              <button\n                type=\"button\"\n                ref={deleteCancelButtonRef}\n                onClick={handleCancelDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors hv-button hv-focus-ring\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                ref={deleteConfirmButtonRef}\n                onClick={handleConfirmDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-red-200 bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition-colors hv-button hv-button-danger\"\n              >\n                Supprimer définitivement\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/InspirationDetail.jsx": "import React, { useEffect, useMemo, useState } from '../react.js';\nimport { Edit, Save, Close, Link as LinkIcon } from './icons.js';\nimport { normalizeInspirationFormConfig } from '../utils/inspirationConfig.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\nimport { renderRichText } from '../utils/richText.js';\n\nconst formatValue = (value) => {\n  if (Array.isArray(value)) {\n    const formatted = value\n      .map((item) => (typeof item === 'string' ? item.trim() : ''))\n      .filter(Boolean)\n      .join(', ');\n    return formatted.length > 0 ? formatted : 'Non renseigné';\n  }\n\n  if (typeof value === 'string' && value.trim().length > 0) {\n    return value;\n  }\n  return 'Non renseigné';\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeMultiSelect = (value) =>\n  Array.isArray(value)\n    ? value\n        .map((item) => (typeof item === 'string' ? item.trim() : ''))\n        .filter(Boolean)\n    : [];\n\nexport const InspirationDetail = ({\n  project,\n  formConfig,\n  onBack,\n  onUpdate\n}) => {\n  const normalizedConfig = useMemo(\n    () => normalizeInspirationFormConfig(formConfig),\n    [formConfig]\n  );\n  const [draft, setDraft] = useState(project);\n  const [editingFields, setEditingFields] = useState({});\n\n  useEffect(() => {\n    setDraft(project);\n    setEditingFields({});\n  }, [project]);\n\n  if (!project) {\n    return null;\n  }\n\n  const enabledFields = normalizedConfig.fields.filter((field) => field.enabled);\n\n  const toggleFieldEditing = (fieldId, isEditing) => {\n    setEditingFields((prev) => ({ ...prev, [fieldId]: isEditing }));\n  };\n\n  const handleFieldChange = (fieldId, value) => {\n    setDraft((prev) => ({ ...prev, [fieldId]: value }));\n  };\n\n  const handleSaveField = (field) => {\n    if (typeof onUpdate !== 'function') {\n      toggleFieldEditing(field.id, false);\n      return;\n    }\n\n    const fieldId = field.id;\n    const fieldType = field.type;\n    const nextValue = draft[fieldId];\n    const updates = {\n      [fieldId]: fieldType === 'documents'\n        ? normalizeDocuments(nextValue)\n        : fieldType === 'multi_select'\n          ? normalizeMultiSelect(nextValue)\n          : nextValue,\n      updatedAt: new Date().toISOString()\n    };\n    onUpdate(project.id, updates);\n    toggleFieldEditing(fieldId, false);\n  };\n\n  const renderField = (field, content) => (\n    <div className=\"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm\">\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\n        <div>\n          <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n            {field.label || field.id}\n          </p>\n          {content}\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          {editingFields[field.id] ? (\n            <>\n              <button\n                type=\"button\"\n                onClick={() => handleSaveField(field)}\n                className=\"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-700\"\n              >\n                <Save className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Sauvegarder\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setDraft(project);\n                  toggleFieldEditing(field.id, false);\n                }}\n                className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50\"\n              >\n                <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Annuler\n              </button>\n            </>\n          ) : (\n            <button\n              type=\"button\"\n              onClick={() => toggleFieldEditing(field.id, true)}\n              className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n            >\n              <Edit className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Modifier\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n\n  const resolvePlaceholder = (field, fallback) => {\n    if (typeof field.placeholder === 'string' && field.placeholder.trim() !== '') {\n      return field.placeholder.trim();\n    }\n\n    return fallback;\n  };\n\n  const renderEditableField = (field) => {\n    const value = draft?.[field.id] ?? '';\n\n    if (field.type === 'select') {\n      const emptyOptionLabel = resolvePlaceholder(field, 'Sélectionner...');\n      return (\n        <select\n          value={value}\n          onChange={(event) => handleFieldChange(field.id, event.target.value)}\n          className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        >\n          <option value=\"\">{emptyOptionLabel}</option>\n          {(field.options || []).map((option) => (\n            <option key={option} value={option}>\n              {option}\n            </option>\n          ))}\n        </select>\n      );\n    }\n\n    if (field.type === 'multi_select') {\n      const selections = normalizeMultiSelect(value);\n      return (\n        <select\n          multiple\n          value={selections}\n          onChange={(event) =>\n            handleFieldChange(\n              field.id,\n              Array.from(event.target.selectedOptions).map((option) => option.value)\n            )}\n          className=\"mt-2 w-full min-h-[140px] rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        >\n          {(field.options || []).map((option) => (\n            <option key={option} value={option}>\n              {option}\n            </option>\n          ))}\n        </select>\n      );\n    }\n\n    if (field.type === 'long_text') {\n      const fallback = field.id === 'review'\n        ? 'Ajoutez un avis détaillé...'\n        : 'Saisissez une description détaillée...';\n      return (\n        <div className=\"mt-2\">\n          <RichTextEditor\n            id={`inspiration-${field.id}`}\n            value={value}\n            onChange={(nextValue) => handleFieldChange(field.id, nextValue)}\n            ariaLabel={`${field.label} (édition riche)`}\n            placeholder={resolvePlaceholder(field, fallback)}\n            compact\n          />\n        </div>\n      );\n    }\n\n    if (field.type === 'documents') {\n      return (\n        <div className=\"mt-2 space-y-3\">\n          {normalizeDocuments(value).map((doc, index) => (\n            <div key={`doc-${index}`} className=\"grid grid-cols-1 gap-2 md:grid-cols-2\">\n              <input\n                type=\"text\"\n                value={doc.name}\n                onChange={(event) => {\n                  const nextDocs = normalizeDocuments(value);\n                  nextDocs[index] = { ...doc, name: event.target.value };\n                  handleFieldChange(field.id, nextDocs);\n                }}\n                className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n              />\n              <input\n                type=\"url\"\n                value={doc.url}\n                onChange={(event) => {\n                  const nextDocs = normalizeDocuments(value);\n                  nextDocs[index] = { ...doc, url: event.target.value };\n                  handleFieldChange(field.id, nextDocs);\n                }}\n                className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n              />\n            </div>\n          ))}\n          <button\n            type=\"button\"\n            onClick={() =>\n              handleFieldChange(field.id, [\n                ...normalizeDocuments(value),\n                { name: '', url: '' }\n              ])\n            }\n            className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n          >\n            Ajouter un document\n          </button>\n        </div>\n      );\n    }\n\n    const inputType = field.type === 'url' ? 'url' : 'text';\n    const placeholder = resolvePlaceholder(field, field.type === 'url' ? 'https://...' : '');\n\n    return (\n      <input\n        type={inputType}\n        value={value}\n        onChange={(event) => handleFieldChange(field.id, event.target.value)}\n        className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        placeholder={placeholder}\n      />\n    );\n  };\n\n  const renderDisplayField = (field) => {\n    const value = project?.[field.id];\n\n    if (field.type === 'long_text') {\n      return (\n        <p className=\"mt-2 text-sm text-gray-700\">\n          {value?.trim() ? renderRichText(value) : formatValue(value)}\n        </p>\n      );\n    }\n\n    if (field.type === 'documents') {\n      const docs = normalizeDocuments(value);\n      return (\n        <div className=\"mt-2 space-y-2 text-sm text-gray-700\">\n          {docs.length > 0 ? (\n            docs.map((doc, index) => (\n              <div key={`doc-view-${index}`} className=\"flex flex-col\">\n                <span className=\"font-medium\">{doc.name || 'Document'}</span>\n                {doc.url && (\n                  <a\n                    href={doc.url}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-blue-600 hover:underline\"\n                  >\n                    {doc.url}\n                  </a>\n                )}\n              </div>\n            ))\n          ) : (\n            <p>Non renseigné</p>\n          )}\n        </div>\n      );\n    }\n\n    if (field.type === 'multi_select') {\n      const selections = normalizeMultiSelect(value);\n      return (\n        <p className=\"mt-2 text-sm text-gray-700\">\n          {selections.length > 0 ? selections.join(', ') : 'Non renseigné'}\n        </p>\n      );\n    }\n\n    if (field.type === 'url') {\n      return value ? (\n        <a\n          href={value}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"mt-2 inline-flex items-center gap-2 text-sm text-blue-600 hover:underline\"\n        >\n          <LinkIcon className=\"h-4 w-4\" aria-hidden=\"true\" />\n          {value}\n        </a>\n      ) : (\n        <p className=\"mt-2 text-sm text-gray-700\">Non renseigné</p>\n      );\n    }\n\n    return <p className=\"mt-2 text-sm text-gray-700\">{formatValue(value)}</p>;\n  };\n\n  const visibilityLabel = project.visibility === 'shared' ? 'Partagé' : 'Personnel';\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        <header className=\"rounded-3xl border border-gray-200 bg-white p-6 shadow-lg\">\n          <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\n            <div>\n              <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-600\">Fiche projet inspirant</p>\n              <h1 className=\"text-3xl font-bold text-gray-900\">{project.title}</h1>\n              <p className=\"mt-1 text-sm text-gray-500\">\n                {project.labName} · {project.country}\n              </p>\n            </div>\n            <button\n              type=\"button\"\n              onClick={onBack}\n              className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n            >\n              <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Retour\n            </button>\n          </div>\n\n          <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div>\n              <p className=\"text-xs text-gray-500\">Mode de partage</p>\n              <p className=\"text-sm font-semibold text-gray-700\">{visibilityLabel}</p>\n            </div>\n            <div\n              className=\"inline-flex items-center rounded-full border border-blue-200 bg-blue-50 p-1\"\n              role=\"group\"\n              aria-label=\"Mode de partage\"\n            >\n              <button\n                type=\"button\"\n                onClick={() => onUpdate(project.id, { visibility: 'personal', updatedAt: new Date().toISOString() })}\n                className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                  project.visibility !== 'shared'\n                    ? 'bg-blue-600 text-white'\n                    : 'text-blue-700 hover:bg-blue-100'\n                }`}\n              >\n                Personnel\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => onUpdate(project.id, { visibility: 'shared', updatedAt: new Date().toISOString() })}\n                className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                  project.visibility === 'shared'\n                    ? 'bg-blue-600 text-white'\n                    : 'text-blue-700 hover:bg-blue-100'\n                }`}\n              >\n                Partagé\n              </button>\n            </div>\n          </div>\n        </header>\n\n        <div className=\"grid grid-cols-1 gap-4\">\n          {enabledFields.map((field) => (\n            <React.Fragment key={field.id}>\n              {renderField(\n                field,\n                editingFields[field.id] ? renderEditableField(field) : renderDisplayField(field)\n              )}\n            </React.Fragment>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/InspirationForm.jsx": "import React, { useEffect, useMemo, useState } from '../react.js';\nimport { Plus, Save, Close } from './icons.js';\nimport { normalizeInspirationFormConfig } from '../utils/inspirationConfig.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\n\nconst buildInitialFormState = (config) => {\n  const fields = Array.isArray(config?.fields) ? config.fields : [];\n  const initialState = {};\n\n  fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.type === 'documents') {\n      initialState[field.id] = [{ name: '', url: '' }];\n      return;\n    }\n\n    if (field.type === 'multi_select') {\n      initialState[field.id] = [];\n      return;\n    }\n\n    initialState[field.id] = '';\n  });\n\n  return initialState;\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeMultiSelect = (value) =>\n  Array.isArray(value)\n    ? value\n        .map((item) => (typeof item === 'string' ? item.trim() : ''))\n        .filter(Boolean)\n    : [];\n\nconst renderFieldLabel = (field) => {\n  if (!field) {\n    return '';\n  }\n\n  return field.required ? `${field.label} *` : field.label;\n};\n\nexport const InspirationForm = ({\n  formConfig,\n  existingProjects = [],\n  onSubmit,\n  onCancel\n}) => {\n  const normalizedConfig = useMemo(\n    () => normalizeInspirationFormConfig(formConfig),\n    [formConfig]\n  );\n  const [formState, setFormState] = useState(() => buildInitialFormState(normalizedConfig));\n  const [errors, setErrors] = useState({});\n\n  const labSuggestions = useMemo(() => {\n    const suggestions = new Set();\n    existingProjects.forEach((project) => {\n      const name = typeof project?.labName === 'string' ? project.labName.trim() : '';\n      if (name.length > 0) {\n        suggestions.add(name);\n      }\n    });\n    return Array.from(suggestions).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));\n  }, [existingProjects]);\n\n  useEffect(() => {\n    setFormState((prev) => {\n      const baseState = buildInitialFormState(normalizedConfig);\n      const merged = { ...baseState, ...prev };\n\n      normalizedConfig.fields.forEach((field) => {\n        if (field.type !== 'documents') {\n          if (field.type === 'multi_select' && !Array.isArray(merged[field.id])) {\n            merged[field.id] = baseState[field.id];\n          }\n          return;\n        }\n\n        if (!Array.isArray(merged[field.id]) || merged[field.id].length === 0) {\n          merged[field.id] = baseState[field.id];\n        }\n      });\n\n      return merged;\n    });\n  }, [normalizedConfig]);\n\n  const updateField = (fieldId, value) => {\n    setFormState((prev) => ({ ...prev, [fieldId]: value }));\n  };\n\n  const handleDocumentChange = (fieldId, index, key, value) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      const target = nextDocuments[index] || { name: '', url: '' };\n      nextDocuments[index] = { ...target, [key]: value };\n      return { ...prev, [fieldId]: nextDocuments };\n    });\n  };\n\n  const handleAddDocument = (fieldId) => {\n    setFormState((prev) => ({\n      ...prev,\n      [fieldId]: [...(prev[fieldId] || []), { name: '', url: '' }]\n    }));\n  };\n\n  const handleRemoveDocument = (fieldId, index) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      nextDocuments.splice(index, 1);\n      return {\n        ...prev,\n        [fieldId]: nextDocuments.length > 0 ? nextDocuments : [{ name: '', url: '' }]\n      };\n    });\n  };\n\n  const validate = () => {\n    const nextErrors = {};\n\n    normalizedConfig.fields.forEach((field) => {\n      if (!field.enabled || !field.required) {\n        return;\n      }\n\n      const value = formState[field.id];\n      if (field.type === 'documents') {\n        const normalizedDocs = normalizeDocuments(value);\n        if (normalizedDocs.length === 0) {\n          nextErrors[field.id] = 'Veuillez renseigner au moins un document.';\n        }\n        return;\n      }\n\n      if (field.type === 'multi_select') {\n        const normalizedSelections = normalizeMultiSelect(value);\n        if (normalizedSelections.length === 0) {\n          nextErrors[field.id] = 'Veuillez sélectionner au moins une option.';\n        }\n        return;\n      }\n\n      if (value == null || (typeof value === 'string' && value.trim().length === 0)) {\n        nextErrors[field.id] = 'Ce champ est requis.';\n      }\n    });\n\n    setErrors(nextErrors);\n    return Object.keys(nextErrors).length === 0;\n  };\n\n  const handleSubmit = (event) => {\n    event.preventDefault();\n    if (!validate()) {\n      return;\n    }\n\n    const now = new Date().toISOString();\n    const payload = normalizedConfig.fields.reduce((acc, field) => {\n      if (!field.enabled) {\n        return acc;\n      }\n\n      if (field.type === 'documents') {\n        acc[field.id] = normalizeDocuments(formState[field.id]);\n        return acc;\n      }\n\n      if (field.type === 'multi_select') {\n        acc[field.id] = normalizeMultiSelect(formState[field.id]);\n        return acc;\n      }\n\n      const value = formState[field.id];\n      if (typeof value === 'string') {\n        acc[field.id] = value.trim();\n        return acc;\n      }\n\n      acc[field.id] = value ?? '';\n      return acc;\n    }, {});\n\n    payload.visibility = 'personal';\n    payload.createdAt = now;\n    payload.updatedAt = now;\n\n    if (typeof onSubmit === 'function') {\n      onSubmit(payload);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8\">\n      <div className=\"max-w-4xl mx-auto\">\n        <header className=\"mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-600\">\n              Nouvel exemple inspirant\n            </p>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Questionnaire projet inspiration</h1>\n            <p className=\"mt-2 text-sm text-gray-600\">\n              Documentez un projet inspirant issu d'un autre laboratoire afin d'enrichir la base d'exemples.\n            </p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={onCancel}\n            className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n          >\n            <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n            Retour\n          </button>\n        </header>\n\n        <form\n          onSubmit={handleSubmit}\n          className=\"space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-lg\"\n        >\n          <div className=\"grid grid-cols-1 gap-6 md:grid-cols-2\">\n            {normalizedConfig.fields\n              .filter((field) => field.enabled && field.type !== 'long_text' && field.type !== 'documents')\n              .map((field) => {\n                if (field.type === 'select') {\n                  const emptyOptionLabel = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'Sélectionner...';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        value={formState[field.id] || ''}\n                        onChange={(event) => updateField(field.id, event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">{emptyOptionLabel}</option>\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.type === 'multi_select') {\n                  const selectedValues = Array.isArray(formState[field.id]) ? formState[field.id] : [];\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        multiple\n                        value={selectedValues}\n                        onChange={(event) =>\n                          updateField(\n                            field.id,\n                            Array.from(event.target.selectedOptions).map((option) => option.value)\n                          )}\n                        className=\"min-h-[120px] rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.id === 'labName') {\n                  const placeholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'Nom du laboratoire';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <input\n                        type=\"text\"\n                        list=\"inspiration-labs\"\n                        value={formState.labName}\n                        onChange={(event) => updateField('labName', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        placeholder={placeholder}\n                      />\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                const inputType = field.type === 'url' ? 'url' : 'text';\n                const inputPlaceholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                  ? field.placeholder.trim()\n                  : field.type === 'url'\n                    ? 'https://...'\n                    : '';\n\n                return (\n                  <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                    <span>{renderFieldLabel(field)}</span>\n                    <input\n                      type={inputType}\n                      value={formState[field.id] || ''}\n                      onChange={(event) => updateField(field.id, event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder={inputPlaceholder}\n                    />\n                    {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                  </label>\n                );\n              })}\n          </div>\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'long_text')\n            .map((field) => (\n              <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                <span>{renderFieldLabel(field)}</span>\n                <RichTextEditor\n                  id={`inspiration-${field.id}`}\n                  value={formState[field.id] || ''}\n                  onChange={(value) => updateField(field.id, value)}\n                  ariaLabel={`${field.label} (édition riche)`}\n                  placeholder={\n                    typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                      ? field.placeholder.trim()\n                      : field.id === 'review'\n                        ? 'Ajoutez votre avis détaillé sur ce projet inspirant...'\n                        : 'Saisir une description détaillée...'\n                  }\n                  compact\n                />\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </label>\n            ))}\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'documents')\n            .map((field) => (\n              <div key={field.id} className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-gray-700\">{renderFieldLabel(field)}</p>\n                    <p className=\"text-xs text-gray-500\">\n                      Ajoutez plusieurs documents (nom + URL).\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={() => handleAddDocument(field.id)}\n                    className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n                  >\n                    <Plus className=\"h-4 w-4\" aria-hidden=\"true\" />\n                    Ajouter\n                  </button>\n                </div>\n                <div className=\"space-y-3\">\n                  {(formState[field.id] || []).map((doc, index) => (\n                    <div\n                      key={`doc-${index}`}\n                      className=\"grid grid-cols-1 gap-3 rounded-xl border border-gray-200 bg-gray-50 p-3 md:grid-cols-[1fr_1fr_auto]\"\n                    >\n                      <input\n                        type=\"text\"\n                        value={doc.name}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'name', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"Nom du document\"\n                      />\n                      <input\n                        type=\"url\"\n                        value={doc.url}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'url', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"https://...\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemoveDocument(field.id, index)}\n                        className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-100\"\n                      >\n                        Retirer\n                      </button>\n                    </div>\n                  ))}\n                </div>\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </div>\n            ))}\n\n          <datalist id=\"inspiration-labs\">\n            {labSuggestions.map((suggestion) => (\n              <option key={suggestion} value={suggestion} />\n            ))}\n          </datalist>\n\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-end\">\n            <button\n              type=\"button\"\n              onClick={onCancel}\n              className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n            >\n              Annuler\n            </button>\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n            >\n              <Save className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Enregistrer le projet\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/RichTextEditor.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport { sanitizeRichText } from '../utils/richText.js';\n\nconst BUTTON_BASE_CLASSES =\n  'inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1';\n\nconst commandIsAvailable = () => typeof document !== 'undefined' && typeof document.execCommand === 'function';\n\nconst normalizeValue = (value) => (typeof value === 'string' ? value : '');\n\nexport const RichTextEditor = ({\n  id,\n  value,\n  onChange,\n  placeholder = 'Commencez votre saisie (texte riche et liens autorisés)',\n  compact = false,\n  ariaLabel\n}) => {\n  const editorRef = useRef(null);\n  const linkTextInputRef = useRef(null);\n  const selectionRangeRef = useRef(null);\n  const selectedTextRef = useRef('');\n  const [htmlValue, setHtmlValue] = useState(() => normalizeValue(value));\n  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);\n  const [linkText, setLinkText] = useState('');\n  const [linkUrl, setLinkUrl] = useState('https://');\n  const [linkError, setLinkError] = useState('');\n\n  useEffect(() => {\n    setHtmlValue(normalizeValue(value));\n  }, [value]);\n\n  useEffect(() => {\n    const normalized = normalizeValue(value);\n    setHtmlValue(normalized);\n\n    if (!editorRef.current) {\n      return;\n    }\n\n    const isFocused =\n      typeof document !== 'undefined' && document.activeElement === editorRef.current;\n\n    if (isFocused) {\n      return;\n    }\n\n    if (editorRef.current.innerHTML !== normalized) {\n      editorRef.current.innerHTML = normalized || '';\n    }\n  }, [value]);\n\n  useEffect(() => {\n    if (isLinkModalOpen && linkTextInputRef.current) {\n      linkTextInputRef.current.focus();\n    }\n  }, [isLinkModalOpen]);\n\n  const emitChange = useCallback(\n    (nextValue) => {\n      const sanitized = sanitizeRichText(nextValue || '');\n      setHtmlValue(sanitized);\n      onChange?.(sanitized);\n      return sanitized;\n    },\n    [onChange]\n  );\n\n  const handleInput = useCallback(() => {\n    emitChange(editorRef.current?.innerHTML || '');\n  }, [emitChange]);\n\n  const handleBlur = useCallback(() => {\n    const sanitized = emitChange(editorRef.current?.innerHTML || '');\n\n    if (editorRef.current && editorRef.current.innerHTML !== sanitized) {\n      editorRef.current.innerHTML = sanitized || '';\n    }\n  }, [emitChange]);\n\n  const handlePaste = useCallback(\n    (event) => {\n      if (!event?.clipboardData) {\n        return;\n      }\n\n      const text = event.clipboardData.getData('text/plain');\n      if (commandIsAvailable()) {\n        event.preventDefault();\n        document.execCommand('insertText', false, text);\n        handleInput();\n      }\n    },\n    [handleInput]\n  );\n\n  const applyCommand = useCallback(\n    (command, argument = null) => {\n      if (!commandIsAvailable()) {\n        return;\n      }\n\n      document.execCommand(command, false, argument);\n      handleInput();\n    },\n    [handleInput]\n  );\n\n  const handleAddLink = useCallback(() => {\n    if (typeof window === 'undefined' || !commandIsAvailable()) {\n      return;\n    }\n\n    const selection = typeof window.getSelection === 'function' ? window.getSelection() : null;\n    const selectedText = selection?.toString() || '';\n    selectionRangeRef.current =\n      selection && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;\n    selectedTextRef.current = selectedText;\n    setLinkText(selectedText);\n    setLinkUrl('https://');\n    setLinkError('');\n    setIsLinkModalOpen(true);\n  }, [applyCommand]);\n\n  const handleCloseLinkModal = useCallback(() => {\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, []);\n\n  const handleConfirmLink = useCallback((event) => {\n    event?.preventDefault?.();\n\n    const trimmedUrl = linkUrl.trim();\n    if (!/^https?:\\/\\//i.test(trimmedUrl)) {\n      setLinkError('Veuillez saisir une URL valide (https://...)');\n      return;\n    }\n\n    const normalizedDisplayText = linkText.trim() || selectedTextRef.current || trimmedUrl;\n    const linkHtml = `<a href=\"${trimmedUrl}\" target=\"_blank\" rel=\"noopener noreferrer\">${normalizedDisplayText}</a>`;\n\n    if (typeof window !== 'undefined' && selectionRangeRef.current && typeof window.getSelection === 'function') {\n      const selection = window.getSelection();\n      if (selection) {\n        selection.removeAllRanges();\n        selection.addRange(selectionRangeRef.current);\n      }\n    }\n\n    applyCommand('insertHTML', linkHtml);\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, [applyCommand, linkText, linkUrl]);\n\n  const minHeight = useMemo(() => (compact ? 120 : 180), [compact]);\n  const showPlaceholder = !htmlValue;\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex flex-wrap gap-2\">\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('bold')}>\n          <span className=\"font-semibold\">G</span>\n          <span className=\"sr-only\">Mettre en gras</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('italic')}>\n          <span className=\"italic\">I</span>\n          <span className=\"sr-only\">Italique</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('underline')}>\n          <span className=\"underline\">U</span>\n          <span className=\"sr-only\">Souligner</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('insertUnorderedList')}>\n          <span aria-hidden=\"true\">• • •</span>\n          <span className=\"sr-only\">Liste à puces</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={handleAddLink}>\n          <span aria-hidden=\"true\">🔗</span>\n          <span className=\"sr-only\">Insérer un lien</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('removeFormat')}>\n          <span aria-hidden=\"true\">⟲</span>\n          <span className=\"sr-only\">Nettoyer la mise en forme</span>\n        </button>\n      </div>\n      <div className=\"relative\">\n        {showPlaceholder && (\n          <div\n            className=\"pointer-events-none absolute inset-0 px-4 py-3 text-sm text-gray-400 select-none leading-relaxed\"\n            style={{ pointerEvents: 'none', userSelect: 'none' }}\n          >\n            {placeholder}\n          </div>\n        )}\n        <div\n          id={id}\n          ref={editorRef}\n          className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[120px] prose prose-sm max-w-none hv-focus-ring\"\n          style={{ minHeight }}\n          contentEditable={true}\n          suppressContentEditableWarning\n          onInput={handleInput}\n          onBlur={handleBlur}\n          onPaste={handlePaste}\n          onKeyUp={handleInput}\n          onCompositionEnd={handleInput}\n          tabIndex={0}\n          role=\"textbox\"\n          aria-label={ariaLabel || placeholder}\n        />\n      </div>\n      {isLinkModalOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={handleCloseLinkModal} aria-hidden=\"true\" />\n          <form\n            className=\"relative w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl\"\n            onSubmit={handleConfirmLink}\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby={`${id}-link-modal-title`}\n          >\n            <h3 id={`${id}-link-modal-title`} className=\"text-lg font-semibold text-gray-900\">\n              Insérer un lien\n            </h3>\n            <p className=\"mt-1 text-sm text-gray-500\">\n              Renseignez le texte à afficher et l’URL complète (https://).\n            </p>\n            <div className=\"mt-4 space-y-4\">\n              <div>\n                <label htmlFor={`${id}-link-text`} className=\"block text-sm font-medium text-gray-700\">\n                  Texte du lien\n                </label>\n                <input\n                  id={`${id}-link-text`}\n                  ref={linkTextInputRef}\n                  type=\"text\"\n                  value={linkText}\n                  onChange={(event) => setLinkText(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"Ex : Découvrir le document\"\n                />\n              </div>\n              <div>\n                <label htmlFor={`${id}-link-url`} className=\"block text-sm font-medium text-gray-700\">\n                  URL\n                </label>\n                <input\n                  id={`${id}-link-url`}\n                  type=\"url\"\n                  value={linkUrl}\n                  onChange={(event) => setLinkUrl(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"https://exemple.com\"\n                />\n                {linkError && <p className=\"mt-2 text-sm text-red-600\">{linkError}</p>}\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-wrap justify-end gap-3\">\n              <button\n                type=\"button\"\n                onClick={handleCloseLinkModal}\n                className=\"rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700\"\n              >\n                Insérer le lien\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/SynthesisReport.jsx": "import React, { useState, useCallback, useEffect, useRef, useMemo } from '../react.js';\nimport {\n  FileText,\n  Users,\n  AlertTriangle,\n  Send,\n  Sparkles,\n  CheckCircle,\n  Save,\n  Mail,\n  Info,\n  Edit\n} from './icons.js';\nimport { formatAnswer } from '../utils/questions.js';\nimport { computeRankingRecommendations, normalizeRankingConfig } from '../utils/ranking.js';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { ProjectShowcase } from './ProjectShowcase.jsx';\nimport { extractProjectName } from '../utils/projects.js';\nimport {\n  buildProjectExport,\n  downloadProjectJson,\n  getTeamPriority,\n  sanitizeFileName\n} from '../utils/projectExport.js';\n\nconst escapeHtml = (value) => {\n  if (value === null || value === undefined) {\n    return '';\n  }\n\n  return String(value)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n};\n\nconst formatNumber = (value, options = {}) => {\n  return Number(value).toLocaleString('fr-FR', options);\n};\n\nconst formatCriterionScore = (value) => {\n  const numeric = Number(value);\n  if (!Number.isFinite(numeric)) {\n    return '—';\n  }\n\n  if (numeric >= 3) return '+++';\n  if (numeric >= 2) return '++';\n  if (numeric >= 1) return '+';\n  return '—';\n};\n\nconst COMPLIANCE_COMMENTS_KEY = '__compliance_team_comments__';\n\nconst formatWeeksValue = (weeks) => {\n  if (weeks === undefined || weeks === null) {\n    return '-';\n  }\n\n  const rounded = Math.round(weeks * 10) / 10;\n  const hasDecimal = Math.abs(rounded - Math.round(rounded)) > 0.0001;\n\n  return `${formatNumber(rounded, {\n    minimumFractionDigits: hasDecimal ? 1 : 0,\n    maximumFractionDigits: hasDecimal ? 1 : 0\n  })} sem.`;\n};\n\nconst formatDaysValue = (days) => {\n  if (days === undefined || days === null) {\n    return '-';\n  }\n\n  return `${formatNumber(Math.round(days))} j.`;\n};\n\nconst formatRiskScore = (score) => {\n  if (typeof score !== 'number' || Number.isNaN(score)) {\n    return null;\n  }\n\n  const sanitized = Math.max(0, score);\n  const hasDecimals = Math.abs(sanitized - Math.round(sanitized)) > 0.0001;\n\n  return formatNumber(sanitized, {\n    minimumFractionDigits: hasDecimals ? 1 : 0,\n    maximumFractionDigits: hasDecimals ? 2 : 0\n  });\n};\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst formatOverviewValue = (question, answer) => {\n  const formatted = formatAnswer(question, answer);\n\n  if (typeof formatted === 'string') {\n    if (formatted.trim().length > 0) {\n      return formatted;\n    }\n  } else if (formatted) {\n    return formatted;\n  }\n\n  return question?.required ? 'Information à compléter' : '';\n};\n\nconst formatRiskTimingViolation = (violation) => {\n  if (!violation) {\n    return '';\n  }\n\n  const actualParts = [];\n  if (typeof violation.actualWeeks === 'number') {\n    actualParts.push(formatWeeksValue(violation.actualWeeks));\n  }\n  if (typeof violation.actualDays === 'number') {\n    actualParts.push(formatDaysValue(violation.actualDays));\n  }\n\n  const requiredParts = [];\n  if (typeof violation.requiredWeeks === 'number') {\n    requiredParts.push(`${formatNumber(violation.requiredWeeks)} sem.`);\n  }\n  if (typeof violation.requiredDays === 'number') {\n    requiredParts.push(`${formatNumber(violation.requiredDays)} j.`);\n  }\n\n  if (actualParts.length === 0 && requiredParts.length === 0) {\n    return '';\n  }\n\n  const actualText = actualParts.length > 0 ? actualParts.join(' / ') : 'non calculé';\n\n  if (requiredParts.length === 0) {\n    return `Délai constaté : ${actualText}.`;\n  }\n\n  return `Délai constaté : ${actualText} – minimum requis : ${requiredParts.join(' / ')}`;\n};\n\nconst formatTimingRequirementSummary = (questionBank, constraint) => {\n  if (!constraint || typeof constraint !== 'object') {\n    return '';\n  }\n\n  const startId = constraint.startQuestion;\n  const endId = constraint.endQuestion;\n  const minimumWeeks =\n    typeof constraint.minimumWeeks === 'number' ? constraint.minimumWeeks : undefined;\n  const minimumDays =\n    typeof constraint.minimumDays === 'number' ? constraint.minimumDays : undefined;\n\n  const startLabel = resolveQuestionLabel(questionBank, startId);\n  const endLabel = resolveQuestionLabel(questionBank, endId);\n\n  const startDisplay = startLabel || startId || '';\n  const endDisplay = endLabel || endId || '';\n\n  const requirementParts = [];\n  if (minimumWeeks !== undefined) {\n    requirementParts.push(`${formatNumber(minimumWeeks)} sem.`);\n  }\n  if (minimumDays !== undefined) {\n    requirementParts.push(`${formatNumber(minimumDays)} j.`);\n  }\n\n  const hasRequirement = requirementParts.length > 0;\n  const hasStart = startDisplay.length > 0;\n  const hasEnd = endDisplay.length > 0;\n\n  if (!hasRequirement && !hasStart && !hasEnd) {\n    return '';\n  }\n\n  if (hasRequirement && hasStart && hasEnd) {\n    return `Respecter un délai minimal de ${requirementParts.join(' / ')} entre « ${startDisplay} » et « ${endDisplay} ».`;\n  }\n\n  if (hasRequirement && hasStart && !hasEnd) {\n    return `Respecter un délai minimal de ${requirementParts.join(' / ')} après « ${startDisplay} ».`;\n  }\n\n  if (hasRequirement && !hasStart && hasEnd) {\n    return `Respecter un délai minimal de ${requirementParts.join(' / ')} avant « ${endDisplay} ».`;\n  }\n\n  if (hasRequirement) {\n    return `Respecter un délai minimal de ${requirementParts.join(' / ')} avant la prochaine étape.`;\n  }\n\n  if (hasStart && hasEnd) {\n    return `Surveiller le délai entre « ${startDisplay} » et « ${endDisplay} ».`;\n  }\n\n  if (hasStart || hasEnd) {\n    return `Surveiller la date « ${hasStart ? startDisplay : endDisplay} ».`;\n  }\n\n  return '';\n};\n\nconst formatVigilanceStatusMessage = (alert) => {\n  if (!alert || typeof alert !== 'object') {\n    return '';\n  }\n\n  if (alert.status === 'unknown') {\n    return \"Dates manquantes : renseignez-les pour vérifier ce délai.\";\n  }\n\n  if (alert.status === 'satisfied' && alert.diff) {\n    const parts = [];\n    if (typeof alert.diff.diffInWeeks === 'number') {\n      parts.push(formatWeeksValue(alert.diff.diffInWeeks));\n    }\n    if (typeof alert.diff.diffInDays === 'number') {\n      parts.push(formatDaysValue(alert.diff.diffInDays));\n    }\n\n    if (parts.length === 0) {\n      return 'Délai déclaré conforme. Anticiper pour éviter l’alerte.';\n    }\n\n    return `Délai constaté : ${parts.join(' / ')} — anticiper pour éviter l’alerte.`;\n  }\n\n  return '';\n};\n\nconst resolveQuestionLabel = (questionBank, questionId) => {\n  if (!questionId) {\n    return '';\n  }\n\n  const collection = Array.isArray(questionBank) ? questionBank : [];\n  const match = collection.find(question => question?.id === questionId);\n\n  return match?.question || questionId;\n};\n\nconst normalizeTeamQuestionForDisplay = (entry) => {\n  if (typeof entry === 'string') {\n    return { text: entry, timingViolation: null };\n  }\n\n  if (entry && typeof entry === 'object') {\n    return {\n      text: typeof entry.text === 'string' ? entry.text : '',\n      timingViolation:\n        entry.timingViolation && typeof entry.timingViolation === 'object'\n          ? entry.timingViolation\n          : null\n    };\n  }\n\n  return { text: '', timingViolation: null };\n};\n\nconst formatTeamQuestionTimingMessage = (questionBank, violation) => {\n  if (!violation) {\n    return '';\n  }\n\n  const base = formatRiskTimingViolation(violation);\n  if (!base) {\n    return '';\n  }\n\n  const startLabel = resolveQuestionLabel(questionBank, violation.startQuestion);\n  const endLabel = resolveQuestionLabel(questionBank, violation.endQuestion);\n\n  if (startLabel || endLabel) {\n    const safeStart = startLabel || violation.startQuestion || 'début';\n    const safeEnd = endLabel || violation.endQuestion || 'fin';\n    return `Délai entre « ${safeStart} » et « ${safeEnd} » — ${base}`;\n  }\n\n  return base;\n};\n\nconst formatAsHtmlText = (value) => {\n  return escapeHtml(value).replace(/\\r?\\n/g, '<br />');\n};\n\nconst buildEmailHtml = ({\n  projectName,\n  questions,\n  answers,\n  analysis,\n  relevantTeams\n}) => {\n  const title = projectName || 'Projet sans nom';\n  const answeredQuestions = questions.filter(question => {\n    const value = answers[question.id];\n    if (value === null || value === undefined) {\n      return false;\n    }\n\n    if (Array.isArray(value)) {\n      return value.length > 0;\n    }\n\n    if (typeof value === 'string') {\n      return value.trim().length > 0;\n    }\n\n    return true;\n  });\n\n  const risks = Array.isArray(analysis?.risks) ? analysis.risks : [];\n  const vigilanceAlerts = Array.isArray(analysis?.timeline?.vigilance)\n    ? analysis.timeline.vigilance.filter(alert => alert && alert.status !== 'breach')\n    : [];\n\n  const overviewSection = answeredQuestions.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Vue d'ensemble du projet\n          </h2>\n          <table style=\"width:100%; border-collapse:collapse; background-color:#f9fafb; border-radius:12px; overflow:hidden;\">\n            <tbody>\n              ${answeredQuestions\n                .map(question => {\n                  const questionLabel = escapeHtml(question.question);\n                  const formattedAnswer = formatAsHtmlText(formatAnswer(question, answers[question.id]));\n                  return `\n                    <tr>\n                      <td style=\"width:40%; padding:12px 16px; font-size:13px; font-weight:700; color:#001f3f; border-bottom:1px solid #e5e7eb;\">\n                        ${questionLabel}\n                      </td>\n                      <td style=\"padding:12px 16px; font-size:14px; font-weight:600; color:#1f2937; border-bottom:1px solid #e5e7eb;\">\n                        ${formattedAnswer || '<span style=\"color:#9ca3af;\">Non renseigné</span>'}\n                      </td>\n                    </tr>\n                  `;\n                })\n                .join('')}\n            </tbody>\n          </table>\n        </div>\n      `\n    : '';\n\n  const teamSection = relevantTeams.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Équipes à mobiliser\n          </h2>\n          ${relevantTeams\n            .map(team => {\n              const teamPriority = getTeamPriority(analysis, team.id);\n              const teamQuestions = analysis.questions?.[team.id] || [];\n              const contact = team.contact ? `<span style=\"color:#4b5563;\"> | Contact : ${escapeHtml(team.contact)}</span>` : '';\n\n              const formattedTeamQuestions = Array.isArray(teamQuestions)\n                ? teamQuestions\n                    .map(normalizeTeamQuestionForDisplay)\n                    .filter(question => (question.text || '').trim().length > 0)\n                : [];\n\n              const questionsHtml = formattedTeamQuestions.length\n                ? `\n                    <div style=\"margin-top:8px;\">\n                      <span style=\"font-size:13px; color:#4b5563; font-weight:600;\">Points à préparer :</span>\n                      <ul style=\"margin:8px 0 0; padding-left:18px; list-style-type:disc; color:#4b5563; font-size:13px;\">\n                        ${formattedTeamQuestions\n                          .map(question => {\n                            const timingMessage = formatTeamQuestionTimingMessage(questions, question.timingViolation);\n                            const timingHtml = timingMessage\n                              ? `<div style=\"margin-top:4px; font-size:12px; color:#b45309;\">⚠️ ${escapeHtml(timingMessage)}</div>`\n                              : '';\n                            return `<li>${escapeHtml(question.text)}${timingHtml}</li>`;\n                          })\n                          .join('')}\n                      </ul>\n                    </div>\n                  `\n                : '';\n\n              return `\n                <div style=\"border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#f9fafb;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#1f2937;\">\n                    ${escapeHtml(team.name)} — Priorité : ${escapeHtml(teamPriority)}${contact}\n                  </div>\n                  ${questionsHtml}\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  const riskSection = risks.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Risques identifiés et actions\n          </h2>\n          ${risks\n            .map(risk => {\n              const timingInfo = formatRiskTimingViolation(risk.timingViolation);\n\n              return `\n                <div style=\"border:1px solid #fee2e2; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#fef2f2;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#b91c1c;\">\n                    ${escapeHtml(risk.level)} — Priorité : ${escapeHtml(risk.priority)}\n                  </div>\n                  <p style=\"margin:8px 0 4px; font-size:14px; color:#4b5563;\">\n                    <strong>Description :</strong> ${formatAsHtmlText(risk.description)}\n                  </p>\n                  ${timingInfo\n                    ? `<p style=\"margin:0 0 6px; font-size:13px; color:#b91c1c;\">${escapeHtml(timingInfo)}</p>`\n                    : ''}\n                  <p style=\"margin:0; font-size:14px; color:#4b5563;\">\n                    <strong>Mitigation :</strong> ${formatAsHtmlText(risk.mitigation)}\n                  </p>\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  const vigilanceSection = vigilanceAlerts.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Points de vigilance\n          </h2>\n          ${vigilanceAlerts\n            .map(alert => {\n              const requirementSummary = formatTimingRequirementSummary(questions, alert.timingConstraint);\n              const statusMessage = formatVigilanceStatusMessage(alert);\n              const title = alert.riskDescription && alert.riskDescription.trim().length > 0\n                ? alert.riskDescription\n                : alert.ruleName;\n\n              return `\n                <div style=\"border:1px solid #bbf7d0; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#ecfdf5;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#047857;\">\n                    ${escapeHtml(alert.ruleName)}${alert.priority ? ` — Priorité : ${escapeHtml(alert.priority)}` : ''}\n                  </div>\n                  <p style=\"margin:8px 0 4px; font-size:14px; color:#064e3b; font-weight:600;\">\n                    ${formatAsHtmlText(title)}\n                  </p>\n                  ${requirementSummary\n                    ? `<p style=\"margin:0 0 6px; font-size:13px; color:#047857;\">${escapeHtml(requirementSummary)}</p>`\n                    : ''}\n                  ${statusMessage\n                    ? `<p style=\"margin:0; font-size:12px; color:#1f2937;\">${escapeHtml(statusMessage)}</p>`\n                    : ''}\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  return `<!DOCTYPE html>\n    <html lang=\"fr\">\n      <head>\n        <meta charset=\"UTF-8\" />\n        <title>${escapeHtml(title)}</title>\n      </head>\n      <body style=\"margin:0; padding:0; background-color:#f3f4f6; font-family:'Segoe UI', Arial, sans-serif; color:#1f2937;\">\n        <div style=\"max-width:720px; margin:0 auto; padding:32px 24px;\">\n          <div style=\"background-color:#ffffff; border-radius:20px; padding:32px; box-shadow:0 10px 30px rgba(15, 23, 42, 0.08); border:1px solid #e5e7eb;\">\n            <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;\">\n              <div>\n                <h1 style=\"font-size:24px; color:#111827; margin:0 0 6px;\">Synthèse</h1>\n                <p style=\"margin:0; color:#4b5563; font-size:14px;\">${escapeHtml(title)}</p>\n              </div>\n              <div style=\"padding:10px 16px; background-color:#eff6ff; color:#1d4ed8; border-radius:9999px; font-weight:600; font-size:14px;\">\n                Complexité : ${escapeHtml(analysis.complexity)}\n              </div>\n            </div>\n            <p style=\"margin:0 0 20px; font-size:14px; color:#1f2937;\">\n              Bonjour équipe Compliance, un nouveau projet a été soumis pour revue. Vous trouverez ci-dessous les informations principales.\n            </p>\n            ${overviewSection}\n            ${teamSection}\n            ${riskSection}\n            ${vigilanceSection}\n          </div>\n        </div>\n      </body>\n    </html>`;\n};\n\nconst decodeHtmlEntities = (text) =>\n  text\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\");\n\nconst buildPlainTextEmail = (html) => {\n  if (!html) {\n    return '';\n  }\n\n  let text = html\n    .replace(/<!DOCTYPE[^>]*>/gi, '')\n    .replace(/<head[\\s\\S]*?<\\/head>/gi, '')\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, '')\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, '');\n\n  text = text\n    .replace(/<br\\s*\\/?\\s*>/gi, '\\n')\n    .replace(/<\\/(?:p|div|section|article)\\s*>/gi, '\\n\\n')\n    .replace(/<\\/(?:h[1-6])\\s*>/gi, '\\n')\n    .replace(/<\\/(?:ul|ol)\\s*>/gi, '\\n')\n    .replace(/<li\\s*>/gi, '• ')\n    .replace(/<\\/(?:tr)\\s*>/gi, '\\n')\n    .replace(/<\\/(?:td|th)\\s*>/gi, '\\t');\n\n  text = text.replace(/<[^>]+>/g, '');\n  text = decodeHtmlEntities(text);\n\n  text = text\n    .replace(/\\r/g, '')\n    .replace(/\\t+/g, ' ')\n    .replace(/[ \\t]+\\n/g, '\\n')\n    .replace(/\\n[ \\t]+/g, '\\n')\n    .replace(/\\n{3,}/g, '\\n\\n');\n\n  return text.trim();\n};\n\nconst buildMailtoLink = ({ projectName, relevantTeams, body }) => {\n  const recipients = relevantTeams\n    .map(team => (team.contact || '').trim())\n    .filter(contact => contact.length > 0);\n\n  const toField = recipients.join(',');\n  const subject = projectName || 'Projet compliance';\n  const normalizedBody = (body || '').replace(/\\r?\\n/g, '\\r\\n');\n  const encodedParams = [];\n\n  if (subject) {\n    encodedParams.push(`subject=${encodeURIComponent(subject)}`);\n  }\n\n  if (normalizedBody) {\n    encodedParams.push(`body=${encodeURIComponent(normalizedBody)}`);\n  }\n\n  const prefix = toField ? `mailto:${toField}` : 'mailto:';\n  const query = encodedParams.join('&');\n\n  return query ? `${prefix}?${query}` : prefix;\n};\n\nexport const SynthesisReport = ({\n  answers,\n  analysis,\n  teams,\n  questions,\n  projectStatus,\n  projectId,\n  projectName: providedProjectName,\n  onOpenProjectShowcase,\n  isProjectEditable = true,\n  onRestart,\n  onBack,\n  onUpdateAnswers,\n  onSubmitProject,\n  onNavigateToQuestion,\n  onSaveDraft,\n  saveFeedback,\n  onDismissSaveFeedback,\n  isAdminMode = false,\n  tourContext = null,\n  hasIncompleteAnswers = false\n}) => {\n  const [isShowcaseFallbackOpen, setIsShowcaseFallbackOpen] = useState(false);\n  const showcaseFallbackRef = useRef(null);\n  const [attachmentReminder, setAttachmentReminder] = useState(null);\n  const reminderCloseButtonRef = useRef(null);\n  const complianceCommentFeedbackTimeoutRef = useRef(null);\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const stepToSelectorMap = {\n      'compliance-report': '[data-tour-id=\"synthesis-summary\"]',\n      'compliance-report-top': '[data-tour-id=\"synthesis-summary\"]',\n      'compliance-teams': '[data-tour-id=\"synthesis-teams\"]',\n      'compliance-risks': '[data-tour-id=\"synthesis-risks\"]'\n    };\n\n    const selector = stepToSelectorMap[tourContext.activeStep];\n    if (!selector) {\n      return;\n    }\n\n    const element = document.querySelector(selector);\n    if (element && typeof element.scrollIntoView === 'function') {\n      element.scrollIntoView({ behavior: 'smooth', block: 'start' });\n    }\n  }, [tourContext]);\n  const relevantTeams = teams.filter(team => (analysis?.teams || []).includes(team.id));\n  const hasSaveFeedback = Boolean(saveFeedback?.message);\n  const isSaveSuccess = saveFeedback?.status === 'success';\n  const complianceCommentValue =\n    typeof answers?.[COMPLIANCE_COMMENTS_KEY] === 'string' ? answers[COMPLIANCE_COMMENTS_KEY] : '';\n  const [complianceCommentDraft, setComplianceCommentDraft] = useState(complianceCommentValue);\n  const [complianceCommentFeedback, setComplianceCommentFeedback] = useState(null);\n  const hasComplianceComment = complianceCommentValue.trim().length > 0;\n  const isComplianceCommentDirty = complianceCommentDraft !== complianceCommentValue;\n  const canSaveComplianceComment = typeof onUpdateAnswers === 'function' && isComplianceCommentDirty;\n\n  const resolveTeamLabel = useCallback(\n    (teamId) => {\n      if (!teamId) {\n        return '';\n      }\n\n      const teamMatch = teams.find(team => team?.id === teamId);\n      return teamMatch?.name || teamId;\n    },\n    [teams]\n  );\n\n  const normalizedProjectStatus =\n    typeof projectStatus === 'string' ? projectStatus.toLowerCase() : null;\n  const statusLabelMap = {\n    draft: 'Brouillon',\n    submitted: 'Soumis'\n  };\n  const statusClassMap = {\n    draft: 'bg-yellow-100 text-yellow-800 border border-yellow-200',\n    submitted: 'bg-emerald-100 text-emerald-800 border border-emerald-200'\n  };\n  const projectStatusLabel = normalizedProjectStatus\n    ? statusLabelMap[normalizedProjectStatus] || projectStatus\n    : null;\n  const projectStatusClasses = normalizedProjectStatus\n    ? statusClassMap[normalizedProjectStatus] || 'bg-gray-100 text-gray-700 border border-gray-200'\n    : '';\n\n  const priorityColors = {\n    'A particulièrement anticiper': 'bg-red-100 text-red-800 border-red-300',\n    'A anticiper': 'bg-orange-100 text-orange-800 border-orange-300',\n    'A réaliser': 'bg-blue-100 text-blue-800 border-blue-300'\n  };\n\n  const riskColors = {\n    Élevé: 'bg-red-50 border-red-300 text-red-900',\n    Moyen: 'bg-orange-50 border-orange-300 text-orange-900',\n    Faible: 'bg-green-50 border-green-300 text-green-900'\n  };\n\n  const vigilanceStatusClasses = {\n    satisfied: 'bg-emerald-50 border-emerald-300 text-emerald-900',\n    unknown: 'bg-emerald-50 border-emerald-200 text-emerald-900',\n    breach: 'bg-red-50 border-red-300 text-red-900'\n  };\n\n  const complexityColors = {\n    Élevé: 'text-red-600',\n    Moyen: 'text-orange-600',\n    Faible: 'text-green-600'\n  };\n\n  const formattedRiskScore = formatRiskScore(analysis?.riskScore);\n\n  const rankingQuestions = useMemo(\n    () => (Array.isArray(questions) ? questions.filter(question => question?.type === 'ranking') : []),\n    [questions]\n  );\n\n  const rankingResults = useMemo(() => {\n    return rankingQuestions\n      .map(question => {\n        const config = normalizeRankingConfig(question.rankingConfig || {});\n        const answer = answers?.[question.id];\n        const recommendations = computeRankingRecommendations(answer, config, 3);\n        const formattedAnswer = formatAnswer(question, answer);\n        const prioritizedOrder = Array.isArray(answer?.prioritized)\n          ? answer.prioritized\n          : config.criteria.map(item => item.id);\n        const ignoredSet = new Set(Array.isArray(answer?.ignored) ? answer.ignored : []);\n        const orderedCriteria = prioritizedOrder\n          .map(id => config.criteria.find(criterion => criterion.id === id))\n          .filter(Boolean)\n          .filter(criterion => !ignoredSet.has(criterion.id));\n        const ignoredCriteria = config.criteria.filter(criterion => ignoredSet.has(criterion.id));\n\n        return {\n          question,\n          config,\n          recommendations,\n          formattedAnswer,\n          orderedCriteria,\n          ignoredCriteria\n        };\n      })\n      .filter(entry => entry.recommendations.length > 0 && entry.formattedAnswer);\n  }, [answers, rankingQuestions]);\n\n  const timelineDetails = analysis?.timeline?.details || [];\n  const vigilanceAlerts = (Array.isArray(analysis?.timeline?.vigilance)\n    ? analysis.timeline.vigilance\n    : [])\n    .filter(alert => alert && alert.status !== 'breach')\n    .map(alert => ({\n      ...alert,\n      requirementSummary: formatTimingRequirementSummary(questions, alert.timingConstraint),\n      statusMessage: formatVigilanceStatusMessage(alert)\n    }));\n\n  const extractedProjectName = extractProjectName(answers, questions);\n  const effectiveProjectName =\n    typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : extractedProjectName;\n\n  const scrollShowcaseIntoView = useCallback(() => {\n    const node = showcaseFallbackRef.current;\n\n    if (node) {\n      if (typeof node.scrollIntoView === 'function') {\n        node.scrollIntoView({ behavior: 'smooth', block: 'start' });\n        return;\n      }\n    }\n\n    if (typeof window !== 'undefined' && typeof window.scrollTo === 'function') {\n      window.scrollTo({ top: 0, behavior: 'smooth' });\n    }\n  }, [showcaseFallbackRef]);\n\n  useEffect(() => {\n    if (!isShowcaseFallbackOpen) {\n      return;\n    }\n\n    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\n      window.requestAnimationFrame(() => {\n        scrollShowcaseIntoView();\n      });\n    } else {\n      scrollShowcaseIntoView();\n    }\n  }, [isShowcaseFallbackOpen, scrollShowcaseIntoView]);\n\n  useEffect(() => {\n    if (!attachmentReminder) {\n      return;\n    }\n\n    if (\n      reminderCloseButtonRef.current\n      && typeof reminderCloseButtonRef.current.focus === 'function'\n    ) {\n      reminderCloseButtonRef.current.focus();\n    }\n  }, [attachmentReminder]);\n\n  useEffect(() => {\n    setComplianceCommentDraft(complianceCommentValue);\n  }, [complianceCommentValue]);\n\n  useEffect(() => {\n    return () => {\n      if (complianceCommentFeedbackTimeoutRef.current) {\n        clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const handleComplianceCommentSubmit = useCallback(\n    (event) => {\n      if (event && typeof event.preventDefault === 'function') {\n        event.preventDefault();\n      }\n\n      if (!canSaveComplianceComment) {\n        return;\n      }\n\n      const normalizedDraft =\n        typeof complianceCommentDraft === 'string' ? complianceCommentDraft.replace(/\\r\\n/g, '\\n') : '';\n      const trimmedDraft = normalizedDraft.trim();\n      const nextValue = trimmedDraft.length > 0 ? trimmedDraft : null;\n\n      onUpdateAnswers({\n        [COMPLIANCE_COMMENTS_KEY]: nextValue\n      });\n\n      setComplianceCommentDraft(trimmedDraft);\n\n      if (complianceCommentFeedbackTimeoutRef.current) {\n        clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n      }\n\n      setComplianceCommentFeedback(\n        nextValue\n          ? 'Commentaire enregistré. Enregistrez ensuite le projet et chargez-le dans le dossier « submitted-projects » pour le rendre visible au porteur de projet.'\n          : 'Commentaire effacé.'\n      );\n\n      complianceCommentFeedbackTimeoutRef.current = setTimeout(() => {\n        setComplianceCommentFeedback(null);\n      }, 4000);\n    },\n    [\n      canSaveComplianceComment,\n      complianceCommentDraft,\n      onUpdateAnswers\n    ]\n  );\n\n  const handleComplianceCommentChange = useCallback(\n    (event) => {\n      const nextValue = event?.target?.value ?? '';\n      setComplianceCommentDraft(nextValue);\n\n      if (complianceCommentFeedback) {\n        if (complianceCommentFeedbackTimeoutRef.current) {\n          clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n          complianceCommentFeedbackTimeoutRef.current = null;\n        }\n        setComplianceCommentFeedback(null);\n      }\n    },\n    [complianceCommentFeedback]\n  );\n\n  const handleOpenShowcase = useCallback(() => {\n    if (typeof onOpenProjectShowcase === 'function') {\n      onOpenProjectShowcase({\n        projectId,\n        projectName: effectiveProjectName,\n        status: projectStatus,\n        answers,\n        analysis,\n        relevantTeams,\n        questions,\n        timelineDetails\n      });\n      return;\n    }\n\n    setIsShowcaseFallbackOpen(true);\n\n    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\n      window.requestAnimationFrame(() => {\n        scrollShowcaseIntoView();\n      });\n    } else {\n      scrollShowcaseIntoView();\n    }\n  }, [\n    analysis,\n    answers,\n    effectiveProjectName,\n    onOpenProjectShowcase,\n    projectId,\n    projectStatus,\n    questions,\n    relevantTeams,\n    scrollShowcaseIntoView,\n    timelineDetails\n  ]);\n\n  const handleCloseShowcase = useCallback(() => {\n    setIsShowcaseFallbackOpen(false);\n  }, []);\n\n  const handleDismissAttachmentReminder = useCallback(() => {\n    setAttachmentReminder(null);\n  }, []);\n\n  const handleSaveProject = useCallback(() => {\n    if (!onSubmitProject) {\n      return;\n    }\n\n    onSubmitProject({\n      projectName: effectiveProjectName,\n      answers,\n      analysis,\n      relevantTeams,\n      timelineDetails\n    });\n  }, [analysis, answers, effectiveProjectName, onSubmitProject, relevantTeams, timelineDetails]);\n\n  const handleDownloadProject = useCallback(() => {\n    if (!onSaveDraft) {\n      return;\n    }\n\n    onSaveDraft({\n      projectName: effectiveProjectName,\n      answers,\n      analysis,\n      questions,\n      relevantTeams,\n      timelineDetails,\n      lastQuestionIndex: questions.length > 0 ? questions.length - 1 : 0\n    });\n  }, [analysis, answers, effectiveProjectName, onSaveDraft, questions, relevantTeams, timelineDetails]);\n\n  const handleSubmitByEmail = useCallback(async () => {\n    const emailHtml = buildEmailHtml({\n      projectName: effectiveProjectName,\n      questions,\n      answers,\n      analysis,\n      relevantTeams\n    });\n    const emailText = buildPlainTextEmail(emailHtml);\n    const projectExport = buildProjectExport({\n      projectName: effectiveProjectName,\n      answers\n    });\n\n    let projectJson = '';\n    try {\n      projectJson = JSON.stringify(projectExport, null, 2);\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[SynthesisReport] Impossible de sérialiser le projet :', error);\n      }\n      projectJson = JSON.stringify(\n        {\n          version: 1,\n          project: {\n            name: projectExport.project.name,\n            answers: {}\n          }\n        },\n        null,\n        2\n      );\n    }\n\n    const fileNameBase = sanitizeFileName(effectiveProjectName || 'Projet compliance');\n    const fileName = `${fileNameBase}.json`;\n    const subject = effectiveProjectName || 'Projet compliance';\n\n    if (typeof navigator !== 'undefined' && typeof navigator.share === 'function' && typeof File === 'function') {\n      try {\n        const projectFile = new File([projectJson], fileName, {\n          type: 'application/json'\n        });\n        const canShare =\n          typeof navigator.canShare === 'function'\n            ? navigator.canShare({ files: [projectFile] })\n            : true;\n\n        if (canShare) {\n          await navigator.share({\n            title: subject,\n            text: `${emailText}\\n\\nFichier du projet : ${fileName}`,\n            files: [projectFile]\n          });\n          return;\n        }\n      } catch (error) {\n        if (error && error.name === 'AbortError') {\n          return;\n        }\n\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[SynthesisReport] Partage du projet impossible :', error);\n        }\n      }\n    }\n\n    downloadProjectJson(projectJson, { projectName: effectiveProjectName });\n    setAttachmentReminder({ fileName });\n\n    const fallbackBody = `${emailText}\\n\\nFichier du projet : ${fileName}\\nLe fichier JSON a été téléchargé automatiquement ; merci de l'ajouter en pièce jointe avant envoi.`;\n    const mailtoLink = buildMailtoLink({ projectName: effectiveProjectName, relevantTeams, body: fallbackBody });\n    if (typeof window !== 'undefined') {\n      window.location.href = mailtoLink;\n    }\n  }, [\n    analysis,\n    answers,\n    effectiveProjectName,\n    questions,\n    relevantTeams,\n    timelineDetails,\n    setAttachmentReminder\n  ]);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 px-4 py-6 sm:px-8 sm:py-10 hv-background\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div\n          className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6 hv-surface\"\n          role=\"region\"\n          aria-label=\"Synthèse du projet\"\n          data-tour-id=\"synthesis-summary\"\n        >\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6\">\n            <div className=\"flex flex-col gap-2\">\n              <h1 className=\"text-3xl font-bold text-gray-800 sm:text-4xl\">Synthèse</h1>\n              {projectStatusLabel && (\n                <span\n                  className={`inline-flex items-center self-start rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide ${projectStatusClasses}`}\n                >\n                  Statut : {projectStatusLabel}\n                </span>\n              )}\n              {!isProjectEditable && (\n                <p className=\"text-sm text-gray-500\">\n                  Ce projet n'est pas en mode brouillon. Les modifications sont désactivées dans cette vue.\n                </p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 w-full lg:w-auto\">\n              {onBack && (\n                <button\n                  type=\"button\"\n                  onClick={onBack}\n                  className=\"px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg font-medium text-gray-700 transition-all hv-button hv-focus-ring w-full sm:w-auto justify-center text-sm sm:text-base\"\n                >\n                  Retour au questionnaire\n                </button>\n              )}\n              {onSaveDraft && (\n                <button\n                  type=\"button\"\n                  onClick={handleDownloadProject}\n                  className=\"px-4 py-2 bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-focus-ring w-full sm:w-auto text-sm sm:text-base\"\n                  data-tour-id=\"synthesis-save\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Sauvegarder le projet\n                </button>\n              )}\n              <button\n                type=\"button\"\n                onClick={handleSubmitByEmail}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"synthesis-submit\"\n              >\n                <Send className=\"w-4 h-4 mr-2\" />\n                Soumettre par e-mail\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleOpenShowcase}\n                className=\"px-4 py-2 bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-focus-ring w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"synthesis-showcase\"\n              >\n                <Sparkles className=\"w-4 h-4 mr-2\" />\n                Vitrine du projet\n              </button>\n            </div>\n          </div>\n\n          {hasSaveFeedback && (\n            <div className=\"mb-6\" role=\"status\" aria-live=\"polite\">\n              <div\n                className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${\n                  isSaveSuccess\n                    ? 'border-emerald-200 bg-emerald-50 text-emerald-700'\n                    : 'border-red-200 bg-red-50 text-red-700'\n                }`}\n              >\n                {isSaveSuccess ? (\n                  <CheckCircle className=\"mt-0.5 h-5 w-5\" />\n                ) : (\n                  <AlertTriangle className=\"mt-0.5 h-5 w-5\" />\n                )}\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\">{saveFeedback.message}</p>\n                </div>\n                {typeof onDismissSaveFeedback === 'function' && (\n                  <button\n                    type=\"button\"\n                    onClick={onDismissSaveFeedback}\n                    className=\"text-xs font-semibold uppercase tracking-wide text-current hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-current rounded\"\n                  >\n                    Fermer\n                  </button>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Vue d'ensemble */}\n          <section className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 sm:p-6 mb-8 border border-blue-200 hv-surface\" aria-labelledby=\"overview-heading\">\n            <h2 id=\"overview-heading\" className=\"text-xl font-bold text-gray-800 mb-4 flex items-center\">\n              <FileText className=\"w-6 h-6 mr-2 text-blue-600\" />\n              Vue d'ensemble du projet\n            </h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {questions.map(q => {\n                const answerValue = answers[q.id];\n                const shouldRenderCard = isAnswerProvided(answerValue) || q.required;\n\n                if (!shouldRenderCard) {\n                  return null;\n                }\n\n                const displayValue = formatOverviewValue(q, answerValue);\n\n                return (\n                  <div key={q.id} className=\"bg-white rounded-lg p-4 border border-gray-200 hv-surface\">\n                    <div className=\"flex items-start justify-between gap-3 mb-1\">\n                      <p className=\"text-sm text-gray-600\">{q.question}</p>\n                      {typeof onNavigateToQuestion === 'function' && isProjectEditable && (\n                        <button\n                          type=\"button\"\n                          onClick={() => onNavigateToQuestion(q.id)}\n                          className=\"flex items-center justify-center w-8 h-8 rounded-full border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 transition-colors hv-button hv-focus-ring\"\n                          aria-label={`Modifier la réponse pour « ${q.question} »`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </button>\n                      )}\n                    </div>\n                    <p className=\"font-semibold text-gray-900 whitespace-pre-line\">\n                      {renderTextWithLinks(displayValue || 'Information à compléter')}\n                    </p>\n                  </div>\n                );\n              })}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between bg-white rounded-lg p-4 border border-gray-200 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <span className=\"font-medium text-gray-700\">Niveau de complexité compliance :</span>\n              <span className={`text-xl font-bold ${complexityColors[analysis.complexity] || 'text-blue-600'}`}>\n                {analysis.complexity}\n              </span>\n            </div>\n            {analysis?.complexityRule?.description && (\n              <p className=\"mt-3 bg-white border border-gray-200 rounded-lg p-3 text-sm text-gray-600 hv-surface\">\n                {analysis.complexityRule.description}\n              </p>\n            )}\n            {formattedRiskScore && (\n              <p className=\"mt-3 text-sm text-gray-500\">\n                Score de risque total : {formattedRiskScore}\n              </p>\n            )}\n          </section>\n\n\n          {/* Équipes à solliciter */}\n          <section className=\"mb-8\" aria-labelledby=\"teams-heading\" data-tour-id=\"synthesis-teams\">\n            <h2 id=\"teams-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n              <Users className=\"w-6 h-6 mr-2 text-blue-600\" />\n              Équipes à solliciter ({relevantTeams.length})\n            </h2>\n            {hasIncompleteAnswers && (\n              <div className=\"mb-4 flex items-start gap-3 rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-sm text-yellow-800\">\n                <Info className=\"mt-0.5 h-5 w-5\" />\n                <p>En attente de l’ensemble des informations sur le projet pour une évaluation complète.</p>\n              </div>\n            )}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {relevantTeams.map(team => {\n                const teamPriority = getTeamPriority(analysis, team.id);\n                const teamQuestions = analysis.questions?.[team.id];\n                const formattedTeamQuestions = Array.isArray(teamQuestions)\n                  ? teamQuestions\n                      .map(normalizeTeamQuestionForDisplay)\n                      .filter(question => (question.text || '').trim().length > 0)\n                  : [];\n\n                return (\n                  <div key={team.id} className=\"bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-blue-300 transition-all hv-surface\" role=\"article\" aria-label={`Équipe ${team.name}`}>\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <h3 className=\"text-lg font-bold text-gray-800\">{team.name}</h3>\n                      <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityColors[teamPriority]}`}>\n                        {teamPriority}\n                      </span>\n                    </div>\n                    <p className=\"text-sm text-gray-600 mb-3\">{renderTextWithLinks(team.expertise)}</p>\n                    <div className=\"mt-2 text-sm text-blue-600 font-medium flex items-center gap-2\">\n                      <Mail className=\"w-4 h-4\" />\n                      {renderTextWithLinks(team.contact)}\n                    </div>\n\n                    {formattedTeamQuestions.length > 0 && (\n                      <div className=\"mt-4\">\n                        <h4 className=\"text-sm font-semibold text-gray-800 mb-2\">Points à préparer :</h4>\n                        <ul className=\"space-y-1\">\n                          {formattedTeamQuestions.map((question, idx) => {\n                            const timingMessage = formatTeamQuestionTimingMessage(questions, question.timingViolation);\n                            return (\n                              <li key={idx} className=\"text-sm text-gray-700 flex flex-col\">\n                                <div className=\"flex\">\n                                  <span className=\"text-blue-500 mr-2\">•</span>\n                                  <span>{renderTextWithLinks(question.text)}</span>\n                                </div>\n                                {timingMessage && (\n                                  <span className=\"ml-5 text-xs text-yellow-600 mt-1\">⚠️ {timingMessage}</span>\n                                )}\n                              </li>\n                            );\n                          })}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </section>\n\n          <div data-tour-id=\"synthesis-risks\" className=\"space-y-8\">\n            {/* Risques identifiés */}\n            <section aria-labelledby=\"risks-heading\">\n              <h2 id=\"risks-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n                <AlertTriangle className=\"w-6 h-6 mr-2 text-red-500\" />\n                Risques identifiés ({analysis.risks.length})\n              </h2>\n              {hasIncompleteAnswers && (\n                <div className=\"mb-4 flex items-start gap-3 rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-sm text-yellow-800\">\n                  <Info className=\"mt-0.5 h-5 w-5\" />\n                  <p>En attente de l’ensemble des informations sur le projet pour une évaluation complète.</p>\n                </div>\n              )}\n              <div className=\"space-y-3\">\n                {analysis.risks.map((risk, idx) => {\n                  const timingViolationMessage = formatRiskTimingViolation(risk.timingViolation);\n\n                  return (\n                    <div\n                      key={idx}\n                      className={`p-4 rounded-xl border hv-surface ${riskColors[risk.level]}`}\n                      role=\"article\"\n                      aria-label={`Risque ${risk.level}`}\n                    >\n                      <div className=\"flex flex-wrap items-center justify-between gap-2 mb-2\">\n                        <span className=\"text-sm font-semibold text-gray-700\">{risk.level}</span>\n                        <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityColors[risk.priority]}`}>\n                          {risk.priority}\n                        </span>\n                      </div>\n                      <p className=\"text-gray-800 font-medium\">{renderTextWithLinks(risk.description)}</p>\n                      {timingViolationMessage && (\n                        <p className=\"text-xs text-red-600 mt-2\">{timingViolationMessage}</p>\n                      )}\n                      <p className=\"text-xs text-gray-600 mt-2\">\n                        <span className=\"font-semibold text-gray-700\">Équipe référente :</span>{' '}\n                        {(() => {\n                          const associatedTeam = teams.find(team => {\n                            if (risk.teamId) {\n                              return team.id === risk.teamId;\n                            }\n                            if (Array.isArray(risk.teams)) {\n                              return risk.teams.includes(team.id);\n                            }\n                            return false;\n                          });\n\n                          if (associatedTeam) {\n                            return associatedTeam.name;\n                          }\n\n                          if (risk.teamId) {\n                            return risk.teamId;\n                          }\n\n                          if (Array.isArray(risk.teams) && risk.teams.length > 0) {\n                            return risk.teams[0];\n                          }\n\n                          return 'Non renseignée';\n                        })()}\n                      </p>\n                      <p className=\"text-sm text-gray-600 mt-2\">\n                        <span className=\"font-semibold text-gray-700\">Mitigation :</span>{' '}\n                        {renderTextWithLinks(risk.mitigation)}\n                      </p>\n                    </div>\n                  );\n                })}\n              </div>\n            </section>\n\n            {rankingResults.map(result => (\n              <section key={result.question.id} aria-labelledby={`ranking-${result.question.id}`} className=\"mt-8\">\n                <h3\n                  id={`ranking-${result.question.id}`}\n                  className=\"text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2\"\n                >\n                  <Sparkles className=\"w-5 h-5 text-indigo-600\" />\n                  {result.config.title}\n                </h3>\n                <p className=\"text-sm text-gray-600 mb-4\">Priorités déclarées : {result.formattedAnswer}</p>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  {result.recommendations.map(recommendation => (\n                    <article\n                      key={recommendation.id}\n                      className=\"p-4 border border-gray-200 rounded-xl bg-white shadow-sm space-y-3 hv-surface\"\n                      aria-label={`Recommandation ${recommendation.name}`}\n                    >\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div>\n                          <h4 className=\"text-lg font-semibold text-gray-900\">{recommendation.name}</h4>\n                          {recommendation.previousProject && (\n                            <p className=\"text-xs text-gray-600\">Projet récent : {recommendation.previousProject}</p>\n                          )}\n                          {recommendation.opinion && (\n                            <p className=\"text-xs text-gray-600\">Avis global : {recommendation.opinion}</p>\n                          )}\n                        </div>\n                        <div className=\"text-right\">\n                          <span className=\"text-xs font-semibold text-gray-500 uppercase\">Score</span>\n                          <p className=\"text-xl font-bold text-indigo-700\">{formatNumber(recommendation.score, { maximumFractionDigits: 1 })}</p>\n                        </div>\n                      </div>\n\n                      <div className=\"flex flex-wrap gap-2\">\n                        {result.orderedCriteria.map(criterion => (\n                          <span\n                            key={`${recommendation.id}-${criterion.id}`}\n                            className=\"inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100\"\n                          >\n                            {criterion.label} : <span className=\"text-gray-900\">{formatCriterionScore(recommendation.scores?.[criterion.id])}</span>\n                          </span>\n                        ))}\n                        {result.ignoredCriteria.map(criterion => (\n                          <span\n                            key={`${recommendation.id}-${criterion.id}-ignored`}\n                            className=\"inline-flex items-center gap-1 px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-500 border border-gray-200\"\n                          >\n                            {criterion.label} : sans importance\n                          </span>\n                        ))}\n                      </div>\n\n                      <div className=\"flex flex-col gap-1 text-sm text-gray-700\">\n                        {recommendation.contact && (\n                          <div className=\"flex items-center gap-2 text-blue-700\">\n                            <Mail className=\"w-4 h-4\" />\n                            {renderTextWithLinks(recommendation.contact)}\n                          </div>\n                        )}\n                        {recommendation.website && (\n                          <a\n                            href={recommendation.website}\n                            className=\"text-sm text-blue-600 underline\"\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                          >\n                            Consulter le site\n                          </a>\n                        )}\n                        {recommendation.notes && (\n                          <p className=\"text-xs text-gray-600 mt-1\">{renderTextWithLinks(recommendation.notes)}</p>\n                        )}\n                      </div>\n                    </article>\n                  ))}\n                </div>\n              </section>\n            ))}\n\n            {vigilanceAlerts.length > 0 && (\n              <section aria-labelledby=\"vigilance-heading\" className=\"mt-8\">\n                <h2 id=\"vigilance-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n                  <CheckCircle className=\"w-6 h-6 mr-2 text-emerald-500\" />\n                  Points de vigilance ({vigilanceAlerts.length})\n                </h2>\n                <div className=\"space-y-3\">\n                  {vigilanceAlerts.map(alert => {\n                    const priorityClass = priorityColors[alert.priority] || 'bg-emerald-100 text-emerald-800 border-emerald-300';\n                    const statusClass = vigilanceStatusClasses[alert.status] || vigilanceStatusClasses.unknown;\n                    const title = alert.riskDescription && alert.riskDescription.trim().length > 0\n                      ? alert.riskDescription\n                      : alert.ruleName;\n                    const teamLabel = resolveTeamLabel(alert.teamId);\n\n                    return (\n                      <div\n                        key={alert.id || `${alert.ruleId}-${alert.riskId || 'risk'}`}\n                        className={`p-4 rounded-xl border hv-surface ${statusClass}`}\n                        role=\"article\"\n                        aria-label={`Point de vigilance ${alert.ruleName}`}\n                      >\n                        <div className=\"flex flex-wrap items-center justify-between gap-2 mb-2\">\n                          <span className=\"text-sm font-semibold text-gray-700\">{alert.ruleName}</span>\n                          {alert.priority && (\n                            <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityClass}`}>\n                              {alert.priority}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-gray-800 font-medium\">{renderTextWithLinks(title)}</p>\n                        {alert.requirementSummary && (\n                          <p className=\"text-xs text-emerald-800 mt-2\">{alert.requirementSummary}</p>\n                        )}\n                        {alert.statusMessage && (\n                          <p className=\"text-xs text-gray-600 mt-2\">{alert.statusMessage}</p>\n                        )}\n                        {teamLabel && (\n                          <p className=\"text-xs text-gray-600 mt-2\">\n                            <span className=\"font-semibold text-gray-700\">Équipe référente :</span>{' '}\n                            {teamLabel}\n                          </p>\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              </section>\n            )}\n          </div>\n\n          {(isAdminMode || hasComplianceComment) && (\n            <section className=\"mt-8\" aria-labelledby=\"compliance-comments-heading\">\n              <div className=\"bg-white rounded-xl border border-blue-200 p-6 hv-surface\">\n                <div className=\"flex items-center mb-4\">\n                  <Info className=\"w-6 h-6 mr-2 text-blue-600\" />\n                  <h2 id=\"compliance-comments-heading\" className=\"text-2xl font-bold text-gray-800\">\n                    Commentaires des équipes compliance\n                  </h2>\n                </div>\n\n                {isAdminMode && (\n                  <form onSubmit={handleComplianceCommentSubmit} className=\"space-y-3 mb-6\">\n                    <label\n                      htmlFor=\"compliance-comments-textarea\"\n                      className=\"block text-sm font-medium text-gray-700\"\n                    >\n                      Renseignez les informations clés à partager avec le Chef de projet.\n                    </label>\n                    <textarea\n                      id=\"compliance-comments-textarea\"\n                      name=\"compliance-comments\"\n                      rows={5}\n                      className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200\"\n                      placeholder=\"Ajoutez ici vos recommandations ou points d'attention compliance...\"\n                      value={complianceCommentDraft}\n                      onChange={handleComplianceCommentChange}\n                    />\n                    <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n                      <p className=\"text-xs text-gray-500\">\n                        Ces commentaires sont enregistrés dans le rapport. Enregistrez ensuite le projet et chargez-le dans le dossier « submitted-projects » pour qu’ils soient visibles par le Chef de projet.\n                      </p>\n                      <div className=\"flex flex-col sm:flex-row sm:items-center gap-2\">\n                        <button\n                          type=\"submit\"\n                          className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all hv-button ${\n                            canSaveComplianceComment\n                              ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                              : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                          }`}\n                          disabled={!canSaveComplianceComment}\n                        >\n                          Enregistrer le commentaire\n                        </button>\n                        {complianceCommentFeedback && (\n                          <span className=\"text-xs font-medium text-emerald-700\">\n                            {complianceCommentFeedback}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </form>\n                )}\n\n                {hasComplianceComment ? (\n                  <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\">\n                  \n                    <p className=\"mt-2 text-sm text-gray-800 whitespace-pre-line\">\n                      {renderTextWithLinks(complianceCommentValue)}\n                    </p>\n                  </div>\n                ) : (\n                  !isAdminMode && (\n                    <p className=\"text-sm text-gray-500\">\n                      Aucun commentaire compliance pour le moment.\n                    </p>\n                  )\n                )}\n              </div>\n            </section>\n          )}\n        </div>\n      </div>\n      {isShowcaseFallbackOpen && (\n        <div ref={showcaseFallbackRef}>\n          <ProjectShowcase\n            projectName={effectiveProjectName}\n            onClose={handleCloseShowcase}\n            analysis={analysis}\n            relevantTeams={relevantTeams}\n            questions={questions}\n            answers={answers}\n            timelineDetails={timelineDetails}\n            onUpdateAnswers={onUpdateAnswers}\n          />\n        </div>\n      )}\n      {attachmentReminder && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"attachment-reminder-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"flex items-center justify-center\">\n              <Mail className=\"w-10 h-10 text-blue-600\" aria-hidden=\"true\" />\n            </div>\n            <div className=\"text-center\">\n              <h2 id=\"attachment-reminder-title\" className=\"text-xl font-semibold text-gray-800\">\n                N'oubliez pas la pièce jointe JSON\n              </h2>\n              <p className=\"mt-3 text-sm text-gray-600\">\n                Le fichier{' '}\n                <span className=\"font-medium text-gray-900\">{attachmentReminder.fileName}</span>\n                {' '}vient d'être téléchargé. Ajoutez-le en pièce jointe de votre e-mail aux équipes compliance pour garantir\n                l'intégration du projet dans la base de données.\n              </p>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleDismissAttachmentReminder}\n                ref={reminderCloseButtonRef}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Compris\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/data/questions.js": "export const initialQuestions = [\n  {\n    \"id\": \"projectName\",\n    \"type\": \"text\",\n    \"question\": \"Quel est le nom du projet ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Nommer clairement l'initiative pour qu'elle soit mémorisée dès les premières secondes.\",\n      \"details\": \"Le nom affiché dans la vitrine du projet sert de repère pour toutes les équipes qui contribuent au pitch.\",\n      \"tips\": [\n        \"Renseignez le nom officiel ou celui que vous souhaitez tester auprès des parties prenantes.\",\n        \"Si un nom de code interne existe, ajoutez-le entre parenthèses pour faciliter le suivi.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Titre principal affiché dans la vitrine du projet.\"\n    }\n  },\n  {\n    \"id\": \"teamLead\",\n    \"type\": \"text\",\n    \"question\": \"Qui lead ce projet ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier l'interlocuteur principal pour les échanges compliance\",\n      \"details\": \"Cette information permet aux équipes expertes de contacter la bonne personne pour clarifier les éléments du dossier.\",\n      \"tips\": [\n        \"Renseignez le prénom et le nom\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Bloc « Lead du projet » dans la section équipe.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"teamLeadTeam\",\n    \"type\": \"choice\",\n    \"question\": \"Équipe à laquelle cette personne appartient\",\n    \"options\": [\n      \"Marketing\",\n      \"Médical\",\n      \"Accès\",\n      \"Vente\",\n      \"Digital\",\n      \"Autre\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Préciser le rattachement du lead pour fluidifier les validations.\",\n      \"details\": \"Cette information s’affiche en complément du lead pour aider les interlocuteurs à identifier le bon canal.\",\n      \"tips\": [\n        \"Sélectionnez l’équipe principale du lead.\",\n        \"Précisez une double appartenance dans vos notes internes si nécessaire.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Mention du rattachement du lead dans la section équipe.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"ProjectType\",\n    \"type\": \"multi_choice\",\n    \"question\": \"De quel type de projet s'agit-il ?\",\n    \"options\": [\n      \"Parrainage / Partenariat\",\n      \"Support d'information / sensibilisation\",\n      \"Outil d'aide à la décision\",\n      \"Outil d'optimisation de la prise en charge des patients\",\n      \"Autre\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Identifier le type de projet pour connaitre les procédures applicables\",\n      \"details\": \"En fonction de la catégorie du projet sélectionné, nous vous poserons des questions supplémentaires pour affiner le projet et ainsi vous guider au mieux\",\n      \"tips\": [\n        \"En cas de doute, sélectionner les différentes catégories applicables\"\n      ]\n    }\n  },\n  {\n    \"id\": \"targetAudience\",\n    \"type\": \"multi_choice\",\n    \"question\": \"À qui s'adresse votre projet ?\",\n    \"options\": [\n      \"Grand public\",\n      \"Patients\",\n      \"Professionnels de santé\",\n      \"Acheteurs\",\n      \"Collaborateurs du LFB\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier les destinataires du projet\",\n      \"details\": \"En fonction de la cible, les règles de validation ne seront pas les mêmes\",\n      \"tips\": [\n        \"Choisissez l'ensemble des personnes auxquelles votre projet s'adresse\",\n        \"Ne sélectionnez \\\"Interne à LFB\\\" que si le projet s'adresse aux collaborateurs du LFB (ex : un site intranet)\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Badge « Audience principale » dans le bandeau de la vitrine.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"showcaseTheme\",\n    \"type\": \"choice\",\n    \"question\": \"Quel thème souhaitez-vous pour la vitrine ?\",\n    \"options\": [\n      \"Universel\",\n      \"Produit\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Sélectionner la palette de couleurs qui servira de base à la vitrine du projet.\",\n      \"details\": \"Chaque thème peut être ajusté dans le back-office grâce aux color-pickers (fond, dégradés, accents). Choisissez celui qui correspond le mieux à votre projet.\",\n      \"tips\": [\n        \"Universel : reprend l'identité visuelle actuelle de la vitrine.\",\n        \"Produit : palette solaire et contrastée pour valoriser une offre produit.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Pilote les couleurs et dégradés utilisés dans l'ensemble de la vitrine.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"projectSlogan\",\n    \"type\": \"text\",\n    \"question\": \"Quel slogan pour votre projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Résumer l'accroche en moins de 10 mots pour capter l'attention immédiatement.\",\n      \"details\": \"Le slogan apparaît dans la hero section et doit être simple, mémorable et orienté bénéfice.\",\n      \"tips\": [\n        \"Utilisez un verbe d’action qui évoque le résultat attendu.\",\n        \"Préférez un ton conversationnel : adressez-vous directement à votre audience.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Promesse courte située sous le nom du projet.\"\n    }\n  },\n  {\n    \"id\": \"problemPainPoints\",\n    \"type\": \"long_text\",\n    \"question\": \"Listez 2 à 3 besoins concrets vécus par vos utilisateurs et que votre projet vient solutionner.\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Montrer que vous comprenez les besoins prioritaires de votre audience.\",\n      \"details\": \"Chaque besoin s’affichera comme un bullet point pour renforcer l’empathie.\",\n      \"tips\": [\n        \"Utilisez une ligne par besoin pour faciliter la lecture.\",\n        \"Décrivez la situation vécue plutôt que la solution souhaitée.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"problem\"\n      ],\n      \"usage\": \"Liste des irritants principaux affichée dans la colonne de gauche.\"\n    }\n  },\n  {\n    \"id\": \"solutionDescription\",\n    \"type\": \"long_text\",\n    \"question\": \"Décrivez en quoi consiste votre solution.\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Clarifier l’expérience proposée avant de détailler les bénéfices.\",\n      \"details\": \"Cette description introduit la section “Solution” et doit rester simple à comprendre.\",\n      \"tips\": [\n        \"Structurez en 2-3 phrases : quoi, pour qui, comment.\",\n        \"Évitez le vocabulaire interne : imaginez que vous présentez le concept à un prospect.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Bloc « Expérience proposée » dans la partie solution.\"\n    }\n  },\n  {\n    \"id\": \"q11\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Quels sont les livrables associés au projet ?\",\n    \"options\": [\n      \"Site internet\",\n      \"Communication sur les réseaux sociaux\",\n      \"Application mobile / web app\",\n      \"Matériel promotionnel\",\n      \"Matériel environnement\",\n      \"Publication scientifique\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"\",\n      \"details\": \"\",\n      \"tips\": []\n    }\n  },\n  {\n    \"id\": \"q3\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Collectez-vous des données dans le cadre de votre projet / solution ?\",\n    \"options\": [\n      \"Oui - Données de santé\",\n      \"Oui - Autre données sensibles\",\n      \"Oui - Données personnelles standard\",\n      \"Non\"\n    ],\n    \"required\": true,\n    \"conditions\": [\n      {\n        \"question\": \"q11\",\n        \"operator\": \"contains\",\n        \"value\": \"Site internet\"\n      },\n      {\n        \"question\": \"q11\",\n        \"operator\": \"contains\",\n        \"value\": \"Application mobile / web app\"\n      }\n    ],\n    \"guidance\": {\n      \"objective\": \"Qualifier la nature des données personnelles manipulées.\",\n      \"details\": \"Les données de santé impliquent une analyse d'impact renforcée (DPIA), un hébergement certifié HDS et des clauses contractuelles spécifiques.\",\n      \"tips\": [\n        \"Si la collecte est incertaine, retenez l'hypothèse la plus protectrice pour planifier les validations.\"\n      ]\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": [\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"q11\",\n            \"operator\": \"contains\",\n            \"value\": \"Site internet\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"contains\",\n            \"value\": \"Application mobile / web app\"\n          }\n        ]\n      }\n    ],\n    \"conditionLogic\": \"any\"\n  },\n  {\n    \"id\": \"q13\",\n    \"type\": \"choice\",\n    \"question\": \"Votre solution contiendra-t-elle des champs libres ?\",\n    \"options\": [\n      \"Oui\",\n      \"Non\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Grand public\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Patients\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Professionnels de santé\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Acheteurs\"\n          }\n        ]\n      },\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Site internet\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Application mobile / web app\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Matériel promotionnel\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Matériel environnement\"\n          }\n        ]\n      }\n    ],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Les champs libres peuvent créer des obligations de PV\",\n      \"details\": \"Dès lors qu'un champs libre est présent, il convient de mettre en place un système de monitoring\",\n      \"tips\": [\n        \"Les champs libres ne sont pas problématiques en soi ! Il convient juste de mettre les bons contrôles en place\"\n      ]\n    }\n  },\n  {\n    \"id\": \"solutionBenefits\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels bénéfices tangibles votre solution apporte-t-elle ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Mettre en avant les résultats obtenus plutôt que les fonctionnalités.\",\n      \"details\": \"Chaque ligne sera transformée en bénéfice clé dans la vitrine.\",\n      \"tips\": [\n        \"Rédigez une phrase par bénéfice, orientée résultat (“Gain de 2h par semaine”).\",\n        \"Priorisez les bénéfices les plus différenciants pour votre audience.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Liste des bénéfices clés dans la section solution.\"\n    }\n  },\n  {\n    \"id\": \"solutionComparison\",\n    \"type\": \"long_text\",\n    \"question\": \"En quoi cette solution se distingue-t-elle des alternatives actuelles ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Souligner la différenciation sans dénigrer la concurrence.\",\n      \"details\": \"Cette réponse apparaît dans la section “Solution” comme une comparaison subtile.\",\n      \"tips\": [\n        \"Comparez-vous à un comportement ou à une solution existante plutôt qu’à un concurrent direct.\",\n        \"Appuyez-vous sur un bénéfice mesurable ou une expérience utilisateur plus fluide.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Bloc « Pourquoi c’est différent » dans la section solution.\"\n    }\n  },\n  {\n    \"id\": \"q10\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Allez-vous impliquer un ou plusieurs partenaires ?\",\n    \"options\": [\n      \"Prestataire de service\",\n      \"Etablissement de santé\",\n      \"Professionnel de santé (via contrat à mettre en place)\",\n      \"Société savante / association de PDS\",\n      \"Association de patients\"\n    ],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Anticiper l'implication de prestataires externes et les contrôles associés\",\n      \"details\": \"Les partenariats imposent une revue juridique des contrats, et parfois des délais supplémentaires liés à des obligations de déclaration / demande d'autorisation aux autorités\",\n      \"tips\": []\n    }\n  },\n  {\n    \"id\": \"BUDGET\",\n    \"type\": \"number\",\n    \"question\": \"Quel est le coût estimé du projet ? (en K€)\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"numberUnit\": \"K€\",\n    \"guidance\": {\n      \"objective\": \"\",\n      \"details\": \"\",\n      \"tips\": []\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"impact\"\n      ],\n      \"usage\": \"Carte « Budget estimé » dans la section impact.\"\n    }\n  },\n  {\n    \"id\": \"innovationProcess\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels sont vos objectifs derrières ce projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier l'intérêt business du projet\",\n      \"details\": \"Cette réponse vous permet de mettre en avant la valeur générée du projet pour le LFB\",\n      \"tips\": [\n        \"Soyez précis dans la description de votre objectif\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"innovation\"\n      ],\n      \"usage\": \"Encart explicatif sur le fonctionnement de l’innovation.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"visionStatement\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels indicateurs allez-vous suivre pour mesurer l'impact du projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Montrer comment vous suivrez concrètement la création de valeur.\",\n      \"details\": \"Chaque indicateur s’affichera comme un point clé dans la section impact pour rassurer les parties prenantes.\",\n      \"tips\": [\n        \"Listez une métrique par ligne (quantitative ou qualitative).\",\n        \"Précisez la cible ou la fréquence de suivi lorsque c’est pertinent.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"impact\"\n      ],\n      \"usage\": \"Citation de conclusion dans la section impact.\"\n    }\n  },\n  {\n    \"id\": \"campaignKickoffDate\",\n    \"type\": \"date\",\n    \"question\": \"À quelle date allez-vous soumettre ce projet à la compliance ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Poser le jalon officiel de passage en revue compliance.\",\n      \"details\": \"Cette date permet d’anticiper les échanges de validation et le temps de traitement.\",\n      \"tips\": [\n        \"Indiquez la date d’envoi du dossier complet à la compliance.\",\n        \"Mettez à jour la date dès qu’un nouveau créneau est confirmé.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Point de départ utilisé pour calculer le runway et les prochaines étapes.\"\n    }\n  },\n  {\n    \"id\": \"launchDate\",\n    \"type\": \"date\",\n    \"question\": \"Quelle est la date de lancement souhaitée ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Aligner toutes les parties prenantes sur la cible de lancement.\",\n      \"details\": \"Associée à la date de soumission compliance, cette information permet de vérifier la faisabilité du planning.\",\n      \"tips\": [\n        \"Renseignez la première date de mise en avant (événement, publication, annonce).\",\n        \"Si la date n’est pas figée, indiquez l’hypothèse la plus réaliste pour planifier les ressources.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Date cible utilisée pour le calcul du runway et du calendrier.\"\n    }\n  },\n  {\n    \"id\": \"roadmapMilestones\",\n    \"type\": \"milestone_list\",\n    \"question\": \"Quels jalons clés souhaitez-vous mettre en avant ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Projeter les étapes majeures à venir pour synchroniser les parties prenantes.\",\n      \"details\": \"Chaque jalon affichera une date et un descriptif dans la section feuille de route de la vitrine.\",\n      \"tips\": [\n        \"Utilisez un format AAAA-MM-JJ pour les dates afin de faciliter la lecture.\",\n        \"Formulez des descriptions actionnables : validation, lancement partiel, publication clé, etc.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Liste de jalons personnalisés dans la section « Les prochains jalons ».\"\n    }\n  },\n  {\n    \"id\": \"teamCoreMembers\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels sont les membres de l'équipe projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Mettre en avant la complémentarité de l’équipe.\",\n      \"details\": \"Chaque ligne sera affichée comme un membre du “collectif moteur”.\",\n      \"tips\": [\n        \"Mentionnez pour chaque personne le rôle ou l’expertise apportée.\",\n        \"Incluez éventuellement les partenaires ou experts externes essentiels.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Liste « Collectif moteur » dans la section équipe.\"\n    },\n    \"placeholder\": \"Prénom Nom - Poste de la personne\\nPrénom Nom - Poste de la personne\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"agencyRanking\",\n    \"type\": \"ranking\",\n    \"question\": \"Classez vos critères pour sélectionner une agence médicale partenaire\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier rapidement l'agence qui correspond le mieux à vos attentes.\",\n      \"details\": \"Ordonnez les critères par importance et mettez de côté ceux qui n'ont aucune incidence pour vous.\",\n      \"tips\": [\n        \"Pensez aux compétences clés attendues (scientifique, créativité, international...).\",\n        \"Marquez les critères non pertinents comme \\\"sans importance\\\" pour affiner la recommandation.\"\n      ]\n    },\n    \"rankingConfig\": {\n      \"title\": \"Prestataires pré-identifiés\",\n      \"criteria\": [\n        { \"id\": \"international\", \"label\": \"International\" },\n        { \"id\": \"scientific\", \"label\": \"Contenu scientifique\" },\n        { \"id\": \"creativity\", \"label\": \"Créativité\" },\n        { \"id\": \"price\", \"label\": \"Prix\" },\n        { \"id\": \"opinion\", \"label\": \"Avis global\" }\n      ],\n      \"entries\": [\n        {\n          \"id\": \"a-a\",\n          \"name\": \"A+A\",\n          \"scores\": { \"international\": 3, \"scientific\": 3, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"antoine.ada@aa.com\",\n          \"website\": \"https://www.adhealth.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"+++\",\n          \"notes\": \"Positionnement premium et solide réseau international.\"\n        },\n        {\n          \"id\": \"adahealth\",\n          \"name\": \"ADAHealth\",\n          \"scores\": { \"international\": 1, \"scientific\": 2, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"robin.benard@adhealth.com\",\n          \"website\": \"https://www.adhealth.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Agence créative avec appétence digitale.\"\n        },\n        {\n          \"id\": \"anna-purna\",\n          \"name\": \"Anna Purna\",\n          \"scores\": { \"international\": 2, \"scientific\": 2, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"l.esperanza@annapurna8000.com\",\n          \"website\": \"https://www.agence-annapurna.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Approche équilibrée entre rigueur médicale et créativité.\"\n        },\n        {\n          \"id\": \"arsenal-cdm\",\n          \"name\": \"Arsenal CDM\",\n          \"scores\": { \"international\": 1, \"scientific\": 1, \"creativity\": 1, \"price\": 1, \"opinion\": 1 },\n          \"contact\": \"cherry@cdmparis.com\",\n          \"website\": \"https://www.cdmparis.com\",\n          \"previousProject\": \"FitCLOT / CLOTTAFACT\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Historique sur des projets clotting, bonne connaissance du secteur.\"\n        }\n      ]\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  }\n];\n",
  "src/utils/inspirationConfig.js": "const DEFAULT_INSPIRATION_FILTERS = {\n  fields: [\n    {\n      id: 'labName',\n      label: 'Nom du labo',\n      type: 'select',\n      enabled: true,\n      sourceQuestionId: 'labName'\n    },\n    {\n      id: 'target',\n      label: 'Cible du projet',\n      type: 'select',\n      enabled: true,\n      options: ['PS', 'Patient', 'GP'],\n      sourceQuestionId: 'target'\n    },\n    {\n      id: 'typology',\n      label: 'Typologie',\n      type: 'select',\n      enabled: true,\n      options: ['Digital', 'Print'],\n      sourceQuestionId: 'typology'\n    },\n    {\n      id: 'therapeuticArea',\n      label: 'Aire thérapeutique',\n      type: 'select',\n      enabled: true,\n      options: ['Immunologie', 'Hémostase', 'Soins intensifs'],\n      sourceQuestionId: 'therapeuticArea'\n    },\n    {\n      id: 'country',\n      label: 'Pays',\n      type: 'select',\n      enabled: true,\n      options: ['France', 'Europe', 'États-Unis', 'Autre'],\n      sourceQuestionId: 'country'\n    }\n  ]\n};\n\nconst DEFAULT_INSPIRATION_FORM_FIELDS = {\n  fields: [\n    {\n      id: 'title',\n      label: 'Titre du projet',\n      type: 'text',\n      required: true,\n      enabled: true\n    },\n    {\n      id: 'labName',\n      label: 'Nom du laboratoire / association',\n      type: 'text',\n      required: true,\n      enabled: true\n    },\n    {\n      id: 'target',\n      label: 'Cible du projet',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['PS', 'Patient', 'GP']\n    },\n    {\n      id: 'typology',\n      label: 'Typologie',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['Digital', 'Print']\n    },\n    {\n      id: 'therapeuticArea',\n      label: 'Aire thérapeutique',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['Immunologie', 'Hémostase', 'Soins intensifs']\n    },\n    {\n      id: 'country',\n      label: 'Pays',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['France', 'Europe', 'États-Unis', 'Autre']\n    },\n    {\n      id: 'description',\n      label: 'Description du projet',\n      type: 'long_text',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'link',\n      label: 'Lien utile',\n      type: 'url',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'documents',\n      label: 'Documents',\n      type: 'documents',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'review',\n      label: 'Avis sur le projet',\n      type: 'long_text',\n      required: false,\n      enabled: true\n    }\n  ]\n};\n\nconst clone = (value) => {\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst sanitizeIdentifier = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : '';\n};\n\nconst sanitizeLabel = (label, fallback) => {\n  if (typeof label !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = label.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst sanitizeBoolean = (value, fallback = true) => {\n  if (typeof value === 'boolean') {\n    return value;\n  }\n  return fallback;\n};\n\nconst sanitizeOptionsList = (options) => {\n  if (!Array.isArray(options)) {\n    return [];\n  }\n\n  return options\n    .map((option) => (typeof option === 'string' ? option.trim() : ''))\n    .filter(Boolean);\n};\n\nconst sanitizeEmptyOptionLabel = (value, fallback = 'Toutes les valeurs') => {\n  if (typeof value !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst normalizeFilterField = (field) => {\n  if (!field || typeof field !== 'object') {\n    return null;\n  }\n\n  const id = sanitizeIdentifier(field.id);\n  if (!id) {\n    return null;\n  }\n\n  const rawType = typeof field.type === 'string' ? field.type : 'text';\n  const type = rawType === 'select' ? 'select' : 'text';\n\n  const normalized = {\n    id,\n    label: sanitizeLabel(field.label, id),\n    type,\n    enabled: sanitizeBoolean(field.enabled, true)\n  };\n\n  const sourceQuestionId = sanitizeIdentifier(field.sourceQuestionId);\n  if (sourceQuestionId) {\n    normalized.sourceQuestionId = sourceQuestionId;\n  }\n\n  if (type === 'select') {\n    normalized.options = sanitizeOptionsList(field.options);\n    if (Object.prototype.hasOwnProperty.call(field, 'emptyOptionLabel')) {\n      normalized.emptyOptionLabel = sanitizeEmptyOptionLabel(field.emptyOptionLabel);\n    }\n  }\n\n  return normalized;\n};\n\nconst normalizeFormField = (field) => {\n  if (!field || typeof field !== 'object') {\n    return null;\n  }\n\n  const id = sanitizeIdentifier(field.id);\n  if (!id) {\n    return null;\n  }\n\n  const type = typeof field.type === 'string' ? field.type : 'text';\n\n  const normalized = {\n    id,\n    label: sanitizeLabel(field.label, id),\n    type,\n    enabled: sanitizeBoolean(field.enabled, true)\n  };\n\n  if (typeof field.required === 'boolean') {\n    normalized.required = field.required;\n  }\n\n  if (typeof field.placeholder === 'string') {\n    normalized.placeholder = field.placeholder;\n  }\n\n  if (type === 'select' || type === 'multi_select') {\n    normalized.options = sanitizeOptionsList(field.options);\n  }\n\n  return normalized;\n};\n\nconst normalizeFilterConfig = (config, fallback) => {\n  if (!config || typeof config !== 'object') {\n    return clone(fallback);\n  }\n\n  if (!Array.isArray(config.fields)) {\n    return clone(fallback);\n  }\n\n  const fields = config.fields.map(normalizeFilterField).filter(Boolean);\n  return { fields };\n};\n\nconst normalizeFormConfig = (config, fallback) => {\n  const base = config && typeof config === 'object' ? config : {};\n  const fields = Array.isArray(base.fields) ? base.fields.map(normalizeFormField).filter(Boolean) : [];\n\n  if (fields.length === 0) {\n    return clone(fallback);\n  }\n\n  return { fields };\n};\n\nexport const createDefaultInspirationFiltersConfig = () => clone(DEFAULT_INSPIRATION_FILTERS);\n\nexport const createDefaultInspirationFormConfig = () => clone(DEFAULT_INSPIRATION_FORM_FIELDS);\n\nexport const normalizeInspirationFiltersConfig = (config) =>\n  normalizeFilterConfig(config, DEFAULT_INSPIRATION_FILTERS);\n\nexport const normalizeInspirationFormConfig = (config) =>\n  normalizeFormConfig(config, DEFAULT_INSPIRATION_FORM_FIELDS);\n\nexport const resetInspirationFiltersConfig = () => createDefaultInspirationFiltersConfig();\n\nexport const resetInspirationFormConfig = () => createDefaultInspirationFormConfig();\n\nexport const updateInspirationFilterField = (config, fieldId, updates) => {\n  const normalized = normalizeInspirationFiltersConfig(config);\n  const nextFields = normalized.fields.map((field) => {\n    if (field.id !== fieldId) {\n      return field;\n    }\n\n    const updated = { ...field };\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'label')) {\n      updated.label = updates.label;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'enabled')) {\n      updated.enabled = updates.enabled;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'type')) {\n      updated.type = updates.type === 'select' ? 'select' : 'text';\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'options') && updated.type === 'select') {\n      updated.options = updates.options;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'emptyOptionLabel') && updated.type === 'select') {\n      updated.emptyOptionLabel = updates.emptyOptionLabel;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'sourceQuestionId')) {\n      updated.sourceQuestionId = updates.sourceQuestionId;\n    }\n\n    return normalizeFilterField(updated) || field;\n  });\n\n  return { ...normalized, fields: nextFields };\n};\n\nexport const updateInspirationFormField = (config, fieldId, updates) => {\n  const normalized = normalizeInspirationFormConfig(config);\n  const nextFields = normalized.fields.map((field) => {\n    if (field.id !== fieldId) {\n      return field;\n    }\n\n    const updated = { ...field, ...updates };\n    return normalizeFormField(updated) || field;\n  });\n\n  return { ...normalized, fields: nextFields };\n};\n",
