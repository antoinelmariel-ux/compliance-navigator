/* Auto-generated by scripts/generate-module-manifest.js */
window.__COMPLIANCE_NAVIGATOR_MANIFEST__ = {
  "src/App.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState, lazy, Suspense } from './react.js';\nimport { QuestionnaireScreen } from './components/QuestionnaireScreen.jsx';\nimport { SynthesisReport } from './components/SynthesisReport.jsx';\nimport { HomeScreen } from './components/HomeScreen.jsx';\nimport { InspirationForm } from './components/InspirationForm.jsx';\nimport { InspirationDetail } from './components/InspirationDetail.jsx';\nimport { AnnotationLayer } from './components/AnnotationLayer.jsx';\nimport { CheckCircle, Link, Lock, MessageSquare, Settings, Sparkles } from './components/icons.js';\nimport { MandatoryQuestionsSummary } from './components/MandatoryQuestionsSummary.jsx';\nimport { initialQuestions } from './data/questions.js';\nimport { initialRules } from './data/rules.js';\nimport { initialRiskLevelRules } from './data/riskLevelRules.js';\nimport { initialRiskWeights } from './data/riskWeights.js';\nimport { initialTeams } from './data/teams.js';\nimport { initialShowcaseThemes } from './data/showcaseThemes.js';\nimport { initialInspirationProjects } from './data/inspirationProjects.js';\nimport { initialOnboardingTourConfig } from './data/onboardingTour.js';\nimport { initialValidationCommitteeConfig } from './data/validationCommitteeConfig.js';\nimport { initialAdminEmails } from './data/adminEmails.js';\nimport { loadPersistedState, persistState } from './utils/storage.js';\nimport { shouldShowQuestion } from './utils/questions.js';\nimport { analyzeAnswers } from './utils/rules.js';\nimport { extractProjectName } from './utils/projects.js';\nimport { createDemoProject, demoProjectAnswersSnapshot } from './data/demoProject.js';\nimport { exportProjectToFile } from './utils/projectExport.js';\nimport { normalizeRiskWeighting } from './utils/risk.js';\nimport { normalizeProjectEntry, normalizeProjectsCollection } from './utils/projectNormalization.js';\nimport { loadSubmittedProjectsFromDirectory } from './utils/externalProjectsLoader.js';\nimport { loadSubmittedInspirationsFromDirectory } from './utils/externalInspirationsLoader.js';\nimport {\n  createDefaultProjectFiltersConfig,\n  normalizeProjectFilterConfig\n} from './utils/projectFilters.js';\nimport { normalizeOnboardingConfig } from './utils/onboarding.js';\nimport {\n  createDefaultInspirationFiltersConfig,\n  createDefaultInspirationFormConfig,\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig\n} from './utils/inspirationConfig.js';\nimport { exportInspirationToFile } from './utils/inspirationExport.js';\nimport { normalizeValidationCommitteeConfig } from './utils/validationCommittee.js';\nimport currentUser from './data/graph-current-user.json';\n\nconst APP_VERSION = 'v1.0.272';\n\nconst resolveShowcaseDisplayMode = (value) => {\n  if (value === 'light') {\n    return 'light';\n  }\n  if (value === 'full') {\n    return 'full';\n  }\n  return null;\n};\n\nconst loadModule = (modulePath) => {\n  if (typeof window === 'undefined') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  if (!window.ModuleLoader || typeof window.ModuleLoader.import !== 'function') {\n    throw new Error('ModuleLoader indisponible.');\n  }\n\n  return window.ModuleLoader.import(modulePath);\n};\n\nconst LazyBackOffice = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/BackOffice.jsx').BackOffice\n  }))\n);\n\nconst LazyProjectShowcase = lazy(() =>\n  Promise.resolve().then(() => ({\n    default: loadModule('./src/components/ProjectShowcase.jsx').ProjectShowcase\n  }))\n);\n\nconst LoadingFallback = ({ label, hint }) => (\n  <div className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n    <div className=\"flex items-center gap-3 text-sm text-gray-600\">\n      <span className=\"loading-spinner\" aria-hidden=\"true\" />\n      <span>{label}</span>\n    </div>\n    {hint && <p className=\"mt-2 text-xs text-gray-400\">{hint}</p>}\n  </div>\n);\n\nconst ANNOTATION_COLORS = [\n  '#2563eb',\n  '#ec4899',\n  '#10b981',\n  '#f59e0b',\n  '#8b5cf6',\n  '#0ea5e9',\n  '#14b8a6',\n  '#ef4444',\n  '#ea580c'\n];\n\nconst BACK_OFFICE_PASSWORD_HASH = '3c5b8c6aaa89db61910cdfe32f1bdb193d1923146dbd6a7b0634a32ab73ac1af';\nconst BACK_OFFICE_PASSWORD_FALLBACK_DIGEST = '86ceec83';\n\nconst computeBackOfficePasswordDigest = async (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return '';\n  }\n\n  const globalCrypto =\n    typeof globalThis !== 'undefined' && typeof globalThis.crypto !== 'undefined'\n      ? globalThis.crypto\n      : undefined;\n\n  const hasSubtleCrypto =\n    !!globalCrypto?.subtle && typeof TextEncoder !== 'undefined';\n\n  if (hasSubtleCrypto) {\n    try {\n      const encoder = new TextEncoder();\n      const data = encoder.encode(value);\n      const digest = await globalCrypto.subtle.digest('SHA-256', data);\n      return Array.from(new Uint8Array(digest))\n        .map(byte => byte.toString(16).padStart(2, '0'))\n        .join('');\n    } catch (error) {\n      // Fallback defined below\n    }\n  }\n\n  let hash = 0;\n  for (let index = 0; index < value.length; index += 1) {\n    hash = (hash * 31 + value.charCodeAt(index)) >>> 0;\n  }\n\n  return hash.toString(16).padStart(8, '0');\n};\n\nconst verifyBackOfficePassword = async (value) => {\n  const digest = await computeBackOfficePasswordDigest(value);\n\n  if (!digest) {\n    return false;\n  }\n\n  if (digest.length === BACK_OFFICE_PASSWORD_HASH.length) {\n    return digest === BACK_OFFICE_PASSWORD_HASH;\n  }\n\n  return digest === BACK_OFFICE_PASSWORD_FALLBACK_DIGEST;\n};\n\nconst normalizeEmail = (value) => (typeof value === 'string' ? value.trim().toLowerCase() : '');\n\nconst cloneDeep = (value) => {\n  if (value === null || value === undefined) {\n    return value;\n  }\n\n  if (typeof structuredClone === 'function') {\n    try {\n      return structuredClone(value);\n    } catch (error) {\n      // Fallback to JSON strategy below\n    }\n  }\n\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst createAnnotationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `note-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst createInspirationId = () => {\n  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {\n    return crypto.randomUUID();\n  }\n\n  return `inspiration-${Date.now()}-${Math.round(Math.random() * 100000)}`;\n};\n\nconst buildAnnotationContextKey = ({ screen, projectId, scope }) => {\n  const base = screen === 'showcase' ? `showcase:${projectId || 'unknown'}` : screen;\n\n  if (screen === 'showcase' && scope) {\n    return `${base}:${scope}`;\n  }\n\n  return base || 'global';\n};\n\nconst restoreShowcaseQuestions = (currentQuestions, referenceQuestions = initialQuestions) => {\n  if (!Array.isArray(currentQuestions)) {\n    return referenceQuestions;\n  }\n\n  const nextQuestions = currentQuestions.slice();\n  let changed = false;\n\n  referenceQuestions.forEach((referenceQuestion, referenceIndex) => {\n    if (!referenceQuestion || !referenceQuestion.showcase) {\n      return;\n    }\n\n    const existingIndex = nextQuestions.findIndex((item) => item && item.id === referenceQuestion.id);\n\n    if (existingIndex === -1) {\n      const clonedQuestion = JSON.parse(JSON.stringify(referenceQuestion));\n      const insertionIndex = Math.min(referenceIndex, nextQuestions.length);\n      nextQuestions.splice(insertionIndex, 0, clonedQuestion);\n      changed = true;\n      return;\n    }\n\n    const existingQuestion = nextQuestions[existingIndex];\n    const existingShowcaseMeta = existingQuestion && existingQuestion.showcase;\n    const referenceShowcaseMeta = referenceQuestion.showcase;\n\n    const showcaseMetaDiffers =\n      !existingShowcaseMeta ||\n      JSON.stringify(existingShowcaseMeta) !== JSON.stringify(referenceShowcaseMeta);\n\n    if (showcaseMetaDiffers) {\n      nextQuestions[existingIndex] = {\n        ...existingQuestion,\n        showcase: JSON.parse(JSON.stringify(referenceShowcaseMeta))\n      };\n      changed = true;\n    }\n  });\n\n  return changed ? nextQuestions : currentQuestions;\n};\n\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst areAnswersEqual = (previousValue, nextValue) => {\n  if (previousValue === nextValue) {\n    return true;\n  }\n\n  if (Array.isArray(previousValue) && Array.isArray(nextValue)) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      if (previousValue.length !== nextValue.length) {\n        return false;\n      }\n      return previousValue.every((entry, index) => entry === nextValue[index]);\n    }\n  }\n\n  if (\n    previousValue &&\n    nextValue &&\n    typeof previousValue === 'object' &&\n    typeof nextValue === 'object'\n  ) {\n    try {\n      return JSON.stringify(previousValue) === JSON.stringify(nextValue);\n    } catch (error) {\n      return false;\n    }\n  }\n\n  return false;\n};\n\nconst findQuestionById = (questions, id) => {\n  if (!Array.isArray(questions)) {\n    return null;\n  }\n\n  return questions.find(question => question?.id === id) || null;\n};\n\nconst normalizeMilestoneListValue = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0)\n    .map(entry => ({\n      date: entry.date,\n      description: entry.description\n    }));\n};\n\nconst areMilestoneListsEqual = (previousValue, nextValue) => {\n  if (previousValue.length !== nextValue.length) {\n    return false;\n  }\n\n  return previousValue.every((entry, index) => {\n    const nextEntry = nextValue[index];\n    if (!nextEntry) {\n      return false;\n    }\n\n    return entry.date === nextEntry.date && entry.description === nextEntry.description;\n  });\n};\n\nconst applyAnswerUpdates = (\n  prevAnswers = {},\n  updates,\n  questions,\n  predicate,\n  options = {}\n) => {\n  if (!updates || typeof updates !== 'object') {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const entries = Object.entries(updates);\n  if (entries.length === 0) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const nextAnswers = { ...prevAnswers };\n  let changed = false;\n\n  entries.forEach(([questionId, value]) => {\n    if (!questionId) {\n      return;\n    }\n\n    const question = findQuestionById(questions, questionId);\n    const questionType = question?.type;\n\n    if (questionType === 'milestone_list') {\n      const normalizedValue = normalizeMilestoneListValue(value);\n      const previousRawValue = nextAnswers[questionId];\n      const previousValue = Array.isArray(previousRawValue)\n        ? normalizeMilestoneListValue(previousRawValue)\n        : [];\n      const previousRawJson = JSON.stringify(Array.isArray(previousRawValue) ? previousRawValue : []);\n      const normalizedJson = JSON.stringify(normalizedValue);\n\n      if (normalizedValue.length > 0) {\n        if (!areMilestoneListsEqual(previousValue, normalizedValue) || previousRawJson !== normalizedJson) {\n          changed = true;\n          nextAnswers[questionId] = normalizedValue;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (Array.isArray(value)) {\n      const filtered = value\n        .map(item => (typeof item === 'string' ? item.trim() : item))\n        .filter(item => {\n          if (typeof item === 'string') {\n            return item.length > 0;\n          }\n          return item !== null && item !== undefined;\n        });\n\n      const previousValue = nextAnswers[questionId];\n      const arraysAreEqual = Array.isArray(previousValue)\n        && previousValue.length === filtered.length\n        && previousValue.every((item, index) => item === filtered[index]);\n\n      if (filtered.length > 0) {\n        if (!arraysAreEqual) {\n          changed = true;\n        }\n        nextAnswers[questionId] = filtered;\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n\n      return;\n    }\n\n    if (value === null || value === undefined) {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length > 0) {\n        if (nextAnswers[questionId] !== value) {\n          changed = true;\n          nextAnswers[questionId] = value;\n        }\n      } else if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n      return;\n    }\n\n    if (nextAnswers[questionId] !== value) {\n      changed = true;\n      nextAnswers[questionId] = value;\n    }\n  });\n\n  if (!changed) {\n    return { nextAnswers: prevAnswers, changed: false };\n  }\n\n  const canEvaluatePredicate = typeof predicate === 'function';\n  const shouldPreserveQuestion = typeof options.shouldPreserveQuestion === 'function'\n    ? options.shouldPreserveQuestion\n    : null;\n  const questionsToRemove = Array.isArray(questions) && canEvaluatePredicate\n    ? questions\n        .filter(question => {\n          if (!question || !question.id) {\n            return false;\n          }\n\n          const wasVisible = predicate(question, prevAnswers);\n          const isVisible = predicate(question, nextAnswers);\n\n          if (isVisible) {\n            return false;\n          }\n\n          if (shouldPreserveQuestion && shouldPreserveQuestion(question, {\n            prevAnswers,\n            nextAnswers\n          })) {\n            return false;\n          }\n\n          if (wasVisible) {\n            return true;\n          }\n\n          return isAnswerProvided(nextAnswers[question.id]) || isAnswerProvided(prevAnswers[question.id]);\n        })\n        .map(question => question.id)\n    : [];\n\n  if (questionsToRemove.length > 0) {\n    questionsToRemove.forEach(questionId => {\n      if (questionId in nextAnswers) {\n        changed = true;\n        delete nextAnswers[questionId];\n      }\n    });\n  }\n\n  return { nextAnswers, changed };\n};\n\nconst resolveFallbackQuestionsLength = (savedState, currentQuestionsLength = initialQuestions.length) => {\n  if (savedState && Array.isArray(savedState.questions) && savedState.questions.length > 0) {\n    return savedState.questions.length;\n  }\n\n  return currentQuestionsLength;\n};\n\nconst buildInitialProjectsState = () => {\n  const savedState = loadPersistedState();\n\n  if (!savedState) {\n    return [createDemoProject()];\n  }\n\n  const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : initialQuestions;\n  const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : initialRules;\n  const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n    ? savedState.riskLevelRules\n    : initialRiskLevelRules;\n  const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n    ? normalizeRiskWeighting(savedState.riskWeights)\n    : initialRiskWeights;\n  const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n  const normalizedProjects = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength)\n    || normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n\n  if (normalizedProjects && normalizedProjects.length > 0) {\n    return normalizedProjects;\n  }\n\n  return [createDemoProject({\n    questions: fallbackQuestions,\n    rules: fallbackRules,\n    riskLevelRules: fallbackRiskLevelRules,\n    riskWeights: fallbackRiskWeights\n  })];\n};\n\nconst buildInitialInspirationProjectsState = () => {\n  const savedState = loadPersistedState();\n  if (savedState && Array.isArray(savedState.inspirationProjects)) {\n    return cloneDeep(savedState.inspirationProjects);\n  }\n\n  return cloneDeep(initialInspirationProjects);\n};\n\nconst buildInitialOnboardingConfig = () => {\n  const savedState = loadPersistedState();\n  if (savedState && savedState.onboardingTourConfig) {\n    return normalizeOnboardingConfig(savedState.onboardingTourConfig);\n  }\n\n  return cloneDeep(initialOnboardingTourConfig);\n};\n\nconst buildInitialValidationCommitteeConfig = () => {\n  const savedState = loadPersistedState();\n  if (savedState && savedState.validationCommitteeConfig) {\n    return normalizeValidationCommitteeConfig(savedState.validationCommitteeConfig);\n  }\n\n  return normalizeValidationCommitteeConfig(initialValidationCommitteeConfig);\n};\n\nconst buildInitialAdminEmailsState = () => {\n  const savedState = loadPersistedState();\n  if (savedState && Array.isArray(savedState.adminEmails)) {\n    return savedState.adminEmails;\n  }\n\n  return cloneDeep(initialAdminEmails);\n};\n\nconst isOnboardingProject = (project) => {\n  if (!project || typeof project !== 'object') {\n    return false;\n  }\n\n  const { id } = project;\n  if (typeof id !== 'string' || id.length === 0) {\n    return false;\n  }\n\n  return id === 'onboarding-demo' || id.startsWith('tour-');\n};\n\nconst sanitizeRestoredProjects = (projects) => {\n  if (!Array.isArray(projects)) {\n    return [];\n  }\n\n  const restored = projects.filter(project => !isOnboardingProject(project));\n\n  if (restored.length === 0) {\n    return [];\n  }\n\n  return cloneDeep(restored);\n};\n\nexport const App = () => {\n  const [mode, setMode] = useState('user');\n  const [screen, setScreen] = useState('home');\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [answers, setAnswers] = useState({});\n  const [analysis, setAnalysis] = useState(null);\n  const [projects, setProjects] = useState(buildInitialProjectsState);\n  const projectsRef = useRef(projects);\n  const [inspirationProjects, setInspirationProjects] = useState(buildInitialInspirationProjectsState);\n  const [onboardingTourConfig, setOnboardingTourConfig] = useState(buildInitialOnboardingConfig);\n  const [activeInspirationId, setActiveInspirationId] = useState(null);\n  const [activeProjectId, setActiveProjectId] = useState(null);\n  const [validationError, setValidationError] = useState(null);\n  const [saveFeedback, setSaveFeedback] = useState(null);\n  const [showcaseProjectContext, setShowcaseProjectContext] = useState(null);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  const [returnToSynthesisAfterEdit, setReturnToSynthesisAfterEdit] = useState(false);\n  const [isOnboardingActive, setIsOnboardingActive] = useState(false);\n  const [onboardingStepId, setOnboardingStepId] = useState(null);\n  const [isTourGuideReady, setIsTourGuideReady] = useState(false);\n  const tourInstanceRef = useRef(null);\n  const onboardingStateRef = useRef(null);\n  const onboardingDemoDataRef = useRef(null);\n  const isOnboardingActiveRef = useRef(false);\n\n  const [questions, setQuestions] = useState(() => restoreShowcaseQuestions(initialQuestions));\n  const [rules, setRules] = useState(initialRules);\n  const [riskLevelRules, setRiskLevelRules] = useState(initialRiskLevelRules);\n  const [riskWeights, setRiskWeights] = useState(() => normalizeRiskWeighting(initialRiskWeights));\n  const [teams, setTeams] = useState(initialTeams);\n  const [showcaseThemes, setShowcaseThemes] = useState(initialShowcaseThemes);\n  const [projectFilters, setProjectFiltersState] = useState(() => createDefaultProjectFiltersConfig());\n  const [inspirationFilters, setInspirationFilters] = useState(() => createDefaultInspirationFiltersConfig());\n  const [inspirationFormFields, setInspirationFormFields] = useState(() => createDefaultInspirationFormConfig());\n  const [homeView, setHomeView] = useState('platform');\n  const [isHydrated, setIsHydrated] = useState(false);\n  const [validationCommitteeConfig, setValidationCommitteeConfig] = useState(buildInitialValidationCommitteeConfig);\n  const [adminEmails, setAdminEmails] = useState(buildInitialAdminEmailsState);\n  const [isBackOfficeUnlocked, setIsBackOfficeUnlocked] = useState(false);\n  const [backOfficeAuthError, setBackOfficeAuthError] = useState(null);\n  const [isBackOfficePromptOpen, setIsBackOfficePromptOpen] = useState(false);\n  const [backOfficePromptValue, setBackOfficePromptValue] = useState('');\n  const [backOfficePromptError, setBackOfficePromptError] = useState('');\n\n  const normalizedOnboardingConfig = useMemo(\n    () => normalizeOnboardingConfig(onboardingTourConfig),\n    [onboardingTourConfig]\n  );\n  const normalizedAdminEmails = useMemo(\n    () => (Array.isArray(adminEmails) ? adminEmails.map(normalizeEmail).filter(Boolean) : []),\n    [adminEmails]\n  );\n  const currentUserEmail = useMemo(\n    () => normalizeEmail(currentUser?.mail || currentUser?.userPrincipalName || ''),\n    []\n  );\n  const currentUserDisplayName = useMemo(() => {\n    const firstName = typeof currentUser?.givenName === 'string' ? currentUser.givenName.trim() : '';\n    const lastName = typeof currentUser?.surname === 'string' ? currentUser.surname.trim() : '';\n    const combined = `${firstName} ${lastName}`.trim();\n    if (combined) {\n      return combined;\n    }\n    const displayName = typeof currentUser?.displayName === 'string' ? currentUser.displayName.trim() : '';\n    if (displayName) {\n      return displayName;\n    }\n    return currentUserEmail;\n  }, [currentUser, currentUserEmail]);\n  const isCurrentUserAdmin = useMemo(\n    () => !!currentUserEmail && normalizedAdminEmails.includes(currentUserEmail),\n    [currentUserEmail, normalizedAdminEmails]\n  );\n  const backOfficePromptResolverRef = useRef(null);\n  const [adminView, setAdminView] = useState('home');\n  const showcaseShareInputRef = useRef(null);\n  const [showcaseDisplayMode, setShowcaseDisplayMode] = useState('full');\n  const [showcaseDisplayModeLock, setShowcaseDisplayModeLock] = useState(null);\n  const [showcaseShareMode, setShowcaseShareMode] = useState('full');\n  const [showcaseShareCommentsEnabled, setShowcaseShareCommentsEnabled] = useState(false);\n  const [isShowcaseSharedView, setIsShowcaseSharedView] = useState(false);\n  const [showcaseCommentsEnabled, setShowcaseCommentsEnabled] = useState(false);\n  const persistTimeoutRef = useRef(null);\n  const previousScreenRef = useRef(null);\n  const pendingShowcaseDisplayModeRef = useRef(null);\n  const [isAnnotationModeEnabled, setIsAnnotationModeEnabled] = useState(false);\n  const [isAnnotationPaused, setIsAnnotationPaused] = useState(false);\n  const [annotationNotes, setAnnotationNotes] = useState([]);\n  const [annotationSources, setAnnotationSources] = useState({ session: ANNOTATION_COLORS[0] });\n  const [showcaseAnnotationScope, setShowcaseAnnotationScope] = useState('display-full');\n  const [autoFocusAnnotationId, setAutoFocusAnnotationId] = useState(null);\n  const [isShowcaseEditing, setIsShowcaseEditing] = useState(false);\n  const [isShowcaseShareOpen, setIsShowcaseShareOpen] = useState(false);\n  const [showcaseShareFeedback, setShowcaseShareFeedback] = useState('');\n  const annotationNotesRef = useRef(annotationNotes);\n  const annotationFileInputRef = useRef(null);\n  const showcaseProjectNameRef = useRef('');\n  const loadedStylesRef = useRef(new Set());\n  const pendingShowcaseProjectIdRef = useRef(null);\n  const pendingShowcaseSharedRef = useRef(false);\n  const pendingShowcaseCommentsRef = useRef(false);\n\n  const ensureStylesheetLoaded = useCallback((href) => {\n    if (typeof document === 'undefined' || !href) {\n      return;\n    }\n\n    if (loadedStylesRef.current.has(href)) {\n      return;\n    }\n\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = href;\n    link.dataset.dynamic = 'true';\n    document.head.appendChild(link);\n    loadedStylesRef.current.add(href);\n  }, []);\n\n  const isAnnotationUiInteraction = useCallback((event) => {\n    const path = typeof event?.composedPath === 'function' ? event.composedPath() : [];\n    if (Array.isArray(path) && path.length > 0) {\n      return path.some(node => node instanceof Element && node.dataset?.annotationUi === 'true');\n    }\n\n    const target = event?.target;\n    const element = target instanceof Element ? target : target?.parentElement;\n    if (element?.closest) {\n      return Boolean(element.closest('[data-annotation-ui=\"true\"]'));\n    }\n\n    return false;\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleBeforeUnload = (event) => {\n      if (!hasUnsavedChanges) {\n        return undefined;\n      }\n\n      const message = 'Avez-vous bien sauvegardÃ© votre projet avant de quitter ?';\n      event.preventDefault();\n      event.returnValue = message;\n      return message;\n    };\n\n    window.addEventListener('beforeunload', handleBeforeUnload);\n\n    return () => {\n      window.removeEventListener('beforeunload', handleBeforeUnload);\n    };\n  }, [hasUnsavedChanges]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const { search, hash } = window.location;\n    const params = new URLSearchParams(search || '');\n    let projectId = params.get('projectId') || params.get('showcase');\n    const rawShowcaseMode = params.get('showcaseMode');\n    const resolvedShowcaseMode = resolveShowcaseDisplayMode(rawShowcaseMode);\n    const rawShowcaseShared = params.get('showcaseShared');\n    const rawShowcaseComments = params.get('showcaseComments');\n    const isSharedView = rawShowcaseShared === '1' || rawShowcaseShared === 'true';\n    const hasCommentsEnabled = rawShowcaseComments === '1' || rawShowcaseComments === 'true';\n\n    if (!projectId && typeof hash === 'string' && hash.length > 1) {\n      const normalizedHash = hash.slice(1);\n      if (normalizedHash.startsWith('showcase=')) {\n        projectId = normalizedHash.replace(/^showcase=/, '');\n      } else if (normalizedHash.startsWith('showcase:')) {\n        projectId = normalizedHash.replace(/^showcase:/, '');\n      }\n    }\n\n    if (projectId) {\n      pendingShowcaseProjectIdRef.current = projectId;\n    }\n\n    if (resolvedShowcaseMode) {\n      pendingShowcaseDisplayModeRef.current = resolvedShowcaseMode;\n    }\n\n    if (isSharedView) {\n      pendingShowcaseSharedRef.current = true;\n    }\n\n    if (hasCommentsEnabled) {\n      pendingShowcaseCommentsRef.current = true;\n    }\n  }, []);\n\n  useEffect(() => {\n    projectsRef.current = projects;\n  }, [projects]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    ensureStylesheetLoaded('./src/styles/project-showcase.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-aurora.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-deezer.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-editorial.css');\n    ensureStylesheetLoaded('./src/styles/project-showcase-theme-fibclot.css');\n  }, [ensureStylesheetLoaded, showcaseProjectContext]);\n\n  useEffect(() => {\n    annotationNotesRef.current = annotationNotes;\n  }, [annotationNotes]);\n\n  useEffect(() => {\n    if (showcaseProjectContext?.projectId) {\n      showcaseProjectNameRef.current = showcaseProjectContext.projectName || '';\n    }\n  }, [showcaseProjectContext?.projectId, showcaseProjectContext?.projectName]);\n\n  useEffect(() => {\n    isOnboardingActiveRef.current = isOnboardingActive;\n  }, [isOnboardingActive]);\n\n  useEffect(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      if (!Array.isArray(prevProjects) || prevProjects.length === 0) {\n        return prevProjects;\n      }\n\n      const containsOnboardingProjects = prevProjects.some(isOnboardingProject);\n      if (!containsOnboardingProjects) {\n        return prevProjects;\n      }\n\n      const sanitizedProjects = prevProjects.filter(project => !isOnboardingProject(project));\n\n      if (sanitizedProjects.length === 0) {\n        return buildInitialProjectsState();\n      }\n\n      return cloneDeep(sanitizedProjects);\n    });\n  }, [isOnboardingActive, setProjects]);\n\n  useEffect(() => {\n    if (mode !== 'admin') {\n      setAdminView('home');\n    }\n  }, [mode]);\n\nconst updateProjectFilters = useCallback((updater) => {\n  setProjectFiltersState(prevConfig => {\n    const currentConfig = normalizeProjectFilterConfig(prevConfig);\n    const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n    return normalizeProjectFilterConfig(nextConfig);\n  });\n}, []);\n\n  const updateInspirationFilters = useCallback((updater) => {\n    setInspirationFilters(prevConfig => {\n      const currentConfig = normalizeInspirationFiltersConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFiltersConfig(nextConfig);\n    });\n  }, []);\n\n  const updateInspirationFormFields = useCallback((updater) => {\n    setInspirationFormFields(prevConfig => {\n      const currentConfig = normalizeInspirationFormConfig(prevConfig);\n      const nextConfig = typeof updater === 'function' ? updater(currentConfig) : updater;\n      return normalizeInspirationFormConfig(nextConfig);\n    });\n  }, []);\n\n  useEffect(() => {\n    if (!Array.isArray(showcaseThemes) || showcaseThemes.length === 0) {\n      return;\n    }\n\n    setQuestions((previousQuestions) => {\n      const nextQuestions = Array.isArray(previousQuestions)\n        ? previousQuestions.slice()\n        : [];\n      const themeQuestionIndex = nextQuestions.findIndex(question => question?.id === 'showcaseTheme');\n\n      if (themeQuestionIndex === -1) {\n        return previousQuestions;\n      }\n\n      const themeOptions = showcaseThemes\n        .map(theme => (typeof theme?.label === 'string' && theme.label.trim().length > 0\n          ? theme.label.trim()\n          : typeof theme?.id === 'string'\n            ? theme.id\n            : ''))\n        .filter(option => option.length > 0);\n\n      const existingOptions = Array.isArray(nextQuestions[themeQuestionIndex]?.options)\n        ? nextQuestions[themeQuestionIndex].options\n        : [];\n\n      if (\n        themeOptions.length === existingOptions.length &&\n        themeOptions.every((option, index) => option === existingOptions[index])\n      ) {\n        return previousQuestions;\n      }\n\n      const existingThemeQuestion = nextQuestions[themeQuestionIndex] || {};\n\n      nextQuestions[themeQuestionIndex] = {\n        ...existingThemeQuestion,\n        options: themeOptions\n      };\n\n      return nextQuestions;\n    });\n  }, [setQuestions, showcaseThemes]);\n\n  const synchronizeExternalProjects = useCallback(async () => {\n    const existingProjects = Array.isArray(projectsRef.current) ? projectsRef.current : [];\n\n    const fallbackQuestionsLength = questions.length;\n\n    const externalProjects = await loadSubmittedProjectsFromDirectory({\n      questions,\n      rules,\n      riskLevelRules,\n      riskWeights,\n      fallbackQuestionsLength,\n      existingProjects\n    });\n\n    const externalSources = new Set(externalProjects.map(entry => entry.sourceId));\n\n    setProjects(prevProjects => {\n      const baseProjects = Array.isArray(prevProjects) ? prevProjects : [];\n      const preserved = baseProjects.filter(project => (\n        !project?.externalSourceId || externalSources.has(project.externalSourceId)\n      ));\n\n      const bySource = new Map();\n      preserved.forEach(project => {\n        if (project && project.externalSourceId) {\n          bySource.set(project.externalSourceId, project);\n        }\n      });\n\n      let changed = preserved.length !== baseProjects.length;\n      const nextProjects = preserved.slice();\n\n      externalProjects.forEach(entry => {\n        const { project, sourceId, checksum } = entry;\n        if (!project || !sourceId) {\n          return;\n        }\n\n        const existing = bySource.get(sourceId);\n        if (!existing) {\n          nextProjects.push(project);\n          changed = true;\n          return;\n        }\n\n        const existingChecksum = existing.externalSourceChecksum;\n        if (existingChecksum && existingChecksum === checksum) {\n          return;\n        }\n\n        const index = nextProjects.findIndex(item => item?.externalSourceId === sourceId);\n        if (index !== -1) {\n          nextProjects[index] = project;\n        } else {\n          nextProjects.push(project);\n        }\n        changed = true;\n      });\n\n      return changed ? nextProjects : baseProjects;\n    });\n  }, [questions, riskLevelRules, riskWeights, rules]);\n\n  const synchronizeExternalInspirations = useCallback(async () => {\n    const externalInspirations = await loadSubmittedInspirationsFromDirectory();\n    const externalSources = new Set(externalInspirations.map(entry => entry.sourceId));\n\n    setInspirationProjects(prevProjects => {\n      const baseProjects = Array.isArray(prevProjects) ? prevProjects : [];\n      const preserved = baseProjects.filter(project => (\n        !project?.externalSourceId || externalSources.has(project.externalSourceId)\n      ));\n\n      const bySource = new Map();\n      preserved.forEach(project => {\n        if (project?.externalSourceId) {\n          bySource.set(project.externalSourceId, project);\n        }\n      });\n\n      let changed = preserved.length !== baseProjects.length;\n      const nextProjects = preserved.slice();\n\n      externalInspirations.forEach(entry => {\n        const { project, sourceId, checksum } = entry;\n        if (!project || !sourceId) {\n          return;\n        }\n\n        const existing = bySource.get(sourceId);\n        if (!existing) {\n          nextProjects.push(project);\n          changed = true;\n          return;\n        }\n\n        const existingChecksum = existing.externalSourceChecksum;\n        if (existingChecksum && existingChecksum === checksum) {\n          return;\n        }\n\n        const index = nextProjects.findIndex(item => item?.externalSourceId === sourceId);\n        if (index !== -1) {\n          nextProjects[index] = project;\n        } else {\n          nextProjects.push(project);\n        }\n        changed = true;\n      });\n\n      return changed ? nextProjects : baseProjects;\n    });\n  }, []);\n\n  useEffect(() => {\n    const loadExternal = async () => {\n      try {\n        await synchronizeExternalProjects();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('Impossible de synchroniser les projets externes :', error);\n        }\n      }\n    };\n\n    loadExternal();\n  }, [synchronizeExternalProjects]);\n\n  useEffect(() => {\n    const loadExternalInspirations = async () => {\n      try {\n        await synchronizeExternalInspirations();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('Impossible de synchroniser les inspirations externes :', error);\n        }\n      }\n    };\n\n    loadExternalInspirations();\n  }, [synchronizeExternalInspirations]);\n\n  useEffect(() => {\n    const savedState = loadPersistedState();\n    if (!savedState) {\n      setIsHydrated(true);\n      return;\n    }\n\n    const fallbackQuestions = Array.isArray(savedState.questions) ? savedState.questions : questions;\n    const fallbackRules = Array.isArray(savedState.rules) ? savedState.rules : rules;\n    const fallbackRiskLevelRules = Array.isArray(savedState.riskLevelRules)\n      ? savedState.riskLevelRules\n      : riskLevelRules;\n    const fallbackRiskWeights = savedState && typeof savedState.riskWeights === 'object'\n      ? normalizeRiskWeighting(savedState.riskWeights)\n      : riskWeights;\n    const fallbackQuestionsLength = resolveFallbackQuestionsLength(savedState, fallbackQuestions.length);\n\n    if (savedState.mode === 'admin') {\n      setMode('user');\n    } else if (savedState.mode) {\n      setMode(savedState.mode);\n    }\n    if (savedState.screen) setScreen(savedState.screen);\n    if (typeof savedState.currentQuestionIndex === 'number' && savedState.currentQuestionIndex >= 0) {\n      setCurrentQuestionIndex(savedState.currentQuestionIndex);\n    }\n    if (savedState.answers && typeof savedState.answers === 'object') setAnswers(savedState.answers);\n    if (typeof savedState.analysis !== 'undefined') setAnalysis(savedState.analysis);\n    if (Array.isArray(savedState.projects)) {\n      const normalized = normalizeProjectsCollection(savedState.projects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    } else if (Array.isArray(savedState.submittedProjects)) {\n      const normalized = normalizeProjectsCollection(savedState.submittedProjects, fallbackQuestionsLength);\n      if (normalized && normalized.length > 0) {\n        setProjects(normalized);\n      } else {\n        setProjects([createDemoProject({\n          questions: fallbackQuestions,\n          rules: fallbackRules,\n          riskLevelRules: fallbackRiskLevelRules,\n          riskWeights: fallbackRiskWeights\n        })]);\n      }\n    }\n    if (typeof savedState.activeProjectId === 'string') setActiveProjectId(savedState.activeProjectId);\n    if (typeof savedState.activeInspirationId === 'string') setActiveInspirationId(savedState.activeInspirationId);\n    if (typeof savedState.homeView === 'string') setHomeView(savedState.homeView);\n    if (Array.isArray(savedState.questions)) {\n      setQuestions(restoreShowcaseQuestions(savedState.questions));\n    }\n    if (Array.isArray(savedState.rules)) setRules(savedState.rules);\n    if (Array.isArray(savedState.riskLevelRules)) setRiskLevelRules(savedState.riskLevelRules);\n    if (savedState && typeof savedState.riskWeights === 'object') {\n      setRiskWeights(normalizeRiskWeighting(savedState.riskWeights));\n    }\n    if (Array.isArray(savedState.teams)) setTeams(savedState.teams);\n    if (Array.isArray(savedState.showcaseThemes)) setShowcaseThemes(savedState.showcaseThemes);\n    if (savedState && typeof savedState.projectFilters === 'object') {\n      setProjectFiltersState(normalizeProjectFilterConfig(savedState.projectFilters));\n    }\n    if (Array.isArray(savedState.inspirationProjects)) {\n      setInspirationProjects(cloneDeep(savedState.inspirationProjects));\n    }\n    if (savedState && typeof savedState.inspirationFilters === 'object') {\n      setInspirationFilters(normalizeInspirationFiltersConfig(savedState.inspirationFilters));\n    }\n    if (savedState && typeof savedState.inspirationFormFields === 'object') {\n      setInspirationFormFields(normalizeInspirationFormConfig(savedState.inspirationFormFields));\n    }\n    if (savedState && savedState.onboardingTourConfig) {\n      setOnboardingTourConfig(normalizeOnboardingConfig(savedState.onboardingTourConfig));\n    }\n\n    setIsHydrated(true);\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    let disposed = false;\n\n    const updateStatus = () => {\n      if (disposed) {\n        return;\n      }\n      setIsTourGuideReady(Boolean(window.TourGuideClient));\n    };\n\n    updateStatus();\n\n    if (window.TourGuideClient) {\n      return () => {\n        disposed = true;\n      };\n    }\n\n    const intervalId = window.setInterval(() => {\n      if (window.TourGuideClient) {\n        updateStatus();\n        window.clearInterval(intervalId);\n      }\n    }, 500);\n\n    return () => {\n      disposed = true;\n      window.clearInterval(intervalId);\n    };\n  }, []);\n\n  const noop = useCallback(() => {}, []);\n\n  const computeDemoData = useCallback(() => {\n    const answers = cloneDeep(demoProjectAnswersSnapshot) || {};\n    const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n    const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    const relevantTeamsList = Array.isArray(teams)\n      ? teams.filter(team => (analysisResult?.teams || []).includes(team.id))\n      : [];\n    const timelineDetails = analysisResult?.timeline?.details || [];\n    const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n      ? answers.projectName.trim()\n      : 'Projet de dÃ©monstration';\n\n    return {\n      answers,\n      analysis: analysisResult,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      projectName,\n      relevantTeams: relevantTeamsList,\n      timelineDetails\n    };\n  }, [questions, riskLevelRules, riskWeights, rules, shouldShowQuestion, teams]);\n\n  const getDemoData = useCallback(() => {\n    if (!onboardingDemoDataRef.current) {\n      onboardingDemoDataRef.current = computeDemoData();\n    }\n\n    return onboardingDemoDataRef.current;\n  }, [computeDemoData]);\n\n  const buildOnboardingAnnotationNotes = useCallback((projectContext) => {\n    if (!projectContext) {\n      return [];\n    }\n\n    const projectId = projectContext.projectId || 'unknown';\n    const contextId = buildAnnotationContextKey({\n      screen: 'showcase',\n      projectId,\n      scope: showcaseAnnotationScope\n    });\n    const sourceId = 'onboarding-demo';\n    const color = registerAnnotationSource(sourceId, ANNOTATION_COLORS[3]);\n\n    return [\n      {\n        id: createAnnotationId(),\n        x: 0.22,\n        y: 0.25,\n        sectionId: 'hero',\n        sectionX: 0.25,\n        sectionY: 0.2,\n        text: 'ðŸ’¡ Ã€ montrer en mode Light pour aller droit au message.',\n        color,\n        contextId,\n        projectId,\n        projectName: projectContext.projectName || '',\n        sourceId\n      },\n      {\n        id: createAnnotationId(),\n        x: 0.68,\n        y: 0.42,\n        sectionId: 'solution',\n        sectionX: 0.65,\n        sectionY: 0.4,\n        text: 'Ajouter une capture ici pour illustrer la solution.',\n        color,\n        contextId,\n        projectId,\n        projectName: projectContext.projectName || '',\n        sourceId\n      },\n      {\n        id: createAnnotationId(),\n        x: 0.3,\n        y: 0.75,\n        sectionId: 'timeline',\n        sectionX: 0.35,\n        sectionY: 0.2,\n        text: 'Timeline OK, prÃ©voir une date de revue en plus.',\n        color,\n        contextId,\n        projectId,\n        projectName: projectContext.projectName || '',\n        sourceId\n      }\n    ];\n  }, [registerAnnotationSource, showcaseAnnotationScope]);\n\n  const buildOnboardingProjects = useCallback((demoData) => {\n    const baseAnswers = cloneDeep(demoData?.answers || demoProjectAnswersSnapshot || {});\n    const now = Date.now();\n\n    const createEntry = (config) => {\n      const offsetMs = typeof config.offsetMs === 'number' ? config.offsetMs : 0;\n      const timestamp = config.timestamp || new Date(now - offsetMs).toISOString();\n      const answersPatch = config.answers || {};\n      const answers = cloneDeep({ ...baseAnswers, ...answersPatch });\n      if (config.projectName) {\n        answers.projectName = config.projectName;\n      }\n\n      const projectName = typeof answers.projectName === 'string' && answers.projectName.trim().length > 0\n        ? answers.projectName.trim()\n        : 'Projet sans nom';\n\n      const analysisResult = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n      const visibleQuestions = questions.filter(question => shouldShowQuestion(question, answers));\n      const totalQuestions = visibleQuestions.length > 0 ? visibleQuestions.length : questions.length;\n      const answeredQuestions = visibleQuestions.filter(question => isAnswerProvided(answers[question.id])).length;\n      const status = config.status || 'draft';\n\n      return {\n        id: config.id,\n        projectName,\n        answers,\n        analysis: analysisResult,\n        status,\n        lastUpdated: config.lastUpdated || timestamp,\n        generatedAt: config.generatedAt || timestamp,\n        submittedAt: status === 'submitted' ? (config.submittedAt || timestamp) : undefined,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex:\n          typeof config.lastQuestionIndex === 'number'\n            ? config.lastQuestionIndex\n            : (status === 'submitted' && totalQuestions > 0\n              ? totalQuestions - 1\n              : Math.max(totalQuestions - 2, 0)),\n        isDemo: true\n      };\n    };\n\n    return [\n      createEntry({\n        id: 'tour-draft-1',\n        projectName: 'Atlas Connect',\n        status: 'draft',\n        offsetMs: 86400000,\n        answers: {\n          teamLead: 'LÃ©a Martin',\n          teamLeadTeam: 'Digital'\n        }\n      }),\n      createEntry({\n        id: 'tour-submitted',\n        projectName: 'Pulse Live',\n        status: 'submitted',\n        offsetMs: 432000000,\n        answers: {\n          teamLead: 'Noah Carpentier',\n          teamLeadTeam: 'Marketing'\n        }\n      }),\n      createEntry({\n        id: 'tour-draft-demo',\n        projectName: demoData?.projectName || 'Plasma 360',\n        status: 'draft',\n        offsetMs: 172800000,\n        answers: {}\n      })\n    ];\n  }, [analyzeAnswers, currentUserEmail, questions, riskLevelRules, riskWeights, rules, shouldShowQuestion]);\n\n  const restoreOnboardingSnapshot = useCallback(() => {\n    const snapshot = onboardingStateRef.current;\n    onboardingStateRef.current = null;\n    onboardingDemoDataRef.current = null;\n\n    if (!snapshot) {\n      setMode('user');\n      setAdminView('home');\n      setScreen('home');\n      setAnswers({});\n      setAnalysis(null);\n      setProjects(buildInitialProjectsState());\n      setProjectFiltersState(createDefaultProjectFiltersConfig());\n      setCurrentQuestionIndex(0);\n      setValidationError(null);\n      setSaveFeedback(null);\n      setActiveProjectId(null);\n      setShowcaseProjectContext(null);\n      setHasUnsavedChanges(false);\n      setBackOfficeAuthError(null);\n      setIsBackOfficeUnlocked(false);\n      setAnnotationNotes([]);\n      setAnnotationSources({ session: ANNOTATION_COLORS[0] });\n      setIsAnnotationModeEnabled(false);\n      setIsAnnotationPaused(false);\n      setShowcaseAnnotationScope('display-full');\n      return;\n    }\n\n    setMode(snapshot.mode || 'user');\n    setAdminView(snapshot.adminView || 'home');\n    setScreen(snapshot.screen || 'home');\n    setAnswers(snapshot.answers || {});\n    setAnalysis(typeof snapshot.analysis !== 'undefined' ? snapshot.analysis : null);\n    const restoredProjects = sanitizeRestoredProjects(snapshot.projects);\n    setProjects(\n      restoredProjects.length > 0\n        ? restoredProjects\n        : buildInitialProjectsState()\n    );\n    setProjectFiltersState(\n      snapshot.projectFilters\n        ? normalizeProjectFilterConfig(snapshot.projectFilters)\n        : createDefaultProjectFiltersConfig()\n    );\n    setCurrentQuestionIndex(\n      typeof snapshot.currentQuestionIndex === 'number' && snapshot.currentQuestionIndex >= 0\n        ? snapshot.currentQuestionIndex\n        : 0\n    );\n    setValidationError(snapshot.validationError || null);\n    setSaveFeedback(snapshot.saveFeedback || null);\n    setActiveProjectId(typeof snapshot.activeProjectId === 'string' ? snapshot.activeProjectId : null);\n    setShowcaseProjectContext(snapshot.showcaseProjectContext || null);\n    setHasUnsavedChanges(Boolean(snapshot.hasUnsavedChanges));\n    setBackOfficeAuthError(snapshot.backOfficeAuthError || null);\n    setIsBackOfficeUnlocked(Boolean(snapshot.isBackOfficeUnlocked));\n    setAnnotationNotes(Array.isArray(snapshot.annotationNotes) ? snapshot.annotationNotes : []);\n    setAnnotationSources(snapshot.annotationSources || { session: ANNOTATION_COLORS[0] });\n    setIsAnnotationModeEnabled(Boolean(snapshot.isAnnotationModeEnabled));\n    setIsAnnotationPaused(Boolean(snapshot.isAnnotationPaused));\n    setShowcaseAnnotationScope(snapshot.showcaseAnnotationScope || 'display-full');\n  }, [\n    setActiveProjectId,\n    setAdminView,\n    setAnalysis,\n    setAnswers,\n    setBackOfficeAuthError,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setIsBackOfficeUnlocked,\n    setMode,\n    setProjectFiltersState,\n    setProjects,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseProjectContext,\n    setValidationError,\n    setAnnotationNotes,\n    setAnnotationSources,\n    setIsAnnotationModeEnabled,\n    setIsAnnotationPaused,\n    setShowcaseAnnotationScope\n  ]);\n\n  const finishOnboarding = useCallback((options = {}) => {\n    const { shouldLoadIndex = false } = options || {};\n    const snapshotExists = Boolean(onboardingStateRef.current);\n    const wasOnboardingActive = isOnboardingActiveRef.current;\n\n    if (!wasOnboardingActive && !snapshotExists) {\n      return;\n    }\n\n    isOnboardingActiveRef.current = false;\n    setIsOnboardingActive(false);\n    setOnboardingStepId(null);\n\n    const tourInstance = tourInstanceRef.current;\n    tourInstanceRef.current = null;\n\n    if (tourInstance && typeof tourInstance.stop === 'function') {\n      try {\n        tourInstance.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Impossible de stopper le guide :', error);\n        }\n      }\n    }\n\n    if (snapshotExists) {\n      restoreOnboardingSnapshot();\n    }\n\n    if (shouldLoadIndex && typeof window !== 'undefined') {\n      const redirect = () => {\n        try {\n          if (window.location) {\n            if (typeof window.location.assign === 'function') {\n              window.location.assign('./index.html');\n            } else {\n              window.location.href = './index.html';\n            }\n          }\n        } catch (error) {\n          if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n            console.warn('[Onboarding] Impossible de charger la page d\\'accueil :', error);\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => redirect());\n      } else if (typeof window.setTimeout === 'function') {\n        window.setTimeout(() => redirect(), 0);\n      }\n    }\n  }, [restoreOnboardingSnapshot]);\n\n  const handleOnboardingStepEnter = useCallback((stepId) => {\n    if (!stepId) {\n      return;\n    }\n\n    const demoData = getDemoData();\n\n    const openDemoShowcase = () => {\n      openProjectShowcase({\n        projectId: null,\n        projectName: demoData.projectName,\n        answers: cloneDeep(demoData.answers),\n        analysis: demoData.analysis,\n        relevantTeams: demoData.relevantTeams,\n        questions: demoData.questions,\n        timelineDetails: demoData.timelineDetails,\n        status: 'draft'\n      });\n      setHasUnsavedChanges(false);\n    };\n\n    const ensureShowcaseTopVisible = () => {\n      if (typeof window === 'undefined') {\n        return;\n      }\n\n      const scrollToTop = () => {\n        try {\n          if (typeof document !== 'undefined') {\n            const topSection = document.querySelector('[data-tour-id=\"showcase-preview\"]');\n            if (topSection && typeof topSection.scrollIntoView === 'function') {\n              topSection.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });\n              return;\n            }\n          }\n\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n          }\n        } catch (error) {\n          if (typeof window.scrollTo === 'function') {\n            window.scrollTo({ top: 0 });\n          }\n        }\n      };\n\n      if (typeof window.requestAnimationFrame === 'function') {\n        window.requestAnimationFrame(() => {\n          if (typeof window.setTimeout === 'function') {\n            window.setTimeout(scrollToTop, 0);\n          } else {\n            scrollToTop();\n          }\n        });\n        return;\n      }\n\n      if (typeof window.setTimeout === 'function') {\n        window.setTimeout(scrollToTop, 0);\n        return;\n      }\n\n      scrollToTop();\n    };\n\n    const shouldOpenShareModal = stepId === 'showcase-display-modes';\n\n    if (!shouldOpenShareModal && isShowcaseShareOpen) {\n      setIsShowcaseShareOpen(false);\n      setShowcaseShareFeedback('');\n    }\n\n    switch (stepId) {\n      case 'welcome':\n      case 'create-project': {\n        setScreen('home');\n        setShowcaseProjectContext(null);\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'question-overview':\n      case 'question-guidance':\n      case 'project-save-anytime': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setCurrentQuestionIndex(0);\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'questionnaire-finish': {\n        setShowcaseProjectContext(null);\n        setScreen('questionnaire');\n        setActiveProjectId('onboarding-demo');\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        const totalQuestionsCount = Array.isArray(demoData.questions) && demoData.questions.length > 0\n          ? demoData.questions.length\n          : questions.length;\n        const lastIndex = totalQuestionsCount > 0 ? totalQuestionsCount - 1 : 0;\n        setCurrentQuestionIndex(lastIndex);\n        break;\n      }\n      case 'compliance-report-top':\n      case 'compliance-teams':\n      case 'compliance-risks':\n      case 'compliance-submit':\n      case 'compliance-save':\n      case 'compliance-showcase-button': {\n        setAnswers(cloneDeep(demoData.answers));\n        setAnalysis(demoData.analysis);\n        setCurrentQuestionIndex(0);\n        setValidationError(null);\n        setScreen('synthesis');\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      case 'showcase-top': {\n        openDemoShowcase();\n        ensureShowcaseTopVisible();\n        break;\n      }\n      case 'showcase-bottom':\n      case 'showcase-edit-trigger':\n      case 'showcase-edit':\n      case 'showcase-custom-sections':\n      case 'showcase-save-edits':\n      case 'showcase-back-to-report': {\n        openDemoShowcase();\n        break;\n      }\n      case 'showcase-display-modes': {\n        openDemoShowcase();\n        setShowcaseShareMode(showcaseDisplayMode === 'light' ? 'light' : 'full');\n        setShowcaseShareCommentsEnabled(false);\n        setIsShowcaseShareOpen(true);\n        setShowcaseShareFeedback('');\n        setIsAnnotationModeEnabled(false);\n        setIsAnnotationPaused(false);\n        break;\n      }\n      case 'showcase-comments': {\n        openDemoShowcase();\n        setIsShowcaseShareOpen(false);\n        setShowcaseShareFeedback('');\n        setIsAnnotationModeEnabled(true);\n        setIsAnnotationPaused(false);\n        setAnnotationNotes(buildOnboardingAnnotationNotes({\n          projectId: 'unknown',\n          projectName: demoData.projectName\n        }));\n        break;\n      }\n      case 'project-import':\n      case 'project-filters': {\n        setShowcaseProjectContext(null);\n        setScreen('home');\n        setActiveProjectId(null);\n        setValidationError(null);\n        setSaveFeedback(null);\n        setHasUnsavedChanges(false);\n        break;\n      }\n      default:\n        break;\n    }\n  }, [\n    getDemoData,\n    openProjectShowcase,\n    screen,\n    questions,\n    setActiveProjectId,\n    setAnalysis,\n    setAnswers,\n    setAnnotationNotes,\n    setIsAnnotationModeEnabled,\n    setIsAnnotationPaused,\n    setCurrentQuestionIndex,\n    setHasUnsavedChanges,\n    setIsShowcaseShareOpen,\n    setSaveFeedback,\n    setScreen,\n    setShowcaseShareCommentsEnabled,\n    setShowcaseShareFeedback,\n    setShowcaseShareMode,\n    setShowcaseProjectContext,\n    setValidationError,\n    buildOnboardingAnnotationNotes,\n    showcaseDisplayMode,\n    isShowcaseShareOpen\n  ]);\n\n  const handleStartOnboarding = useCallback(() => {\n    if (isOnboardingActive) {\n      return;\n    }\n\n    if (typeof window === 'undefined' || typeof window.TourGuideClient !== 'function') {\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Le guide interactif est momentanÃ©ment indisponible.');\n      }\n      return;\n    }\n\n    onboardingStateRef.current = {\n      mode,\n      screen,\n      adminView,\n      answers: cloneDeep(answers),\n      analysis: cloneDeep(analysis),\n      projects: cloneDeep(projects),\n      projectFilters: cloneDeep(projectFilters),\n      currentQuestionIndex,\n      validationError: cloneDeep(validationError),\n      saveFeedback: cloneDeep(saveFeedback),\n      activeProjectId,\n      showcaseProjectContext: cloneDeep(showcaseProjectContext),\n      hasUnsavedChanges,\n      backOfficeAuthError,\n      isBackOfficeUnlocked,\n      annotationNotes: cloneDeep(annotationNotes),\n      annotationSources: cloneDeep(annotationSources),\n      isAnnotationModeEnabled,\n      isAnnotationPaused,\n      showcaseAnnotationScope\n    };\n\n    const demoData = getDemoData();\n    onboardingDemoDataRef.current = demoData;\n    const onboardingProjects = buildOnboardingProjects(demoData);\n\n    isOnboardingActiveRef.current = true;\n    setIsOnboardingActive(true);\n    setOnboardingStepId(null);\n    setMode('user');\n    setAdminView('home');\n    setScreen('home');\n    setShowcaseProjectContext(null);\n    setActiveProjectId(null);\n    setAnswers({});\n    setAnalysis(null);\n    setValidationError(null);\n    setSaveFeedback(null);\n    setHasUnsavedChanges(false);\n    setBackOfficeAuthError(null);\n    setIsBackOfficeUnlocked(false);\n    setAnnotationNotes([]);\n    setAnnotationSources({ session: ANNOTATION_COLORS[0] });\n    setIsAnnotationModeEnabled(false);\n    setIsAnnotationPaused(false);\n    setShowcaseAnnotationScope('display-full');\n    setProjects(onboardingProjects);\n    setProjectFiltersState(createDefaultProjectFiltersConfig());\n\n    const {\n      steps,\n      labels,\n      allowClose,\n      showStepDots\n    } = normalizedOnboardingConfig;\n\n    if (!Array.isArray(steps) || steps.length === 0) {\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Le tour dâ€™onboarding est vide. Veuillez vÃ©rifier la configuration.');\n      }\n      return;\n    }\n\n    const tour = new window.TourGuideClient({\n      steps,\n      labels,\n      allowClose,\n      showStepDots\n    });\n\n    tour.on('stepChange', ({ step }) => {\n      const stepId = step?.id || null;\n      handleOnboardingStepEnter(stepId);\n      setOnboardingStepId(stepId);\n    });\n\n    tour.on('close', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.on('finish', () => {\n      finishOnboarding({ shouldLoadIndex: true });\n    });\n\n    tour.start();\n    tourInstanceRef.current = tour;\n  }, [\n    isOnboardingActive,\n    mode,\n    screen,\n    adminView,\n    answers,\n    analysis,\n    projects,\n    projectFilters,\n    currentQuestionIndex,\n    validationError,\n    saveFeedback,\n    activeProjectId,\n    showcaseProjectContext,\n    hasUnsavedChanges,\n    backOfficeAuthError,\n    isBackOfficeUnlocked,\n    annotationNotes,\n    annotationSources,\n    isAnnotationModeEnabled,\n    isAnnotationPaused,\n    showcaseAnnotationScope,\n    getDemoData,\n    buildOnboardingProjects,\n    normalizedOnboardingConfig,\n    handleOnboardingStepEnter,\n    finishOnboarding,\n    setMode,\n    setAdminView,\n    setScreen,\n    setShowcaseProjectContext,\n    setActiveProjectId,\n    setAnswers,\n    setAnalysis,\n    setValidationError,\n    setSaveFeedback,\n    setHasUnsavedChanges,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked,\n    setAnnotationNotes,\n    setAnnotationSources,\n    setIsAnnotationModeEnabled,\n    setIsAnnotationPaused,\n    setShowcaseAnnotationScope,\n    setProjects,\n    setProjectFiltersState\n  ]);\n\n  useEffect(() => () => {\n    if (tourInstanceRef.current && typeof tourInstanceRef.current.stop === 'function') {\n      try {\n        tourInstanceRef.current.stop();\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[Onboarding] Nettoyage du guide impossible :', error);\n        }\n      }\n    }\n    tourInstanceRef.current = null;\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!isHydrated || isOnboardingActive) return undefined;\n\n    if (persistTimeoutRef.current) {\n      clearTimeout(persistTimeoutRef.current);\n    }\n\n    persistTimeoutRef.current = setTimeout(() => {\n      const modeToPersist = mode === 'admin' ? 'user' : mode;\n\n      persistState({\n        mode: modeToPersist,\n        screen,\n        currentQuestionIndex,\n        answers,\n        analysis,\n        questions,\n        rules,\n        riskLevelRules,\n        riskWeights,\n        teams,\n        showcaseThemes,\n        projects,\n        activeProjectId,\n        projectFilters: normalizeProjectFilterConfig(projectFilters),\n        inspirationProjects,\n        inspirationFilters: normalizeInspirationFiltersConfig(inspirationFilters),\n        inspirationFormFields: normalizeInspirationFormConfig(inspirationFormFields),\n        onboardingTourConfig: normalizedOnboardingConfig,\n        validationCommitteeConfig: normalizeValidationCommitteeConfig(validationCommitteeConfig),\n        adminEmails,\n        homeView,\n        activeInspirationId\n      });\n      persistTimeoutRef.current = null;\n    }, 200);\n\n    return () => {\n      if (persistTimeoutRef.current) {\n        clearTimeout(persistTimeoutRef.current);\n        persistTimeoutRef.current = null;\n      }\n    };\n  }, [\n    mode,\n    screen,\n    currentQuestionIndex,\n    answers,\n    analysis,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    teams,\n    showcaseThemes,\n    projects,\n    activeProjectId,\n    projectFilters,\n    inspirationProjects,\n    inspirationFilters,\n    inspirationFormFields,\n    normalizedOnboardingConfig,\n    validationCommitteeConfig,\n    adminEmails,\n    homeView,\n    activeInspirationId,\n    isHydrated,\n    isOnboardingActive\n  ]);\n\n  const tourContext = useMemo(\n    () => (isOnboardingActive ? { isActive: true, activeStep: onboardingStepId } : null),\n    [isOnboardingActive, onboardingStepId]\n  );\n\n  const activeQuestions = useMemo(\n    () => questions.filter(q => shouldShowQuestion(q, answers)),\n    [questions, answers]\n  );\n\n  const unansweredMandatoryQuestions = useMemo(\n    () =>\n      activeQuestions.filter(question => question.required && !isAnswerProvided(answers[question.id])),\n    [activeQuestions, answers]\n  );\n\n  const pendingMandatoryQuestions = useMemo(\n    () =>\n      unansweredMandatoryQuestions.map(question => ({\n        question,\n        position: activeQuestions.findIndex(item => item.id === question.id) + 1\n      })),\n    [unansweredMandatoryQuestions, activeQuestions]\n  );\n\n  const hasIncompleteAnswers = useMemo(\n    () => unansweredMandatoryQuestions.length > 0,\n    [unansweredMandatoryQuestions]\n  );\n\n  const teamLeadTeamOptions = useMemo(() => {\n    const leadTeamQuestion = questions.find(question => question?.id === 'teamLeadTeam');\n    if (!leadTeamQuestion || !Array.isArray(leadTeamQuestion.options)) {\n      return [];\n    }\n\n    const sanitized = leadTeamQuestion.options\n      .map(option => (typeof option === 'string' ? option.trim() : ''))\n      .filter(option => option.length > 0);\n\n    return Array.from(new Set(sanitized));\n  }, [questions]);\n\n  useEffect(() => {\n    if (!isHydrated) return;\n    if (activeQuestions.length === 0) return;\n    if (currentQuestionIndex >= activeQuestions.length) {\n      setCurrentQuestionIndex(activeQuestions.length - 1);\n    }\n  }, [activeQuestions.length, currentQuestionIndex, isHydrated]);\n\n  useEffect(() => {\n    if (screen !== 'questionnaire' && screen !== 'synthesis') {\n      setSaveFeedback(null);\n    }\n  }, [screen]);\n\n  const activeProject = useMemo(\n    () => projects.find(project => project.id === activeProjectId) || null,\n    [projects, activeProjectId]\n  );\n  const activeInspirationProject = useMemo(\n    () => inspirationProjects.find(project => project.id === activeInspirationId) || null,\n    [inspirationProjects, activeInspirationId]\n  );\n\n  const activeProjectName = useMemo(() => {\n    if (typeof activeProject?.projectName === 'string' && activeProject.projectName.trim().length > 0) {\n      return activeProject.projectName.trim();\n    }\n\n    return extractProjectName(answers, questions);\n  }, [activeProject, answers, questions]);\n\n  const activeShowcaseProjectId = showcaseProjectContext?.projectId || null;\n\n  const activeAnnotationContextKey = useMemo(\n    () => buildAnnotationContextKey({\n      screen,\n      projectId: activeShowcaseProjectId,\n      scope: showcaseAnnotationScope\n    }),\n    [activeShowcaseProjectId, screen, showcaseAnnotationScope]\n  );\n\n  useEffect(() => {\n    if (!isOnboardingActive || onboardingStepId !== 'showcase-comments') {\n      return;\n    }\n\n    if (screen !== 'showcase') {\n      return;\n    }\n\n    const hasOnboardingNotes = annotationNotes.some(note => note?.sourceId === 'onboarding-demo');\n    if (hasOnboardingNotes) {\n      return;\n    }\n\n    const demoData = getDemoData();\n    setIsAnnotationModeEnabled(true);\n    setIsAnnotationPaused(false);\n    setAnnotationNotes(buildOnboardingAnnotationNotes({\n      projectId: showcaseProjectContext?.projectId || 'unknown',\n      projectName: demoData.projectName\n    }));\n  }, [\n    annotationNotes,\n    buildOnboardingAnnotationNotes,\n    getDemoData,\n    isOnboardingActive,\n    onboardingStepId,\n    screen,\n    setAnnotationNotes,\n    setIsAnnotationModeEnabled,\n    setIsAnnotationPaused,\n    showcaseProjectContext\n  ]);\n\n  const registerAnnotationSource = useCallback((sourceId, preferredColor) => {\n    if (!sourceId) {\n      return ANNOTATION_COLORS[0];\n    }\n\n    let resolvedColor = ANNOTATION_COLORS[0];\n\n    setAnnotationSources(prevSources => {\n      if (prevSources[sourceId]) {\n        resolvedColor = prevSources[sourceId];\n        return prevSources;\n      }\n\n      const usedColors = new Set(Object.values(prevSources));\n\n      if (preferredColor && !usedColors.has(preferredColor)) {\n        resolvedColor = preferredColor;\n      } else {\n        const availableColor = ANNOTATION_COLORS.find(color => !usedColors.has(color));\n        resolvedColor = availableColor || ANNOTATION_COLORS[0];\n      }\n\n      return { ...prevSources, [sourceId]: resolvedColor };\n    });\n\n    return resolvedColor;\n  }, []);\n\n  const resolveAnnotationTarget = useCallback((clientX, clientY, targetElement = null) => {\n    if (typeof document === 'undefined') {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const activeTarget = targetElement instanceof Element\n      ? targetElement\n      : document.elementFromPoint(clientX, clientY);\n\n    const sectionElement = activeTarget?.closest('[data-showcase-section]');\n\n    if (!sectionElement) {\n      return { sectionId: null, sectionX: null, sectionY: null };\n    }\n\n    const rect = sectionElement.getBoundingClientRect();\n    const sectionWidth = rect?.width || 1;\n    const sectionHeight = rect?.height || 1;\n\n    return {\n      sectionId: sectionElement.getAttribute('data-showcase-section') || null,\n      sectionX: clamp01((clientX - rect.left) / sectionWidth),\n      sectionY: clamp01((clientY - rect.top) / sectionHeight)\n    };\n  }, []);\n\n  const handleAddAnnotationNote = useCallback((clientX, clientY, targetElement = null) => {\n    if (screen !== 'showcase' || !showcaseProjectContext || isAnnotationPaused) {\n      return;\n    }\n\n    const width = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const height = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const x = clamp01(clientX / width);\n    const y = clamp01(clientY / height);\n    const sourceId = currentUserDisplayName || 'session';\n    const color = registerAnnotationSource(sourceId);\n    const { sectionId, sectionX, sectionY } = resolveAnnotationTarget(clientX, clientY, targetElement);\n\n    const newNoteId = createAnnotationId();\n\n    setAnnotationNotes(prevNotes => [\n      ...prevNotes,\n      {\n        id: newNoteId,\n        x,\n        y,\n        sectionId,\n        sectionX: sectionX ?? x,\n        sectionY: sectionY ?? y,\n        text: '',\n        color,\n        contextId: activeAnnotationContextKey,\n        projectId: showcaseProjectContext.projectId || 'unknown',\n        projectName: showcaseProjectContext.projectName || '',\n        sourceId\n      }\n    ]);\n    setAutoFocusAnnotationId(newNoteId);\n  }, [\n    activeAnnotationContextKey,\n    currentUserDisplayName,\n    isAnnotationPaused,\n    registerAnnotationSource,\n    resolveAnnotationTarget,\n    screen,\n    showcaseProjectContext\n  ]);\n\n  const handleAnnotationTextChange = useCallback((noteId, text) => {\n    setAnnotationNotes(prevNotes => prevNotes.map(note => (\n      note?.id === noteId\n        ? { ...note, text }\n        : note\n    )));\n  }, []);\n\n  const handleRemoveAnnotationNote = useCallback((noteId) => {\n    setAnnotationNotes(prevNotes => prevNotes.filter(note => note?.id !== noteId));\n  }, []);\n\n  const handleToggleAnnotationMode = useCallback(() => {\n    setIsAnnotationModeEnabled(prev => {\n      const next = !prev;\n\n      if (!next) {\n        setIsAnnotationPaused(false);\n      }\n\n      return next;\n    });\n  }, []);\n\n  const handleToggleAnnotationPause = useCallback(() => {\n    setIsAnnotationPaused(prev => !prev);\n  }, []);\n\n  const downloadAnnotationFile = useCallback((notesToSave, projectName) => {\n    if (!Array.isArray(notesToSave) || notesToSave.length === 0 || typeof window === 'undefined') {\n      return;\n    }\n\n    const safeName = typeof projectName === 'string' && projectName.trim().length > 0\n      ? projectName.trim()\n      : 'projet';\n\n    const payload = JSON.stringify(notesToSave, null, 2);\n    const blob = new Blob([payload], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = `Commentaire sur le projet ${safeName}.json`;\n    anchor.click();\n    URL.revokeObjectURL(url);\n  }, []);\n\n  const handleSaveAnnotationNotes = useCallback(() => {\n    if (!showcaseProjectContext) {\n      return;\n    }\n\n    const projectNotes = annotationNotes.filter(note => note?.projectId === showcaseProjectContext.projectId);\n\n    if (projectNotes.length === 0) {\n      return;\n    }\n\n    downloadAnnotationFile(projectNotes, showcaseProjectContext.projectName);\n  }, [annotationNotes, downloadAnnotationFile, showcaseProjectContext]);\n\n  const handleRequestAnnotationFile = useCallback(() => {\n    if (annotationFileInputRef.current) {\n      annotationFileInputRef.current.value = '';\n      annotationFileInputRef.current.click();\n    }\n  }, []);\n\n  const handleAnnotationFileChange = useCallback((event) => {\n    const [file] = event?.target?.files || [];\n    const fileInput = event?.target;\n\n    if (!file) {\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = () => {\n      try {\n        const parsed = JSON.parse(reader.result || '[]');\n        const rawNotes = Array.isArray(parsed)\n          ? parsed\n          : Array.isArray(parsed?.notes)\n            ? parsed.notes\n            : [];\n\n        if (!Array.isArray(rawNotes) || rawNotes.length === 0) {\n          return;\n        }\n\n        const sourceId = file.name || `import-${Date.now()}`;\n        const sourceColor = registerAnnotationSource(sourceId);\n\n        const importedNotes = rawNotes.map(rawNote => {\n          const normalizedX = clamp01(rawNote?.x ?? 0);\n          const normalizedY = clamp01(rawNote?.y ?? 0);\n\n          return {\n            id: rawNote?.id || createAnnotationId(),\n            x: normalizedX,\n            y: normalizedY,\n            sectionId: typeof rawNote?.sectionId === 'string' ? rawNote.sectionId : null,\n            sectionX: clamp01(rawNote?.sectionX ?? normalizedX),\n            sectionY: clamp01(rawNote?.sectionY ?? normalizedY),\n            text: typeof rawNote?.text === 'string' ? rawNote.text : '',\n            color: sourceColor,\n            contextId: rawNote?.contextId || activeAnnotationContextKey,\n            projectId: rawNote?.projectId || showcaseProjectContext?.projectId || 'unknown',\n            projectName: rawNote?.projectName || showcaseProjectContext?.projectName || '',\n            sourceId\n          };\n        });\n\n        setAnnotationNotes(prevNotes => [...prevNotes, ...importedNotes]);\n      } catch (error) {\n        // Malformed file, ignore silently\n      } finally {\n        if (fileInput) {\n          fileInput.value = '';\n        }\n      }\n    };\n\n    reader.readAsText(file);\n  }, [activeAnnotationContextKey, registerAnnotationSource, showcaseProjectContext]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    if (!isAnnotationModeEnabled || isAnnotationPaused || screen !== 'showcase') {\n      return undefined;\n    }\n\n    const handleDocumentClick = (event) => {\n      const target = event?.target;\n\n      if (isAnnotationUiInteraction(event)) {\n        return;\n      }\n\n      handleAddAnnotationNote(event.clientX, event.clientY, target);\n    };\n\n    window.addEventListener('click', handleDocumentClick, true);\n\n    return () => {\n      window.removeEventListener('click', handleDocumentClick, true);\n    };\n  }, [handleAddAnnotationNote, isAnnotationModeEnabled, isAnnotationPaused, isAnnotationUiInteraction, screen]);\n\n  useEffect(() => {\n    if (!showcaseProjectContext?.projectId) {\n      return undefined;\n    }\n\n    const projectId = showcaseProjectContext.projectId;\n\n    return () => {\n      const projectNotes = (annotationNotesRef.current || []).filter(note => note?.projectId === projectId);\n\n      if (projectNotes.length > 0) {\n        downloadAnnotationFile(projectNotes, showcaseProjectNameRef.current);\n      }\n    };\n  }, [downloadAnnotationFile, showcaseProjectContext?.projectId]);\n\n  const isAdminMode = mode === 'admin';\n  const isAdminHomeView = isAdminMode && adminView === 'home';\n  const isAdminBackOfficeView = isAdminMode && adminView === 'back-office';\n  const isActiveProjectEditable = isAdminMode || !activeProject || activeProject.status === 'draft';\n  const annotationOffsetClass = isAnnotationModeEnabled && screen === 'showcase'\n    ? 'pt-20 lg:pt-24'\n    : '';\n\n  const handleAnswer = useCallback((questionId, answer) => {\n    let answerChanged = false;\n    let nextAnswersSnapshot = null;\n\n    setAnswers(prevAnswers => {\n      const previousValue = prevAnswers[questionId];\n      if (!areAnswersEqual(previousValue, answer)) {\n        answerChanged = true;\n      }\n\n      const nextAnswers = { ...prevAnswers, [questionId]: answer };\n\n      const questionsToRemove = questions\n        .filter(q => !shouldShowQuestion(q, nextAnswers))\n        .map(q => q.id);\n\n      if (questionsToRemove.length === 0) {\n        if (answerChanged) {\n          nextAnswersSnapshot = nextAnswers;\n        }\n        return answerChanged ? nextAnswers : prevAnswers;\n      }\n\n      const sanitizedAnswers = { ...nextAnswers };\n      let removedExistingAnswer = false;\n      questionsToRemove.forEach(qId => {\n        if (Object.prototype.hasOwnProperty.call(sanitizedAnswers, qId)) {\n          if (Object.prototype.hasOwnProperty.call(prevAnswers, qId)) {\n            removedExistingAnswer = true;\n          }\n          delete sanitizedAnswers[qId];\n        }\n      });\n\n      if (!answerChanged) {\n        if (removedExistingAnswer) {\n          answerChanged = true;\n        } else {\n          const prevKeys = Object.keys(prevAnswers);\n          const nextKeys = Object.keys(sanitizedAnswers);\n          if (prevKeys.length !== nextKeys.length) {\n            answerChanged = true;\n          } else if (nextKeys.some(key => !areAnswersEqual(prevAnswers[key], sanitizedAnswers[key]))) {\n            answerChanged = true;\n          }\n        }\n      }\n\n      if (answerChanged) {\n        nextAnswersSnapshot = sanitizedAnswers;\n      }\n\n      return answerChanged ? sanitizedAnswers : prevAnswers;\n    });\n\n    if (!answerChanged || !nextAnswersSnapshot) {\n      setValidationError(prev => {\n        if (!prev) return null;\n        return prev.questionId === questionId ? null : prev;\n      });\n      return;\n    }\n\n    setHasUnsavedChanges(true);\n\n    const updatedAnalysis = Object.keys(nextAnswersSnapshot).length > 0\n      ? analyzeAnswers(nextAnswersSnapshot, rules, riskLevelRules, riskWeights)\n      : null;\n\n    setAnalysis(updatedAnalysis);\n\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswersSnapshot));\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => isAnswerProvided(nextAnswersSnapshot[question.id])).length\n      : Object.keys(nextAnswersSnapshot).length;\n    const inferredName = extractProjectName(nextAnswersSnapshot, questions);\n    const normalizedInferredName = typeof inferredName === 'string' ? inferredName.trim() : '';\n\n    if (activeProjectId && isActiveProjectEditable) {\n      setProjects(prevProjects => {\n        const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n        if (projectIndex === -1) {\n          return prevProjects;\n        }\n\n        const project = prevProjects[projectIndex];\n        if (!project) {\n          return prevProjects;\n        }\n\n        const canUpdateProject = project.status === 'draft' || isAdminMode;\n        if (!canUpdateProject) {\n          return prevProjects;\n        }\n\n        const totalQuestions = relevantQuestions.length > 0\n          ? relevantQuestions.length\n          : project.totalQuestions || questions.length || 0;\n        const sanitizedName = normalizedInferredName.length > 0\n          ? normalizedInferredName\n          : project.projectName;\n        const lastQuestionIndex = totalQuestions > 0\n          ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n          : project.lastQuestionIndex ?? 0;\n\n        const updatedProject = {\n          ...project,\n          answers: nextAnswersSnapshot,\n          analysis: updatedAnalysis,\n          projectName: sanitizedName,\n          totalQuestions,\n          answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n          lastQuestionIndex,\n          lastUpdated: new Date().toISOString()\n        };\n\n        const nextProjects = prevProjects.slice();\n        nextProjects[projectIndex] = updatedProject;\n        return nextProjects;\n      });\n    }\n\n    setValidationError(prev => {\n      if (!prev) return null;\n      return prev.questionId === questionId ? null : prev;\n    });\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion\n  ]);\n\n  const handleUpdateAnswers = useCallback((updates) => {\n    if (!isActiveProjectEditable) {\n      return;\n    }\n\n    let sanitizedResult = null;\n\n    setAnswers(prevAnswers => {\n      const { nextAnswers, changed } = applyAnswerUpdates(prevAnswers, updates, questions, shouldShowQuestion);\n      if (!changed) {\n        return prevAnswers;\n      }\n      sanitizedResult = nextAnswers;\n      return nextAnswers;\n    });\n\n    if (sanitizedResult) {\n      const updatedAnalysis = analyzeAnswers(sanitizedResult, rules, riskLevelRules, riskWeights);\n      setAnalysis(updatedAnalysis);\n      setValidationError(null);\n      setHasUnsavedChanges(true);\n\n      if (activeProjectId) {\n        setProjects(prevProjects => {\n          const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n          if (projectIndex === -1) {\n            return prevProjects;\n          }\n\n          const project = prevProjects[projectIndex];\n          if (!project) {\n            return prevProjects;\n          }\n\n          const canUpdateProject = project.status === 'draft' || isAdminMode;\n          if (!canUpdateProject) {\n            return prevProjects;\n          }\n\n          const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedResult));\n          const totalQuestions = relevantQuestions.length > 0\n            ? relevantQuestions.length\n            : project.totalQuestions || questions.length || 0;\n          const answeredQuestionsCount = relevantQuestions.length > 0\n            ? relevantQuestions.filter(question => isAnswerProvided(sanitizedResult[question.id])).length\n            : Object.keys(sanitizedResult).length;\n          const inferredName = extractProjectName(sanitizedResult, questions);\n          const sanitizedName = inferredName && inferredName.trim().length > 0\n            ? inferredName.trim()\n            : project.projectName;\n          const lastQuestionIndex = totalQuestions > 0\n            ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n            : project.lastQuestionIndex ?? 0;\n\n          const updatedProject = {\n            ...project,\n            answers: sanitizedResult,\n            analysis: updatedAnalysis,\n            projectName: sanitizedName,\n            totalQuestions,\n            answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n            lastQuestionIndex,\n            lastUpdated: new Date().toISOString()\n          };\n\n          const nextProjects = prevProjects.slice();\n          nextProjects[projectIndex] = updatedProject;\n          return nextProjects;\n        });\n      }\n    }\n  }, [\n    activeProjectId,\n    analyzeAnswers,\n    extractProjectName,\n    isActiveProjectEditable,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const handleUpdateComplianceComments = useCallback((updates) => {\n    if (!activeProjectId || !updates || typeof updates !== 'object') {\n      return;\n    }\n\n    let sanitizedResult = null;\n\n    setAnswers(prevAnswers => {\n      const nextAnswers = { ...prevAnswers };\n      Object.entries(updates).forEach(([key, value]) => {\n        if (value === null || value === undefined) {\n          delete nextAnswers[key];\n        } else {\n          nextAnswers[key] = value;\n        }\n      });\n      sanitizedResult = nextAnswers;\n      return nextAnswers;\n    });\n\n    if (sanitizedResult) {\n      setHasUnsavedChanges(true);\n      setProjects(prevProjects => {\n        const projectIndex = prevProjects.findIndex(project => project.id === activeProjectId);\n        if (projectIndex === -1) {\n          return prevProjects;\n        }\n\n        const project = prevProjects[projectIndex];\n        if (!project) {\n          return prevProjects;\n        }\n\n        const updatedProject = {\n          ...project,\n          answers: sanitizedResult,\n          lastUpdated: new Date().toISOString()\n        };\n\n        const nextProjects = prevProjects.slice();\n        nextProjects[projectIndex] = updatedProject;\n        return nextProjects;\n      });\n    }\n  }, [activeProjectId, setHasUnsavedChanges]);\n\n  const handleAddSharedMember = useCallback((email) => {\n    if (!activeProjectId) {\n      return;\n    }\n\n    const normalizedEmail = normalizeEmail(email);\n    if (!normalizedEmail) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.map(project => {\n      if (project.id !== activeProjectId) {\n        return project;\n      }\n\n      const existingShared = Array.isArray(project.sharedWith) ? project.sharedWith : [];\n      const alreadyShared = existingShared.some(entry => normalizeEmail(entry) === normalizedEmail);\n      if (alreadyShared) {\n        return project;\n      }\n\n      return {\n        ...project,\n        ownerEmail: project.ownerEmail || currentUserEmail || '',\n        sharedWith: [...existingShared, normalizedEmail],\n        lastUpdated: new Date().toISOString()\n      };\n    }));\n  }, [activeProjectId, currentUserEmail]);\n\n  const handleRemoveSharedMember = useCallback((email) => {\n    if (!activeProjectId) {\n      return;\n    }\n\n    const normalizedEmail = normalizeEmail(email);\n    if (!normalizedEmail) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.map(project => {\n      if (project.id !== activeProjectId) {\n        return project;\n      }\n\n      const existingShared = Array.isArray(project.sharedWith) ? project.sharedWith : [];\n      const nextShared = existingShared.filter(entry => normalizeEmail(entry) !== normalizedEmail);\n      if (nextShared.length === existingShared.length) {\n        return project;\n      }\n\n      return {\n        ...project,\n        sharedWith: nextShared,\n        lastUpdated: new Date().toISOString()\n      };\n    }));\n  }, [activeProjectId]);\n\n  const buildDefaultAnswers = useCallback(() => {\n    if (currentUserDisplayName) {\n      return { teamLead: currentUserDisplayName };\n    }\n    return {};\n  }, [currentUserDisplayName]);\n\n  const resetProjectState = useCallback(() => {\n    setAnswers(buildDefaultAnswers());\n    setCurrentQuestionIndex(0);\n    setAnalysis(null);\n    setValidationError(null);\n    setActiveProjectId(null);\n    setHasUnsavedChanges(false);\n    setReturnToSynthesisAfterEdit(false);\n  }, [buildDefaultAnswers, setHasUnsavedChanges]);\n\n  const openBackOfficePrompt = useCallback(() => new Promise((resolve) => {\n    backOfficePromptResolverRef.current = resolve;\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    setIsBackOfficePromptOpen(true);\n  }), []);\n\n  const closeBackOfficePrompt = useCallback((result = false) => {\n    setIsBackOfficePromptOpen(false);\n    setBackOfficePromptValue('');\n    setBackOfficePromptError('');\n    const resolver = backOfficePromptResolverRef.current;\n    backOfficePromptResolverRef.current = null;\n    if (typeof resolver === 'function') {\n      resolver(result);\n    }\n  }, []);\n\n  const handleBackOfficePromptSubmit = useCallback(async (event) => {\n    event.preventDefault();\n    const trimmed = backOfficePromptValue.trim();\n    if (!trimmed) {\n      setBackOfficePromptError('Veuillez saisir un mot de passe.');\n      return;\n    }\n\n    const isValid = await verifyBackOfficePassword(trimmed);\n\n    if (isValid) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      closeBackOfficePrompt(true);\n      return;\n    }\n\n    setIsBackOfficeUnlocked(false);\n    setBackOfficeAuthError('Mot de passe incorrect. Veuillez rÃ©essayer.');\n    setBackOfficePromptError('Mot de passe incorrect. Veuillez rÃ©essayer.');\n  }, [backOfficePromptValue, closeBackOfficePrompt]);\n\n  const requestAdminAccess = useCallback(async () => {\n    if (isAdminMode) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    if (isCurrentUserAdmin) {\n      setIsBackOfficeUnlocked(true);\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    if (isBackOfficeUnlocked) {\n      setBackOfficeAuthError(null);\n      return true;\n    }\n\n    setBackOfficeAuthError(null);\n    return openBackOfficePrompt();\n  }, [\n    isAdminMode,\n    isCurrentUserAdmin,\n    isBackOfficeUnlocked,\n    openBackOfficePrompt,\n    setBackOfficeAuthError,\n    setIsBackOfficeUnlocked\n  ]);\n\n  const handleBackOfficeClick = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('back-office');\n  }, [requestAdminAccess, setMode]);\n\n  const handleActivateAdminOnHome = useCallback(async () => {\n    const hasAccess = await requestAdminAccess();\n    if (!hasAccess) {\n      return;\n    }\n\n    setMode('admin');\n    setAdminView('home');\n    setScreen('home');\n  }, [requestAdminAccess, setMode, setScreen]);\n\n  const handleReturnToProjectMode = useCallback(() => {\n    setMode('user');\n    setAdminView('home');\n    setBackOfficeAuthError(null);\n  }, [setBackOfficeAuthError, setMode]);\n\n  const handleCreateNewProject = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleStartInspirationProject = useCallback(() => {\n    setScreen('inspiration-form');\n  }, []);\n\n  const handleSaveInspirationProject = useCallback((payload) => {\n    const project = {\n      id: createInspirationId(),\n      ...payload,\n      ownerEmail: currentUserEmail || '',\n      teamLead: currentUserDisplayName || ''\n    };\n    setInspirationProjects((prev) => [project, ...(Array.isArray(prev) ? prev : [])]);\n    setHomeView('inspiration');\n    setScreen('home');\n  }, [currentUserDisplayName, currentUserEmail]);\n\n  const handleOpenInspirationProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n    setActiveInspirationId(projectId);\n    setScreen('inspiration-detail');\n  }, []);\n\n  const handleUpdateInspirationProject = useCallback((projectId, updates) => {\n    if (!projectId || !updates) {\n      return;\n    }\n\n    setInspirationProjects((prev) => (Array.isArray(prev) ? prev : []).map((project) => {\n      if (!project || project.id !== projectId) {\n        return project;\n      }\n\n      return { ...project, ...updates };\n    }));\n  }, []);\n\n  const handleExportInspirationProject = useCallback((project) => {\n    if (!project) {\n      return;\n    }\n\n    exportInspirationToFile(project);\n  }, []);\n\n  const handleImportProject = useCallback((file) => {\n    if (!file) {\n      return;\n    }\n\n    if (typeof FileReader === 'undefined') {\n      if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n        console.warn('[projectImport] FileReader API indisponible dans cet environnement.');\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Votre navigateur ne permet pas d\\'importer un projet depuis un fichier.');\n      }\n      return;\n    }\n\n    const reader = new FileReader();\n\n    reader.onload = (event) => {\n      try {\n        const content = typeof event?.target?.result === 'string' ? event.target.result : '';\n\n        if (!content) {\n          throw new Error('EMPTY_FILE');\n        }\n\n        const parsed = JSON.parse(content);\n        const projectData = parsed?.project && typeof parsed.project === 'object' ? parsed.project : parsed;\n\n        if (!projectData || typeof projectData !== 'object') {\n          throw new Error('INVALID_PROJECT');\n        }\n\n        const importedAnswers = projectData.answers && typeof projectData.answers === 'object'\n          ? projectData.answers\n          : {};\n        const importedAnalysis = projectData.analysis && typeof projectData.analysis === 'object'\n          ? projectData.analysis\n          : null;\n        const importedName = typeof projectData.name === 'string' ? projectData.name.trim() : '';\n        const projectName = importedName.length > 0 ? importedName : 'Projet importÃ©';\n        const importedTotalQuestions = Array.isArray(projectData?.questionnaire?.questionIds)\n          ? projectData.questionnaire.questionIds.length\n          : undefined;\n\n        const entry = handleSaveProject({\n          id: `project-${Date.now()}`,\n          projectName,\n          answers: importedAnswers,\n          analysis: importedAnalysis,\n          status: 'draft',\n          totalQuestions: importedTotalQuestions,\n          lastQuestionIndex: 0\n        });\n\n        if (!entry) {\n          throw new Error('SAVE_FAILED');\n        }\n\n        const relevantQuestions = questions.filter(question => shouldShowQuestion(question, importedAnswers));\n        const missingMandatory = relevantQuestions.filter(question => question.required && !isAnswerProvided(importedAnswers[question.id]));\n        const firstMissingId = missingMandatory[0]?.id;\n        const derivedAnalysis = entry.analysis\n          || (Object.keys(importedAnswers).length > 0 ? analyzeAnswers(importedAnswers, rules, riskLevelRules, riskWeights) : null);\n\n        const nextIndex = firstMissingId\n          ? Math.max(relevantQuestions.findIndex(question => question.id === firstMissingId), 0)\n          : relevantQuestions.length > 0\n            ? Math.min(entry.lastQuestionIndex ?? 0, relevantQuestions.length - 1)\n            : 0;\n        const hasPendingMandatory = missingMandatory.length > 0;\n\n        setAnswers(importedAnswers);\n        setAnalysis(derivedAnalysis);\n        setCurrentQuestionIndex(nextIndex);\n        setValidationError(null);\n        setActiveProjectId(entry.id);\n        setScreen('synthesis');\n        setSaveFeedback({\n          status: 'success',\n          message: hasPendingMandatory\n            ? 'Projet importÃ©. La synthÃ¨se est disponible. ComplÃ©tez les questions obligatoires avant de soumettre.'\n            : 'Projet importÃ©. La synthÃ¨se est disponible.'\n        });\n        setHasUnsavedChanges(false);\n      } catch (error) {\n        if (typeof console !== 'undefined' && typeof console.error === 'function') {\n          console.error('[projectImport] Impossible de charger le projet :', error);\n        }\n        if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n          window.alert('Le fichier sÃ©lectionnÃ© est invalide. Veuillez vÃ©rifier le JSON exportÃ©.');\n        }\n      }\n    };\n\n    reader.onerror = () => {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Ã‰chec de la lecture du fichier :', reader.error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Impossible de lire le fichier sÃ©lectionnÃ©. Veuillez rÃ©essayer.');\n      }\n    };\n\n    try {\n      reader.readAsText(file, 'utf-8');\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectImport] Erreur inattendue lors de la lecture du fichier :', error);\n      }\n      if (typeof window !== 'undefined' && typeof window.alert === 'function') {\n        window.alert('Une erreur est survenue lors de l\\'import du projet.');\n      }\n    }\n  }, [\n    handleSaveProject,\n    setHasUnsavedChanges,\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    shouldShowQuestion,\n    analyzeAnswers\n  ]);\n\n  const navigateToSynthesis = useCallback(() => {\n    const result = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n    setAnalysis(result);\n    setValidationError(null);\n    setReturnToSynthesisAfterEdit(false);\n    setScreen('synthesis');\n  }, [analyzeAnswers, answers, riskLevelRules, riskWeights, rules]);\n\n  const handleNext = useCallback(() => {\n    if (currentQuestionIndex < activeQuestions.length - 1) {\n      setCurrentQuestionIndex(currentQuestionIndex + 1);\n      setValidationError(null);\n      return;\n    }\n\n    navigateToSynthesis();\n  }, [activeQuestions, currentQuestionIndex, navigateToSynthesis]);\n\n  const handleBack = useCallback(() => {\n    if (currentQuestionIndex > 0) {\n      setCurrentQuestionIndex(currentQuestionIndex - 1);\n    }\n    setValidationError(null);\n  }, [currentQuestionIndex]);\n\n  const handleRestart = useCallback(() => {\n    resetProjectState();\n    setScreen('questionnaire');\n  }, [resetProjectState]);\n\n  const handleOpenProject = useCallback((projectId, options = {}) => {\n    if (!projectId) {\n      return;\n    }\n\n    const project = projects.find(item => item.id === projectId);\n    if (!project) {\n      return;\n    }\n\n    const projectAnswers = project.answers || {};\n    const derivedQuestions = questions.filter(q => shouldShowQuestion(q, projectAnswers));\n    const derivedAnalysis = Object.keys(projectAnswers).length > 0\n      ? analyzeAnswers(projectAnswers, rules, riskLevelRules, riskWeights)\n      : null;\n    const answeredQuestionsCount = derivedQuestions.length > 0\n      ? derivedQuestions.filter(question => isAnswerProvided(projectAnswers[question.id])).length\n      : Object.keys(projectAnswers).length;\n    const missingMandatory = derivedQuestions.filter(question => question.required && !isAnswerProvided(projectAnswers[question.id]));\n    const totalQuestions = derivedQuestions.length;\n    const rawIndex = typeof project.lastQuestionIndex === 'number' ? project.lastQuestionIndex : 0;\n    const sanitizedIndex = totalQuestions > 0 ? Math.min(Math.max(rawIndex, 0), totalQuestions - 1) : 0;\n    const firstMissingId = missingMandatory[0]?.id;\n    const missingIndex = firstMissingId\n      ? derivedQuestions.findIndex(question => question.id === firstMissingId)\n      : -1;\n    const startingIndex = missingIndex >= 0 ? missingIndex : project.status === 'draft' ? sanitizedIndex : 0;\n\n    setAnswers(projectAnswers);\n    setAnalysis(derivedAnalysis);\n    setCurrentQuestionIndex(startingIndex);\n    setValidationError(null);\n    setActiveProjectId(project.id);\n\n    setProjects(prevProjects => prevProjects.map(entry => {\n      if (entry.id !== project.id) {\n        return entry;\n      }\n\n      return {\n        ...entry,\n        analysis: derivedAnalysis,\n        totalQuestions,\n        answeredQuestions: Math.min(\n          answeredQuestionsCount,\n          totalQuestions || answeredQuestionsCount\n        ),\n        lastQuestionIndex: sanitizedIndex\n      };\n    }));\n\n    const forcedView = typeof options?.view === 'string' ? options.view : null;\n\n    let targetScreen = null;\n    if (forcedView === 'synthesis' || forcedView === 'questionnaire' || forcedView === 'mandatory-summary') {\n      targetScreen = forcedView;\n    }\n\n    if (!targetScreen) {\n      targetScreen = project.status === 'draft' ? 'questionnaire' : 'synthesis';\n    }\n\n    setScreen(targetScreen);\n    setHasUnsavedChanges(false);\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    setHasUnsavedChanges,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const handleDeleteProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => prevProjects.filter(project => project.id !== projectId));\n    setActiveProjectId(prev => (prev === projectId ? null : prev));\n  }, []);\n\n  const handleDuplicateProject = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    setProjects(prevProjects => {\n      const sourceProject = prevProjects.find(project => project.id === projectId);\n      if (!sourceProject) {\n        return prevProjects;\n      }\n\n      const answersClone = sourceProject.answers && typeof sourceProject.answers === 'object'\n        ? JSON.parse(JSON.stringify(sourceProject.answers))\n        : {};\n\n      if (currentUserDisplayName) {\n        answersClone.teamLead = currentUserDisplayName;\n      }\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, answersClone));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : typeof sourceProject.totalQuestions === 'number' && sourceProject.totalQuestions > 0\n          ? sourceProject.totalQuestions\n          : questions.length;\n\n      const answeredQuestionsCount = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(answersClone[question.id])).length\n        : typeof sourceProject.answeredQuestions === 'number'\n          ? Math.min(sourceProject.answeredQuestions, totalQuestions || sourceProject.answeredQuestions)\n          : Object.keys(answersClone).length;\n\n      const computedAnalysis = Object.keys(answersClone).length > 0\n        ? analyzeAnswers(answersClone, rules, riskLevelRules, riskWeights)\n        : null;\n\n      const baseName = typeof sourceProject.projectName === 'string' && sourceProject.projectName.trim().length > 0\n        ? sourceProject.projectName.trim()\n        : 'Projet sans nom';\n      const nameWithoutCopyPrefix = baseName.replace(/^\\[Copie\\]\\s*/i, '').trim();\n      const duplicateBaseName = nameWithoutCopyPrefix.length > 0 ? nameWithoutCopyPrefix : baseName;\n\n      const duplicateEntry = {\n        id: `project-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n        projectName: `[Copie] ${duplicateBaseName}`,\n        answers: answersClone,\n        analysis: computedAnalysis,\n        status: 'draft',\n        lastUpdated: new Date().toISOString(),\n        lastQuestionIndex: 0,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n        ownerEmail: currentUserEmail || '',\n        sharedWith: []\n      };\n\n      return [duplicateEntry, ...prevProjects];\n    });\n  }, [\n    analyzeAnswers,\n    currentUserDisplayName,\n    currentUserEmail,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    shouldShowQuestion\n  ]);\n\n  const openProjectShowcase = useCallback((context = {}) => {\n    const {\n      projectId = null,\n      projectName: providedProjectName,\n      status: providedStatus,\n      answers: providedAnswers,\n      analysis: providedAnalysis,\n      relevantTeams: providedRelevantTeams,\n      questions: providedQuestions,\n      timelineDetails: providedTimelineDetails\n    } = context || {};\n\n    const project = projectId ? projects.find(item => item.id === projectId) : null;\n    const answersSource = providedAnswers || project?.answers || {};\n    const visibleQuestions = Array.isArray(providedQuestions) && providedQuestions.length > 0\n      ? providedQuestions\n      : questions.filter(question => shouldShowQuestion(question, answersSource));\n    const computedAnalysis = providedAnalysis\n      || (Object.keys(answersSource).length > 0\n        ? analyzeAnswers(answersSource, rules, riskLevelRules, riskWeights)\n        : null);\n    const relevantTeamsList = Array.isArray(providedRelevantTeams) && providedRelevantTeams.length > 0\n      ? providedRelevantTeams\n      : teams.filter(team => (computedAnalysis?.teams || []).includes(team.id));\n    const timelineDetailsList = Array.isArray(providedTimelineDetails)\n      ? providedTimelineDetails\n      : computedAnalysis?.timeline?.details || [];\n\n    const normalizedProjectName = typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : (typeof project?.projectName === 'string' && project.projectName.trim().length > 0\n        ? project.projectName.trim()\n        : extractProjectName(answersSource, questions));\n\n    const resolvedProjectName = normalizedProjectName && normalizedProjectName.length > 0\n      ? normalizedProjectName\n      : 'Projet sans nom';\n    const resolvedStatus = providedStatus || project?.status || 'draft';\n\n    const answeredQuestionsCount = visibleQuestions.length > 0\n      ? visibleQuestions.filter(question => isAnswerProvided(answersSource[question.id])).length\n      : Object.keys(answersSource).length;\n\n    const hasShowcaseIncompleteAnswers = visibleQuestions.length > 0\n      ? visibleQuestions.some(\n        question => question.required && !isAnswerProvided(answersSource[question.id])\n      )\n      : Object.keys(answersSource).length === 0;\n\n    const totalQuestions = visibleQuestions.length > 0\n      ? visibleQuestions.length\n      : project?.totalQuestions || questions.length || 0;\n\n    if (projectId) {\n      setProjects(prevProjects => prevProjects.map(entry => {\n        if (entry.id !== projectId) {\n          return entry;\n        }\n\n        return {\n          ...entry,\n          analysis: computedAnalysis,\n          totalQuestions,\n          answeredQuestions: Math.min(\n            answeredQuestionsCount,\n            totalQuestions || answeredQuestionsCount\n          )\n        };\n      }));\n    }\n\n    const pendingShowcaseMode = pendingShowcaseDisplayModeRef.current;\n    const resolvedShowcaseMode = resolveShowcaseDisplayMode(pendingShowcaseMode) || 'full';\n    const pendingSharedView = Boolean(pendingShowcaseSharedRef.current);\n    const pendingComments = Boolean(pendingShowcaseCommentsRef.current);\n    const resolvedDisplayModeLock = pendingSharedView\n      ? resolvedShowcaseMode\n      : resolvedShowcaseMode === 'light'\n        ? 'light'\n        : null;\n\n    pendingShowcaseDisplayModeRef.current = null;\n    pendingShowcaseSharedRef.current = false;\n    pendingShowcaseCommentsRef.current = false;\n    setShowcaseDisplayMode(resolvedShowcaseMode);\n    setShowcaseDisplayModeLock(resolvedDisplayModeLock);\n    setIsShowcaseSharedView(pendingSharedView);\n    setShowcaseCommentsEnabled(pendingComments);\n\n    setShowcaseProjectContext({\n      projectId: projectId || null,\n      projectName: resolvedProjectName,\n      status: resolvedStatus,\n      answers: answersSource,\n      analysis: computedAnalysis,\n      relevantTeams: relevantTeamsList,\n      questions: visibleQuestions.length > 0 ? visibleQuestions : questions,\n      timelineDetails: timelineDetailsList,\n      hasIncompleteAnswers: hasShowcaseIncompleteAnswers\n    });\n    previousScreenRef.current = screen;\n    setScreen('showcase');\n  }, [\n    analyzeAnswers,\n    projects,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    screen,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  useEffect(() => {\n    if (!isHydrated) {\n      return;\n    }\n\n    const pendingProjectId = pendingShowcaseProjectIdRef.current;\n    if (!pendingProjectId) {\n      return;\n    }\n\n    const matchingProject = projects.find(project => project?.id === pendingProjectId);\n    if (!matchingProject) {\n      return;\n    }\n\n    pendingShowcaseProjectIdRef.current = null;\n    openProjectShowcase({ projectId: pendingProjectId });\n  }, [isHydrated, openProjectShowcase, projects]);\n\n  const handleShowProjectShowcase = useCallback((projectId) => {\n    if (!projectId) {\n      return;\n    }\n\n    openProjectShowcase({ projectId });\n  }, [openProjectShowcase]);\n\n  const handleOpenActiveProjectShowcase = useCallback((payload = {}) => {\n    const projectId = payload?.projectId || activeProjectId || null;\n\n    openProjectShowcase({\n      ...payload,\n      projectId\n    });\n  }, [activeProjectId, openProjectShowcase]);\n\n  const handleCloseProjectShowcase = useCallback(() => {\n    setShowcaseProjectContext(null);\n    setShowcaseDisplayMode('full');\n    setShowcaseDisplayModeLock(null);\n    setIsShowcaseSharedView(false);\n    setShowcaseCommentsEnabled(false);\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('home');\n    }\n    previousScreenRef.current = null;\n  }, []);\n\n  const handleReturnToComplianceReport = useCallback(() => {\n    if (showcaseProjectContext?.projectId) {\n      const { projectId } = showcaseProjectContext;\n      setShowcaseProjectContext(null);\n      setIsShowcaseSharedView(false);\n      setShowcaseCommentsEnabled(false);\n      previousScreenRef.current = null;\n      handleOpenProject(projectId, { view: 'synthesis' });\n      return;\n    }\n\n    setShowcaseProjectContext(null);\n    setIsShowcaseSharedView(false);\n    setShowcaseCommentsEnabled(false);\n\n    if (previousScreenRef.current) {\n      setScreen(previousScreenRef.current);\n    } else {\n      setScreen('synthesis');\n    }\n\n    previousScreenRef.current = null;\n  }, [handleOpenProject, showcaseProjectContext, setScreen]);\n\n  const handleUpdateProjectShowcaseAnswers = useCallback((updates) => {\n    if (\n      !showcaseProjectContext ||\n      !showcaseProjectContext.projectId ||\n      (showcaseProjectContext.status !== 'draft' && !isAdminMode)\n    ) {\n      return;\n    }\n\n    const projectId = showcaseProjectContext.projectId;\n    let contextPatch = null;\n    let hasProjectChanges = false;\n\n    setProjects(prevProjects => {\n      const project = prevProjects.find(entry => entry.id === projectId);\n      if (!project || (project.status !== 'draft' && !isAdminMode)) {\n        return prevProjects;\n      }\n\n      const { nextAnswers, changed } = applyAnswerUpdates(\n        project.answers || {},\n        updates,\n        questions,\n        shouldShowQuestion,\n        {\n          shouldPreserveQuestion: (question) => !question?.showcase\n        }\n      );\n      if (!changed) {\n        return prevProjects;\n      }\n\n      hasProjectChanges = true;\n\n      const relevantQuestions = questions.filter(question => shouldShowQuestion(question, nextAnswers));\n      const totalQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.length\n        : project.totalQuestions || questions.length || 0;\n      const answeredQuestions = relevantQuestions.length > 0\n        ? relevantQuestions.filter(question => isAnswerProvided(nextAnswers[question.id])).length\n        : Object.keys(nextAnswers).length;\n\n      const updatedAnalysis = analyzeAnswers(nextAnswers, rules, riskLevelRules, riskWeights);\n      const timelineDetails = updatedAnalysis?.timeline?.details || [];\n      const relevantTeamsIds = Array.isArray(updatedAnalysis?.teams) ? updatedAnalysis.teams : [];\n      const relevantTeams = teams.filter(team => relevantTeamsIds.includes(team.id));\n      const inferredName = extractProjectName(nextAnswers, questions);\n      const sanitizedName = inferredName && inferredName.trim().length > 0\n        ? inferredName.trim()\n        : project.projectName;\n\n      const lastQuestionIndex = totalQuestions > 0\n        ? Math.min(Math.max(project.lastQuestionIndex ?? totalQuestions - 1, 0), totalQuestions - 1)\n        : project.lastQuestionIndex ?? 0;\n\n      contextPatch = {\n        projectName: sanitizedName,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        relevantTeams,\n        timelineDetails,\n        questions: relevantQuestions.length > 0 ? relevantQuestions : null\n      };\n\n      const now = new Date().toISOString();\n\n      const updatedProject = {\n        ...project,\n        answers: nextAnswers,\n        analysis: updatedAnalysis,\n        projectName: sanitizedName,\n        totalQuestions,\n        answeredQuestions: Math.min(answeredQuestions, totalQuestions || answeredQuestions),\n        lastQuestionIndex,\n        lastUpdated: now\n      };\n\n      return [updatedProject, ...prevProjects.filter(entry => entry.id !== projectId)];\n    });\n\n    if (contextPatch) {\n      setShowcaseProjectContext(prev => {\n        if (!prev || prev.projectId !== projectId) {\n          return prev;\n        }\n\n        return {\n          ...prev,\n          ...contextPatch,\n          questions: contextPatch.questions ? contextPatch.questions : prev.questions\n        };\n      });\n    }\n\n    if (hasProjectChanges) {\n      setHasUnsavedChanges(true);\n    }\n  }, [\n    analyzeAnswers,\n    extractProjectName,\n    isAdminMode,\n    setHasUnsavedChanges,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    showcaseProjectContext,\n    shouldShowQuestion,\n    teams\n  ]);\n\n  const upsertProject = useCallback((entry) => {\n    return prevProjects => {\n      if (!entry || !entry.id) {\n        return prevProjects;\n      }\n\n      const filtered = prevProjects.filter(project => project.id !== entry.id);\n      return [entry, ...filtered];\n    };\n  }, []);\n\n  const handleSaveProject = useCallback((payload = {}) => {\n    const baseAnswers = payload.answers && typeof payload.answers === 'object' ? payload.answers : answers;\n    const sanitizedAnswers = baseAnswers || {};\n    const status = payload.status === 'submitted' ? 'submitted' : 'draft';\n    const projectId = activeProjectId || payload.id || `project-${Date.now()}`;\n    const relevantQuestions = questions.filter(question => shouldShowQuestion(question, sanitizedAnswers));\n    const existingProject = projects.find(project => project?.id === projectId);\n    const computedTotalQuestions = payload.totalQuestions\n      || (relevantQuestions.length > 0 ? relevantQuestions.length : activeQuestions.length);\n    const totalQuestions = computedTotalQuestions > 0 ? computedTotalQuestions : activeQuestions.length;\n    const answeredQuestionsCount = relevantQuestions.length > 0\n      ? relevantQuestions.filter(question => {\n        const value = sanitizedAnswers[question.id];\n        if (Array.isArray(value)) {\n          return value.length > 0;\n        }\n        if (typeof value === 'string') {\n          return value.trim().length > 0;\n        }\n        return value !== null && value !== undefined;\n      }).length\n      : Object.keys(sanitizedAnswers).length;\n    const now = new Date().toISOString();\n\n    let computedAnalysis = null;\n    if (payload.analysis && typeof payload.analysis === 'object') {\n      computedAnalysis = payload.analysis;\n    } else if (Object.keys(sanitizedAnswers).length > 0) {\n      computedAnalysis = analyzeAnswers(sanitizedAnswers, rules, riskLevelRules, riskWeights);\n    }\n\n    if (status === 'submitted' && !computedAnalysis) {\n      return null;\n    }\n\n    const inferredName = extractProjectName(sanitizedAnswers, questions);\n    const projectNameRaw = typeof payload.projectName === 'string' ? payload.projectName : inferredName;\n    const sanitizedName =\n      projectNameRaw && projectNameRaw.trim().length > 0 ? projectNameRaw.trim() : 'Projet sans nom';\n\n    let lastQuestionIndex =\n      typeof payload.lastQuestionIndex === 'number' ? payload.lastQuestionIndex : currentQuestionIndex;\n    if (status === 'submitted' && totalQuestions > 0) {\n      lastQuestionIndex = totalQuestions - 1;\n    }\n\n    const clampedLastIndex = totalQuestions > 0\n      ? Math.min(Math.max(lastQuestionIndex, 0), totalQuestions - 1)\n      : 0;\n\n    const entry = {\n      id: projectId,\n      projectName: sanitizedName,\n      answers: sanitizedAnswers,\n      analysis: computedAnalysis,\n      status,\n      lastUpdated: now,\n      lastQuestionIndex: clampedLastIndex,\n      totalQuestions,\n      answeredQuestions: Math.min(answeredQuestionsCount, totalQuestions || answeredQuestionsCount),\n      ownerEmail: existingProject?.ownerEmail || currentUserEmail || '',\n      sharedWith: Array.isArray(existingProject?.sharedWith) ? existingProject.sharedWith : []\n    };\n\n    if (status === 'submitted') {\n      entry.submittedAt = now;\n    }\n\n    setProjects(upsertProject(entry));\n    setActiveProjectId(projectId);\n\n    if (computedAnalysis) {\n      setAnalysis(computedAnalysis);\n    }\n\n    setHasUnsavedChanges(false);\n\n    return entry;\n  }, [\n    activeProjectId,\n    activeQuestions.length,\n    analyzeAnswers,\n    answers,\n    currentQuestionIndex,\n    currentUserEmail,\n    extractProjectName,\n    projects,\n    questions,\n    riskLevelRules,\n    riskWeights,\n    rules,\n    setHasUnsavedChanges,\n    shouldShowQuestion,\n    upsertProject\n  ]);\n\n  const handleSubmitProject = useCallback((payload = {}) => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      setSaveFeedback({\n        status: 'error',\n        message: 'Impossible de soumettre : complÃ©tez les questions obligatoires avant lâ€™envoi.'\n      });\n      setScreen('synthesis');\n      return null;\n    }\n\n    const entry = handleSaveProject({ ...payload, status: 'submitted' });\n    if (entry) {\n      setValidationError(null);\n      setScreen('home');\n    }\n  }, [handleSaveProject, unansweredMandatoryQuestions]);\n\n  const handleSaveDraft = useCallback((payload = {}) => {\n    const { lastQuestionIndex: payloadLastQuestionIndex, ...otherPayload } = payload || {};\n\n    const entry = handleSaveProject({\n      ...otherPayload,\n      lastQuestionIndex:\n        typeof payloadLastQuestionIndex === 'number'\n          ? payloadLastQuestionIndex\n          : currentQuestionIndex,\n      status: 'draft'\n    });\n\n    if (entry) {\n      setValidationError(null);\n\n      const exported = exportProjectToFile({\n        projectName: entry.projectName,\n        answers: entry.answers\n      });\n\n      setSaveFeedback(\n        exported\n          ? {\n              status: 'success',\n              message: 'Votre projet a bien Ã©tÃ© enregistrÃ© dans vos tÃ©lÃ©chargements'\n            }\n          : {\n              status: 'error',\n              message: 'Projet enregistrÃ© mais le tÃ©lÃ©chargement a Ã©chouÃ©. Veuillez rÃ©essayer.'\n            }\n      );\n    }\n  }, [currentQuestionIndex, handleSaveProject]);\n\n  const handleDismissSaveFeedback = useCallback(() => {\n    setSaveFeedback(null);\n  }, []);\n\n  const handleBackToQuestionnaire = useCallback(() => {\n    if (unansweredMandatoryQuestions.length > 0) {\n      const firstMissingId = unansweredMandatoryQuestions[0].id;\n      const targetIndex = activeQuestions.findIndex(question => question.id === firstMissingId);\n      if (targetIndex >= 0) {\n        setCurrentQuestionIndex(targetIndex);\n      }\n    } else if (activeQuestions.length > 0) {\n      const lastIndex = activeQuestions.length - 1;\n      setCurrentQuestionIndex(prevIndex => {\n        if (prevIndex > lastIndex) {\n          return lastIndex;\n        }\n        return prevIndex;\n      });\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions, unansweredMandatoryQuestions]);\n\n  const handleNavigateToQuestion = useCallback((questionId) => {\n    const targetIndex = activeQuestions.findIndex(question => question.id === questionId);\n    if (targetIndex >= 0) {\n      setCurrentQuestionIndex(targetIndex);\n    }\n    setValidationError(null);\n    setScreen('questionnaire');\n  }, [activeQuestions]);\n\n  const handleNavigateToQuestionFromReport = useCallback((questionId) => {\n    setReturnToSynthesisAfterEdit(true);\n    handleNavigateToQuestion(questionId);\n  }, [handleNavigateToQuestion]);\n\n  const handleReturnToSynthesisFromQuestionnaire = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const handleProceedToSynthesis = useCallback(() => {\n    navigateToSynthesis();\n  }, [navigateToSynthesis]);\n\n  const showcaseProjectId = showcaseProjectContext?.projectId || '';\n  const buildShowcaseShareUrl = useCallback((shareMode) => {\n    if (!showcaseProjectId || typeof window === 'undefined') {\n      return '';\n    }\n\n    const url = new URL(window.location.href);\n    url.searchParams.set('projectId', showcaseProjectId);\n    url.searchParams.set('showcaseShared', '1');\n    if (showcaseShareCommentsEnabled) {\n      url.searchParams.set('showcaseComments', '1');\n    } else {\n      url.searchParams.delete('showcaseComments');\n    }\n    if (shareMode === 'light') {\n      url.searchParams.set('showcaseMode', 'light');\n    } else {\n      url.searchParams.delete('showcaseMode');\n    }\n    url.hash = `showcase=${showcaseProjectId}`;\n    return url.toString();\n  }, [showcaseProjectId, showcaseShareCommentsEnabled]);\n\n  const showcaseShareUrl = useMemo(\n    () => buildShowcaseShareUrl(showcaseShareMode),\n    [buildShowcaseShareUrl, showcaseShareMode]\n  );\n\n  const handleOpenShowcaseShare = useCallback(() => {\n    if (!showcaseProjectId) {\n      return;\n    }\n\n    setShowcaseShareMode(showcaseDisplayMode === 'light' ? 'light' : 'full');\n    setShowcaseShareCommentsEnabled(false);\n    setIsShowcaseShareOpen(true);\n    setShowcaseShareFeedback('');\n  }, [showcaseDisplayMode, showcaseProjectId]);\n\n  const handleCloseShowcaseShare = useCallback(() => {\n    setIsShowcaseShareOpen(false);\n    setShowcaseShareFeedback('');\n  }, []);\n\n  useEffect(() => {\n    if (!isShowcaseShareOpen) {\n      return;\n    }\n\n    if (showcaseShareInputRef.current && typeof showcaseShareInputRef.current.focus === 'function') {\n      showcaseShareInputRef.current.focus();\n    }\n  }, [isShowcaseShareOpen]);\n\n  const handleCopyShowcaseLink = useCallback(async () => {\n    if (!showcaseShareUrl) {\n      return;\n    }\n\n    try {\n      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {\n        await navigator.clipboard.writeText(showcaseShareUrl);\n        setShowcaseShareFeedback('Lien copiÃ© dans le presse-papiers.');\n        return;\n      }\n    } catch (error) {\n      // Fallback below.\n    }\n\n    if (typeof document !== 'undefined') {\n      const input = document.getElementById('showcase-share-link');\n      if (input && typeof input.select === 'function') {\n        input.select();\n        const copied = document.execCommand && document.execCommand('copy');\n        if (copied) {\n          setShowcaseShareFeedback('Lien copiÃ© dans le presse-papiers.');\n          return;\n        }\n      }\n    }\n\n    setShowcaseShareFeedback('Impossible de copier automatiquement le lien.');\n  }, [showcaseShareUrl]);\n\n  const handleDownloadShowcaseShortcut = useCallback(() => {\n    if (!showcaseShareUrl || typeof window === 'undefined') {\n      return;\n    }\n\n    const shortcutContent = `[InternetShortcut]\\nURL=${showcaseShareUrl}\\n`;\n    const blob = new Blob([shortcutContent], { type: 'text/plain' });\n    const fileName = `raccourci-showcase-${showcaseProjectId || 'projet'}.url`;\n    const downloadUrl = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n\n    anchor.href = downloadUrl;\n    anchor.download = fileName;\n    document.body.appendChild(anchor);\n    anchor.click();\n    anchor.remove();\n    URL.revokeObjectURL(downloadUrl);\n    setShowcaseShareFeedback('Raccourci tÃ©lÃ©chargÃ©.');\n  }, [showcaseProjectId, showcaseShareUrl]);\n\n  return (\n    <div className={`min-h-screen ${annotationOffsetClass}`}>\n      <AnnotationLayer\n        isActive={isAnnotationModeEnabled && screen === 'showcase'}\n        isPaused={isAnnotationPaused}\n        isEditing={isShowcaseEditing}\n        hideToolbar={isOnboardingActive && onboardingStepId === 'showcase-back-to-report'}\n        notes={annotationNotes}\n        activeContextId={activeAnnotationContextKey}\n        sourceColors={annotationSources}\n        projectName={showcaseProjectContext?.projectName || ''}\n        autoFocusNoteId={autoFocusAnnotationId}\n        onAutoFocusComplete={() => setAutoFocusAnnotationId(null)}\n        onTogglePause={handleToggleAnnotationPause}\n        onRequestSave={handleSaveAnnotationNotes}\n        onRequestLoad={handleRequestAnnotationFile}\n        onExit={handleToggleAnnotationMode}\n        onNoteChange={handleAnnotationTextChange}\n        onNoteRemove={handleRemoveAnnotationNote}\n      />\n\n      <input\n        ref={annotationFileInputRef}\n        type=\"file\"\n        accept=\"application/json\"\n        className=\"sr-only\"\n        onChange={handleAnnotationFileChange}\n        data-annotation-ui=\"true\"\n      />\n\n      <div id=\"tour-onboarding-anchor\" className=\"sr-only\" aria-hidden=\"true\">\n        Guide interactif\n      </div>\n      <nav className=\"bg-white shadow-sm border-b border-gray-200 hv-surface\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-8 py-4\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-lg font-bold text-gray-800 sm:text-xl\">Project Navigator</h1>\n                <p className=\"text-xs text-gray-500\">Outil d'aide Ã  la dÃ©cision</p>\n              </div>\n            </div>\n\n            <div\n              className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 lg:justify-end\"\n              role=\"group\"\n              aria-label=\"SÃ©lection du mode d'utilisation\"\n            >\n              {screen === 'showcase' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleToggleAnnotationMode}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex h-10 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      isAnnotationModeEnabled ? 'bg-blue-50 border-blue-200' : 'bg-white border-blue-100'\n                    }`}\n                    aria-pressed={isAnnotationModeEnabled}\n                    aria-label={isAnnotationModeEnabled ? 'DÃ©sactiver le mode annotation' : 'Activer le mode annotation'}\n                    title={isAnnotationModeEnabled ? 'DÃ©sactiver le mode annotation' : 'Activer le mode annotation'}\n                    data-annotation-ui=\"true\"\n                  >\n                    <MessageSquare className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Annotation</span>\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleOpenShowcaseShare}\n                    className={`order-first self-start sm:order-last sm:self-center inline-flex h-10 px-4 items-center justify-center rounded-full border text-blue-700 shadow-sm transition hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${\n                      showcaseProjectId ? 'bg-white border-blue-100' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'\n                    }`}\n                    aria-label=\"Partager la vitrine du projet\"\n                    title={showcaseProjectId ? 'Partager la vitrine du projet' : 'Aucun projet vitrine disponible'}\n                    disabled={!showcaseProjectId}\n                  >\n                    <Link className=\"h-5 w-5\" />\n                    <span className=\"sr-only\">Partager</span>\n                  </button>\n                </>\n              )}\n              {mode === 'user' && screen === 'showcase' && showcaseProjectContext && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToComplianceReport}\n                  className=\"w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-blue-600 text-white hv-button-primary\"\n                  aria-label=\"Revenir Ã  la synthÃ¨se du projet\"\n                  title=\"Revenir Ã  la synthÃ¨se du projet\"\n                  data-tour-id=\"showcase-back-to-report\"\n                >\n                  SynthÃ¨se\n                </button>\n              )}\n              {mode === 'user' && (\n                <>\n                  <button\n                    type=\"button\"\n                    onClick={handleStartOnboarding}\n                    className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-2 ${\n                      isOnboardingActive\n                        ? 'bg-blue-600 text-white hv-button-primary'\n                        : isTourGuideReady\n                          ? 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 hv-focus-ring'\n                          : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'\n                    }`}\n                    disabled={!isTourGuideReady || isOnboardingActive}\n                    data-tour-id=\"nav-onboarding-trigger\"\n                    aria-label=\"Lancer le guide interactif\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Guide interactif</span>\n                  </button>\n                  {screen !== 'home' && (\n                    <button\n                      type=\"button\"\n                      onClick={() => setScreen('home')}\n                      className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button bg-gray-100 text-gray-700 hover:bg-gray-200`}\n                      aria-pressed={false}\n                      aria-label=\"Retourner Ã  l'accueil des projets\"\n                    >\n                      Accueil projets\n                    </button>\n                  )}\n                  <a\n                    href=\"https://forms.office.com/e/p6PYB1gbpM\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button text-white bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 hover:from-pink-600 hover:via-red-600 hover:to-yellow-600 focus-visible:ring-pink-400 hv-focus-ring\"\n                    aria-label=\"Partagez votre avis sur Project Navigator (nouvelle fenÃªtre)\"\n                  >\n                    <Sparkles className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                    <span>Partagez votre avis</span>\n                  </a>\n                </>\n              )}\n              {mode === 'admin' && (\n                <button\n                  type=\"button\"\n                  onClick={handleReturnToProjectMode}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button ${\n                    mode === 'user'\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={mode === 'user'}\n                  aria-label=\"Basculer vers le mode chef de projet\"\n                >\n                  Mode Chef de Projet\n                </button>\n              )}\n              {!isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleActivateAdminOnHome}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center ${\n                    isAdminHomeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminHomeView}\n                  aria-label=\"Activer le mode administrateur sur la page d'accueil\"\n                  title=\"Activer le mode administrateur sur l'accueil\"\n                >\n                  <Lock className=\"text-lg sm:text-xl\" />\n                  <span className=\"sr-only\">Mode Administrateur (Accueil)</span>\n                </button>\n              )}\n              {isAdminMode && (\n                <button\n                  type=\"button\"\n                  onClick={handleBackOfficeClick}\n                  className={`w-full sm:w-auto px-4 py-2 rounded-lg font-medium text-sm sm:text-base transition-all hv-button flex items-center justify-center gap-3 ${\n                    isAdminBackOfficeView\n                      ? 'bg-blue-600 text-white hv-button-primary'\n                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                  }`}\n                  aria-pressed={isAdminBackOfficeView}\n                  aria-label=\"AccÃ©der au Back-office\"\n                  title=\"AccÃ©der au Back-office\"\n                >\n                  <span>AccÃ©der au Back-office</span>\n                  <Settings className=\"text-lg sm:text-xl\" aria-hidden=\"true\" />\n                </button>\n              )}\n              {backOfficeAuthError && (\n                <p className=\"w-full text-sm text-red-600 sm:w-auto\" role=\"alert\">\n                  {backOfficeAuthError}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      {isShowcaseShareOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"showcase-share-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"text-center\">\n              <h2 id=\"showcase-share-title\" className=\"text-xl font-semibold text-gray-800\">\n                Partager la vitrine du projet\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Copiez le lien ou tÃ©lÃ©chargez un raccourci pour ouvrir directement cette vitrine.\n              </p>\n            </div>\n            <div className=\"space-y-3\">\n              <label htmlFor=\"showcase-share-link\" className=\"text-sm font-medium text-gray-700\">\n                Lien Ã  partager\n              </label>\n              <input\n                id=\"showcase-share-link\"\n                type=\"text\"\n                value={showcaseShareUrl}\n                ref={showcaseShareInputRef}\n                readOnly\n                className=\"w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-800\"\n              />\n              {showcaseShareFeedback && (\n                <p className=\"text-sm text-blue-600\">{showcaseShareFeedback}</p>\n              )}\n            </div>\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium text-gray-700\">Mode partagÃ©</p>\n              <div className=\"inline-flex flex-wrap gap-2\">\n                <button\n                  type=\"button\"\n                  onClick={() => setShowcaseShareMode('full')}\n                  className={`rounded-full border px-4 py-2 text-sm font-medium transition ${\n                    showcaseShareMode === 'full'\n                      ? 'border-blue-200 bg-blue-50 text-blue-700 shadow-sm'\n                      : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'\n                  }`}\n                  aria-pressed={showcaseShareMode === 'full'}\n                >\n                  Mode complet\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => setShowcaseShareMode('light')}\n                  className={`rounded-full border px-4 py-2 text-sm font-medium transition ${\n                    showcaseShareMode === 'light'\n                      ? 'border-blue-200 bg-blue-50 text-blue-700 shadow-sm'\n                      : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'\n                  }`}\n                  aria-pressed={showcaseShareMode === 'light'}\n                >\n                  Mode Light\n                </button>\n              </div>\n              <p className=\"text-xs text-gray-500\">\n                En mode Light, seules les sections prÃ©-sÃ©lectionnÃ©es sont visibles.\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                <input\n                  type=\"checkbox\"\n                  className=\"h-4 w-4 rounded border-gray-300 text-blue-600\"\n                  checked={showcaseShareCommentsEnabled}\n                  onChange={(event) => setShowcaseShareCommentsEnabled(event.target.checked)}\n                />\n                Commentaires possibles\n              </label>\n              <p className=\"text-xs text-gray-500\">\n                Active un bouton de commentaires flottant pour lancer le module de post-it.\n              </p>\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCopyShowcaseLink}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Copier le lien\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadShowcaseShortcut}\n                className=\"px-5 py-2 bg-white text-blue-700 font-medium rounded-lg border border-blue-200 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button\"\n              >\n                TÃ©lÃ©charger le raccourci\n              </button>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleCloseShowcaseShare}\n                className=\"text-sm text-gray-500 hover:text-gray-700\"\n              >\n                Fermer\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {isBackOfficePromptOpen && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"backoffice-auth-title\"\n        >\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={() => closeBackOfficePrompt(false)} aria-hidden=\"true\" />\n          <form\n            onSubmit={handleBackOfficePromptSubmit}\n            className=\"relative w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl hv-surface\"\n          >\n            <div className=\"text-center\">\n              <h2 id=\"backoffice-auth-title\" className=\"text-xl font-semibold text-gray-800\">\n                AccÃ¨s back-office\n              </h2>\n              <p className=\"mt-2 text-sm text-gray-600\">\n                Saisissez le mot de passe administrateur pour continuer.\n              </p>\n            </div>\n            <div className=\"mt-5 space-y-3\">\n              <label htmlFor=\"backoffice-password\" className=\"text-sm font-medium text-gray-700\">\n                Mot de passe\n              </label>\n              <input\n                id=\"backoffice-password\"\n                type=\"password\"\n                value={backOfficePromptValue}\n                onChange={(event) => setBackOfficePromptValue(event.target.value)}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                placeholder=\"Mot de passe\"\n              />\n              {backOfficePromptError && (\n                <p className=\"text-sm text-red-600\" role=\"alert\">\n                  {backOfficePromptError}\n                </p>\n              )}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center\">\n              <button\n                type=\"button\"\n                onClick={() => closeBackOfficePrompt(false)}\n                className=\"px-5 py-2 bg-white text-gray-700 font-medium rounded-lg border border-gray-200 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700\"\n              >\n                DÃ©verrouiller\n              </button>\n            </div>\n          </form>\n        </div>\n      )}\n\n      <main id=\"main-content\" tabIndex=\"-1\" className=\"focus:outline-none hv-background\">\n        {!isHydrated ? (\n          <div className=\"flex min-h-[60vh] items-center justify-center\">\n            <LoadingFallback\n              label=\"Chargement de lâ€™accueilâ€¦\"\n              hint=\"PrÃ©paration de votre espace.\"\n            />\n          </div>\n        ) : isAdminBackOfficeView ? (\n          <Suspense\n            fallback={(\n              <LoadingFallback\n                label=\"Chargement du back-officeâ€¦\"\n                hint=\"PrÃ©paration des donnÃ©es administratives en cours.\"\n              />\n            )}\n          >\n            <LazyBackOffice\n              projects={projects}\n              questions={questions}\n              setQuestions={setQuestions}\n              rules={rules}\n              setRules={setRules}\n              riskLevelRules={riskLevelRules}\n              setRiskLevelRules={setRiskLevelRules}\n              riskWeights={riskWeights}\n              setRiskWeights={setRiskWeights}\n              teams={teams}\n              setTeams={setTeams}\n              showcaseThemes={showcaseThemes}\n              setShowcaseThemes={setShowcaseThemes}\n              projectFilters={projectFilters}\n              setProjectFilters={updateProjectFilters}\n              inspirationFilters={inspirationFilters}\n              setInspirationFilters={updateInspirationFilters}\n              inspirationFormFields={inspirationFormFields}\n              setInspirationFormFields={updateInspirationFormFields}\n              onboardingTourConfig={onboardingTourConfig}\n              setOnboardingTourConfig={setOnboardingTourConfig}\n              validationCommitteeConfig={validationCommitteeConfig}\n              setValidationCommitteeConfig={setValidationCommitteeConfig}\n              adminEmails={adminEmails}\n              setAdminEmails={setAdminEmails}\n            />\n          </Suspense>\n        ) : screen === 'home' ? (\n          <HomeScreen\n            projects={projects}\n            projectFilters={projectFilters}\n            teamLeadOptions={teamLeadTeamOptions}\n            inspirationProjects={inspirationProjects}\n            inspirationFilters={inspirationFilters}\n            currentUser={currentUser}\n            homeView={homeView}\n            onHomeViewChange={setHomeView}\n            onStartInspirationProject={handleStartInspirationProject}\n            onOpenInspirationProject={handleOpenInspirationProject}\n            onStartNewProject={handleCreateNewProject}\n            onOpenProject={handleOpenProject}\n            onDeleteProject={handleDeleteProject}\n            onShowProjectShowcase={handleShowProjectShowcase}\n            onImportProject={handleImportProject}\n            onDuplicateProject={handleDuplicateProject}\n            isAdminMode={isAdminMode}\n            tourContext={tourContext}\n          />\n        ) : screen === 'inspiration-form' ? (\n          <InspirationForm\n            formConfig={inspirationFormFields}\n            existingProjects={inspirationProjects}\n            onSubmit={handleSaveInspirationProject}\n            onCancel={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n          />\n        ) : screen === 'inspiration-detail' ? (\n          <InspirationDetail\n            project={activeInspirationProject}\n            formConfig={inspirationFormFields}\n            onBack={() => {\n              setScreen('home');\n              setHomeView('inspiration');\n            }}\n            onUpdate={handleUpdateInspirationProject}\n            onExport={handleExportInspirationProject}\n          />\n        ) : screen === 'questionnaire' ? (\n          <QuestionnaireScreen\n            questions={activeQuestions}\n            currentIndex={currentQuestionIndex}\n            answers={answers}\n            onAnswer={handleAnswer}\n            onNext={handleNext}\n            onBack={handleBack}\n            allQuestions={questions}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onSaveDraft={isOnboardingActive ? noop : handleSaveDraft}\n            saveFeedback={saveFeedback}\n            onDismissSaveFeedback={handleDismissSaveFeedback}\n            validationError={validationError}\n            onReturnToSynthesis={\n              returnToSynthesisAfterEdit ? handleReturnToSynthesisFromQuestionnaire : undefined\n            }\n            isReturnToSynthesisRequested={returnToSynthesisAfterEdit}\n            tourContext={tourContext}\n            onFinish={navigateToSynthesis}\n          />\n        ) : screen === 'mandatory-summary' ? (\n          <MandatoryQuestionsSummary\n            pendingQuestions={pendingMandatoryQuestions}\n            totalQuestions={activeQuestions.length}\n            onBackToQuestionnaire={handleBackToQuestionnaire}\n            onNavigateToQuestion={handleNavigateToQuestion}\n            onProceedToSynthesis={handleProceedToSynthesis}\n          />\n        ) : screen === 'synthesis' ? (\n            <SynthesisReport\n              answers={answers}\n              analysis={analysis}\n              teams={teams}\n              questions={activeQuestions}\n              projectStatus={activeProject?.status || null}\n              projectId={activeProjectId}\n              projectName={activeProjectName}\n              onOpenProjectShowcase={handleOpenActiveProjectShowcase}\n              isProjectEditable={isActiveProjectEditable}\n              onRestart={handleRestart}\n              onBack={isActiveProjectEditable ? handleBackToQuestionnaire : undefined}\n              onUpdateAnswers={isActiveProjectEditable ? handleUpdateAnswers : undefined}\n              onUpdateComplianceComments={activeProjectId ? handleUpdateComplianceComments : undefined}\n              currentUser={currentUser}\n              sharedMembers={activeProject?.sharedWith || []}\n              onShareProjectMember={activeProjectId ? handleAddSharedMember : undefined}\n              onRemoveProjectMember={activeProjectId ? handleRemoveSharedMember : undefined}\n              onSubmitProject={handleSubmitProject}\n              onNavigateToQuestion={handleNavigateToQuestionFromReport}\n              isExistingProject={Boolean(activeProjectId)}\n              onSaveDraft={\n                isOnboardingActive\n                  ? noop\n                  : isActiveProjectEditable\n                    ? handleSaveDraft\n                    : undefined\n              }\n              saveFeedback={saveFeedback}\n              onDismissSaveFeedback={handleDismissSaveFeedback}\n              isAdminMode={isAdminMode}\n              hasIncompleteAnswers={hasIncompleteAnswers}\n              tourContext={tourContext}\n              validationCommitteeConfig={validationCommitteeConfig}\n            />\n        ) : screen === 'showcase' ? (\n          showcaseProjectContext ? (\n            <div className=\"space-y-4\">\n              {showcaseProjectContext.status !== 'draft' && (\n                <div className=\"rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800 hv-surface\">\n                  {isAdminMode\n                    ? 'Ce projet a Ã©tÃ© soumis. Vous pouvez le modifier car vous Ãªtes en mode administrateur.'\n                    : 'Ce projet a Ã©tÃ© soumis. La vitrine est consultable en lecture seule.'}\n                </div>\n              )}\n              <Suspense\n                fallback={(\n                  <LoadingFallback\n                    label=\"Chargement de la vitrine du projetâ€¦\"\n                    hint=\"Nous construisons la synthÃ¨se visuelle du projet.\"\n                  />\n                )}\n              >\n                <LazyProjectShowcase\n                  projectName={showcaseProjectContext.projectName}\n                  onClose={handleCloseProjectShowcase}\n                  analysis={showcaseProjectContext.analysis}\n                  relevantTeams={showcaseProjectContext.relevantTeams}\n                  questions={showcaseProjectContext.questions}\n                  answers={showcaseProjectContext.answers}\n                  timelineDetails={showcaseProjectContext.timelineDetails}\n                  showcaseThemes={showcaseThemes}\n                  hasIncompleteAnswers={Boolean(showcaseProjectContext.hasIncompleteAnswers)}\n                  initialDisplayMode={showcaseDisplayMode}\n                  displayModeLock={showcaseDisplayModeLock}\n                  hideEditBar={isShowcaseSharedView}\n                  hideNotice={isShowcaseSharedView}\n                  onUpdateAnswers={\n                    isShowcaseSharedView\n                      ? undefined\n                      : isOnboardingActive\n                        ? noop\n                        : showcaseProjectContext.status === 'draft' || isAdminMode\n                          ? handleUpdateProjectShowcaseAnswers\n                          : undefined\n                  }\n                  tourContext={tourContext}\n                  onDisplayModeChange={setShowcaseDisplayMode}\n                  onAnnotationScopeChange={setShowcaseAnnotationScope}\n                  onEditingStateChange={setIsShowcaseEditing}\n                />\n              </Suspense>\n            </div>\n          ) : null\n      ) : null}\n    </main>\n\n    {screen === 'showcase' && isShowcaseSharedView && showcaseCommentsEnabled && (\n      <button\n        type=\"button\"\n        onClick={handleToggleAnnotationMode}\n        className={`fixed bottom-6 right-6 z-40 inline-flex items-center gap-2 rounded-full border px-4 py-3 text-sm font-semibold shadow-lg transition hover:shadow-xl ${\n          isAnnotationModeEnabled\n            ? 'border-blue-200 bg-blue-600 text-white'\n            : 'border-blue-100 bg-white text-blue-700'\n        }`}\n        aria-pressed={isAnnotationModeEnabled}\n        aria-label={isAnnotationModeEnabled ? 'Fermer les commentaires' : 'Ouvrir les commentaires'}\n        title={isAnnotationModeEnabled ? 'Fermer les commentaires' : 'Ouvrir les commentaires'}\n        data-annotation-ui=\"true\"\n      >\n        <MessageSquare className=\"h-4 w-4\" />\n        <span>Commentaires</span>\n      </button>\n    )}\n\n    <footer className=\"bg-white border-t border-gray-200 mt-10\" aria-label=\"Pied de page\">\n      <p className=\"text-xs text-gray-400 text-center py-4\">\n        Project Navigator Â· Version {APP_VERSION} Â·{' '}\n        <a\n          href=\"./mentions-legales.html\"\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"underline hover:text-gray-500\"\n        >\n          Mentions lÃ©gales\n        </a>\n      </p>\n    </footer>\n    </div>\n  );\n};\n",
  "src/components/AnnotationLayer.jsx": "import React, { useEffect, useMemo, useRef, useState } from '../react.js';\nimport { Close, Pause, Play, Save, Upload } from './icons.js';\n\nconst clamp01 = (value) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return 0;\n  }\n\n  if (value < 0) {\n    return 0;\n  }\n\n  if (value > 1) {\n    return 1;\n  }\n\n  return value;\n};\n\nconst escapeAttributeValue = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  if (typeof CSS !== 'undefined' && typeof CSS.escape === 'function') {\n    return CSS.escape(value);\n  }\n\n  return value.replace(/\"/g, '\\\\\"');\n};\n\nconst STATUS_BADGE = {\n  active: 'bg-emerald-500 text-white',\n  paused: 'bg-amber-500 text-white'\n};\n\nconst SOURCE_PALETTE_KEYS = ['palette-0', 'palette-1', 'palette-2', 'palette-3', 'palette-4'];\n\nconst getFeedbackPaletteKey = (note, sourcePalette) => {\n  if (note?.sourceId && note.sourceId !== 'session') {\n    return sourcePalette.get(note.sourceId) || 'palette-0';\n  }\n\n  return 'base';\n};\n\nexport const AnnotationLayer = ({\n  isActive = false,\n  isPaused = false,\n  isEditing = false,\n  hideToolbar = false,\n  notes = [],\n  activeContextId = '',\n  projectName = '',\n  autoFocusNoteId = null,\n  onTogglePause,\n  onRequestSave,\n  onRequestLoad,\n  onExit,\n  onNoteChange,\n  onNoteRemove,\n  onAutoFocusComplete\n}) => {\n  const [, setLayoutVersion] = useState(0);\n  const visibleNotes = useMemo(\n    () => notes.filter(note => note && note.contextId === activeContextId),\n    [activeContextId, notes]\n  );\n  const sourcePalette = useMemo(() => {\n    const palette = new Map();\n    let paletteIndex = 0;\n\n    visibleNotes.forEach((note) => {\n      if (!note?.sourceId || note.sourceId === 'session' || palette.has(note.sourceId)) {\n        return;\n      }\n\n      const key = SOURCE_PALETTE_KEYS[paletteIndex % SOURCE_PALETTE_KEYS.length] || 'palette-0';\n      palette.set(note.sourceId, key);\n      paletteIndex += 1;\n    });\n\n    return palette;\n  }, [visibleNotes]);\n\n  const textareaRefs = useRef(new Map());\n\n  const registerTextareaRef = (noteId) => (node) => {\n    if (!noteId) {\n      return;\n    }\n\n    if (node) {\n      textareaRefs.current.set(noteId, node);\n    } else {\n      textareaRefs.current.delete(noteId);\n    }\n  };\n\n  useEffect(() => {\n    if (!autoFocusNoteId) {\n      return;\n    }\n\n    const target = textareaRefs.current.get(autoFocusNoteId);\n    if (target && typeof target.focus === 'function') {\n      target.focus();\n      if (typeof target.setSelectionRange === 'function') {\n        const length = target.value?.length ?? 0;\n        target.setSelectionRange(length, length);\n      }\n      if (typeof onAutoFocusComplete === 'function') {\n        onAutoFocusComplete(autoFocusNoteId);\n      }\n    }\n  }, [autoFocusNoteId, onAutoFocusComplete]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const handleLayoutRefresh = () => {\n      setLayoutVersion(previous => previous + 1);\n    };\n\n    window.addEventListener('resize', handleLayoutRefresh);\n    window.addEventListener('scroll', handleLayoutRefresh, true);\n\n    return () => {\n      window.removeEventListener('resize', handleLayoutRefresh);\n      window.removeEventListener('scroll', handleLayoutRefresh, true);\n    };\n  }, []);\n\n  const getAnnotationAnchor = (note) => {\n    if (typeof document === 'undefined' || !note?.sectionId) {\n      return null;\n    }\n\n    const escapedSectionId = escapeAttributeValue(note.sectionId);\n\n    if (escapedSectionId && isEditing) {\n      const editAnchor = document.querySelector(`[data-annotation-target-section=\"${escapedSectionId}\"]`);\n      if (editAnchor) {\n        return editAnchor;\n      }\n    }\n\n    if (escapedSectionId) {\n      const displayAnchor = document.querySelector(`[data-showcase-section=\"${escapedSectionId}\"]`);\n      if (displayAnchor) {\n        return displayAnchor;\n      }\n    }\n\n    return null;\n  };\n\n  const computeNotePosition = (note) => {\n    const viewportWidth = typeof window !== 'undefined' ? window.innerWidth || 1 : 1;\n    const viewportHeight = typeof window !== 'undefined' ? window.innerHeight || 1 : 1;\n    const anchor = getAnnotationAnchor(note);\n\n    if (anchor && typeof anchor.getBoundingClientRect === 'function') {\n      const rect = anchor.getBoundingClientRect();\n      const relativeX = clamp01(note?.sectionX ?? note?.x ?? 0.5);\n      const relativeY = clamp01(note?.sectionY ?? note?.y ?? 0.5);\n\n      return {\n        left: rect.left + rect.width * relativeX,\n        top: rect.top + rect.height * relativeY\n      };\n    }\n\n    const fallbackX = clamp01(note?.x ?? 0.5);\n    const fallbackY = clamp01(note?.y ?? 0.5);\n\n    return {\n      left: fallbackX * viewportWidth,\n      top: fallbackY * viewportHeight\n    };\n  };\n\n  if (!isActive) {\n    return null;\n  }\n\n  return (\n    <React.Fragment>\n      {!hideToolbar && (\n        <div className=\"annotation-toolbar fixed top-0 inset-x-0 z-[2147483600]\" data-annotation-ui=\"true\">\n          <div className=\"max-w-7xl mx-auto px-4 sm:px-8\">\n            <div className=\"mt-2 rounded-b-xl bg-white border border-slate-200 text-slate-900 shadow-2xl px-4 py-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n              <div className=\"flex items-center gap-2 text-sm text-slate-800\">\n                <span className=\"font-semibold\">Mode annotation</span>\n                <span className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold ${\n                  isPaused ? STATUS_BADGE.paused : STATUS_BADGE.active\n                }`}>\n                  <span className=\"w-2 h-2 rounded-full bg-white\" aria-hidden=\"true\" />\n                  {isPaused ? 'En pause' : 'Actif'}\n                </span>\n                {projectName ? (\n                  <span className=\"text-xs text-slate-600\">Projet : {projectName}</span>\n                ) : null}\n              </div>\n\n              <div className=\"flex flex-wrap items-center gap-2\">\n                <button\n                  type=\"button\"\n                  onClick={onExit}\n                  className=\"inline-flex items-center justify-center rounded-full border border-slate-200 bg-white p-2 text-slate-600 hover:text-slate-900 hover:border-slate-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n                  aria-label=\"Quitter le mode annotation\"\n                  title=\"Quitter le mode annotation\"\n                >\n                  <Close className=\"h-4 w-4\" />\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={onRequestSave}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n                >\n                  <Save className=\"h-4 w-4\" />\n                  Sauvegarder\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={onRequestLoad}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-slate-100 px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n                >\n                  <Upload className=\"h-4 w-4\" />\n                  Charger\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={onTogglePause}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400\"\n                >\n                  {isPaused ? <Play className=\"h-4 w-4\" /> : <Pause className=\"h-4 w-4\" />}\n                  {isPaused ? 'Relancer' : 'Mettre en pause'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div className=\"annotation-sticky-layer\" data-annotation-ui=\"true\">\n        {visibleNotes.map((note, index) => {\n          const position = computeNotePosition(note);\n          const label = note.sourceId && note.sourceId !== 'session' ? note.sourceId : `#${index + 1}`;\n          const paletteKey = getFeedbackPaletteKey(note, sourcePalette);\n\n          return (\n            <div\n              key={note.id}\n              className=\"annotation-sticky feedback-note\"\n              style={{ left: `${position.left}px`, top: `${position.top}px` }}\n              data-annotation-ui=\"true\"\n              data-feedback-source-color={paletteKey}\n            >\n              <div className=\"feedback-note-header\">\n                <span className=\"feedback-note-number\">{label}</span>\n                {onNoteRemove ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => onNoteRemove(note.id)}\n                    className=\"feedback-note-delete\"\n                    aria-label=\"Supprimer le sticky note\"\n                  >\n                    <Close className=\"h-4 w-4\" />\n                  </button>\n                ) : null}\n              </div>\n              <textarea\n                value={note.text || ''}\n                onChange={(event) => onNoteChange && onNoteChange(note.id, event.target.value)}\n                ref={registerTextareaRef(note.id)}\n                className=\"feedback-note-text\"\n                rows={4}\n                placeholder=\"Ajoutez votre remarque ici...\"\n                data-annotation-ui=\"true\"\n              />\n            </div>\n          );\n        })}\n      </div>\n    </React.Fragment>\n  );\n};\n",
  "src/components/BackOffice.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport { normalizeRiskWeighting } from '../utils/risk.js';\nimport {\n  Settings,\n  Plus,\n  Edit,\n  Trash2,\n  Eye,\n  Info,\n  GripVertical,\n  Download,\n  ArrowUp,\n  ArrowDown,\n  Copy,\n  AlertTriangle,\n  CheckCircle,\n  ChevronRight,\n  ChevronLeft\n} from './icons.js';\nimport { QuestionEditor } from './QuestionEditor.jsx';\nimport { RuleEditor } from './RuleEditor.jsx';\nimport { BackOfficeDashboard } from './BackOfficeDashboard.jsx';\nimport { VirtualizedList } from './VirtualizedList.jsx';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { normalizeConditionGroups } from '../utils/conditionGroups.js';\nimport { initialOnboardingTourConfig } from '../data/onboardingTour.js';\nimport {\n  normalizeTimingRequirement,\n  sanitizeRiskTimingConstraint,\n  sanitizeTeamQuestionEntry\n} from '../utils/rules.js';\nimport {\n  applyRuleConditionGroups,\n  createEmptyQuestionCondition,\n  createEmptyTimingCondition,\n  normalizeRuleConditionGroups,\n  sanitizeRuleCondition\n} from '../utils/ruleConditions.js';\nimport { ensureOperatorForType, getOperatorOptionsForType } from '../utils/operatorOptions.js';\nimport { formatTeamContacts, parseTeamContacts } from '../utils/teamContacts.js';\nimport {\n  createOnboardingAction,\n  createOnboardingStep,\n  normalizeOnboardingConfig\n} from '../utils/onboarding.js';\nimport {\n  normalizeProjectFilterConfig,\n  resetProjectFiltersConfig,\n  updateProjectFilterField\n} from '../utils/projectFilters.js';\nimport {\n  normalizeInspirationFiltersConfig,\n  normalizeInspirationFormConfig,\n  resetInspirationFiltersConfig,\n  resetInspirationFormConfig,\n  updateInspirationFilterField,\n  updateInspirationFormField\n} from '../utils/inspirationConfig.js';\nimport { initialShowcaseThemes } from '../data/showcaseThemes.js';\nimport { normalizeValidationCommitteeConfig } from '../utils/validationCommittee.js';\n\nconst QUESTION_TYPE_META = {\n  choice: {\n    label: 'Liste de choix',\n    description: \"Affiche une liste d'options exclusives.\"\n  },\n  multi_choice: {\n    label: 'Choix multiples',\n    description: 'Permet de sÃ©lectionner plusieurs rÃ©ponses.'\n  },\n  milestone_list: {\n    label: 'Liste de jalons',\n    description: 'Collecte des jalons avec une date et une description.'\n  },\n  date: {\n    label: 'Date',\n    description: 'Attend la sÃ©lection d\\'une date prÃ©cise.'\n  },\n  number: {\n    label: 'Valeur numÃ©rique',\n    description: 'Attend un nombre entier ou dÃ©cimal.'\n  },\n  url: {\n    label: 'Lien URL',\n    description: 'Attend un lien complet (https://...).'\n  },\n  file: {\n    label: 'Fichier',\n    description: 'Permet de tÃ©lÃ©verser un document de rÃ©fÃ©rence.'\n  },\n  text: {\n    label: 'Texte libre (1 ligne)',\n    description: 'Attend une rÃ©ponse texte courte.'\n  },\n  long_text: {\n    label: 'Texte libre (plusieurs lignes)',\n    description: 'Attend une rÃ©ponse texte dÃ©taillÃ©e.'\n  }\n};\n\nconst PROTECTED_QUESTION_IDS = new Set(['ProjectType']);\n\nconst getQuestionTypeMeta = (type) => {\n  const key = type || 'choice';\n  return QUESTION_TYPE_META[key] || QUESTION_TYPE_META.choice;\n};\n\nconst formatOperatorSymbol = (operator) => {\n  switch (operator) {\n    case 'equals':\n      return '=';\n    case 'not_equals':\n      return 'â‰ ';\n    case 'contains':\n      return 'contient';\n    case 'lt':\n      return '<';\n    case 'lte':\n      return 'â‰¤';\n    case 'gt':\n      return '>';\n    case 'gte':\n      return 'â‰¥';\n    default:\n      return operator || '=';\n  }\n};\n\nconst buildConditionSummary = (question, allQuestions) => {\n  const conditionGroups = normalizeConditionGroups(question);\n  const summaries = [];\n\n  for (let groupIndex = 0; groupIndex < conditionGroups.length; groupIndex += 1) {\n    const group = conditionGroups[groupIndex];\n    const conditions = Array.isArray(group && group.conditions) ? group.conditions : [];\n\n    if (conditions.length === 0) {\n      continue;\n    }\n\n    const parts = [];\n    for (let conditionIndex = 0; conditionIndex < conditions.length; conditionIndex += 1) {\n      const condition = conditions[conditionIndex];\n      if (!condition) {\n        continue;\n      }\n\n      const refQuestion = allQuestions.find((item) => item.id === condition.question);\n      const label = refQuestion ? refQuestion.question : `Question ${condition.question}`;\n      const operator = formatOperatorSymbol(condition.operator);\n\n      const value = typeof condition.value === 'string' ? condition.value : JSON.stringify(condition.value);\n      const connector = conditionIndex > 0 ? (group.logic === 'any' ? 'OU' : 'ET') : '';\n      parts.push({ label, operator, value, connector });\n    }\n\n    if (parts.length > 0) {\n      summaries.push({\n        index: groupIndex + 1,\n        logic: group.logic === 'any' ? 'OU' : 'ET',\n        parts\n      });\n    }\n  }\n\n  return summaries;\n};\n\nconst buildRuleConditionSummary = (rule, questions) => {\n  const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n  const formatted = [];\n\n  for (let groupIndex = 0; groupIndex < groups.length; groupIndex += 1) {\n    const group = groups[groupIndex];\n    const conditions = Array.isArray(group && group.conditions) ? group.conditions : [];\n\n    if (conditions.length === 0) {\n      continue;\n    }\n\n    const items = [];\n    for (let conditionIndex = 0; conditionIndex < conditions.length; conditionIndex += 1) {\n      const condition = conditions[conditionIndex];\n      if (!condition) {\n        continue;\n      }\n\n      if (condition.type === 'timing') {\n        const requirement = normalizeTimingRequirement(condition);\n        const start = condition.startQuestion || 'dÃ©but ?';\n        const end = condition.endQuestion || 'fin ?';\n        const constraintParts = [];\n\n        if (typeof requirement.minimumWeeks === 'number') {\n          constraintParts.push(`â‰¥ ${requirement.minimumWeeks} sem.`);\n        }\n        if (typeof requirement.maximumWeeks === 'number') {\n          constraintParts.push(`â‰¤ ${requirement.maximumWeeks} sem.`);\n        }\n        if (typeof requirement.minimumDays === 'number') {\n          constraintParts.push(`â‰¥ ${requirement.minimumDays} j.`);\n        }\n        if (typeof requirement.maximumDays === 'number') {\n          constraintParts.push(`â‰¤ ${requirement.maximumDays} j.`);\n        }\n\n        const constraint = constraintParts.length > 0 ? constraintParts.join(' / ') : 'plage personnalisÃ©e';\n        items.push({\n          type: 'timing',\n          description: `FenÃªtre entre Â« ${start} Â» et Â« ${end} Â» (${constraint})`\n        });\n        continue;\n      }\n\n      const refQuestion = questions.find((item) => item.id === condition.question);\n      const label = refQuestion ? `${refQuestion.id} â€“ ${refQuestion.question}` : `Question ${condition.question}`;\n      const operator = formatOperatorSymbol(condition.operator);\n      const value = typeof condition.value === 'string' ? condition.value : JSON.stringify(condition.value);\n\n      items.push({\n        type: 'question',\n        description: `${label} ${operator} Â« ${value} Â»`\n      });\n    }\n\n    if (items.length > 0) {\n      formatted.push({\n        index: groupIndex + 1,\n        logic: group.logic === 'any' ? 'OU' : 'ET',\n        items\n      });\n    }\n  }\n\n  return formatted;\n};\n\nconst collectRuleTeamIds = (rule) => {\n  const teamIds = new Set();\n\n  if (!rule || typeof rule !== 'object') {\n    return teamIds;\n  }\n\n  const baseTeams = Array.isArray(rule?.teams) ? rule.teams : [];\n  baseTeams.forEach((teamId) => {\n    if (typeof teamId === 'string' && teamId.trim() !== '') {\n      teamIds.add(teamId);\n    }\n  });\n\n  if (rule?.questions && typeof rule.questions === 'object') {\n    Object.keys(rule.questions).forEach((teamId) => {\n      if (typeof teamId === 'string' && teamId.trim() !== '') {\n        teamIds.add(teamId);\n      }\n    });\n  }\n\n  const risks = Array.isArray(rule?.risks) ? rule.risks : [];\n  risks.forEach((risk) => {\n    if (risk && typeof risk.teamId === 'string' && risk.teamId.trim() !== '') {\n      teamIds.add(risk.teamId);\n    }\n  });\n\n  return teamIds;\n};\n\nconst formatGuidanceTips = (guidance) => {\n  if (!guidance || !Array.isArray(guidance.tips)) {\n    return [];\n  }\n\n  const tips = [];\n  for (let index = 0; index < guidance.tips.length; index += 1) {\n    const tip = guidance.tips[index];\n    if (typeof tip === 'string' && tip.trim() !== '') {\n      tips.push(tip);\n    }\n  }\n\n  return tips;\n};\n\nconst getTeamLabel = (teamId, teams) => {\n  for (let index = 0; index < teams.length; index += 1) {\n    const team = teams[index];\n    if (team && team.id === teamId) {\n      return `${team.name || team.id}`;\n    }\n  }\n  return teamId;\n};\n\nconst PRIORITY_WEIGHTS = {\n  'A particuliÃ¨rement anticiper': 3,\n  'A anticiper': 2,\n  'A rÃ©aliser': 1\n};\n\nconst RISK_WEIGHT_FIELDS = [\n  {\n    key: 'low',\n    label: 'Risque faible',\n    description: 'Poids appliquÃ© aux risques de criticitÃ© faible.'\n  },\n  {\n    key: 'medium',\n    label: 'Risque moyen',\n    description: 'Poids appliquÃ© aux risques de criticitÃ© moyenne.'\n  },\n  {\n    key: 'high',\n    label: 'Risque Ã©levÃ©',\n    description: 'Poids appliquÃ© aux risques de criticitÃ© Ã©levÃ©e.'\n  }\n];\n\nconst parseScoreValue = (value, fallback, { allowNull = false } = {}) => {\n  if (allowNull && (value === null || value === undefined || value === '')) {\n    return null;\n  }\n\n  const parsed = Number(value);\n\n  if (!Number.isFinite(parsed)) {\n    return fallback;\n  }\n\n  return parsed < 0 ? 0 : parsed;\n};\n\nconst getRuleMinScoreValue = (rule) => parseScoreValue(\n  rule?.minScore !== undefined ? rule.minScore : rule?.minRisks,\n  0\n);\n\nconst getRuleMaxScoreValue = (rule) => parseScoreValue(\n  rule?.maxScore !== undefined ? rule.maxScore : rule?.maxRisks,\n  null,\n  { allowNull: true }\n);\n\nconst formatScoreValue = (value) => {\n  if (!Number.isFinite(value)) {\n    return '0';\n  }\n\n  if (Number.isInteger(value)) {\n    return value.toString();\n  }\n\n  return value.toLocaleString('fr-FR', {\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 2\n  });\n};\n\nconst getPointUnit = (value) => (Math.abs(value - 1) < 1e-9 ? 'point' : 'points');\n\nconst getHighestRiskPriority = (risks = []) => {\n  if (!Array.isArray(risks) || risks.length === 0) {\n    return null;\n  }\n\n  let bestPriority = null;\n\n  risks.forEach((risk) => {\n    const priority = risk?.priority;\n    if (!priority) {\n      return;\n    }\n\n    const currentWeight = PRIORITY_WEIGHTS[priority] || 0;\n    const bestWeight = PRIORITY_WEIGHTS[bestPriority] || 0;\n\n    if (!bestPriority || currentWeight > bestWeight) {\n      bestPriority = priority;\n    }\n  });\n\n  return bestPriority;\n};\n\nconst getPriorityBadgeClasses = (priority) => {\n  switch (priority) {\n    case 'A particuliÃ¨rement anticiper':\n      return 'bg-red-100 text-red-800 border border-red-200';\n    case 'A anticiper':\n      return 'bg-orange-100 text-orange-800 border border-orange-200';\n    case 'A rÃ©aliser':\n      return 'bg-blue-100 text-blue-800 border border-blue-200';\n    default:\n      return 'bg-gray-100 text-gray-700 border border-gray-200';\n  }\n};\n\nconst PROJECT_FILTER_TYPE_LABELS = {\n  text: 'Champ texte',\n  select: 'Liste dÃ©roulante',\n  sort: 'Tri par date'\n};\n\nconst FILTER_COMPATIBLE_QUESTION_TYPES = new Set([\n  'choice',\n  'multi_choice',\n  'text',\n  'long_text',\n  'number',\n  'url',\n  'date'\n]);\n\nconst INSPIRATION_FILTER_TYPE_LABELS = {\n  text: 'Champ texte',\n  select: 'Liste dÃ©roulante'\n};\n\nconst INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES = new Set([\n  'select',\n  'multi_select',\n  'text',\n  'long_text',\n  'number',\n  'url',\n  'date'\n]);\n\nconst INSPIRATION_FORM_FIELD_TYPE_LABELS = {\n  text: 'Texte (1 ligne)',\n  long_text: 'Texte long',\n  select: 'Liste dÃ©roulante',\n  multi_select: 'SÃ©lection multiple',\n  url: 'URL',\n  documents: 'Documents'\n};\n\nconst INSPIRATION_FORM_FIELD_TYPE_OPTIONS = [\n  { value: 'text', label: 'Texte (1 ligne)' },\n  { value: 'long_text', label: 'Texte long' },\n  { value: 'select', label: 'Liste dÃ©roulante' },\n  { value: 'multi_select', label: 'SÃ©lection multiple' },\n  { value: 'url', label: 'URL' },\n  { value: 'documents', label: 'Documents' }\n];\n\nconst INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES = new Set([\n  'text',\n  'long_text',\n  'select',\n  'url'\n]);\n\nconst PROJECT_FILTER_FIELD_DESCRIPTIONS = {\n  projectName:\n    'Permet de rechercher un projet par le titre saisi lors de la qualification.',\n  teamLead:\n    'Filtre les projets en fonction du nom du lead renseignÃ© dans le questionnaire.',\n  teamLeadTeam:\n    'Affiche une liste des Ã©quipes possibles pour retrouver rapidement les initiatives associÃ©es.',\n  dateOrder:\n    \"DÃ©finit l'ordre d'affichage par dÃ©faut des projets (du plus rÃ©cent au plus ancien ou inversement).\"\n};\n\nconst SHOWCASE_THEME_PALETTE_FIELDS = [\n  { key: 'backgroundStart', label: 'Fond (dÃ©but)', description: 'Couleur de dÃ©part du dÃ©gradÃ© principal en arriÃ¨re-plan.' },\n  { key: 'backgroundMid', label: 'Fond (milieu)', description: 'Couleur intermÃ©diaire du dÃ©gradÃ© principal.' },\n  { key: 'backgroundEnd', label: 'Fond (fin)', description: 'Couleur de fermeture du dÃ©gradÃ© principal.' },\n  { key: 'glowPrimary', label: 'Halo principal', description: 'Teinte du halo radial principal utilisÃ© pour la lumiÃ¨re de fond.' },\n  { key: 'glowSecondary', label: 'Halo secondaire', description: 'Teinte du halo secondaire pour adoucir les bords.' },\n  { key: 'accentPrimary', label: 'Accent principal', description: 'PremiÃ¨re couleur du dÃ©gradÃ© des boutons et badges.' },\n  { key: 'accentSecondary', label: 'Accent secondaire', description: 'Seconde couleur du dÃ©gradÃ© des boutons et badges.' },\n  { key: 'surface', label: 'Surface', description: 'Couleur des panneaux de saisie et cartes (avec transparence appliquÃ©e).' },\n  { key: 'border', label: 'Contours', description: 'Base utilisÃ©e pour les bordures et lignes de sÃ©paration.' },\n  { key: 'textPrimary', label: 'Texte principal', description: 'Couleur du texte principal de la vitrine.' },\n  { key: 'textSecondary', label: 'Texte secondaire', description: 'Couleur du texte secondaire et des Ã©lÃ©ments discrets.' },\n  { key: 'highlight', label: 'Mise en avant', description: 'Couleur des petits accents (Ã©tiquettes, survols, repÃ¨res visuels).' }\n];\n\nconst createEmptyInspirationFormField = () => ({\n  id: '',\n  label: '',\n  type: 'text',\n  placeholder: '',\n  options: '',\n  required: false,\n  enabled: true\n});\n\nexport const BackOffice = ({\n  projects,\n  questions,\n  setQuestions,\n  rules,\n  setRules,\n  riskLevelRules,\n  setRiskLevelRules,\n  riskWeights,\n  setRiskWeights,\n  teams,\n  setTeams,\n  showcaseThemes,\n  setShowcaseThemes,\n  projectFilters,\n  setProjectFilters,\n  inspirationFilters,\n  setInspirationFilters,\n  inspirationFormFields,\n  setInspirationFormFields,\n  onboardingTourConfig,\n  setOnboardingTourConfig,\n  validationCommitteeConfig,\n  setValidationCommitteeConfig,\n  adminEmails,\n  setAdminEmails\n}) => {\n  const [activeTab, setActiveTab] = useState('dashboard');\n  const [editingRule, setEditingRule] = useState(null);\n  const [editingQuestion, setEditingQuestion] = useState(null);\n  const [draggedQuestionIndex, setDraggedQuestionIndex] = useState(null);\n  const [dragOverIndex, setDragOverIndex] = useState(null);\n  const [draggedInspirationFieldIndex, setDraggedInspirationFieldIndex] = useState(null);\n  const [dragOverInspirationFieldIndex, setDragOverInspirationFieldIndex] = useState(null);\n  const [reorderAnnouncement, setReorderAnnouncement] = useState('');\n  const [questionTitleFilter, setQuestionTitleFilter] = useState('');\n  const [questionTeamFilter, setQuestionTeamFilter] = useState('all');\n  const [ruleTitleFilter, setRuleTitleFilter] = useState('');\n  const [ruleTeamFilter, setRuleTeamFilter] = useState('all');\n  const [expandedQuestionIds, setExpandedQuestionIds] = useState(() => new Set());\n  const [expandedRuleIds, setExpandedRuleIds] = useState(() => new Set());\n  const [selectedFilterQuestionId, setSelectedFilterQuestionId] = useState('');\n  const [selectedInspirationFilterQuestionId, setSelectedInspirationFilterQuestionId] = useState('');\n  const [newInspirationFormField, setNewInspirationFormField] = useState(() => createEmptyInspirationFormField());\n  const undoStackRef = useRef([]);\n  const [canUndo, setCanUndo] = useState(false);\n  const [undoMessage, setUndoMessage] = useState('');\n  const safeRiskLevelRules = Array.isArray(riskLevelRules) ? riskLevelRules : [];\n  const riskLevelRuleCount = safeRiskLevelRules.length;\n  const normalizedRiskWeights = useMemo(\n    () => normalizeRiskWeighting(riskWeights),\n    [riskWeights]\n  );\n  const safeShowcaseThemes = Array.isArray(showcaseThemes) && showcaseThemes.length > 0\n    ? showcaseThemes\n    : initialShowcaseThemes;\n  const showcaseThemeCount = safeShowcaseThemes.length;\n  const normalizedOnboardingConfig = useMemo(\n    () => normalizeOnboardingConfig(onboardingTourConfig),\n    [onboardingTourConfig]\n  );\n  const onboardingStepCount = normalizedOnboardingConfig.steps.length;\n  const normalizedValidationCommitteeConfig = useMemo(\n    () => normalizeValidationCommitteeConfig(validationCommitteeConfig),\n    [validationCommitteeConfig]\n  );\n  const dateQuestions = useMemo(\n    () => (Array.isArray(questions) ? questions.filter((question) => question?.type === 'date') : []),\n    [questions]\n  );\n  const createValidationCommittee = useCallback((index = 0) => ({\n    id: `committee-${Date.now()}-${Math.round(Math.random() * 1000)}`,\n    name: `ComitÃ© ${index + 1}`,\n    commentRequired: true,\n    emails: [],\n    ruleTriggers: {\n      matchMode: 'any',\n      ruleIds: []\n    },\n    conditionGroups: [],\n    riskTriggers: {\n      minRiskScore: null\n    },\n    teamTriggers: {\n      minTeamsCount: null\n    }\n  }), []);\n  const parseEmailList = useCallback((value) => (\n    typeof value === 'string'\n      ? value\n        .split(/[,;\\n]/)\n        .map((entry) => entry.trim())\n        .filter((entry) => entry.length > 0)\n      : []\n  ), []);\n  const normalizedAdminEmails = useMemo(\n    () => (Array.isArray(adminEmails) ? adminEmails.filter(Boolean) : []),\n    [adminEmails]\n  );\n\n  const updateValidationCommitteeConfig = useCallback(\n    (updater) => {\n      if (typeof setValidationCommitteeConfig !== 'function') {\n        return;\n      }\n      setValidationCommitteeConfig((prev) =>\n        normalizeValidationCommitteeConfig(\n          typeof updater === 'function' ? updater(prev) : updater\n        )\n      );\n    },\n    [setValidationCommitteeConfig]\n  );\n  const updateCommitteeEntry = useCallback(\n    (committeeId, updater) => {\n      updateValidationCommitteeConfig((prev) => {\n        const normalized = normalizeValidationCommitteeConfig(prev);\n        const nextCommittees = normalized.committees.map((committee) =>\n          committee.id === committeeId\n            ? typeof updater === 'function'\n              ? updater(committee)\n              : updater\n            : committee\n        );\n        return {\n          ...normalized,\n          committees: nextCommittees\n        };\n      });\n    },\n    [updateValidationCommitteeConfig]\n  );\n  const sanitizeCommitteeConditionGroups = useCallback(\n    (groups) => (\n      Array.isArray(groups)\n        ? groups.map((group) => ({\n            ...group,\n            conditions: Array.isArray(group.conditions)\n              ? group.conditions.map((condition) => {\n                  const sanitizedCondition = sanitizeRuleCondition(condition);\n                  if (sanitizedCondition.type === 'timing') {\n                    return sanitizedCondition;\n                  }\n\n                  const question = questions.find((item) => item.id === sanitizedCondition.question);\n                  const questionType = question?.type || 'choice';\n                  return {\n                    ...sanitizedCondition,\n                    operator: ensureOperatorForType(questionType, sanitizedCondition.operator)\n                  };\n                })\n              : []\n          }))\n        : []\n    ),\n    [questions]\n  );\n  const updateCommitteeConditionGroups = useCallback(\n    (committeeId, updater) => {\n      updateCommitteeEntry(committeeId, (prev) => {\n        const currentGroups = Array.isArray(prev.conditionGroups) ? prev.conditionGroups : [];\n        const nextGroups = sanitizeCommitteeConditionGroups(\n          typeof updater === 'function' ? updater(currentGroups) : updater\n        );\n        return applyRuleConditionGroups(prev, nextGroups);\n      });\n    },\n    [sanitizeCommitteeConditionGroups, updateCommitteeEntry]\n  );\n  const withUpdatedCommitteeCondition = useCallback(\n    (groups, groupIndex, conditionIndex, updater) => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n      const currentCondition = sanitizeRuleCondition(\n        conditions[conditionIndex] || createEmptyQuestionCondition()\n      );\n      const updatedCondition = sanitizeRuleCondition(\n        updater ? updater(currentCondition) || currentCondition : currentCondition\n      );\n\n      const nextCondition = updatedCondition.type === 'timing'\n        ? updatedCondition\n        : (() => {\n          const question = questions.find((item) => item.id === updatedCondition.question);\n          const questionType = question?.type || 'choice';\n          return {\n            ...updatedCondition,\n            operator: ensureOperatorForType(questionType, updatedCondition.operator)\n          };\n        })();\n\n      conditions[conditionIndex] = nextCondition;\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    },\n    [questions]\n  );\n  const addCommitteeConditionGroup = useCallback(\n    (committeeId) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => ([\n        ...groups,\n        { logic: 'all', conditions: [createEmptyQuestionCondition()] }\n      ]));\n    },\n    [updateCommitteeConditionGroups]\n  );\n  const updateCommitteeConditionGroupLogic = useCallback(\n    (committeeId, groupIndex, logic) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => {\n        const updated = [...groups];\n        const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n        updated[groupIndex] = {\n          ...target,\n          logic: logic === 'any' ? 'any' : 'all'\n        };\n        return updated;\n      });\n    },\n    [updateCommitteeConditionGroups]\n  );\n  const deleteCommitteeConditionGroup = useCallback(\n    (committeeId, groupIndex) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => groups.filter((_, idx) => idx !== groupIndex));\n    },\n    [updateCommitteeConditionGroups]\n  );\n  const addCommitteeCondition = useCallback(\n    (committeeId, groupIndex) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => {\n        const updated = [...groups];\n        const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n        const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n        conditions.push(createEmptyQuestionCondition());\n        updated[groupIndex] = { ...target, conditions };\n        return updated;\n      });\n    },\n    [updateCommitteeConditionGroups]\n  );\n  const updateCommitteeConditionField = useCallback(\n    (committeeId, groupIndex, conditionIndex, field, value) => {\n      updateCommitteeConditionGroups(committeeId, (groups) =>\n        withUpdatedCommitteeCondition(groups, groupIndex, conditionIndex, (condition) => ({\n          ...condition,\n          [field]: value\n        }))\n      );\n    },\n    [updateCommitteeConditionGroups, withUpdatedCommitteeCondition]\n  );\n  const deleteCommitteeCondition = useCallback(\n    (committeeId, groupIndex, conditionIndex) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => {\n        const updated = [...groups];\n        const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n        const conditions = Array.isArray(target.conditions)\n          ? target.conditions.filter((_, idx) => idx !== conditionIndex)\n          : [];\n        updated[groupIndex] = { ...target, conditions };\n        return updated;\n      });\n    },\n    [updateCommitteeConditionGroups]\n  );\n  const handleCommitteeConditionTypeChange = useCallback(\n    (committeeId, groupIndex, conditionIndex, type) => {\n      updateCommitteeConditionGroups(committeeId, (groups) => {\n        const updated = [...groups];\n        const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n        const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n        const normalizedType = type === 'timing' ? 'timing' : 'question';\n        conditions[conditionIndex] = normalizedType === 'timing'\n          ? createEmptyTimingCondition()\n          : createEmptyQuestionCondition();\n        updated[groupIndex] = { ...target, conditions };\n        return updated;\n      });\n    },\n    [updateCommitteeConditionGroups]\n  );\n\n  const removeCommitteeEntry = useCallback(\n    (committeeId) => {\n      updateValidationCommitteeConfig((prev) => {\n        const normalized = normalizeValidationCommitteeConfig(prev);\n        const nextCommittees = normalized.committees.filter((committee) => committee.id !== committeeId);\n        return {\n          ...normalized,\n          committees: nextCommittees\n        };\n      });\n    },\n    [updateValidationCommitteeConfig]\n  );\n\n  const addCommitteeEntry = useCallback(() => {\n    updateValidationCommitteeConfig((prev) => {\n      const normalized = normalizeValidationCommitteeConfig(prev);\n      return {\n        ...normalized,\n        committees: [\n          ...normalized.committees,\n          createValidationCommittee(normalized.committees.length)\n        ]\n      };\n    });\n  }, [createValidationCommittee, updateValidationCommitteeConfig]);\n\n  const normalizeColorValue = useCallback((value, fallback = '#000000') => {\n    if (typeof value !== 'string') {\n      return fallback;\n    }\n\n    const trimmed = value.trim();\n    if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(trimmed)) {\n      return trimmed;\n    }\n\n    return fallback;\n  }, []);\n\n  const updateShowcaseThemeField = useCallback((themeIndex, field, value) => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      const targetTheme = nextThemes[themeIndex];\n\n      if (!targetTheme) {\n        return previousThemes;\n      }\n\n      const aliases = Array.isArray(targetTheme.aliases) ? targetTheme.aliases.slice() : [];\n      if (field === 'label' && typeof targetTheme.label === 'string' && targetTheme.label.trim().length > 0) {\n        const currentLabel = targetTheme.label.trim();\n        if (!aliases.includes(currentLabel)) {\n          aliases.push(currentLabel);\n        }\n      }\n\n      nextThemes[themeIndex] = {\n        ...targetTheme,\n        [field]: value,\n        aliases\n      };\n\n      return nextThemes;\n    });\n  }, [setShowcaseThemes]);\n\n  const updateShowcaseThemePalette = useCallback((themeIndex, key, value) => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      const targetTheme = nextThemes[themeIndex];\n\n      if (!targetTheme) {\n        return previousThemes;\n      }\n\n      const nextPalette = {\n        ...(targetTheme.palette || {}),\n        [key]: normalizeColorValue(value, targetTheme.palette?.[key] || '#000000')\n      };\n\n      nextThemes[themeIndex] = {\n        ...targetTheme,\n        palette: nextPalette\n      };\n\n      return nextThemes;\n    });\n  }, [normalizeColorValue, setShowcaseThemes]);\n\n  const addShowcaseTheme = useCallback(() => {\n    if (typeof setShowcaseThemes !== 'function') {\n      return;\n    }\n\n    const basePalette = safeShowcaseThemes[0]?.palette || initialShowcaseThemes[0]?.palette || {};\n    const nextIndex = Array.isArray(showcaseThemes) ? showcaseThemes.length + 1 : safeShowcaseThemes.length + 1;\n    const newTheme = {\n      id: `theme-${nextIndex}-${Date.now().toString(36).slice(2, 6)}`,\n      label: 'Nouveau thÃ¨me',\n      description: 'Palette personnalisable via les color-pickers.',\n      aliases: ['Nouveau thÃ¨me'],\n      palette: { ...basePalette }\n    };\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes) ? previousThemes.slice() : [];\n      nextThemes.push(newTheme);\n      return nextThemes;\n    });\n  }, [safeShowcaseThemes, setShowcaseThemes, showcaseThemes]);\n\n  const deleteShowcaseTheme = useCallback((themeId) => {\n    if (typeof setShowcaseThemes !== 'function' || !themeId || showcaseThemeCount <= 1) {\n      return;\n    }\n\n    setShowcaseThemes((previousThemes) => {\n      const nextThemes = Array.isArray(previousThemes)\n        ? previousThemes.filter(theme => theme?.id !== themeId)\n        : [];\n\n      return nextThemes.length > 0 ? nextThemes : previousThemes;\n    });\n  }, [setShowcaseThemes, showcaseThemeCount]);\n\n  const updateOnboardingConfig = useCallback((updater) => {\n    if (typeof setOnboardingTourConfig !== 'function') {\n      return;\n    }\n\n    setOnboardingTourConfig((prevConfig) => {\n      const normalized = normalizeOnboardingConfig(prevConfig);\n      const nextConfig = updater(normalized) || normalized;\n      return normalizeOnboardingConfig(nextConfig);\n    });\n  }, [setOnboardingTourConfig]);\n\n  const updateOnboardingField = useCallback((field, value) => {\n    updateOnboardingConfig(prev => ({ ...prev, [field]: value }));\n  }, [updateOnboardingConfig]);\n\n  const updateOnboardingLabel = useCallback((field, value) => {\n    updateOnboardingConfig(prev => ({\n      ...prev,\n      labels: {\n        ...prev.labels,\n        [field]: value\n      }\n    }));\n  }, [updateOnboardingConfig]);\n\n  const addOnboardingStep = useCallback(() => {\n    updateOnboardingConfig((prev) => {\n      const nextSteps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      nextSteps.push(createOnboardingStep(nextSteps.length));\n      return { ...prev, steps: nextSteps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const moveOnboardingStep = useCallback((index, direction) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      const nextIndex = index + direction;\n      if (nextIndex < 0 || nextIndex >= steps.length) {\n        return prev;\n      }\n      const [removed] = steps.splice(index, 1);\n      steps.splice(nextIndex, 0, removed);\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const deleteOnboardingStep = useCallback((index) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      steps.splice(index, 1);\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const updateOnboardingStepField = useCallback((index, field, value) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      const target = steps[index];\n      if (!target) {\n        return prev;\n      }\n      steps[index] = {\n        ...target,\n        [field]: value\n      };\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const addOnboardingAction = useCallback((stepIndex) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      const target = steps[stepIndex];\n      if (!target) {\n        return prev;\n      }\n      const actions = Array.isArray(target.actions) ? target.actions.slice() : [];\n      actions.push(createOnboardingAction());\n      steps[stepIndex] = { ...target, actions };\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const updateOnboardingActionField = useCallback((stepIndex, actionIndex, field, value) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      const target = steps[stepIndex];\n      if (!target) {\n        return prev;\n      }\n      const actions = Array.isArray(target.actions) ? target.actions.slice() : [];\n      const action = actions[actionIndex];\n      if (!action) {\n        return prev;\n      }\n      actions[actionIndex] = {\n        ...action,\n        [field]: value\n      };\n      steps[stepIndex] = { ...target, actions };\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const deleteOnboardingAction = useCallback((stepIndex, actionIndex) => {\n    updateOnboardingConfig((prev) => {\n      const steps = Array.isArray(prev.steps) ? prev.steps.slice() : [];\n      const target = steps[stepIndex];\n      if (!target) {\n        return prev;\n      }\n      const actions = Array.isArray(target.actions) ? target.actions.slice() : [];\n      actions.splice(actionIndex, 1);\n      steps[stepIndex] = { ...target, actions };\n      return { ...prev, steps };\n    });\n  }, [updateOnboardingConfig]);\n\n  const resetOnboardingConfig = useCallback(() => {\n    if (typeof setOnboardingTourConfig !== 'function') {\n      return;\n    }\n    setOnboardingTourConfig(normalizeOnboardingConfig(initialOnboardingTourConfig));\n  }, [setOnboardingTourConfig]);\n\n  const handleUndo = useCallback(() => {\n    const stack = undoStackRef.current;\n    if (!stack || stack.length === 0) {\n      setUndoMessage('');\n      setCanUndo(false);\n      return;\n    }\n\n    const entry = stack[stack.length - 1];\n    undoStackRef.current = stack.slice(0, -1);\n    setCanUndo(undoStackRef.current.length > 0);\n\n    if (!entry) {\n      setUndoMessage('');\n      return;\n    }\n\n    switch (entry.type) {\n      case 'question': {\n        if (typeof setQuestions === 'function') {\n          setQuestions((prevQuestions) => {\n            const next = Array.isArray(prevQuestions) ? prevQuestions.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`La question Â« ${entry.item?.question || entry.item?.id || 'question'} Â» a Ã©tÃ© restaurÃ©e.`);\n        setReorderAnnouncement('Suppression de question annulÃ©e.');\n        break;\n      }\n      case 'rule': {\n        if (typeof setRules === 'function') {\n          setRules((prevRules) => {\n            const next = Array.isArray(prevRules) ? prevRules.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`La rÃ¨gle Â« ${entry.item?.name || entry.item?.id || 'rÃ¨gle'} Â» a Ã©tÃ© restaurÃ©e.`);\n        setReorderAnnouncement('Suppression de rÃ¨gle annulÃ©e.');\n        break;\n      }\n      case 'riskLevelRule': {\n        if (typeof setRiskLevelRules === 'function') {\n          setRiskLevelRules((prevRules) => {\n            const base = Array.isArray(prevRules) ? prevRules.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? base.length, base.length));\n            base.splice(insertIndex, 0, entry.item);\n            return base;\n          });\n        }\n        setUndoMessage(`Le niveau Â« ${entry.item?.label || entry.item?.id || 'niveau'} Â» a Ã©tÃ© restaurÃ©.`);\n        setReorderAnnouncement('Suppression de niveau de complexitÃ© annulÃ©e.');\n        break;\n      }\n      case 'team': {\n        if (typeof setTeams === 'function') {\n          setTeams((prevTeams) => {\n            const next = Array.isArray(prevTeams) ? prevTeams.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? next.length, next.length));\n            next.splice(insertIndex, 0, entry.item);\n            return next;\n          });\n        }\n        setUndoMessage(`L'Ã©quipe Â« ${entry.item?.name || entry.item?.id || 'Ã©quipe'} Â» a Ã©tÃ© restaurÃ©e.`);\n        setReorderAnnouncement('Suppression dâ€™Ã©quipe annulÃ©e.');\n        break;\n      }\n      case 'projectFilter': {\n        if (typeof setProjectFilters === 'function') {\n          setProjectFilters((prevFilters) => {\n            const normalized = normalizeProjectFilterConfig(prevFilters);\n            const fields = Array.isArray(normalized.fields) ? normalized.fields.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? fields.length, fields.length));\n            fields.splice(insertIndex, 0, entry.item);\n            return {\n              ...normalized,\n              fields\n            };\n          });\n        }\n        setUndoMessage(`Le filtre Â« ${entry.item?.label || entry.item?.id || 'filtre'} Â» a Ã©tÃ© restaurÃ©.`);\n        setReorderAnnouncement('Suppression de filtre annulÃ©e.');\n        break;\n      }\n      case 'inspirationFilter': {\n        if (typeof setInspirationFilters === 'function') {\n          setInspirationFilters((prevFilters) => {\n            const normalized = normalizeInspirationFiltersConfig(prevFilters);\n            const fields = Array.isArray(normalized.fields) ? normalized.fields.slice() : [];\n            const insertIndex = Math.max(0, Math.min(entry.index ?? fields.length, fields.length));\n            fields.splice(insertIndex, 0, entry.item);\n            return {\n              ...normalized,\n              fields\n            };\n          });\n        }\n        setUndoMessage(`Le filtre Â« ${entry.item?.label || entry.item?.id || 'filtre'} Â» a Ã©tÃ© restaurÃ©.`);\n        setReorderAnnouncement('Suppression de filtre annulÃ©e.');\n        break;\n      }\n      default:\n        setUndoMessage('DerniÃ¨re action annulÃ©e.');\n        break;\n    }\n  }, [\n    setQuestions,\n    setRules,\n    setRiskLevelRules,\n    setTeams,\n    setProjectFilters,\n    setInspirationFilters,\n    setReorderAnnouncement\n  ]);\n\n  const confirmDeletion = useCallback((message) => {\n    if (typeof window === 'undefined') {\n      return true;\n    }\n\n    return window.confirm(message);\n  }, []);\n\n  const pushUndoEntry = useCallback((entry) => {\n    undoStackRef.current = [...undoStackRef.current.slice(-19), entry];\n    setCanUndo(true);\n    if (entry && entry.message) {\n      setUndoMessage(entry.message);\n    } else {\n      setUndoMessage('DerniÃ¨re suppression enregistrÃ©e. Vous pouvez utiliser Ctrl+Z pour annuler.');\n    }\n  }, []);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const keydownHandler = (event) => {\n      if ((event.ctrlKey || event.metaKey) && !event.shiftKey && event.key.toLowerCase() === 'z') {\n        const target = event.target;\n        if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable)) {\n          return;\n        }\n\n        if (!undoStackRef.current.length) {\n          return;\n        }\n\n        event.preventDefault();\n        handleUndo();\n      }\n    };\n\n    window.addEventListener('keydown', keydownHandler);\n\n    return () => {\n      window.removeEventListener('keydown', keydownHandler);\n    };\n  }, [handleUndo]);\n\n  const questionTeamAssignments = useMemo(() => {\n    const setMap = new Map();\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    const addTeamsForQuestion = (questionId, teamIds) => {\n      if (!questionId) {\n        return;\n      }\n\n      const normalizedQuestionId = typeof questionId === 'string' ? questionId : String(questionId);\n      const candidates = Array.isArray(teamIds) ? teamIds : [];\n      const validTeamIds = candidates.filter((teamId) => typeof teamId === 'string' && teamId.trim() !== '');\n\n      if (validTeamIds.length === 0) {\n        return;\n      }\n\n      const existing = setMap.get(normalizedQuestionId);\n      if (existing) {\n        validTeamIds.forEach((teamId) => existing.add(teamId));\n        return;\n      }\n\n      setMap.set(normalizedQuestionId, new Set(validTeamIds));\n    };\n\n    safeRules.forEach((rule) => {\n      const aggregatedTeamIds = collectRuleTeamIds(rule);\n      const teamsForRule = Array.from(aggregatedTeamIds);\n\n      if (teamsForRule.length === 0) {\n        return;\n      }\n\n      const baseConditions = Array.isArray(rule?.conditions) ? rule.conditions : [];\n      baseConditions.forEach((condition) => {\n        if (!condition) {\n          return;\n        }\n\n        if (condition.type === 'question' && condition.question) {\n          addTeamsForQuestion(condition.question, teamsForRule);\n          return;\n        }\n\n        if (condition.type === 'timing') {\n          if (condition.startQuestion) {\n            addTeamsForQuestion(condition.startQuestion, teamsForRule);\n          }\n          if (condition.endQuestion) {\n            addTeamsForQuestion(condition.endQuestion, teamsForRule);\n          }\n        }\n      });\n\n      const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n      groups.forEach((group) => {\n        const groupConditions = Array.isArray(group?.conditions) ? group.conditions : [];\n        groupConditions.forEach((condition) => {\n          if (!condition) {\n            return;\n          }\n\n          if (condition.type === 'question' && condition.question) {\n            addTeamsForQuestion(condition.question, teamsForRule);\n            return;\n          }\n\n          if (condition.type === 'timing') {\n            if (condition.startQuestion) {\n              addTeamsForQuestion(condition.startQuestion, teamsForRule);\n            }\n            if (condition.endQuestion) {\n              addTeamsForQuestion(condition.endQuestion, teamsForRule);\n            }\n          }\n        });\n      });\n\n      const risks = Array.isArray(rule?.risks) ? rule.risks : [];\n      risks.forEach((risk) => {\n        const timingConstraint = sanitizeRiskTimingConstraint(risk?.timingConstraint);\n\n        if (!timingConstraint.enabled) {\n          return;\n        }\n\n        const relatedTeams = new Set(teamsForRule);\n        if (risk && typeof risk.teamId === 'string' && risk.teamId.trim() !== '') {\n          relatedTeams.add(risk.teamId);\n        }\n\n        if (timingConstraint.startQuestion) {\n          addTeamsForQuestion(timingConstraint.startQuestion, Array.from(relatedTeams));\n        }\n        if (timingConstraint.endQuestion) {\n          addTeamsForQuestion(timingConstraint.endQuestion, Array.from(relatedTeams));\n        }\n      });\n\n      if (rule?.questions && typeof rule.questions === 'object') {\n        Object.entries(rule.questions).forEach(([teamId, entries]) => {\n          if (typeof teamId !== 'string' || teamId.trim() === '') {\n            return;\n          }\n\n          const sanitizedEntries = Array.isArray(entries) ? entries : [];\n          sanitizedEntries.forEach((entry) => {\n            const sanitizedEntry = sanitizeTeamQuestionEntry(entry);\n            const timingConstraint = sanitizeRiskTimingConstraint(sanitizedEntry?.timingConstraint);\n\n            if (!timingConstraint.enabled) {\n              return;\n            }\n\n            if (timingConstraint.startQuestion) {\n              addTeamsForQuestion(timingConstraint.startQuestion, [teamId]);\n            }\n            if (timingConstraint.endQuestion) {\n              addTeamsForQuestion(timingConstraint.endQuestion, [teamId]);\n            }\n          });\n        });\n      }\n    });\n\n    return new Map(\n      Array.from(setMap.entries()).map(([questionId, teamSet]) => [\n        questionId,\n        Array.from(teamSet)\n      ])\n    );\n  }, [rules]);\n\n  const availableTeamFilterOptions = useMemo(() => {\n    const options = [];\n    const seen = new Set();\n    const safeTeams = Array.isArray(teams) ? teams : [];\n\n    safeTeams.forEach((team) => {\n      if (!team || typeof team.id !== 'string' || team.id.trim() === '' || seen.has(team.id)) {\n        return;\n      }\n\n      options.push({ value: team.id, label: getTeamLabel(team.id, safeTeams) });\n      seen.add(team.id);\n    });\n\n    const safeRules = Array.isArray(rules) ? rules : [];\n    safeRules.forEach((rule) => {\n      collectRuleTeamIds(rule).forEach((teamId) => {\n        if (!teamId || seen.has(teamId)) {\n          return;\n        }\n\n        options.push({ value: teamId, label: getTeamLabel(teamId, safeTeams) });\n        seen.add(teamId);\n      });\n    });\n\n    return options;\n  }, [teams, rules]);\n\n  const visibleQuestionIds = useMemo(() => {\n    const ids = [];\n    const normalizedTitle = questionTitleFilter.trim().toLowerCase();\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n\n    safeQuestions.forEach((question) => {\n      if (!question) {\n        return;\n      }\n\n      const questionId = typeof question.id === 'string' ? question.id : String(question.id || '');\n      if (!questionId) {\n        return;\n      }\n\n      const label = typeof question.question === 'string' ? question.question : '';\n      const titleMatches =\n        normalizedTitle === '' ||\n        label.toLowerCase().includes(normalizedTitle) ||\n        questionId.toLowerCase().includes(normalizedTitle);\n\n      if (!titleMatches) {\n        return;\n      }\n\n      const teamsForQuestion = questionTeamAssignments.get(questionId) || [];\n      let teamMatches = true;\n\n      if (questionTeamFilter === 'none') {\n        teamMatches = teamsForQuestion.length === 0;\n      } else if (questionTeamFilter !== 'all') {\n        teamMatches = teamsForQuestion.includes(questionTeamFilter);\n      }\n\n      if (teamMatches) {\n        ids.push(questionId);\n      }\n    });\n\n    return ids;\n  }, [questions, questionTitleFilter, questionTeamFilter, questionTeamAssignments]);\n\n  const visibleQuestionIdSet = useMemo(() => new Set(visibleQuestionIds), [visibleQuestionIds]);\n  const visibleQuestionEntries = useMemo(() => {\n    const entries = [];\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n\n    safeQuestions.forEach((question, index) => {\n      if (!question || !visibleQuestionIdSet.has(question.id)) {\n        return;\n      }\n\n      entries.push({ question, index });\n    });\n\n    return entries;\n  }, [questions, visibleQuestionIdSet]);\n  const shouldVirtualizeQuestions = visibleQuestionEntries.length > 12;\n\n  const visibleRuleIds = useMemo(() => {\n    const ids = [];\n    const normalizedTitle = ruleTitleFilter.trim().toLowerCase();\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    safeRules.forEach((rule) => {\n      if (!rule) {\n        return;\n      }\n\n      const ruleId = typeof rule.id === 'string' ? rule.id : String(rule.id || '');\n      if (!ruleId) {\n        return;\n      }\n\n      const name = typeof rule.name === 'string' ? rule.name : '';\n      const titleMatches =\n        normalizedTitle === '' ||\n        name.toLowerCase().includes(normalizedTitle) ||\n        ruleId.toLowerCase().includes(normalizedTitle);\n\n      if (!titleMatches) {\n        return;\n      }\n\n      const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n      let teamMatches = true;\n\n      if (ruleTeamFilter === 'none') {\n        teamMatches = associatedTeamIds.length === 0;\n      } else if (ruleTeamFilter !== 'all') {\n        teamMatches = associatedTeamIds.includes(ruleTeamFilter);\n      }\n\n      if (teamMatches) {\n        ids.push(ruleId);\n      }\n    });\n\n    return ids;\n  }, [rules, ruleTitleFilter, ruleTeamFilter]);\n\n  const visibleRuleIdSet = useMemo(() => new Set(visibleRuleIds), [visibleRuleIds]);\n  const visibleRuleEntries = useMemo(() => {\n    const entries = [];\n    const safeRules = Array.isArray(rules) ? rules : [];\n\n    safeRules.forEach((rule) => {\n      if (!rule || !visibleRuleIdSet.has(rule.id)) {\n        return;\n      }\n\n      entries.push(rule);\n    });\n\n    return entries;\n  }, [rules, visibleRuleIdSet]);\n  const shouldVirtualizeRules = visibleRuleEntries.length > 8;\n\n  useEffect(() => {\n    if (questionTeamFilter === 'all' || questionTeamFilter === 'none') {\n      return;\n    }\n\n    const availableValues = new Set(availableTeamFilterOptions.map((option) => option.value));\n    if (!availableValues.has(questionTeamFilter)) {\n      setQuestionTeamFilter('all');\n    }\n  }, [questionTeamFilter, availableTeamFilterOptions]);\n\n  useEffect(() => {\n    if (ruleTeamFilter === 'all' || ruleTeamFilter === 'none') {\n      return;\n    }\n\n    const availableValues = new Set(availableTeamFilterOptions.map((option) => option.value));\n    if (!availableValues.has(ruleTeamFilter)) {\n      setRuleTeamFilter('all');\n    }\n  }, [ruleTeamFilter, availableTeamFilterOptions]);\n\n  const normalizedProjectFilters = useMemo(\n    () => normalizeProjectFilterConfig(projectFilters),\n    [projectFilters]\n  );\n\n  const defaultProjectFiltersConfig = useMemo(\n    () => normalizeProjectFilterConfig(resetProjectFiltersConfig()),\n    []\n  );\n\n  const projectFiltersAreDefault = useMemo(\n    () => JSON.stringify(normalizedProjectFilters) === JSON.stringify(defaultProjectFiltersConfig),\n    [normalizedProjectFilters, defaultProjectFiltersConfig]\n  );\n\n  const filterFields = Array.isArray(normalizedProjectFilters.fields)\n    ? normalizedProjectFilters.fields\n    : [];\n\n  const normalizedInspirationFilters = useMemo(\n    () => normalizeInspirationFiltersConfig(inspirationFilters),\n    [inspirationFilters]\n  );\n  const normalizedInspirationFormFields = useMemo(\n    () => normalizeInspirationFormConfig(inspirationFormFields),\n    [inspirationFormFields]\n  );\n  const defaultInspirationFiltersConfig = useMemo(\n    () => normalizeInspirationFiltersConfig(resetInspirationFiltersConfig()),\n    []\n  );\n  const defaultInspirationFormConfig = useMemo(\n    () => normalizeInspirationFormConfig(resetInspirationFormConfig()),\n    []\n  );\n  const inspirationFiltersAreDefault = useMemo(\n    () => JSON.stringify(normalizedInspirationFilters) === JSON.stringify(defaultInspirationFiltersConfig),\n    [normalizedInspirationFilters, defaultInspirationFiltersConfig]\n  );\n  const inspirationFormAreDefault = useMemo(\n    () => JSON.stringify(normalizedInspirationFormFields) === JSON.stringify(defaultInspirationFormConfig),\n    [normalizedInspirationFormFields, defaultInspirationFormConfig]\n  );\n  const inspirationFilterFields = Array.isArray(normalizedInspirationFilters.fields)\n    ? normalizedInspirationFilters.fields\n    : [];\n  const inspirationFormFieldEntries = Array.isArray(normalizedInspirationFormFields.fields)\n    ? normalizedInspirationFormFields.fields\n    : [];\n  const inspirationFieldIds = useMemo(\n    () => new Set(inspirationFormFieldEntries.map((field) => field.id)),\n    [inspirationFormFieldEntries]\n  );\n\n  const availableFilterQuestionOptions = useMemo(() => {\n    const usedQuestionIds = new Set();\n    if (Array.isArray(normalizedProjectFilters.fields)) {\n      normalizedProjectFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n          ? field.sourceQuestionId.trim()\n          : field.id;\n\n        if (sourceId) {\n          usedQuestionIds.add(sourceId);\n        }\n      });\n    }\n\n    const options = Array.isArray(questions)\n      ? questions\n          .filter((question) => question && FILTER_COMPATIBLE_QUESTION_TYPES.has(question.type))\n          .map((question) => ({\n            value: question.id,\n            label: question.question || question.id,\n            disabled: usedQuestionIds.has(question.id),\n            type: question.type\n          }))\n      : [];\n\n    return options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }));\n  }, [questions, normalizedProjectFilters]);\n\n  const selectedFilterOption = useMemo(() => {\n    if (!selectedFilterQuestionId) {\n      return null;\n    }\n\n    return availableFilterQuestionOptions.find((option) => option.value === selectedFilterQuestionId) || null;\n  }, [availableFilterQuestionOptions, selectedFilterQuestionId]);\n\n  const canAddProjectFilter = Boolean(selectedFilterOption && !selectedFilterOption.disabled);\n\n  const availableInspirationFilterQuestionOptions = useMemo(() => {\n    const usedQuestionIds = new Set();\n\n    if (Array.isArray(normalizedInspirationFilters.fields)) {\n      normalizedInspirationFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n          ? field.sourceQuestionId.trim()\n          : field.id;\n\n        if (sourceId) {\n          usedQuestionIds.add(sourceId);\n        }\n      });\n    }\n\n    const options = Array.isArray(inspirationFormFieldEntries)\n      ? inspirationFormFieldEntries\n          .filter((field) => field && INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES.has(field.type))\n          .map((field) => ({\n            value: field.id,\n            label: field.label || field.id,\n            disabled: usedQuestionIds.has(field.id),\n            type: field.type\n          }))\n      : [];\n\n    return options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }));\n  }, [inspirationFormFieldEntries, normalizedInspirationFilters.fields]);\n\n  const selectedInspirationFilterOption = useMemo(() => {\n    if (!selectedInspirationFilterQuestionId) {\n      return null;\n    }\n\n    return availableInspirationFilterQuestionOptions.find(\n      (option) => option.value === selectedInspirationFilterQuestionId\n    ) || null;\n  }, [availableInspirationFilterQuestionOptions, selectedInspirationFilterQuestionId]);\n\n  const canAddInspirationFilter = Boolean(\n    selectedInspirationFilterOption && !selectedInspirationFilterOption.disabled\n  );\n\n  const handleProjectFilterToggle = useCallback((fieldId, enabled) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(prev => updateProjectFilterField(prev, fieldId, { enabled }));\n  }, [setProjectFilters]);\n\n  const handleProjectFilterLabelChange = useCallback((fieldId, label) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(prev => updateProjectFilterField(prev, fieldId, { label }));\n  }, [setProjectFilters]);\n\n  const handleAddProjectFilter = useCallback(() => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    const questionId = typeof selectedFilterQuestionId === 'string'\n      ? selectedFilterQuestionId.trim()\n      : '';\n\n    if (questionId.length === 0) {\n      return;\n    }\n\n    const question = Array.isArray(questions)\n      ? questions.find((item) => item && item.id === questionId)\n      : null;\n\n    if (!question || !FILTER_COMPATIBLE_QUESTION_TYPES.has(question.type)) {\n      return;\n    }\n\n    setProjectFilters((prev) => {\n      const normalized = normalizeProjectFilterConfig(prev);\n      const existing = Array.isArray(normalized.fields)\n        ? normalized.fields.some((field) => {\n            if (!field) {\n              return false;\n            }\n\n            const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n              ? field.sourceQuestionId.trim()\n              : field.id;\n\n            return sourceId === questionId;\n          })\n        : false;\n\n      if (existing) {\n        return normalized;\n      }\n\n      const type = question.type === 'choice' ? 'select' : 'text';\n      const newField = {\n        id: question.id,\n        label: question.question || question.id,\n        type,\n        enabled: true,\n        sourceQuestionId: question.id\n      };\n\n      if (type === 'select') {\n        newField.emptyOptionLabel = question.id === 'teamLeadTeam' ? 'Toutes les Ã©quipes' : 'Toutes les valeurs';\n      }\n\n      const fields = Array.isArray(normalized.fields) ? [...normalized.fields, newField] : [newField];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n\n    setSelectedFilterQuestionId('');\n  }, [questions, selectedFilterQuestionId, setProjectFilters]);\n\n  const handleAddInspirationFilter = useCallback(() => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const fieldId = typeof selectedInspirationFilterQuestionId === 'string'\n      ? selectedInspirationFilterQuestionId.trim()\n      : '';\n\n    if (fieldId.length === 0) {\n      return;\n    }\n\n    const formField = Array.isArray(inspirationFormFieldEntries)\n      ? inspirationFormFieldEntries.find((field) => field && field.id === fieldId)\n      : null;\n\n    if (!formField || !INSPIRATION_FILTER_COMPATIBLE_FIELD_TYPES.has(formField.type)) {\n      return;\n    }\n\n    setInspirationFilters((prev) => {\n      const normalized = normalizeInspirationFiltersConfig(prev);\n      const existing = Array.isArray(normalized.fields)\n        ? normalized.fields.some((field) => {\n            if (!field) {\n              return false;\n            }\n\n            const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n              ? field.sourceQuestionId.trim()\n              : field.id;\n\n            return sourceId === fieldId;\n          })\n        : false;\n\n      if (existing) {\n        return normalized;\n      }\n\n      const type = formField.type === 'select' || formField.type === 'multi_select' ? 'select' : 'text';\n      const newField = {\n        id: formField.id,\n        label: formField.label || formField.id,\n        type,\n        enabled: true,\n        sourceQuestionId: formField.id\n      };\n\n      if (type === 'select') {\n        newField.emptyOptionLabel = 'Toutes les valeurs';\n        if (Array.isArray(formField.options)) {\n          newField.options = formField.options;\n        }\n      }\n\n      const fields = Array.isArray(normalized.fields) ? [...normalized.fields, newField] : [newField];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n\n    setSelectedInspirationFilterQuestionId('');\n  }, [\n    inspirationFormFieldEntries,\n    selectedInspirationFilterQuestionId,\n    setInspirationFilters\n  ]);\n\n  const handleRemoveProjectFilter = useCallback((field) => {\n    if (!field || typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    if (field.id === 'dateOrder') {\n      return;\n    }\n\n    const label = field.label || field.id || 'filtre';\n    const confirmationMessage = `Voulez-vous vraiment supprimer le filtre Â« ${label} Â» ?`;\n    const shouldDelete = confirmDeletion(confirmationMessage);\n\n    if (!shouldDelete) {\n      return;\n    }\n\n    const currentFields = Array.isArray(normalizedProjectFilters.fields)\n      ? normalizedProjectFilters.fields\n      : [];\n\n    const index = currentFields.findIndex((item) => item && item.id === field.id);\n    if (index === -1) {\n      return;\n    }\n\n    const removedField = currentFields[index];\n    pushUndoEntry({\n      type: 'projectFilter',\n      item: removedField,\n      index,\n      message: `Le filtre Â« ${removedField.label || removedField.id || 'filtre'} Â» a Ã©tÃ© supprimÃ©. Appuyez sur Ctrl+Z pour annuler.`\n    });\n\n    setProjectFilters((prev) => {\n      const normalized = normalizeProjectFilterConfig(prev);\n      const fields = Array.isArray(normalized.fields)\n        ? normalized.fields.filter((item) => item && item.id !== field.id)\n        : [];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n  }, [confirmDeletion, normalizedProjectFilters, pushUndoEntry, setProjectFilters]);\n\n  const handleRemoveInspirationFilter = useCallback((field) => {\n    if (!field || typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const label = field.label || field.id || 'filtre';\n    const confirmationMessage = `Voulez-vous vraiment supprimer le filtre Â« ${label} Â» ?`;\n    const shouldDelete = confirmDeletion(confirmationMessage);\n\n    if (!shouldDelete) {\n      return;\n    }\n\n    const currentFields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    const index = currentFields.findIndex((item) => item && item.id === field.id);\n    if (index === -1) {\n      return;\n    }\n\n    const removedField = currentFields[index];\n    pushUndoEntry({\n      type: 'inspirationFilter',\n      item: removedField,\n      index,\n      message: `Le filtre Â« ${removedField.label || removedField.id || 'filtre'} Â» a Ã©tÃ© supprimÃ©. Appuyez sur Ctrl+Z pour annuler.`\n    });\n\n    setInspirationFilters((prev) => {\n      const normalized = normalizeInspirationFiltersConfig(prev);\n      const fields = Array.isArray(normalized.fields)\n        ? normalized.fields.filter((item) => item && item.id !== field.id)\n        : [];\n\n      return {\n        ...normalized,\n        fields\n      };\n    });\n  }, [confirmDeletion, normalizedInspirationFilters, pushUndoEntry, setInspirationFilters]);\n\n  const handleProjectFilterDefaultSortChange = useCallback((value) => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    const direction = value === 'asc' ? 'asc' : 'desc';\n    setProjectFilters(prev => {\n      const updated = updateProjectFilterField(prev, 'dateOrder', { defaultValue: direction });\n      return {\n        ...updated,\n        sortOrder: direction\n      };\n    });\n  }, [setProjectFilters]);\n\n  const handleResetProjectFilters = useCallback(() => {\n    if (typeof setProjectFilters !== 'function') {\n      return;\n    }\n\n    setProjectFilters(resetProjectFiltersConfig());\n  }, [setProjectFilters]);\n\n  const formatOptionList = (options) => (Array.isArray(options) ? options.join(', ') : '');\n\n  const parseOptionList = (value) => {\n    if (typeof value !== 'string') {\n      return [];\n    }\n\n    return value\n      .split(',')\n      .map((option) => option.trim())\n      .filter((option) => option.length > 0);\n  };\n\n  const sanitizeInspirationFieldId = (value) => {\n    if (typeof value !== 'string') {\n      return '';\n    }\n\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return '';\n    }\n\n    return trimmed\n      .replace(/\\s+/g, '_')\n      .replace(/[^a-zA-Z0-9_-]/g, '');\n  };\n\n  const suggestedNewInspirationFieldId = useMemo(() => {\n    const directId = sanitizeInspirationFieldId(newInspirationFormField.id);\n    if (directId) {\n      return directId;\n    }\n\n    return sanitizeInspirationFieldId(newInspirationFormField.label);\n  }, [newInspirationFormField.id, newInspirationFormField.label]);\n\n  const isNewInspirationFieldIdDuplicate =\n    suggestedNewInspirationFieldId.length > 0 && inspirationFieldIds.has(suggestedNewInspirationFieldId);\n\n  const canAddInspirationFormField =\n    suggestedNewInspirationFieldId.length > 0\n    && newInspirationFormField.label.trim().length > 0\n    && !isNewInspirationFieldIdDuplicate;\n\n  const handleInspirationFilterToggle = useCallback((fieldId, enabled) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { enabled }));\n  }, [setInspirationFilters]);\n\n  const handleInspirationFilterLabelChange = useCallback((fieldId, label) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { label }));\n  }, [setInspirationFilters]);\n\n  const handleInspirationFilterOptionsChange = useCallback((fieldId, rawValue) => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    const options = parseOptionList(rawValue);\n    setInspirationFilters((prev) => updateInspirationFilterField(prev, fieldId, { options }));\n  }, [setInspirationFilters]);\n\n  const handleResetInspirationFilters = useCallback(() => {\n    if (typeof setInspirationFilters !== 'function') {\n      return;\n    }\n\n    setInspirationFilters(resetInspirationFiltersConfig());\n  }, [setInspirationFilters]);\n\n  const handleInspirationFormFieldToggle = useCallback((fieldId, enabled) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { enabled }));\n  }, [setInspirationFilters, setInspirationFormFields]);\n\n  const handleInspirationFormFieldLabelChange = useCallback((fieldId, label) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { label }));\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldTypeChange = useCallback((fieldId, nextType) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const normalizedType = INSPIRATION_FORM_FIELD_TYPE_OPTIONS.some((option) => option.value === nextType)\n      ? nextType\n      : 'text';\n\n    setInspirationFormFields((prev) => {\n      const normalized = normalizeInspirationFormConfig(prev);\n      const currentField = normalized.fields.find((field) => field.id === fieldId);\n      const nextOptions = normalizedType === 'select' || normalizedType === 'multi_select'\n        ? (Array.isArray(currentField?.options) && currentField.options.length > 0\n          ? currentField.options\n          : ['Option 1', 'Option 2'])\n        : undefined;\n\n      return updateInspirationFormField(prev, fieldId, {\n        type: normalizedType,\n        options: nextOptions\n      });\n    });\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldPlaceholderChange = useCallback((fieldId, placeholder) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { placeholder }));\n  }, [setInspirationFormFields]);\n\n  const handleInspirationFormFieldOptionsChange = useCallback((fieldId, rawValue) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const options = parseOptionList(rawValue);\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { options }));\n    if (typeof setInspirationFilters === 'function') {\n      setInspirationFilters((prev) => {\n        const normalized = normalizeInspirationFiltersConfig(prev);\n        let nextConfig = normalized;\n\n        normalized.fields.forEach((field) => {\n          const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n            ? field.sourceQuestionId.trim()\n            : field.id;\n\n          if (sourceId === fieldId && field.type === 'select') {\n            nextConfig = updateInspirationFilterField(nextConfig, field.id, { options });\n          }\n        });\n\n        return nextConfig;\n      });\n    }\n  }, [setInspirationFormFields]);\n\n  const handleAddInspirationFormField = useCallback(() => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    const label = newInspirationFormField.label.trim();\n    if (!label) {\n      return;\n    }\n\n    const fieldId = suggestedNewInspirationFieldId;\n    if (!fieldId || inspirationFieldIds.has(fieldId)) {\n      return;\n    }\n\n    const normalizedType = INSPIRATION_FORM_FIELD_TYPE_OPTIONS.some((option) => option.value === newInspirationFormField.type)\n      ? newInspirationFormField.type\n      : 'text';\n\n    const nextField = {\n      id: fieldId,\n      label,\n      type: normalizedType,\n      enabled: Boolean(newInspirationFormField.enabled),\n      required: Boolean(newInspirationFormField.required)\n    };\n\n    const placeholder = newInspirationFormField.placeholder.trim();\n    if (INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(normalizedType) && placeholder.length > 0) {\n      nextField.placeholder = placeholder;\n    }\n\n    if (normalizedType === 'select' || normalizedType === 'multi_select') {\n      const parsedOptions = parseOptionList(newInspirationFormField.options);\n      nextField.options = parsedOptions.length > 0 ? parsedOptions : ['Option 1', 'Option 2'];\n    }\n\n    setInspirationFormFields((prev) => {\n      const normalized = normalizeInspirationFormConfig(prev);\n      return {\n        ...normalized,\n        fields: [...normalized.fields, nextField]\n      };\n    });\n\n    setNewInspirationFormField(createEmptyInspirationFormField());\n  }, [\n    inspirationFieldIds,\n    newInspirationFormField,\n    setInspirationFormFields,\n    suggestedNewInspirationFieldId\n  ]);\n\n  const handleInspirationFormFieldRequiredChange = useCallback((fieldId, required) => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prev) => updateInspirationFormField(prev, fieldId, { required }));\n  }, [setInspirationFormFields]);\n\n  const handleResetInspirationFormFields = useCallback(() => {\n    if (typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields(resetInspirationFormConfig());\n  }, [setInspirationFormFields]);\n\n  const toggleQuestionExpansion = useCallback((questionId) => {\n    if (!questionId && questionId !== 0) {\n      return;\n    }\n\n    const normalizedId = typeof questionId === 'string' ? questionId : String(questionId);\n    setExpandedQuestionIds((prev) => {\n      const next = new Set(prev);\n      if (next.has(normalizedId)) {\n        next.delete(normalizedId);\n      } else {\n        next.add(normalizedId);\n      }\n      return next;\n    });\n  }, []);\n\n  const toggleRuleExpansion = useCallback((ruleId) => {\n    if (!ruleId && ruleId !== 0) {\n      return;\n    }\n\n    const normalizedId = typeof ruleId === 'string' ? ruleId : String(ruleId);\n    setExpandedRuleIds((prev) => {\n      const next = new Set(prev);\n      if (next.has(normalizedId)) {\n        next.delete(normalizedId);\n      } else {\n        next.add(normalizedId);\n      }\n      return next;\n    });\n  }, []);\n\n  const handleRiskWeightChange = (key, rawValue) => {\n    if (typeof setRiskWeights !== 'function') {\n      return;\n    }\n\n    setRiskWeights(prevWeights => {\n      const base = typeof prevWeights === 'object' && prevWeights !== null\n        ? { ...prevWeights }\n        : {};\n\n      const parsed = Number.parseFloat(rawValue);\n\n      if (Number.isNaN(parsed)) {\n        return prevWeights;\n      }\n\n      const sanitized = parsed < 0 ? 0 : parsed;\n\n      if (base[key] === sanitized) {\n        return prevWeights;\n      }\n\n      base[key] = sanitized;\n      return base;\n    });\n  };\n\n  const dataIntegrityIssues = useMemo(() => {\n    const safeQuestions = Array.isArray(questions) ? questions : [];\n    const safeRules = Array.isArray(rules) ? rules : [];\n    const safeTeams = Array.isArray(teams) ? teams : [];\n\n    const questionMap = new Map();\n    safeQuestions.forEach((question) => {\n      if (question?.id) {\n        questionMap.set(question.id, question);\n      }\n    });\n\n    const questionIds = new Set(questionMap.keys());\n\n    const questionOptionMap = new Map();\n    questionMap.forEach((question, id) => {\n      if (Array.isArray(question?.options) && question.options.length > 0) {\n        const normalizedOptions = question.options\n          .map((option) => {\n            if (\n              typeof option === 'string' ||\n              typeof option === 'number' ||\n              typeof option === 'boolean'\n            ) {\n              return String(option);\n            }\n            return null;\n          })\n          .filter(Boolean);\n\n        if (normalizedOptions.length > 0) {\n          questionOptionMap.set(id, new Set(normalizedOptions));\n        }\n      }\n    });\n\n    const teamIds = new Set(\n      safeTeams\n        .map((team) => (team?.id ? team.id : null))\n        .filter(Boolean)\n    );\n    const teamNameMap = new Map();\n    safeTeams.forEach(team => {\n      if (team?.id) {\n        teamNameMap.set(team.id, team?.name || team.id);\n      }\n    });\n\n    const issues = [];\n    let issueIndex = 0;\n\n    const pushIssue = ({ scope, context, message, severity = 'warning' }) => {\n      issueIndex += 1;\n      issues.push({\n        id: `integrity-${issueIndex}`,\n        scope,\n        context,\n        message,\n        severity\n      });\n    };\n\n    const formatConditionPosition = (groupIndex, conditionIndex) => {\n      return `groupe ${groupIndex + 1}, condition ${conditionIndex + 1}`;\n    };\n\n    const getQuestionLabel = (questionId) => {\n      const reference = questionMap.get(questionId);\n      if (!reference) {\n        return questionId || 'Question inconnue';\n      }\n      return reference.question || reference.id || questionId;\n    };\n\n    const collectInvalidOptionValues = (value, optionsSet) => {\n      if (!optionsSet || optionsSet.size === 0) {\n        return [];\n      }\n\n      const invalidValues = [];\n      const inspectValue = (candidate) => {\n        if (candidate === null || candidate === undefined) {\n          return;\n        }\n        if (\n          typeof candidate !== 'string' &&\n          typeof candidate !== 'number' &&\n          typeof candidate !== 'boolean'\n        ) {\n          return;\n        }\n\n        const normalizedCandidate = String(candidate);\n        if (!optionsSet.has(normalizedCandidate)) {\n          invalidValues.push(normalizedCandidate);\n        }\n      };\n\n      if (Array.isArray(value)) {\n        value.forEach(inspectValue);\n      } else {\n        inspectValue(value);\n      }\n\n      return invalidValues;\n    };\n\n    safeQuestions.forEach((question) => {\n      const groups = normalizeConditionGroups(question);\n      const context = `Question Â« ${question.question || question.id || 'Sans titre'} Â»`;\n\n      groups.forEach((group, groupIndex) => {\n        const conditions = Array.isArray(group?.conditions) ? group.conditions : [];\n\n        conditions.forEach((condition, conditionIndex) => {\n          if (!condition) {\n            return;\n          }\n\n          const position = formatConditionPosition(groupIndex, conditionIndex);\n          const targetId = condition.question;\n\n          if (!targetId) {\n            pushIssue({\n              scope: 'questions',\n              context,\n              message: `La condition ${position} n'indique aucune question de rÃ©fÃ©rence. SÃ©lectionnez une question cible ou retirez cette condition.`\n            });\n            return;\n          }\n\n          if (!questionIds.has(targetId)) {\n            pushIssue({\n              scope: 'questions',\n              context,\n              message: `La condition ${position} rÃ©fÃ©rence la question Â« ${targetId} Â» qui n'existe plus. Mettez Ã  jour le ciblage ou supprimez cette condition.`\n            });\n            return;\n          }\n\n          const optionsSet = questionOptionMap.get(targetId);\n          if (optionsSet && optionsSet.size > 0) {\n            const invalidValues = collectInvalidOptionValues(condition.value, optionsSet);\n\n            if (invalidValues.length > 0) {\n              const formattedValues = invalidValues.map((value) => `Â« ${value} Â»`).join(', ');\n              const targetLabel = getQuestionLabel(targetId);\n\n              pushIssue({\n                scope: 'questions',\n                context,\n                message: `La condition ${position} utilise ${formattedValues} qui ne fait pas partie des options disponibles pour Â« ${targetLabel} Â». Ajustez la valeur attendue.`\n              });\n            }\n          }\n        });\n      });\n    });\n\n    safeRules.forEach((rule) => {\n      const ruleLabel = rule?.name || rule?.id || 'RÃ¨gle';\n      const context = `RÃ¨gle Â« ${ruleLabel} Â»`;\n      const groups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n\n      groups.forEach((group, groupIndex) => {\n        const conditions = Array.isArray(group?.conditions) ? group.conditions : [];\n\n        conditions.forEach((condition, conditionIndex) => {\n          if (!condition) {\n            return;\n          }\n\n          const position = formatConditionPosition(groupIndex, conditionIndex);\n\n          if (condition.type === 'timing') {\n            if (!condition.startQuestion) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition temporelle ${position} ne dÃ©finit pas de question de dÃ©part. SÃ©lectionnez une question d'origine.`\n              });\n            } else if (!questionIds.has(condition.startQuestion)) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La question de dÃ©part Â« ${condition.startQuestion} Â» utilisÃ©e dans la condition temporelle ${position} n'existe plus.`\n              });\n            }\n\n            if (!condition.endQuestion) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition temporelle ${position} ne dÃ©finit pas de question d'arrivÃ©e. SÃ©lectionnez une question de fin.`\n              });\n            } else if (!questionIds.has(condition.endQuestion)) {\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La question de fin Â« ${condition.endQuestion} Â» utilisÃ©e dans la condition temporelle ${position} n'existe plus.`\n              });\n            }\n\n            return;\n          }\n\n          const targetId = condition.question;\n\n          if (!targetId) {\n            pushIssue({\n              scope: 'rules',\n              context,\n              message: `La condition ${position} n'indique aucune question de rÃ©fÃ©rence. ComplÃ©tez la configuration ou supprimez cette condition.`\n            });\n            return;\n          }\n\n          if (!questionIds.has(targetId)) {\n            pushIssue({\n              scope: 'rules',\n              context,\n              message: `La condition ${position} rÃ©fÃ©rence la question Â« ${targetId} Â» qui n'existe plus. Mettez Ã  jour la condition.`\n            });\n            return;\n          }\n\n          const optionsSet = questionOptionMap.get(targetId);\n          if (optionsSet && optionsSet.size > 0) {\n            const invalidValues = collectInvalidOptionValues(condition.value, optionsSet);\n\n            if (invalidValues.length > 0) {\n              const formattedValues = invalidValues.map((value) => `Â« ${value} Â»`).join(', ');\n              const targetLabel = getQuestionLabel(targetId);\n\n              pushIssue({\n                scope: 'rules',\n                context,\n                message: `La condition ${position} utilise ${formattedValues} qui ne sont pas proposÃ©s par Â« ${targetLabel} Â». Ajustez la valeur ou les options.`\n              });\n            }\n          }\n        });\n      });\n\n      const ruleTeams = Array.isArray(rule?.teams) ? rule.teams : [];\n      ruleTeams.forEach((teamId) => {\n        if (!teamId) {\n          return;\n        }\n\n        if (!teamIds.has(teamId)) {\n          pushIssue({\n            scope: 'teams',\n            context,\n            message: `L'Ã©quipe Â« ${teamId} Â» n'existe plus dans le rÃ©fÃ©rentiel. Retirez-la de la rÃ¨gle ou ajoutez l'Ã©quipe correspondante.`\n          });\n        }\n      });\n\n      if (rule?.questions && typeof rule.questions === 'object') {\n        Object.entries(rule.questions).forEach(([teamId, teamQuestions]) => {\n          if (!teamIds.has(teamId)) {\n            pushIssue({\n              scope: 'teams',\n              context,\n              message: `La section d'accompagnement Â« ${teamId} Â» n'est associÃ©e Ã  aucune Ã©quipe existante. Renommez la clÃ© ou crÃ©ez l'Ã©quipe correspondante.`\n            });\n            return;\n          }\n\n          const entries = Array.isArray(teamQuestions) ? teamQuestions : [];\n          entries.forEach((questionEntry, questionIndex) => {\n            const sanitizedEntry = sanitizeTeamQuestionEntry(questionEntry);\n            const questionLabel = sanitizedEntry.text ? sanitizedEntry.text : `Question ${questionIndex + 1}`;\n            const questionContext = `RÃ¨gle Â« ${ruleLabel} Â» Â· ${teamNameMap.get(teamId) || teamId} Â· ${questionLabel}`;\n            const timingConstraint = sanitizeRiskTimingConstraint(sanitizedEntry.timingConstraint);\n\n            if (timingConstraint.enabled) {\n              if (!timingConstraint.startQuestion) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `Le contrÃ´le de dÃ©lai ne dÃ©finit pas de question de dÃ©part. SÃ©lectionnez une question de dÃ©but.`\n                });\n              } else if (!questionIds.has(timingConstraint.startQuestion)) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `La question de dÃ©part Â« ${timingConstraint.startQuestion} Â» utilisÃ©e pour le dÃ©lai n'existe plus.`\n                });\n              } else {\n                const startQuestion = questionMap.get(timingConstraint.startQuestion);\n                if ((startQuestion?.type || 'choice') !== 'date') {\n                  pushIssue({\n                    scope: 'rules',\n                    context: questionContext,\n                    message: `La question de dÃ©part Â« ${timingConstraint.startQuestion} Â» n'est pas de type date. Choisissez une question de type date.`\n                  });\n                }\n              }\n\n              if (!timingConstraint.endQuestion) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `Le contrÃ´le de dÃ©lai ne dÃ©finit pas de question d'arrivÃ©e. SÃ©lectionnez une question de fin.`\n                });\n              } else if (!questionIds.has(timingConstraint.endQuestion)) {\n                pushIssue({\n                  scope: 'rules',\n                  context: questionContext,\n                  message: `La question de fin Â« ${timingConstraint.endQuestion} Â» utilisÃ©e pour le dÃ©lai n'existe plus.`\n                });\n              } else {\n                const endQuestion = questionMap.get(timingConstraint.endQuestion);\n                if ((endQuestion?.type || 'choice') !== 'date') {\n                  pushIssue({\n                    scope: 'rules',\n                    context: questionContext,\n                    message: `La question de fin Â« ${timingConstraint.endQuestion} Â» n'est pas de type date. Choisissez une question de type date.`\n                  });\n                }\n              }\n            }\n          });\n        });\n      }\n    });\n\n    return issues;\n  }, [questions, rules, teams]);\n\n  const dataIntegritySummary = useMemo(() => {\n    if (!dataIntegrityIssues || dataIntegrityIssues.length === 0) {\n      return [];\n    }\n\n    const labels = {\n      questions: 'Questions',\n      rules: 'RÃ¨gles',\n      teams: 'Ã‰quipes',\n      general: 'GÃ©nÃ©ral'\n    };\n\n    const counts = dataIntegrityIssues.reduce((accumulator, issue) => {\n      const key = issue.scope || 'general';\n      const current = accumulator[key] || 0;\n      return { ...accumulator, [key]: current + 1 };\n    }, {});\n\n    return Object.entries(counts).map(([scope, count]) => ({\n      scope,\n      count,\n      label: labels[scope] || 'Autres'\n    }));\n  }, [dataIntegrityIssues]);\n\n  useEffect(() => {\n    if (!reorderAnnouncement || typeof window === 'undefined') {\n      return undefined;\n    }\n\n    const timeout = window.setTimeout(() => {\n      setReorderAnnouncement('');\n    }, 2000);\n\n    return () => {\n      window.clearTimeout(timeout);\n    };\n  }, [reorderAnnouncement]);\n\n  const moveQuestion = (fromIndex, toIndex) => {\n    if (fromIndex === toIndex) {\n      return;\n    }\n\n    setQuestions(prevQuestions => {\n      if (\n        fromIndex < 0 ||\n        fromIndex >= prevQuestions.length ||\n        toIndex < 0 ||\n        toIndex >= prevQuestions.length\n      ) {\n        return prevQuestions;\n      }\n\n      const updated = [...prevQuestions];\n      const [movedQuestion] = updated.splice(fromIndex, 1);\n      updated.splice(toIndex, 0, movedQuestion);\n\n      if (movedQuestion) {\n        const label = movedQuestion.question || movedQuestion.id || 'Question';\n        setReorderAnnouncement(`La question Â« ${label} Â» est maintenant en position ${toIndex + 1} sur ${updated.length}.`);\n      }\n\n      return updated;\n    });\n  };\n\n  const handleDragStart = (event, index) => {\n    if (event?.dataTransfer) {\n      event.dataTransfer.effectAllowed = 'move';\n      event.dataTransfer.setData('text/plain', String(index));\n    }\n    setDraggedQuestionIndex(index);\n    setDragOverIndex(index);\n  };\n\n  const handleDragOver = (event, index) => {\n    event.preventDefault();\n    if (dragOverIndex !== index) {\n      setDragOverIndex(index);\n    }\n  };\n\n  const handleDrop = (event, index) => {\n    event.preventDefault();\n\n    let fromIndex = draggedQuestionIndex;\n    if (fromIndex === null) {\n      const transferIndex = Number.parseInt(event?.dataTransfer?.getData('text/plain'), 10);\n      if (Number.isFinite(transferIndex)) {\n        fromIndex = transferIndex;\n      }\n    }\n\n    if (fromIndex !== null) {\n      moveQuestion(fromIndex, index);\n    }\n\n    setDraggedQuestionIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedQuestionIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleKeyboardReorder = (event, index) => {\n    if (questions.length <= 1) {\n      return;\n    }\n\n    if (event.key === 'ArrowUp' && index > 0) {\n      event.preventDefault();\n      moveQuestion(index, index - 1);\n    } else if (event.key === 'ArrowDown' && index < questions.length - 1) {\n      event.preventDefault();\n      moveQuestion(index, index + 1);\n    } else if (event.key === 'Home') {\n      event.preventDefault();\n      moveQuestion(index, 0);\n    } else if (event.key === 'End') {\n      event.preventDefault();\n      moveQuestion(index, questions.length - 1);\n    }\n  };\n\n  const moveInspirationFormField = (fromIndex, toIndex) => {\n    if (fromIndex === toIndex || typeof setInspirationFormFields !== 'function') {\n      return;\n    }\n\n    setInspirationFormFields((prevFields) => {\n      const normalized = normalizeInspirationFormConfig(prevFields);\n      const fields = Array.isArray(normalized.fields) ? normalized.fields.slice() : [];\n\n      if (\n        fromIndex < 0 ||\n        fromIndex >= fields.length ||\n        toIndex < 0 ||\n        toIndex >= fields.length\n      ) {\n        return prevFields;\n      }\n\n      const [movedField] = fields.splice(fromIndex, 1);\n      fields.splice(toIndex, 0, movedField);\n\n      if (movedField) {\n        const label = movedField.label || movedField.id || 'Champ';\n        setReorderAnnouncement(`Le champ Â« ${label} Â» est maintenant en position ${toIndex + 1} sur ${fields.length}.`);\n      }\n\n      return { ...normalized, fields };\n    });\n  };\n\n  const handleInspirationFieldDragStart = (event, index) => {\n    if (event?.dataTransfer) {\n      event.dataTransfer.effectAllowed = 'move';\n      event.dataTransfer.setData('text/plain', String(index));\n    }\n    setDraggedInspirationFieldIndex(index);\n    setDragOverInspirationFieldIndex(index);\n  };\n\n  const handleInspirationFieldDragOver = (event, index) => {\n    event.preventDefault();\n    if (dragOverInspirationFieldIndex !== index) {\n      setDragOverInspirationFieldIndex(index);\n    }\n  };\n\n  const handleInspirationFieldDrop = (event, index) => {\n    event.preventDefault();\n\n    let fromIndex = draggedInspirationFieldIndex;\n    if (fromIndex === null) {\n      const transferIndex = Number.parseInt(event?.dataTransfer?.getData('text/plain'), 10);\n      if (Number.isFinite(transferIndex)) {\n        fromIndex = transferIndex;\n      }\n    }\n\n    if (fromIndex !== null) {\n      moveInspirationFormField(fromIndex, index);\n    }\n\n    setDraggedInspirationFieldIndex(null);\n    setDragOverInspirationFieldIndex(null);\n  };\n\n  const handleInspirationFieldDragEnd = () => {\n    setDraggedInspirationFieldIndex(null);\n    setDragOverInspirationFieldIndex(null);\n  };\n\n  const handleInspirationFieldKeyboardReorder = (event, index) => {\n    if (inspirationFormFieldEntries.length <= 1) {\n      return;\n    }\n\n    if (event.key === 'ArrowUp' && index > 0) {\n      event.preventDefault();\n      moveInspirationFormField(index, index - 1);\n    } else if (event.key === 'ArrowDown' && index < inspirationFormFieldEntries.length - 1) {\n      event.preventDefault();\n      moveInspirationFormField(index, index + 1);\n    } else if (event.key === 'Home') {\n      event.preventDefault();\n      moveInspirationFormField(index, 0);\n    } else if (event.key === 'End') {\n      event.preventDefault();\n      moveInspirationFormField(index, inspirationFormFieldEntries.length - 1);\n    }\n  };\n\n  const getNextId = (items, prefix) => {\n    const ids = new Set(items.map((item) => item.id));\n    const maxNumericSuffix = items\n      .map((item) => item.id)\n      .filter((id) => typeof id === 'string' && id.startsWith(prefix))\n      .map((id) => Number.parseInt(id.slice(prefix.length), 10))\n      .filter((value) => Number.isFinite(value))\n      .reduce((max, value) => Math.max(max, value), 0);\n\n    let counter = maxNumericSuffix + 1;\n    let candidate = `${prefix}${counter}`;\n    while (ids.has(candidate)) {\n      counter += 1;\n      candidate = `${prefix}${counter}`;\n    }\n    return candidate;\n  };\n\n  const cloneData = (value) => {\n    if (Array.isArray(value)) {\n      return value.map((item) => cloneData(item));\n    }\n    if (value && typeof value === 'object') {\n      const cloned = {};\n      Object.keys(value).forEach((key) => {\n        cloned[key] = cloneData(value[key]);\n      });\n      return cloned;\n    }\n    return value;\n  };\n\n  const getDuplicateId = (items, baseId, fallbackPrefix) => {\n    const existingIds = new Set(items.map((item) => item.id));\n    const rawBase = typeof baseId === 'string' ? baseId.trim() : '';\n    const sanitizedBase = rawBase !== '' ? rawBase.replace(/\\s+/g, '_') : '';\n\n    if (sanitizedBase) {\n      let candidate = `${sanitizedBase}_copy`;\n      let counter = 2;\n\n      while (existingIds.has(candidate)) {\n        candidate = `${sanitizedBase}_copy${counter}`;\n        counter += 1;\n      }\n\n      return candidate;\n    }\n\n    return getNextId(items, fallbackPrefix);\n  };\n\n  const addRiskLevelRule = () => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    const nextId = getNextId(safeRiskLevelRules, 'risk_level_');\n    const lastRule = safeRiskLevelRules[safeRiskLevelRules.length - 1];\n    const baseMinimum = lastRule\n      ? Math.max(\n        0,\n        (() => {\n          const lastMax = getRuleMaxScoreValue(lastRule);\n          if (lastMax !== null) {\n            return lastMax + 1;\n          }\n          const lastMin = getRuleMinScoreValue(lastRule);\n          return lastMin + 1;\n        })()\n      )\n      : 0;\n\n    const newRule = {\n      id: nextId,\n      label: 'Nouveau niveau',\n      minRisks: baseMinimum,\n      maxRisks: null,\n      minScore: baseMinimum,\n      maxScore: null,\n      description: ''\n    };\n\n    setRiskLevelRules([...safeRiskLevelRules, newRule]);\n    setActiveTab('riskLevels');\n    setReorderAnnouncement(`Niveau de risque ajoutÃ© en position ${safeRiskLevelRules.length + 1}.`);\n  };\n\n  const updateRiskLevelRuleField = (index, field, value) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (!baseRules[index]) {\n        return prevRules;\n      }\n\n      const updatedRule = { ...baseRules[index] };\n\n      if (field === 'label') {\n        updatedRule.label = value;\n      } else if (field === 'description') {\n        updatedRule.description = value;\n      } else if (field === 'minRisks' || field === 'minScore') {\n        const parsed = Number.parseFloat(value);\n        const sanitized = Number.isNaN(parsed) ? 0 : Math.max(0, parsed);\n        updatedRule.minRisks = sanitized;\n        updatedRule.minScore = sanitized;\n      } else if (field === 'maxRisks' || field === 'maxScore') {\n        if (value === '' || value === null) {\n          updatedRule.maxRisks = null;\n          updatedRule.maxScore = null;\n        } else {\n          const parsed = Number.parseFloat(value);\n          if (Number.isNaN(parsed)) {\n            updatedRule.maxRisks = null;\n            updatedRule.maxScore = null;\n          } else {\n            const sanitized = Math.max(0, parsed);\n            updatedRule.maxRisks = sanitized;\n            updatedRule.maxScore = sanitized;\n          }\n        }\n      }\n\n      baseRules[index] = updatedRule;\n      return baseRules;\n    });\n  };\n\n  const deleteRiskLevelRule = (id, index) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    if (safeRiskLevelRules.length <= 1) {\n      setReorderAnnouncement('Au moins un niveau de risque doit Ãªtre conservÃ©.');\n      return;\n    }\n\n    const normalizedIndex = Number.isInteger(index) && index >= 0\n      ? index\n      : safeRiskLevelRules.findIndex((rule) => rule?.id === id);\n\n    if (normalizedIndex < 0 || normalizedIndex >= safeRiskLevelRules.length) {\n      return;\n    }\n\n    const targetRule = safeRiskLevelRules[normalizedIndex];\n    const label = targetRule?.label || targetRule?.id || `Niveau ${normalizedIndex + 1}`;\n\n    if (!confirmDeletion(`ÃŠtes-vous sÃ»r de vouloir supprimer le niveau de complexitÃ© Â« ${label} Â» ? Cette action peut Ãªtre annulÃ©e (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'riskLevelRule',\n      index: normalizedIndex,\n      item: cloneData(targetRule),\n      message: `Le niveau Â« ${label} Â» a Ã©tÃ© supprimÃ©. Cliquez sur Â« Annuler Â» ou utilisez Ctrl+Z pour le restaurer.`,\n    });\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (normalizedIndex < 0 || normalizedIndex >= baseRules.length) {\n        return baseRules;\n      }\n      baseRules.splice(normalizedIndex, 1);\n      return baseRules;\n    });\n\n    setReorderAnnouncement(`Niveau de risque supprimÃ©. ${Math.max(safeRiskLevelRules.length - 1, 0)} niveau(x) restant(s).`);\n  };\n\n  const moveRiskLevelRule = (fromIndex, toIndex) => {\n    if (typeof setRiskLevelRules !== 'function') {\n      return;\n    }\n\n    if (\n      fromIndex === toIndex ||\n      fromIndex < 0 ||\n      toIndex < 0 ||\n      fromIndex >= safeRiskLevelRules.length ||\n      toIndex >= safeRiskLevelRules.length\n    ) {\n      return;\n    }\n\n    const movedRule = safeRiskLevelRules[fromIndex];\n\n    setRiskLevelRules(prevRules => {\n      const baseRules = Array.isArray(prevRules) ? [...prevRules] : [];\n      if (\n        fromIndex < 0 ||\n        fromIndex >= baseRules.length ||\n        toIndex < 0 ||\n        toIndex >= baseRules.length\n      ) {\n        return prevRules;\n      }\n\n      const next = [...baseRules];\n      const [extracted] = next.splice(fromIndex, 1);\n      next.splice(toIndex, 0, extracted);\n      return next;\n    });\n\n    if (movedRule) {\n      const label = movedRule.label || movedRule.id || 'Niveau de risque';\n      setReorderAnnouncement(`Le niveau Â« ${label} Â» est maintenant en position ${toIndex + 1} sur ${safeRiskLevelRules.length}.`);\n    }\n  };\n\n  const formatRiskRangeLabel = (rule) => {\n    const minScore = getRuleMinScoreValue(rule);\n    const maxScore = getRuleMaxScoreValue(rule);\n\n    const minLabel = formatScoreValue(minScore);\n    const minUnit = getPointUnit(minScore);\n\n    if (maxScore === null) {\n      return `â‰¥ ${minLabel} ${minUnit}`;\n    }\n\n    if (minScore === maxScore) {\n      return `${minLabel} ${getPointUnit(minScore)}`;\n    }\n\n    const maxLabel = formatScoreValue(maxScore);\n    return `${minLabel} Ã  ${maxLabel} points`;\n  };\n\n  const getRiskLevelRuleIssues = (rule, index, rulesList) => {\n    const issues = [];\n    const min = getRuleMinScoreValue(rule);\n    const max = getRuleMaxScoreValue(rule);\n\n    if (max !== null && max < min) {\n      issues.push('Le score maximal doit Ãªtre supÃ©rieur ou Ã©gal au score minimal.');\n    }\n\n    if (index > 0) {\n      const previous = rulesList[index - 1];\n      const previousMax = getRuleMaxScoreValue(previous);\n\n      if (previousMax === null) {\n        issues.push('Le niveau prÃ©cÃ©dent couvre dÃ©jÃ  tous les scores (maximum illimitÃ©). Ajustez-le avant dâ€™ajouter ce palier.');\n      } else if (min <= previousMax) {\n        issues.push(`Le score minimal doit Ãªtre strictement supÃ©rieur Ã  ${formatScoreValue(previousMax)}, le maximum du niveau prÃ©cÃ©dent.`);\n      }\n    }\n\n    return issues;\n  };\n\n  const downloadDataModule = (filename, exportName, data) => {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    const serialized = JSON.stringify(data, null, 2);\n    const moduleContent = `export const ${exportName} = ${serialized};\\n`;\n    const blob = new Blob([moduleContent], { type: 'application/javascript;charset=utf-8' });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    window.URL.revokeObjectURL(url);\n  };\n\n  const handleDownloadDataFiles = () => {\n    downloadDataModule('questions.js', 'initialQuestions', questions);\n    downloadDataModule('rules.js', 'initialRules', rules);\n    downloadDataModule('riskLevelRules.js', 'initialRiskLevelRules', safeRiskLevelRules);\n    downloadDataModule('teams.js', 'initialTeams', teams);\n    downloadDataModule(\n      'inspirationFilters.js',\n      'initialInspirationFilters',\n      normalizeInspirationFiltersConfig(inspirationFilters)\n    );\n    downloadDataModule(\n      'inspirationFormFields.js',\n      'initialInspirationFormFields',\n      normalizeInspirationFormConfig(inspirationFormFields)\n    );\n    downloadDataModule('showcaseThemes.js', 'initialShowcaseThemes', safeShowcaseThemes);\n    downloadDataModule(\n      'onboardingTour.js',\n      'initialOnboardingTourConfig',\n      normalizeOnboardingConfig(onboardingTourConfig)\n    );\n    downloadDataModule(\n      'validationCommitteeConfig.js',\n      'initialValidationCommitteeConfig',\n      normalizeValidationCommitteeConfig(validationCommitteeConfig)\n    );\n    downloadDataModule('adminEmails.js', 'initialAdminEmails', normalizedAdminEmails);\n  };\n\n  const inspirationFilterCount = inspirationFilterFields.length;\n  const inspirationFormCount = inspirationFormFieldEntries.length;\n  const adminEmailCount = normalizedAdminEmails.length;\n  const validationCommitteeRuleOptions = useMemo(\n    () =>\n      (Array.isArray(rules) ? rules : [])\n        .filter((rule) => rule && rule.id)\n        .map((rule) => ({\n          value: rule.id,\n          label: rule.name ? `${rule.name} (${rule.id})` : rule.id\n        })),\n    [rules]\n  );\n\n  const tabDefinitions = [\n    {\n      id: 'dashboard',\n      label: 'Dashboard',\n      panelId: 'backoffice-tabpanel-dashboard'\n    },\n    {\n      id: 'filters',\n      label: `Filtres d'accueil (${filterFields.length})`,\n      panelId: 'backoffice-tabpanel-filters'\n    },\n    {\n      id: 'inspiration',\n      label: `Inspiration (${inspirationFilterCount + inspirationFormCount})`,\n      panelId: 'backoffice-tabpanel-inspiration'\n    },\n    {\n      id: 'themes',\n      label: `ThÃ¨mes vitrine (${showcaseThemeCount})`,\n      panelId: 'backoffice-tabpanel-themes'\n    },\n    {\n      id: 'onboarding',\n      label: `Onboarding (${onboardingStepCount})`,\n      panelId: 'backoffice-tabpanel-onboarding'\n    },\n    {\n      id: 'questions',\n      label: `Questions (${questions.length})`,\n      panelId: 'backoffice-tabpanel-questions'\n    },\n    {\n      id: 'rules',\n      label: `RÃ¨gles (${rules.length})`,\n      panelId: 'backoffice-tabpanel-rules'\n    },\n    {\n      id: 'validationCommittee',\n      label: 'ComitÃ©s de validation',\n      panelId: 'backoffice-tabpanel-validationCommittee'\n    },\n    {\n      id: 'administrators',\n      label: `Administrateurs (${adminEmailCount})`,\n      panelId: 'backoffice-tabpanel-administrators'\n    },\n    {\n      id: 'riskLevels',\n      label: `Niveaux de complexitÃ© (${riskLevelRuleCount})`,\n      panelId: 'backoffice-tabpanel-risk-levels'\n    },\n    {\n      id: 'teams',\n      label: `Ã‰quipes (${teams.length})`,\n      panelId: 'backoffice-tabpanel-teams'\n    }\n  ];\n\n  const createDefaultQuestion = (existingQuestions) => ({\n    id: getNextId(existingQuestions, 'q'),\n    type: 'choice',\n    question: 'Nouvelle question',\n    options: ['Option 1', 'Option 2'],\n    required: true,\n    conditions: [],\n    conditionLogic: 'all',\n    conditionGroups: [],\n    placeholder: '',\n    numberUnit: '',\n    guidance: {\n      objective: '',\n      details: '',\n      tips: []\n    }\n  });\n\n  const addQuestion = () => {\n    const newQuestion = createDefaultQuestion(questions);\n\n    setQuestions([...questions, newQuestion]);\n    setEditingQuestion(newQuestion);\n    if (newQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const next = new Set(prev);\n        next.add(newQuestion.id);\n        return next;\n      });\n    }\n  };\n\n  const addQuestionAtIndex = (targetIndex) => {\n    const newQuestion = createDefaultQuestion(questions);\n    const next = questions.slice();\n    next.splice(targetIndex, 0, newQuestion);\n\n    setQuestions(next);\n    setEditingQuestion(newQuestion);\n    setReorderAnnouncement(`Nouvelle question ajoutÃ©e en position ${targetIndex + 1} sur ${next.length}.`);\n    if (newQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const updated = new Set(prev);\n        updated.add(newQuestion.id);\n        return updated;\n      });\n    }\n  };\n\n  const deleteQuestion = (id) => {\n    if (PROTECTED_QUESTION_IDS.has(id)) {\n      return;\n    }\n\n    const targetIndex = questions.findIndex((question) => question.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = questions[targetIndex];\n    if (target && target.showcase) {\n      return;\n    }\n\n    const label = target?.question || target?.id || 'cette question';\n\n    if (!confirmDeletion(`ÃŠtes-vous sÃ»r de vouloir supprimer la question Â« ${label} Â» ? Cette action peut Ãªtre annulÃ©e (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'question',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `La question Â« ${label} Â» a Ã©tÃ© supprimÃ©e. Cliquez sur Â« Annuler Â» ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setQuestions((prevQuestions) => prevQuestions.filter((question) => question.id !== id));\n  };\n\n  const duplicateQuestion = (id) => {\n    const originalIndex = questions.findIndex((question) => question.id === id);\n    if (originalIndex < 0) {\n      return;\n    }\n\n    const originalQuestion = questions[originalIndex];\n    const duplicateId = getDuplicateId(questions, originalQuestion?.id, 'q');\n    const copiedQuestion = cloneData(originalQuestion || {});\n\n    copiedQuestion.id = duplicateId;\n    copiedQuestion.question = typeof originalQuestion?.question === 'string' && originalQuestion.question.trim() !== ''\n      ? `${originalQuestion.question} (copie)`\n      : `Copie de ${duplicateId}`;\n\n    const updatedQuestions = questions.slice();\n    updatedQuestions.splice(originalIndex + 1, 0, copiedQuestion);\n\n    setQuestions(updatedQuestions);\n    setEditingQuestion(copiedQuestion);\n    if (copiedQuestion?.id) {\n      setExpandedQuestionIds((prev) => {\n        const next = new Set(prev);\n        next.add(copiedQuestion.id);\n        return next;\n      });\n    }\n\n    const sourceLabel = originalQuestion?.id || 'question dâ€™origine';\n    setReorderAnnouncement(`La question ${duplicateId} a Ã©tÃ© crÃ©Ã©e Ã  partir de ${sourceLabel} et placÃ©e en position ${originalIndex + 2} sur ${updatedQuestions.length}.`);\n  };\n\n  const saveQuestion = (updatedQuestion) => {\n    const index = questions.findIndex((question) => question.id === updatedQuestion.id);\n\n    if (index >= 0) {\n      const next = questions.slice();\n      next[index] = updatedQuestion;\n      setQuestions(next);\n    } else {\n      setQuestions([...questions, updatedQuestion]);\n    }\n    setEditingQuestion(null);\n  };\n\n  const addRule = () => {\n    const newRule = {\n      id: getNextId(rules, 'rule'),\n      name: 'Nouvelle rÃ¨gle',\n      conditions: [],\n      conditionGroups: [],\n      conditionLogic: 'all',\n      teams: [],\n      questions: {},\n      risks: []\n    };\n\n    setRules([...rules, newRule]);\n    setEditingRule(newRule);\n    if (newRule?.id) {\n      setExpandedRuleIds((prev) => {\n        const next = new Set(prev);\n        next.add(newRule.id);\n        return next;\n      });\n    }\n  };\n\n  const deleteRule = (id) => {\n    const targetIndex = rules.findIndex((rule) => rule.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = rules[targetIndex];\n    const label = target?.name || target?.id || 'cette rÃ¨gle';\n\n    if (!confirmDeletion(`ÃŠtes-vous sÃ»r de vouloir supprimer la rÃ¨gle Â« ${label} Â» ? Cette action peut Ãªtre annulÃ©e (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'rule',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `La rÃ¨gle Â« ${label} Â» a Ã©tÃ© supprimÃ©e. Cliquez sur Â« Annuler Â» ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setRules((prevRules) => prevRules.filter((ruleItem) => ruleItem.id !== id));\n    if (editingRule && editingRule.id === id) {\n      setEditingRule(null);\n    }\n  };\n\n  const duplicateRule = (id) => {\n    const originalIndex = rules.findIndex((rule) => rule.id === id);\n    if (originalIndex < 0) {\n      return;\n    }\n\n    const originalRule = rules[originalIndex];\n    const duplicateId = getDuplicateId(rules, originalRule?.id, 'rule');\n    const copiedRule = cloneData(originalRule || {});\n\n    copiedRule.id = duplicateId;\n    copiedRule.name = typeof originalRule?.name === 'string' && originalRule.name.trim() !== ''\n      ? `${originalRule.name} (copie)`\n      : `Copie de ${duplicateId}`;\n    delete copiedRule.priority;\n\n    const updatedRules = rules.slice();\n    updatedRules.splice(originalIndex + 1, 0, copiedRule);\n\n    setRules(updatedRules);\n    setEditingRule(copiedRule);\n    if (copiedRule?.id) {\n      setExpandedRuleIds((prev) => {\n        const next = new Set(prev);\n        next.add(copiedRule.id);\n        return next;\n      });\n    }\n  };\n\n  const saveRule = (updatedRule) => {\n    const index = rules.findIndex((rule) => rule.id === updatedRule.id);\n\n    if (index >= 0) {\n      const next = rules.slice();\n      next[index] = updatedRule;\n      setRules(next);\n    } else {\n      setRules([...rules, updatedRule]);\n    }\n    setEditingRule(null);\n  };\n\n  const addTeam = () => {\n    const newTeam = {\n      id: getNextId(teams, 'team'),\n      name: 'Nouvelle Ã©quipe',\n      contacts: ['email@company.com'],\n      expertise: \"Domaine d'expertise\"\n    };\n\n    setTeams([...teams, newTeam]);\n  };\n\n  const updateTeamField = (index, field, value) => {\n    const next = teams.slice();\n    if (!next[index]) {\n      return;\n    }\n    next[index] = { ...next[index], [field]: value };\n    setTeams(next);\n  };\n\n  const deleteTeam = (id) => {\n    const targetIndex = teams.findIndex((team) => team.id === id);\n    if (targetIndex < 0) {\n      return;\n    }\n\n    const target = teams[targetIndex];\n    const label = target?.name || target?.id || 'cette Ã©quipe';\n\n    if (!confirmDeletion(`ÃŠtes-vous sÃ»r de vouloir supprimer l'Ã©quipe Â« ${label} Â» ? Cette action peut Ãªtre annulÃ©e (Ctrl+Z).`)) {\n      return;\n    }\n\n    pushUndoEntry({\n      type: 'team',\n      index: targetIndex,\n      item: cloneData(target),\n      message: `L'Ã©quipe Â« ${label} Â» a Ã©tÃ© supprimÃ©e. Cliquez sur Â« Annuler Â» ou utilisez Ctrl+Z pour la restaurer.`,\n    });\n\n    setTeams((prevTeams) => prevTeams.filter((team) => team.id !== id));\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 px-4 py-6 sm:px-6 lg:px-8 hv-background\">\n      <div className=\"max-w-7xl mx-auto space-y-6\">\n        <div className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 hv-surface\" role=\"region\" aria-label=\"Back-office\">\n          <header className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-8\">\n            <div className=\"flex items-center space-x-3\">\n              <span className=\"inline-flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-xl\">\n                <Settings className=\"w-6 h-6\" />\n              </span>\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-800 sm:text-3xl\">Back-office</h1>\n                <p className=\"text-sm text-gray-500\">Configurez vos rÃ©fÃ©rentiels et automatisations</p>\n              </div>\n            </div>\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2 w-full lg:w-auto\">\n              <button\n                type=\"button\"\n                onClick={handleUndo}\n                disabled={!canUndo}\n                title=\"Annuler la derniÃ¨re suppression (Ctrl+Z)\"\n                className=\"inline-flex items-center justify-center px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-60 hv-button hv-focus-ring text-sm sm:text-base\"\n              >\n                <ChevronLeft className=\"w-5 h-5 mr-2\" />\n                Annuler (Ctrl+Z)\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDownloadDataFiles}\n                className=\"inline-flex items-center justify-center px-4 py-2 bg-white border border-blue-200 text-blue-700 rounded-lg shadow-sm hover:bg-blue-50 hv-button hv-focus-ring text-sm sm:text-base\"\n              >\n                <Download className=\"w-5 h-5 mr-2\" />\n                TÃ©lÃ©charger les fichiers (questions, rÃ¨gles, Ã©quipes, inspiration, vitrine)\n              </button>\n            </div>\n          </header>\n\n          {undoMessage ? (\n            <div\n              className=\"mb-6 rounded-2xl border border-blue-200 bg-blue-50/80 p-4 text-sm text-blue-800\"\n              role=\"status\"\n              aria-live=\"polite\"\n            >\n              {undoMessage}\n            </div>\n          ) : null}\n\n          <section\n            className=\"mb-6\"\n            aria-label=\"DÃ©tection des incohÃ©rences\"\n            aria-live=\"polite\"\n          >\n            {dataIntegrityIssues.length > 0 ? (\n              <div className=\"rounded-2xl border border-yellow-200 bg-yellow-50/80 p-4\">\n                <div className=\"flex items-start gap-3\">\n                  <AlertTriangle className=\"w-6 h-6 text-yellow-600 mt-1\" />\n                  <div className=\"flex-1 space-y-3\">\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <p className=\"text-sm font-semibold text-yellow-900\">\n                        {dataIntegrityIssues.length} incohÃ©rence\n                        {dataIntegrityIssues.length > 1 ? 's' : ''} dÃ©tectÃ©e\n                        {dataIntegrityIssues.length > 1 ? 's' : ''} dans la configuration.\n                      </p>\n                      {dataIntegritySummary.map((entry) => (\n                        <span\n                          key={entry.scope}\n                          className=\"inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800\"\n                        >\n                          {entry.label} Â· {entry.count}\n                        </span>\n                      ))}\n                    </div>\n                    <ul className=\"space-y-2 text-sm text-yellow-900\">\n                      {dataIntegrityIssues.map((issue) => (\n                        <li\n                          key={issue.id}\n                          className=\"rounded-lg border border-yellow-200 bg-white/60 p-3\"\n                        >\n                          <p className=\"font-medium\">{issue.context}</p>\n                          <p className=\"mt-1 leading-snug\">{issue.message}</p>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"flex items-start gap-3 rounded-2xl border border-emerald-200 bg-emerald-50 p-4\">\n                <CheckCircle className=\"w-6 h-6 text-emerald-600 mt-1\" />\n                <div>\n                  <p className=\"text-sm font-semibold text-emerald-800\">\n                    Aucune incohÃ©rence dÃ©tectÃ©e dans les donnÃ©es de configuration.\n                  </p>\n                  <p className=\"mt-1 text-xs text-emerald-700\">\n                    Les conditions, Ã©quipes et rÃ©fÃ©rences sont alignÃ©es.\n                  </p>\n                </div>\n              </div>\n            )}\n          </section>\n\n          <nav className=\"flex flex-wrap gap-2 border-b border-gray-200 pb-2 mb-6\" role=\"tablist\" aria-label=\"Navigation back-office\">\n            {tabDefinitions.map((tab) => (\n              <button\n                key={tab.id}\n                type=\"button\"\n                id={`backoffice-tab-${tab.id}`}\n                role=\"tab\"\n                aria-controls={tab.panelId}\n                aria-selected={activeTab === tab.id}\n                onClick={() => setActiveTab(tab.id)}\n                className={`px-4 py-2 rounded-t-md text-sm font-medium hv-focus-ring ${\n                  activeTab === tab.id\n                    ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-600'\n                    : 'text-gray-600 hover:text-gray-800'\n                }`}\n              >\n                {tab.label}\n              </button>\n            ))}\n          </nav>\n\n          {activeTab === 'dashboard' && (\n            <section\n              id=\"backoffice-tabpanel-dashboard\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-dashboard\"\n              className=\"space-y-6\"\n            >\n              <BackOfficeDashboard projects={projects} teams={teams} />\n            </section>\n          )}\n\n          {activeTab === 'filters' && (\n            <section\n              id=\"backoffice-tabpanel-filters\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-filters\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Filtres de la page d'accueil</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Activez, ajoutez ou personnalisez les filtres mis Ã  disposition des chefs de projet sur l'Ã©cran d'accueil.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetProjectFilters}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      projectFiltersAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={projectFiltersAreDefault}\n                  >\n                    RÃ©initialiser les filtres\n                  </button>\n                </header>\n\n                <div className=\"flex flex-col gap-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4 md:flex md:items-end md:justify-between md:gap-4\">\n                    <div className=\"flex-1 space-y-2\">\n                      <label htmlFor=\"new-filter-question\" className=\"text-sm font-medium text-blue-900\">\n                        Ajouter un filtre basÃ© sur une question\n                      </label>\n                      <select\n                        id=\"new-filter-question\"\n                        value={selectedFilterQuestionId}\n                        onChange={(event) => setSelectedFilterQuestionId(event.target.value)}\n                        className=\"w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">SÃ©lectionnez une questionâ€¦</option>\n                        {availableFilterQuestionOptions.map((option) => (\n                          <option key={option.value} value={option.value} disabled={option.disabled}>\n                            {option.label}{option.disabled ? ' (dÃ©jÃ  utilisÃ©)' : ''}\n                          </option>\n                        ))}\n                      </select>\n                      <p className=\"text-xs text-blue-700\">\n                        Les champs texte et listes Ã  choix unique du questionnaire peuvent Ãªtre transformÃ©s en filtres.\n                      </p>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={handleAddProjectFilter}\n                      disabled={!canAddProjectFilter}\n                      className={`mt-4 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button md:mt-0 ${\n                        canAddProjectFilter\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                    >\n                      <Plus className=\"w-4 h-4\" /> Ajouter le filtre\n                    </button>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    {filterFields.length === 0 ? (\n                      <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                        Aucun filtre n'est configurÃ© pour le moment. Utilisez le menu ci-dessus pour en ajouter.\n                      </div>\n                    ) : (\n                      filterFields.map((field) => {\n                        const typeLabel = PROJECT_FILTER_TYPE_LABELS[field.type] || 'ParamÃ¨tre';\n                        const description = PROJECT_FILTER_FIELD_DESCRIPTIONS[field.id] || '';\n                        const labelInputId = `project-filter-label-${field.id}`;\n                        const sortDefault = field.type === 'sort' && field.defaultValue === 'asc' ? 'asc' : 'desc';\n                        const sourceQuestionId = field.sourceQuestionId || field.id;\n                        const sourceQuestion = Array.isArray(questions)\n                          ? questions.find((question) => question && question.id === sourceQuestionId)\n                          : null;\n                        const sourceLabel = sourceQuestion?.question;\n                        const canRemoveFilter = field.id !== 'dateOrder';\n\n                        return (\n                          <article\n                            key={field.id}\n                            className=\"border border-gray-200 rounded-xl bg-white p-5 shadow-sm hv-surface\"\n                          >\n                            <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                                  <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                    {typeLabel}\n                                  </span>\n                                  <span\n                                    className={`rounded-full px-2 py-1 ${\n                                      field.enabled\n                                        ? 'bg-emerald-100 text-emerald-700'\n                                        : 'bg-gray-100 text-gray-600'\n                                    }`}\n                                  >\n                                    {field.enabled ? 'ActivÃ©' : 'DÃ©sactivÃ©'}\n                                  </span>\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{field.label}</h3>\n                                {description && <p className=\"text-sm text-gray-600\">{description}</p>}\n                                {sourceQuestionId && (\n                                  <p className=\"text-xs text-gray-500\">\n                                    Source : <span className=\"font-medium\">{sourceQuestionId}</span>\n                                    {sourceLabel ? ` â€“ ${sourceLabel}` : ''}\n                                  </p>\n                                )}\n                              </div>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <label className=\"inline-flex items-center gap-2 text-sm font-medium text-gray-700\">\n                                  <input\n                                    type=\"checkbox\"\n                                    checked={field.enabled}\n                                    onChange={(event) => handleProjectFilterToggle(field.id, event.target.checked)}\n                                    className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                  />\n                                  <span>Activer</span>\n                                </label>\n                                {canRemoveFilter && (\n                                  <button\n                                    type=\"button\"\n                                    onClick={() => handleRemoveProjectFilter(field)}\n                                    className=\"inline-flex items-center gap-1 rounded-lg border border-red-100 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-100 hv-button\"\n                                  >\n                                    <Trash2 className=\"w-4 h-4\" /> Supprimer\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                              <div className=\"flex flex-col gap-2\">\n                                <label htmlFor={labelInputId} className=\"text-sm font-medium text-gray-700\">\n                                  LibellÃ© affichÃ©\n                                </label>\n                                <input\n                                  id={labelInputId}\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleProjectFilterLabelChange(field.id, event.target.value)}\n                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                                <p className=\"text-xs text-gray-500\">\n                                  Ce titre s'affiche sur la page d'accueil Ã  cÃ´tÃ© du champ de filtre.\n                                </p>\n                              </div>\n\n                              {field.type === 'sort' ? (\n                                <fieldset className=\"flex flex-col gap-2\">\n                                  <legend className=\"text-sm font-medium text-gray-700\">Ordre par dÃ©faut</legend>\n                                  <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                                    <input\n                                      type=\"radio\"\n                                      name={`project-filter-sort-order-${field.id}`}\n                                      value=\"desc\"\n                                      checked={sortDefault === 'desc'}\n                                      onChange={() => handleProjectFilterDefaultSortChange('desc')}\n                                      className=\"h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                    />\n                                    <span>Les plus rÃ©cents en premier</span>\n                                  </label>\n                                  <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                                    <input\n                                      type=\"radio\"\n                                      name={`project-filter-sort-order-${field.id}`}\n                                      value=\"asc\"\n                                      checked={sortDefault === 'asc'}\n                                      onChange={() => handleProjectFilterDefaultSortChange('asc')}\n                                      className=\"h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                    />\n                                    <span>Les plus anciens en premier</span>\n                                  </label>\n                                </fieldset>\n                              ) : field.type === 'select' ? (\n                                <div className=\"flex flex-col gap-2\">\n                                  <label\n                                    htmlFor={`project-filter-empty-option-${field.id}`}\n                                    className=\"text-sm font-medium text-gray-700\"\n                                  >\n                                    LibellÃ© de l'option Â« toutes Â»\n                                  </label>\n                                  <input\n                                    id={`project-filter-empty-option-${field.id}`}\n                                    type=\"text\"\n                                    value={field.emptyOptionLabel || 'Toutes les valeurs'}\n                                    onChange={(event) =>\n                                      setProjectFilters((prev) =>\n                                        updateProjectFilterField(prev, field.id, {\n                                          emptyOptionLabel: event.target.value\n                                        })\n                                      )\n                                    }\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  />\n                                  <p className=\"text-xs text-gray-500\">\n                                    Texte affichÃ© pour reprÃ©senter l'ensemble des valeurs disponibles.\n                                  </p>\n                                </div>\n                              ) : (\n                                <div className=\"flex flex-col gap-2 text-sm text-gray-600\">\n                                  <span className=\"font-medium text-gray-700\">Comportement</span>\n                                  <p className=\"text-xs text-gray-500\">\n                                    Recherche plein texte sur la rÃ©ponse saisie par le chef de projet.\n                                  </p>\n                                </div>\n                              )}\n                            </div>\n                          </article>\n                        );\n                      })\n                    )}\n                  </div>\n                </div>\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'inspiration' && (\n            <section\n              id=\"backoffice-tabpanel-inspiration\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-inspiration\"\n              className=\"space-y-6\"\n            >\n              <div className=\"sr-only\" aria-live=\"polite\">{reorderAnnouncement}</div>\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Filtres Inspiration</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Ajustez les filtres disponibles pour trier les projets inspirants.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetInspirationFilters}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      inspirationFiltersAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={inspirationFiltersAreDefault}\n                  >\n                    RÃ©initialiser\n                  </button>\n                </header>\n\n                <div className=\"flex flex-col gap-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4 md:flex md:items-end md:justify-between md:gap-4\">\n                    <div className=\"flex-1 space-y-2\">\n                      <label htmlFor=\"new-inspiration-filter-question\" className=\"text-sm font-medium text-blue-900\">\n                        Ajouter un filtre basÃ© sur un champ du questionnaire\n                      </label>\n                      <select\n                        id=\"new-inspiration-filter-question\"\n                        value={selectedInspirationFilterQuestionId}\n                        onChange={(event) => setSelectedInspirationFilterQuestionId(event.target.value)}\n                        className=\"w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">SÃ©lectionnez un champâ€¦</option>\n                        {availableInspirationFilterQuestionOptions.map((option) => (\n                          <option key={option.value} value={option.value} disabled={option.disabled}>\n                            {option.label}{option.disabled ? ' (dÃ©jÃ  utilisÃ©)' : ''}\n                          </option>\n                        ))}\n                      </select>\n                      <p className=\"text-xs text-blue-700\">\n                        Les champs texte et les listes du formulaire peuvent Ãªtre transformÃ©s en filtres Inspiration.\n                      </p>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={handleAddInspirationFilter}\n                      disabled={!canAddInspirationFilter}\n                      className={`mt-4 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button md:mt-0 ${\n                        canAddInspirationFilter\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                    >\n                      <Plus className=\"w-4 h-4\" /> Ajouter le filtre\n                    </button>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    {inspirationFilterFields.length === 0 ? (\n                      <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                        Aucun filtre n'est configurÃ© pour le moment. Utilisez le menu ci-dessus pour en ajouter.\n                      </div>\n                    ) : (\n                      inspirationFilterFields.map((field) => {\n                        const typeLabel = INSPIRATION_FILTER_TYPE_LABELS[field.type] || 'ParamÃ¨tre';\n                        const labelInputId = `inspiration-filter-label-${field.id}`;\n                        const sourceQuestionId = field.sourceQuestionId || field.id;\n                        const sourceQuestion = inspirationFormFieldEntries.find(\n                          (item) => item && item.id === sourceQuestionId\n                        );\n                        const sourceLabel = sourceQuestion?.label;\n\n                        return (\n                          <article key={field.id} className=\"rounded-xl border border-gray-200 bg-white p-5 shadow-sm hv-surface\">\n                            <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                                  <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                    {typeLabel}\n                                  </span>\n                                  <span\n                                    className={`rounded-full px-2 py-1 ${\n                                      field.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'\n                                    }`}\n                                  >\n                                    {field.enabled ? 'ActivÃ©' : 'DÃ©sactivÃ©'}\n                                  </span>\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{field.label}</h3>\n                                {sourceQuestionId && (\n                                  <p className=\"text-xs text-gray-500\">\n                                    Source : <span className=\"font-medium\">{sourceQuestionId}</span>\n                                    {sourceLabel ? ` â€“ ${sourceLabel}` : ''}\n                                  </p>\n                                )}\n                              </div>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <label className=\"inline-flex items-center gap-2 text-sm font-medium text-gray-700\">\n                                  <input\n                                    type=\"checkbox\"\n                                    checked={field.enabled}\n                                    onChange={(event) => handleInspirationFilterToggle(field.id, event.target.checked)}\n                                    className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                  />\n                                  <span>Activer</span>\n                                </label>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => handleRemoveInspirationFilter(field)}\n                                  className=\"inline-flex items-center gap-1 rounded-lg border border-red-100 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-100 hv-button\"\n                                >\n                                  <Trash2 className=\"w-4 h-4\" /> Supprimer\n                                </button>\n                              </div>\n                            </div>\n\n                            <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                              <div className=\"flex flex-col gap-2\">\n                                <label htmlFor={labelInputId} className=\"text-sm font-medium text-gray-700\">\n                                  LibellÃ© affichÃ©\n                                </label>\n                                <input\n                                  id={labelInputId}\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleInspirationFilterLabelChange(field.id, event.target.value)}\n                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                                <p className=\"text-xs text-gray-500\">\n                                  Ce titre s'affiche sur la page d'accueil pour les projets inspiration.\n                                </p>\n                              </div>\n\n                              {field.type === 'select' ? (\n                                <div className=\"flex flex-col gap-2\">\n                                  <label\n                                    htmlFor={`inspiration-filter-empty-option-${field.id}`}\n                                    className=\"text-sm font-medium text-gray-700\"\n                                  >\n                                    LibellÃ© de l'option Â« toutes Â»\n                                  </label>\n                                  <input\n                                    id={`inspiration-filter-empty-option-${field.id}`}\n                                    type=\"text\"\n                                    value={field.emptyOptionLabel || 'Toutes les valeurs'}\n                                    onChange={(event) =>\n                                      setInspirationFilters((prev) =>\n                                        updateInspirationFilterField(prev, field.id, {\n                                          emptyOptionLabel: event.target.value\n                                        })\n                                      )\n                                    }\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  />\n                                  <p className=\"text-xs text-gray-500\">\n                                    Texte affichÃ© pour reprÃ©senter l'ensemble des valeurs disponibles.\n                                  </p>\n                                </div>\n                              ) : (\n                                <div className=\"flex flex-col gap-2 text-sm text-gray-600\">\n                                  <span className=\"font-medium text-gray-700\">Comportement</span>\n                                  <p className=\"text-xs text-gray-500\">\n                                    Recherche plein texte sur les champs du projet inspirant.\n                                  </p>\n                                </div>\n                              )}\n                            </div>\n                          </article>\n                        );\n                      })\n                    )}\n                  </div>\n                </div>\n              </article>\n\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Champs du formulaire</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      DÃ©finissez les champs visibles dans le questionnaire de crÃ©ation d'un projet inspirant.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={handleResetInspirationFormFields}\n                    className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                      inspirationFormAreDefault\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                    }`}\n                    disabled={inspirationFormAreDefault}\n                  >\n                    RÃ©initialiser\n                  </button>\n                </header>\n\n                <div className=\"space-y-4\">\n                  <div className=\"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-5\">\n                    <div className=\"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between\">\n                      <div className=\"flex-1 space-y-4\">\n                        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-label\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              LibellÃ© du champ\n                            </label>\n                            <input\n                              id=\"new-inspiration-field-label\"\n                              type=\"text\"\n                              value={newInspirationFormField.label}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  label: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder=\"Ex : Contexte du projet\"\n                            />\n                          </div>\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-id\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              Identifiant technique\n                            </label>\n                            <input\n                              id=\"new-inspiration-field-id\"\n                              type=\"text\"\n                              value={newInspirationFormField.id}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  id: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder=\"ex : contexteProjet\"\n                            />\n                            <p className=\"mt-1 text-xs text-blue-700\">\n                              {isNewInspirationFieldIdDuplicate\n                                ? 'Cet identifiant est dÃ©jÃ  utilisÃ©.'\n                                : suggestedNewInspirationFieldId\n                                  ? `Identifiant utilisÃ© : ${suggestedNewInspirationFieldId}`\n                                  : 'Laissez vide pour gÃ©nÃ©rer automatiquement Ã  partir du libellÃ©.'}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-3\">\n                          <div>\n                            <label\n                              htmlFor=\"new-inspiration-field-type\"\n                              className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                            >\n                              Type de champ\n                            </label>\n                            <select\n                              id=\"new-inspiration-field-type\"\n                              value={newInspirationFormField.type}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  type: event.target.value\n                                }))\n                              }\n                              className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              {INSPIRATION_FORM_FIELD_TYPE_OPTIONS.map((option) => (\n                                <option key={option.value} value={option.value}>\n                                  {option.label}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                          {newInspirationFormField.type === 'select' || newInspirationFormField.type === 'multi_select' ? (\n                            <div className=\"md:col-span-2 space-y-3\">\n                              <div>\n                                <label\n                                  htmlFor=\"new-inspiration-field-options\"\n                                  className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                                >\n                                  Options (sÃ©parÃ©es par des virgules)\n                                </label>\n                                <input\n                                  id=\"new-inspiration-field-options\"\n                                  type=\"text\"\n                                  value={newInspirationFormField.options}\n                                  onChange={(event) =>\n                                    setNewInspirationFormField((prev) => ({\n                                      ...prev,\n                                      options: event.target.value\n                                    }))\n                                  }\n                                  className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                  placeholder=\"Ex : Patient, Professionnels, Grand public\"\n                                />\n                              </div>\n                              {newInspirationFormField.type === 'select' && (\n                                <div>\n                                  <label\n                                    htmlFor=\"new-inspiration-field-select-placeholder\"\n                                    className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                                  >\n                                    LibellÃ© de sÃ©lection par dÃ©faut\n                                  </label>\n                                  <input\n                                    id=\"new-inspiration-field-select-placeholder\"\n                                    type=\"text\"\n                                    value={newInspirationFormField.placeholder}\n                                    onChange={(event) =>\n                                      setNewInspirationFormField((prev) => ({\n                                        ...prev,\n                                        placeholder: event.target.value\n                                      }))\n                                    }\n                                    className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Ex : SÃ©lectionner...\"\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          ) : INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(newInspirationFormField.type) ? (\n                            <div className=\"md:col-span-2\">\n                              <label\n                                htmlFor=\"new-inspiration-field-placeholder\"\n                                className=\"text-xs font-semibold uppercase tracking-wide text-blue-800\"\n                              >\n                                Placeholder / texte indicatif\n                              </label>\n                              <input\n                                id=\"new-inspiration-field-placeholder\"\n                                type=\"text\"\n                                value={newInspirationFormField.placeholder}\n                                onChange={(event) =>\n                                  setNewInspirationFormField((prev) => ({\n                                    ...prev,\n                                    placeholder: event.target.value\n                                  }))\n                                }\n                                className=\"mt-1 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Texte affichÃ© dans le champ\"\n                              />\n                            </div>\n                          ) : (\n                            <div className=\"md:col-span-2 flex items-center text-xs text-blue-700\">\n                              Ce type de champ ne nÃ©cessite pas de placeholder.\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"flex flex-wrap gap-4 text-sm text-blue-900\">\n                          <label className=\"inline-flex items-center gap-2\">\n                            <input\n                              type=\"checkbox\"\n                              checked={newInspirationFormField.required}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  required: event.target.checked\n                                }))\n                              }\n                              className=\"h-4 w-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500\"\n                            />\n                            Champ requis\n                          </label>\n                          <label className=\"inline-flex items-center gap-2\">\n                            <input\n                              type=\"checkbox\"\n                              checked={newInspirationFormField.enabled}\n                              onChange={(event) =>\n                                setNewInspirationFormField((prev) => ({\n                                  ...prev,\n                                  enabled: event.target.checked\n                                }))\n                              }\n                              className=\"h-4 w-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500\"\n                            />\n                            Champ actif\n                          </label>\n                        </div>\n                      </div>\n                      <button\n                        type=\"button\"\n                        onClick={handleAddInspirationFormField}\n                        disabled={!canAddInspirationFormField}\n                        className={`inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                          canAddInspirationFormField\n                            ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                            : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                        }`}\n                      >\n                        <Plus className=\"w-4 h-4\" />\n                        Ajouter le champ\n                      </button>\n                    </div>\n                  </div>\n\n                  {inspirationFormFieldEntries.length === 0 ? (\n                    <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600\">\n                      Aucun champ n'est configurÃ©.\n                    </div>\n                  ) : (\n                    inspirationFormFieldEntries.map((field, index) => {\n                      const positionId = `inspiration-form-position-${field.id}`;\n\n                      return (\n                        <article\n                          key={field.id}\n                          className={`rounded-xl border border-gray-200 bg-white p-5 shadow-sm hv-surface ${\n                            dragOverInspirationFieldIndex === index ? 'ring-2 ring-blue-400 ring-offset-2' : ''\n                          } ${\n                            draggedInspirationFieldIndex === index ? 'opacity-75' : ''\n                          }`}\n                          onDragOver={(event) => handleInspirationFieldDragOver(event, index)}\n                          onDrop={(event) => handleInspirationFieldDrop(event, index)}\n                        >\n                        <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                          <div className=\"space-y-2\">\n                            <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide\">\n                              <span className=\"rounded-full bg-blue-100 px-2 py-1 text-blue-700\">\n                                {INSPIRATION_FORM_FIELD_TYPE_LABELS[field.type] || field.type}\n                              </span>\n                              <span\n                                className={`rounded-full px-2 py-1 ${\n                                  field.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'\n                                }`}\n                              >\n                                {field.enabled ? 'ActivÃ©' : 'DÃ©sactivÃ©'}\n                              </span>\n                              {field.required && (\n                                <span className=\"rounded-full bg-purple-100 px-2 py-1 text-purple-700\">Requis</span>\n                              )}\n                            </div>\n                            <div className=\"text-xs text-gray-500\" id={positionId}>\n                              Position {index + 1} sur {inspirationFormFieldEntries.length}\n                            </div>\n                            <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">LibellÃ©</span>\n                                <input\n                                  type=\"text\"\n                                  value={field.label}\n                                  onChange={(event) => handleInspirationFormFieldLabelChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                              </label>\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">Type de champ</span>\n                                <select\n                                  value={field.type}\n                                  onChange={(event) => handleInspirationFormFieldTypeChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                >\n                                  {INSPIRATION_FORM_FIELD_TYPE_OPTIONS.map((option) => (\n                                    <option key={option.value} value={option.value}>\n                                      {option.label}\n                                    </option>\n                                  ))}\n                                </select>\n                              </label>\n                            </div>\n                            {INSPIRATION_FORM_FIELD_PLACEHOLDER_TYPES.has(field.type) && (\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">\n                                  {field.type === 'select' ? 'LibellÃ© de sÃ©lection' : 'Placeholder'}\n                                </span>\n                                {field.type === 'long_text' ? (\n                                  <textarea\n                                    rows={2}\n                                    value={field.placeholder || ''}\n                                    onChange={(event) => handleInspirationFormFieldPlaceholderChange(field.id, event.target.value)}\n                                    className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Texte indicatif affichÃ© dans le champ\"\n                                  />\n                                ) : (\n                                  <input\n                                    type=\"text\"\n                                    value={field.placeholder || ''}\n                                    onChange={(event) => handleInspirationFormFieldPlaceholderChange(field.id, event.target.value)}\n                                    className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    placeholder=\"Texte indicatif affichÃ© dans le champ\"\n                                  />\n                                )}\n                              </label>\n                            )}\n                            {field.type === 'select' || field.type === 'multi_select' ? (\n                              <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                                <span className=\"font-semibold text-gray-700\">Options (sÃ©parÃ©es par des virgules)</span>\n                                <input\n                                  type=\"text\"\n                                  value={formatOptionList(field.options)}\n                                  onChange={(event) => handleInspirationFormFieldOptionsChange(field.id, event.target.value)}\n                                  className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                />\n                              </label>\n                            ) : null}\n                            <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                              <input\n                                type=\"checkbox\"\n                                checked={Boolean(field.required)}\n                                onChange={(event) => handleInspirationFormFieldRequiredChange(field.id, event.target.checked)}\n                                className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                              />\n                              Champ requis\n                            </label>\n                          </div>\n                          <div className=\"flex flex-wrap gap-2\">\n                            <button\n                              type=\"button\"\n                              className=\"p-2 text-gray-500 hover:text-blue-600 rounded hv-button cursor-move\"\n                              aria-label={`RÃ©organiser le champ ${field.label || field.id}. Position ${index + 1} sur ${inspirationFormFieldEntries.length}. Utilisez les flÃ¨ches haut et bas.`}\n                              aria-describedby={positionId}\n                              draggable\n                              onDragStart={(event) => handleInspirationFieldDragStart(event, index)}\n                              onDragOver={(event) => handleInspirationFieldDragOver(event, index)}\n                              onDrop={(event) => handleInspirationFieldDrop(event, index)}\n                              onDragEnd={handleInspirationFieldDragEnd}\n                              onKeyDown={(event) => handleInspirationFieldKeyboardReorder(event, index)}\n                            >\n                              <GripVertical className=\"w-4 h-4\" />\n                            </button>\n                            <button\n                              type=\"button\"\n                              onClick={() => handleInspirationFormFieldToggle(field.id, !field.enabled)}\n                              className={`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition-colors hv-button ${\n                                field.enabled\n                                  ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                                  : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                              }`}\n                            >\n                              {field.enabled ? 'DÃ©sactiver' : 'Activer'}\n                            </button>\n                          </div>\n                        </div>\n                      </article>\n                      );\n                    })\n                  )}\n                </div>\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'themes' && (\n            <section\n              id=\"backoffice-tabpanel-themes\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-themes\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">ThÃ¨mes de la vitrine</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      Pilotez les palettes couleurs utilisÃ©es dans la vitrine. Chaque couleur est Ã©ditable via un color-picker\n                      pour ajuster les dÃ©gradÃ©s, halos et surfaces principales.\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={addShowcaseTheme}\n                    className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700 hv-button hv-button-primary\"\n                  >\n                    <Plus className=\"w-5 h-5\" />\n                    Ajouter un thÃ¨me\n                  </button>\n                </div>\n\n                {safeShowcaseThemes.length === 0 ? (\n                  <div className=\"rounded-xl border border-dashed border-gray-300 p-6 text-center text-gray-500\">\n                    Aucun thÃ¨me configurÃ©.\n                  </div>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {safeShowcaseThemes.map((theme, index) => {\n                      const palette = theme?.palette || {};\n                      const themeId = theme?.id || `theme-${index + 1}`;\n                      const disableDelete = showcaseThemeCount <= 1;\n\n                      return (\n                        <article key={themeId} className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4 shadow-sm\">\n                          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                            <div className=\"flex-1 space-y-3\">\n                              <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                                <div>\n                                  <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-label`}>\n                                    Nom affichÃ©\n                                  </label>\n                                  <input\n                                    id={`${themeId}-label`}\n                                    type=\"text\"\n                                    value={theme?.label || ''}\n                                    onChange={(event) => updateShowcaseThemeField(index, 'label', event.target.value)}\n                                    className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm hv-focus-ring\"\n                                    placeholder=\"Nom du thÃ¨me\"\n                                  />\n                                </div>\n                                <div>\n                                  <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-id`}>\n                                    ClÃ© technique\n                                  </label>\n                                  <input\n                                    id={`${themeId}-id`}\n                                    type=\"text\"\n                                    value={themeId}\n                                    readOnly\n                                    className=\"w-full cursor-not-allowed rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-sm text-gray-600\"\n                                  />\n                                  <p className=\"mt-1 text-xs text-gray-500\">UtilisÃ©e pour identifier le thÃ¨me dans les rÃ©ponses.</p>\n                                </div>\n                              </div>\n\n                              <div>\n                                <label className=\"mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-description`}>\n                                  Description\n                                </label>\n                                <textarea\n                                  id={`${themeId}-description`}\n                                  rows={2}\n                                  value={theme?.description || ''}\n                                  onChange={(event) => updateShowcaseThemeField(index, 'description', event.target.value)}\n                                  className=\"w-full resize-y rounded-lg border border-gray-300 px-3 py-2 text-sm hv-focus-ring\"\n                                  placeholder=\"DÃ©crivez l'esprit du thÃ¨me (tonalitÃ©, usage, cible)\"\n                                />\n                              </div>\n                            </div>\n\n                            <div className=\"flex justify-end gap-2 lg:flex-col lg:items-end\">\n                              <span className=\"rounded-full bg-gray-200 px-3 py-1 text-xs font-semibold text-gray-700\">#{index + 1}</span>\n                              <button\n                                type=\"button\"\n                                onClick={() => deleteShowcaseTheme(themeId)}\n                                disabled={disableDelete}\n                                className=\"inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-red-600 transition-colors hover:bg-red-50 hv-button disabled:cursor-not-allowed disabled:opacity-50\"\n                                aria-disabled={disableDelete}\n                              >\n                                <Trash2 className=\"w-5 h-5\" />\n                                Supprimer\n                              </button>\n                            </div>\n                          </div>\n\n                          <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3\">\n                            {SHOWCASE_THEME_PALETTE_FIELDS.map((field) => (\n                              <div key={`${themeId}-${field.key}`} className=\"rounded-lg border border-gray-200 bg-white p-3 shadow-sm\">\n                                <label className=\"mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-600\" htmlFor={`${themeId}-${field.key}`}>\n                                  {field.label}\n                                </label>\n                                <div className=\"flex items-center gap-3\">\n                                  <input\n                                    id={`${themeId}-${field.key}`}\n                                    type=\"color\"\n                                    value={normalizeColorValue(palette[field.key], '#000000')}\n                                    onChange={(event) => updateShowcaseThemePalette(index, field.key, event.target.value)}\n                                    className=\"h-10 w-16 cursor-pointer rounded border border-gray-300 bg-white\"\n                                    aria-label={`SÃ©lectionner ${field.label.toLowerCase()}`}\n                                  />\n                                  <input\n                                    type=\"text\"\n                                    value={palette[field.key] || ''}\n                                    onChange={(event) => updateShowcaseThemePalette(index, field.key, event.target.value)}\n                                    className=\"flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm font-mono hv-focus-ring\"\n                                    placeholder=\"#000000\"\n                                  />\n                                </div>\n                                <p className=\"mt-1 text-xs text-gray-500\">{field.description}</p>\n                              </div>\n                            ))}\n                          </div>\n                        </article>\n                      );\n                    })}\n                  </div>\n                )}\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'onboarding' && (\n            <section\n              id=\"backoffice-tabpanel-onboarding\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-onboarding\"\n              className=\"space-y-6\"\n            >\n              <article className=\"space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                <header className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                  <div className=\"space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-gray-800\">Tour d'onboarding</h2>\n                    <p className=\"text-sm text-gray-600\">\n                      DÃ©finissez le contenu du tour guidÃ© : Ã©tapes, cibles, et boutons d'action pour proposer diffÃ©rents parcours.\n                    </p>\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    <button\n                      type=\"button\"\n                      onClick={addOnboardingStep}\n                      className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700 hv-button hv-button-primary\"\n                    >\n                      <Plus className=\"w-4 h-4\" />\n                      Ajouter une Ã©tape\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={resetOnboardingConfig}\n                      className=\"inline-flex items-center justify-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm transition-colors hover:bg-gray-50 hv-button\"\n                    >\n                      RÃ©initialiser\n                    </button>\n                  </div>\n                </header>\n\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                  <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                    <span className=\"font-semibold text-gray-700\">LibellÃ© â€œSuivantâ€</span>\n                    <input\n                      type=\"text\"\n                      value={normalizedOnboardingConfig.labels.next}\n                      onChange={(event) => updateOnboardingLabel('next', event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    />\n                  </label>\n                  <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                    <span className=\"font-semibold text-gray-700\">LibellÃ© â€œPrÃ©cÃ©dentâ€</span>\n                    <input\n                      type=\"text\"\n                      value={normalizedOnboardingConfig.labels.prev}\n                      onChange={(event) => updateOnboardingLabel('prev', event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    />\n                  </label>\n                  <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                    <span className=\"font-semibold text-gray-700\">LibellÃ© â€œFermerâ€</span>\n                    <input\n                      type=\"text\"\n                      value={normalizedOnboardingConfig.labels.close}\n                      onChange={(event) => updateOnboardingLabel('close', event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    />\n                  </label>\n                  <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                    <span className=\"font-semibold text-gray-700\">LibellÃ© â€œTerminerâ€</span>\n                    <input\n                      type=\"text\"\n                      value={normalizedOnboardingConfig.labels.finish}\n                      onChange={(event) => updateOnboardingLabel('finish', event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    />\n                  </label>\n                </div>\n\n                <div className=\"flex flex-wrap gap-4 text-sm text-gray-700\">\n                  <label className=\"inline-flex items-center gap-2\">\n                    <input\n                      type=\"checkbox\"\n                      checked={normalizedOnboardingConfig.allowClose}\n                      onChange={(event) => updateOnboardingField('allowClose', event.target.checked)}\n                      className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                    />\n                    Autoriser la fermeture manuelle\n                  </label>\n                  <label className=\"inline-flex items-center gap-2\">\n                    <input\n                      type=\"checkbox\"\n                      checked={normalizedOnboardingConfig.showStepDots}\n                      onChange={(event) => updateOnboardingField('showStepDots', event.target.checked)}\n                      className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                    />\n                    Afficher les points de progression\n                  </label>\n                </div>\n              </article>\n\n              {normalizedOnboardingConfig.steps.length === 0 ? (\n                <div className=\"rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-sm text-gray-600\">\n                  Aucune Ã©tape configurÃ©e. Ajoutez une premiÃ¨re Ã©tape pour dÃ©marrer.\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {normalizedOnboardingConfig.steps.map((step, index) => (\n                    <article key={`${step.id}-${index}`} className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface\">\n                      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                        <div className=\"space-y-1\">\n                          <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                            Ã‰tape {index + 1} sur {normalizedOnboardingConfig.steps.length}\n                          </p>\n                          <h3 className=\"text-lg font-semibold text-gray-800\">\n                            {step.title || step.id || 'Ã‰tape sans titre'}\n                          </h3>\n                          <p className=\"text-sm text-gray-600\">{step.target || 'Aucune cible dÃ©finie'}</p>\n                        </div>\n                        <div className=\"flex flex-wrap gap-2\">\n                          <button\n                            type=\"button\"\n                            onClick={() => moveOnboardingStep(index, -1)}\n                            className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white p-2 text-gray-600 hover:bg-gray-50 hv-button\"\n                            aria-label=\"Remonter l'Ã©tape\"\n                          >\n                            <ArrowUp className=\"w-4 h-4\" />\n                          </button>\n                          <button\n                            type=\"button\"\n                            onClick={() => moveOnboardingStep(index, 1)}\n                            className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white p-2 text-gray-600 hover:bg-gray-50 hv-button\"\n                            aria-label=\"Descendre l'Ã©tape\"\n                          >\n                            <ArrowDown className=\"w-4 h-4\" />\n                          </button>\n                          <button\n                            type=\"button\"\n                            onClick={() => deleteOnboardingStep(index)}\n                            className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white p-2 text-red-600 hover:bg-red-50 hv-button\"\n                            aria-label=\"Supprimer l'Ã©tape\"\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </button>\n                        </div>\n                      </div>\n\n                      <div className=\"mt-4 grid grid-cols-1 gap-4 md:grid-cols-2\">\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">Identifiant</span>\n                          <input\n                            type=\"text\"\n                            value={step.id}\n                            onChange={(event) => updateOnboardingStepField(index, 'id', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                          />\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">Cible (ID d'Ã©lÃ©ment)</span>\n                          <input\n                            type=\"text\"\n                            value={typeof step.target === 'string' && step.target.startsWith('#') ? step.target.slice(1) : ''}\n                            onChange={(event) => {\n                              const nextId = event.target.value.trim();\n                              if (nextId.length > 0) {\n                                updateOnboardingStepField(index, 'target', `#${nextId}`);\n                              } else if (typeof step.target === 'string' && step.target.startsWith('#')) {\n                                updateOnboardingStepField(index, 'target', '');\n                              }\n                            }}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"mon-element\"\n                          />\n                          <span className=\"text-xs text-gray-500\">Saisissez l'attribut id (sans #) pour cibler un Ã©lÃ©ment prÃ©cis.</span>\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">Cible (sÃ©lecteur CSS avancÃ©)</span>\n                          <input\n                            type=\"text\"\n                            value={step.target || ''}\n                            onChange={(event) => updateOnboardingStepField(index, 'target', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"#mon-element ou .ma-classe\"\n                          />\n                          <span className=\"text-xs text-gray-500\">\n                            Utilisez un sÃ©lecteur personnalisÃ© si besoin (ex. [data-tour-id=\"home-create-project\"]).\n                          </span>\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">Titre</span>\n                          <input\n                            type=\"text\"\n                            value={step.title}\n                            onChange={(event) => updateOnboardingStepField(index, 'title', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                          />\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">Position du tooltip</span>\n                          <select\n                            value={step.placement || ''}\n                            onChange={(event) => updateOnboardingStepField(index, 'placement', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                          >\n                            <option value=\"\">Automatique</option>\n                            <option value=\"top\">Haut</option>\n                            <option value=\"bottom\">Bas</option>\n                            <option value=\"left\">Gauche</option>\n                            <option value=\"right\">Droite</option>\n                          </select>\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">VisibilitÃ© du focus</span>\n                          <select\n                            value={step.highlightScope || 'target'}\n                            onChange={(event) => updateOnboardingStepField(index, 'highlightScope', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                          >\n                            <option value=\"target\">Uniquement la cible</option>\n                            <option value=\"page\">Page entiÃ¨re</option>\n                          </select>\n                        </label>\n                        <label className=\"flex flex-col gap-2 text-sm text-gray-700 md:col-span-2\">\n                          <span className=\"font-semibold text-gray-700\">Message</span>\n                          <textarea\n                            rows={3}\n                            value={step.content}\n                            onChange={(event) => updateOnboardingStepField(index, 'content', event.target.value)}\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                          />\n                        </label>\n                        <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n                          <input\n                            type=\"checkbox\"\n                            checked={step.showDefaultButtons !== false}\n                            onChange={(event) => updateOnboardingStepField(index, 'showDefaultButtons', event.target.checked)}\n                            className=\"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                          />\n                          Afficher les boutons â€œPrÃ©cÃ©dent/Suivantâ€\n                        </label>\n                      </div>\n\n                      <div className=\"mt-6 space-y-3 rounded-xl border border-gray-100 bg-gray-50 p-4\">\n                        <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                          <div>\n                            <p className=\"text-sm font-semibold text-gray-800\">Boutons d'action</p>\n                            <p className=\"text-xs text-gray-500\">\n                              Ajoutez des boutons pour proposer des choix ou des raccourcis vers d'autres Ã©tapes.\n                            </p>\n                          </div>\n                          <button\n                            type=\"button\"\n                            onClick={() => addOnboardingAction(index)}\n                            className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition-colors hover:bg-blue-700 hv-button hv-button-primary\"\n                          >\n                            <Plus className=\"w-3 h-3\" />\n                            Ajouter un bouton\n                          </button>\n                        </div>\n\n                        {Array.isArray(step.actions) && step.actions.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {step.actions.map((action, actionIndex) => (\n                              <div key={`${action.id}-${actionIndex}`} className=\"rounded-lg border border-gray-200 bg-white p-3\">\n                                <div className=\"grid grid-cols-1 gap-3 md:grid-cols-4\">\n                                  <label className=\"flex flex-col gap-1 text-xs font-medium text-gray-600\">\n                                    LibellÃ©\n                                    <input\n                                      type=\"text\"\n                                      value={action.label}\n                                      onChange={(event) =>\n                                        updateOnboardingActionField(index, actionIndex, 'label', event.target.value)\n                                      }\n                                      className=\"rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    />\n                                  </label>\n                                  <label className=\"flex flex-col gap-1 text-xs font-medium text-gray-600\">\n                                    Action\n                                    <select\n                                      value={action.action}\n                                      onChange={(event) =>\n                                        updateOnboardingActionField(index, actionIndex, 'action', event.target.value)\n                                      }\n                                      className=\"rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    >\n                                      <option value=\"next\">Aller Ã  l'Ã©tape suivante</option>\n                                      <option value=\"prev\">Revenir Ã  l'Ã©tape prÃ©cÃ©dente</option>\n                                      <option value=\"goTo\">Aller Ã  une Ã©tape prÃ©cise</option>\n                                      <option value=\"finish\">Terminer le tour</option>\n                                      <option value=\"close\">Fermer le tour</option>\n                                    </select>\n                                  </label>\n                                  <label className=\"flex flex-col gap-1 text-xs font-medium text-gray-600\">\n                                    Style\n                                    <select\n                                      value={action.variant || 'ghost'}\n                                      onChange={(event) =>\n                                        updateOnboardingActionField(index, actionIndex, 'variant', event.target.value)\n                                      }\n                                      className=\"rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                    >\n                                      <option value=\"primary\">Principal</option>\n                                      <option value=\"ghost\">Secondaire</option>\n                                    </select>\n                                  </label>\n                                  <div className=\"flex flex-col gap-1 text-xs font-medium text-gray-600\">\n                                    Ã‰tape cible\n                                    <div className=\"flex items-center gap-2\">\n                                      <select\n                                        value={action.stepId || ''}\n                                        onChange={(event) =>\n                                          updateOnboardingActionField(index, actionIndex, 'stepId', event.target.value)\n                                        }\n                                        disabled={action.action !== 'goTo'}\n                                        className=\"flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:bg-gray-100\"\n                                      >\n                                        <option value=\"\">SÃ©lectionnez une Ã©tape</option>\n                                        {normalizedOnboardingConfig.steps.map((targetStep) => (\n                                          <option key={targetStep.id} value={targetStep.id}>\n                                            {targetStep.id}\n                                          </option>\n                                        ))}\n                                      </select>\n                                      <button\n                                        type=\"button\"\n                                        onClick={() => deleteOnboardingAction(index, actionIndex)}\n                                        className=\"inline-flex items-center justify-center rounded-md border border-gray-200 bg-white p-2 text-red-600 hover:bg-red-50 hv-button\"\n                                        aria-label=\"Supprimer le bouton\"\n                                      >\n                                        <Trash2 className=\"w-3 h-3\" />\n                                      </button>\n                                    </div>\n                                  </div>\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-xs text-gray-500\">Aucun bouton personnalisÃ© pour cette Ã©tape.</p>\n                        )}\n                      </div>\n                    </article>\n                  ))}\n                </div>\n              )}\n            </section>\n          )}\n\n          {activeTab === 'questions' && (\n            <section id=\"backoffice-tabpanel-questions\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-questions\" className=\"space-y-4\">\n              <div className=\"sr-only\" aria-live=\"polite\">{reorderAnnouncement}</div>\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des questions</h2>\n                  <p className=\"text-sm text-gray-600\">DÃ©finissez les questions et leur logique d'affichage conditionnel.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addQuestion}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une question\n                </button>\n              </div>\n\n              <div className=\"rounded-lg border border-blue-100 bg-blue-50/60 px-4 py-3 text-sm text-blue-900\">\n                <p className=\"font-medium\">Questions vitrine du projet</p>\n                <p className=\"mt-1 text-blue-800\">\n                  Les questions marquÃ©es Â«&nbsp;Vitrine du projet&nbsp;Â» alimentent automatiquement la vitrine du projet.\n                  Elles sont obligatoires pour complÃ©ter le showcase et ne peuvent pas Ãªtre supprimÃ©es.\n                </p>\n              </div>\n\n              <div className=\"rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4\">\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  <div>\n                    <label\n                      htmlFor=\"question-title-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par titre ou identifiant\n                    </label>\n                    <input\n                      id=\"question-title-filter\"\n                      type=\"text\"\n                      value={questionTitleFilter}\n                      onChange={(event) => setQuestionTitleFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder=\"Ex. audience, q12...\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"question-team-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par Ã©quipe impliquÃ©e\n                    </label>\n                    <select\n                      id=\"question-team-filter\"\n                      value={questionTeamFilter}\n                      onChange={(event) => setQuestionTeamFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    >\n                      <option value=\"all\">Toutes les Ã©quipes</option>\n                      <option value=\"none\">Sans Ã©quipe identifiÃ©e</option>\n                      {availableTeamFilterOptions.map((option) => (\n                        <option key={`question-team-filter-${option.value}`} value={option.value}>\n                          {option.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div className=\"md:col-span-2 lg:col-span-1 flex items-end\">\n                    <p className=\"text-xs text-gray-500\">\n                      {questions.length === 0\n                        ? 'Aucune question configurÃ©e.'\n                        : visibleQuestionIds.length === questions.length\n                          ? 'Toutes les questions sont affichÃ©es.'\n                          : visibleQuestionIds.length === 0\n                            ? 'Aucune question ne correspond aux filtres.'\n                            : `${visibleQuestionIds.length} question${visibleQuestionIds.length > 1 ? 's' : ''} correspond${visibleQuestionIds.length > 1 ? 'ent' : ''} aux filtres.`}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {questions.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune question configurÃ©e pour le moment.\n                </div>\n              ) : visibleQuestionIds.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune question ne correspond aux filtres sÃ©lectionnÃ©s.\n                </div>\n              ) : (\n                shouldVirtualizeQuestions ? (\n                  <VirtualizedList\n                    items={visibleQuestionEntries}\n                    itemKey={(entry) => entry.question.id}\n                    estimatedItemHeight={360}\n                    overscan={4}\n                    className=\"relative\"\n                    renderItem={(entry) => {\n                      const { question, index } = entry;\n                      const typeMeta = getQuestionTypeMeta(question.type);\n                      const conditionSummary = buildConditionSummary(question, questions);\n                      const guidance = question.guidance || {};\n                      const tips = formatGuidanceTips(guidance);\n                      const numberUnitLabel =\n                        question.type === 'number' && typeof question.numberUnit === 'string'\n                          ? question.numberUnit.trim()\n                          : '';\n                      const isShowcaseQuestion = Boolean(question && question.showcase);\n                      const isProtectedQuestion = question?.id === 'ProjectType';\n                      const deleteButtonDisabled = isShowcaseQuestion || isProtectedQuestion;\n                      const deleteButtonClasses = deleteButtonDisabled\n                        ? 'p-2 text-gray-300 bg-gray-100 cursor-not-allowed rounded hv-button'\n                        : 'p-2 text-red-600 hover:bg-red-50 rounded hv-button';\n                      const deleteButtonTitle = isShowcaseQuestion\n                        ? 'Cette question alimente la vitrine du projet et ne peut pas Ãªtre supprimÃ©e.'\n                        : isProtectedQuestion\n                          ? 'Cette question est indispensable pour identifier le type de projet et ne peut pas Ãªtre supprimÃ©e.'\n                          : `Supprimer la question ${question.id}`;\n                      const questionTeams = questionTeamAssignments.get(question.id) || [];\n                      const questionTeamLabels = questionTeams.map((teamId) => getTeamLabel(teamId, teams));\n                      const isExpanded = expandedQuestionIds.has(question.id);\n                      const detailsId = `question-details-${question.id}`;\n                      const toggleLabel = isExpanded\n                        ? `Masquer les dÃ©tails de la question ${question.id}`\n                        : `Afficher les dÃ©tails de la question ${question.id}`;\n\n                      return (\n                        <div className=\"pb-6\">\n                          <article\n                            className={`border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface transition-shadow ${\n                              dragOverIndex === index ? 'ring-2 ring-blue-400 ring-offset-2' : ''\n                            } ${\n                              draggedQuestionIndex === index ? 'opacity-75' : ''\n                            }`}\n                            aria-label={`Question ${question.id}`}\n                            onDragOver={(event) => handleDragOver(event, index)}\n                            onDrop={(event) => handleDrop(event, index)}\n                          >\n                            <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                              <div className=\"flex items-start gap-3 flex-1\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => toggleQuestionExpansion(question.id)}\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                  aria-expanded={isExpanded}\n                                  aria-controls={detailsId}\n                                >\n                                  <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                  <span className=\"sr-only\">{toggleLabel}</span>\n                                </button>\n                                <div className=\"space-y-2 flex-1\">\n                                  <div className=\"flex flex-wrap items-center gap-2\">\n                                    <span className=\"text-xs font-semibold uppercase tracking-wide bg-blue-100 text-blue-700 px-2 py-1 rounded-full\">\n                                      {question.id}\n                                    </span>\n                                    <span className=\"text-sm bg-gray-100 text-gray-700 px-2 py-1 rounded-full\">\n                                      {typeMeta.label}\n                                    </span>\n                                    {isShowcaseQuestion && (\n                                      <span className=\"text-xs text-blue-800 bg-blue-100 px-2 py-1 rounded-full font-medium\">\n                                        Vitrine du projet\n                                      </span>\n                                    )}\n                                    {question.required && (\n                                      <span className=\"text-xs text-red-700 bg-red-100 px-2 py-1 rounded-full\">Obligatoire</span>\n                                    )}\n                                  </div>\n                                  <h3 className=\"text-lg font-semibold text-gray-800\">{question.question}</h3>\n                                  <div className=\"flex flex-wrap items-center gap-3 text-xs text-gray-500\">\n                                    <span id={`question-${question.id}-position`}>\n                                      Position {index + 1} sur {questions.length}\n                                    </span>\n                                  </div>\n                                  {questionTeamLabels.length > 0 && (\n                                    <div className=\"flex flex-wrap gap-2\">\n                                      {questionTeamLabels.map((label) => (\n                                        <span\n                                          key={`${question.id}-team-${label}`}\n                                          className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs border border-blue-100\"\n                                        >\n                                          {label}\n                                        </span>\n                                      ))}\n                                    </div>\n                                  )}\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-2\">\n                                <button\n                                  type=\"button\"\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 rounded hv-button cursor-move\"\n                                  aria-label={`RÃ©organiser la question ${question.id}. Position ${index + 1} sur ${questions.length}. Utilisez les flÃ¨ches haut et bas.`}\n                                  aria-describedby={`question-${question.id}-position`}\n                                  draggable\n                                  onDragStart={(event) => handleDragStart(event, index)}\n                                  onDragOver={(event) => handleDragOver(event, index)}\n                                  onDrop={(event) => handleDrop(event, index)}\n                                  onDragEnd={handleDragEnd}\n                                  onKeyDown={(event) => handleKeyboardReorder(event, index)}\n                                >\n                                  <GripVertical className=\"w-4 h-4\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => duplicateQuestion(question.id)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Dupliquer la question ${question.id}`}\n                                  title={`Dupliquer la question ${question.id}`}\n                                >\n                                  <Copy className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => setEditingQuestion(question)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Modifier la question ${question.id}`}\n                                >\n                                  <Edit className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => {\n                                    if (deleteButtonDisabled) {\n                                      return;\n                                    }\n\n                                    const confirmationMessage = `Voulez-vous vraiment supprimer la question ${question.id} ?`;\n                                    const shouldDelete = typeof window === 'undefined'\n                                      ? true\n                                      : window.confirm(confirmationMessage);\n\n                                    if (shouldDelete) {\n                                      deleteQuestion(question.id);\n                                    }\n                                  }}\n                                  className={deleteButtonClasses}\n                                  aria-label={deleteButtonTitle}\n                                  aria-disabled={deleteButtonDisabled}\n                                  disabled={deleteButtonDisabled}\n                                  title={deleteButtonTitle}\n                                >\n                                  <Trash2 className=\"w-5 h-5\" />\n                                </button>\n                              </div>\n                            </div>\n\n                            {isExpanded && (\n                              <div id={detailsId} className=\"mt-4 space-y-6\">\n                                <div className=\"space-y-2 text-sm text-gray-600\">\n                                  <p>{typeMeta.description}</p>\n                                  {numberUnitLabel && (\n                                    <p className=\"inline-flex items-center gap-2 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1 rounded-full\">\n                                      <Info className=\"w-4 h-4\" />\n                                      UnitÃ© affichÃ©e : {numberUnitLabel}\n                                    </p>\n                                  )}\n                                </div>\n\n                                {(Array.isArray(question.options) && question.options.length > 0) && (\n                                  <div>\n                                    <h4 className=\"text-sm font-semibold text-gray-700 flex items-center\">\n                                      <Info className=\"w-4 h-4 mr-2\" /> Options proposÃ©es\n                                    </h4>\n                                    <ul className=\"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-700\">\n                                      {question.options.map((option, optionIndex) => (\n                                        <li key={`${question.id}-option-${optionIndex}`} className=\"px-3 py-2 bg-gray-50 rounded-lg border border-gray-200\">\n                                          {option}\n                                        </li>\n                                      ))}\n                                    </ul>\n                                  </div>\n                                )}\n\n                                {conditionSummary.length > 0 ? (\n                                  <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-gray-700\">\n                                    <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions d'affichage</h4>\n                                    <ol className=\"space-y-3\">\n                                      {conditionSummary.map((group) => (\n                                        <li key={`${question.id}-condition-group-${group.index}`} className=\"space-y-2\">\n                                          <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                            Groupe {group.index} â€“ logique {group.logic === 'OU' ? 'OU (au moins une)' : 'ET (toutes)'}\n                                          </div>\n                                          <ul className=\"space-y-1\">\n                                            {group.parts.map((part, partIndex) => (\n                                              <li key={`${question.id}-part-${group.index}-${partIndex}`} className=\"flex items-baseline space-x-2\">\n                                                {part.connector && <span className=\"text-xs text-blue-500\">{part.connector}</span>}\n                                                <span className=\"font-mono bg-white px-2 py-0.5 rounded border border-blue-100\">{part.label}</span>\n                                                <span>{part.operator}</span>\n                                                <span className=\"font-semibold text-blue-700\">Â« {part.value} Â»</span>\n                                              </li>\n                                            ))}\n                                          </ul>\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Cette question est toujours affichÃ©e.</p>\n                                )}\n\n                                {(guidance.objective || guidance.details || tips.length > 0) && (\n                                  <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm text-gray-700 space-y-2\">\n                                    {guidance.objective && (\n                                      <p>\n                                        <strong className=\"text-gray-800\">Objectif :</strong>{' '}\n                                        {renderTextWithLinks(guidance.objective)}\n                                      </p>\n                                    )}\n                                    {guidance.details && (\n                                      <p>{renderTextWithLinks(guidance.details)}</p>\n                                    )}\n                                    {tips.length > 0 && (\n                                      <div>\n                                        <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-600 mb-1\">Conseils pratiques</p>\n                                        <ul className=\"list-disc list-inside space-y-1\">\n                                          {tips.map((tip, tipIndex) => (\n                                            <li key={`${question.id}-tip-${tipIndex}`}>{renderTextWithLinks(tip)}</li>\n                                          ))}\n                                        </ul>\n                                      </div>\n                                    )}\n                                  </div>\n                                )}\n                              </div>\n                            )}\n                          </article>\n                          {index < questions.length - 1 && (\n                            <div className=\"flex justify-center my-3\">\n                              <button\n                                type=\"button\"\n                                onClick={() => addQuestionAtIndex(index + 1)}\n                                className=\"w-10 h-10 rounded-full border-2 border-dashed border-blue-300 text-blue-600 bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 hv-button\"\n                                aria-label={`InsÃ©rer une nouvelle question aprÃ¨s la question ${question.id}`}\n                              >\n                                <Plus className=\"w-5 h-5\" />\n                                <span className=\"sr-only\">Ajouter une question Ã  cet emplacement</span>\n                              </button>\n                            </div>\n                          )}\n                        </div>\n                      );\n                    }}\n                  />\n                ) : (\n                  visibleQuestionEntries.map((entry) => {\n                    const { question, index } = entry;\n                    const typeMeta = getQuestionTypeMeta(question.type);\n                    const conditionSummary = buildConditionSummary(question, questions);\n                    const guidance = question.guidance || {};\n                    const tips = formatGuidanceTips(guidance);\n                    const numberUnitLabel =\n                      question.type === 'number' && typeof question.numberUnit === 'string'\n                        ? question.numberUnit.trim()\n                        : '';\n                    const isShowcaseQuestion = Boolean(question && question.showcase);\n                    const isProtectedQuestion = question?.id === 'ProjectType';\n                    const deleteButtonDisabled = isShowcaseQuestion || isProtectedQuestion;\n                    const deleteButtonClasses = deleteButtonDisabled\n                      ? 'p-2 text-gray-300 bg-gray-100 cursor-not-allowed rounded hv-button'\n                      : 'p-2 text-red-600 hover:bg-red-50 rounded hv-button';\n                    const deleteButtonTitle = isShowcaseQuestion\n                      ? 'Cette question alimente la vitrine du projet et ne peut pas Ãªtre supprimÃ©e.'\n                      : isProtectedQuestion\n                        ? 'Cette question est indispensable pour identifier le type de projet et ne peut pas Ãªtre supprimÃ©e.'\n                        : `Supprimer la question ${question.id}`;\n                    const questionTeams = questionTeamAssignments.get(question.id) || [];\n                    const questionTeamLabels = questionTeams.map((teamId) => getTeamLabel(teamId, teams));\n                    const isExpanded = expandedQuestionIds.has(question.id);\n                    const detailsId = `question-details-${question.id}`;\n                    const toggleLabel = isExpanded\n                      ? `Masquer les dÃ©tails de la question ${question.id}`\n                      : `Afficher les dÃ©tails de la question ${question.id}`;\n\n                    return (\n                      <React.Fragment key={question.id}>\n                        <article\n                          className={`border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface transition-shadow ${\n                            dragOverIndex === index ? 'ring-2 ring-blue-400 ring-offset-2' : ''\n                          } ${\n                            draggedQuestionIndex === index ? 'opacity-75' : ''\n                          }`}\n                          aria-label={`Question ${question.id}`}\n                          onDragOver={(event) => handleDragOver(event, index)}\n                          onDrop={(event) => handleDrop(event, index)}\n                        >\n                          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                            <div className=\"flex items-start gap-3 flex-1\">\n                              <button\n                                type=\"button\"\n                                onClick={() => toggleQuestionExpansion(question.id)}\n                                className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                aria-expanded={isExpanded}\n                                aria-controls={detailsId}\n                              >\n                                <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                <span className=\"sr-only\">{toggleLabel}</span>\n                              </button>\n                              <div className=\"space-y-2 flex-1\">\n                                <div className=\"flex flex-wrap items-center gap-2\">\n                                  <span className=\"text-xs font-semibold uppercase tracking-wide bg-blue-100 text-blue-700 px-2 py-1 rounded-full\">\n                                    {question.id}\n                                  </span>\n                                  <span className=\"text-sm bg-gray-100 text-gray-700 px-2 py-1 rounded-full\">\n                                    {typeMeta.label}\n                                  </span>\n                                  {isShowcaseQuestion && (\n                                    <span className=\"text-xs text-blue-800 bg-blue-100 px-2 py-1 rounded-full font-medium\">\n                                      Vitrine du projet\n                                    </span>\n                                  )}\n                                  {question.required && (\n                                    <span className=\"text-xs text-red-700 bg-red-100 px-2 py-1 rounded-full\">Obligatoire</span>\n                                  )}\n                                </div>\n                                <h3 className=\"text-lg font-semibold text-gray-800\">{question.question}</h3>\n                                <div className=\"flex flex-wrap items-center gap-3 text-xs text-gray-500\">\n                                  <span id={`question-${question.id}-position`}>\n                                    Position {index + 1} sur {questions.length}\n                                  </span>\n                                </div>\n                                {questionTeamLabels.length > 0 && (\n                                  <div className=\"flex flex-wrap gap-2\">\n                                    {questionTeamLabels.map((label) => (\n                                      <span\n                                        key={`${question.id}-team-${label}`}\n                                        className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs border border-blue-100\"\n                                      >\n                                        {label}\n                                      </span>\n                                    ))}\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"flex flex-wrap gap-2\">\n                              <button\n                                type=\"button\"\n                                className=\"p-2 text-gray-500 hover:text-blue-600 rounded hv-button cursor-move\"\n                                aria-label={`RÃ©organiser la question ${question.id}. Position ${index + 1} sur ${questions.length}. Utilisez les flÃ¨ches haut et bas.`}\n                                aria-describedby={`question-${question.id}-position`}\n                                draggable\n                                onDragStart={(event) => handleDragStart(event, index)}\n                                onDragOver={(event) => handleDragOver(event, index)}\n                                onDrop={(event) => handleDrop(event, index)}\n                                onDragEnd={handleDragEnd}\n                                onKeyDown={(event) => handleKeyboardReorder(event, index)}\n                              >\n                                <GripVertical className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => duplicateQuestion(question.id)}\n                                className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                aria-label={`Dupliquer la question ${question.id}`}\n                                title={`Dupliquer la question ${question.id}`}\n                              >\n                                <Copy className=\"w-5 h-5\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => setEditingQuestion(question)}\n                                className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                aria-label={`Modifier la question ${question.id}`}\n                              >\n                                <Edit className=\"w-5 h-5\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => {\n                                  if (deleteButtonDisabled) {\n                                    return;\n                                  }\n\n                                  const confirmationMessage = `Voulez-vous vraiment supprimer la question ${question.id} ?`;\n                                  const shouldDelete = typeof window === 'undefined'\n                                    ? true\n                                    : window.confirm(confirmationMessage);\n\n                                  if (shouldDelete) {\n                                    deleteQuestion(question.id);\n                                  }\n                                }}\n                                className={deleteButtonClasses}\n                                aria-label={deleteButtonTitle}\n                                aria-disabled={deleteButtonDisabled}\n                                disabled={deleteButtonDisabled}\n                                title={deleteButtonTitle}\n                              >\n                                <Trash2 className=\"w-5 h-5\" />\n                              </button>\n                            </div>\n                          </div>\n\n                          {isExpanded && (\n                            <div id={detailsId} className=\"mt-4 space-y-6\">\n                              <div className=\"space-y-2 text-sm text-gray-600\">\n                                <p>{typeMeta.description}</p>\n                                {numberUnitLabel && (\n                                  <p className=\"inline-flex items-center gap-2 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1 rounded-full\">\n                                    <Info className=\"w-4 h-4\" />\n                                    UnitÃ© affichÃ©e : {numberUnitLabel}\n                                  </p>\n                                )}\n                              </div>\n\n                              {(Array.isArray(question.options) && question.options.length > 0) && (\n                                <div>\n                                  <h4 className=\"text-sm font-semibold text-gray-700 flex items-center\">\n                                    <Info className=\"w-4 h-4 mr-2\" /> Options proposÃ©es\n                                  </h4>\n                                  <ul className=\"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-700\">\n                                    {question.options.map((option, optionIndex) => (\n                                      <li key={`${question.id}-option-${optionIndex}`} className=\"px-3 py-2 bg-gray-50 rounded-lg border border-gray-200\">\n                                        {option}\n                                      </li>\n                                    ))}\n                                  </ul>\n                                </div>\n                              )}\n\n                              {conditionSummary.length > 0 ? (\n                                <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-gray-700\">\n                                  <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions d'affichage</h4>\n                                  <ol className=\"space-y-3\">\n                                    {conditionSummary.map((group) => (\n                                      <li key={`${question.id}-condition-group-${group.index}`} className=\"space-y-2\">\n                                        <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                          Groupe {group.index} â€“ logique {group.logic === 'OU' ? 'OU (au moins une)' : 'ET (toutes)'}\n                                        </div>\n                                        <ul className=\"space-y-1\">\n                                          {group.parts.map((part, partIndex) => (\n                                            <li key={`${question.id}-part-${group.index}-${partIndex}`} className=\"flex items-baseline space-x-2\">\n                                              {part.connector && <span className=\"text-xs text-blue-500\">{part.connector}</span>}\n                                              <span className=\"font-mono bg-white px-2 py-0.5 rounded border border-blue-100\">{part.label}</span>\n                                              <span>{part.operator}</span>\n                                              <span className=\"font-semibold text-blue-700\">Â« {part.value} Â»</span>\n                                            </li>\n                                          ))}\n                                        </ul>\n                                      </li>\n                                    ))}\n                                  </ol>\n                                </div>\n                              ) : (\n                                <p className=\"text-xs text-gray-500 italic\">Cette question est toujours affichÃ©e.</p>\n                              )}\n\n                              {(guidance.objective || guidance.details || tips.length > 0) && (\n                                <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm text-gray-700 space-y-2\">\n                                  {guidance.objective && (\n                                    <p>\n                                      <strong className=\"text-gray-800\">Objectif :</strong>{' '}\n                                      {renderTextWithLinks(guidance.objective)}\n                                    </p>\n                                  )}\n                                  {guidance.details && (\n                                    <p>{renderTextWithLinks(guidance.details)}</p>\n                                  )}\n                                  {tips.length > 0 && (\n                                    <div>\n                                      <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-600 mb-1\">Conseils pratiques</p>\n                                      <ul className=\"list-disc list-inside space-y-1\">\n                                        {tips.map((tip, tipIndex) => (\n                                          <li key={`${question.id}-tip-${tipIndex}`}>{renderTextWithLinks(tip)}</li>\n                                        ))}\n                                      </ul>\n                                    </div>\n                                  )}\n                                </div>\n                              )}\n                            </div>\n                          )}\n                        </article>\n                        {index < questions.length - 1 && (\n                          <div className=\"flex justify-center my-3\">\n                            <button\n                              type=\"button\"\n                              onClick={() => addQuestionAtIndex(index + 1)}\n                              className=\"w-10 h-10 rounded-full border-2 border-dashed border-blue-300 text-blue-600 bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 hv-button\"\n                              aria-label={`InsÃ©rer une nouvelle question aprÃ¨s la question ${question.id}`}\n                            >\n                              <Plus className=\"w-5 h-5\" />\n                              <span className=\"sr-only\">Ajouter une question Ã  cet emplacement</span>\n                            </button>\n                          </div>\n                        )}\n                      </React.Fragment>\n                    );\n                  })\n                )\n              )}\n            </section>\n          )}\n\n          {activeTab === 'rules' && (\n            <section id=\"backoffice-tabpanel-rules\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-rules\" className=\"space-y-4\">\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des rÃ¨gles</h2>\n                  <p className=\"text-sm text-gray-600\">Identifiez les combinaisons Ã  risque et les Ã©quipes concernÃ©es.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addRule}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une rÃ¨gle\n                </button>\n              </div>\n\n              <div className=\"rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4\">\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  <div>\n                    <label\n                      htmlFor=\"rule-title-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par titre ou identifiant\n                    </label>\n                    <input\n                      id=\"rule-title-filter\"\n                      type=\"text\"\n                      value={ruleTitleFilter}\n                      onChange={(event) => setRuleTitleFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder=\"Ex. donnÃ©es, rule3...\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"rule-team-filter\"\n                      className=\"text-xs font-semibold uppercase tracking-wide text-gray-600\"\n                    >\n                      Filtrer par Ã©quipe impliquÃ©e\n                    </label>\n                    <select\n                      id=\"rule-team-filter\"\n                      value={ruleTeamFilter}\n                      onChange={(event) => setRuleTeamFilter(event.target.value)}\n                      className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    >\n                      <option value=\"all\">Toutes les Ã©quipes</option>\n                      <option value=\"none\">Sans Ã©quipe identifiÃ©e</option>\n                      {availableTeamFilterOptions.map((option) => (\n                        <option key={`rule-team-filter-${option.value}`} value={option.value}>\n                          {option.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div className=\"md:col-span-2 lg:col-span-1 flex items-end\">\n                    <p className=\"text-xs text-gray-500\">\n                      {rules.length === 0\n                        ? 'Aucune rÃ¨gle mÃ©tier n\\'est configurÃ©e.'\n                        : visibleRuleIds.length === rules.length\n                          ? 'Toutes les rÃ¨gles sont affichÃ©es.'\n                          : visibleRuleIds.length === 0\n                            ? 'Aucune rÃ¨gle ne correspond aux filtres.'\n                            : `${visibleRuleIds.length} rÃ¨gle${visibleRuleIds.length > 1 ? 's' : ''} correspond${visibleRuleIds.length > 1 ? 'ent' : ''} aux filtres.`}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {rules.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune rÃ¨gle mÃ©tier n'est configurÃ©e.\n                </div>\n              ) : visibleRuleIds.length === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune rÃ¨gle ne correspond aux filtres sÃ©lectionnÃ©s.\n                </div>\n              ) : (\n                shouldVirtualizeRules ? (\n                  <VirtualizedList\n                    items={visibleRuleEntries}\n                    itemKey={(rule) => rule.id}\n                    estimatedItemHeight={320}\n                    overscan={3}\n                    className=\"relative\"\n                    renderItem={(rule) => {\n                      const conditionSummary = buildRuleConditionSummary(rule, questions);\n                      const risks = Array.isArray(rule.risks) ? rule.risks : [];\n                      const highestRiskPriority = getHighestRiskPriority(risks);\n                      const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n                      const associatedTeamLabels = associatedTeamIds.map((teamId) => getTeamLabel(teamId, teams));\n                      const isExpanded = expandedRuleIds.has(rule.id);\n                      const detailsId = `rule-details-${rule.id}`;\n                      const ruleDisplayName = typeof rule.name === 'string' && rule.name.trim() !== '' ? rule.name : rule.id;\n                      const toggleLabel = isExpanded\n                        ? `Masquer les dÃ©tails de la rÃ¨gle ${ruleDisplayName}`\n                        : `Afficher les dÃ©tails de la rÃ¨gle ${ruleDisplayName}`;\n\n                      return (\n                        <div className=\"pb-6\">\n                          <article className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                            <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                              <div className=\"flex items-start gap-3 flex-1\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => toggleRuleExpansion(rule.id)}\n                                  className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                                  aria-expanded={isExpanded}\n                                  aria-controls={detailsId}\n                                >\n                                  <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                                  <span className=\"sr-only\">{toggleLabel}</span>\n                                </button>\n                                <div className=\"space-y-2 flex-1\">\n                                  <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-500\">\n                                    <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold\">{rule.id}</span>\n                                    <span className={`px-2 py-1 rounded-full font-semibold ${getPriorityBadgeClasses(highestRiskPriority)}`}>\n                                      {highestRiskPriority\n                                        ? `PrioritÃ© principale : ${highestRiskPriority}`\n                                        : 'PrioritÃ© non renseignÃ©e'}\n                                    </span>\n                                  </div>\n                                  <h3 className=\"text-lg font-semibold text-gray-800\">{ruleDisplayName}</h3>\n                                  {associatedTeamLabels.length > 0 && (\n                                    <div className=\"flex flex-wrap gap-2 text-xs\">\n                                      {associatedTeamLabels.map((label) => (\n                                        <span\n                                          key={`${rule.id}-team-${label}`}\n                                          className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100\"\n                                        >\n                                          {label}\n                                        </span>\n                                      ))}\n                                    </div>\n                                  )}\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-2\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => setEditingRule(rule)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Afficher la rÃ¨gle ${ruleDisplayName}`}\n                                >\n                                  <Eye className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => duplicateRule(rule.id)}\n                                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                                  aria-label={`Dupliquer la rÃ¨gle ${ruleDisplayName}`}\n                                  title={`Dupliquer la rÃ¨gle ${ruleDisplayName}`}\n                                >\n                                  <Copy className=\"w-5 h-5\" />\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  onClick={() => deleteRule(rule.id)}\n                                  className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                                  aria-label={`Supprimer la rÃ¨gle ${ruleDisplayName}`}\n                                >\n                                  <Trash2 className=\"w-5 h-5\" />\n                                </button>\n                              </div>\n                            </div>\n\n                            {isExpanded && (\n                              <div id={detailsId} className=\"mt-4 space-y-6 text-sm text-gray-700\">\n                                {conditionSummary.length > 0 ? (\n                                  <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4\">\n                                    <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions de dÃ©clenchement</h4>\n                                    <ol className=\"space-y-3\">\n                                      {conditionSummary.map((group) => (\n                                        <li key={`${rule.id}-group-${group.index}`} className=\"space-y-2\">\n                                          <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                            Groupe {group.index} â€“ logique {group.logic === 'OU' ? 'OU' : 'ET'}\n                                          </div>\n                                          <ul className=\"space-y-1\">\n                                            {group.items.map((item, idx) => (\n                                              <li key={`${rule.id}-item-${group.index}-${idx}`} className=\"flex items-start space-x-2\">\n                                                <span className=\"text-blue-500 mt-1\">â€¢</span>\n                                                <span>{item.description}</span>\n                                              </li>\n                                            ))}\n                                          </ul>\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">\n                                    Cette rÃ¨gle est toujours active (aucune condition configurÃ©e).\n                                  </p>\n                                )}\n\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                                  <div className=\"space-y-2\">\n                                    <h4 className=\"font-semibold text-gray-800\">Ã‰quipes impliquÃ©es</h4>\n                                    {associatedTeamLabels.length > 0 ? (\n                                      <ul className=\"flex flex-wrap gap-2\">\n                                        {associatedTeamLabels.map((label) => (\n                                          <li key={`${rule.id}-details-team-${label}`} className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded border border-blue-100\">\n                                            {label}\n                                          </li>\n                                        ))}\n                                      </ul>\n                                    ) : (\n                                      <p className=\"text-xs text-gray-500 italic\">Aucune Ã©quipe associÃ©e.</p>\n                                    )}\n                                  </div>\n\n                                  <div className=\"space-y-2\">\n                                    <h4 className=\"font-semibold text-gray-800\">Risques identifiÃ©s</h4>\n                                    {risks.length > 0 ? (\n                                      <ul className=\"space-y-1\">\n                                        {risks.map((risk, index) => {\n                                          const riskDescription = risk && risk.description ? risk.description : 'Risque non renseignÃ©';\n                                          const riskPriority = risk?.priority || 'A rÃ©aliser';\n                                          const riskTeamLabel = risk?.teamId ? getTeamLabel(risk.teamId, teams) : 'Ã‰quipe non renseignÃ©e';\n\n                                          return (\n                                            <li key={`${rule.id}-risk-${index}`} className=\"space-y-1\">\n                                              <div className=\"flex items-start space-x-2\">\n                                                <span className=\"text-red-500 mt-1\">â€¢</span>\n                                                <span>{riskDescription}</span>\n                                              </div>\n                                              <div className=\"text-xs text-gray-500 flex flex-wrap gap-2 pl-4\">\n                                                <span className=\"inline-flex items-center gap-1\">\n                                                  <strong className=\"font-semibold text-gray-600\">Ã‰quipe :</strong>\n                                                  <span>{riskTeamLabel}</span>\n                                                </span>\n                                                <span className=\"inline-flex items-center gap-1\">\n                                                  <strong className=\"font-semibold text-gray-600\">PrioritÃ© :</strong>\n                                                  <span>{riskPriority}</span>\n                                                </span>\n                                              </div>\n                                            </li>\n                                          );\n                                        })}\n                                      </ul>\n                                    ) : (\n                                      <p className=\"text-xs text-gray-500 italic\">Aucun risque documentÃ©.</p>\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            )}\n                          </article>\n                        </div>\n                      );\n                    }}\n                  />\n                ) : (\n                  visibleRuleEntries.map((rule) => {\n                    const conditionSummary = buildRuleConditionSummary(rule, questions);\n                    const risks = Array.isArray(rule.risks) ? rule.risks : [];\n                    const highestRiskPriority = getHighestRiskPriority(risks);\n                    const associatedTeamIds = Array.from(collectRuleTeamIds(rule));\n                    const associatedTeamLabels = associatedTeamIds.map((teamId) => getTeamLabel(teamId, teams));\n                    const isExpanded = expandedRuleIds.has(rule.id);\n                    const detailsId = `rule-details-${rule.id}`;\n                    const ruleDisplayName = typeof rule.name === 'string' && rule.name.trim() !== '' ? rule.name : rule.id;\n                    const toggleLabel = isExpanded\n                      ? `Masquer les dÃ©tails de la rÃ¨gle ${ruleDisplayName}`\n                      : `Afficher les dÃ©tails de la rÃ¨gle ${ruleDisplayName}`;\n\n                    return (\n                      <article key={rule.id} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                        <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n                          <div className=\"flex items-start gap-3 flex-1\">\n                            <button\n                              type=\"button\"\n                              onClick={() => toggleRuleExpansion(rule.id)}\n                              className=\"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full hv-button\"\n                              aria-expanded={isExpanded}\n                              aria-controls={detailsId}\n                            >\n                              <ChevronRight className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />\n                              <span className=\"sr-only\">{toggleLabel}</span>\n                            </button>\n                            <div className=\"space-y-2 flex-1\">\n                              <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-500\">\n                                <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold\">{rule.id}</span>\n                                <span className={`px-2 py-1 rounded-full font-semibold ${getPriorityBadgeClasses(highestRiskPriority)}`}>\n                                  {highestRiskPriority\n                                    ? `PrioritÃ© principale : ${highestRiskPriority}`\n                                    : 'PrioritÃ© non renseignÃ©e'}\n                                </span>\n                              </div>\n                              <h3 className=\"text-lg font-semibold text-gray-800\">{ruleDisplayName}</h3>\n                              {associatedTeamLabels.length > 0 && (\n                                <div className=\"flex flex-wrap gap-2 text-xs\">\n                                  {associatedTeamLabels.map((label) => (\n                                    <span\n                                      key={`${rule.id}-team-${label}`}\n                                      className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100\"\n                                    >\n                                      {label}\n                                    </span>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex flex-wrap gap-2\">\n                            <button\n                              type=\"button\"\n                              onClick={() => setEditingRule(rule)}\n                              className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                              aria-label={`Afficher la rÃ¨gle ${ruleDisplayName}`}\n                            >\n                              <Eye className=\"w-5 h-5\" />\n                            </button>\n                            <button\n                              type=\"button\"\n                              onClick={() => duplicateRule(rule.id)}\n                              className=\"p-2 text-blue-600 hover:bg-blue-50 rounded hv-button\"\n                              aria-label={`Dupliquer la rÃ¨gle ${ruleDisplayName}`}\n                              title={`Dupliquer la rÃ¨gle ${ruleDisplayName}`}\n                            >\n                              <Copy className=\"w-5 h-5\" />\n                            </button>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteRule(rule.id)}\n                              className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                              aria-label={`Supprimer la rÃ¨gle ${ruleDisplayName}`}\n                            >\n                              <Trash2 className=\"w-5 h-5\" />\n                            </button>\n                          </div>\n                        </div>\n\n                        {isExpanded && (\n                          <div id={detailsId} className=\"mt-4 space-y-6 text-sm text-gray-700\">\n                            {conditionSummary.length > 0 ? (\n                              <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4\">\n                                <h4 className=\"text-sm font-semibold text-blue-700 mb-3\">Conditions de dÃ©clenchement</h4>\n                                <ol className=\"space-y-3\">\n                                  {conditionSummary.map((group) => (\n                                    <li key={`${rule.id}-group-${group.index}`} className=\"space-y-2\">\n                                      <div className=\"text-xs font-semibold text-blue-600 uppercase tracking-wide\">\n                                        Groupe {group.index} â€“ logique {group.logic === 'OU' ? 'OU' : 'ET'}\n                                      </div>\n                                      <ul className=\"space-y-1\">\n                                        {group.items.map((item, idx) => (\n                                          <li key={`${rule.id}-item-${group.index}-${idx}`} className=\"flex items-start space-x-2\">\n                                            <span className=\"text-blue-500 mt-1\">â€¢</span>\n                                            <span>{item.description}</span>\n                                          </li>\n                                        ))}\n                                      </ul>\n                                    </li>\n                                  ))}\n                                </ol>\n                              </div>\n                            ) : (\n                              <p className=\"text-xs text-gray-500 italic\">\n                                Cette rÃ¨gle est toujours active (aucune condition configurÃ©e).\n                              </p>\n                            )}\n\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                              <div className=\"space-y-2\">\n                                <h4 className=\"font-semibold text-gray-800\">Ã‰quipes impliquÃ©es</h4>\n                                {associatedTeamLabels.length > 0 ? (\n                                  <ul className=\"flex flex-wrap gap-2\">\n                                    {associatedTeamLabels.map((label) => (\n                                      <li key={`${rule.id}-details-team-${label}`} className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded border border-blue-100\">\n                                        {label}\n                                      </li>\n                                    ))}\n                                  </ul>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Aucune Ã©quipe associÃ©e.</p>\n                                )}\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <h4 className=\"font-semibold text-gray-800\">Risques identifiÃ©s</h4>\n                                {risks.length > 0 ? (\n                                  <ul className=\"space-y-1\">\n                                    {risks.map((risk, index) => {\n                                      const riskDescription = risk && risk.description ? risk.description : 'Risque non renseignÃ©';\n                                      const riskPriority = risk?.priority || 'A rÃ©aliser';\n                                      const riskTeamLabel = risk?.teamId ? getTeamLabel(risk.teamId, teams) : 'Ã‰quipe non renseignÃ©e';\n\n                                      return (\n                                        <li key={`${rule.id}-risk-${index}`} className=\"space-y-1\">\n                                          <div className=\"flex items-start space-x-2\">\n                                            <span className=\"text-red-500 mt-1\">â€¢</span>\n                                            <span>{riskDescription}</span>\n                                          </div>\n                                          <div className=\"text-xs text-gray-500 flex flex-wrap gap-2 pl-4\">\n                                            <span className=\"inline-flex items-center gap-1\">\n                                              <strong className=\"font-semibold text-gray-600\">Ã‰quipe :</strong>\n                                              <span>{riskTeamLabel}</span>\n                                            </span>\n                                            <span className=\"inline-flex items-center gap-1\">\n                                              <strong className=\"font-semibold text-gray-600\">PrioritÃ© :</strong>\n                                              <span>{riskPriority}</span>\n                                            </span>\n                                          </div>\n                                        </li>\n                                      );\n                                    })}\n                                  </ul>\n                                ) : (\n                                  <p className=\"text-xs text-gray-500 italic\">Aucun risque documentÃ©.</p>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        )}\n                      </article>\n                    );\n                  })\n                )\n              )}\n            </section>\n          )}\n\n          {activeTab === 'validationCommittee' && (\n            <section\n              id=\"backoffice-tabpanel-validationCommittee\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-validationCommittee\"\n              className=\"space-y-6\"\n            >\n              <article className=\"rounded-2xl border border-gray-200 bg-white p-6 shadow-sm hv-surface space-y-6\">\n                <header className=\"space-y-2\">\n                  <h2 className=\"text-2xl font-bold text-gray-800\">ComitÃ© de validation</h2>\n                  <p className=\"text-sm text-gray-600\">\n                    DÃ©finissez plusieurs comitÃ©s avec leurs contacts et leurs rÃ¨gles de dÃ©clenchement.\n                  </p>\n                </header>\n\n                <div className=\"rounded-xl border border-blue-100 bg-blue-50 p-4 text-sm text-blue-900\">\n                  Activez la demande de commentaire pour chaque comitÃ© selon vos besoins. Le commentaire est requis\n                  lorsque les critÃ¨res du comitÃ© et lâ€™option dÃ©diÃ©e sont actifs.\n                </div>\n\n                <div className=\"flex flex-wrap items-center gap-3\">\n                  <label className=\"inline-flex items-center gap-3 text-sm font-medium text-gray-700\">\n                    <input\n                      type=\"checkbox\"\n                      className=\"h-4 w-4 rounded border-gray-300 text-blue-600\"\n                      checked={normalizedValidationCommitteeConfig.enabled}\n                      onChange={(event) => {\n                        updateValidationCommitteeConfig((prev) => ({\n                          ...prev,\n                          enabled: event.target.checked\n                        }));\n                      }}\n                    />\n                    Activer le suivi des comitÃ©s de validation\n                  </label>\n                  <button\n                    type=\"button\"\n                    onClick={addCommitteeEntry}\n                    className=\"ml-auto inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n                  >\n                    Ajouter un comitÃ©\n                  </button>\n                </div>\n\n                {normalizedValidationCommitteeConfig.committees.length === 0 ? (\n                  <p className=\"text-sm text-gray-500\">\n                    Aucun comitÃ© nâ€™est configurÃ©. Ajoutez-en un pour dÃ©finir ses rÃ¨gles.\n                  </p>\n                ) : (\n                  <div className=\"space-y-6\">\n                    {normalizedValidationCommitteeConfig.committees.map((committee, index) => (\n                      <article\n                        key={committee.id}\n                        className=\"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm space-y-5\"\n                      >\n                        <div className=\"flex flex-wrap items-start justify-between gap-3\">\n                          <div className=\"space-y-2\">\n                            <h3 className=\"text-lg font-semibold text-gray-800\">\n                              {committee.name || `ComitÃ© ${index + 1}`}\n                            </h3>\n                            <p className=\"text-xs text-gray-500\">\n                              Configurez les contacts et les rÃ¨gles de dÃ©clenchement spÃ©cifiques Ã  ce comitÃ©.\n                            </p>\n                            <label className=\"inline-flex items-center gap-2 text-xs font-medium text-gray-600\">\n                              <input\n                                type=\"checkbox\"\n                                className=\"h-4 w-4 rounded border-gray-300 text-blue-600\"\n                                checked={committee.commentRequired !== false}\n                                onChange={(event) =>\n                                  updateCommitteeEntry(committee.id, (prev) => ({\n                                    ...prev,\n                                    commentRequired: event.target.checked\n                                  }))\n                                }\n                              />\n                              Activer la demande de commentaire\n                            </label>\n                          </div>\n                          <button\n                            type=\"button\"\n                            onClick={() => removeCommitteeEntry(committee.id)}\n                            className=\"text-xs font-semibold text-red-600 hover:text-red-700\"\n                          >\n                            Supprimer\n                          </button>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 gap-4 lg:grid-cols-2\">\n                          <div>\n                            <label\n                              htmlFor={`validation-committee-name-${committee.id}`}\n                              className=\"text-sm font-medium text-gray-700\"\n                            >\n                              Nom du comitÃ©\n                            </label>\n                            <input\n                              id={`validation-committee-name-${committee.id}`}\n                              type=\"text\"\n                              value={committee.name}\n                              onChange={(event) =>\n                                updateCommitteeEntry(committee.id, (prev) => ({\n                                  ...prev,\n                                  name: event.target.value\n                                }))\n                              }\n                              className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder={`ComitÃ© ${index + 1}`}\n                            />\n                          </div>\n                          <div>\n                            <label\n                              htmlFor={`validation-committee-emails-${committee.id}`}\n                              className=\"text-sm font-medium text-gray-700\"\n                            >\n                              Adresses mail\n                            </label>\n                            <input\n                              id={`validation-committee-emails-${committee.id}`}\n                              type=\"text\"\n                              value={committee.emails.join(', ')}\n                              onChange={(event) =>\n                                updateCommitteeEntry(committee.id, (prev) => ({\n                                  ...prev,\n                                  emails: parseEmailList(event.target.value)\n                                }))\n                              }\n                              className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              placeholder=\"ex: comite@company.com, bureau@company.com\"\n                            />\n                            <p className=\"mt-2 text-xs text-gray-500\">\n                              SÃ©parez plusieurs adresses par une virgule, un point-virgule ou un retour Ã  la ligne.\n                            </p>\n                          </div>\n                        </div>\n\n                        <div className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\n                          <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                            <div>\n                              <h4 className=\"text-base font-semibold text-gray-800\">\n                                Conditions de dÃ©clenchement\n                              </h4>\n                              <p className=\"text-xs text-gray-600\">\n                                DÃ©clenchez ce comitÃ© en fonction des rÃ©ponses renseignÃ©es dans le projet.\n                              </p>\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => addCommitteeConditionGroup(committee.id)}\n                              className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n                            >\n                              <Plus className=\"h-4 w-4\" />\n                              Ajouter un groupe\n                            </button>\n                          </div>\n\n                          {(() => {\n                            const conditionGroups = normalizeRuleConditionGroups(committee);\n\n                            if (conditionGroups.length === 0) {\n                              return (\n                                <div className=\"rounded-lg border border-dashed border-blue-200 bg-white p-4 text-center text-sm text-blue-700\">\n                                  <p>Ce comitÃ© ne dÃ©pend pas encore des rÃ©ponses du projet.</p>\n                                  <button\n                                    type=\"button\"\n                                    onClick={() => addCommitteeConditionGroup(committee.id)}\n                                    className=\"mt-3 inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700\"\n                                  >\n                                    <Plus className=\"h-4 w-4\" />\n                                    CrÃ©er un groupe de conditions\n                                  </button>\n                                </div>\n                              );\n                            }\n\n                            return (\n                              <div className=\"space-y-4\">\n                                <div className=\"rounded-lg border border-blue-200 bg-blue-50 p-3 text-sm text-blue-900\">\n                                  {conditionGroups.length === 1 ? (\n                                    (() => {\n                                      const logic = conditionGroups[0].logic === 'any' ? 'any' : 'all';\n                                      const logicLabel = logic === 'any' ? 'OU' : 'ET';\n                                      const logicDescription = logic === 'any'\n                                        ? 'au moins une des conditions ci-dessous est remplie'\n                                        : 'toutes les conditions ci-dessous sont remplies';\n\n                                      return (\n                                        <p>\n                                          <strong>Logique :</strong> Le comitÃ© se dÃ©clenche si{' '}\n                                          <strong className=\"text-blue-700\">{logicDescription}</strong>{' '}\n                                          (logique {logicLabel}).\n                                        </p>\n                                      );\n                                    })()\n                                  ) : (\n                                    <div className=\"space-y-1\">\n                                      <p>\n                                        <strong>Logique :</strong> Le comitÃ© se dÃ©clenche lorsque{' '}\n                                        <strong className=\"text-blue-700\">chaque groupe de conditions</strong> est validÃ© (logique globale <strong>ET</strong>).\n                                      </p>\n                                      <p>\n                                        Ã€ l'intÃ©rieur d'un groupe, choisissez si{' '}\n                                        <strong className=\"text-blue-700\">toutes</strong> les conditions doivent Ãªtre vraies (ET) ou si{' '}\n                                        <strong className=\"text-blue-700\">au moins une</strong> suffit (OU).\n                                      </p>\n                                    </div>\n                                  )}\n                                </div>\n\n                                <div className=\"space-y-6\">\n                                  {conditionGroups.map((group, groupIdx) => {\n                                    const logic = group.logic === 'any' ? 'any' : 'all';\n                                    const conditions = Array.isArray(group.conditions) ? group.conditions : [];\n                                    const connectorLabel = logic === 'any' ? 'OU' : 'ET';\n\n                                    return (\n                                      <div key={`${committee.id}-group-${groupIdx}`}>\n                                        {groupIdx > 0 && (\n                                          <div className=\"flex justify-center -mb-3\" aria-hidden=\"true\">\n                                            <span className=\"rounded-full bg-blue-600 px-3 py-1 text-xs font-bold text-white shadow\">\n                                              ET\n                                            </span>\n                                          </div>\n                                        )}\n\n                                        <div className=\"rounded-lg border border-blue-200 bg-gradient-to-r from-blue-50 to-blue-100 p-4\">\n                                          <div className=\"mb-4 flex flex-wrap items-center gap-3\">\n                                            <span className=\"text-sm font-semibold text-gray-700\">\n                                              Groupe {groupIdx + 1}\n                                            </span>\n                                            <div className=\"flex items-center gap-2 text-xs uppercase tracking-wide text-blue-800\">\n                                              <span className=\"font-semibold\">Logique interne</span>\n                                              <select\n                                                value={logic}\n                                                onChange={(event) =>\n                                                  updateCommitteeConditionGroupLogic(\n                                                    committee.id,\n                                                    groupIdx,\n                                                    event.target.value\n                                                  )\n                                                }\n                                                className=\"rounded-lg border border-blue-200 bg-white px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-500\"\n                                              >\n                                                <option value=\"all\">Toutes les conditions (ET)</option>\n                                                <option value=\"any\">Au moins une condition (OU)</option>\n                                              </select>\n                                            </div>\n                                            <button\n                                              type=\"button\"\n                                              onClick={() => deleteCommitteeConditionGroup(committee.id, groupIdx)}\n                                              className=\"ml-auto rounded p-2 text-red-600 hover:bg-red-50\"\n                                              aria-label={`Supprimer le groupe ${groupIdx + 1}`}\n                                            >\n                                              <Trash2 className=\"h-4 w-4\" />\n                                            </button>\n                                          </div>\n\n                                          {conditions.length === 0 ? (\n                                            <div className=\"rounded-lg border border-dashed border-blue-200 bg-white p-4 text-sm text-blue-700\">\n                                              <p>Ajoutez une condition pour dÃ©finir ce groupe.</p>\n                                              <button\n                                                type=\"button\"\n                                                onClick={() => addCommitteeCondition(committee.id, groupIdx)}\n                                                className=\"mt-3 inline-flex items-center gap-2 rounded-lg bg-blue-50 px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-100\"\n                                              >\n                                                <Plus className=\"h-4 w-4\" />\n                                                Ajouter une condition\n                                              </button>\n                                            </div>\n                                          ) : (\n                                            <div className=\"space-y-4\">\n                                              {conditions.map((condition, conditionIdx) => {\n                                                const conditionType = condition.type === 'timing' ? 'timing' : 'question';\n                                                const selectedQuestion = questions.find((item) => item.id === condition.question);\n                                                const selectedQuestionType = selectedQuestion?.type || 'choice';\n                                                const usesOptions = ['choice', 'multi_choice'].includes(selectedQuestionType);\n                                                const inputType = selectedQuestionType === 'number'\n                                                  ? 'number'\n                                                  : selectedQuestionType === 'date'\n                                                    ? 'date'\n                                                    : 'text';\n                                                const placeholder = selectedQuestionType === 'date'\n                                                  ? 'AAAA-MM-JJ'\n                                                  : selectedQuestionType === 'url'\n                                                    ? 'https://...'\n                                                    : 'Valeur (texte, date, etc.)';\n\n                                                return (\n                                                  <div\n                                                    key={`${committee.id}-condition-${groupIdx}-${conditionIdx}`}\n                                                    className=\"rounded-lg border border-blue-200 bg-white p-4 shadow-sm\"\n                                                  >\n                                                    <div className=\"mb-3 flex flex-wrap items-center gap-3\">\n                                                      {conditionIdx > 0 && (\n                                                        <span className=\"rounded-full bg-blue-600 px-3 py-1 text-xs font-bold text-white\">\n                                                          {connectorLabel}\n                                                        </span>\n                                                      )}\n                                                      <span className=\"text-sm font-semibold text-gray-700\">\n                                                        Condition {conditionIdx + 1}\n                                                      </span>\n                                                      <select\n                                                        value={conditionType}\n                                                        onChange={(event) =>\n                                                          handleCommitteeConditionTypeChange(\n                                                            committee.id,\n                                                            groupIdx,\n                                                            conditionIdx,\n                                                            event.target.value\n                                                          )\n                                                        }\n                                                        className=\"rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                      >\n                                                        <option value=\"question\">BasÃ©e sur une rÃ©ponse</option>\n                                                        <option value=\"timing\">Comparaison de dates</option>\n                                                      </select>\n                                                      <button\n                                                        type=\"button\"\n                                                        onClick={() =>\n                                                          deleteCommitteeCondition(committee.id, groupIdx, conditionIdx)\n                                                        }\n                                                        className=\"ml-auto rounded p-1 text-red-600 hover:bg-red-50\"\n                                                      >\n                                                        <Trash2 className=\"h-4 w-4\" />\n                                                      </button>\n                                                    </div>\n\n                                                    {conditionType === 'timing' ? (\n                                                      <div className=\"space-y-4\">\n                                                        {dateQuestions.length >= 2 ? (\n                                                          <>\n                                                            <div className=\"grid grid-cols-1 gap-3 md:grid-cols-2\">\n                                                              <div>\n                                                                <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                                  Date de dÃ©part\n                                                                </label>\n                                                                <select\n                                                                  value={condition.startQuestion}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'startQuestion',\n                                                                      event.target.value\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                >\n                                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                                  {dateQuestions.map((question) => (\n                                                                    <option key={question.id} value={question.id}>\n                                                                      {question.id} - {question.question ?? ''}\n                                                                    </option>\n                                                                  ))}\n                                                                </select>\n                                                              </div>\n\n                                                              <div>\n                                                                <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                                  Date d'arrivÃ©e\n                                                                </label>\n                                                                <select\n                                                                  value={condition.endQuestion}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'endQuestion',\n                                                                      event.target.value\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                >\n                                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                                  {dateQuestions.map((question) => (\n                                                                    <option key={question.id} value={question.id}>\n                                                                      {question.id} - {question.question ?? ''}\n                                                                    </option>\n                                                                  ))}\n                                                                </select>\n                                                              </div>\n                                                            </div>\n\n                                                            <div className=\"grid grid-cols-1 gap-3 md:grid-cols-2\">\n                                                              <div>\n                                                                <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                                  DurÃ©e minimale (semaines)\n                                                                </label>\n                                                                <input\n                                                                  type=\"number\"\n                                                                  min=\"0\"\n                                                                  value={condition.minimumWeeks ?? ''}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'minimumWeeks',\n                                                                      event.target.value === '' ? undefined : Number(event.target.value)\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                  placeholder=\"Ex: 8\"\n                                                                />\n                                                              </div>\n\n                                                              <div>\n                                                                <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                                  DurÃ©e maximale (semaines - optionnel)\n                                                                </label>\n                                                                <input\n                                                                  type=\"number\"\n                                                                  min=\"0\"\n                                                                  value={condition.maximumWeeks ?? ''}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'maximumWeeks',\n                                                                      event.target.value === '' ? undefined : Number(event.target.value)\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                  placeholder=\"Laisser vide si non concernÃ©\"\n                                                                />\n                                                              </div>\n                                                            </div>\n\n                                                            <p className=\"text-xs text-gray-500\">\n                                                              Le comitÃ© se dÃ©clenche si la durÃ©e entre les deux dates respecte les contraintes dÃ©finies.\n                                                            </p>\n                                                          </>\n                                                        ) : (\n                                                          <div className=\"rounded-lg border border-dashed border-blue-200 bg-white p-4 text-sm text-blue-700\">\n                                                            Ajoutez au moins deux questions de type date pour configurer cette condition temporelle.\n                                                          </div>\n                                                        )}\n                                                      </div>\n                                                    ) : (\n                                                      <div className=\"grid grid-cols-1 gap-3 md:grid-cols-3\">\n                                                        <div>\n                                                          <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                            Question\n                                                          </label>\n                                                          <select\n                                                            value={condition.question}\n                                                            onChange={(event) =>\n                                                              updateCommitteeConditionField(\n                                                                committee.id,\n                                                                groupIdx,\n                                                                conditionIdx,\n                                                                'question',\n                                                                event.target.value\n                                                              )\n                                                            }\n                                                            className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                          >\n                                                            <option value=\"\">SÃ©lectionner...</option>\n                                                            {questions.map((question) => (\n                                                              <option key={question.id} value={question.id}>\n                                                                {question.id} - {question.question ?? ''}\n                                                              </option>\n                                                            ))}\n                                                          </select>\n                                                        </div>\n\n                                                        <div>\n                                                          <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                            OpÃ©rateur\n                                                          </label>\n                                                          {(() => {\n                                                            const operatorOptions = getOperatorOptionsForType(selectedQuestionType);\n                                                            const operatorValue = ensureOperatorForType(\n                                                              selectedQuestionType,\n                                                              condition.operator\n                                                            );\n                                                            return (\n                                                              <select\n                                                                value={operatorValue}\n                                                                onChange={(event) =>\n                                                                  updateCommitteeConditionField(\n                                                                    committee.id,\n                                                                    groupIdx,\n                                                                    conditionIdx,\n                                                                    'operator',\n                                                                    event.target.value\n                                                                  )\n                                                                }\n                                                                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                              >\n                                                                {operatorOptions.map((option) => (\n                                                                  <option key={option.value} value={option.value}>\n                                                                    {option.label}\n                                                                  </option>\n                                                                ))}\n                                                              </select>\n                                                            );\n                                                          })()}\n                                                        </div>\n\n                                                        <div>\n                                                          <label className=\"mb-1 block text-xs font-medium text-gray-600\">\n                                                            Valeur\n                                                          </label>\n                                                          {(() => {\n                                                            if (!condition.question) {\n                                                              return (\n                                                                <input\n                                                                  type=\"text\"\n                                                                  value={condition.value}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'value',\n                                                                      event.target.value\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                  placeholder=\"Valeur (texte, date, etc.)\"\n                                                                />\n                                                              );\n                                                            }\n\n                                                            if (usesOptions) {\n                                                              return (\n                                                                <select\n                                                                  value={condition.value}\n                                                                  onChange={(event) =>\n                                                                    updateCommitteeConditionField(\n                                                                      committee.id,\n                                                                      groupIdx,\n                                                                      conditionIdx,\n                                                                      'value',\n                                                                      event.target.value\n                                                                    )\n                                                                  }\n                                                                  className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                >\n                                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                                  {(selectedQuestion?.options || []).map((option, optionIndex) => (\n                                                                    <option key={optionIndex} value={option}>\n                                                                      {option}\n                                                                    </option>\n                                                                  ))}\n                                                                </select>\n                                                              );\n                                                            }\n\n                                                            return (\n                                                              <input\n                                                                type={inputType}\n                                                                value={condition.value}\n                                                                onChange={(event) =>\n                                                                  updateCommitteeConditionField(\n                                                                    committee.id,\n                                                                    groupIdx,\n                                                                    conditionIdx,\n                                                                    'value',\n                                                                    event.target.value\n                                                                  )\n                                                                }\n                                                                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500\"\n                                                                placeholder={placeholder}\n                                                              />\n                                                            );\n                                                          })()}\n                                                        </div>\n                                                      </div>\n                                                    )}\n                                                  </div>\n                                                );\n                                              })}\n\n                                              <div className=\"flex justify-end border-t border-blue-100 pt-3\">\n                                                <button\n                                                  type=\"button\"\n                                                  onClick={() => addCommitteeCondition(committee.id, groupIdx)}\n                                                  className=\"inline-flex items-center gap-2 rounded-lg bg-blue-50 px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-100\"\n                                                >\n                                                  <Plus className=\"h-4 w-4\" />\n                                                  Ajouter une condition\n                                                </button>\n                                              </div>\n                                            </div>\n                                          )}\n                                        </div>\n                                      </div>\n                                    );\n                                  })}\n                                </div>\n                              </div>\n                            );\n                          })()}\n                        </div>\n\n                        <div className=\"grid grid-cols-1 gap-6 lg:grid-cols-2\">\n                          <div className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\n                            <div>\n                              <h4 className=\"text-base font-semibold text-gray-800\">RÃ¨gles dÃ©clenchantes</h4>\n                              <p className=\"text-xs text-gray-600\">\n                                DÃ©clenchez le comitÃ© en fonction des rÃ¨gles activÃ©es par le projet.\n                              </p>\n                            </div>\n                            <div>\n                              <label\n                                htmlFor={`validation-committee-rules-${committee.id}`}\n                                className=\"text-sm font-medium text-gray-700\"\n                              >\n                                RÃ¨gles ciblÃ©es\n                              </label>\n                              <select\n                                id={`validation-committee-rules-${committee.id}`}\n                                multiple\n                                value={committee.ruleTriggers.ruleIds}\n                                onChange={(event) => {\n                                  const selected = Array.from(event.target.selectedOptions).map((option) => option.value);\n                                  updateCommitteeEntry(committee.id, (prev) => ({\n                                    ...prev,\n                                    ruleTriggers: {\n                                      ...prev.ruleTriggers,\n                                      ruleIds: selected\n                                    }\n                                  }));\n                                }}\n                                className=\"mt-2 h-36 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                              >\n                                {validationCommitteeRuleOptions.length === 0 && (\n                                  <option value=\"\" disabled>\n                                    Aucune rÃ¨gle disponible.\n                                  </option>\n                                )}\n                                {validationCommitteeRuleOptions.map((option) => (\n                                  <option key={`validation-rule-${committee.id}-${option.value}`} value={option.value}>\n                                    {option.label}\n                                  </option>\n                                ))}\n                              </select>\n                              <p className=\"mt-2 text-xs text-gray-500\">\n                                Maintenez Ctrl/âŒ˜ pour sÃ©lectionner plusieurs rÃ¨gles.\n                              </p>\n                            </div>\n                            <p className=\"text-xs text-gray-500\">\n                              Le comitÃ© se dÃ©clenche dÃ¨s quâ€™une rÃ¨gle sÃ©lectionnÃ©e est activÃ©e.\n                            </p>\n                          </div>\n\n                          <div className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\n                            <div>\n                              <h4 className=\"text-base font-semibold text-gray-800\">Risques identifiÃ©s</h4>\n                              <p className=\"text-xs text-gray-600\">\n                                Reliez lâ€™obligation Ã  lâ€™analyse des risques et au score du projet.\n                              </p>\n                            </div>\n                            <div>\n                              <label\n                                htmlFor={`validation-committee-risk-score-${committee.id}`}\n                                className=\"text-sm font-medium text-gray-700\"\n                              >\n                                Score de risque minimal\n                              </label>\n                              <input\n                                id={`validation-committee-risk-score-${committee.id}`}\n                                type=\"number\"\n                                min=\"0\"\n                                step=\"0.5\"\n                                value={committee.riskTriggers.minRiskScore ?? ''}\n                                onChange={(event) => {\n                                  const value = event.target.value;\n                                  updateCommitteeEntry(committee.id, (prev) => ({\n                                    ...prev,\n                                    riskTriggers: {\n                                      ...prev.riskTriggers,\n                                      minRiskScore: value === '' ? null : Number(value)\n                                    }\n                                  }));\n                                }}\n                                className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Ex. 3,5\"\n                              />\n                            </div>\n                          </div>\n\n                          <div className=\"space-y-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\n                            <div>\n                              <h4 className=\"text-base font-semibold text-gray-800\">Ã‰quipes sollicitÃ©es</h4>\n                              <p className=\"text-xs text-gray-600\">\n                                DÃ©clenchez ce comitÃ© en fonction du nombre dâ€™Ã©quipes compliance impliquÃ©es.\n                              </p>\n                            </div>\n                            <div>\n                              <label\n                                htmlFor={`validation-committee-team-count-${committee.id}`}\n                                className=\"text-sm font-medium text-gray-700\"\n                              >\n                                Nombre minimal dâ€™Ã©quipes\n                              </label>\n                              <input\n                                id={`validation-committee-team-count-${committee.id}`}\n                                type=\"number\"\n                                min=\"1\"\n                                value={committee.teamTriggers.minTeamsCount ?? ''}\n                                onChange={(event) => {\n                                  const value = event.target.value;\n                                  updateCommitteeEntry(committee.id, (prev) => ({\n                                    ...prev,\n                                    teamTriggers: {\n                                      ...prev.teamTriggers,\n                                      minTeamsCount: value === '' ? null : Number(value)\n                                    }\n                                  }));\n                                }}\n                                className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Ex. 3\"\n                              />\n                            </div>\n                          </div>\n                        </div>\n                      </article>\n                    ))}\n                  </div>\n                )}\n              </article>\n            </section>\n          )}\n\n          {activeTab === 'administrators' && (\n            <section\n              id=\"backoffice-tabpanel-administrators\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-administrators\"\n              className=\"space-y-4\"\n            >\n              <div className=\"flex flex-col gap-2\">\n                <h2 className=\"text-2xl font-bold text-gray-800\">Administrateurs</h2>\n                <p className=\"text-sm text-gray-600\">\n                  Ajoutez les adresses e-mail autorisÃ©es Ã  accÃ©der au back-office sans mot de passe.\n                </p>\n              </div>\n\n              <div className=\"bg-white border border-gray-200 rounded-xl p-6 shadow-sm hv-surface space-y-4\">\n                <div>\n                  <label htmlFor=\"admin-emails\" className=\"text-sm font-medium text-gray-700\">\n                    Adresses e-mail des administrateurs\n                  </label>\n                  <textarea\n                    id=\"admin-emails\"\n                    rows={4}\n                    value={normalizedAdminEmails.join('\\n')}\n                    onChange={(event) => {\n                      const nextEmails = parseEmailList(event.target.value);\n                      if (typeof setAdminEmails === 'function') {\n                        setAdminEmails(nextEmails);\n                      }\n                    }}\n                    className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                    placeholder=\"admin1@entreprise.com\\nadmin2@entreprise.com\"\n                  />\n                  <p className=\"mt-2 text-xs text-gray-500\">\n                    SÃ©parez chaque adresse par une virgule, un point-virgule ou un retour Ã  la ligne.\n                  </p>\n                </div>\n\n                {normalizedAdminEmails.length > 0 ? (\n                  <div className=\"space-y-2\">\n                    <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                      Administrateurs enregistrÃ©s ({normalizedAdminEmails.length})\n                    </p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {normalizedAdminEmails.map((email) => (\n                        <span\n                          key={email}\n                          className=\"px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-xs font-medium\"\n                        >\n                          {email}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                ) : (\n                  <p className=\"text-sm text-gray-500\">\n                    Aucune adresse administrateur n'est encore enregistrÃ©e.\n                  </p>\n                )}\n              </div>\n            </section>\n          )}\n\n          {activeTab === 'riskLevels' && (\n            <section\n              id=\"backoffice-tabpanel-risk-levels\"\n              role=\"tabpanel\"\n              aria-labelledby=\"backoffice-tab-riskLevels\"\n              className=\"space-y-4\"\n            >\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Niveaux de risque</h2>\n                  <p className=\"text-sm text-gray-600\">\n                    Ajustez les seuils utilisÃ©s pour calculer la complexitÃ© compliance affichÃ©e aux Ã©quipes.\n                  </p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addRiskLevelRule}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter un niveau\n                </button>\n              </div>\n\n              <div className=\"bg-blue-50 border border-blue-100 rounded-xl p-4 text-sm text-blue-900 space-y-2\">\n                <p className=\"flex items-start gap-2\">\n                  <Info className=\"w-5 h-5 mt-0.5\" />\n                  <span>\n                    Les niveaux sont Ã©valuÃ©s du haut vers le bas : le premier palier correspondant au score de risque total sâ€™applique.\n                  </span>\n                </p>\n                <p className=\"text-xs text-blue-700\">\n                  Le score de risque additionne le poids de chaque risque selon sa criticitÃ©. Laissez la borne maximale vide pour couvrir toutes les valeurs supÃ©rieures Ã  la borne minimale.\n                </p>\n              </div>\n\n              <div className=\"bg-white border border-gray-200 rounded-xl p-6 shadow-sm hv-surface space-y-4\">\n                <div>\n                  <h3 className=\"text-lg font-semibold text-gray-800\">PondÃ©ration des criticitÃ©s</h3>\n                  <p className=\"text-sm text-gray-600\">\n                    Ajustez la valeur attribuÃ©e Ã  chaque niveau de criticitÃ© pour recalculer le score de risque des projets.\n                  </p>\n                </div>\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-3\">\n                  {RISK_WEIGHT_FIELDS.map((field) => (\n                    <div key={field.key} className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\">\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\" htmlFor={`risk-weight-${field.key}`}>\n                        {field.label}\n                      </label>\n                      <input\n                        id={`risk-weight-${field.key}`}\n                        type=\"number\"\n                        min=\"0\"\n                        step=\"0.5\"\n                        value={normalizedRiskWeights[field.key] ?? 0}\n                        onChange={(event) => handleRiskWeightChange(field.key, event.target.value)}\n                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                      />\n                      <p className=\"mt-2 text-xs text-gray-500\">{field.description}</p>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {riskLevelRuleCount === 0 ? (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucun niveau de risque n'est configurÃ©.\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {safeRiskLevelRules.map((rule, index) => {\n                    const ruleId = rule?.id || `risk-level-${index + 1}`;\n                    const labelInputId = `${ruleId}-label`;\n                    const minInputId = `${ruleId}-min`;\n                    const maxInputId = `${ruleId}-max`;\n                    const descriptionId = `${ruleId}-description`;\n                    const rangeLabel = formatRiskRangeLabel(rule);\n                    const issues = getRiskLevelRuleIssues(rule, index, safeRiskLevelRules);\n                    const disableDelete = riskLevelRuleCount <= 1;\n                    const minValue = getRuleMinScoreValue(rule);\n                    const maxScoreValue = getRuleMaxScoreValue(rule);\n                    const maxValue = maxScoreValue === null ? '' : maxScoreValue;\n\n                    return (\n                      <article key={ruleId} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\">\n                        <div className=\"flex flex-col gap-4 md:flex-row md:items-start md:justify-between\">\n                          <div className=\"space-y-3 flex-1\">\n                            <div className=\"flex flex-wrap items-center gap-2 text-xs text-gray-500\">\n                              <span className=\"px-2 py-1 bg-blue-50 text-blue-700 rounded-full font-semibold\">{ruleId}</span>\n                              <span className=\"px-2 py-1 bg-gray-100 text-gray-700 rounded-full\">{rangeLabel}</span>\n                              <span className=\"px-2 py-1 bg-gray-100 text-gray-700 rounded-full\">Palier {index + 1}</span>\n                            </div>\n                            <div>\n                              <label\n                                className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                                htmlFor={labelInputId}\n                              >\n                                IntitulÃ© du niveau\n                              </label>\n                              <input\n                                id={labelInputId}\n                                type=\"text\"\n                                value={rule?.label || ''}\n                                onChange={(event) => updateRiskLevelRuleField(index, 'label', event.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                              />\n                            </div>\n                          </div>\n                          <div className=\"flex items-start gap-2 self-stretch md:self-start\">\n                            <div className=\"flex flex-col gap-2\" role=\"group\" aria-label={`RÃ©ordonner le niveau ${rule?.label || index + 1}`}>\n                              <button\n                                type=\"button\"\n                                onClick={() => moveRiskLevelRule(index, index - 1)}\n                                disabled={index === 0}\n                                className=\"p-2 text-gray-600 bg-white border border-gray-200 rounded hover:bg-gray-100 hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                                aria-label={`Monter le niveau ${rule?.label || ruleId}`}\n                              >\n                                <ArrowUp className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                type=\"button\"\n                                onClick={() => moveRiskLevelRule(index, index + 1)}\n                                disabled={index === riskLevelRuleCount - 1}\n                                className=\"p-2 text-gray-600 bg-white border border-gray-200 rounded hover:bg-gray-100 hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                                aria-label={`Descendre le niveau ${rule?.label || ruleId}`}\n                              >\n                                <ArrowDown className=\"w-4 h-4\" />\n                              </button>\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteRiskLevelRule(ruleId, index)}\n                              disabled={disableDelete}\n                              className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button disabled:opacity-40 disabled:cursor-not-allowed\"\n                              aria-label={`Supprimer le niveau ${rule?.label || ruleId}`}\n                            >\n                              <Trash2 className=\"w-5 h-5\" />\n                            </button>\n                          </div>\n                        </div>\n\n                        <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-4\">\n                          <div>\n                            <label\n                              className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                              htmlFor={minInputId}\n                            >\n                              Score minimal\n                            </label>\n                            <input\n                              id={minInputId}\n                              type=\"number\"\n                              min=\"0\"\n                              step=\"0.5\"\n                              value={minValue}\n                              onChange={(event) => updateRiskLevelRuleField(index, 'minScore', event.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                            />\n                          </div>\n                          <div>\n                            <label\n                              className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                              htmlFor={maxInputId}\n                            >\n                              Score maximal (optionnel)\n                            </label>\n                            <input\n                              id={maxInputId}\n                              type=\"number\"\n                              min=\"0\"\n                              step=\"0.5\"\n                              placeholder=\"IllimitÃ©e\"\n                              value={maxValue}\n                              onChange={(event) => updateRiskLevelRuleField(index, 'maxScore', event.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm hv-focus-ring\"\n                            />\n                            <p className=\"mt-1 text-xs text-gray-500\">\n                              Laisser vide pour couvrir tous les scores au-delÃ  du minimum.\n                            </p>\n                          </div>\n                          <div>\n                            <span className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\">\n                              RÃ©sumÃ© automatique\n                            </span>\n                            <div className=\"px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm text-gray-700\">\n                              {rangeLabel}\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className=\"mt-4\">\n                          <label\n                            className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\"\n                            htmlFor={descriptionId}\n                          >\n                            Message de contexte\n                          </label>\n                          <textarea\n                            id={descriptionId}\n                            rows={3}\n                            value={rule?.description || ''}\n                            onChange={(event) => updateRiskLevelRuleField(index, 'description', event.target.value)}\n                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y hv-focus-ring\"\n                          />\n                        </div>\n\n                        {issues.length > 0 && (\n                          <div className=\"mt-4 bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-700 space-y-1\">\n                            {issues.map((issue, issueIndex) => (\n                              <p key={`${ruleId}-issue-${issueIndex}`}>â€¢ {issue}</p>\n                            ))}\n                          </div>\n                        )}\n                      </article>\n                    );\n                  })}\n                </div>\n              )}\n            </section>\n          )}\n\n          {activeTab === 'teams' && (\n            <section id=\"backoffice-tabpanel-teams\" role=\"tabpanel\" aria-labelledby=\"backoffice-tab-teams\" className=\"space-y-4\">\n              <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-gray-800\">Gestion des Ã©quipes</h2>\n                  <p className=\"text-sm text-gray-600\">DÃ©finissez les Ã©quipes contactÃ©es selon les scÃ©narios identifiÃ©s.</p>\n                </div>\n                <button\n                  type=\"button\"\n                  onClick={addTeam}\n                  className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                >\n                  <Plus className=\"w-5 h-5 mr-2\" />\n                  Ajouter une Ã©quipe\n                </button>\n              </div>\n\n              {teams.length === 0 && (\n                <div className=\"border border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500\">\n                  Aucune Ã©quipe renseignÃ©e.\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {teams.map((team, index) => (\n                  <article key={team.id} className=\"border border-gray-200 rounded-xl p-6 bg-white shadow-sm hv-surface\" aria-label={`Ã‰quipe ${team.name}`}>\n                    <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between mb-4\">\n                      <input\n                        type=\"text\"\n                        value={team.name}\n                        onChange={(event) => updateTeamField(index, 'name', event.target.value)}\n                        className=\"text-lg font-semibold text-gray-800 border-b border-transparent focus:border-blue-600 focus:outline-none flex-1 hv-focus-ring\"\n                        aria-label={`Nom de l'Ã©quipe ${team.id}`}\n                      />\n                      <div className=\"flex justify-end sm:justify-start\">\n                        <button\n                          type=\"button\"\n                          onClick={() => deleteTeam(team.id)}\n                          className=\"p-2 text-red-600 hover:bg-red-50 rounded hv-button\"\n                          aria-label={`Supprimer l'Ã©quipe ${team.name}`}\n                        >\n                          <Trash2 className=\"w-5 h-5\" />\n                        </button>\n                      </div>\n                    </div>\n\n                    <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\" htmlFor={`${team.id}-contact`}>\n                      Contacts e-mail\n                    </label>\n                    <textarea\n                      id={`${team.id}-contact`}\n                      value={formatTeamContacts(team, ', ')}\n                      onChange={(event) =>\n                        updateTeamField(index, 'contacts', parseTeamContacts(event.target.value))\n                      }\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2 hv-focus-ring\"\n                      rows={2}\n                      placeholder=\"ex : contact@company.com, support@company.com\"\n                    />\n                    <p className=\"text-xs text-gray-500 mb-4\">\n                      SÃ©parez plusieurs adresses par une virgule, un point-virgule ou un retour Ã  la ligne.\n                    </p>\n\n                    <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1\" htmlFor={`${team.id}-expertise`}>\n                      Domaine d'expertise\n                    </label>\n                    <textarea\n                      id={`${team.id}-expertise`}\n                      value={team.expertise}\n                      onChange={(event) => updateTeamField(index, 'expertise', event.target.value)}\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y hv-focus-ring\"\n                      rows={3}\n                    />\n                  </article>\n                ))}\n              </div>\n            </section>\n          )}\n        </div>\n\n        {editingQuestion && (\n          <QuestionEditor\n            question={editingQuestion}\n            onSave={saveQuestion}\n            onCancel={() => setEditingQuestion(null)}\n            allQuestions={questions}\n          />\n        )}\n\n        {editingRule && (\n          <RuleEditor\n            rule={editingRule}\n            onSave={saveRule}\n            onCancel={() => setEditingRule(null)}\n            questions={questions}\n            teams={teams}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n",
  "src/components/BackOfficeDashboard.jsx": "import React, { useMemo, useState } from '../react.js';\n\nconst TIME_FILTER_OPTIONS = [\n  {\n    id: 'all',\n    label: 'Toute la pÃ©riode',\n    computeRange: () => null\n  },\n  {\n    id: '30d',\n    label: '30 derniers jours',\n    computeRange: () => {\n      const end = endOfDay(new Date());\n      const start = startOfDay(addDays(end, -29));\n      return { start, end };\n    }\n  },\n  {\n    id: '90d',\n    label: '90 derniers jours',\n    computeRange: () => {\n      const end = endOfDay(new Date());\n      const start = startOfDay(addDays(end, -89));\n      return { start, end };\n    }\n  },\n  {\n    id: '12m',\n    label: '12 derniers mois',\n    computeRange: () => {\n      const end = endOfDay(new Date());\n      const start = startOfDay(addMonths(end, -11));\n      return { start, end };\n    }\n  },\n  {\n    id: 'custom',\n    label: 'Plage personnalisÃ©e',\n    computeRange: () => null\n  }\n];\n\nconst COLORBLIND_SAFE_PALETTE = [\n  {\n    color: '#0072B2',\n    pattern:\n      'repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.35) 0, rgba(255, 255, 255, 0.35) 8px, transparent 8px, transparent 16px)',\n    backgroundSize: '16px 16px'\n  },\n  {\n    color: '#D55E00',\n    pattern:\n      'repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.35) 0, rgba(255, 255, 255, 0.35) 8px, transparent 8px, transparent 16px)',\n    backgroundSize: '16px 16px'\n  },\n  {\n    color: '#009E73',\n    pattern:\n      'repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.35) 0, rgba(255, 255, 255, 0.35) 6px, transparent 6px, transparent 12px)',\n    backgroundSize: '12px 12px'\n  },\n  {\n    color: '#CC79A7',\n    pattern:\n      'repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.35) 0, rgba(255, 255, 255, 0.35) 10px, transparent 10px, transparent 20px)',\n    backgroundSize: '20px 20px'\n  },\n  {\n    color: '#56B4E9',\n    pattern:\n      'repeating-linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0, rgba(255, 255, 255, 0.3) 6px, transparent 6px, transparent 12px)',\n    backgroundSize: '12px 12px'\n  },\n  {\n    color: '#E69F00',\n    pattern:\n      'repeating-linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0, rgba(255, 255, 255, 0.3) 12px, transparent 12px, transparent 24px)',\n    backgroundSize: '24px 24px'\n  },\n  {\n    color: '#F0E442',\n    pattern:\n      'repeating-linear-gradient(225deg, rgba(17, 24, 39, 0.2) 0, rgba(17, 24, 39, 0.2) 6px, transparent 6px, transparent 12px)',\n    backgroundSize: '12px 12px'\n  },\n  {\n    color: '#000000',\n    pattern:\n      'repeating-linear-gradient(315deg, rgba(255, 255, 255, 0.35) 0, rgba(255, 255, 255, 0.35) 4px, transparent 4px, transparent 8px)',\n    backgroundSize: '8px 8px'\n  }\n];\n\nconst getPaletteEntry = (index, palette = COLORBLIND_SAFE_PALETTE) => {\n  const source = Array.isArray(palette) && palette.length > 0 ? palette : COLORBLIND_SAFE_PALETTE;\n  return source[index % source.length];\n};\n\nconst resolveColor = (entry) => {\n  if (typeof entry === 'string') {\n    return entry;\n  }\n  return entry?.color || '#4B5563';\n};\n\nconst buildPatternStyle = (input, palette = COLORBLIND_SAFE_PALETTE) => {\n  const entry =\n    typeof input === 'number' || typeof input === 'bigint'\n      ? getPaletteEntry(Number(input), palette)\n      : input;\n\n  if (typeof entry === 'string') {\n    return {\n      backgroundColor: entry,\n      border: '1px solid rgba(17, 24, 39, 0.15)'\n    };\n  }\n\n  return {\n    backgroundColor: entry.color,\n    backgroundImage: entry.pattern,\n    backgroundSize: entry.backgroundSize,\n    backgroundBlendMode: entry.backgroundBlendMode || 'multiply',\n    border: entry.border || '1px solid rgba(17, 24, 39, 0.15)'\n  };\n};\n\nconst numberFormatter = new Intl.NumberFormat('fr-FR');\nconst decimalFormatter = new Intl.NumberFormat('fr-FR', {\n  maximumFractionDigits: 1,\n  minimumFractionDigits: 0\n});\n\nconst averageFormatter = new Intl.NumberFormat('fr-FR', {\n  maximumFractionDigits: 2,\n  minimumFractionDigits: 0\n});\n\nconst formatDays = (value) => {\n  if (!Number.isFinite(value)) {\n    return 'â€”';\n  }\n  return `${decimalFormatter.format(value)} jour${Math.abs(value - 1) < 0.001 ? '' : 's'}`;\n};\n\nconst startOfDay = (date) => {\n  const clone = new Date(date.getTime());\n  clone.setHours(0, 0, 0, 0);\n  return clone;\n};\n\nconst endOfDay = (date) => {\n  const clone = new Date(date.getTime());\n  clone.setHours(23, 59, 59, 999);\n  return clone;\n};\n\nconst addDays = (referenceDate, amount) => {\n  const clone = new Date(referenceDate.getTime());\n  clone.setDate(clone.getDate() + amount);\n  return clone;\n};\n\nconst addMonths = (referenceDate, amount) => {\n  const clone = new Date(referenceDate.getTime());\n  clone.setMonth(clone.getMonth() + amount);\n  return clone;\n};\n\nconst parseDate = (value) => {\n  if (!value) {\n    return null;\n  }\n\n  const parsed = new Date(value);\n  if (Number.isNaN(parsed.getTime())) {\n    return null;\n  }\n\n  return parsed;\n};\n\nconst getProjectGeneratedAt = (project) => {\n  const candidates = [\n    project?.generatedAt,\n    project?.metadata?.generatedAt,\n    project?.submittedAt,\n    project?.lastUpdated\n  ];\n\n  for (const candidate of candidates) {\n    const parsed = parseDate(candidate);\n    if (parsed) {\n      return parsed;\n    }\n  }\n\n  return null;\n};\n\nconst getLeadTeamsFromProject = (project) => {\n  const rawValue = project?.answers?.teamLeadTeam;\n\n  if (Array.isArray(rawValue)) {\n    return rawValue\n      .map((entry) => (typeof entry === 'string' ? entry.trim() : ''))\n      .filter((entry) => entry.length > 0);\n  }\n\n  if (typeof rawValue === 'string' && rawValue.trim().length > 0) {\n    return [rawValue.trim()];\n  }\n\n  return [];\n};\n\nconst getLaunchDate = (project) => {\n  const answers = project?.answers || {};\n  return parseDate(answers.launchDate || answers.projectLaunchDate);\n};\n\nconst PieChart = ({ data, colors = COLORBLIND_SAFE_PALETTE, size = 180, strokeWidth = 26, title }) => {\n  const total = data.reduce((sum, item) => sum + Math.max(item.value, 0), 0);\n\n  if (total <= 0) {\n    return (\n      <div className=\"flex h-full flex-col items-center justify-center gap-2 py-6 text-center text-sm text-gray-500\">\n        <span role=\"img\" aria-label=\"Aucune donnÃ©e\">ðŸ“Š</span>\n        <p>Aucune donnÃ©e exploitable pour ce graphique.</p>\n      </div>\n    );\n  }\n\n  const radius = (size - strokeWidth) / 2;\n  const circumference = 2 * Math.PI * radius;\n  const segments = [];\n  let cumulative = 0;\n\n  data.forEach((item, index) => {\n    const value = Math.max(item.value, 0);\n    if (value <= 0) {\n      return;\n    }\n\n    const segmentLength = (value / total) * circumference;\n    const percentage = (value / total) * 100;\n    const paletteEntry = getPaletteEntry(segments.length, colors);\n    const midAngle = ((cumulative + segmentLength / 2) / circumference) * 2 * Math.PI - Math.PI / 2;\n\n    segments.push({\n      key: item.id || item.label || index,\n      item,\n      value,\n      percentage,\n      segmentLength,\n      startOffset: cumulative,\n      paletteEntry,\n      midAngle,\n      displayIndex: segments.length\n    });\n\n    cumulative += segmentLength;\n  });\n\n  const labelRadius = Math.max(radius - strokeWidth / 2 - 8, radius * 0.45);\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <svg\n        width={size}\n        height={size}\n        viewBox={`0 0 ${size} ${size}`}\n        role=\"img\"\n        aria-label={title || 'RÃ©partition'}\n      >\n        <g transform={`translate(${size / 2} ${size / 2}) rotate(-90)`}>\n          <circle\n            r={radius}\n            fill=\"transparent\"\n            stroke=\"#E5E7EB\"\n            strokeWidth={strokeWidth}\n          />\n          {segments.map((segment) => {\n            const dashArray = `${segment.segmentLength} ${circumference}`;\n            const color = resolveColor(segment.paletteEntry);\n            return (\n              <g key={`segment-${segment.key}`}>\n                <circle\n                  r={radius}\n                  fill=\"transparent\"\n                  stroke={color}\n                  strokeWidth={strokeWidth}\n                  strokeDasharray={dashArray}\n                  strokeDashoffset={-segment.startOffset}\n                  strokeLinecap=\"butt\"\n                >\n                  <title>\n                    {`${segment.item.label} : ${numberFormatter.format(segment.value)} (${decimalFormatter.format(segment.percentage)}%)`}\n                  </title>\n                </circle>\n              </g>\n            );\n          })}\n          {segments.map((segment) => {\n            const angle = segment.midAngle;\n            const x = Math.cos(angle) * labelRadius;\n            const y = Math.sin(angle) * labelRadius;\n            return (\n              <text\n                key={`label-${segment.key}`}\n                x={x}\n                y={y}\n                textAnchor=\"middle\"\n                dominantBaseline=\"middle\"\n                fill=\"#111827\"\n                fontSize={12}\n                fontWeight={700}\n                stroke=\"#ffffff\"\n                strokeWidth={3}\n                style={{ paintOrder: 'stroke fill' }}\n                aria-hidden=\"true\"\n              >\n                {segment.displayIndex + 1}\n              </text>\n            );\n          })}\n        </g>\n      </svg>\n      <div className=\"grid w-full gap-2 text-sm\">\n        {segments.map((segment) => (\n          <div\n            key={`legend-${segment.key}`}\n            className=\"flex items-center justify-between rounded-lg border border-gray-100 bg-white/70 px-3 py-2\"\n          >\n            <div className=\"flex items-center gap-3\">\n              <span className=\"flex h-6 w-6 items-center justify-center rounded-full bg-gray-100 text-xs font-semibold text-gray-700\">\n                {segment.displayIndex + 1}\n              </span>\n              <span\n                className=\"h-3 w-10 rounded-full\"\n                style={buildPatternStyle(segment.paletteEntry, colors)}\n                aria-hidden=\"true\"\n              />\n              <span className=\"font-medium text-gray-700\">{segment.item.label}</span>\n            </div>\n            <span className=\"text-sm font-semibold text-gray-900\">\n              {numberFormatter.format(segment.value)} Â· {decimalFormatter.format(segment.percentage)}%\n            </span>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nconst BarChart = ({\n  data,\n  valueFormatter = (value) => numberFormatter.format(value),\n  unitSuffix = '',\n  colors = COLORBLIND_SAFE_PALETTE,\n  emptyLabel = 'Aucune donnÃ©e Ã  afficher'\n}) => {\n  const cleanedData = data.filter((entry) => Number.isFinite(entry.value) && entry.value > 0);\n  const maxValue = cleanedData.reduce((max, entry) => Math.max(max, entry.value), 0);\n\n  if (cleanedData.length === 0 || maxValue <= 0) {\n    return (\n      <div className=\"flex h-full flex-col items-center justify-center gap-2 py-6 text-center text-sm text-gray-500\">\n        <span role=\"img\" aria-label=\"Aucune donnÃ©e\">ðŸ“‰</span>\n        <p>{emptyLabel}</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {cleanedData.map((entry, index) => {\n        const percentage = Math.max((entry.value / maxValue) * 100, 4);\n        const barStyle = {\n          width: `${percentage}%`,\n          ...buildPatternStyle(index, colors),\n          borderRadius: '9999px'\n        };\n        return (\n          <div key={entry.id || entry.label || index} className=\"space-y-1\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"font-medium text-gray-700\">{entry.label}</span>\n              <span className=\"font-semibold text-gray-900\">\n                {valueFormatter(entry.value)}{unitSuffix}\n              </span>\n            </div>\n            <div className=\"h-3 rounded-full bg-gray-100\">\n              <div\n                className=\"h-full rounded-full transition-all duration-500\"\n                style={barStyle}\n                aria-hidden=\"true\"\n              />\n            </div>\n          </div>\n        );\n      })}\n    </div>\n  );\n};\n\nconst buildTeamOptions = (projects = []) => {\n  const counts = new Map();\n  projects.forEach((project) => {\n    const teams = getLeadTeamsFromProject(project);\n    if (teams.length === 0) {\n      counts.set('not_set', (counts.get('not_set') || 0) + 1);\n      return;\n    }\n    teams.forEach((team) => {\n      counts.set(team, (counts.get(team) || 0) + 1);\n    });\n  });\n\n  if (!counts.has('not_set')) {\n    counts.set('not_set', 0);\n  }\n\n  const entries = Array.from(counts.entries()).map(([id, count]) => ({\n    id,\n    label: id === 'not_set' ? 'Ã‰quipe non renseignÃ©e' : id,\n    count\n  }));\n\n  entries.sort((a, b) => b.count - a.count || a.label.localeCompare(b.label));\n  return entries;\n};\n\nconst formatDateRangeSummary = (range, fallbackLabel) => {\n  if (!range) {\n    return fallbackLabel;\n  }\n\n  const formatter = new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium' });\n  return `${formatter.format(range.start)} â€“ ${formatter.format(range.end)}`;\n};\n\nexport const BackOfficeDashboard = ({ projects = [], teams = [] }) => {\n  const [selectedLeadTeam, setSelectedLeadTeam] = useState('all');\n  const [selectedTimeFilter, setSelectedTimeFilter] = useState('all');\n  const [customStart, setCustomStart] = useState('');\n  const [customEnd, setCustomEnd] = useState('');\n\n  const sanitizedProjects = useMemo(\n    () => (Array.isArray(projects) ? projects.filter((project) => !(project && project.isDemo)) : []),\n    [projects]\n  );\n\n  const teamOptions = useMemo(() => buildTeamOptions(sanitizedProjects), [sanitizedProjects]);\n  const timeOption = useMemo(\n    () => TIME_FILTER_OPTIONS.find((option) => option.id === selectedTimeFilter) || TIME_FILTER_OPTIONS[0],\n    [selectedTimeFilter]\n  );\n\n  const computedRange = useMemo(() => {\n    if (timeOption.id === 'custom') {\n      const start = customStart ? startOfDay(new Date(customStart)) : null;\n      const end = customEnd ? endOfDay(new Date(customEnd)) : null;\n\n      if (start && end && start > end) {\n        return null;\n      }\n\n      if (!start && !end) {\n        return null;\n      }\n\n      return {\n        start: start || startOfDay(addDays(end || new Date(), -29)),\n        end: end || endOfDay(new Date())\n      };\n    }\n\n    return timeOption.computeRange ? timeOption.computeRange() : null;\n  }, [timeOption, customStart, customEnd]);\n\n  const filteredProjects = useMemo(() => {\n    const list = sanitizedProjects;\n\n    return list.filter((project) => {\n      if (!project) {\n        return false;\n      }\n\n      if (selectedLeadTeam !== 'all') {\n        const teamsForProject = getLeadTeamsFromProject(project);\n        const target = selectedLeadTeam === 'not_set' ? teamsForProject.length === 0 : teamsForProject.includes(selectedLeadTeam);\n        if (!target) {\n          return false;\n        }\n      }\n\n      if (computedRange) {\n        const generatedAt = getProjectGeneratedAt(project);\n        if (!generatedAt) {\n          return false;\n        }\n\n        if (generatedAt < computedRange.start || generatedAt > computedRange.end) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n  }, [sanitizedProjects, selectedLeadTeam, computedRange]);\n\n  const leadTeamDistribution = useMemo(() => {\n    const counts = new Map();\n    filteredProjects.forEach((project) => {\n      const teamsForProject = getLeadTeamsFromProject(project);\n      if (teamsForProject.length === 0) {\n        counts.set('Ã‰quipe non renseignÃ©e', (counts.get('Ã‰quipe non renseignÃ©e') || 0) + 1);\n        return;\n      }\n      teamsForProject.forEach((team) => {\n        counts.set(team, (counts.get(team) || 0) + 1);\n      });\n    });\n\n    const entries = Array.from(counts.entries()).map(([label, value]) => ({ label, value }));\n    entries.sort((a, b) => b.value - a.value || a.label.localeCompare(b.label));\n\n    return {\n      total: entries.reduce((sum, entry) => sum + entry.value, 0),\n      entries\n    };\n  }, [filteredProjects]);\n\n  const averageDelay = useMemo(() => {\n    let totalDays = 0;\n    let count = 0;\n\n    filteredProjects.forEach((project) => {\n      const submissionDate = getProjectGeneratedAt(project) || parseDate(project?.submittedAt);\n      const launchDate = getLaunchDate(project);\n\n      if (!submissionDate || !launchDate) {\n        return;\n      }\n\n      const diffInMs = launchDate.getTime() - submissionDate.getTime();\n      const diffInDays = diffInMs / (1000 * 60 * 60 * 24);\n\n      if (!Number.isFinite(diffInDays)) {\n        return;\n      }\n\n      const sanitized = Math.max(diffInDays, 0);\n      totalDays += sanitized;\n      count += 1;\n    });\n\n    return {\n      average: count > 0 ? totalDays / count : 0,\n      count\n    };\n  }, [filteredProjects]);\n\n  const riskSeverityAverages = useMemo(() => {\n    const totals = new Map();\n\n    filteredProjects.forEach((project) => {\n      const risks = Array.isArray(project?.analysis?.risks) ? project.analysis.risks : [];\n      if (risks.length === 0) {\n        return;\n      }\n      risks.forEach((risk) => {\n        const rawLevel = typeof risk?.level === 'string' && risk.level.trim().length > 0 ? risk.level.trim() : 'Non classÃ©';\n        const normalizedLevel = rawLevel.charAt(0).toUpperCase() + rawLevel.slice(1);\n        totals.set(normalizedLevel, (totals.get(normalizedLevel) || 0) + 1);\n      });\n    });\n\n    const entries = Array.from(totals.entries()).map(([label, totalRisks]) => ({\n      id: label,\n      label,\n      totalRisks,\n      value: filteredProjects.length > 0 ? totalRisks / filteredProjects.length : 0\n    }));\n\n    entries.sort((a, b) => b.value - a.value || a.label.localeCompare(b.label));\n\n    return {\n      entries\n    };\n  }, [filteredProjects]);\n\n  const riskLevelDistribution = useMemo(() => {\n    const counts = new Map();\n    filteredProjects.forEach((project) => {\n      const complexity = typeof project?.analysis?.complexity === 'string' && project.analysis.complexity.trim().length > 0\n        ? project.analysis.complexity.trim()\n        : 'Non Ã©valuÃ©';\n      counts.set(complexity, (counts.get(complexity) || 0) + 1);\n    });\n\n    const entries = Array.from(counts.entries()).map(([label, value]) => ({ label, value }));\n    entries.sort((a, b) => b.value - a.value || a.label.localeCompare(b.label));\n\n    return {\n      total: entries.reduce((sum, entry) => sum + entry.value, 0),\n      entries\n    };\n  }, [filteredProjects]);\n\n  const solicitationsByTeam = useMemo(() => {\n    const counts = new Map();\n    const teamNames = new Map(\n      Array.isArray(teams)\n        ? teams.map((team) => [team.id, team.name || team.id])\n        : []\n    );\n\n    filteredProjects.forEach((project) => {\n      const collected = new Set();\n      const risks = Array.isArray(project?.analysis?.risks) ? project.analysis.risks : [];\n      risks.forEach((risk) => {\n        if (typeof risk?.teamId === 'string' && risk.teamId) {\n          collected.add(risk.teamId);\n        }\n        if (Array.isArray(risk?.teams)) {\n          risk.teams.forEach((teamId) => {\n            if (typeof teamId === 'string' && teamId) {\n              collected.add(teamId);\n            }\n          });\n        }\n      });\n\n      const analysisTeams = Array.isArray(project?.analysis?.teams) ? project.analysis.teams : [];\n      analysisTeams.forEach((teamId) => {\n        if (typeof teamId === 'string' && teamId) {\n          collected.add(teamId);\n        }\n      });\n\n      collected.forEach((teamId) => {\n        counts.set(teamId, (counts.get(teamId) || 0) + 1);\n      });\n    });\n\n    const entries = Array.from(counts.entries()).map(([teamId, value]) => ({\n      id: teamId,\n      label: teamNames.get(teamId) || teamId,\n      value\n    }));\n\n    entries.sort((a, b) => b.value - a.value || a.label.localeCompare(b.label));\n\n    return {\n      total: entries.reduce((sum, entry) => sum + entry.value, 0),\n      entries\n    };\n  }, [filteredProjects, teams]);\n\n  const leadTeamFilterLabel = useMemo(() => {\n    if (selectedLeadTeam === 'all') {\n      return 'Toutes les Ã©quipes';\n    }\n    if (selectedLeadTeam === 'not_set') {\n      return 'Ã‰quipe non renseignÃ©e';\n    }\n    return selectedLeadTeam;\n  }, [selectedLeadTeam]);\n\n  const effectiveRangeLabel = useMemo(() => {\n    if (timeOption.id === 'custom') {\n      if (!customStart && !customEnd) {\n        return 'Intervalle personnalisÃ©';\n      }\n      return formatDateRangeSummary(computedRange, 'Intervalle personnalisÃ©');\n    }\n    return timeOption.label;\n  }, [timeOption, customStart, customEnd, computedRange]);\n\n  const totalObservedRisks = useMemo(\n    () => riskSeverityAverages.entries.reduce((sum, entry) => sum + entry.totalRisks, 0),\n    [riskSeverityAverages.entries]\n  );\n\n  return (\n    <article className=\"space-y-8 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm\">\n      <header className=\"space-y-2\">\n        <h2 className=\"text-2xl font-bold text-gray-800\">Dashboard</h2>\n        <p className=\"text-sm text-gray-600\">\n          Analysez en un coup d'Å“il vos projets soumis : filtrez par Ã©quipe lead et pÃ©riode pour prendre des dÃ©cisions Ã©clairÃ©es.\n        </p>\n      </header>\n\n      <section aria-label=\"Filtres du tableau de bord\" className=\"space-y-4\">\n        <div className=\"grid gap-4 lg:grid-cols-2\">\n          <div className=\"space-y-2\">\n            <label htmlFor=\"dashboard-lead-team-filter\" className=\"text-sm font-medium text-gray-700\">\n              Filtrer par Ã©quipe lead\n            </label>\n            <select\n              id=\"dashboard-lead-team-filter\"\n              value={selectedLeadTeam}\n              onChange={(event) => setSelectedLeadTeam(event.target.value)}\n              className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n            >\n              <option value=\"all\">Toutes les Ã©quipes ({numberFormatter.format(sanitizedProjects.length)})</option>\n              <option value=\"not_set\">Ã‰quipe non renseignÃ©e ({numberFormatter.format(teamOptions.find((option) => option.id === 'not_set')?.count || 0)})</option>\n              {teamOptions\n                .filter((option) => option.id !== 'not_set')\n                .map((option) => (\n                  <option key={option.id} value={option.id}>\n                    {option.label} ({numberFormatter.format(option.count)})\n                  </option>\n                ))}\n            </select>\n          </div>\n          <div className=\"space-y-2\">\n            <label htmlFor=\"dashboard-time-filter\" className=\"text-sm font-medium text-gray-700\">\n              PÃ©riode d'analyse\n            </label>\n            <select\n              id=\"dashboard-time-filter\"\n              value={selectedTimeFilter}\n              onChange={(event) => setSelectedTimeFilter(event.target.value)}\n              className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n            >\n              {TIME_FILTER_OPTIONS.map((option) => (\n                <option key={option.id} value={option.id}>\n                  {option.label}\n                </option>\n              ))}\n            </select>\n          </div>\n        </div>\n\n        {timeOption.id === 'custom' && (\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            <div className=\"space-y-2\">\n              <label htmlFor=\"dashboard-custom-start\" className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                Date de dÃ©but\n              </label>\n              <input\n                id=\"dashboard-custom-start\"\n                type=\"date\"\n                value={customStart}\n                onChange={(event) => setCustomStart(event.target.value)}\n                max={customEnd || undefined}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label htmlFor=\"dashboard-custom-end\" className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                Date de fin\n              </label>\n              <input\n                id=\"dashboard-custom-end\"\n                type=\"date\"\n                value={customEnd}\n                onChange={(event) => setCustomEnd(event.target.value)}\n                min={customStart || undefined}\n                className=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n              />\n            </div>\n          </div>\n        )}\n\n        <div className=\"flex flex-wrap items-center gap-2 rounded-xl bg-blue-50/70 px-4 py-3 text-sm text-blue-900\">\n          <span className=\"rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-700\">\n            Filtres actifs\n          </span>\n          <span>\n            {numberFormatter.format(filteredProjects.length)} projet{filteredProjects.length > 1 ? 's' : ''} Â· {leadTeamFilterLabel} Â· {effectiveRangeLabel}\n          </span>\n        </div>\n      </section>\n\n      <section className=\"grid gap-4 md:grid-cols-2\">\n        <div className=\"rounded-2xl border border-blue-100 bg-blue-50/60 p-5\">\n          <p className=\"text-sm font-medium text-blue-800\">Nombre de projets soumis</p>\n          <p className=\"mt-3 text-4xl font-bold text-blue-900\">\n            {numberFormatter.format(filteredProjects.length)}\n          </p>\n          <p className=\"mt-2 text-xs text-blue-700\">\n            Sur un total de {numberFormatter.format(sanitizedProjects.length)} projets importÃ©s.\n          </p>\n        </div>\n        <div className=\"rounded-2xl border border-emerald-100 bg-emerald-50/60 p-5\">\n          <p className=\"text-sm font-medium text-emerald-800\">DÃ©lai moyen entre soumission et lancement cible</p>\n          <p className=\"mt-3 text-3xl font-bold text-emerald-900\">\n            {formatDays(averageDelay.average)}\n          </p>\n          <p className=\"mt-2 text-xs text-emerald-700\">\n            BasÃ© sur {numberFormatter.format(averageDelay.count)} projet{averageDelay.count > 1 ? 's' : ''} disposant des deux dates.\n          </p>\n        </div>\n      </section>\n\n      <section className=\"grid gap-6 lg:grid-cols-2\" aria-label=\"RÃ©partition des projets\">\n        <article className=\"rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-inner\">\n          <header className=\"mb-4\">\n            <h3 className=\"text-lg font-semibold text-gray-800\">RÃ©partition des projets par Ã©quipe lead</h3>\n            <p className=\"text-sm text-gray-500\">Visualisez le poids relatif de chaque Ã©quipe dans les projets qualifiÃ©s.</p>\n          </header>\n          <PieChart\n            data={leadTeamDistribution.entries}\n            title=\"RÃ©partition des projets par Ã©quipe lead\"\n          />\n        </article>\n        <article className=\"rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-inner\">\n          <header className=\"mb-4\">\n            <h3 className=\"text-lg font-semibold text-gray-800\">RÃ©partition par niveau de risque</h3>\n            <p className=\"text-sm text-gray-500\">Classement issu de la pondÃ©ration des risques dÃ©tectÃ©s par les rÃ¨gles mÃ©tier.</p>\n          </header>\n          <PieChart\n            data={riskLevelDistribution.entries}\n            title=\"RÃ©partition par niveau de risque\"\n          />\n        </article>\n      </section>\n\n      <section className=\"grid gap-6 lg:grid-cols-2\" aria-label=\"Analyse des risques\">\n        <article className=\"rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-inner\">\n          <header className=\"mb-4\">\n            <h3 className=\"text-lg font-semibold text-gray-800\">Nombre moyen de risques par gravitÃ©</h3>\n            <p className=\"text-sm text-gray-500\">\n              Moyenne calculÃ©e sur l'ensemble des projets filtrÃ©s (mÃªme si aucun risque n'est dÃ©tectÃ© sur un projet donnÃ©).\n            </p>\n          </header>\n          <BarChart\n            data={riskSeverityAverages.entries.map((entry) => ({\n              ...entry,\n              value: entry.value,\n              label: entry.label,\n              totalRisks: entry.totalRisks\n            }))}\n            valueFormatter={(value) => averageFormatter.format(value)}\n            unitSuffix=\" risque(s)/projet\"\n            emptyLabel=\"Aucun risque n'a Ã©tÃ© identifiÃ© sur la pÃ©riode filtrÃ©e.\"\n          />\n          {riskSeverityAverages.entries.length > 0 && (\n            <p className=\"mt-4 text-xs text-gray-500\">\n              Total observÃ© : {numberFormatter.format(totalObservedRisks)} risque{totalObservedRisks > 1 ? 's' : ''} sur {numberFormatter.format(filteredProjects.length)} projet{filteredProjects.length > 1 ? 's' : ''}.\n            </p>\n          )}\n        </article>\n        <article className=\"rounded-2xl border border-gray-100 bg-white/80 p-5 shadow-inner\">\n          <header className=\"mb-4\">\n            <h3 className=\"text-lg font-semibold text-gray-800\">Nombre de sollicitations par Ã©quipe compliance</h3>\n            <p className=\"text-sm text-gray-500\">\n              Compte le nombre de projets nÃ©cessitant l'intervention de chaque Ã©quipe compliance.\n            </p>\n          </header>\n          <BarChart\n            data={solicitationsByTeam.entries}\n            unitSuffix=\" projet(s)\"\n            emptyLabel=\"Aucune sollicitation compliance sur les filtres sÃ©lectionnÃ©s.\"\n          />\n        </article>\n      </section>\n    </article>\n  );\n};\n\n",
  "src/components/HomeScreen.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  Plus,\n  Target,\n  Rocket,\n  Compass,\n  Users,\n  Calendar,\n  CheckCircle,\n  Eye,\n  AlertTriangle,\n  Edit,\n  Save,\n  Upload,\n  Copy,\n  Trash2,\n  Close,\n  Sparkles\n} from './icons.js';\nimport { VirtualizedList } from './VirtualizedList.jsx';\nimport { normalizeProjectFilterConfig } from '../utils/projectFilters.js';\nimport { normalizeInspirationFiltersConfig } from '../utils/inspirationConfig.js';\n\nconst formatDate = (isoDate) => {\n  if (!isoDate) {\n    return 'Date inconnue';\n  }\n\n  try {\n    return new Date(isoDate).toLocaleString('fr-FR', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  } catch (error) {\n    return 'Date inconnue';\n  }\n};\n\nconst getSafeString = (value) => (typeof value === 'string' ? value : '');\nconst normalizeEmail = (value) => getSafeString(value).trim().toLowerCase();\n\nconst normalizeInspirationFieldValues = (value) => {\n  if (Array.isArray(value)) {\n    return value\n      .map((item) => (typeof item === 'string' ? item.trim() : ''))\n      .filter(Boolean);\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    return trimmed.length > 0 ? [trimmed] : [];\n  }\n\n  return [];\n};\n\nconst DEFAULT_SELECT_FILTER_VALUE = 'all';\nconst DEFAULT_TEXT_FILTER_VALUE = '';\n\nconst PROJECT_FILTER_VALUE_EXTRACTORS = {\n  projectName: (project) => {\n    if (!project) {\n      return '';\n    }\n\n    const directName = getSafeString(project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    return getSafeString(project.answers?.projectName);\n  },\n  teamLead: (project) => getSafeString(project?.answers?.teamLead),\n  teamLeadTeam: (project) => getSafeString(project?.answers?.teamLeadTeam)\n};\n\nconst formatAnswerValue = (value) => {\n  if (Array.isArray(value)) {\n    return value.map((item) => (item == null ? '' : String(item))).filter(Boolean).join(', ');\n  }\n\n  if (value == null) {\n    return '';\n  }\n\n  return String(value);\n};\n\nconst getProjectFilterValue = (field, project) => {\n  if (!field || !project) {\n    return '';\n  }\n\n  const extractor = PROJECT_FILTER_VALUE_EXTRACTORS[field.id];\n  if (typeof extractor === 'function') {\n    const extracted = extractor(project);\n    if (typeof extracted === 'string' && extracted.trim().length > 0) {\n      return extracted;\n    }\n  }\n\n  const sourceId = typeof field.sourceQuestionId === 'string' && field.sourceQuestionId.trim().length > 0\n    ? field.sourceQuestionId\n    : field.id;\n\n  const answerValue = project?.answers?.[sourceId];\n  if (typeof answerValue === 'string') {\n    return answerValue;\n  }\n\n  const formattedAnswer = formatAnswerValue(answerValue);\n  if (formattedAnswer.trim().length > 0) {\n    return formattedAnswer;\n  }\n\n  const directValue = project[sourceId];\n  if (typeof directValue === 'string') {\n    return directValue;\n  }\n\n  return formatAnswerValue(directValue);\n};\n\nconst getProjectTimestamp = (project) => {\n  if (!project) {\n    return 0;\n  }\n\n  const candidates = [project.lastUpdated, project.submittedAt, project.generatedAt];\n\n  for (let index = 0; index < candidates.length; index += 1) {\n    const candidate = candidates[index];\n    if (!candidate) {\n      continue;\n    }\n\n    const parsed = new Date(candidate).getTime();\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return 0;\n};\n\nconst buildInitialFiltersState = (config) => {\n  const initial = {\n    sortOrder: 'desc',\n    sortOrderDefault: 'desc'\n  };\n\n  if (!config || !Array.isArray(config.fields)) {\n    return initial;\n  }\n\n  config.fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.id === 'dateOrder') {\n      const defaultValue = field.defaultValue === 'asc' ? 'asc' : 'desc';\n      initial.sortOrder = defaultValue;\n      initial.sortOrderDefault = defaultValue;\n      return;\n    }\n\n    if (field.type === 'select') {\n      initial[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n    } else {\n      initial[field.id] = '';\n    }\n  });\n\n  return initial;\n};\n\nconst SORT_LABELS = {\n  desc: 'Les plus rÃ©cents en premier',\n  asc: 'Les plus anciens en premier'\n};\n\nconst complexityColors = {\n  Faible: 'text-green-600',\n  ModÃ©rÃ©e: 'text-yellow-600',\n  Ã‰levÃ©e: 'text-red-600'\n};\n\nconst statusStyles = {\n  draft: {\n    label: 'Brouillon en cours',\n    className: 'bg-yellow-50 border-yellow-200 text-yellow-600'\n  },\n  submitted: {\n    label: 'SynthÃ¨se finalisÃ©e',\n    className: 'bg-emerald-50 border-emerald-200 text-emerald-600'\n  }\n};\n\nconst computeRemainingQuestions = (project) => {\n  if (!project || typeof project.totalQuestions !== 'number' || project.totalQuestions <= 0) {\n    return null;\n  }\n\n  const answeredCountRaw =\n    typeof project.answeredQuestions === 'number'\n      ? project.answeredQuestions\n      : Math.max((project.lastQuestionIndex ?? 0) + 1, 0);\n\n  const answeredCount = Math.min(answeredCountRaw, project.totalQuestions);\n  const remainingCount = Math.max(project.totalQuestions - answeredCount, 0);\n\n  return remainingCount;\n};\n\nexport const HomeScreen = ({\n  projects = [],\n  projectFilters,\n  teamLeadOptions = [],\n  inspirationProjects = [],\n  inspirationFilters,\n  homeView = 'platform',\n  onHomeViewChange,\n  onStartInspirationProject,\n  onOpenInspirationProject,\n  onStartNewProject,\n  onOpenProject,\n  onDeleteProject,\n  onShowProjectShowcase,\n  onImportProject,\n  onDuplicateProject,\n  isAdminMode = false,\n  tourContext = null,\n  currentUser = null\n}) => {\n  const normalizedFilters = useMemo(\n    () => normalizeProjectFilterConfig(projectFilters),\n    [projectFilters]\n  );\n  const currentUserEmail = useMemo(\n    () => normalizeEmail(currentUser?.mail || currentUser?.userPrincipalName || ''),\n    [currentUser]\n  );\n  const currentUserFirstName = getSafeString(currentUser?.givenName).trim();\n  const heroHeadline = currentUserFirstName.length > 0\n    ? `${currentUserFirstName}, anticipez les besoins compliance de vos projets en quelques minutes`\n    : 'Anticipez les besoins compliance de vos projets en quelques minutes';\n  const [filtersState, setFiltersState] = useState(() => buildInitialFiltersState(normalizedFilters));\n  const normalizedInspirationFilters = useMemo(\n    () => normalizeInspirationFiltersConfig(inspirationFilters),\n    [inspirationFilters]\n  );\n  const [inspirationFiltersState, setInspirationFiltersState] = useState(() =>\n    buildInitialFiltersState(normalizedInspirationFilters)\n  );\n  const fileInputRef = useRef(null);\n  const [deleteDialogState, setDeleteDialogState] = useState(() => ({\n    isOpen: false,\n    project: null\n  }));\n  const deleteCancelButtonRef = useRef(null);\n  const deleteConfirmButtonRef = useRef(null);\n  const previouslyFocusedElementRef = useRef(null);\n\n  const accessibleProjects = useMemo(() => {\n    if (!Array.isArray(projects)) {\n      return [];\n    }\n\n    if (isAdminMode || !currentUserEmail) {\n      return projects;\n    }\n\n    return projects.filter((project) => {\n      const ownerEmail = normalizeEmail(project?.ownerEmail);\n      const sharedWith = Array.isArray(project?.sharedWith) ? project.sharedWith : [];\n      const isShared = sharedWith.some((entry) => normalizeEmail(entry) === currentUserEmail);\n\n      if (!ownerEmail && sharedWith.length === 0) {\n        return true;\n      }\n\n      return ownerEmail === currentUserEmail || isShared;\n    });\n  }, [projects, isAdminMode, currentUserEmail]);\n\n  const closeDeleteDialog = useCallback(() => {\n    setDeleteDialogState({ isOpen: false, project: null });\n  }, []);\n\n  const handleCancelDeleteProject = useCallback(() => {\n    closeDeleteDialog();\n  }, [closeDeleteDialog]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    let selector = null;\n\n    if (activeStep === 'create-project') {\n      selector = '[data-tour-id=\"home-create-project\"]';\n    } else if (activeStep === 'project-import') {\n      selector = '[data-tour-id=\"home-import-project\"]';\n    } else if (activeStep === 'project-filters') {\n      selector = '[data-tour-id=\"home-filters\"]';\n    }\n\n    if (selector) {\n      const element = document.querySelector(selector);\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      }\n    }\n  }, [tourContext]);\n\n  const handleRequestProjectDeletion = useCallback((project) => {\n    if (!project || !project.id || typeof onDeleteProject !== 'function') {\n      return;\n    }\n\n    if (typeof document !== 'undefined' && document.activeElement instanceof HTMLElement) {\n      previouslyFocusedElementRef.current = document.activeElement;\n    } else {\n      previouslyFocusedElementRef.current = null;\n    }\n\n    setDeleteDialogState({\n      isOpen: true,\n      project\n    });\n  }, [onDeleteProject]);\n\n  const handleConfirmDeleteProject = useCallback(() => {\n    if (!deleteDialogState.project || typeof onDeleteProject !== 'function') {\n      closeDeleteDialog();\n      return;\n    }\n\n    onDeleteProject(deleteDialogState.project.id);\n    closeDeleteDialog();\n  }, [closeDeleteDialog, deleteDialogState.project, onDeleteProject]);\n\n  useEffect(() => {\n    if (!deleteDialogState.isOpen) {\n      if (\n        previouslyFocusedElementRef.current &&\n        typeof previouslyFocusedElementRef.current.focus === 'function'\n      ) {\n        const shouldRestoreFocus =\n          typeof document === 'undefined' ||\n          document.contains(previouslyFocusedElementRef.current);\n\n        if (shouldRestoreFocus) {\n          previouslyFocusedElementRef.current.focus();\n        }\n\n        previouslyFocusedElementRef.current = null;\n      }\n      return undefined;\n    }\n\n    const timeoutId = typeof window !== 'undefined'\n      ? window.setTimeout(() => {\n        if (deleteCancelButtonRef.current && typeof deleteCancelButtonRef.current.focus === 'function') {\n          deleteCancelButtonRef.current.focus();\n        }\n      }, 0)\n      : null;\n\n    const handleKeyDown = (event) => {\n      if (event.key === 'Escape') {\n        event.preventDefault();\n        handleCancelDeleteProject();\n        return;\n      }\n\n      if (event.key === 'Tab') {\n        const focusableElements = [deleteCancelButtonRef.current, deleteConfirmButtonRef.current].filter(\n          (element) => element && typeof element.focus === 'function'\n        );\n\n        if (focusableElements.length === 0) {\n          return;\n        }\n\n        const activeElement = typeof document !== 'undefined' ? document.activeElement : null;\n        const currentIndex = focusableElements.indexOf(activeElement);\n        let nextIndex = currentIndex;\n\n        if (event.shiftKey) {\n          nextIndex = currentIndex <= 0 ? focusableElements.length - 1 : currentIndex - 1;\n        } else {\n          nextIndex = currentIndex === focusableElements.length - 1 ? 0 : currentIndex + 1;\n        }\n\n        event.preventDefault();\n        focusableElements[nextIndex]?.focus();\n      }\n    };\n\n    if (typeof document !== 'undefined') {\n      document.addEventListener('keydown', handleKeyDown);\n    }\n\n    return () => {\n      if (typeof document !== 'undefined') {\n        document.removeEventListener('keydown', handleKeyDown);\n      }\n      if (timeoutId !== null && typeof window !== 'undefined') {\n        window.clearTimeout(timeoutId);\n      }\n    };\n  }, [deleteDialogState.isOpen, handleCancelDeleteProject]);\n\n  useEffect(() => {\n    setFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      if (typeof prevState.sortOrder === 'undefined') {\n        nextState.sortOrder = initialState.sortOrder;\n        changed = true;\n      }\n      if (typeof prevState.sortOrderDefault === 'undefined') {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      if (prevState.sortOrder === prevState.sortOrderDefault) {\n        if (prevState.sortOrder !== initialState.sortOrder) {\n          nextState.sortOrder = initialState.sortOrder;\n          changed = true;\n        }\n      }\n      if (prevState.sortOrderDefault !== initialState.sortOrderDefault) {\n        nextState.sortOrderDefault = initialState.sortOrderDefault;\n        changed = true;\n      }\n\n      normalizedFilters.fields.forEach((field) => {\n        if (!field || field.id === 'dateOrder') {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = '';\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== '') {\n            nextState[field.id] = '';\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        if (key === 'sortOrder' || key === 'sortOrderDefault') {\n          return;\n        }\n\n        const stillExists = normalizedFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedFilters]);\n\n  useEffect(() => {\n    setInspirationFiltersState(prevState => {\n      const initialState = buildInitialFiltersState(normalizedInspirationFilters);\n      const nextState = { ...prevState };\n      let changed = false;\n\n      normalizedInspirationFilters.fields.forEach((field) => {\n        if (!field) {\n          return;\n        }\n\n        if (field.type === 'select') {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_SELECT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_SELECT_FILTER_VALUE;\n            changed = true;\n          }\n        } else {\n          if (!(field.id in prevState)) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n          if (!field.enabled && nextState[field.id] !== DEFAULT_TEXT_FILTER_VALUE) {\n            nextState[field.id] = DEFAULT_TEXT_FILTER_VALUE;\n            changed = true;\n          }\n        }\n      });\n\n      Object.keys(nextState).forEach((key) => {\n        const stillExists = normalizedInspirationFilters.fields.some((field) => field && field.id === key);\n        if (!stillExists) {\n          delete nextState[key];\n          changed = true;\n        }\n      });\n\n      if (!changed) {\n        return prevState;\n      }\n\n      return nextState;\n    });\n  }, [normalizedInspirationFilters]);\n\n  const selectFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (field.id === 'teamLeadTeam' && Array.isArray(teamLeadOptions)) {\n        teamLeadOptions.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      accessibleProjects.forEach((project) => {\n        const value = getProjectFilterValue(field, project).trim();\n        if (value.length > 0) {\n          options.add(value);\n        }\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [accessibleProjects, normalizedFilters.fields, teamLeadOptions]);\n\n  const inspirationFilterOptions = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields) ? normalizedInspirationFilters.fields : [];\n    const map = new Map();\n\n    fields.forEach((field) => {\n      if (!field || field.type !== 'select') {\n        return;\n      }\n\n      const options = new Set();\n\n      if (Array.isArray(field.options)) {\n        field.options.forEach((option) => {\n          const label = getSafeString(option).trim();\n          if (label.length > 0) {\n            options.add(label);\n          }\n        });\n      }\n\n      inspirationProjects.forEach((project) => {\n        const values = normalizeInspirationFieldValues(project?.[field.id]);\n        values.forEach((value) => {\n          if (value.length > 0) {\n            options.add(value);\n          }\n        });\n      });\n\n      map.set(field.id, Array.from(options).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' })));\n    });\n\n    return map;\n  }, [normalizedInspirationFilters.fields, inspirationProjects]);\n\n  const filteredProjects = useMemo(() => {\n    if (!Array.isArray(accessibleProjects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    const selection = accessibleProjects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled || field.id === 'dateOrder') {\n          continue;\n        }\n\n        const value = filtersState[field.id];\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            const projectValue = getProjectFilterValue(field, project);\n            if (projectValue !== value) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const projectValue = getProjectFilterValue(field, project);\n        if (projectValue.toLowerCase().indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n\n    const sortField = activeFields.find((field) => field && field.id === 'dateOrder');\n    const selectedOrder = filtersState.sortOrder || sortField?.defaultValue || 'desc';\n    const direction = selectedOrder === 'asc' ? 'asc' : 'desc';\n\n    return selection.slice().sort((a, b) => {\n      const statusA = a?.status === 'draft' ? 0 : 1;\n      const statusB = b?.status === 'draft' ? 0 : 1;\n\n      if (statusA !== statusB) {\n        return statusA - statusB;\n      }\n\n      const timeA = getProjectTimestamp(a);\n      const timeB = getProjectTimestamp(b);\n      const diff = timeA - timeB;\n\n      return direction === 'asc' ? diff : -diff;\n    });\n  }, [accessibleProjects, normalizedFilters, filtersState]);\n\n  const filteredInspirationProjects = useMemo(() => {\n    if (!Array.isArray(inspirationProjects)) {\n      return [];\n    }\n\n    const activeFields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    return inspirationProjects.filter((project) => {\n      for (let index = 0; index < activeFields.length; index += 1) {\n        const field = activeFields[index];\n        if (!field || !field.enabled) {\n          continue;\n        }\n\n        const value = inspirationFiltersState[field.id];\n        const projectValues = normalizeInspirationFieldValues(project?.[field.id]);\n\n        if (field.type === 'select') {\n          if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n            if (!projectValues.includes(value)) {\n              return false;\n            }\n          }\n          continue;\n        }\n\n        const query = typeof value === 'string' ? value.trim().toLowerCase() : '';\n        if (query.length === 0) {\n          continue;\n        }\n\n        const haystack = projectValues.join(' ').toLowerCase();\n        if (haystack.indexOf(query) === -1) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n  }, [inspirationProjects, normalizedInspirationFilters.fields, inspirationFiltersState]);\n  const projectRows = useMemo(() => {\n    const rows = [];\n    for (let index = 0; index < filteredProjects.length; index += 2) {\n      rows.push(filteredProjects.slice(index, index + 2));\n    }\n    return rows;\n  }, [filteredProjects]);\n  const shouldVirtualizeProjects = projectRows.length > 6;\n\n  const hasProjects = accessibleProjects.length > 0;\n  const hasFilteredProjects = filteredProjects.length > 0;\n  const hasInspirationProjects = inspirationProjects.length > 0;\n  const hasFilteredInspirationProjects = filteredInspirationProjects.length > 0;\n  const pendingDeletionProjectName = useMemo(() => {\n    if (!deleteDialogState.project) {\n      return '';\n    }\n\n    const directName = getSafeString(deleteDialogState.project.projectName);\n    if (directName.trim().length > 0) {\n      return directName;\n    }\n\n    const answerName = getSafeString(deleteDialogState.project.answers?.projectName);\n    if (answerName.trim().length > 0) {\n      return answerName;\n    }\n\n    return 'Projet sans nom';\n  }, [deleteDialogState.project]);\n\n  const hasActiveFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedFilters.fields) ? normalizedFilters.fields : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      if (field.id === 'dateOrder') {\n        if (filtersState.sortOrder !== filtersState.sortOrderDefault) {\n          return true;\n        }\n        continue;\n      }\n\n      const value = filtersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedFilters, filtersState]);\n\n  const hasActiveInspirationFilters = useMemo(() => {\n    const fields = Array.isArray(normalizedInspirationFilters.fields)\n      ? normalizedInspirationFilters.fields\n      : [];\n\n    for (let index = 0; index < fields.length; index += 1) {\n      const field = fields[index];\n      if (!field || !field.enabled) {\n        continue;\n      }\n\n      const value = inspirationFiltersState[field.id];\n      if (field.type === 'select') {\n        if (value && value !== DEFAULT_SELECT_FILTER_VALUE) {\n          return true;\n        }\n      } else if (typeof value === 'string' && value.trim().length > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }, [normalizedInspirationFilters.fields, inspirationFiltersState]);\n\n  const displayedProjectsCount = filteredProjects.length;\n  const totalProjectsCount = accessibleProjects.length;\n  const sortFilterConfig = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.find(field => field && field.id === 'dateOrder')\n    : null;\n  const enabledFilterFields = Array.isArray(normalizedFilters.fields)\n    ? normalizedFilters.fields.filter(field => field && field.enabled && field.id !== 'dateOrder')\n    : [];\n  const shouldShowFiltersCard = hasProjects && (enabledFilterFields.length > 0 || (sortFilterConfig && sortFilterConfig.enabled));\n  const currentSortOrder = filtersState.sortOrder || sortFilterConfig?.defaultValue || 'desc';\n  const inspirationFilterFields = Array.isArray(normalizedInspirationFilters.fields)\n    ? normalizedInspirationFilters.fields.filter((field) => field && field.enabled)\n    : [];\n  const shouldShowInspirationFiltersCard = hasInspirationProjects && inspirationFilterFields.length > 0;\n\n  const handleClearProjectFilter = useCallback((target) => {\n    setFiltersState((prev) => {\n      const next = { ...prev };\n\n      if (target.type === 'sort') {\n        const defaultValue = prev.sortOrderDefault || 'desc';\n        if (prev.sortOrder === defaultValue) {\n          return prev;\n        }\n        next.sortOrder = defaultValue;\n        return next;\n      }\n\n      if (target.type === 'select') {\n        next[target.id] = DEFAULT_SELECT_FILTER_VALUE;\n      } else {\n        next[target.id] = DEFAULT_TEXT_FILTER_VALUE;\n      }\n\n      return next;\n    });\n  }, []);\n\n  const handleClearInspirationFilter = useCallback((target) => {\n    setInspirationFiltersState((prev) => {\n      const next = { ...prev };\n\n      if (target.type === 'select') {\n        next[target.id] = DEFAULT_SELECT_FILTER_VALUE;\n      } else {\n        next[target.id] = DEFAULT_TEXT_FILTER_VALUE;\n      }\n\n      return next;\n    });\n  }, []);\n\n  const activeProjectFilterChips = useMemo(() => {\n    const chips = [];\n\n    enabledFilterFields.forEach((field) => {\n      const rawValue = filtersState[field.id];\n      if (field.type === 'select') {\n        if (rawValue && rawValue !== DEFAULT_SELECT_FILTER_VALUE) {\n          chips.push({\n            id: field.id,\n            label: field.label || 'Filtre',\n            value: String(rawValue),\n            onClear: () => handleClearProjectFilter({ id: field.id, type: 'select' })\n          });\n        }\n        return;\n      }\n\n      const trimmed = typeof rawValue === 'string' ? rawValue.trim() : '';\n      if (trimmed.length > 0) {\n        chips.push({\n          id: field.id,\n          label: field.label || 'Filtre',\n          value: trimmed,\n          onClear: () => handleClearProjectFilter({ id: field.id, type: 'text' })\n        });\n      }\n    });\n\n    if (sortFilterConfig?.enabled && filtersState.sortOrder !== filtersState.sortOrderDefault) {\n      chips.push({\n        id: 'sortOrder',\n        label: sortFilterConfig.label || 'Tri',\n        value: SORT_LABELS[filtersState.sortOrder] || filtersState.sortOrder,\n        onClear: () => handleClearProjectFilter({ id: 'sortOrder', type: 'sort' })\n      });\n    }\n\n    return chips;\n  }, [\n    enabledFilterFields,\n    filtersState,\n    sortFilterConfig,\n    handleClearProjectFilter\n  ]);\n\n  const activeInspirationFilterChips = useMemo(() => {\n    const chips = [];\n\n    inspirationFilterFields.forEach((field) => {\n      const rawValue = inspirationFiltersState[field.id];\n      if (field.type === 'select') {\n        if (rawValue && rawValue !== DEFAULT_SELECT_FILTER_VALUE) {\n          chips.push({\n            id: field.id,\n            label: field.label || 'Filtre',\n            value: String(rawValue),\n            onClear: () => handleClearInspirationFilter({ id: field.id, type: 'select' })\n          });\n        }\n        return;\n      }\n\n      const trimmed = typeof rawValue === 'string' ? rawValue.trim() : '';\n      if (trimmed.length > 0) {\n        chips.push({\n          id: field.id,\n          label: field.label || 'Filtre',\n          value: trimmed,\n          onClear: () => handleClearInspirationFilter({ id: field.id, type: 'text' })\n        });\n      }\n    });\n\n    return chips;\n  }, [inspirationFilterFields, inspirationFiltersState, handleClearInspirationFilter]);\n\n  const handleResetFilters = () => {\n    setFiltersState(buildInitialFiltersState(normalizedFilters));\n  };\n\n  const handleResetInspirationFilters = () => {\n    setInspirationFiltersState(buildInitialFiltersState(normalizedInspirationFilters));\n  };\n\n  const handleTriggerImport = () => {\n    if (fileInputRef.current) {\n      fileInputRef.current.click();\n    }\n  };\n\n  const handleFileChange = (event) => {\n    const file = event?.target?.files?.[0];\n    if (file && typeof onImportProject === 'function') {\n      onImportProject(file);\n    }\n\n    if (event?.target) {\n      event.target.value = '';\n    }\n  };\n\n  const renderProjectCard = (project) => {\n    const complexity = project.analysis?.complexity;\n    const risksCount = project.analysis?.risks?.length ?? 0;\n    const projectStatus = statusStyles[project.status] || statusStyles.submitted;\n    const remainingQuestions = computeRemainingQuestions(project);\n    const isDraft = project.status === 'draft';\n    const adminCanEditSubmitted = isAdminMode && !isDraft;\n    const leadName = getSafeString(project?.answers?.teamLead).trim();\n    const leadTeam = getSafeString(project?.answers?.teamLeadTeam).trim();\n    const leadDisplay = leadName.length > 0\n      ? `${leadName}${leadTeam.length > 0 ? ` (${leadTeam})` : ''}`\n      : leadTeam.length > 0\n        ? `(${leadTeam})`\n        : 'Lead du projet non renseignÃ©';\n    const projectTypeRaw = project?.answers?.ProjectType;\n    const projectType = Array.isArray(projectTypeRaw)\n      ? projectTypeRaw\n          .map(item => (typeof item === 'string' ? item.trim() : ''))\n          .filter(item => item.length > 0)\n          .join(', ')\n      : getSafeString(projectTypeRaw).trim();\n    const projectTypeDisplay = projectType.length > 0\n      ? projectType\n      : 'Type de projet non renseignÃ©';\n\n    return (\n      <article\n        key={project.id}\n        className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n        role=\"listitem\"\n        aria-label={`Projet ${project.projectName || 'sans nom'}`}\n      >\n        <div className=\"flex items-start justify-between gap-4\">\n          <div>\n            <h3 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2 flex-wrap\">\n              <span>{project.projectName || 'Projet sans nom'}</span>\n              {project.isDemo && (\n                <span className=\"inline-flex items-center px-2 py-0.5 text-xs font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full\">\n                  Projet dÃ©mo\n                </span>\n              )}\n            </h3>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              DerniÃ¨re mise Ã  jour : {formatDate(project.lastUpdated || project.submittedAt)}\n            </p>\n          </div>\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex flex-col items-end gap-2\">\n              <span\n                className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${projectStatus.className}`.trim()}\n              >\n                {projectStatus.label}\n              </span>\n              {complexity && (\n                <span className={`px-3 py-1 text-xs font-semibold rounded-full border hv-badge ${complexityColors[complexity] || 'text-blue-600'}`}>\n                  {complexity}\n                </span>\n              )}\n            </div>\n            {typeof onDuplicateProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => onDuplicateProject(project.id)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-blue-200 text-blue-600 hover:bg-blue-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Dupliquer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Dupliquer le projet\"\n              >\n                <Copy className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n            {isDraft && typeof onDeleteProject === 'function' && (\n              <button\n                type=\"button\"\n                onClick={() => handleRequestProjectDeletion(project)}\n                className=\"inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition-colors hv-button hv-focus-ring\"\n                aria-label={`Supprimer le projet ${project.projectName || 'sans nom'}`}\n                title=\"Supprimer le projet\"\n              >\n                <Trash2 className=\"w-4 h-4\" aria-hidden=\"true\" />\n              </button>\n            )}\n          </div>\n        </div>\n\n        <dl className=\"mt-4 grid grid-cols-1 gap-3 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"w-4 h-4\" />\n            <span className=\"font-medium text-gray-700\">{leadDisplay}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{projectTypeDisplay}</span>\n          </div>\n          {remainingQuestions !== null && (\n            <div className=\"flex items-center gap-2\">\n              <Save className=\"w-4 h-4\" />\n              <span>\n                {remainingQuestions === 0\n                  ? 'Aucune question restante'\n                  : `${remainingQuestions} question${remainingQuestions > 1 ? 's' : ''} restante${remainingQuestions > 1 ? 's' : ''}`}\n              </span>\n            </div>\n          )}\n          <div className=\"flex items-center gap-2\">\n            <AlertTriangle className=\"w-4 h-4\" />\n            <span>{risksCount} risque{risksCount > 1 ? 's' : ''} identifiÃ©{risksCount > 1 ? 's' : ''}</span>\n          </div>\n        </dl>\n\n        <div className=\"mt-6 flex flex-wrap gap-3\">\n          <button\n            type=\"button\"\n            onClick={() => {\n              if (isDraft) {\n                onOpenProject(project.id);\n                return;\n              }\n\n              if (adminCanEditSubmitted) {\n                onOpenProject(project.id, { view: 'questionnaire' });\n                return;\n              }\n\n              onOpenProject(project.id);\n            }}\n            className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button ${\n              isDraft || adminCanEditSubmitted\n                ? 'hv-button-draft text-white'\n                : 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n            }`}\n          >\n            {isDraft ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Continuer l'Ã©dition</span>\n              </>\n            ) : adminCanEditSubmitted ? (\n              <>\n                <Edit className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Modifier le projet</span>\n              </>\n            ) : (\n              <>\n                <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n                <span>Consulter la synthÃ¨se</span>\n              </>\n            )}\n          </button>\n          {adminCanEditSubmitted && (\n            <button\n              type=\"button\"\n              onClick={() => onOpenProject(project.id, { view: 'synthesis' })}\n              className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n            >\n              <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n              <span>Consulter la synthÃ¨se</span>\n            </button>\n          )}\n          {onShowProjectShowcase && (\n            <button\n              type=\"button\"\n              onClick={() => onShowProjectShowcase(project.id)}\n              className=\"inline-flex items-center px-4 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all hv-button hv-focus-ring\"\n            >\n              <Sparkles className=\"w-4 h-4 mr-2\" /> Vitrine du projet\n            </button>\n          )}\n        </div>\n      </article>\n    );\n  };\n\n  const renderInspirationCard = (project) => (\n    <article\n      key={project.id}\n      className=\"bg-white border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-lg transition-all hv-surface\"\n      role=\"listitem\"\n      aria-label={`Projet inspirant ${project.title || 'sans titre'}`}\n    >\n      <div className=\"space-y-3\">\n        <div>\n          <h3 className=\"text-xl font-semibold text-gray-900\">{project.title || 'Projet sans titre'}</h3>\n          <p className=\"text-sm text-gray-500\">{project.labName || 'Laboratoire non renseignÃ©'}</p>\n        </div>\n        <dl className=\"grid grid-cols-1 gap-2 text-sm text-gray-600\">\n          <div className=\"flex items-center gap-2\">\n            <Compass className=\"w-4 h-4\" />\n            <span>{project.country || 'Pays non renseignÃ©'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Target className=\"w-4 h-4\" />\n            <span>{project.target || 'Cible non renseignÃ©e'}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Sparkles className=\"w-4 h-4\" />\n            <span>{project.therapeuticArea || 'Aire thÃ©rapeutique non renseignÃ©e'}</span>\n          </div>\n        </dl>\n      </div>\n      <div className=\"mt-5 flex flex-wrap gap-3\">\n        <button\n          type=\"button\"\n          onClick={() => onOpenInspirationProject?.(project.id)}\n          className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all hv-button bg-blue-600 text-white hover:bg-blue-700 hv-button-primary\"\n        >\n          <Eye className=\"w-4 h-4\" aria-hidden=\"true\" />\n          <span>Fiche complÃ¨te</span>\n        </button>\n      </div>\n    </article>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8 hv-background\">\n      <div className=\"max-w-6xl mx-auto space-y-12\">\n        <header className=\"bg-white border border-blue-100 rounded-3xl shadow-xl p-6 sm:p-10 hv-surface\" role=\"banner\">\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6\">\n            <div className=\"space-y-4\">\n              <span className=\"inline-flex items-center px-3 py-1 text-sm font-semibold text-blue-700 bg-blue-100 rounded-full border border-blue-200\">\n                <Target className=\"w-4 h-4 mr-2\" /> Votre copilote compliance\n              </span>\n              <h1 className=\"text-3xl sm:text-4xl font-bold text-gray-900 leading-tight\">\n                {heroHeadline}\n              </h1>\n              <p className=\"text-lg text-gray-600 leading-relaxed max-w-2xl\">\n                Project Navigator vous guide pas Ã  pas pour qualifier votre initiative, identifier les interlocuteurs Ã  mobiliser et sÃ©curiser vos dÃ©lais rÃ©glementaires.\n              </p>\n              <div className=\"flex flex-col sm:flex-row gap-3\" role=\"group\" aria-label=\"Actions principales\">\n                <button\n                  type=\"button\"\n                  onClick={onStartNewProject}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-xl shadow-md transition-all hv-button hv-button-primary\"\n                  data-tour-id=\"home-create-project\"\n                >\n                  <Plus className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>CrÃ©er un nouveau</span>\n                    <span>projet</span>\n                  </span>\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleTriggerImport}\n                  className=\"inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-blue-600 bg-white hover:bg-blue-50 rounded-xl border border-blue-200 transition-all hv-button hv-focus-ring\"\n                  data-tour-id=\"home-import-project\"\n                >\n                  <Upload className=\"w-5 h-5\" aria-hidden=\"true\" />\n                  <span className=\"flex flex-col leading-tight text-left\">\n                    <span>Charger</span>\n                    <span>un projet</span>\n                  </span>\n                </button>\n              </div>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\"application/json\"\n                onChange={handleFileChange}\n                className=\"hidden\"\n                tabIndex={-1}\n                aria-hidden=\"true\"\n              />\n            </div>\n            <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 text-sm text-gray-600\">\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Rocket className=\"w-5 h-5 mr-2\" /> DÃ©marrez simplement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Un questionnaire dynamique pour cadrer votre projet et qualifier les impacts compliance.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Compass className=\"w-5 h-5 mr-2\" /> Visualisez la feuille de route\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Une synthÃ¨se claire avec le niveau de complexitÃ©, les Ã©quipes Ã  mobiliser et les dÃ©lais recommandÃ©s.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Users className=\"w-5 h-5 mr-2\" /> Collaborez efficacement\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Partagez la synthÃ¨se avec les parties prenantes pour sÃ©curiser vos points de passage.\n                </p>\n              </div>\n              <div className=\"bg-blue-50 border border-blue-200 rounded-2xl p-4 hv-surface\" role=\"listitem\">\n                <p className=\"font-semibold text-gray-800 flex items-center\">\n                  <Calendar className=\"w-5 h-5 mr-2\" /> Gardez une trace\n                </p>\n                <p className=\"mt-2 leading-relaxed\">\n                  Retrouvez Ã  tout moment les projets dÃ©jÃ  soumis et mettez-les Ã  jour si nÃ©cessaire.\n                </p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        <section aria-labelledby=\"projects-heading\" className=\"space-y-6\">\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n            <div>\n              <h2 id=\"projects-heading\" className=\"text-2xl font-bold text-gray-900\">\n                {homeView === 'inspiration' ? 'Projets inspirants' : 'Vos projets enregistrÃ©s'}\n              </h2>\n              <p className=\"text-sm text-gray-600\">\n                {homeView === 'inspiration'\n                  ? 'DÃ©couvrez les initiatives dâ€™autres laboratoires et gÃ©rez vos projets inspirants.'\n                  : 'AccÃ©dez aux brouillons et aux synthÃ¨ses finalisÃ©es pour les reprendre Ã  tout moment.'}\n              </p>\n            </div>\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n              <div\n                className=\"inline-flex items-center rounded-full border border-blue-200 bg-blue-50 p-1\"\n                role=\"group\"\n                aria-label=\"SÃ©lection du bloc projet\"\n              >\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('platform')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView !== 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Projets LFB\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => onHomeViewChange?.('inspiration')}\n                  className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                    homeView === 'inspiration'\n                      ? 'bg-blue-600 text-white'\n                      : 'text-blue-700 hover:bg-blue-100'\n                  }`}\n                >\n                  Inspiration\n                </button>\n              </div>\n              {homeView === 'inspiration' ? (\n                <button\n                  type=\"button\"\n                  onClick={onStartInspirationProject}\n                  className=\"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n                >\n                  <Plus className=\"w-4 h-4\" aria-hidden=\"true\" />\n                  Ajouter un projet inspirant\n                </button>\n              ) : (\n                <span className=\"inline-flex items-center text-sm font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-full px-3 py-1\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" /> {displayedProjectsCount} projet{displayedProjectsCount > 1 ? 's' : ''}\n                  {hasActiveFilters ? ` sur ${totalProjectsCount}` : ''}\n                </span>\n              )}\n            </div>\n          </div>\n\n          {homeView !== 'inspiration' && !hasProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet enregistrÃ© pour le moment.</p>\n              <p className=\"mt-2\">Lancez-vous dÃ¨s maintenant pour prÃ©parer votre premiÃ¨re synthÃ¨se compliance.</p>\n              <button\n                type=\"button\"\n                onClick={onStartNewProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> CrÃ©er un projet\n              </button>\n            </div>\n          )}\n\n          {homeView !== 'inspiration' && hasProjects && (\n            <>\n              {shouldShowFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets\"\n                  data-tour-id=\"home-filters\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres disponibles\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveFilters}\n                    >\n                      Effacer tous les filtres\n                    </button>\n                  </div>\n                  {activeProjectFilterChips.length > 0 && (\n                    <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-600\">\n                      <span className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                        Filtres actifs\n                      </span>\n                      {activeProjectFilterChips.map((chip) => (\n                        <span\n                          key={chip.id}\n                          className=\"inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700\"\n                        >\n                          <span className=\"font-semibold text-blue-800\">{chip.label} :</span>\n                          <span>{chip.value}</span>\n                          <button\n                            type=\"button\"\n                            onClick={chip.onClear}\n                            className=\"inline-flex h-5 w-5 items-center justify-center rounded-full text-blue-700 transition-colors hover:bg-blue-100\"\n                            aria-label={`Supprimer le filtre ${chip.label}`}\n                          >\n                            <Close className=\"h-3 w-3\" aria-hidden=\"true\" />\n                          </button>\n                        </span>\n                      ))}\n                    </div>\n                  )}\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                    {enabledFilterFields.map((field) => {\n                      const fieldId = `project-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = filtersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = selectFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof filtersState[field.id] === 'string' ? filtersState[field.id] : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                    {sortFilterConfig && sortFilterConfig.enabled && (\n                      <div className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                        <label htmlFor=\"project-sort-order\" className=\"font-semibold text-gray-700\">\n                          {sortFilterConfig.label}\n                        </label>\n                        <select\n                          id=\"project-sort-order\"\n                          value={currentSortOrder}\n                          onChange={(event) =>\n                            setFiltersState(prev => ({\n                              ...prev,\n                              sortOrder: event.target.value === 'asc' ? 'asc' : 'desc'\n                            }))\n                          }\n                          className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        >\n                          <option value=\"desc\">{SORT_LABELS.desc}</option>\n                          <option value=\"asc\">{SORT_LABELS.asc}</option>\n                        </select>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredProjects ? (\n                shouldVirtualizeProjects ? (\n                  <VirtualizedList\n                    items={projectRows}\n                    itemKey={(_row, index) => `project-row-${index}`}\n                    estimatedItemHeight={420}\n                    overscan={3}\n                    role=\"list\"\n                    className=\"relative\"\n                    renderItem={(row) => (\n                      <div className=\"pb-6\">\n                        <div className=\"flex flex-col md:flex-row gap-6\">\n                          {row.map(project => renderProjectCard(project))}\n                        </div>\n                      </div>\n                    )}\n                  />\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                    {filteredProjects.map(project => renderProjectCard(project))}\n                  </div>\n                )\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond Ã  vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critÃ¨res ou rÃ©initialisez les filtres pour afficher tous les projets.</p>\n                  {hasActiveFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Effacer tous les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n\n          {homeView === 'inspiration' && !hasInspirationProjects && (\n            <div className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <p className=\"text-lg font-medium text-gray-800\">Aucun projet inspirant enregistrÃ©.</p>\n              <p className=\"mt-2\">Ajoutez des exemples pour nourrir vos rÃ©flexions.</p>\n              <button\n                type=\"button\"\n                onClick={onStartInspirationProject}\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" /> CrÃ©er un projet inspirant\n              </button>\n            </div>\n          )}\n\n          {homeView === 'inspiration' && hasInspirationProjects && (\n            <>\n              {shouldShowInspirationFiltersCard && (\n                <div\n                  className=\"bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hv-surface space-y-4\"\n                  role=\"region\"\n                  aria-label=\"Filtres des projets inspirants\"\n                >\n                  <div className=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\">\n                    <h3 className=\"text-sm font-semibold uppercase tracking-wide text-gray-700\">\n                      Filtres Inspiration\n                    </h3>\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors hv-button ${\n                        hasActiveInspirationFilters\n                          ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }`}\n                      disabled={!hasActiveInspirationFilters}\n                    >\n                      Effacer tous les filtres\n                    </button>\n                  </div>\n                  {activeInspirationFilterChips.length > 0 && (\n                    <div className=\"flex flex-wrap items-center gap-2 text-sm text-gray-600\">\n                      <span className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                        Filtres actifs\n                      </span>\n                      {activeInspirationFilterChips.map((chip) => (\n                        <span\n                          key={chip.id}\n                          className=\"inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700\"\n                        >\n                          <span className=\"font-semibold text-blue-800\">{chip.label} :</span>\n                          <span>{chip.value}</span>\n                          <button\n                            type=\"button\"\n                            onClick={chip.onClear}\n                            className=\"inline-flex h-5 w-5 items-center justify-center rounded-full text-blue-700 transition-colors hover:bg-blue-100\"\n                            aria-label={`Supprimer le filtre ${chip.label}`}\n                          >\n                            <Close className=\"h-3 w-3\" aria-hidden=\"true\" />\n                          </button>\n                        </span>\n                      ))}\n                    </div>\n                  )}\n                  <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5\">\n                    {inspirationFilterFields.map((field) => {\n                      const fieldId = `inspiration-filter-${field.id}`;\n\n                      if (field.type === 'select') {\n                        const value = inspirationFiltersState[field.id] || DEFAULT_SELECT_FILTER_VALUE;\n                        const optionLabel = field.emptyOptionLabel || 'Toutes les valeurs';\n                        const options = inspirationFilterOptions.get(field.id) || [];\n                        return (\n                          <div key={field.id} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                            <label htmlFor={fieldId} className=\"font-semibold text-gray-700\">\n                              {field.label}\n                            </label>\n                            <select\n                              id={fieldId}\n                              value={value}\n                              onChange={(event) =>\n                                setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                              }\n                              className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            >\n                              <option value={DEFAULT_SELECT_FILTER_VALUE}>{optionLabel}</option>\n                              {options.map(option => (\n                                <option key={option} value={option}>\n                                  {option}\n                                </option>\n                              ))}\n                            </select>\n                          </div>\n                        );\n                      }\n\n                      const value = typeof inspirationFiltersState[field.id] === 'string'\n                        ? inspirationFiltersState[field.id]\n                        : '';\n                      return (\n                        <label key={field.id} htmlFor={fieldId} className=\"flex flex-col gap-2 text-sm text-gray-700\">\n                          <span className=\"font-semibold text-gray-700\">{field.label}</span>\n                          <input\n                            id={fieldId}\n                            type=\"text\"\n                            value={value}\n                            onChange={(event) =>\n                              setInspirationFiltersState(prev => ({ ...prev, [field.id]: event.target.value }))\n                            }\n                            className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                            placeholder=\"Rechercher...\"\n                          />\n                        </label>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n\n              {hasFilteredInspirationProjects ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\" role=\"list\">\n                  {filteredInspirationProjects.map(project => renderInspirationCard(project))}\n                </div>\n              ) : (\n                <div\n                  className=\"bg-white border border-dashed border-blue-200 rounded-3xl p-8 text-center text-gray-600 hv-surface\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                >\n                  <p className=\"text-lg font-medium text-gray-800\">Aucun projet ne correspond Ã  vos filtres.</p>\n                  <p className=\"mt-2\">Ajustez vos critÃ¨res ou rÃ©initialisez les filtres.</p>\n                  {hasActiveInspirationFilters && (\n                    <button\n                      type=\"button\"\n                      onClick={handleResetInspirationFilters}\n                      className=\"mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-all hv-button hv-button-primary\"\n                    >\n                      Effacer tous les filtres\n                    </button>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n        </section>\n      </div>\n      {deleteDialogState.isOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div\n            className=\"absolute inset-0 bg-gray-900 bg-opacity-60\"\n            aria-hidden=\"true\"\n            onClick={handleCancelDeleteProject}\n          />\n          <div\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby=\"delete-project-dialog-title\"\n            aria-describedby=\"delete-project-dialog-description\"\n            className=\"relative z-10 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl focus:outline-none hv-surface\"\n          >\n            <div className=\"flex items-start gap-3\">\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600\">\n                <Trash2 className=\"h-6 w-6\" aria-hidden=\"true\" />\n              </div>\n              <div>\n                <h2 id=\"delete-project-dialog-title\" className=\"text-xl font-semibold text-gray-900\">\n                  Supprimer le projet ?\n                </h2>\n                <p id=\"delete-project-dialog-description\" className=\"mt-2 text-sm text-gray-600\">\n                  Vous Ãªtes sur le point de supprimer Â« {pendingDeletionProjectName || 'Projet sans nom'} Â». Cette action est\n                  dÃ©finitive et le projet ne pourra pas Ãªtre restaurÃ©.\n                </p>\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end sm:gap-3\">\n              <button\n                type=\"button\"\n                ref={deleteCancelButtonRef}\n                onClick={handleCancelDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors hv-button hv-focus-ring\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                ref={deleteConfirmButtonRef}\n                onClick={handleConfirmDeleteProject}\n                className=\"inline-flex items-center justify-center rounded-lg border border-red-200 bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition-colors hv-button hv-button-danger\"\n              >\n                Supprimer dÃ©finitivement\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/InspirationDetail.jsx": "import React, { useEffect, useMemo, useState } from '../react.js';\nimport { Edit, Save, Close, Download, Link as LinkIcon } from './icons.js';\nimport { normalizeInspirationFormConfig } from '../utils/inspirationConfig.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\nimport { renderRichText } from '../utils/richText.js';\n\nconst formatValue = (value) => {\n  if (Array.isArray(value)) {\n    const formatted = value\n      .map((item) => (typeof item === 'string' ? item.trim() : ''))\n      .filter(Boolean)\n      .join(', ');\n    return formatted.length > 0 ? formatted : 'Non renseignÃ©';\n  }\n\n  if (typeof value === 'string' && value.trim().length > 0) {\n    return value;\n  }\n  return 'Non renseignÃ©';\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeMultiSelect = (value) =>\n  Array.isArray(value)\n    ? value\n        .map((item) => (typeof item === 'string' ? item.trim() : ''))\n        .filter(Boolean)\n    : [];\n\nexport const InspirationDetail = ({\n  project,\n  formConfig,\n  onBack,\n  onUpdate,\n  onExport\n}) => {\n  const normalizedConfig = useMemo(\n    () => normalizeInspirationFormConfig(formConfig),\n    [formConfig]\n  );\n  const [draft, setDraft] = useState(project);\n  const [editingFields, setEditingFields] = useState({});\n\n  useEffect(() => {\n    setDraft(project);\n    setEditingFields({});\n  }, [project]);\n\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });\n    }\n  }, [project?.id]);\n\n  if (!project) {\n    return null;\n  }\n\n  const enabledFields = normalizedConfig.fields.filter((field) => field.enabled);\n\n  const toggleFieldEditing = (fieldId, isEditing) => {\n    setEditingFields((prev) => ({ ...prev, [fieldId]: isEditing }));\n  };\n\n  const handleFieldChange = (fieldId, value) => {\n    setDraft((prev) => ({ ...prev, [fieldId]: value }));\n  };\n\n  const handleSaveField = (field) => {\n    if (typeof onUpdate !== 'function') {\n      toggleFieldEditing(field.id, false);\n      return;\n    }\n\n    const fieldId = field.id;\n    const fieldType = field.type;\n    const nextValue = draft[fieldId];\n    const updates = {\n      [fieldId]: fieldType === 'documents'\n        ? normalizeDocuments(nextValue)\n        : fieldType === 'multi_select'\n          ? normalizeMultiSelect(nextValue)\n          : nextValue,\n      updatedAt: new Date().toISOString()\n    };\n    onUpdate(project.id, updates);\n    toggleFieldEditing(fieldId, false);\n  };\n\n  const renderField = (field, content) => (\n    <div className=\"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm\">\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\n        <div>\n          <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n            {field.label || field.id}\n          </p>\n          {content}\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          {editingFields[field.id] ? (\n            <>\n              <button\n                type=\"button\"\n                onClick={() => handleSaveField(field)}\n                className=\"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-700\"\n              >\n                <Save className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Sauvegarder\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setDraft(project);\n                  toggleFieldEditing(field.id, false);\n                }}\n                className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-50\"\n              >\n                <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Annuler\n              </button>\n            </>\n          ) : (\n            <button\n              type=\"button\"\n              onClick={() => toggleFieldEditing(field.id, true)}\n              className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n            >\n              <Edit className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Modifier\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n\n  const resolvePlaceholder = (field, fallback) => {\n    if (typeof field.placeholder === 'string' && field.placeholder.trim() !== '') {\n      return field.placeholder.trim();\n    }\n\n    return fallback;\n  };\n\n  const renderEditableField = (field) => {\n    const value = draft?.[field.id] ?? '';\n\n    if (field.type === 'select') {\n      const emptyOptionLabel = resolvePlaceholder(field, 'SÃ©lectionner...');\n      return (\n        <select\n          value={value}\n          onChange={(event) => handleFieldChange(field.id, event.target.value)}\n          className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        >\n          <option value=\"\">{emptyOptionLabel}</option>\n          {(field.options || []).map((option) => (\n            <option key={option} value={option}>\n              {option}\n            </option>\n          ))}\n        </select>\n      );\n    }\n\n    if (field.type === 'multi_select') {\n      const selections = normalizeMultiSelect(value);\n      return (\n        <select\n          multiple\n          value={selections}\n          onChange={(event) =>\n            handleFieldChange(\n              field.id,\n              Array.from(event.target.selectedOptions).map((option) => option.value)\n            )}\n          className=\"mt-2 w-full min-h-[140px] rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        >\n          {(field.options || []).map((option) => (\n            <option key={option} value={option}>\n              {option}\n            </option>\n          ))}\n        </select>\n      );\n    }\n\n    if (field.type === 'long_text') {\n      const fallback = field.id === 'review'\n        ? 'Ajoutez un avis dÃ©taillÃ©...'\n        : 'Saisissez une description dÃ©taillÃ©e...';\n      return (\n        <div className=\"mt-2\">\n          <RichTextEditor\n            id={`inspiration-${field.id}`}\n            value={value}\n            onChange={(nextValue) => handleFieldChange(field.id, nextValue)}\n            ariaLabel={`${field.label} (Ã©dition riche)`}\n            placeholder={resolvePlaceholder(field, fallback)}\n            compact\n          />\n        </div>\n      );\n    }\n\n    if (field.type === 'documents') {\n      return (\n        <div className=\"mt-2 space-y-3\">\n          {normalizeDocuments(value).map((doc, index) => (\n            <div key={`doc-${index}`} className=\"grid grid-cols-1 gap-2 md:grid-cols-2\">\n              <input\n                type=\"text\"\n                value={doc.name}\n                onChange={(event) => {\n                  const nextDocs = normalizeDocuments(value);\n                  nextDocs[index] = { ...doc, name: event.target.value };\n                  handleFieldChange(field.id, nextDocs);\n                }}\n                className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n              />\n              <input\n                type=\"url\"\n                value={doc.url}\n                onChange={(event) => {\n                  const nextDocs = normalizeDocuments(value);\n                  nextDocs[index] = { ...doc, url: event.target.value };\n                  handleFieldChange(field.id, nextDocs);\n                }}\n                className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n              />\n            </div>\n          ))}\n          <button\n            type=\"button\"\n            onClick={() =>\n              handleFieldChange(field.id, [\n                ...normalizeDocuments(value),\n                { name: '', url: '' }\n              ])\n            }\n            className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n          >\n            Ajouter un document\n          </button>\n          <p className=\"text-xs text-amber-600\">\n            Les fichiers doivent bien Ãªtre partagÃ©s aux collaborateurs LFB.\n          </p>\n        </div>\n      );\n    }\n\n    const inputType = field.type === 'url' ? 'url' : 'text';\n    const placeholder = resolvePlaceholder(field, field.type === 'url' ? 'https://...' : '');\n\n    return (\n      <input\n        type={inputType}\n        value={value}\n        onChange={(event) => handleFieldChange(field.id, event.target.value)}\n        className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n        placeholder={placeholder}\n      />\n    );\n  };\n\n  const renderDisplayField = (field) => {\n    const value = project?.[field.id];\n\n    if (field.type === 'long_text') {\n      return (\n        <p className=\"mt-2 text-sm text-gray-700\">\n          {value?.trim() ? renderRichText(value) : formatValue(value)}\n        </p>\n      );\n    }\n\n    if (field.type === 'documents') {\n      const docs = normalizeDocuments(value);\n      return (\n        <div className=\"mt-2 space-y-2 text-sm text-gray-700\">\n          {docs.length > 0 ? (\n            docs.map((doc, index) => (\n              <div key={`doc-view-${index}`} className=\"flex flex-col\">\n                <span className=\"font-medium\">{doc.name || 'Document'}</span>\n                {doc.url && (\n                  <a\n                    href={doc.url}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-blue-600 hover:underline\"\n                  >\n                    {doc.url}\n                  </a>\n                )}\n              </div>\n            ))\n          ) : (\n            <p>Non renseignÃ©</p>\n          )}\n        </div>\n      );\n    }\n\n    if (field.type === 'multi_select') {\n      const selections = normalizeMultiSelect(value);\n      return (\n        <p className=\"mt-2 text-sm text-gray-700\">\n          {selections.length > 0 ? selections.join(', ') : 'Non renseignÃ©'}\n        </p>\n      );\n    }\n\n    if (field.type === 'url') {\n      return value ? (\n        <a\n          href={value}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"mt-2 inline-flex items-center gap-2 text-sm text-blue-600 hover:underline\"\n        >\n          <LinkIcon className=\"h-4 w-4\" aria-hidden=\"true\" />\n          {value}\n        </a>\n      ) : (\n        <p className=\"mt-2 text-sm text-gray-700\">Non renseignÃ©</p>\n      );\n    }\n\n    return <p className=\"mt-2 text-sm text-gray-700\">{formatValue(value)}</p>;\n  };\n\n  const visibilityLabel = project.visibility === 'shared' ? 'PartagÃ©' : 'Personnel';\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        <header className=\"rounded-3xl border border-gray-200 bg-white p-6 shadow-lg\">\n          <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\n            <div>\n              <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-600\">Fiche projet inspirant</p>\n              <h1 className=\"text-3xl font-bold text-gray-900\">{project.title}</h1>\n              <p className=\"mt-1 text-sm text-gray-500\">\n                {project.labName} Â· {project.country}\n              </p>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              <button\n                type=\"button\"\n                onClick={() => onExport?.(project)}\n                className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-100\"\n              >\n                <Download className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Enregistrer\n              </button>\n              <button\n                type=\"button\"\n                onClick={onBack}\n                className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n              >\n                <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n                Retour\n              </button>\n            </div>\n          </div>\n\n          <div className=\"mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div>\n              <p className=\"text-xs text-gray-500\">Mode de partage</p>\n              <p className=\"text-sm font-semibold text-gray-700\">{visibilityLabel}</p>\n            </div>\n            <div\n              className=\"inline-flex items-center rounded-full border border-blue-200 bg-blue-50 p-1\"\n              role=\"group\"\n              aria-label=\"Mode de partage\"\n            >\n              <button\n                type=\"button\"\n                onClick={() => onUpdate(project.id, { visibility: 'personal', updatedAt: new Date().toISOString() })}\n                className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                  project.visibility !== 'shared'\n                    ? 'bg-blue-600 text-white'\n                    : 'text-blue-700 hover:bg-blue-100'\n                }`}\n              >\n                Personnel\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => onUpdate(project.id, { visibility: 'shared', updatedAt: new Date().toISOString() })}\n                className={`rounded-full px-4 py-2 text-xs font-semibold transition-colors ${\n                  project.visibility === 'shared'\n                    ? 'bg-blue-600 text-white'\n                    : 'text-blue-700 hover:bg-blue-100'\n                }`}\n              >\n                PartagÃ©\n              </button>\n            </div>\n          </div>\n        </header>\n\n        <div className=\"grid grid-cols-1 gap-4\">\n          {enabledFields.map((field) => (\n            <React.Fragment key={field.id}>\n              {renderField(\n                field,\n                editingFields[field.id] ? renderEditableField(field) : renderDisplayField(field)\n              )}\n            </React.Fragment>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/InspirationForm.jsx": "import React, { useEffect, useMemo, useRef, useState } from '../react.js';\nimport { Plus, Save, Close } from './icons.js';\nimport { normalizeInspirationFormConfig } from '../utils/inspirationConfig.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\n\nconst buildInitialFormState = (config) => {\n  const fields = Array.isArray(config?.fields) ? config.fields : [];\n  const initialState = {};\n\n  fields.forEach((field) => {\n    if (!field) {\n      return;\n    }\n\n    if (field.type === 'documents') {\n      initialState[field.id] = [{ name: '', url: '' }];\n      return;\n    }\n\n    if (field.type === 'multi_select') {\n      initialState[field.id] = [];\n      return;\n    }\n\n    initialState[field.id] = '';\n  });\n\n  return initialState;\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeMultiSelect = (value) =>\n  Array.isArray(value)\n    ? value\n        .map((item) => (typeof item === 'string' ? item.trim() : ''))\n        .filter(Boolean)\n    : [];\n\nconst renderFieldLabel = (field) => {\n  if (!field) {\n    return '';\n  }\n\n  return field.required ? `${field.label} *` : field.label;\n};\n\nexport const InspirationForm = ({\n  formConfig,\n  existingProjects = [],\n  onSubmit,\n  onCancel\n}) => {\n  const normalizedConfig = useMemo(\n    () => normalizeInspirationFormConfig(formConfig),\n    [formConfig]\n  );\n  const formTopRef = useRef(null);\n  const [formState, setFormState] = useState(() => buildInitialFormState(normalizedConfig));\n  const [errors, setErrors] = useState({});\n\n  const labSuggestions = useMemo(() => {\n    const suggestions = new Set();\n    existingProjects.forEach((project) => {\n      const name = typeof project?.labName === 'string' ? project.labName.trim() : '';\n      if (name.length > 0) {\n        suggestions.add(name);\n      }\n    });\n    return Array.from(suggestions).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));\n  }, [existingProjects]);\n\n  useEffect(() => {\n    setFormState((prev) => {\n      const baseState = buildInitialFormState(normalizedConfig);\n      const merged = { ...baseState, ...prev };\n\n      normalizedConfig.fields.forEach((field) => {\n        if (field.type !== 'documents') {\n          if (field.type === 'multi_select' && !Array.isArray(merged[field.id])) {\n            merged[field.id] = baseState[field.id];\n          }\n          return;\n        }\n\n        if (!Array.isArray(merged[field.id]) || merged[field.id].length === 0) {\n          merged[field.id] = baseState[field.id];\n        }\n      });\n\n      return merged;\n    });\n  }, [normalizedConfig]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const focusTarget = formTopRef.current;\n    const scrollToTop = () => {\n      if (!focusTarget) {\n        return;\n      }\n\n      if (typeof focusTarget.scrollIntoView === 'function') {\n        focusTarget.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });\n      } else if (typeof window.scrollTo === 'function') {\n        window.scrollTo({ top: 0, behavior: 'smooth' });\n      }\n\n      if (typeof focusTarget.focus === 'function') {\n        focusTarget.focus({ preventScroll: true });\n      }\n    };\n\n    if (typeof window.requestAnimationFrame === 'function') {\n      window.requestAnimationFrame(scrollToTop);\n      return;\n    }\n\n    scrollToTop();\n  }, []);\n\n  const updateField = (fieldId, value) => {\n    setFormState((prev) => ({ ...prev, [fieldId]: value }));\n  };\n\n  const handleDocumentChange = (fieldId, index, key, value) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      const target = nextDocuments[index] || { name: '', url: '' };\n      nextDocuments[index] = { ...target, [key]: value };\n      return { ...prev, [fieldId]: nextDocuments };\n    });\n  };\n\n  const handleAddDocument = (fieldId) => {\n    setFormState((prev) => ({\n      ...prev,\n      [fieldId]: [...(prev[fieldId] || []), { name: '', url: '' }]\n    }));\n  };\n\n  const handleRemoveDocument = (fieldId, index) => {\n    setFormState((prev) => {\n      const nextDocuments = Array.isArray(prev[fieldId]) ? prev[fieldId].slice() : [];\n      nextDocuments.splice(index, 1);\n      return {\n        ...prev,\n        [fieldId]: nextDocuments.length > 0 ? nextDocuments : [{ name: '', url: '' }]\n      };\n    });\n  };\n\n  const validate = () => {\n    const nextErrors = {};\n\n    normalizedConfig.fields.forEach((field) => {\n      if (!field.enabled || !field.required) {\n        return;\n      }\n\n      const value = formState[field.id];\n      if (field.type === 'documents') {\n        const normalizedDocs = normalizeDocuments(value);\n        if (normalizedDocs.length === 0) {\n          nextErrors[field.id] = 'Veuillez renseigner au moins un document.';\n        }\n        return;\n      }\n\n      if (field.type === 'multi_select') {\n        const normalizedSelections = normalizeMultiSelect(value);\n        if (normalizedSelections.length === 0) {\n          nextErrors[field.id] = 'Veuillez sÃ©lectionner au moins une option.';\n        }\n        return;\n      }\n\n      if (value == null || (typeof value === 'string' && value.trim().length === 0)) {\n        nextErrors[field.id] = 'Ce champ est requis.';\n      }\n    });\n\n    setErrors(nextErrors);\n    return Object.keys(nextErrors).length === 0;\n  };\n\n  const handleSubmit = (event) => {\n    event.preventDefault();\n    if (!validate()) {\n      return;\n    }\n\n    const now = new Date().toISOString();\n    const payload = normalizedConfig.fields.reduce((acc, field) => {\n      if (!field.enabled) {\n        return acc;\n      }\n\n      if (field.type === 'documents') {\n        acc[field.id] = normalizeDocuments(formState[field.id]);\n        return acc;\n      }\n\n      if (field.type === 'multi_select') {\n        acc[field.id] = normalizeMultiSelect(formState[field.id]);\n        return acc;\n      }\n\n      const value = formState[field.id];\n      if (typeof value === 'string') {\n        acc[field.id] = value.trim();\n        return acc;\n      }\n\n      acc[field.id] = value ?? '';\n      return acc;\n    }, {});\n\n    payload.visibility = 'personal';\n    payload.createdAt = now;\n    payload.updatedAt = now;\n\n    if (typeof onSubmit === 'function') {\n      onSubmit(payload);\n    }\n  };\n\n  return (\n    <div\n      ref={formTopRef}\n      tabIndex={-1}\n      className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100 px-4 py-8 sm:px-8 focus:outline-none\"\n    >\n      <div className=\"max-w-4xl mx-auto\">\n        <header className=\"mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-600\">\n              Nouvel exemple inspirant\n            </p>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Questionnaire projet inspiration</h1>\n            <p className=\"mt-2 text-sm text-gray-600\">\n              Documentez un projet inspirant issu d'un autre laboratoire afin d'enrichir la base d'exemples.\n            </p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={onCancel}\n            className=\"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n          >\n            <Close className=\"h-4 w-4\" aria-hidden=\"true\" />\n            Retour\n          </button>\n        </header>\n\n        <form\n          onSubmit={handleSubmit}\n          className=\"space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-lg\"\n        >\n          <p className=\"text-xs italic text-gray-400\">\n            Le LFB traite les donnÃ©es recueillies pour gÃ©rer les projets Ã  soumettre aux Ã©quipes compliance.{' '}\n            <a\n              href=\"./mentions-legales.html\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"underline hover:text-gray-500\"\n            >\n              En savoir plus sur vos donnÃ©es et vos droits\n            </a>\n          </p>\n          <div className=\"grid grid-cols-1 gap-6 md:grid-cols-2\">\n            {normalizedConfig.fields\n              .filter((field) => field.enabled && field.type !== 'long_text' && field.type !== 'documents')\n              .map((field) => {\n                if (field.type === 'select') {\n                  const emptyOptionLabel = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'SÃ©lectionner...';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        value={formState[field.id] || ''}\n                        onChange={(event) => updateField(field.id, event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        <option value=\"\">{emptyOptionLabel}</option>\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.type === 'multi_select') {\n                  const selectedValues = Array.isArray(formState[field.id]) ? formState[field.id] : [];\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <select\n                        multiple\n                        value={selectedValues}\n                        onChange={(event) =>\n                          updateField(\n                            field.id,\n                            Array.from(event.target.selectedOptions).map((option) => option.value)\n                          )}\n                        className=\"min-h-[120px] rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      >\n                        {(field.options || []).map((option) => (\n                          <option key={option} value={option}>\n                            {option}\n                          </option>\n                        ))}\n                      </select>\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                if (field.id === 'labName') {\n                  const placeholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                    ? field.placeholder.trim()\n                    : 'Nom du laboratoire';\n\n                  return (\n                    <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                      <span>{renderFieldLabel(field)}</span>\n                      <input\n                        type=\"text\"\n                        list=\"inspiration-labs\"\n                        value={formState.labName}\n                        onChange={(event) => updateField('labName', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                        placeholder={placeholder}\n                      />\n                      {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                    </label>\n                  );\n                }\n\n                const inputType = field.type === 'url' ? 'url' : 'text';\n                const inputPlaceholder = typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                  ? field.placeholder.trim()\n                  : field.type === 'url'\n                    ? 'https://...'\n                    : '';\n\n                return (\n                  <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                    <span>{renderFieldLabel(field)}</span>\n                    <input\n                      type={inputType}\n                      value={formState[field.id] || ''}\n                      onChange={(event) => updateField(field.id, event.target.value)}\n                      className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                      placeholder={inputPlaceholder}\n                    />\n                    {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n                  </label>\n                );\n              })}\n          </div>\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'long_text')\n            .map((field) => (\n              <label key={field.id} className=\"flex flex-col gap-2 text-sm font-medium text-gray-700\">\n                <span>{renderFieldLabel(field)}</span>\n                <RichTextEditor\n                  id={`inspiration-${field.id}`}\n                  value={formState[field.id] || ''}\n                  onChange={(value) => updateField(field.id, value)}\n                  ariaLabel={`${field.label} (Ã©dition riche)`}\n                  placeholder={\n                    typeof field.placeholder === 'string' && field.placeholder.trim() !== ''\n                      ? field.placeholder.trim()\n                      : field.id === 'review'\n                        ? 'Ajoutez votre avis dÃ©taillÃ© sur ce projet inspirant...'\n                        : 'Saisir une description dÃ©taillÃ©e...'\n                  }\n                  compact\n                />\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </label>\n            ))}\n\n          {normalizedConfig.fields\n            .filter((field) => field.enabled && field.type === 'documents')\n            .map((field) => (\n              <div key={field.id} className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-gray-700\">{renderFieldLabel(field)}</p>\n                    <p className=\"text-xs text-gray-500\">\n                      Ajoutez plusieurs documents (nom + URL).\n                    </p>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={() => handleAddDocument(field.id)}\n                    className=\"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs font-semibold text-blue-700 hover:bg-blue-100\"\n                  >\n                    <Plus className=\"h-4 w-4\" aria-hidden=\"true\" />\n                    Ajouter\n                  </button>\n                </div>\n                <p className=\"text-xs text-amber-600\">\n                  Les fichiers doivent bien Ãªtre partagÃ©s aux collaborateurs LFB.\n                </p>\n                <div className=\"space-y-3\">\n                  {(formState[field.id] || []).map((doc, index) => (\n                    <div\n                      key={`doc-${index}`}\n                      className=\"grid grid-cols-1 gap-3 rounded-xl border border-gray-200 bg-gray-50 p-3 md:grid-cols-[1fr_1fr_auto]\"\n                    >\n                      <input\n                        type=\"text\"\n                        value={doc.name}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'name', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"Nom du document\"\n                      />\n                      <input\n                        type=\"url\"\n                        value={doc.url}\n                        onChange={(event) => handleDocumentChange(field.id, index, 'url', event.target.value)}\n                        className=\"rounded-lg border border-gray-300 px-3 py-2 text-sm\"\n                        placeholder=\"https://...\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemoveDocument(field.id, index)}\n                        className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-100\"\n                      >\n                        Retirer\n                      </button>\n                    </div>\n                  ))}\n                </div>\n                {errors[field.id] && <span className=\"text-xs text-red-600\">{errors[field.id]}</span>}\n              </div>\n            ))}\n\n          <datalist id=\"inspiration-labs\">\n            {labSuggestions.map((suggestion) => (\n              <option key={suggestion} value={suggestion} />\n            ))}\n          </datalist>\n\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:justify-end\">\n            <button\n              type=\"button\"\n              onClick={onCancel}\n              className=\"inline-flex items-center justify-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-50\"\n            >\n              Annuler\n            </button>\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700\"\n            >\n              <Save className=\"h-4 w-4\" aria-hidden=\"true\" />\n              Enregistrer le projet\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/MandatoryQuestionsSummary.jsx": "import React, { useEffect, useState } from '../react.js';\nimport { AlertTriangle, CheckCircle, ChevronRight } from './icons.js';\n\nexport const MandatoryQuestionsSummary = ({\n  pendingQuestions = [],\n  totalQuestions = 0,\n  onBackToQuestionnaire,\n  onNavigateToQuestion,\n  onProceedToSynthesis\n}) => {\n  const hasPending = pendingQuestions.length > 0;\n  const [showIncompleteAlert, setShowIncompleteAlert] = useState(false);\n\n  useEffect(() => {\n    if (!hasPending) {\n      setShowIncompleteAlert(false);\n    }\n  }, [hasPending]);\n\n  const handleNavigate = (questionId) => {\n    if (typeof onNavigateToQuestion === 'function') {\n      onNavigateToQuestion(questionId);\n    }\n  };\n\n  const handleBack = () => {\n    if (typeof onBackToQuestionnaire === 'function') {\n      onBackToQuestionnaire();\n    }\n  };\n\n  const handleProceed = () => {\n    if (hasPending) {\n      setShowIncompleteAlert(true);\n      return;\n    }\n\n    setShowIncompleteAlert(false);\n\n    if (typeof onProceedToSynthesis === 'function') {\n      onProceedToSynthesis();\n    }\n  };\n\n  const proceedButtonClassName = `w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition-all hv-button hv-button-primary ${\n    hasPending ? 'opacity-60 cursor-not-allowed focus:outline-none focus:ring-0' : ''\n  }`;\n\n  return (\n    <div className=\"py-10 px-4 sm:px-8\">\n      <div className=\"max-w-4xl mx-auto\">\n        <div className=\"bg-white border border-gray-200 rounded-2xl shadow-sm p-6 sm:p-8 space-y-6 hv-surface\">\n          <div className=\"flex items-start gap-4\">\n            {hasPending ? (\n              <AlertTriangle className=\"w-6 h-6 text-yellow-500 mt-1\" />\n            ) : (\n              <CheckCircle className=\"w-6 h-6 text-emerald-500 mt-1\" />\n            )}\n            <div>\n              <h2 className=\"text-xl font-bold text-gray-900\">\n                {hasPending\n                  ? 'Questions obligatoires Ã  complÃ©ter'\n                  : 'Toutes les questions obligatoires sont complÃ©tÃ©es'}\n              </h2>\n              <p className=\"text-sm text-gray-600 mt-1\">\n                {hasPending\n                  ? 'Veuillez complÃ©ter ces rÃ©ponses avant de pouvoir accÃ©der Ã  la synthÃ¨se du projet.'\n                  : 'Vous pouvez dÃ©sormais consulter la synthÃ¨se du projet.'}\n              </p>\n            </div>\n          </div>\n\n          {hasPending ? (\n            <ul className=\"space-y-4\" aria-label=\"Questions obligatoires non rÃ©pondues\">\n              {pendingQuestions.map(({ question, position }) => {\n                const questionNumber = position > 0 ? position : null;\n                const positionLabel =\n                  questionNumber && totalQuestions\n                    ? `Question ${questionNumber} sur ${totalQuestions}`\n                    : 'Question obligatoire';\n\n                return (\n                  <li\n                    key={question.id}\n                    className=\"border border-yellow-200 rounded-xl bg-yellow-50 p-4 sm:p-5 hv-surface\"\n                  >\n                    <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n                      <div>\n                        <p className=\"text-xs font-semibold uppercase tracking-wide text-yellow-700\">{positionLabel}</p>\n                        <p className=\"mt-2 text-sm sm:text-base font-medium text-gray-900\">{question.question}</p>\n                        {question.guidance?.objective && (\n                          <p className=\"mt-1 text-xs text-gray-600\">\n                            {question.guidance.objective}\n                          </p>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <button\n                          type=\"button\"\n                          onClick={() => handleNavigate(question.id)}\n                          className=\"inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium bg-white text-yellow-700 border border-yellow-300 hover:bg-yellow-100 transition-all hv-button\"\n                        >\n                          ComplÃ©ter la question\n                          <ChevronRight className=\"w-4 h-4 ml-2\" />\n                        </button>\n                      </div>\n                    </div>\n                  </li>\n                );\n              })}\n            </ul>\n          ) : (\n            <div className=\"border border-emerald-200 rounded-xl bg-emerald-50 p-4 sm:p-5 hv-surface\">\n              <p className=\"text-sm text-emerald-800\">\n                Toutes les rÃ©ponses obligatoires ont Ã©tÃ© fournies. Vous pouvez gÃ©nÃ©rer la synthÃ¨se quand vous le souhaitez.\n              </p>\n            </div>\n          )}\n\n          {showIncompleteAlert && hasPending && (\n            <div className=\"border border-yellow-200 rounded-xl bg-yellow-50 p-4 text-yellow-800 flex items-start gap-3\" role=\"alert\" aria-live=\"assertive\">\n              <AlertTriangle className=\"w-5 h-5 mt-0.5\" />\n              <div>\n                <p className=\"text-sm font-semibold\">ComplÃ©tez les rÃ©ponses obligatoires</p>\n                <p className=\"text-sm\">\n                  Vous devez rÃ©pondre Ã  toutes les questions obligatoires avant de pouvoir accÃ©der Ã  la synthÃ¨se du projet.\n                </p>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <button\n              type=\"button\"\n              onClick={handleBack}\n              className=\"w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 rounded-lg font-medium text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all hv-button\"\n            >\n              Retour au questionnaire\n            </button>\n            <button\n              type=\"button\"\n              onClick={handleProceed}\n              aria-disabled={hasPending}\n              className={proceedButtonClassName}\n            >\n              AccÃ©der Ã  la synthÃ¨se\n              <ChevronRight className=\"w-5 h-5 ml-2\" />\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/ProjectShowcase.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  CheckCircle,\n  Edit,\n  Plus,\n  Trash2\n} from './icons.js';\nimport { formatAnswer } from '../utils/questions.js';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { initialShowcaseThemes } from '../data/showcaseThemes.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\n\nconst SHOWCASE_SECTION_OPTIONS = [\n  { id: 'notice', label: 'Message de complÃ©tude' },\n  { id: 'hero', label: 'Hero du projet' },\n  { id: 'problem', label: 'Le problÃ¨me' },\n  { id: 'solution', label: 'La rÃ©ponse' },\n  { id: 'innovation', label: 'DiffÃ©renciation & impact' },\n  { id: 'team', label: 'Ã‰quipe & alliances' },\n  { id: 'timeline', label: 'Feuille de route' }\n];\n\nconst MAX_CUSTOM_SECTION_COLUMNS = 4;\n\nconst SECTION_TEMPLATES = [\n  {\n    id: 'highlight',\n    name: 'Bloc mise en avant',\n    description: 'Un bandeau court pour mettre un chiffre ou une promesse clÃ© en lumiÃ¨re.',\n    placeholder: {\n      title: 'Impact attendu',\n      description: 'Un message synthÃ©tique pour convaincre immÃ©diatement.',\n      badge: 'Badge'\n    }\n  },\n  {\n    id: 'aurora-section__inner',\n    name: 'Chiffre en avant',\n    description: 'Un format percutant pour faire ressortir un indicateur majeur.',\n    placeholder: {\n      title: 'Chiffre clÃ©',\n      description: 'Mettez en lumiÃ¨re un KPI, un taux ou un volume essentiel.',\n      badge: 'KPI'\n    }\n  },\n  {\n    id: 'columns',\n    name: 'Bloc multi-colonnes',\n    description: 'Un contenu rÃ©parti sur plusieurs colonnes pour comparer ou structurer lâ€™information.',\n    placeholder: {\n      title: 'Points clÃ©s par axe',\n      subtitle: 'Une synthÃ¨se rapide Ã  plusieurs voix',\n      columns: [\n        'Colonne 1 : rappels stratÃ©giques et contexte.',\n        'Colonne 2 : bÃ©nÃ©fices Ã  retenir pour les Ã©quipes.',\n        'Colonne 3 : prochaines Ã©tapes prioritaires.'\n      ],\n      columnCount: 3\n    }\n  },\n  {\n    id: 'document-viewer',\n    name: 'Visionneuse documentaire',\n    description: 'Un titre, un sous-titre et une visionneuse intÃ©grÃ©e pour un document SharePoint.',\n    placeholder: {\n      title: 'Document de rÃ©fÃ©rence',\n      subtitle: 'AccÃ¨s rapide aux supports projet',\n      description: 'Ajoutez un lien SharePoint (PDF, image ou prÃ©sentation) pour lâ€™afficher directement.',\n      documentUrl: 'https://votre-tenant.sharepoint.com/sites/projet/Shared%20Documents/brief.pdf',\n      documentType: 'pdf',\n      accent: 'SharePoint'\n    }\n  },\n  {\n    id: 'story',\n    name: 'Bloc narratif',\n    description: 'Un encart avec un titre et un texte riche pour raconter une Ã©tape clÃ©.',\n    placeholder: {\n      title: 'Une histoire qui marque',\n      description: 'Ajoutez un paragraphe clair, des liens et des Ã©lÃ©ments de contexte.'\n    }\n  },\n  {\n    id: 'checklist',\n    name: 'Points dâ€™attention',\n    description: 'Une liste courte pour dÃ©tailler des livrables, risques ou actions Ã  suivre.',\n    placeholder: {\n      title: 'Nos prioritÃ©s',\n      description: 'Listez 3 Ã  5 Ã©lÃ©ments concrets Ã  surveiller.',\n      items: ['Point clÃ© #1', 'Point clÃ© #2', 'Point clÃ© #3']\n    }\n  }\n];\n\nconst SECTION_TEMPLATE_CONFIG = {\n  highlight: {\n    showSubtitle: false,\n    showAccent: false,\n    showBadge: true,\n    showDescription: true,\n    showColumns: false,\n    showDocument: false,\n    showItems: false\n  },\n  'aurora-section__inner': {\n    showSubtitle: false,\n    showAccent: false,\n    showBadge: true,\n    showDescription: true,\n    showColumns: false,\n    showDocument: false,\n    showItems: false\n  },\n  columns: {\n    showSubtitle: true,\n    showAccent: false,\n    showBadge: false,\n    showDescription: false,\n    showColumns: true,\n    showDocument: false,\n    showItems: false\n  },\n  'document-viewer': {\n    showSubtitle: true,\n    showAccent: true,\n    showBadge: false,\n    showDescription: true,\n    showColumns: false,\n    showDocument: true,\n    showItems: false\n  },\n  story: {\n    showSubtitle: false,\n    showAccent: false,\n    showBadge: false,\n    showDescription: true,\n    showColumns: false,\n    showDocument: false,\n    showItems: false\n  },\n  checklist: {\n    showSubtitle: false,\n    showAccent: false,\n    showBadge: false,\n    showDescription: true,\n    showColumns: false,\n    showDocument: false,\n    showItems: true\n  }\n};\n\nconst buildDefaultLightSectionSelection = (sectionIds = SHOWCASE_SECTION_OPTIONS.map(section => section.id)) =>\n  sectionIds.reduce((acc, sectionId) => {\n    acc[sectionId] = true;\n    return acc;\n  }, {});\n\nconst DOCUMENT_VIEWER_TYPES = [\n  { id: 'pdf', label: 'PDF' },\n  { id: 'jpg', label: 'JPG' },\n  { id: 'png', label: 'PNG' },\n  { id: 'pptx', label: 'PPTX' }\n];\n\nconst resolveCustomSectionColumnCount = (value, columns = []) => {\n  const parsed = Number.parseInt(value, 10);\n  if (Number.isFinite(parsed) && parsed > 0) {\n    return Math.min(MAX_CUSTOM_SECTION_COLUMNS, parsed);\n  }\n  if (Array.isArray(columns) && columns.length > 0) {\n    return Math.min(MAX_CUSTOM_SECTION_COLUMNS, columns.length);\n  }\n  return 1;\n};\n\nconst normalizeCustomSectionColumns = (columns, columnCount) => {\n  const normalized = Array.isArray(columns)\n    ? columns.map(column => (typeof column === 'string' ? column.trim() : ''))\n    : [];\n  const boundedColumns = normalized.slice(0, columnCount);\n  while (boundedColumns.length < columnCount) {\n    boundedColumns.push('');\n  }\n  return boundedColumns;\n};\n\nconst isSharePointUrl = (value) => {\n  if (typeof value !== 'string') {\n    return false;\n  }\n\n  return value.toLowerCase().includes('sharepoint');\n};\n\nconst resolveDocumentEmbedSrc = (documentUrl, documentType) => {\n  if (!documentUrl) {\n    return '';\n  }\n\n  if (['jpg', 'png'].includes(documentType)) {\n    return documentUrl;\n  }\n\n  if (documentUrl.includes('officeapps.live.com')) {\n    return documentUrl;\n  }\n\n  return `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(documentUrl)}`;\n};\n\nconst resolveTemplateConfig = (templateId) =>\n  SECTION_TEMPLATE_CONFIG[templateId] || SECTION_TEMPLATE_CONFIG.highlight;\n\nconst sanitizeCustomSections = (rawSections) => {\n  if (!Array.isArray(rawSections)) {\n    return [];\n  }\n\n  return rawSections\n    .map((section, index) => {\n      if (!section || typeof section !== 'object') {\n        return null;\n      }\n\n      const id = typeof section.id === 'string' && section.id.trim().length > 0\n        ? section.id.trim()\n        : `custom-section-${index}`;\n\n      const title = typeof section.title === 'string' ? section.title.trim() : '';\n      const subtitle = typeof section.subtitle === 'string' ? section.subtitle.trim() : '';\n      const description = typeof section.description === 'string' ? section.description.trim() : '';\n      const accent = typeof section.accent === 'string' ? section.accent.trim() : '';\n      const documentUrl = typeof section.documentUrl === 'string' ? section.documentUrl.trim() : '';\n      const documentType = typeof section.documentType === 'string' ? section.documentType.trim() : '';\n      const items = Array.isArray(section.items)\n        ? section.items.map(item => (typeof item === 'string' ? item.trim() : '')).filter(Boolean)\n        : [];\n      const type = typeof section.type === 'string' ? section.type : SECTION_TEMPLATES[0].id;\n      const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n      const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n      const hasColumnContent = columns.some(column => column.length > 0);\n\n      if (!title && !subtitle && !description && !documentUrl && items.length === 0 && !hasColumnContent) {\n        return null;\n      }\n\n      return {\n        id,\n        type,\n        title,\n        subtitle,\n        description,\n        accent,\n        documentUrl,\n        documentType,\n        items,\n        columnCount,\n        columns\n      };\n    })\n    .filter(Boolean);\n};\n\nconst normalizeSectionOrder = (rawOrder, customSections) => {\n  const baseOrder = SHOWCASE_SECTION_OPTIONS.map(section => section.id);\n  const customIds = Array.isArray(customSections) ? customSections.map(section => section.id) : [];\n  const fallbackOrder = [...baseOrder, ...customIds];\n\n  if (!Array.isArray(rawOrder)) {\n    return fallbackOrder;\n  }\n\n  const knownIds = new Set(fallbackOrder);\n  const seen = new Set();\n  const normalized = [];\n\n  rawOrder.forEach(entry => {\n    if (typeof entry !== 'string' || !knownIds.has(entry) || seen.has(entry)) {\n      return;\n    }\n    normalized.push(entry);\n    seen.add(entry);\n  });\n\n  fallbackOrder.forEach(entry => {\n    if (!seen.has(entry)) {\n      normalized.push(entry);\n    }\n  });\n\n  return normalized;\n};\n\nconst areCustomSectionsEqual = (previous, next) => {\n  if (!Array.isArray(previous) && !Array.isArray(next)) {\n    return true;\n  }\n\n  if (!Array.isArray(previous) || !Array.isArray(next) || previous.length !== next.length) {\n    return false;\n  }\n\n  return previous.every((entry, index) => {\n    const candidate = next[index];\n    if (!candidate) {\n      return false;\n    }\n\n    return entry.id === candidate.id\n      && entry.title === candidate.title\n      && entry.subtitle === candidate.subtitle\n      && entry.description === candidate.description\n      && entry.accent === candidate.accent\n      && entry.documentUrl === candidate.documentUrl\n      && entry.documentType === candidate.documentType\n      && JSON.stringify(entry.items || []) === JSON.stringify(candidate.items || [])\n      && entry.columnCount === candidate.columnCount\n      && JSON.stringify(entry.columns || []) === JSON.stringify(candidate.columns || [])\n      && entry.type === candidate.type;\n  });\n};\n\nconst MISSING_INFO_LABEL = 'Information Ã  complÃ©ter';\n\nconst findQuestionById = (questions, id) => {\n  if (!Array.isArray(questions)) {\n    return null;\n  }\n\n  return questions.find(question => question?.id === id) || null;\n};\n\nconst getFormattedAnswer = (questions, answers, id) => {\n  const question = findQuestionById(questions, id);\n  if (!question) {\n    return '';\n  }\n\n  const formatted = formatAnswer(question, answers?.[id]);\n\n  if (typeof formatted === 'string') {\n    const trimmed = formatted.trim();\n    if (trimmed.length > 0) {\n      return trimmed;\n    }\n  } else if (formatted) {\n    return formatted;\n  }\n\n  return question.required ? MISSING_INFO_LABEL : '';\n};\n\nconst getRawAnswer = (answers, id) => {\n  if (!answers) {\n    return undefined;\n  }\n\n  return answers[id];\n};\n\nconst hasText = (value) => typeof value === 'string' && value.trim().length > 0;\n\nconst formatNumberFR = (value, options = {}) => {\n  const numericValue = Number(value);\n  if (!Number.isFinite(numericValue)) {\n    return '';\n  }\n\n  return numericValue.toLocaleString('fr-FR', options);\n};\n\nconst formatWeeksValue = (weeks) => {\n  if (weeks === undefined || weeks === null) {\n    return '';\n  }\n\n  const rounded = Math.round(weeks * 10) / 10;\n  const hasDecimal = Math.abs(rounded - Math.round(rounded)) > 0.0001;\n\n  return `${formatNumberFR(rounded, {\n    minimumFractionDigits: hasDecimal ? 1 : 0,\n    maximumFractionDigits: hasDecimal ? 1 : 0\n  })} sem.`;\n};\n\nconst formatDaysValue = (days) => {\n  if (days === undefined || days === null) {\n    return '';\n  }\n\n  return `${formatNumberFR(Math.round(days))} j.`;\n};\n\nconst resolveQuestionTitle = (questions, id) => {\n  if (!id) {\n    return '';\n  }\n\n  const question = findQuestionById(questions, id);\n  return question?.question || id;\n};\n\nconst formatTimingRequirementSummary = (questions, constraint) => {\n  if (!constraint || typeof constraint !== 'object') {\n    return '';\n  }\n\n  const startLabel = resolveQuestionTitle(questions, constraint.startQuestion);\n  const endLabel = resolveQuestionTitle(questions, constraint.endQuestion);\n\n  const requirementParts = [];\n  if (typeof constraint.minimumWeeks === 'number') {\n    requirementParts.push(`${formatNumberFR(constraint.minimumWeeks)} sem.`);\n  }\n  if (typeof constraint.minimumDays === 'number') {\n    requirementParts.push(`${formatNumberFR(constraint.minimumDays)} j.`);\n  }\n\n  const hasRequirement = requirementParts.length > 0;\n  const hasStart = Boolean(startLabel);\n  const hasEnd = Boolean(endLabel);\n\n  if (!hasRequirement && !hasStart && !hasEnd) {\n    return '';\n  }\n\n  if (hasRequirement && hasStart && hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} entre Â« ${startLabel} Â» et Â« ${endLabel} Â».`;\n  }\n\n  if (hasRequirement && hasStart && !hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} aprÃ¨s Â« ${startLabel} Â».`;\n  }\n\n  if (hasRequirement && !hasStart && hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} avant Â« ${endLabel} Â».`;\n  }\n\n  if (hasRequirement) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} avant la prochaine Ã©tape.`;\n  }\n\n  if (hasStart && hasEnd) {\n    return `Surveiller le dÃ©lai entre Â« ${startLabel} Â» et Â« ${endLabel} Â».`;\n  }\n\n  const singleLabel = startLabel || endLabel;\n  if (singleLabel) {\n    return `Surveiller la date Â« ${singleLabel} Â».`;\n  }\n\n  return '';\n};\n\nconst formatVigilanceStatusMessage = (alert) => {\n  if (!alert || typeof alert !== 'object') {\n    return '';\n  }\n\n  if (alert.status === 'unknown') {\n    return \"Dates manquantes : complÃ©tez les informations pour confirmer ce dÃ©lai.\";\n  }\n\n  if (alert.status === 'breach') {\n    const diffWeeks = alert.diff && typeof alert.diff.diffInWeeks === 'number'\n      ? alert.diff.diffInWeeks\n      : null;\n    const diffDays = alert.diff && typeof alert.diff.diffInDays === 'number'\n      ? alert.diff.diffInDays\n      : null;\n\n    const requiredWeeks = typeof alert.requiredWeeks === 'number' ? alert.requiredWeeks : null;\n    const requiredDays = typeof alert.requiredDays === 'number' ? alert.requiredDays : null;\n\n    const requiredParts = [];\n    if (requiredWeeks !== null) {\n      requiredParts.push(`${formatNumberFR(requiredWeeks)} sem.`);\n    }\n    if (requiredDays !== null) {\n      requiredParts.push(`${formatNumberFR(requiredDays)} j.`);\n    }\n\n    const missingParts = [];\n    if (requiredWeeks !== null && diffWeeks !== null) {\n      const missingWeeks = requiredWeeks - diffWeeks;\n      if (missingWeeks > 0.0001) {\n        missingParts.push(formatWeeksValue(missingWeeks));\n      }\n    }\n    if (requiredDays !== null && diffDays !== null) {\n      const missingDays = requiredDays - diffDays;\n      if (missingDays > 0.0001) {\n        missingParts.push(formatDaysValue(missingDays));\n      }\n    }\n\n    if (missingParts.length > 0 && requiredParts.length > 0) {\n      return `Ã‰cart Ã  combler : ${missingParts.join(' / ')} pour atteindre le minimum requis de ${requiredParts.join(' / ')}. Ajuster le planning en consÃ©quence.`;\n    }\n\n    if (missingParts.length > 0) {\n      return `Ã‰cart Ã  combler : ${missingParts.join(' / ')}. Ajuster le planning en consÃ©quence.`;\n    }\n\n    const diffParts = [];\n    if (diffWeeks !== null) {\n      diffParts.push(formatWeeksValue(diffWeeks));\n    }\n    if (diffDays !== null) {\n      diffParts.push(formatDaysValue(diffDays));\n    }\n\n    if (diffParts.length === 0 && requiredParts.length === 0) {\n      return 'DÃ©lai insuffisant : ajuster les jalons pour respecter lâ€™exigence.';\n    }\n\n    if (diffParts.length === 0) {\n      return `DÃ©lai insuffisant â€“ minimum requis : ${requiredParts.join(' / ')}.`;\n    }\n\n    const diffLabel = diffParts.join(' / ');\n    if (requiredParts.length === 0) {\n      return `DÃ©lai constatÃ© : ${diffLabel}. Ajuster le planning pour sÃ©curiser le lancement.`;\n    }\n\n    return `DÃ©lai constatÃ© : ${diffLabel} â€“ minimum requis : ${requiredParts.join(' / ')}. Ajuster le planning en consÃ©quence.`;\n  }\n\n  if (alert.status === 'satisfied' && alert.diff) {\n    const parts = [];\n    if (typeof alert.diff.diffInWeeks === 'number') {\n      parts.push(formatWeeksValue(alert.diff.diffInWeeks));\n    }\n    if (typeof alert.diff.diffInDays === 'number') {\n      parts.push(formatDaysValue(alert.diff.diffInDays));\n    }\n\n    const diffLabel = parts.length > 0 ? parts.join(' / ') : '';\n    if (diffLabel) {\n      return `DÃ©lai actuel : ${diffLabel}. Maintenir cette marge pour Ã©viter lâ€™alerte.`;\n    }\n\n    return 'DÃ©lai actuel conforme. Maintenir cette marge pour Ã©viter lâ€™alerte.';\n  }\n\n  return '';\n};\n\nconst buildVigilanceAlerts = (analysis, questions, resolveTeamLabel) => {\n  const rawAlerts = Array.isArray(analysis?.timeline?.vigilance)\n    ? analysis.timeline.vigilance\n    : [];\n\n  return rawAlerts\n    .filter(alert => alert && typeof alert === 'object')\n    .map((alert, index) => {\n      const title = alert.riskDescription && alert.riskDescription.trim().length > 0\n        ? alert.riskDescription.trim()\n        : alert.ruleName;\n\n      const normalizedRuleId = alert?.ruleId != null\n        ? (() => {\n            const value = String(alert.ruleId).trim();\n            return value.length > 0 ? value : null;\n          })()\n        : null;\n      const normalizedRiskId = alert?.riskId != null\n        ? (() => {\n            const value = String(alert.riskId).trim();\n            return value.length > 0 ? value : null;\n          })()\n        : null;\n      const normalizedRiskDescription = typeof alert?.riskDescription === 'string'\n        ? alert.riskDescription.trim()\n        : '';\n\n      return {\n        id: alert.id || `${alert.ruleId || 'rule'}-${alert.riskId || index}`,\n        ruleId: normalizedRuleId,\n        ruleName: alert.ruleName,\n        riskId: normalizedRiskId,\n        riskDescription: normalizedRiskDescription,\n        title,\n        priority: alert.priority || '',\n        requirementSummary: formatTimingRequirementSummary(questions, alert.timingConstraint),\n        statusMessage: formatVigilanceStatusMessage(alert),\n        status: alert.status || 'unknown',\n        teamId: alert.teamId || '',\n        teamLabel: typeof resolveTeamLabel === 'function'\n          ? resolveTeamLabel(alert.teamId)\n          : (alert.teamId || '')\n      };\n    })\n    .filter(entry => entry.title || entry.requirementSummary || entry.statusMessage);\n};\n\nconst mergeTimelineSummariesWithAlerts = (summaries, alerts) => {\n  const safeSummaries = Array.isArray(summaries) ? summaries : [];\n  const safeAlerts = Array.isArray(alerts) ? alerts : [];\n\n  if (safeSummaries.length === 0) {\n    return { summaries: safeSummaries, unmatchedAlerts: safeAlerts };\n  }\n\n  const alertKeyMap = new Map();\n\n  const registerKey = (map, key, entry) => {\n    if (key === null || key === undefined) {\n      return;\n    }\n\n    const stringKey = typeof key === 'string' ? key : String(key);\n    if (stringKey.length === 0) {\n      return;\n    }\n\n    if (!map.has(stringKey)) {\n      map.set(stringKey, entry);\n    }\n\n    const normalized = stringKey.trim().toLowerCase();\n    if (normalized.length > 0 && !map.has(normalized)) {\n      map.set(normalized, entry);\n    }\n  };\n\n  const registerTextKey = (map, text, entry) => {\n    if (typeof text !== 'string') {\n      return;\n    }\n\n    const trimmed = text.trim();\n    if (trimmed.length === 0) {\n      return;\n    }\n\n    registerKey(map, trimmed, entry);\n  };\n\n  const registerCompositeKey = (map, parts, entry) => {\n    if (!Array.isArray(parts)) {\n      return;\n    }\n\n    const normalizedParts = parts\n      .map(part => {\n        if (part === null || part === undefined) {\n          return null;\n        }\n\n        if (typeof part === 'string') {\n          const trimmed = part.trim();\n          return trimmed.length > 0 ? trimmed : null;\n        }\n\n        const stringified = String(part);\n        return stringified.length > 0 ? stringified : null;\n      })\n      .filter(Boolean);\n\n    if (normalizedParts.length === 0) {\n      return;\n    }\n\n    registerKey(map, normalizedParts.join('::'), entry);\n  };\n\n  safeAlerts.forEach((alert, index) => {\n    if (!alert || typeof alert !== 'object') {\n      return;\n    }\n\n    const entry = { alert, index };\n\n    registerTextKey(alertKeyMap, alert.id, entry);\n    registerTextKey(alertKeyMap, alert.ruleId, entry);\n    registerTextKey(alertKeyMap, alert.ruleName, entry);\n    registerTextKey(alertKeyMap, alert.title, entry);\n    registerTextKey(alertKeyMap, alert.riskDescription, entry);\n\n    if (alert.ruleId) {\n      if (alert.riskId != null) {\n        const riskId = String(alert.riskId);\n        registerKey(alertKeyMap, `${alert.ruleId}-${riskId}`, entry);\n        registerKey(alertKeyMap, `${alert.ruleId}__${riskId}`, entry);\n        registerCompositeKey(alertKeyMap, [alert.ruleId, riskId], entry);\n      } else {\n        registerKey(alertKeyMap, `${alert.ruleId}-risk`, entry);\n      }\n\n      if (typeof alert.title === 'string' && alert.title.trim().length > 0) {\n        registerCompositeKey(alertKeyMap, [alert.ruleId, alert.title], entry);\n      }\n\n      if (typeof alert.riskDescription === 'string' && alert.riskDescription.trim().length > 0) {\n        registerCompositeKey(alertKeyMap, [alert.ruleId, alert.riskDescription], entry);\n      }\n\n      if (typeof alert.ruleName === 'string' && alert.ruleName.trim().length > 0) {\n        registerCompositeKey(alertKeyMap, [alert.ruleId, alert.ruleName], entry);\n      }\n    }\n  });\n\n  const matchedAlertIndexes = new Set();\n\n  const mergedSummaries = safeSummaries.map(summary => {\n    if (!summary || typeof summary !== 'object') {\n      return summary;\n    }\n\n    const candidateKeys = [];\n\n    if (summary.id) {\n      candidateKeys.push(summary.id);\n    }\n\n    if (summary.source) {\n      candidateKeys.push(summary.source);\n    }\n\n    if (summary.ruleId) {\n      candidateKeys.push(summary.ruleId);\n\n      if (summary.ruleLabel) {\n        candidateKeys.push(`${summary.ruleId}::${summary.ruleLabel}`);\n      }\n\n      if (summary.ruleName && typeof summary.ruleName === 'string') {\n        candidateKeys.push(`${summary.ruleId}::${summary.ruleName}`);\n      }\n\n      if (summary.riskDescription) {\n        candidateKeys.push(`${summary.ruleId}::${summary.riskDescription}`);\n      }\n\n      if (!summary.riskId && summary.source) {\n        candidateKeys.push(`${summary.ruleId}-${summary.source}`);\n        candidateKeys.push(`${summary.ruleId}::${summary.source}`);\n      }\n    }\n\n    if (summary.ruleLabel) {\n      candidateKeys.push(summary.ruleLabel);\n    }\n\n    if (summary.ruleName && typeof summary.ruleName === 'string') {\n      candidateKeys.push(summary.ruleName);\n    }\n\n    if (summary.riskDescription) {\n      candidateKeys.push(summary.riskDescription);\n    }\n\n    if (summary.riskId != null) {\n      candidateKeys.push(summary.riskId);\n\n      if (summary.ruleId) {\n        candidateKeys.push(`${summary.ruleId}-${summary.riskId}`);\n        candidateKeys.push(`${summary.ruleId}__${summary.riskId}`);\n        candidateKeys.push(`${summary.ruleId}::${summary.riskId}`);\n      }\n    }\n\n    let matchedEntry = null;\n\n    for (const key of candidateKeys) {\n      if (!key) {\n        continue;\n      }\n\n      if (alertKeyMap.has(key)) {\n        matchedEntry = alertKeyMap.get(key);\n        break;\n      }\n\n      if (typeof key === 'string') {\n        const normalizedKey = key.trim().toLowerCase();\n        if (alertKeyMap.has(normalizedKey)) {\n          matchedEntry = alertKeyMap.get(normalizedKey);\n          break;\n        }\n      }\n    }\n\n    if (matchedEntry) {\n      matchedAlertIndexes.add(matchedEntry.index);\n      return {\n        ...summary,\n        alert: matchedEntry.alert\n      };\n    }\n\n    return summary;\n  });\n\n  const unmatchedAlerts = safeAlerts.filter((_, index) => !matchedAlertIndexes.has(index));\n\n  return {\n    summaries: mergedSummaries,\n    unmatchedAlerts\n  };\n};\n\nconst FALLBACK_SHOWCASE_THEME = initialShowcaseThemes[0] || {\n  id: 'aurora',\n  label: 'Aurora nÃ©on',\n  description: 'Jeux de lumiÃ¨res et ambiance futuriste pour un rendu premium.',\n  palette: {}\n};\n\nconst normalizeColorValue = (value, fallback) => {\n  if (typeof value === 'string' && value.trim().length > 0) {\n    return value.trim();\n  }\n\n  return fallback;\n};\n\nconst toRgba = (value, alpha = 1, fallback = 'rgba(0, 0, 0, 1)') => {\n  if (typeof value !== 'string' || value.trim().length === 0) {\n    return fallback;\n  }\n\n  const normalized = value.trim();\n\n  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(normalized)) {\n    let hex = normalized.slice(1);\n    if (hex.length === 3) {\n      hex = hex.split('').map(char => char + char).join('');\n    }\n\n    const numeric = parseInt(hex, 16);\n    const r = (numeric >> 16) & 255;\n    const g = (numeric >> 8) & 255;\n    const b = numeric & 255;\n    const safeAlpha = Math.min(1, Math.max(0, typeof alpha === 'number' ? alpha : 1));\n\n    return `rgba(${r}, ${g}, ${b}, ${safeAlpha})`;\n  }\n\n  if (/^rgba?\\(/i.test(normalized)) {\n    if (normalized.startsWith('rgb(') && typeof alpha === 'number') {\n      return normalized.replace(/^rgb\\((.*)\\)$/i, `rgba($1, ${Math.min(1, Math.max(0, alpha))})`);\n    }\n\n    return normalized;\n  }\n\n  return fallback;\n};\n\nconst buildThemeVariables = (theme) => {\n  const palette = (theme && typeof theme === 'object' ? theme.palette : null) || {};\n  const accentPrimary = normalizeColorValue(palette.accentPrimary, '#2563eb');\n  const accentSecondary = normalizeColorValue(palette.accentSecondary, '#06b6d4');\n  const borderBase = normalizeColorValue(palette.border, '#94a3b8');\n  const highlightBase = normalizeColorValue(palette.highlight, accentSecondary);\n  const inkStrong = normalizeColorValue(palette.inkStrong, '#0f172a');\n  const inkSoft = normalizeColorValue(palette.inkSoft, '#1e293b');\n  const inkMuted = normalizeColorValue(palette.inkMuted, '#475569');\n  const inkSubtle = normalizeColorValue(palette.inkSubtle, '#94a3b8');\n  const surfaceLight = normalizeColorValue(palette.surfaceLight, '#f8fafc');\n  const surfaceLightAlt = normalizeColorValue(palette.surfaceLightAlt, '#e2e8f0');\n  const titleGradientStart = normalizeColorValue(palette.titleGradientStart, accentPrimary);\n  const titleGradientMid = normalizeColorValue(palette.titleGradientMid, highlightBase);\n  const titleGradientEnd = normalizeColorValue(palette.titleGradientEnd, accentSecondary);\n  const ctaStart = normalizeColorValue(palette.ctaStart, accentPrimary);\n  const ctaEnd = normalizeColorValue(palette.ctaEnd, accentSecondary);\n  const heroStart = normalizeColorValue(palette.heroBackgroundStart, '#000000');\n  const heroMid = normalizeColorValue(palette.heroBackgroundMid, '#090d15');\n  const heroEnd = normalizeColorValue(palette.heroBackgroundEnd, '#0b1f2c');\n  const panelSoftStart = normalizeColorValue(palette.panelSoftStart, '#101728');\n  const panelSoftEnd = normalizeColorValue(palette.panelSoftEnd, '#1b2230');\n  const panelStrongStart = normalizeColorValue(palette.panelStrongStart, '#0b2f41');\n  const panelStrongEnd = normalizeColorValue(palette.panelStrongEnd, '#0e5560');\n  const statusOkStart = normalizeColorValue(palette.statusOkStart, '#d1fae5');\n  const statusOkEnd = normalizeColorValue(palette.statusOkEnd, '#a7f3d0');\n  const statusWarnStart = normalizeColorValue(palette.statusWarnStart, '#ecfdf5');\n  const statusWarnEnd = normalizeColorValue(palette.statusWarnEnd, '#d1fae5');\n  const statusAlertStart = normalizeColorValue(palette.statusAlertStart, '#fee2e2');\n  const statusAlertEnd = normalizeColorValue(palette.statusAlertEnd, '#fecaca');\n  const statusAlertStrongStart = normalizeColorValue(palette.statusAlertStrongStart, '#f05959');\n  const statusAlertStrongEnd = normalizeColorValue(palette.statusAlertStrongEnd, '#be1717');\n  const statusOkText = normalizeColorValue(palette.statusOkText, '#064e3b');\n  const statusWarnText = normalizeColorValue(palette.statusWarnText, '#064e3b');\n  const statusAlertText = normalizeColorValue(palette.statusAlertText, '#7f1d1d');\n\n  return {\n    '--showcase-bg-start': normalizeColorValue(palette.backgroundStart, '#020309'),\n    '--showcase-bg-mid': normalizeColorValue(palette.backgroundMid, '#050b18'),\n    '--showcase-bg-end': normalizeColorValue(palette.backgroundEnd, '#020309'),\n    '--showcase-glow-primary': toRgba(palette.glowPrimary || accentPrimary, 0.18, 'rgba(59, 130, 246, 0.18)'),\n    '--showcase-glow-secondary': toRgba(palette.glowSecondary || accentSecondary, 0.16, 'rgba(14, 165, 233, 0.16)'),\n    '--showcase-text-strong': normalizeColorValue(palette.textPrimary, '#f8fafc'),\n    '--showcase-text-soft': normalizeColorValue(palette.textSecondary, '#e2e8f0'),\n    '--showcase-accent-primary': accentPrimary,\n    '--showcase-accent-secondary': accentSecondary,\n    '--showcase-surface': toRgba(palette.surface, 0.78, 'rgba(8, 13, 22, 0.78)'),\n    '--showcase-border-strong': toRgba(borderBase, 0.25, 'rgba(148, 163, 184, 0.25)'),\n    '--showcase-border-soft': toRgba(borderBase, 0.28, 'rgba(148, 163, 184, 0.28)'),\n    '--showcase-highlight-strong': toRgba(highlightBase, 0.85, 'rgba(148, 197, 255, 0.85)'),\n    '--showcase-highlight-soft': toRgba(highlightBase, 0.7, 'rgba(148, 197, 255, 0.7)'),\n    '--showcase-shadow-soft': toRgba(accentSecondary, 0.32, 'rgba(14, 165, 233, 0.32)'),\n    '--showcase-shadow-strong': toRgba(accentSecondary, 0.4, 'rgba(14, 165, 233, 0.4)'),\n    '--showcase-ink-strong': inkStrong,\n    '--showcase-ink-soft': inkSoft,\n    '--showcase-ink-muted': inkMuted,\n    '--showcase-ink-subtle': inkSubtle,\n    '--showcase-surface-light': surfaceLight,\n    '--showcase-surface-light-alt': surfaceLightAlt,\n    '--showcase-surface-card': toRgba(surfaceLight, 0.82, 'rgba(255, 255, 255, 0.82)'),\n    '--showcase-surface-card-soft': toRgba(surfaceLight, 0.72, 'rgba(255, 255, 255, 0.72)'),\n    '--showcase-surface-panel': toRgba(surfaceLight, 0.78, 'rgba(255, 255, 255, 0.78)'),\n    '--showcase-surface-panel-soft': toRgba(surfaceLight, 0.95, 'rgba(248, 250, 252, 0.95)'),\n    '--showcase-border-light': toRgba(borderBase, 0.4, 'rgba(148, 197, 255, 0.4)'),\n    '--showcase-title-gradient': `linear-gradient(120deg, ${titleGradientStart}, ${titleGradientMid}, ${titleGradientEnd})`,\n    '--showcase-title-shadow': toRgba(accentSecondary, 0.35, 'rgba(14, 116, 144, 0.35)'),\n    '--showcase-title-sheen': toRgba(surfaceLight, 0.65, 'rgba(255, 255, 255, 0.65)'),\n    '--showcase-cta-gradient': `linear-gradient(120deg, ${ctaStart}, ${ctaEnd})`,\n    '--showcase-cta-text': normalizeColorValue(palette.ctaText, '#ecfeff'),\n    '--showcase-hero-gradient': `linear-gradient(135deg, ${heroStart} 0%, ${heroMid} 45%, ${heroEnd} 100%)`,\n    '--showcase-hero-glow-primary': toRgba(highlightBase, 0.15, 'rgba(148, 197, 255, 0.15)'),\n    '--showcase-hero-glow-secondary': toRgba(accentSecondary, 0.18, 'rgba(14, 165, 233, 0.18)'),\n    '--showcase-highlight-panel': `linear-gradient(145deg, ${toRgba(highlightBase, 0.18, 'rgba(148, 197, 255, 0.18)')}, ${toRgba(palette.backgroundMid || '#0c1220', 0.38, 'rgba(15, 23, 42, 0.38)')})`,\n    '--showcase-panel-soft-gradient': `linear-gradient(135deg, ${panelSoftStart} 0%, ${panelSoftEnd} 100%)`,\n    '--showcase-panel-strong-gradient': `linear-gradient(135deg, ${panelStrongStart} 0%, ${panelStrongEnd} 100%)`,\n    '--showcase-panel-light-gradient': `linear-gradient(135deg, ${surfaceLightAlt} 0%, ${surfaceLight} 100%)`,\n    '--showcase-panel-soft-surface': `linear-gradient(140deg, ${toRgba(highlightBase, 0.16, 'rgba(148, 197, 255, 0.16)')}, ${toRgba(palette.backgroundMid || '#0c1220', 0.42, 'rgba(12, 18, 32, 0.42)')})`,\n    '--showcase-panel-card-gradient': `linear-gradient(150deg, ${toRgba(highlightBase, 0.16, 'rgba(148, 197, 255, 0.16)')}, ${toRgba(palette.backgroundMid || '#0c1220', 0.4, 'rgba(15, 23, 42, 0.4)')})`,\n    '--showcase-impact-gradient': `linear-gradient(140deg, ${toRgba(accentSecondary, 0.12, 'rgba(56, 189, 248, 0.12)')}, ${toRgba(accentPrimary, 0.32, 'rgba(30, 64, 175, 0.32)')}, ${toRgba(palette.backgroundEnd || '#020309', 0.8, 'rgba(2, 6, 23, 0.8)')})`,\n    '--showcase-impact-card-gradient': `radial-gradient(circle at 12% 18%, ${toRgba(highlightBase, 0.26, 'rgba(191, 219, 254, 0.26)')}, transparent 55%), radial-gradient(circle at 88% 82%, ${toRgba(highlightBase, 0.24, 'rgba(147, 197, 253, 0.24)')}, transparent 52%), linear-gradient(155deg, ${toRgba(accentPrimary, 0.65, 'rgba(30, 64, 175, 0.65)')}, ${toRgba(accentSecondary, 0.55, 'rgba(15, 118, 110, 0.55)')})`,\n    '--showcase-impact-vision-gradient': `radial-gradient(circle at 16% 22%, ${toRgba(highlightBase, 0.25, 'rgba(191, 219, 254, 0.25)')}, transparent 50%), linear-gradient(150deg, ${toRgba(accentSecondary, 0.24, 'rgba(56, 189, 248, 0.24)')}, ${toRgba(accentPrimary, 0.55, 'rgba(30, 58, 138, 0.55)')})`,\n    '--showcase-risk-halo-gradient': `radial-gradient(circle at 30% 30%, ${toRgba(accentPrimary, 0.55, 'rgba(92, 50, 0, 0.55)')}, ${toRgba(accentSecondary, 0.55, 'rgba(59, 37, 0, 0.55)')})`,\n    '--showcase-risk-note': toRgba(surfaceLight, 0.9, 'rgba(255, 228, 196, 0.9)'),\n    '--showcase-partner-bg': toRgba(accentPrimary, 0.12, 'rgba(78, 131, 255, 0.12)'),\n    '--showcase-status-ok-gradient': `linear-gradient(135deg, ${statusOkStart} 0%, ${statusOkEnd} 100%)`,\n    '--showcase-status-warn-gradient': `linear-gradient(135deg, ${statusWarnStart} 0%, ${statusWarnEnd} 100%)`,\n    '--showcase-status-alert-gradient': `linear-gradient(135deg, ${statusAlertStart} 0%, ${statusAlertEnd} 100%)`,\n    '--showcase-status-alert-strong-gradient': `linear-gradient(135deg, ${statusAlertStrongStart} 0%, ${statusAlertStrongEnd} 100%)`,\n    '--showcase-status-ok-text': statusOkText,\n    '--showcase-status-warn-text': statusWarnText,\n    '--showcase-status-alert-text': statusAlertText,\n    '--showcase-accent-soft': toRgba(highlightBase, 0.85, 'rgba(147, 197, 253, 0.85)'),\n    '--showcase-accent-strong': toRgba(accentPrimary, 0.9, 'rgba(59, 130, 246, 0.9)'),\n    '--showcase-accent-muted': toRgba(accentPrimary, 0.75, 'rgba(79, 70, 229, 0.75)')\n  };\n};\n\nconst normalizeThemeKey = (value) => (typeof value === 'string' ? value.trim().toLowerCase() : '');\n\nconst resolveShowcaseTheme = (themes, answer) => {\n  const availableThemes = Array.isArray(themes) && themes.length > 0 ? themes : initialShowcaseThemes;\n  const normalizedAnswer = normalizeThemeKey(answer);\n\n  if (normalizedAnswer.length > 0) {\n    const matched = availableThemes.find(theme => {\n      if (!theme) {\n        return false;\n      }\n\n      const candidates = [theme.id, theme.label, ...(Array.isArray(theme.aliases) ? theme.aliases : [])]\n        .filter(Boolean)\n        .map(normalizeThemeKey);\n\n      return candidates.includes(normalizedAnswer);\n    });\n\n    if (matched) {\n      return matched;\n    }\n  }\n\n  return availableThemes[0] || FALLBACK_SHOWCASE_THEME;\n};\n\nconst SHOWCASE_FIELD_CONFIG = [\n  { id: 'projectName', fallbackLabel: 'Nom du projet', fallbackType: 'text' },\n  { id: 'projectSlogan', fallbackLabel: 'Slogan du projet', fallbackType: 'text' },\n  { id: 'showcaseTheme', fallbackLabel: 'ThÃ¨me de la vitrine', fallbackType: 'choice' },\n  { id: 'targetAudience', fallbackLabel: 'Audience cible', fallbackType: 'multi_choice' },\n  { id: 'problemPainPoints', fallbackLabel: 'Besoins utilisateurs', fallbackType: 'long_text' },\n  { id: 'solutionDescription', fallbackLabel: 'Description de la solution', fallbackType: 'long_text' },\n  { id: 'solutionBenefits', fallbackLabel: 'BÃ©nÃ©fices clÃ©s', fallbackType: 'long_text' },\n  { id: 'solutionComparison', fallbackLabel: 'DiffÃ©renciation', fallbackType: 'long_text' },\n  { id: 'innovationProcess', fallbackLabel: 'Processus innovation', fallbackType: 'long_text' },\n  { id: 'visionStatement', fallbackLabel: \"Indicateurs d'impact\", fallbackType: 'long_text' },\n  { id: 'BUDGET', fallbackLabel: 'Budget estimÃ© (Kâ‚¬)', fallbackType: 'number' },\n  { id: 'teamLead', fallbackLabel: 'Lead du projet', fallbackType: 'text' },\n  { id: 'teamLeadTeam', fallbackLabel: 'Ã‰quipe du lead', fallbackType: 'text' },\n  { id: 'teamCoreMembers', fallbackLabel: 'Membres clÃ©s', fallbackType: 'long_text' },\n  { id: 'campaignKickoffDate', fallbackLabel: 'Date de soumission compliance', fallbackType: 'date' },\n  { id: 'launchDate', fallbackLabel: 'Date de lancement', fallbackType: 'date' },\n  { id: 'roadmapMilestones', fallbackLabel: 'Jalons du projet', fallbackType: 'milestone_list' }\n];\n\nconst FIELD_SECTION_MAP = {\n  projectName: 'hero',\n  projectSlogan: 'hero',\n  showcaseTheme: 'hero',\n  targetAudience: 'hero',\n  problemPainPoints: 'problem',\n  solutionDescription: 'solution',\n  solutionBenefits: 'solution',\n  solutionComparison: 'solution',\n  innovationProcess: 'innovation',\n  visionStatement: 'innovation',\n  BUDGET: 'innovation',\n  teamLead: 'team',\n  teamLeadTeam: 'team',\n  teamCoreMembers: 'team',\n  campaignKickoffDate: 'timeline',\n  launchDate: 'timeline',\n  roadmapMilestones: 'timeline'\n};\n\nconst createEmptyMilestoneDragState = () => ({\n  fieldId: null,\n  sourceIndex: null,\n  targetIndex: null\n});\n\nconst ensureStringArrayUniqueness = (values) => {\n  const seen = new Set();\n  return values.filter(value => {\n    if (seen.has(value)) {\n      return false;\n    }\n    seen.add(value);\n    return true;\n  });\n};\n\nconst normalizeMultiChoiceValue = (rawValue) => {\n  const normalizeEntry = (entry) => {\n    if (entry === null || entry === undefined) {\n      return '';\n    }\n\n    if (typeof entry === 'string') {\n      return entry.trim();\n    }\n\n    return String(entry).trim();\n  };\n\n  if (Array.isArray(rawValue)) {\n    const normalized = rawValue\n      .map(normalizeEntry)\n      .filter(entry => entry.length > 0);\n\n    return ensureStringArrayUniqueness(normalized);\n  }\n\n  if (typeof rawValue === 'string') {\n    const splitValues = rawValue\n      .split(/\\r?\\n|Â·|â€¢|;|,/)\n      .map(entry => entry.replace(/^[-â€¢\\s]+/, '').trim())\n      .filter(entry => entry.length > 0);\n\n    return ensureStringArrayUniqueness(splitValues);\n  }\n\n  return [];\n};\n\nconst sanitizeMilestoneEntries = (entries) => {\n  if (!Array.isArray(entries)) {\n    return [];\n  }\n\n  return entries\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0)\n    .map(entry => ({ date: entry.date, description: entry.description }));\n};\n\nconst formatMilestoneDraftState = (entries) => {\n  if (!Array.isArray(entries)) {\n    return [];\n  }\n\n  return entries\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date : '',\n      description: typeof item?.description === 'string' ? item.description : ''\n    }))\n    .filter(entry => entry.date.trim().length > 0 || entry.description.trim().length > 0);\n};\n\nconst formatValueForDraft = (type, rawValue) => {\n  if (rawValue === null || rawValue === undefined) {\n    return type === 'multi_choice' || type === 'milestone_list' ? [] : '';\n  }\n\n  if (type === 'multi_choice') {\n    return normalizeMultiChoiceValue(rawValue);\n  }\n\n  if (type === 'date') {\n    const parsed = rawValue instanceof Date ? rawValue : new Date(rawValue);\n    if (Number.isNaN(parsed.getTime())) {\n      return String(rawValue);\n    }\n    return parsed.toISOString().slice(0, 10);\n  }\n\n  if (type === 'milestone_list') {\n    return formatMilestoneDraftState(rawValue);\n  }\n\n  return String(rawValue);\n};\n\nconst formatValueForUpdate = (type, draftValue) => {\n  if (type === 'multi_choice') {\n    return normalizeMultiChoiceValue(draftValue);\n  }\n\n  if (type === 'date') {\n    if (typeof draftValue !== 'string') {\n      return null;\n    }\n    const trimmed = draftValue.trim();\n    return trimmed.length > 0 ? trimmed : null;\n  }\n\n  if (type === 'milestone_list') {\n    return sanitizeMilestoneEntries(draftValue);\n  }\n\n  if (typeof draftValue !== 'string') {\n    return '';\n  }\n\n  return draftValue;\n};\n\nconst areFieldValuesEqual = (type, previousValue, nextValue) => {\n  if (type === 'multi_choice') {\n    const previousArray = Array.isArray(previousValue)\n      ? previousValue\n      : normalizeMultiChoiceValue(previousValue);\n    const nextArray = Array.isArray(nextValue)\n      ? nextValue\n      : normalizeMultiChoiceValue(nextValue);\n\n    if (previousArray.length !== nextArray.length) {\n      return false;\n    }\n\n    return previousArray.every((entry, index) => entry === nextArray[index]);\n  }\n\n  if (type === 'milestone_list') {\n    const previousEntries = sanitizeMilestoneEntries(previousValue);\n    const nextEntries = sanitizeMilestoneEntries(nextValue);\n\n    if (previousEntries.length !== nextEntries.length) {\n      return false;\n    }\n\n    return previousEntries.every((entry, index) => {\n      const nextEntry = nextEntries[index];\n      if (!nextEntry) {\n        return false;\n      }\n\n      return entry.date === nextEntry.date && entry.description === nextEntry.description;\n    });\n  }\n\n  return previousValue === nextValue;\n};\n\nconst buildDraftValues = (fields, answers, fallbackProjectName) => {\n  const draft = {};\n\n  fields.forEach(field => {\n    const question = field.question;\n    const fieldType = question?.type || field.fallbackType || 'text';\n    const rawValue = getRawAnswer(answers, field.id);\n    if (rawValue === undefined || rawValue === null) {\n      draft[field.id] = fieldType === 'multi_choice' || fieldType === 'milestone_list' ? [] : '';\n    } else {\n      draft[field.id] = formatValueForDraft(fieldType, rawValue);\n    }\n  });\n\n  if (typeof fallbackProjectName === 'string' && fallbackProjectName.trim().length > 0) {\n    if (!hasText(draft.projectName)) {\n      draft.projectName = fallbackProjectName.trim();\n    }\n  }\n\n  return draft;\n};\n\nconst parseListAnswer = (value) => {\n  if (!value) {\n    return [];\n  }\n\n  if (Array.isArray(value)) {\n    return value.filter(item => hasText(String(item)));\n  }\n\n  const normalized = String(value)\n    .split(/\\r?\\n|Â·|â€¢|;|,/)\n    .map(entry => entry.replace(/^[-â€¢\\s]+/, '').trim())\n    .filter(entry => entry.length > 0);\n\n  return normalized;\n};\n\nconst formatDate = (value) => {\n  if (!value) {\n    return '';\n  }\n\n  const parsed = value instanceof Date ? value : new Date(value);\n  if (Number.isNaN(parsed.getTime())) {\n    return '';\n  }\n\n  return new Intl.DateTimeFormat('fr-FR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric'\n  }).format(parsed);\n};\n\nconst formatMilestoneDisplayDate = (value) => {\n  if (typeof value !== 'string' || value.trim().length === 0) {\n    return '';\n  }\n\n  const formatted = formatDate(value);\n  if (formatted && formatted.length > 0) {\n    return formatted;\n  }\n\n  return value.trim();\n};\n\nconst buildManualMilestones = (entries) => {\n  const sanitized = sanitizeMilestoneEntries(entries);\n\n  return sanitized.map((entry, index) => {\n    const formattedDate = formatMilestoneDisplayDate(entry.date);\n\n    return {\n      id: `manual-milestone-${index}`,\n      date: entry.date,\n      formattedDate,\n      description: entry.description\n    };\n  });\n};\n\nconst MS_IN_DAY = 24 * 60 * 60 * 1000;\n\nconst computeRunway = (answers) => {\n  const launchRaw = answers?.launchDate;\n\n  if (!launchRaw) {\n    return null;\n  }\n\n  const launchDate = new Date(launchRaw);\n\n  if (Number.isNaN(launchDate.getTime())) {\n    return null;\n  }\n\n  const today = new Date();\n  const todayNormalized = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n  const launchNormalized = new Date(\n    launchDate.getFullYear(),\n    launchDate.getMonth(),\n    launchDate.getDate()\n  );\n\n  const diffMs = launchNormalized.getTime() - todayNormalized.getTime();\n  const diffInDays = Math.max(0, Math.round(diffMs / MS_IN_DAY));\n  const diffInWeeks = diffInDays / 7;\n\n  return {\n    launchDate: launchNormalized,\n    diffDays: diffInDays,\n    diffWeeks: diffInWeeks,\n    weeks: diffInWeeks,\n    days: diffInDays,\n    isToday: diffMs === 0,\n    isOverdue: diffMs < 0,\n    launchLabel: formatDate(launchNormalized),\n    weeksLabel: `${Math.round(diffInWeeks)} sem.`,\n    daysLabel: `${diffInDays} j.`\n  };\n};\n\nconst formatCountdownUnit = (value, unit) => {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return `0 ${unit}`;\n  }\n\n  const rounded = Math.max(0, Math.round(value));\n  return `${rounded} ${unit}`;\n};\n\nconst useAnimatedCounter = (targetValue, options = {}) => {\n  const { duration = 1000 } = options;\n  const [displayValue, setDisplayValue] = useState(0);\n  const frameRef = useRef(null);\n  const previousTargetRef = useRef(null);\n\n  useEffect(() => {\n    if (frameRef.current) {\n      cancelAnimationFrame(frameRef.current);\n      frameRef.current = null;\n    }\n\n    if (typeof targetValue !== 'number' || Number.isNaN(targetValue)) {\n      previousTargetRef.current = null;\n      setDisplayValue(0);\n      return undefined;\n    }\n\n    const clampedTarget = Math.max(0, targetValue);\n\n    if (duration <= 0) {\n      setDisplayValue(clampedTarget);\n      previousTargetRef.current = clampedTarget;\n      return undefined;\n    }\n\n    if (previousTargetRef.current === clampedTarget) {\n      setDisplayValue(clampedTarget);\n      return undefined;\n    }\n\n    previousTargetRef.current = clampedTarget;\n    let start = null;\n\n    const step = (timestamp) => {\n      if (start === null) {\n        start = timestamp;\n      }\n\n      const progress = Math.min((timestamp - start) / duration, 1);\n      const easedProgress = 1 - Math.pow(1 - progress, 3);\n      const nextValue = clampedTarget * easedProgress;\n      setDisplayValue(nextValue);\n\n      if (progress < 1) {\n        frameRef.current = requestAnimationFrame(step);\n      }\n    };\n\n    frameRef.current = requestAnimationFrame(step);\n\n    return () => {\n      if (frameRef.current) {\n        cancelAnimationFrame(frameRef.current);\n        frameRef.current = null;\n      }\n    };\n  }, [targetValue, duration]);\n\n  return displayValue;\n};\n\nconst computeTimelineSummaries = (timelineDetails) => {\n  if (!Array.isArray(timelineDetails)) {\n    return [];\n  }\n\n  return timelineDetails\n    .filter(detail => Boolean(detail?.diff) && detail?.satisfied === false)\n    .map((detail, index) => {\n      const diff = detail.diff;\n      const weeks = Number.isFinite(diff?.diffInWeeks)\n        ? Math.round(diff.diffInWeeks)\n        : 0;\n      const days = Number.isFinite(diff?.diffInDays)\n        ? Math.round(diff.diffInDays)\n        : 0;\n      const riskLabel = typeof detail?.riskDescription === 'string'\n        ? detail.riskDescription.trim()\n        : '';\n      const summaryLabel = riskLabel.length > 0 ? riskLabel : detail?.ruleName;\n      const hasProfiles = Array.isArray(detail?.profiles) && detail.profiles.length > 0;\n      const source = typeof detail?.source === 'string' ? detail.source : null;\n      const ruleId = detail?.ruleId != null\n        ? (() => {\n            const value = String(detail.ruleId).trim();\n            return value.length > 0 ? value : null;\n          })()\n        : null;\n      const riskId = detail?.riskId != null\n        ? (() => {\n            const value = String(detail.riskId).trim();\n            return value.length > 0 ? value : null;\n          })()\n        : null;\n      const ruleLabel = typeof detail?.ruleName === 'string'\n        ? detail.ruleName.trim()\n        : '';\n      const identifier = detail?.id\n        || `${ruleId || ruleLabel || 'rule'}-${riskId || source || index}`;\n\n      return {\n        id: identifier,\n        ruleId,\n        ruleName: summaryLabel,\n        ruleLabel,\n        riskId,\n        riskDescription: riskLabel,\n        satisfied: detail?.satisfied ?? false,\n        weeks,\n        days,\n        hasProfiles,\n        source\n      };\n    });\n};\n\nconst extractTimelineProfiles = (timelineDetails) => {\n  if (!Array.isArray(timelineDetails)) {\n    return [];\n  }\n\n  const detailWithProfiles = timelineDetails.find(\n    (detail) => Array.isArray(detail?.profiles) && detail.profiles.length > 0\n  );\n\n  if (!detailWithProfiles) {\n    return [];\n  }\n\n  return detailWithProfiles.profiles\n    .map((profile) => ({\n      id: profile?.id ?? null,\n      label: typeof profile?.label === 'string' ? profile.label : '',\n      description: typeof profile?.description === 'string' ? profile.description : ''\n    }))\n    .filter(profile => profile.label.length > 0 || profile.description.length > 0);\n};\n\nconst REQUIRED_SHOWCASE_QUESTION_IDS = [\n  'projectName',\n  'projectSlogan',\n  'targetAudience',\n  'problemPainPoints',\n  'solutionDescription',\n  'solutionBenefits',\n  'solutionComparison',\n  'innovationProcess',\n  'visionStatement',\n  'BUDGET',\n  'teamLead',\n  'teamLeadTeam',\n  'teamCoreMembers',\n  'campaignKickoffDate',\n  'launchDate',\n  'roadmapMilestones'\n];\n\nconst buildHeroHighlights = ({ targetAudience, runway }) => {\n  const highlights = [];\n\n  if (hasText(targetAudience)) {\n    highlights.push({\n      id: 'audience',\n      label: 'Audience cible',\n      value: targetAudience,\n      caption: ''\n    });\n  }\n\n  if (runway) {\n    highlights.push({\n      id: 'runway',\n      label: 'Compte Ã  rebours avant lancement',\n      value: `${runway.weeksLabel} (${runway.daysLabel})`,\n      caption: runway.isOverdue\n        ? `Lancement prÃ©vu le ${runway.launchLabel} (Ã©chÃ©ance atteinte).`\n        : runway.isToday\n          ? `Lancement prÃ©vu aujourd'hui (${runway.launchLabel}).`\n          : `Lancement prÃ©vu le ${runway.launchLabel}.`\n    });\n  }\n\n  return highlights;\n};\n\nexport const ProjectShowcase = ({\n  projectName,\n  onClose,\n  analysis,\n  relevantTeams,\n  questions,\n  answers,\n  timelineDetails,\n  renderInStandalone = false,\n  onUpdateAnswers,\n  tourContext = null,\n  showcaseThemes = initialShowcaseThemes,\n  hasIncompleteAnswers = false,\n  onAnnotationScopeChange = null,\n  onEditingStateChange = null,\n  initialDisplayMode = 'full',\n  displayModeLock = null,\n  onDisplayModeChange = null,\n  hideEditBar = false,\n  hideNotice = false\n}) => {\n  const rawProjectName = typeof projectName === 'string' ? projectName.trim() : '';\n  const safeProjectName = rawProjectName.length > 0 ? rawProjectName : MISSING_INFO_LABEL;\n  const isMissingInfoLabel = useCallback(\n    (value) => typeof value === 'string' && value.trim() === MISSING_INFO_LABEL,\n    []\n  );\n  const missingInfoClass = useCallback(\n    (value) => (isMissingInfoLabel(value) ? 'text-rose-600' : ''),\n    [isMissingInfoLabel]\n  );\n  const normalizedTeams = Array.isArray(relevantTeams) ? relevantTeams : [];\n  const availableThemes = useMemo(\n    () => (Array.isArray(showcaseThemes) && showcaseThemes.length > 0\n      ? showcaseThemes\n      : initialShowcaseThemes),\n    [showcaseThemes]\n  );\n  const selectedTheme = useMemo(\n    () => resolveShowcaseTheme(availableThemes, answers?.showcaseTheme),\n    [answers?.showcaseTheme, availableThemes]\n  );\n  const showcaseThemeId = selectedTheme?.id || FALLBACK_SHOWCASE_THEME.id;\n  const showcaseLayout =\n    selectedTheme?.layout || (showcaseThemeId === 'deezer' ? 'deezer' : 'aurora');\n  const isDeezerTheme = showcaseLayout === 'deezer';\n  const isEditorialTheme = showcaseLayout === 'editorial';\n  const isFibclotTheme = showcaseLayout === 'fibclot';\n  const showcaseThemeVariables = useMemo(\n    () => buildThemeVariables(selectedTheme || FALLBACK_SHOWCASE_THEME),\n    [selectedTheme]\n  );\n  const teamNameById = useMemo(() => {\n    const map = new Map();\n    normalizedTeams.forEach(team => {\n      if (team && team.id) {\n        map.set(team.id, team.name || team.id);\n      }\n    });\n    return map;\n  }, [normalizedTeams]);\n\n  const editableFields = useMemo(\n    () =>\n      SHOWCASE_FIELD_CONFIG.map(config => ({\n        ...config,\n        question: findQuestionById(questions, config.id)\n      })),\n    [questions]\n  );\n\n  const [isEditing, setIsEditing] = useState(false);\n  const [draftValues, setDraftValues] = useState(() =>\n    buildDraftValues(editableFields, answers, rawProjectName)\n  );\n  const [customSections, setCustomSections] = useState(() =>\n    sanitizeCustomSections(answers?.customShowcaseSections)\n  );\n  const [sectionOrder, setSectionOrder] = useState(() =>\n    normalizeSectionOrder(answers?.showcaseSectionOrder, sanitizeCustomSections(answers?.customShowcaseSections))\n  );\n  const [milestoneDragState, setMilestoneDragState] = useState(createEmptyMilestoneDragState);\n  const resolvedDisplayModeLock =\n    displayModeLock === 'light' || displayModeLock === 'full' ? displayModeLock : null;\n  const resolvedInitialDisplayMode = initialDisplayMode === 'light' ? 'light' : 'full';\n  const [displayMode, setDisplayMode] = useState(resolvedDisplayModeLock || resolvedInitialDisplayMode);\n  const [lightSections, setLightSections] = useState(() =>\n    buildDefaultLightSectionSelection(sectionOrder)\n  );\n  const [pendingLightSections, setPendingLightSections] = useState(lightSections);\n  const [isLightConfigOpen, setIsLightConfigOpen] = useState(false);\n  const [sectionDragState, setSectionDragState] = useState({ sourceIndex: null, targetIndex: null });\n  const [isSectionModalOpen, setIsSectionModalOpen] = useState(false);\n  const [sectionModalStep, setSectionModalStep] = useState('templates');\n  const [selectedTemplateIndex, setSelectedTemplateIndex] = useState(0);\n  const [pendingInsertionIndex, setPendingInsertionIndex] = useState(null);\n  const [isSharePointWarningOpen, setIsSharePointWarningOpen] = useState(false);\n  const [sharePointWarningUrl, setSharePointWarningUrl] = useState('');\n  const [sectionDraft, setSectionDraft] = useState({\n    title: '',\n    subtitle: '',\n    description: '',\n    accent: '',\n    documentUrl: '',\n    documentType: 'pdf',\n    items: [],\n    columnCount: 1,\n    columns: ['']\n  });\n\n  const resetMilestoneDragState = useCallback(() => {\n    setMilestoneDragState(createEmptyMilestoneDragState());\n  }, []);\n\n  const handleSharePointWarning = useCallback((nextValue) => {\n    if (!isSharePointUrl(nextValue)) {\n      return;\n    }\n\n    if (nextValue === sharePointWarningUrl) {\n      return;\n    }\n\n    setSharePointWarningUrl(nextValue);\n    setIsSharePointWarningOpen(true);\n  }, [sharePointWarningUrl]);\n\n  const handleCloseSharePointWarning = useCallback(() => {\n    setIsSharePointWarningOpen(false);\n  }, []);\n\n  useEffect(() => {\n    if (isEditing) {\n      return;\n    }\n    setDraftValues(buildDraftValues(editableFields, answers, rawProjectName));\n    const sanitizedSections = sanitizeCustomSections(answers?.customShowcaseSections);\n    setCustomSections(sanitizedSections);\n    setSectionOrder(normalizeSectionOrder(answers?.showcaseSectionOrder, sanitizedSections));\n  }, [answers, editableFields, rawProjectName]);\n\n  useEffect(() => {\n    if (!isEditing) {\n      resetMilestoneDragState();\n    }\n  }, [isEditing, resetMilestoneDragState]);\n\n  useEffect(() => {\n    setLightSections(previous => {\n      const nextState = { ...previous };\n      let changed = false;\n\n      sectionOrder.forEach(id => {\n        if (nextState[id] === undefined) {\n          nextState[id] = true;\n          changed = true;\n        }\n      });\n\n      Object.keys(nextState).forEach(id => {\n        if (!sectionOrder.includes(id)) {\n          delete nextState[id];\n          changed = true;\n        }\n      });\n\n      return changed ? nextState : previous;\n    });\n  }, [sectionOrder]);\n\n  useEffect(() => {\n    if (typeof onAnnotationScopeChange !== 'function') {\n      return undefined;\n    }\n\n    const scope = isSectionModalOpen\n      ? `section-modal-${sectionModalStep}`\n      : isLightConfigOpen\n        ? 'light-config'\n        : `display-${displayMode}`;\n\n    onAnnotationScopeChange(scope);\n\n    return () => {\n      onAnnotationScopeChange('');\n    };\n  }, [displayMode, isLightConfigOpen, isSectionModalOpen, onAnnotationScopeChange, sectionModalStep]);\n\n  const handleDisplayModeChange = useCallback((mode) => {\n    if (resolvedDisplayModeLock) {\n      return;\n    }\n\n    if (mode === 'full' || mode === 'light') {\n      setDisplayMode(mode);\n    }\n  }, [resolvedDisplayModeLock]);\n\n  useEffect(() => {\n    if (resolvedDisplayModeLock) {\n      setDisplayMode(resolvedDisplayModeLock);\n      setIsLightConfigOpen(false);\n      return;\n    }\n\n    if (initialDisplayMode === 'light' || initialDisplayMode === 'full') {\n      setDisplayMode(initialDisplayMode);\n    }\n  }, [initialDisplayMode, resolvedDisplayModeLock]);\n\n  useEffect(() => {\n    if (typeof onDisplayModeChange === 'function') {\n      onDisplayModeChange(displayMode);\n    }\n  }, [displayMode, onDisplayModeChange]);\n\n  const handleOpenLightConfig = useCallback(() => {\n    setPendingLightSections(lightSections);\n    setIsLightConfigOpen(true);\n  }, [lightSections]);\n\n  const handleCancelLightConfig = useCallback(() => {\n    setPendingLightSections(lightSections);\n    setIsLightConfigOpen(false);\n  }, [lightSections]);\n\n  const handleTogglePendingSection = useCallback((sectionId) => {\n    setPendingLightSections(prev => ({\n      ...prev,\n      [sectionId]: !prev[sectionId]\n    }));\n  }, []);\n\n  const handleSelectAllSections = useCallback(() => {\n    setPendingLightSections(buildDefaultLightSectionSelection());\n  }, []);\n\n  const handleValidateLightConfig = useCallback(() => {\n    setLightSections(pendingLightSections);\n    setIsLightConfigOpen(false);\n  }, [pendingLightSections]);\n\n  const sanitizedCustomSections = useMemo(\n    () => sanitizeCustomSections(customSections),\n    [customSections]\n  );\n\n  const customSectionMap = useMemo(() => {\n    const map = new Map();\n    sanitizedCustomSections.forEach(section => {\n      map.set(section.id, section);\n    });\n    return map;\n  }, [sanitizedCustomSections]);\n\n  const customSectionFormMap = useMemo(() => {\n    const map = new Map();\n    customSections.forEach(section => {\n      if (section?.id) {\n        map.set(section.id, section);\n      }\n    });\n    return map;\n  }, [customSections]);\n\n  const sectionFieldsById = useMemo(() => {\n    return editableFields.reduce((acc, field) => {\n      const sectionId = FIELD_SECTION_MAP[field.id];\n      if (!sectionId) {\n        return acc;\n      }\n\n      if (!acc[sectionId]) {\n        acc[sectionId] = [];\n      }\n\n      acc[sectionId].push(field);\n      return acc;\n    }, {});\n  }, [editableFields]);\n\n  const editFormBlocks = useMemo(() => {\n    const blocks = [];\n\n    sectionOrder.forEach(sectionId => {\n      const customSection = customSectionFormMap.get(sectionId);\n      if (customSection) {\n        blocks.push({ type: 'custom', section: customSection });\n        return;\n      }\n\n      const sectionFields = sectionFieldsById[sectionId] || [];\n      sectionFields.forEach(field => blocks.push({ type: 'field', field }));\n    });\n\n    return blocks;\n  }, [customSectionFormMap, sectionFieldsById, sectionOrder]);\n\n  const handleOpenSectionModal = useCallback((insertionIndex = null) => {\n    setPendingInsertionIndex(insertionIndex);\n    setSectionModalStep('templates');\n    setSectionDraft({\n      title: '',\n      subtitle: '',\n      description: '',\n      accent: '',\n      documentUrl: '',\n      documentType: 'pdf',\n      items: [],\n      columnCount: 1,\n      columns: ['']\n    });\n    setIsSectionModalOpen(true);\n  }, []);\n\n  const handleCloseSectionModal = useCallback(() => {\n    setIsSectionModalOpen(false);\n    setSectionModalStep('templates');\n    setPendingInsertionIndex(null);\n    setSectionDraft({\n      title: '',\n      subtitle: '',\n      description: '',\n      accent: '',\n      documentUrl: '',\n      documentType: 'pdf',\n      items: [],\n      columnCount: 1,\n      columns: ['']\n    });\n  }, []);\n\n  useEffect(() => {\n    if (typeof onEditingStateChange === 'function') {\n      onEditingStateChange(isEditing);\n    }\n\n    return () => {\n      if (typeof onEditingStateChange === 'function') {\n        onEditingStateChange(false);\n      }\n    };\n  }, [isEditing, onEditingStateChange]);\n\n  const handleTemplateNavigation = useCallback((direction) => {\n    setSelectedTemplateIndex(previous => {\n      const nextIndex = (previous + direction + SECTION_TEMPLATES.length) % SECTION_TEMPLATES.length;\n      return nextIndex;\n    });\n  }, []);\n\n  const handleConfirmTemplateChoice = useCallback(() => {\n    const template = SECTION_TEMPLATES[selectedTemplateIndex];\n    const placeholder = template?.placeholder || {};\n    const columnCount = resolveCustomSectionColumnCount(placeholder.columnCount, placeholder.columns);\n    const columns = normalizeCustomSectionColumns(placeholder.columns, columnCount);\n    setSectionDraft({\n      title: placeholder.title || '',\n      subtitle: placeholder.subtitle || '',\n      description: placeholder.description || '',\n      accent: placeholder.accent || '',\n      documentUrl: placeholder.documentUrl || '',\n      documentType: placeholder.documentType || 'pdf',\n      items: Array.isArray(placeholder.items) ? placeholder.items : [],\n      columnCount,\n      columns\n    });\n    setSectionModalStep('form');\n  }, [selectedTemplateIndex]);\n\n  const handleSectionDraftChange = useCallback((field, value) => {\n    setSectionDraft(previous => ({\n      ...previous,\n      [field]: value\n    }));\n  }, []);\n\n  const handleSectionDraftColumnCountChange = useCallback((value) => {\n    const nextCount = resolveCustomSectionColumnCount(value);\n    setSectionDraft(previous => ({\n      ...previous,\n      columnCount: nextCount,\n      columns: normalizeCustomSectionColumns(previous.columns, nextCount)\n    }));\n  }, []);\n\n  const handleSectionDraftColumnChange = useCallback((index, value) => {\n    setSectionDraft(previous => {\n      const currentCount = resolveCustomSectionColumnCount(previous.columnCount, previous.columns);\n      const columns = normalizeCustomSectionColumns(previous.columns, currentCount);\n      columns[index] = value;\n      return {\n        ...previous,\n        columns\n      };\n    });\n  }, []);\n\n  const handleSectionDraftItemChange = useCallback((index, value) => {\n    setSectionDraft(previous => {\n      const items = Array.isArray(previous.items) ? [...previous.items] : [];\n      items[index] = value;\n      return {\n        ...previous,\n        items\n      };\n    });\n  }, []);\n\n  const handleSectionDraftItemAdd = useCallback(() => {\n    setSectionDraft(previous => ({\n      ...previous,\n      items: [...(Array.isArray(previous.items) ? previous.items : []), '']\n    }));\n  }, []);\n\n  const handleSectionDraftItemRemove = useCallback((index) => {\n    setSectionDraft(previous => {\n      const items = Array.isArray(previous.items) ? [...previous.items] : [];\n      items.splice(index, 1);\n      return {\n        ...previous,\n        items\n      };\n    });\n  }, []);\n\n  const handleSubmitNewSection = useCallback((event) => {\n    event.preventDefault();\n    const template = SECTION_TEMPLATES[selectedTemplateIndex];\n    const safeTemplateId = template?.id || SECTION_TEMPLATES[0].id;\n    const newSectionId = `custom-section-${Date.now()}`;\n\n    const newSection = {\n      id: newSectionId,\n      type: safeTemplateId,\n      title: sectionDraft.title?.trim() || template?.name || 'Nouvelle section',\n      subtitle: sectionDraft.subtitle?.trim() || '',\n      description: sectionDraft.description?.trim() || '',\n      accent: sectionDraft.accent?.trim() || '',\n      documentUrl: sectionDraft.documentUrl?.trim() || '',\n      documentType: sectionDraft.documentType?.trim() || '',\n      items: Array.isArray(sectionDraft.items) ? sectionDraft.items : [],\n      columnCount: resolveCustomSectionColumnCount(sectionDraft.columnCount, sectionDraft.columns),\n      columns: normalizeCustomSectionColumns(\n        sectionDraft.columns,\n        resolveCustomSectionColumnCount(sectionDraft.columnCount, sectionDraft.columns)\n      )\n    };\n\n    setCustomSections(previous => [...sanitizeCustomSections(previous), newSection]);\n    setSectionOrder(previousOrder => {\n      const base = Array.isArray(previousOrder) ? [...previousOrder] : [];\n      const insertionIndex = typeof pendingInsertionIndex === 'number'\n        ? Math.max(0, Math.min(base.length, pendingInsertionIndex))\n        : base.length;\n      base.splice(insertionIndex, 0, newSectionId);\n      return normalizeSectionOrder(base, [...sanitizeCustomSections(customSections), newSection]);\n    });\n    handleCloseSectionModal();\n  }, [customSections, handleCloseSectionModal, pendingInsertionIndex, sectionDraft, selectedTemplateIndex]);\n\n  const handleBackToTemplates = useCallback(() => {\n    setSectionModalStep('templates');\n  }, []);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    const shouldForceEditing = [\n      'showcase-edit',\n      'showcase-save-edits',\n      'showcase-custom-sections'\n    ].includes(activeStep);\n\n    if (shouldForceEditing) {\n      setDraftValues(buildDraftValues(editableFields, answers, rawProjectName));\n      resetMilestoneDragState();\n      setIsEditing(true);\n    } else if (isEditing && activeStep !== 'showcase-edit' && activeStep !== 'showcase-save-edits') {\n      setIsEditing(false);\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    let selector = null;\n    let scrollOptions = { behavior: 'smooth', block: 'center' };\n\n    if (activeStep === 'showcase-top') {\n      selector = '[data-tour-id=\"showcase-preview\"]';\n      scrollOptions = { behavior: 'smooth', block: 'start' };\n    } else if (activeStep === 'showcase-bottom') {\n      selector = '[data-tour-id=\"showcase-roadmap\"]';\n      scrollOptions = { behavior: 'smooth', block: 'center' };\n    } else if (activeStep === 'showcase-comments') {\n      selector = '[data-tour-id=\"showcase-preview\"]';\n      scrollOptions = { behavior: 'smooth', block: 'center' };\n    } else if (activeStep === 'showcase-edit-trigger') {\n      selector = '[data-tour-id=\"showcase-edit-trigger\"]';\n    } else if (activeStep === 'showcase-edit' || activeStep === 'showcase-save-edits') {\n      selector = '[data-tour-id=\"showcase-edit-panel\"]';\n    }\n\n    if (selector) {\n      let element = document.querySelector(selector);\n      if (!element && activeStep === 'showcase-bottom') {\n        element = document.querySelector('[data-tour-id=\"showcase-preview\"]');\n        scrollOptions = { behavior: 'smooth', block: 'center' };\n      }\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView(scrollOptions);\n      }\n    }\n\n    if (activeStep === 'showcase-custom-sections') {\n      if (!isSectionModalOpen) {\n        handleOpenSectionModal();\n      }\n    } else if (isSectionModalOpen && activeStep !== 'showcase-custom-sections') {\n      handleCloseSectionModal();\n    }\n  }, [\n    tourContext,\n    editableFields,\n    buildDraftValues,\n    answers,\n    rawProjectName,\n    resetMilestoneDragState,\n    isEditing,\n    setDraftValues,\n    handleOpenSectionModal,\n    handleCloseSectionModal,\n    isSectionModalOpen\n  ]);\n\n  const isLightMode = displayMode === 'light';\n\n  const shouldDisplaySection = useCallback(\n    (sectionId) => displayMode === 'full' || lightSections[sectionId] !== false,\n    [displayMode, lightSections]\n  );\n\n  const selectedLightSectionsCount = useMemo(\n    () => Object.values(lightSections).filter(Boolean).length,\n    [lightSections]\n  );\n\n  const canEdit = typeof onUpdateAnswers === 'function' && !hideEditBar;\n  const shouldShowPreview = !isEditing || !canEdit;\n  const formId = 'project-showcase-edit-form';\n\n  const handleStartEditing = useCallback(() => {\n    setDraftValues(buildDraftValues(editableFields, answers, rawProjectName));\n    resetMilestoneDragState();\n    setIsEditing(true);\n  }, [answers, editableFields, rawProjectName, resetMilestoneDragState]);\n\n  const handleCancelEditing = useCallback(() => {\n    setDraftValues(buildDraftValues(editableFields, answers, rawProjectName));\n    setIsEditing(false);\n    const sanitizedSections = sanitizeCustomSections(answers?.customShowcaseSections);\n    setCustomSections(sanitizedSections);\n    setSectionOrder(normalizeSectionOrder(answers?.showcaseSectionOrder, sanitizedSections));\n  }, [answers, editableFields, rawProjectName]);\n\n  const handleFieldChange = useCallback((fieldId, valueOrUpdater) => {\n    setDraftValues(prev => {\n      const nextValue =\n        typeof valueOrUpdater === 'function'\n          ? valueOrUpdater(prev[fieldId], prev)\n          : valueOrUpdater;\n\n      if (prev[fieldId] === nextValue) {\n        return prev;\n      }\n\n      return {\n        ...prev,\n        [fieldId]: nextValue\n      };\n    });\n  }, []);\n\n  const handleCustomSectionFieldChange = useCallback((sectionId, field, value) => {\n    setCustomSections(prev =>\n      prev.map(section => {\n        if (!section || section.id !== sectionId) {\n          return section;\n        }\n\n        return {\n          ...section,\n          [field]: value\n        };\n      })\n    );\n  }, []);\n\n  const handleCustomSectionColumnCountChange = useCallback((sectionId, value) => {\n    const nextCount = resolveCustomSectionColumnCount(value);\n    setCustomSections(prev =>\n      prev.map(section => {\n        if (!section || section.id !== sectionId) {\n          return section;\n        }\n\n        const columns = normalizeCustomSectionColumns(section.columns, nextCount);\n\n        return {\n          ...section,\n          columnCount: nextCount,\n          columns\n        };\n      })\n    );\n  }, []);\n\n  const handleCustomSectionColumnChange = useCallback((sectionId, index, value) => {\n    setCustomSections(prev =>\n      prev.map(section => {\n        if (!section || section.id !== sectionId) {\n          return section;\n        }\n\n        const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n        const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n        columns[index] = value;\n\n        return {\n          ...section,\n          columns\n        };\n      })\n    );\n  }, []);\n\n  const handleCustomSectionItemChange = useCallback((sectionId, index, value) => {\n    setCustomSections(prev =>\n      prev.map(section => {\n        if (!section || section.id !== sectionId) {\n          return section;\n        }\n\n        const items = Array.isArray(section.items) ? [...section.items] : [];\n        items[index] = value;\n\n        return {\n          ...section,\n          items\n        };\n      })\n    );\n  }, []);\n\n  const handleCustomSectionItemAdd = useCallback((sectionId) => {\n    setCustomSections(prev =>\n      prev.map(section => (\n        section && section.id === sectionId\n          ? { ...section, items: [...(Array.isArray(section.items) ? section.items : []), ''] }\n          : section\n      ))\n    );\n  }, []);\n\n  const handleCustomSectionItemRemove = useCallback((sectionId, index) => {\n    setCustomSections(prev =>\n      prev.map(section => {\n        if (!section || section.id !== sectionId) {\n          return section;\n        }\n\n        const items = Array.isArray(section.items) ? [...section.items] : [];\n        items.splice(index, 1);\n\n        return {\n          ...section,\n          items\n        };\n      })\n    );\n  }, []);\n\n  const handleRemoveCustomSection = useCallback((sectionId) => {\n    setCustomSections(previous => previous.filter(section => section.id !== sectionId));\n    setSectionOrder(previous => previous.filter(entry => entry !== sectionId));\n  }, []);\n\n  const handleSectionDragStart = useCallback((index, event) => {\n    if (event?.dataTransfer) {\n      event.dataTransfer.effectAllowed = 'move';\n      try {\n        event.dataTransfer.setData('text/plain', String(index));\n      } catch (_error) {\n        // Certains navigateurs bloquent l'Ã©criture : on ignore.\n      }\n    }\n    setSectionDragState({ sourceIndex: index, targetIndex: index });\n  }, []);\n\n  const handleSectionDragEnter = useCallback((index) => {\n    setSectionDragState(previous => {\n      if (previous.sourceIndex === null || previous.targetIndex === index) {\n        return previous;\n      }\n      return { ...previous, targetIndex: index };\n    });\n  }, []);\n\n  const handleSectionDragLeave = useCallback((index, event) => {\n    if (event?.currentTarget?.contains(event?.relatedTarget)) {\n      return;\n    }\n    setSectionDragState(previous => {\n      if (previous.targetIndex !== index) {\n        return previous;\n      }\n      return { ...previous, targetIndex: previous.sourceIndex };\n    });\n  }, []);\n\n  const handleSectionDragOver = useCallback((event) => {\n    if (sectionDragState.sourceIndex !== null) {\n      event.preventDefault();\n      if (event?.dataTransfer) {\n        event.dataTransfer.dropEffect = 'move';\n      }\n    }\n  }, [sectionDragState.sourceIndex]);\n\n  const handleSectionDrop = useCallback((index, event) => {\n    if (sectionDragState.sourceIndex === null) {\n      return;\n    }\n    event.preventDefault();\n    const sourceIndex = Math.max(0, Math.min(sectionOrder.length - 1, sectionDragState.sourceIndex));\n    const targetIndex = Math.max(0, Math.min(sectionOrder.length - 1, index));\n\n    if (sourceIndex === targetIndex) {\n      setSectionDragState({ sourceIndex: null, targetIndex: null });\n      return;\n    }\n\n    setSectionOrder(previous => {\n      const next = [...previous];\n      const [removed] = next.splice(sourceIndex, 1);\n      next.splice(targetIndex, 0, removed);\n      return next;\n    });\n    setSectionDragState({ sourceIndex: null, targetIndex: null });\n  }, [sectionDragState.sourceIndex, sectionOrder.length]);\n\n  const handleSubmitEdit = useCallback(\n    (event) => {\n      event.preventDefault();\n      if (!canEdit) {\n        setIsEditing(false);\n        return;\n      }\n\n      const updates = {};\n\n      editableFields.forEach(field => {\n        const { id } = field;\n        if (!id) {\n          return;\n        }\n\n        const type = field.question?.type || field.fallbackType || 'text';\n        const rawPreviousValue = getRawAnswer(answers, id);\n        const previousValue =\n          rawPreviousValue === undefined || rawPreviousValue === null\n            ? (type === 'multi_choice' || type === 'milestone_list' ? [] : '')\n            : formatValueForDraft(type, rawPreviousValue);\n        const nextValue =\n          draftValues[id] !== undefined\n            ? draftValues[id]\n            : (type === 'multi_choice' || type === 'milestone_list' ? [] : '');\n\n        if (areFieldValuesEqual(type, previousValue, nextValue)) {\n          return;\n        }\n\n        updates[id] = formatValueForUpdate(type, nextValue);\n      });\n\n      const previousCustomSections = sanitizeCustomSections(answers?.customShowcaseSections);\n      const nextCustomSections = sanitizeCustomSections(customSections);\n      const previousSectionOrder = normalizeSectionOrder(answers?.showcaseSectionOrder, previousCustomSections);\n      const nextSectionOrder = normalizeSectionOrder(sectionOrder, nextCustomSections);\n\n      if (!areCustomSectionsEqual(previousCustomSections, nextCustomSections)) {\n        updates.customShowcaseSections = nextCustomSections;\n      }\n\n      if (!areCustomSectionsEqual(\n        previousSectionOrder.map(id => ({ id })),\n        nextSectionOrder.map(id => ({ id }))\n      )) {\n        updates.showcaseSectionOrder = nextSectionOrder;\n      }\n\n      if (Object.keys(updates).length > 0) {\n        onUpdateAnswers(updates);\n      }\n\n      setIsEditing(false);\n    },\n    [answers, canEdit, customSections, draftValues, editableFields, onUpdateAnswers, sectionOrder]\n  );\n\n  const missingShowcaseQuestions = useMemo(() => {\n    const available = new Set(Array.isArray(questions) ? questions.map(question => question?.id).filter(Boolean) : []);\n    return REQUIRED_SHOWCASE_QUESTION_IDS.filter(id => !available.has(id));\n  }, [questions]);\n\n  const slogan = getFormattedAnswer(questions, answers, 'projectSlogan');\n  const targetAudience = getFormattedAnswer(questions, answers, 'targetAudience');\n  const problemPainPoints = parseListAnswer(getRawAnswer(answers, 'problemPainPoints'));\n\n  const solutionDescription = getFormattedAnswer(questions, answers, 'solutionDescription');\n  const solutionBenefits = parseListAnswer(getRawAnswer(answers, 'solutionBenefits'));\n  const solutionComparison = getFormattedAnswer(questions, answers, 'solutionComparison');\n\n  const innovationProcess = getFormattedAnswer(questions, answers, 'innovationProcess');\n  const visionStatement = getFormattedAnswer(questions, answers, 'visionStatement');\n  const visionStatementEntries = useMemo(\n    () => parseListAnswer(getRawAnswer(answers, 'visionStatement')),\n    [answers]\n  );\n  const budgetEstimate = getFormattedAnswer(questions, answers, 'BUDGET');\n  const normalizedTimelineDetails = useMemo(() => {\n    if (Array.isArray(timelineDetails)) {\n      return timelineDetails;\n    }\n\n    const analysisDetails = analysis?.timeline?.details;\n    return Array.isArray(analysisDetails) ? analysisDetails : [];\n  }, [analysis, timelineDetails]);\n\n  const formattedBudgetEstimate = useMemo(() => {\n    if (!hasText(budgetEstimate)) {\n      return '';\n    }\n\n    const trimmed = budgetEstimate.trim();\n    if (/[â‚¬]/i.test(trimmed)) {\n      return trimmed;\n    }\n\n    return `${trimmed} Kâ‚¬`;\n  }, [budgetEstimate]);\n\n  const teamLead = getFormattedAnswer(questions, answers, 'teamLead');\n  const teamLeadTeam = getFormattedAnswer(questions, answers, 'teamLeadTeam');\n  const teamCoreMembers = parseListAnswer(getRawAnswer(answers, 'teamCoreMembers'));\n\n  const rawRunway = useMemo(() => computeRunway(answers), [answers]);\n  const animatedWeeks = useAnimatedCounter(rawRunway?.weeks ?? null, { duration: 1200 });\n  const animatedDays = useAnimatedCounter(rawRunway?.days ?? null, { duration: 1200 });\n  const runway = useMemo(() => {\n    if (!rawRunway) {\n      return null;\n    }\n\n    return {\n      ...rawRunway,\n      weeksLabel: formatCountdownUnit(animatedWeeks, 'sem.'),\n      daysLabel: formatCountdownUnit(animatedDays, 'j.')\n    };\n  }, [rawRunway, animatedWeeks, animatedDays]);\n  const timelineSummaries = useMemo(\n    () => computeTimelineSummaries(normalizedTimelineDetails),\n    [normalizedTimelineDetails]\n  );\n  const timelineProfiles = useMemo(\n    () => extractTimelineProfiles(normalizedTimelineDetails),\n    [normalizedTimelineDetails]\n  );\n  const vigilanceAlerts = useMemo(\n    () =>\n      buildVigilanceAlerts(\n        analysis,\n        questions,\n        (teamId) => (teamNameById.has(teamId) ? teamNameById.get(teamId) : teamId || '')\n      ),\n    [analysis, questions, teamNameById]\n  );\n  const { summaries: timelineSummariesWithAlerts, unmatchedAlerts: unmatchedVigilanceAlerts } = useMemo(\n    () => mergeTimelineSummariesWithAlerts(timelineSummaries, vigilanceAlerts),\n    [timelineSummaries, vigilanceAlerts]\n  );\n  const manualMilestones = useMemo(\n    () => buildManualMilestones(getRawAnswer(answers, 'roadmapMilestones')),\n    [answers]\n  );\n  const heroHighlights = useMemo(\n    () =>\n      buildHeroHighlights({\n        targetAudience,\n        runway\n      }),\n    [targetAudience, runway]\n  );\n\n  const teamMemberCards = useMemo(\n    () =>\n      teamCoreMembers.map((entry, index) => {\n        const raw = typeof entry === 'string' ? entry : String(entry ?? '');\n        const normalized = raw.trim();\n\n        if (normalized.length === 0) {\n          return {\n            id: `team-member-${index}`,\n            name: 'Membre clÃ©',\n            details: null,\n            initials: 'â€¢',\n            fullText: raw\n          };\n        }\n\n        const separatorIndex = normalized.search(/[-â€“â€”:â€¢]/);\n        const name = separatorIndex > -1 ? normalized.slice(0, separatorIndex).trim() : normalized;\n        const details = separatorIndex > -1 ? normalized.slice(separatorIndex + 1).trim() : '';\n        const initials = name\n          .split(/\\s+/)\n          .filter(Boolean)\n          .slice(0, 2)\n          .map(part => part[0]?.toUpperCase() || '')\n          .join('');\n\n        return {\n          id: `team-member-${index}`,\n          name: name || normalized,\n          details: details.length > 0 ? details : null,\n          initials: initials.length > 0 ? initials : (normalized[0]?.toUpperCase() ?? 'â€¢'),\n          fullText: normalized\n        };\n      }),\n    [teamCoreMembers]\n  );\n\n  useEffect(() => {\n    if (missingShowcaseQuestions.length === 0) {\n      return;\n    }\n\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn(\n        '[ProjectShowcase] Les questions suivantes sont absentes alors que la vitrine les attend :',\n        missingShowcaseQuestions.join(', ')\n      );\n    }\n  }, [missingShowcaseQuestions]);\n\n  useEffect(() => {\n    if (renderInStandalone || typeof document === 'undefined') {\n      return undefined;\n    }\n\n    const handleKeyDown = (event) => {\n      if (event.key === 'Escape') {\n        onClose?.();\n      }\n    };\n\n    document.addEventListener('keydown', handleKeyDown);\n\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [onClose, renderInStandalone]);\n\n  useEffect(() => {\n    if (renderInStandalone) {\n      return;\n    }\n\n    if (typeof window !== 'undefined' && typeof window.scrollTo === 'function') {\n      window.scrollTo({ top: 0, behavior: 'smooth' });\n    }\n  }, [renderInStandalone]);\n\n\n  const hasTimelineProfiles = Array.isArray(timelineProfiles) && timelineProfiles.length > 0;\n  const hasManualMilestones = manualMilestones.length > 0;\n  const timelineProfileEntries = useMemo(() => {\n    if (!hasTimelineProfiles) {\n      return [];\n    }\n\n    return timelineProfiles.map((profile, index) => ({\n      id: profile.id || `profile-${index}`,\n      label: profile.label,\n      description: profile.description || ''\n    }));\n  }, [hasTimelineProfiles, timelineProfiles]);\n\n  const manualTimelineEntries = useMemo(\n    () =>\n      manualMilestones.map((milestone, index) => {\n        const hasDate = typeof milestone.formattedDate === 'string' && milestone.formattedDate.length > 0;\n        const hasDescription = typeof milestone.description === 'string' && milestone.description.length > 0;\n        const label = hasDate\n          ? milestone.formattedDate\n          : hasDescription\n            ? milestone.description\n            : 'Jalon Ã  venir';\n        const description = hasDate && hasDescription ? milestone.description : '';\n\n        return {\n          id: milestone.id || `manual-milestone-${index}`,\n          label,\n          description\n        };\n      }),\n    [manualMilestones]\n  );\n\n  const timelineEntries = useMemo(\n    () => [...timelineProfileEntries, ...manualTimelineEntries],\n    [timelineProfileEntries, manualTimelineEntries]\n  );\n  const hasTimelineEntries = timelineEntries.length > 0;\n  const timelineSummariesToDisplay = useMemo(() => {\n    if (!hasTimelineProfiles) {\n      return timelineSummariesWithAlerts;\n    }\n\n    return timelineSummariesWithAlerts.filter(summary => !summary.hasProfiles);\n  }, [hasTimelineProfiles, timelineSummariesWithAlerts]);\n  const hasTimelineSummaries = timelineSummariesToDisplay.length > 0;\n  const hasVigilanceAlerts = unmatchedVigilanceAlerts.length > 0;\n  const hasTimelineSection = Boolean(\n    runway || hasTimelineSummaries || hasManualMilestones || hasTimelineProfiles || hasVigilanceAlerts\n  );\n\n  const renderDeezerSection = useCallback((sectionId, index) => {\n    if (!shouldDisplaySection(sectionId)) {\n      return null;\n    }\n\n    switch (sectionId) {\n      case 'notice':\n        if (hideNotice || !hasIncompleteAnswers) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section deezer-section--notice\" data-showcase-section=\"notice\">\n            <p className=\"deezer-subtitle\">\n              En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.\n            </p>\n          </section>\n        );\n      case 'hero':\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"deezer-section deezer-section--hero\"\n            data-showcase-section=\"hero\"\n            data-tour-id=\"showcase-hero\"\n          >\n            <div className=\"deezer-parallax\" aria-hidden=\"true\" />\n            <p className=\"deezer-eyebrow\">Now playing</p>\n            <h1 className={`deezer-title ${missingInfoClass(safeProjectName)}`}>{safeProjectName}</h1>\n            {hasText(slogan) && (\n              <p className={`deezer-subtitle ${missingInfoClass(slogan)}`}>{renderTextWithLinks(slogan)}</p>\n            )}\n            <button type=\"button\" className=\"deezer-cta\">DÃ©couvrir le projet</button>\n            {heroHighlights.length > 0 && (\n              <div className=\"deezer-highlight-grid\">\n                {heroHighlights.map((highlight) => (\n                  <div key={highlight.id} className=\"deezer-highlight-card\">\n                    <p className=\"deezer-eyebrow\">{highlight.label}</p>\n                    <p\n                      className={`deezer-title ${missingInfoClass(highlight.value)}`}\n                      style={{ fontSize: '1.5rem' }}\n                    >\n                      {highlight.value}\n                    </p>\n                    <p className=\"deezer-subtitle\">{highlight.caption}</p>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n        );\n      case 'problem':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section\" data-showcase-section=\"problem\">\n            <p className=\"deezer-eyebrow\">Le problÃ¨me</p>\n            <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>Pourquoi ce projet doit exister</h2>\n            {problemPainPoints.length > 0 && (\n              <div className=\"deezer-grid\">\n                {problemPainPoints.map((point, pointIndex) => (\n                  <div key={`${point}-${pointIndex}`} className=\"deezer-card\">\n                    <p className=\"deezer-subtitle\">{renderTextWithLinks(point)}</p>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n        );\n      case 'solution':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section\" data-showcase-section=\"solution\">\n            <p className=\"deezer-eyebrow\">Notre solution</p>\n            <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>Comment nous changeons la donne</h2>\n            <div className=\"deezer-grid\">\n              {hasText(solutionDescription) && (\n                <div className=\"deezer-card\">\n                  <h3>En clair</h3>\n                  <p className={`deezer-subtitle ${missingInfoClass(solutionDescription)}`}>\n                    {renderTextWithLinks(solutionDescription)}\n                  </p>\n                </div>\n              )}\n              {solutionBenefits.length > 0 && (\n                <div className=\"deezer-card\">\n                  <h3>BÃ©nÃ©fices clefs</h3>\n                  <ul className=\"deezer-list\">\n                    {solutionBenefits.map((benefit, benefitIndex) => (\n                      <li key={`${benefit}-${benefitIndex}`}>{renderTextWithLinks(benefit)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(solutionComparison) && (\n                <div className=\"deezer-card\">\n                  <h3>DiffÃ©renciation</h3>\n                  <p className={`deezer-subtitle ${missingInfoClass(solutionComparison)}`}>\n                    {renderTextWithLinks(solutionComparison)}\n                  </p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'innovation':\n        if (!hasText(innovationProcess) && !hasText(visionStatement)) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section\" data-showcase-section=\"innovation\">\n            <p className=\"deezer-eyebrow\">Notre impact</p>\n            <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>DÃ©livrer le maximum de valeur</h2>\n            <div className=\"deezer-grid\">\n              {hasText(innovationProcess) && (\n                <div className=\"deezer-card\">\n                  <h3>Processus & expÃ©rimentation</h3>\n                  <p className={`deezer-subtitle ${missingInfoClass(innovationProcess)}`}>\n                    {renderTextWithLinks(innovationProcess)}\n                  </p>\n                </div>\n              )}\n              {visionStatementEntries.length > 0 && (\n                <div className=\"deezer-card\">\n                  <h3>Indicateurs de valeur</h3>\n                  <ul className=\"deezer-list\">\n                    {visionStatementEntries.map((entry, entryIndex) => (\n                      <li key={`${entry}-${entryIndex}`}>{renderTextWithLinks(entry)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(budgetEstimate) && (\n                <div className=\"deezer-card\">\n                  <h3>Budget estimÃ©</h3>\n                  <p\n                    className={`deezer-title ${missingInfoClass(budgetEstimate)}`}\n                    style={{ fontSize: '1.8rem' }}\n                  >\n                    {formattedBudgetEstimate} Kâ‚¬\n                  </p>\n                  <p className=\"deezer-subtitle\">PrÃ©vision globale sur 12 mois.</p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'team':\n        if (!hasText(teamLead) && !hasText(teamLeadTeam) && teamCoreMembers.length === 0) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section\" data-showcase-section=\"team\">\n            <p className=\"deezer-eyebrow\">Ã‰quipe & alliances</p>\n            <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>Qui porte et sÃ©curise le projet</h2>\n            <div className=\"deezer-grid\">\n              {hasText(teamLead) && (\n                <div className=\"deezer-card\">\n                  <h3>Pilotage</h3>\n                  <p className={`deezer-subtitle ${missingInfoClass(teamLead)}`}>{teamLead}</p>\n                  {hasText(teamLeadTeam) && (\n                    <p className={`deezer-subtitle ${missingInfoClass(teamLeadTeam)}`}>{teamLeadTeam}</p>\n                  )}\n                </div>\n              )}\n              {teamMemberCards.map((member) => (\n                <div key={member.id} className=\"deezer-card\">\n                  <h3>{member.name}</h3>\n                  {member.details && <p className=\"deezer-subtitle\">{member.details}</p>}\n                </div>\n              ))}\n            </div>\n          </section>\n        );\n      case 'timeline':\n        if (!hasTimelineSection) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"deezer-section\" data-showcase-section=\"timeline\" data-tour-id=\"showcase-roadmap\">\n            <p className=\"deezer-eyebrow\">Feuille de route</p>\n            <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>Les Ã©tapes clÃ©s pour livrer</h2>\n            {runway && (\n              <p className=\"deezer-subtitle\">\n                {runway.isOverdue ? (\n                  <>Le lancement prÃ©vu le {runway.launchLabel} a dÃ©jÃ  eu lieu.</>\n                ) : runway.isToday ? (\n                  <>DerniÃ¨re ligne droite : lancement aujourd'hui ({runway.launchLabel}).</>\n                ) : (\n                  <>Compte Ã  rebours : {runway.weeksLabel} ({runway.daysLabel}) avant le lancement prÃ©vu le {runway.launchLabel}.</>\n                )}\n              </p>\n            )}\n            {hasTimelineSummaries && (\n              <div className=\"deezer-grid\">\n                {timelineSummariesToDisplay.map((summary, summaryIndex) => (\n                  <div key={summary.id || `timeline-summary-${summaryIndex}`} className={`deezer-card ${summary.satisfied ? '' : 'deezer-alert'}`}>\n                    {summary?.alert?.ruleName && (\n                      <p className=\"deezer-eyebrow\">{renderTextWithLinks(summary.alert.ruleName)}</p>\n                    )}\n                    {summary?.alert?.title && (\n                      <p className=\"deezer-subtitle\">{renderTextWithLinks(summary.alert.title)}</p>\n                    )}\n                    {summary.satisfied && (\n                      <p className=\"deezer-title\" style={{ fontSize: '1.4rem' }}>{summary.weeks} semaines ({summary.days} jours)</p>\n                    )}\n                    {summary.alert?.requirementSummary && (\n                      <p className=\"deezer-subtitle\">{renderTextWithLinks(summary.alert.requirementSummary)}</p>\n                    )}\n                    {summary.alert?.statusMessage && (\n                      <p className=\"deezer-subtitle\">{renderTextWithLinks(summary.alert.statusMessage)}</p>\n                    )}\n                    {summary.alert?.teamLabel && (\n                      <p className=\"deezer-subtitle\">Ã‰quipe rÃ©fÃ©rente : {summary.alert.teamLabel}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            {hasVigilanceAlerts && (\n              <div className=\"deezer-grid\">\n                {unmatchedVigilanceAlerts.map((alert) => (\n                  <div key={alert.id} className=\"deezer-card deezer-alert\">\n                    <p className=\"deezer-eyebrow\">{alert.ruleName}</p>\n                    <p className=\"deezer-subtitle\">{renderTextWithLinks(alert.title)}</p>\n                    {alert.requirementSummary && (\n                      <p className=\"deezer-subtitle\">{alert.requirementSummary}</p>\n                    )}\n                    {alert.statusMessage && (\n                      <p className=\"deezer-subtitle\">{alert.statusMessage}</p>\n                    )}\n                    {alert.teamLabel && (\n                      <p className=\"deezer-subtitle\">Ã‰quipe rÃ©fÃ©rente : {alert.teamLabel}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            {hasTimelineEntries && (\n              <div className=\"deezer-timeline\">\n                {timelineEntries.map((entry, entryIndex) => (\n                  <div key={entry.id || `timeline-entry-${entryIndex}`} className=\"deezer-timeline-item\">\n                    <span className=\"deezer-timeline-dot\" />\n                    <div>\n                      <p className=\"deezer-subtitle\">{entry.label}</p>\n                      {entry.description && (\n                        <p className=\"deezer-subtitle\">{renderTextWithLinks(entry.description)}</p>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n        );\n      default:\n        return null;\n    }\n  }, [\n    budgetEstimate,\n    formattedBudgetEstimate,\n    hasIncompleteAnswers,\n    hasText,\n    hasTimelineEntries,\n    hasTimelineSection,\n    hasTimelineSummaries,\n    heroHighlights,\n    innovationProcess,\n    problemPainPoints,\n    runway,\n    shouldDisplaySection,\n    solutionBenefits,\n    solutionComparison,\n    solutionDescription,\n    teamCoreMembers,\n    teamLead,\n    teamLeadTeam,\n    teamMemberCards,\n    timelineEntries,\n    timelineSummariesToDisplay,\n    unmatchedVigilanceAlerts,\n    visionStatement,\n    visionStatementEntries,\n    slogan,\n    safeProjectName\n  ]);\n\n  const renderEditorialSection = useCallback((sectionId, index) => {\n    if (!shouldDisplaySection(sectionId)) {\n      return null;\n    }\n\n    switch (sectionId) {\n      case 'notice':\n        if (hideNotice || !hasIncompleteAnswers) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"editorial-section\" data-showcase-section=\"notice\">\n            <div className=\"editorial-alert\">\n              En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.\n            </div>\n          </section>\n        );\n      case 'hero':\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"editorial-section editorial-section--hero\"\n            data-showcase-section=\"hero\"\n            data-tour-id=\"showcase-hero\"\n          >\n            <div className=\"editorial-hero\">\n              <div className=\"editorial-hero__copy\">\n                <p className=\"editorial-eyebrow\">Dossier stratÃ©gique</p>\n                <h1 className={`editorial-title ${missingInfoClass(safeProjectName)}`}>{safeProjectName}</h1>\n                {hasText(slogan) && (\n                  <p className={`editorial-subtitle ${missingInfoClass(slogan)}`}>{renderTextWithLinks(slogan)}</p>\n                )}\n                <div className=\"editorial-hero__cta\">\n                  <button type=\"button\" className=\"editorial-cta\">Explorer le brief</button>\n                </div>\n              </div>\n              {heroHighlights.length > 0 && (\n                <div className=\"editorial-hero__highlights\">\n                  {heroHighlights.map((highlight) => (\n                    <div key={highlight.id} className=\"editorial-highlight\">\n                      <p className=\"editorial-highlight__label\">{highlight.label}</p>\n                      <p className={`editorial-highlight__value ${missingInfoClass(highlight.value)}`}>\n                        {highlight.value}\n                      </p>\n                      <p className=\"editorial-highlight__caption\">{highlight.caption}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'problem':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"editorial-section\" data-showcase-section=\"problem\">\n            <div className=\"editorial-section__header\">\n              <p className=\"editorial-eyebrow\">Le problÃ¨me</p>\n              <h2 className=\"editorial-section__title\">Les tensions Ã  rÃ©soudre</h2>\n            </div>\n            {problemPainPoints.length > 0 && (\n              <div className=\"editorial-grid\">\n                {problemPainPoints.map((point, pointIndex) => (\n                  <div key={`${point}-${pointIndex}`} className=\"editorial-card\">\n                    <p className=\"editorial-card__text\">{renderTextWithLinks(point)}</p>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n        );\n      case 'solution':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"editorial-section\" data-showcase-section=\"solution\">\n            <div className=\"editorial-section__header\">\n              <p className=\"editorial-eyebrow\">Notre rÃ©ponse</p>\n              <h2 className=\"editorial-section__title\">Une solution pensÃ©e pour l'exÃ©cution</h2>\n            </div>\n            <div className=\"editorial-split\">\n              {hasText(solutionDescription) && (\n                <div className=\"editorial-card editorial-card--wide\">\n                  <h3 className=\"editorial-card__title\">En clair</h3>\n                  <p className={`editorial-card__text ${missingInfoClass(solutionDescription)}`}>\n                    {renderTextWithLinks(solutionDescription)}\n                  </p>\n                </div>\n              )}\n              {solutionBenefits.length > 0 && (\n                <div className=\"editorial-card\">\n                  <h3 className=\"editorial-card__title\">BÃ©nÃ©fices clefs</h3>\n                  <ul className=\"editorial-list\">\n                    {solutionBenefits.map((benefit, benefitIndex) => (\n                      <li key={`${benefit}-${benefitIndex}`}>{renderTextWithLinks(benefit)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(solutionComparison) && (\n                <div className=\"editorial-card\">\n                  <h3 className=\"editorial-card__title\">DiffÃ©renciation</h3>\n                  <p className={`editorial-card__text ${missingInfoClass(solutionComparison)}`}>\n                    {renderTextWithLinks(solutionComparison)}\n                  </p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'innovation':\n        if (!hasText(innovationProcess) && !hasText(visionStatement) && !hasText(budgetEstimate)) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"editorial-section\" data-showcase-section=\"innovation\">\n            <div className=\"editorial-section__header\">\n              <p className=\"editorial-eyebrow\">DiffÃ©renciation & impact</p>\n              <h2 className=\"editorial-section__title\">Ce qui crÃ©e l'Ã©cart</h2>\n            </div>\n            <div className=\"editorial-grid editorial-grid--featured\">\n              {hasText(innovationProcess) && (\n                <div className=\"editorial-card\">\n                  <h3 className=\"editorial-card__title\">Processus & expÃ©rimentation</h3>\n                  <p className={`editorial-card__text ${missingInfoClass(innovationProcess)}`}>\n                    {renderTextWithLinks(innovationProcess)}\n                  </p>\n                </div>\n              )}\n              {visionStatementEntries.length > 0 && (\n                <div className=\"editorial-card\">\n                  <h3 className=\"editorial-card__title\">Indicateurs de valeur</h3>\n                  <ul className=\"editorial-list\">\n                    {visionStatementEntries.map((entry, entryIndex) => (\n                      <li key={`${entry}-${entryIndex}`}>{renderTextWithLinks(entry)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(budgetEstimate) && (\n                <div className=\"editorial-card editorial-card--accent\">\n                  <h3 className=\"editorial-card__title\">Budget estimÃ©</h3>\n                  <p className={`editorial-metric ${missingInfoClass(budgetEstimate)}`}>\n                    {formattedBudgetEstimate} Kâ‚¬\n                  </p>\n                  <p className=\"editorial-card__caption\">PrÃ©vision globale sur 12 mois.</p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'team':\n        if (!hasText(teamLead) && !hasText(teamLeadTeam) && teamCoreMembers.length === 0) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"editorial-section\" data-showcase-section=\"team\">\n            <div className=\"editorial-section__header\">\n              <p className=\"editorial-eyebrow\">Ã‰quipe & alliances</p>\n              <h2 className=\"editorial-section__title\">Les forces mobilisÃ©es</h2>\n            </div>\n            <div className=\"editorial-grid editorial-grid--team\">\n              {hasText(teamLead) && (\n                <div className=\"editorial-card editorial-card--lead\">\n                  <p className=\"editorial-card__kicker\">Pilotage</p>\n                  <h3 className={`editorial-card__title ${missingInfoClass(teamLead)}`}>{teamLead}</h3>\n                  {hasText(teamLeadTeam) && (\n                    <p className={`editorial-card__text ${missingInfoClass(teamLeadTeam)}`}>{teamLeadTeam}</p>\n                  )}\n                </div>\n              )}\n              {teamMemberCards.map((member) => (\n                <div key={member.id} className=\"editorial-card\">\n                  <h3 className=\"editorial-card__title\">{member.name}</h3>\n                  {member.details && <p className=\"editorial-card__text\">{member.details}</p>}\n                </div>\n              ))}\n            </div>\n          </section>\n        );\n      case 'timeline':\n        if (!hasTimelineSection) {\n          return null;\n        }\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"editorial-section\"\n            data-showcase-section=\"timeline\"\n            data-tour-id=\"showcase-roadmap\"\n          >\n            <div className=\"editorial-section__header\">\n              <p className=\"editorial-eyebrow\">Feuille de route</p>\n              <h2 className=\"editorial-section__title\">Les jalons clÃ©s Ã  sÃ©curiser</h2>\n            </div>\n            {runway && (\n              <p className=\"editorial-subtitle\">\n                {runway.isOverdue ? (\n                  <>Le lancement prÃ©vu le {runway.launchLabel} a dÃ©jÃ  eu lieu.</>\n                ) : runway.isToday ? (\n                  <>DerniÃ¨re ligne droite : lancement aujourd'hui ({runway.launchLabel}).</>\n                ) : (\n                  <>Compte Ã  rebours : {runway.weeksLabel} ({runway.daysLabel}) avant le lancement prÃ©vu le {runway.launchLabel}.</>\n                )}\n              </p>\n            )}\n            {hasTimelineSummaries && (\n              <div className=\"editorial-grid\">\n                {timelineSummariesToDisplay.map((summary, summaryIndex) => (\n                  <div\n                    key={summary.id || `timeline-summary-${summaryIndex}`}\n                    className={`editorial-card ${summary.satisfied ? '' : 'editorial-card--alert'}`}\n                  >\n                    {summary?.alert?.ruleName && (\n                      <p className=\"editorial-card__kicker\">{renderTextWithLinks(summary.alert.ruleName)}</p>\n                    )}\n                    {summary?.alert?.title && (\n                      <p className=\"editorial-card__text\">{renderTextWithLinks(summary.alert.title)}</p>\n                    )}\n                    {summary.satisfied && (\n                      <p className=\"editorial-metric\">{summary.weeks} semaines ({summary.days} jours)</p>\n                    )}\n                    {summary.alert?.requirementSummary && (\n                      <p className=\"editorial-card__text\">{renderTextWithLinks(summary.alert.requirementSummary)}</p>\n                    )}\n                    {summary.alert?.statusMessage && (\n                      <p className=\"editorial-card__text\">{renderTextWithLinks(summary.alert.statusMessage)}</p>\n                    )}\n                    {summary.alert?.teamLabel && (\n                      <p className=\"editorial-card__caption\">Ã‰quipe rÃ©fÃ©rente : {summary.alert.teamLabel}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            {hasVigilanceAlerts && (\n              <div className=\"editorial-grid\">\n                {unmatchedVigilanceAlerts.map((alert) => (\n                  <div key={alert.id} className=\"editorial-card editorial-card--alert\">\n                    <p className=\"editorial-card__kicker\">{alert.ruleName}</p>\n                    <p className=\"editorial-card__text\">{renderTextWithLinks(alert.title)}</p>\n                    {alert.requirementSummary && (\n                      <p className=\"editorial-card__text\">{alert.requirementSummary}</p>\n                    )}\n                    {alert.statusMessage && (\n                      <p className=\"editorial-card__text\">{alert.statusMessage}</p>\n                    )}\n                    {alert.teamLabel && (\n                      <p className=\"editorial-card__caption\">Ã‰quipe rÃ©fÃ©rente : {alert.teamLabel}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            {hasTimelineEntries && (\n              <ul className=\"editorial-timeline\">\n                {timelineEntries.map((entry, entryIndex) => (\n                  <li key={entry.id || `timeline-entry-${entryIndex}`} className=\"editorial-timeline__item\">\n                    <span className=\"editorial-timeline__dot\" />\n                    <div>\n                      <p className=\"editorial-timeline__label\">{entry.label}</p>\n                      {entry.description && (\n                        <p className=\"editorial-timeline__caption\">{renderTextWithLinks(entry.description)}</p>\n                      )}\n                    </div>\n                  </li>\n                ))}\n              </ul>\n            )}\n          </section>\n        );\n      default:\n        return null;\n    }\n  }, [\n    budgetEstimate,\n    formattedBudgetEstimate,\n    hasIncompleteAnswers,\n    hasText,\n    hasTimelineEntries,\n    hasTimelineSection,\n    hasTimelineSummaries,\n    heroHighlights,\n    innovationProcess,\n    problemPainPoints,\n    runway,\n    shouldDisplaySection,\n    solutionBenefits,\n    solutionComparison,\n    solutionDescription,\n    teamCoreMembers,\n    teamLead,\n    teamLeadTeam,\n    teamMemberCards,\n    timelineEntries,\n    timelineSummariesToDisplay,\n    unmatchedVigilanceAlerts,\n    visionStatement,\n    visionStatementEntries,\n    slogan,\n    safeProjectName\n  ]);\n\n  const renderFibclotSection = useCallback((sectionId, index) => {\n    if (!shouldDisplaySection(sectionId)) {\n      return null;\n    }\n\n    switch (sectionId) {\n      case 'notice':\n        if (hideNotice || !hasIncompleteAnswers) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"fibclot-section fibclot-section--notice\" data-showcase-section=\"notice\">\n            <div className=\"fibclot-alert\">\n              En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.\n            </div>\n          </section>\n        );\n      case 'hero':\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"fibclot-section fibclot-section--hero\"\n            data-showcase-section=\"hero\"\n            data-tour-id=\"showcase-hero\"\n          >\n            <div className=\"fibclot-hero\">\n              <div className=\"fibclot-hero__intro\">\n                <span className=\"fibclot-eyebrow\">SynthÃ¨se Fibclot</span>\n                <h1 className={`fibclot-hero__title ${missingInfoClass(safeProjectName)}`}>{safeProjectName}</h1>\n                {hasText(slogan) && (\n                  <p className={`fibclot-hero__subtitle ${missingInfoClass(slogan)}`}>\n                    {renderTextWithLinks(slogan)}\n                  </p>\n                )}\n                <div className=\"fibclot-hero__actions\">\n                  <button type=\"button\" className=\"fibclot-cta\">Explorer le dossier</button>\n                  <span className=\"fibclot-hero__tag\">Fibclot strategic view</span>\n                </div>\n              </div>\n              {heroHighlights.length > 0 && (\n                <div className=\"fibclot-hero__stats\">\n                  {heroHighlights.map((highlight) => (\n                    <div key={highlight.id} className=\"fibclot-kpi\">\n                      <p className=\"fibclot-kpi__label\">{highlight.label}</p>\n                      <p className={`fibclot-kpi__value ${missingInfoClass(highlight.value)}`}>\n                        {highlight.value}\n                      </p>\n                      <p className=\"fibclot-kpi__caption\">{highlight.caption}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'problem':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"fibclot-section\" data-showcase-section=\"problem\">\n            <div className=\"fibclot-section__header\">\n              <span className=\"fibclot-eyebrow\">Tensions</span>\n              <h2 className=\"fibclot-section__title\">Les frictions qui justifient lâ€™initiative</h2>\n            </div>\n            {problemPainPoints.length > 0 && (\n              <div className=\"fibclot-fragments\">\n                {problemPainPoints.map((point, pointIndex) => (\n                  <div key={`${point}-${pointIndex}`} className=\"fibclot-fragment\">\n                    <span className=\"fibclot-fragment__marker\" />\n                    <p className=\"fibclot-fragment__text\">{renderTextWithLinks(point)}</p>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n        );\n      case 'solution':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"fibclot-section\" data-showcase-section=\"solution\">\n            <div className=\"fibclot-section__header\">\n              <span className=\"fibclot-eyebrow\">Plan dâ€™action</span>\n              <h2 className=\"fibclot-section__title\">Architecture de la rÃ©ponse Fibclot</h2>\n            </div>\n            <div className=\"fibclot-solution\">\n              {hasText(solutionDescription) && (\n                <div className=\"fibclot-card fibclot-card--wide\">\n                  <h3 className=\"fibclot-card__title\">En clair</h3>\n                  <p className={`fibclot-card__text ${missingInfoClass(solutionDescription)}`}>\n                    {renderTextWithLinks(solutionDescription)}\n                  </p>\n                </div>\n              )}\n              {solutionBenefits.length > 0 && (\n                <div className=\"fibclot-card\">\n                  <h3 className=\"fibclot-card__title\">BÃ©nÃ©fices clefs</h3>\n                  <ul className=\"fibclot-list\">\n                    {solutionBenefits.map((benefit, benefitIndex) => (\n                      <li key={`${benefit}-${benefitIndex}`}>{renderTextWithLinks(benefit)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(solutionComparison) && (\n                <div className=\"fibclot-card fibclot-card--accent\">\n                  <h3 className=\"fibclot-card__title\">DiffÃ©renciation</h3>\n                  <p className={`fibclot-card__text ${missingInfoClass(solutionComparison)}`}>\n                    {renderTextWithLinks(solutionComparison)}\n                  </p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'innovation':\n        if (!hasText(innovationProcess) && !hasText(visionStatement)) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"fibclot-section\" data-showcase-section=\"innovation\">\n            <div className=\"fibclot-section__header\">\n              <span className=\"fibclot-eyebrow\">Impact & valeur</span>\n              <h2 className=\"fibclot-section__title\">CrÃ©er lâ€™Ã©cart avec mÃ©thode</h2>\n            </div>\n            <div className=\"fibclot-impact\">\n              {hasText(innovationProcess) && (\n                <div className=\"fibclot-impact__panel\">\n                  <p className=\"fibclot-impact__label\">Processus & expÃ©rimentation</p>\n                  <p className={`fibclot-impact__text ${missingInfoClass(innovationProcess)}`}>\n                    {renderTextWithLinks(innovationProcess)}\n                  </p>\n                </div>\n              )}\n              {visionStatementEntries.length > 0 && (\n                <div className=\"fibclot-impact__panel fibclot-impact__panel--list\">\n                  <p className=\"fibclot-impact__label\">Indicateurs de valeur</p>\n                  <ul className=\"fibclot-list\">\n                    {visionStatementEntries.map((entry, entryIndex) => (\n                      <li key={`${entry}-${entryIndex}`}>{renderTextWithLinks(entry)}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {hasText(budgetEstimate) && (\n                <div className=\"fibclot-impact__metric\" data-tour-id=\"showcase-budget\">\n                  <p className=\"fibclot-impact__label\">Budget estimÃ©</p>\n                  <p className={`fibclot-impact__value ${missingInfoClass(budgetEstimate)}`}>\n                    {formattedBudgetEstimate} Kâ‚¬\n                  </p>\n                  <p className=\"fibclot-impact__caption\">Projection sur 12 mois.</p>\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'team':\n        if (!hasText(teamLead) && !hasText(teamLeadTeam) && teamCoreMembers.length === 0) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"fibclot-section\" data-showcase-section=\"team\">\n            <div className=\"fibclot-section__header\">\n              <span className=\"fibclot-eyebrow\">Ã‰quipe & alliances</span>\n              <h2 className=\"fibclot-section__title\">Les forces mobilisÃ©es</h2>\n            </div>\n            <div className=\"fibclot-team\">\n              {hasText(teamLead) && (\n                <div className=\"fibclot-team__lead\">\n                  <p className=\"fibclot-team__label\">Pilotage</p>\n                  <h3 className={`fibclot-team__name ${missingInfoClass(teamLead)}`}>{teamLead}</h3>\n                  {hasText(teamLeadTeam) && (\n                    <p className={`fibclot-team__role ${missingInfoClass(teamLeadTeam)}`}>{teamLeadTeam}</p>\n                  )}\n                </div>\n              )}\n              {teamMemberCards.length > 0 && (\n                <div className=\"fibclot-team__grid\">\n                  {teamMemberCards.map((member) => (\n                    <div key={member.id} className=\"fibclot-team__card\">\n                      <div className=\"fibclot-team__avatar\" aria-hidden=\"true\">{member.initials}</div>\n                      <div>\n                        <p className=\"fibclot-team__member\">{member.name}</p>\n                        {member.details && (\n                          <p className=\"fibclot-team__details\">{member.details}</p>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'timeline':\n        if (!hasTimelineSection) {\n          return null;\n        }\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"fibclot-section\"\n            data-showcase-section=\"timeline\"\n            data-tour-id=\"showcase-roadmap\"\n          >\n            <div className=\"fibclot-section__header\">\n              <span className=\"fibclot-eyebrow\">Feuille de route</span>\n              <h2 className=\"fibclot-section__title\">Les jalons Ã  sÃ©curiser</h2>\n            </div>\n            {runway && (\n              <p className=\"fibclot-runway\">\n                {runway.isOverdue ? (\n                  <>Le lancement prÃ©vu le {runway.launchLabel} a dÃ©jÃ  eu lieu.</>\n                ) : runway.isToday ? (\n                  <>DerniÃ¨re ligne droite : lancement aujourd'hui ({runway.launchLabel}).</>\n                ) : (\n                  <>Compte Ã  rebours : {runway.weeksLabel} ({runway.daysLabel}) avant le lancement prÃ©vu le {runway.launchLabel}.</>\n                )}\n              </p>\n            )}\n            {hasTimelineSummaries && (\n              <div className=\"fibclot-alert-grid\">\n                {timelineSummariesToDisplay.map((summary, summaryIndex) => {\n                  const summaryRuleLabel = summary?.alert?.ruleName || summary?.ruleName;\n                  const alertTitle = summary?.alert?.title;\n                  const summaryClassName = summary.satisfied\n                    ? 'fibclot-alert-card fibclot-alert-card--ok'\n                    : 'fibclot-alert-card fibclot-alert-card--alert';\n\n                  return (\n                    <div key={summary.id || `timeline-summary-${summaryIndex}`} className={summaryClassName}>\n                      {summaryRuleLabel && (\n                        <p className=\"fibclot-alert-card__label\">{renderTextWithLinks(summaryRuleLabel)}</p>\n                      )}\n                      {alertTitle && (\n                        <p className=\"fibclot-alert-card__title\">{renderTextWithLinks(alertTitle)}</p>\n                      )}\n                      {summary.satisfied && (\n                        <p className=\"fibclot-alert-card__value\">{summary.weeks} semaines ({summary.days} jours)</p>\n                      )}\n                      {summary.alert?.requirementSummary && (\n                        <p className=\"fibclot-alert-card__text\">{renderTextWithLinks(summary.alert.requirementSummary)}</p>\n                      )}\n                      {summary.alert?.statusMessage && (\n                        <p className=\"fibclot-alert-card__text\">{renderTextWithLinks(summary.alert.statusMessage)}</p>\n                      )}\n                      {summary.alert?.teamLabel && (\n                        <p className=\"fibclot-alert-card__caption\">Ã‰quipe rÃ©fÃ©rente : {summary.alert.teamLabel}</p>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n            {hasVigilanceAlerts && (\n              <div className=\"fibclot-alert-grid\">\n                {unmatchedVigilanceAlerts.map((alert) => (\n                  <div key={alert.id} className=\"fibclot-alert-card fibclot-alert-card--alert\">\n                    <p className=\"fibclot-alert-card__label\">{alert.ruleName}</p>\n                    <p className=\"fibclot-alert-card__title\">{renderTextWithLinks(alert.title)}</p>\n                    {alert.requirementSummary && (\n                      <p className=\"fibclot-alert-card__text\">{alert.requirementSummary}</p>\n                    )}\n                    {alert.statusMessage && (\n                      <p className=\"fibclot-alert-card__text\">{alert.statusMessage}</p>\n                    )}\n                    {alert.teamLabel && (\n                      <p className=\"fibclot-alert-card__caption\">Ã‰quipe rÃ©fÃ©rente : {alert.teamLabel}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            {hasTimelineEntries && (\n              <ul className=\"fibclot-timeline\">\n                {timelineEntries.map((entry, entryIndex) => (\n                  <li key={entry.id || `timeline-entry-${entryIndex}`} className=\"fibclot-timeline__item\">\n                    <span className=\"fibclot-timeline__dot\" />\n                    <div>\n                      <p className=\"fibclot-timeline__label\">{entry.label}</p>\n                      {entry.description && (\n                        <p className=\"fibclot-timeline__caption\">{renderTextWithLinks(entry.description)}</p>\n                      )}\n                    </div>\n                  </li>\n                ))}\n              </ul>\n            )}\n          </section>\n        );\n      default:\n        return null;\n    }\n  }, [\n    formattedBudgetEstimate,\n    hasIncompleteAnswers,\n    hasText,\n    hasTimelineEntries,\n    hasTimelineSection,\n    hasTimelineSummaries,\n    heroHighlights,\n    innovationProcess,\n    problemPainPoints,\n    runway,\n    shouldDisplaySection,\n    solutionBenefits,\n    solutionComparison,\n    solutionDescription,\n    teamCoreMembers,\n    teamLead,\n    teamLeadTeam,\n    teamMemberCards,\n    timelineEntries,\n    timelineSummariesToDisplay,\n    unmatchedVigilanceAlerts,\n    visionStatement,\n    visionStatementEntries,\n    slogan,\n    safeProjectName\n  ]);\n\n  const renderBaseSection = useCallback((sectionId, index) => {\n    if (!shouldDisplaySection(sectionId)) {\n      return null;\n    }\n\n    switch (sectionId) {\n      case 'notice':\n        if (hideNotice || !hasIncompleteAnswers) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"aurora-section\" data-showcase-section=\"notice\">\n            <div className=\"aurora-section__inner aurora-section__inner--narrow\">\n              <div className=\"rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800\">\n                En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.\n              </div>\n            </div>\n          </section>\n        );\n      case 'hero':\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"aurora-section aurora-hero\"\n            data-showcase-section=\"hero\"\n            data-tour-id=\"showcase-hero\"\n          >\n            <div className=\"aurora-section__inner\">\n              <div className=\"aurora-hero__copy\">\n                <h1 className={`aurora-hero__title ${missingInfoClass(safeProjectName)}`}>{safeProjectName}</h1>\n                {hasText(slogan) && (\n                  <p className={`aurora-hero__subtitle ${missingInfoClass(slogan)}`}>\n                    {renderTextWithLinks(slogan)}\n                  </p>\n                )}\n                <div className=\"aurora-cta-group\">\n                  <button type=\"button\" className=\"aurora-cta\">DÃ©couvrir le projet</button>\n                </div>\n              </div>\n              {heroHighlights.length > 0 && (\n                <div className=\"aurora-hero__highlights\">\n                  {heroHighlights.map((highlight, highlightIndex) => (\n                    <div\n                      key={highlight.id}\n                      className=\"aurora-hero-highlight\"\n                      style={{ animationDelay: `${highlightIndex * 0.15}s` }}\n                    >\n                      <p className=\"aurora-hero-highlight__label\">{highlight.label}</p>\n                      <p className={`aurora-hero-highlight__value ${missingInfoClass(highlight.value)}`}>\n                        {highlight.value}\n                      </p>\n                      <p className=\"aurora-hero-highlight__caption\">{highlight.caption}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'problem':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"aurora-section aurora-why\" data-showcase-section=\"problem\">\n            <div className=\"aurora-section__inner aurora-section__inner--narrow\">\n              <div className=\"aurora-section__header\">\n                <p className=\"aurora-eyebrow\">Le problÃ¨me</p>\n                <h2 className=\"aurora-section__title\">Pourquoi ce projet doit exister</h2>\n              </div>\n              {problemPainPoints.length > 0 && (\n                <div className=\"aurora-why__points\">\n                  {problemPainPoints.map((point, pointIndex) => (\n                    <div\n                      key={`${point}-${pointIndex}`}\n                      className=\"aurora-why__point\"\n                      style={{ animationDelay: `${pointIndex * 0.12 + 0.1}s` }}\n                    >\n                      <span className=\"aurora-why__beam\" />\n                      <span className=\"aurora-why__text\">{renderTextWithLinks(point)}</span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </section>\n        );\n      case 'solution':\n        return (\n          <section key={`${sectionId}-${index}`} className=\"aurora-section aurora-response\" data-showcase-section=\"solution\">\n            <div className=\"aurora-section__inner\">\n              <div className=\"aurora-section__header aurora-section__header--split\">\n                <div>\n                  <p className=\"aurora-eyebrow\">Notre solution</p>\n                  <h2 className=\"aurora-section__title\">Comment nous changeons la donne</h2>\n                </div>\n              </div>\n              <div className=\"aurora-pillars\">\n                {hasText(solutionDescription) && (\n                  <div className=\"aurora-pillar\">\n                    <h3 className=\"aurora-pillar__title\">En clair</h3>\n                    <p className={`aurora-pillar__text ${missingInfoClass(solutionDescription)}`}>\n                      {renderTextWithLinks(solutionDescription)}\n                    </p>\n                  </div>\n                )}\n                {solutionBenefits.length > 0 && (\n                  <div className=\"aurora-pillar\">\n                    <h3 className=\"aurora-pillar__title\">BÃ©nÃ©fices clefs</h3>\n                    <ul className=\"aurora-pillar__list\">\n                      {solutionBenefits.map((benefit, benefitIndex) => (\n                        <li key={`${benefit}-${benefitIndex}`} className=\"aurora-pillar__item\">\n                          <span className=\"aurora-pillar__bullet\" />\n                          <span>{renderTextWithLinks(benefit)}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n                {hasText(solutionComparison) && (\n                  <div className=\"aurora-pillar\">\n                    <h3 className=\"aurora-pillar__title\">Pourquoi c'est diffÃ©rent</h3>\n                    <p className={`aurora-pillar__text ${missingInfoClass(solutionComparison)}`}>\n                      {renderTextWithLinks(solutionComparison)}\n                    </p>\n                  </div>\n                )}\n              </div>\n            </div>\n          </section>\n        );\n      case 'innovation':\n        if (!hasText(innovationProcess) && !hasText(visionStatement)) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"aurora-section aurora-difference\" data-showcase-section=\"innovation\">\n            <div className=\"aurora-section__inner\">\n              <div className=\"aurora-section__header aurora-section__header--split\">\n                <div>\n                  <p className=\"aurora-eyebrow\">Notre impact</p>\n                  <h2 className=\"aurora-section__title\">DÃ©livrer le maximum de valeur</h2>\n                </div>\n                {hasText(budgetEstimate) && (\n                  <div className=\"aurora-card aurora-card--budget\" data-tour-id=\"showcase-budget\">\n                    <p className=\"aurora-eyebrow\">Budget estimÃ©</p>\n                    <p className={`aurora-card__metric ${missingInfoClass(budgetEstimate)}`}>\n                      {formattedBudgetEstimate} Kâ‚¬\n                    </p>\n                    <p className=\"aurora-card__caption\">PrÃ©vision globale sur 12 mois.</p>\n                  </div>\n                )}\n              </div>\n              <div className=\"aurora-difference__layout\">\n                {hasText(innovationProcess) && (\n                  <div className=\"aurora-difference__text\">\n                    <div className=\"aurora-difference__text-section\">\n                      <p className=\"aurora-eyebrow\">Comment on s'y prend</p>\n                      <p className=\"aurora-difference__label\">Processus & expÃ©rimentation</p>\n                      <div className=\"aurora-difference__text-content\">\n                        <span className={missingInfoClass(innovationProcess)}>\n                          {renderTextWithLinks(innovationProcess)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n                {visionStatementEntries.length > 0 && (\n                  <div className=\"aurora-difference__metrics\">\n                    <p className=\"aurora-eyebrow\">Indicateurs de valeur</p>\n                    <p className=\"aurora-difference__label\">Comment nous mesurons l'impact</p>\n                    <ul className=\"aurora-difference__metrics-list\">\n                      {visionStatementEntries.map((entry, entryIndex) => (\n                        <li key={`${entry}-${entryIndex}`} className=\"aurora-difference__metrics-item\">\n                          <span className=\"aurora-difference__metrics-bullet\" />\n                          <span className=\"aurora-difference__metrics-text\">{renderTextWithLinks(entry)}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </div>\n            </div>\n          </section>\n        );\n      case 'team':\n        if (!hasText(teamLead) && !hasText(teamLeadTeam) && teamCoreMembers.length === 0) {\n          return null;\n        }\n        return (\n          <section key={`${sectionId}-${index}`} className=\"aurora-section aurora-team\" data-showcase-section=\"team\">\n            <div className=\"aurora-section__inner\">\n              <div className=\"aurora-section__header aurora-section__header--split\">\n                <div>\n                  <p className=\"aurora-eyebrow\">Ã‰quipe & alliances</p>\n                  <h2 className=\"aurora-section__title\">Qui porte et sÃ©curise le projet</h2>\n                </div>\n              </div>\n              <div className=\"aurora-team__layout\">\n                {hasText(teamLead) && (\n                  <div className=\"aurora-team__lead\">\n                    <div className=\"aurora-team__lead-info\">\n                      <p className=\"aurora-team__lead-label\">Pilotage</p>\n                      <h3 className={`aurora-team__lead-name ${missingInfoClass(teamLead)}`}>{teamLead}</h3>\n                      {hasText(teamLeadTeam) && (\n                        <p className={`aurora-team__lead-team ${missingInfoClass(teamLeadTeam)}`}>\n                          {teamLeadTeam}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                )}\n                {teamMemberCards.length > 0 && (\n                  <div className=\"aurora-team__members\">\n                    <p className=\"aurora-team__members-label\">Ã‰quipe cÅ“ur</p>\n                    <div className=\"aurora-team__carousel\">\n                      {teamMemberCards.map((member, memberIndex) => (\n                        <div key={member.id ?? `${member.name}-${memberIndex}`} className=\"aurora-team__card\">\n                          <div className=\"aurora-team__avatar\" aria-hidden=\"true\">\n                            {member.initials}\n                          </div>\n                          <div className=\"aurora-team__card-text\">\n                            <p className=\"aurora-team__card-name\">{member.name}</p>\n                            {member.details && (\n                              <p className=\"aurora-team__card-role\">{member.details}</p>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </section>\n        );\n      case 'timeline':\n        if (!hasTimelineSection) {\n          return null;\n        }\n        return (\n          <section\n            key={`${sectionId}-${index}`}\n            className=\"aurora-section aurora-roadmap\"\n            data-showcase-section=\"timeline\"\n            data-tour-id=\"showcase-roadmap\"\n          >\n            <div className=\"aurora-section__inner\">\n              <div className=\"aurora-section__header aurora-section__header--split\">\n                <div>\n                  <p className=\"aurora-eyebrow\">Feuille de route</p>\n                  <h2 className=\"aurora-section__title\">Les Ã©tapes clÃ©s pour livrer</h2>\n                </div>\n                {hasText(runway?.launchLabel) && (\n                  <div className=\"aurora-chip aurora-chip--tone\">\n                    <span className=\"aurora-chip__dot\" />\n                    {runway.launchLabel}\n                  </div>\n                )}\n              </div>\n              {runway && (\n                <p className=\"aurora-roadmap__intro\">\n                  {runway.isOverdue ? (\n                    <>Le lancement prÃ©vu le {runway.launchLabel} a dÃ©jÃ  eu lieu.</>\n                  ) : runway.isToday ? (\n                    <>DerniÃ¨re ligne droite : lancement aujourd'hui ({runway.launchLabel}).</>\n                  ) : (\n                    <>\n                      Compte Ã  rebours : <span>{runway.weeksLabel}</span> ({runway.daysLabel}) avant le lancement prÃ©vu le {runway.launchLabel}.\n                    </>\n                  )}\n                </p>\n              )}\n              {hasTimelineSummaries && (\n                timelineSummariesToDisplay.map((summary, summaryIndex) => {\n                  const summaryRuleLabel = summary?.alert?.ruleName || summary?.ruleName;\n                  const alertTitle = summary?.alert?.title;\n\n                  return (\n                    <div\n                      key={summary.id || `timeline-summary-${summaryIndex}`}\n                      className={`${\n                        summary.satisfied\n                          ? 'aurora-roadmap__summary aurora-roadmap__summary--ok'\n                          : 'aurora-roadmap__summary aurora-roadmap__summary--alert'\n                      }`}\n                      style={{ animationDelay: `${summaryIndex * 0.08}s` }}\n                    >\n                      {summaryRuleLabel && (\n                        <p className=\"aurora-roadmap__label\">\n                          {renderTextWithLinks(summaryRuleLabel)}\n                        </p>\n                      )}\n                      {alertTitle && (\n                        <p className=\"aurora-roadmap__summary-title\">\n                          {renderTextWithLinks(alertTitle)}\n                        </p>\n                      )}\n                      {summary.satisfied && (\n                        <>\n                          <p className=\"aurora-roadmap__value\">{summary.weeks} semaines ({summary.days} jours)</p>\n                          <p className=\"aurora-roadmap__caption\">Runway conforme aux exigences identifiÃ©es.</p>\n                        </>\n                      )}\n                      {summary.alert?.requirementSummary && (\n                        <p className=\"aurora-roadmap__summary-detail\">\n                          {renderTextWithLinks(summary.alert.requirementSummary)}\n                        </p>\n                      )}\n                      {summary.alert?.statusMessage && (\n                        <p className=\"aurora-roadmap__summary-detail aurora-roadmap__summary-detail--status\">\n                          {renderTextWithLinks(summary.alert.statusMessage)}\n                        </p>\n                      )}\n                      {summary.alert?.teamLabel && (\n                        <p className=\"aurora-roadmap__summary-team\">Ã‰quipe rÃ©fÃ©rente : {summary.alert.teamLabel}</p>\n                      )}\n                    </div>\n                  );\n                })\n              )}\n              {hasVigilanceAlerts && (\n                <div className=\"aurora-roadmap__watchpoints\">\n                  {unmatchedVigilanceAlerts.map((alert, alertIndex) => (\n                    <div\n                      key={alert.id}\n                      className={`aurora-roadmap__watchpoint aurora-roadmap__watchpoint--${alert.status}`}\n                      style={{ animationDelay: `${alertIndex * 0.08}s` }}\n                    >\n                      <p className=\"aurora-roadmap__watchpoint-eyebrow\">{alert.ruleName}</p>\n                      <p className=\"aurora-roadmap__watchpoint-title\">{renderTextWithLinks(alert.title)}</p>\n                      {alert.requirementSummary && (\n                        <p className=\"aurora-roadmap__watchpoint-text\">{alert.requirementSummary}</p>\n                      )}\n                      {alert.statusMessage && (\n                        <p className=\"aurora-roadmap__watchpoint-caption\">{alert.statusMessage}</p>\n                      )}\n                      {alert.teamLabel && (\n                        <p className=\"aurora-roadmap__watchpoint-team\">Ã‰quipe rÃ©fÃ©rente : {alert.teamLabel}</p>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n              {hasTimelineEntries && (\n                <ul className=\"aurora-roadmap__timeline\">\n                  {timelineEntries.map((entry, entryIndex) => (\n                    <li\n                      key={entry.id || `timeline-entry-${entryIndex}`}\n                      className=\"aurora-roadmap__step\"\n                      style={{ animationDelay: `${entryIndex * 0.1}s` }}\n                    >\n                      <span className=\"aurora-roadmap__node\" />\n                      <div>\n                        <p className=\"aurora-roadmap__label\">{entry.label}</p>\n                        {entry.description && (\n                          <p className=\"aurora-roadmap__caption\">{renderTextWithLinks(entry.description)}</p>\n                        )}\n                      </div>\n                    </li>\n                  ))}\n                </ul>\n              )}\n            </div>\n          </section>\n        );\n      default:\n        return null;\n    }\n  }, [\n    formattedBudgetEstimate,\n    hasIncompleteAnswers,\n    hasText,\n    hasTimelineEntries,\n    hasTimelineSection,\n    hasTimelineSummaries,\n    heroHighlights,\n    innovationProcess,\n    problemPainPoints,\n    runway,\n    shouldDisplaySection,\n    solutionBenefits,\n    solutionComparison,\n    solutionDescription,\n    teamCoreMembers,\n    teamLead,\n    teamLeadTeam,\n    timelineEntries,\n    timelineSummariesToDisplay,\n    unmatchedVigilanceAlerts,\n    visionStatement,\n    visionStatementEntries,\n    slogan,\n    safeProjectName\n  ]);\n\n  const renderCustomSection = useCallback((section, index) => {\n    if (!section) {\n      return null;\n    }\n\n    const templateConfig = resolveTemplateConfig(section.type);\n    const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n    const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n    const activeColumns = columns.filter(column => column.trim().length > 0);\n\n    const badgeLabel = section.accent || 'Badge';\n    const headerBadgeLabel = templateConfig.showBadge\n      ? badgeLabel\n      : `Bloc personnalisÃ© #${index + 1}`;\n    const innerClassName = section.type === 'aurora-section__inner'\n      ? 'aurora-section__inner'\n      : 'aurora-section__inner aurora-section__inner--narrow';\n\n    return (\n      <section\n        key={section.id}\n        className=\"aurora-section aurora-section--custom\"\n        data-showcase-section={section.type || 'custom'}\n      >\n        <div className={innerClassName}>\n          <div className=\"aurora-section__header aurora-section__header--split\">\n            <div>\n              {templateConfig.showAccent && (\n                <p className=\"aurora-eyebrow\">{renderTextWithLinks(section.accent || 'Section additionnelle')}</p>\n              )}\n              <h2 className=\"aurora-section__title\">{renderTextWithLinks(section.title || 'Section personnalisÃ©e')}</h2>\n              {templateConfig.showSubtitle && section.subtitle && (\n                <p className=\"mt-1 text-sm text-gray-600\">{renderTextWithLinks(section.subtitle)}</p>\n              )}\n            </div>\n            <div className=\"aurora-chip aurora-chip--ghost\">{renderTextWithLinks(headerBadgeLabel)}</div>\n          </div>\n          {templateConfig.showDescription && section.description && (\n            <p className=\"aurora-body-text\">{renderTextWithLinks(section.description)}</p>\n          )}\n          {templateConfig.showColumns && activeColumns.length > 0 && (\n            <div\n              className=\"mt-6 grid gap-4\"\n              style={{ gridTemplateColumns: `repeat(${Math.min(columnCount, activeColumns.length)}, minmax(0, 1fr))` }}\n            >\n              {activeColumns.map((column, columnIndex) => (\n                <div\n                  key={`${section.id}-column-${columnIndex}`}\n                  className=\"rounded-2xl border border-gray-100 bg-white/70 p-4 text-sm text-gray-700 shadow-sm\"\n                >\n                  <p className=\"whitespace-pre-line\">{renderTextWithLinks(column)}</p>\n                </div>\n              ))}\n            </div>\n          )}\n          {templateConfig.showDocument && section.documentUrl && (\n            <div className=\"mt-6 space-y-3 rounded-2xl border border-gray-200 bg-white p-4 shadow-sm\">\n              <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                <div>\n                  <p className=\"text-sm font-semibold text-gray-800\">Visionneuse documentaire</p>\n                  <p className=\"text-xs text-gray-500\">Source SharePoint â€¢ {section.documentType?.toUpperCase() || 'DOC'}</p>\n                </div>\n                <a\n                  href={section.documentUrl}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"text-sm font-semibold text-blue-600 hover:text-blue-700\"\n                >\n                  Ouvrir dans un nouvel onglet\n                </a>\n              </div>\n              {['jpg', 'png'].includes(section.documentType) ? (\n                <img\n                  src={section.documentUrl}\n                  alt={`Document ${section.title || 'section personnalisÃ©e'}`}\n                  className=\"max-h-96 w-full rounded-xl border border-gray-100 object-contain\"\n                  loading=\"lazy\"\n                  decoding=\"async\"\n                />\n              ) : (\n                <iframe\n                  title={`Document ${section.title || 'section personnalisÃ©e'}`}\n                  src={resolveDocumentEmbedSrc(section.documentUrl, section.documentType)}\n                  className=\"h-80 w-full rounded-xl border border-gray-100\"\n                  loading=\"lazy\"\n                />\n              )}\n              <p className=\"text-xs text-gray-500\">\n                Pour les prÃ©sentations PPTX, utilisez un lien SharePoint accessible ou un lien dâ€™intÃ©gration Office.\n              </p>\n            </div>\n          )}\n          {templateConfig.showItems && Array.isArray(section.items) && section.items.length > 0 && (\n            <ul className=\"mt-4 space-y-3\">\n              {section.items.map((item, itemIndex) => (\n                <li key={`${section.id}-item-${itemIndex}`} className=\"flex items-start gap-3\">\n                  <span className=\"mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-gradient-to-r from-blue-500 to-teal-400 text-xs font-semibold text-white\">\n                    {itemIndex + 1}\n                  </span>\n                  <span className=\"text-base text-gray-800\">{renderTextWithLinks(item)}</span>\n                </li>\n              ))}\n            </ul>\n          )}\n        </div>\n      </section>\n    );\n  }, []);\n\n  const renderCustomSectionFibclot = useCallback((section, index) => {\n    if (!section) {\n      return null;\n    }\n\n    const templateConfig = resolveTemplateConfig(section.type);\n    const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n    const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n    const activeColumns = columns.filter(column => column.trim().length > 0);\n\n    const badgeLabel = section.accent || 'Badge';\n    const headerBadgeLabel = templateConfig.showBadge\n      ? badgeLabel\n      : `Bloc personnalisÃ© #${index + 1}`;\n\n    return (\n      <section\n        key={section.id}\n        className=\"fibclot-section fibclot-section--custom\"\n        data-showcase-section={section.type || 'custom'}\n      >\n        <div className=\"fibclot-section__header\">\n          {templateConfig.showAccent && (\n            <span className=\"fibclot-eyebrow\">{renderTextWithLinks(section.accent || 'Section additionnelle')}</span>\n          )}\n          <h2 className=\"fibclot-section__title\">{renderTextWithLinks(section.title || 'Section personnalisÃ©e')}</h2>\n          {templateConfig.showBadge && (\n            <span className=\"fibclot-badge\">{renderTextWithLinks(headerBadgeLabel)}</span>\n          )}\n        </div>\n        {templateConfig.showSubtitle && section.subtitle && (\n          <p className=\"fibclot-subtitle\">{renderTextWithLinks(section.subtitle)}</p>\n        )}\n        {templateConfig.showDescription && section.description && (\n          <p className=\"fibclot-card__text\">{renderTextWithLinks(section.description)}</p>\n        )}\n        {templateConfig.showColumns && activeColumns.length > 0 && (\n          <div\n            className=\"fibclot-columns\"\n            style={{ gridTemplateColumns: `repeat(${Math.min(columnCount, activeColumns.length)}, minmax(0, 1fr))` }}\n          >\n            {activeColumns.map((column, columnIndex) => (\n              <div key={`${section.id}-column-${columnIndex}`} className=\"fibclot-card\">\n                <p className=\"fibclot-card__text\">{renderTextWithLinks(column)}</p>\n              </div>\n            ))}\n          </div>\n        )}\n        {templateConfig.showDocument && section.documentUrl && (\n          <div className=\"fibclot-card fibclot-card--document\">\n            <div className=\"fibclot-document__header\">\n              <div>\n                <p className=\"fibclot-card__title\">Visionneuse documentaire</p>\n                <p className=\"fibclot-card__caption\">Source SharePoint â€¢ {section.documentType?.toUpperCase() || 'DOC'}</p>\n              </div>\n              <a\n                href={section.documentUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"fibclot-link\"\n              >\n                Ouvrir dans un nouvel onglet\n              </a>\n            </div>\n            {['jpg', 'png'].includes(section.documentType) ? (\n              <img\n                src={section.documentUrl}\n                alt={`Document ${section.title || 'section personnalisÃ©e'}`}\n                className=\"fibclot-document__media\"\n                loading=\"lazy\"\n                decoding=\"async\"\n              />\n            ) : (\n              <iframe\n                title={`Document ${section.title || 'section personnalisÃ©e'}`}\n                src={resolveDocumentEmbedSrc(section.documentUrl, section.documentType)}\n                className=\"fibclot-document__media\"\n                loading=\"lazy\"\n              />\n            )}\n          </div>\n        )}\n        {templateConfig.showItems && Array.isArray(section.items) && section.items.length > 0 && (\n          <ul className=\"fibclot-list fibclot-list--stacked\">\n            {section.items.map((item, itemIndex) => (\n              <li key={`${section.id}-item-${itemIndex}`}>{renderTextWithLinks(item)}</li>\n            ))}\n          </ul>\n        )}\n      </section>\n    );\n  }, []);\n\n  const renderCustomSectionDeezer = useCallback((section, index) => {\n    if (!section) {\n      return null;\n    }\n\n    const templateConfig = resolveTemplateConfig(section.type);\n    const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n    const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n    const activeColumns = columns.filter(column => column.trim().length > 0);\n\n    const badgeLabel = section.accent || 'Badge';\n    const headerBadgeLabel = templateConfig.showBadge\n      ? badgeLabel\n      : `Bloc personnalisÃ© #${index + 1}`;\n\n    return (\n      <section\n        key={section.id}\n        className=\"deezer-section deezer-section--custom\"\n        data-showcase-section={section.type || 'custom'}\n      >\n        {templateConfig.showAccent && (\n          <p className=\"deezer-eyebrow\">{renderTextWithLinks(section.accent || 'Section additionnelle')}</p>\n        )}\n        {templateConfig.showBadge && (\n          <div className=\"aurora-chip aurora-chip--ghost\">{renderTextWithLinks(headerBadgeLabel)}</div>\n        )}\n        <h2 className=\"deezer-title\" style={{ fontSize: '2rem' }}>{renderTextWithLinks(section.title || 'Section personnalisÃ©e')}</h2>\n        {templateConfig.showSubtitle && section.subtitle && (\n          <p className=\"deezer-subtitle\">{renderTextWithLinks(section.subtitle)}</p>\n        )}\n        {templateConfig.showDescription && section.description && (\n          <p className=\"deezer-subtitle\">{renderTextWithLinks(section.description)}</p>\n        )}\n        {templateConfig.showColumns && activeColumns.length > 0 && (\n          <div\n            className=\"deezer-grid\"\n            style={{ gridTemplateColumns: `repeat(${Math.min(columnCount, activeColumns.length)}, minmax(0, 1fr))` }}\n          >\n            {activeColumns.map((column, columnIndex) => (\n              <div key={`${section.id}-column-${columnIndex}`} className=\"deezer-card\">\n                <p className=\"deezer-subtitle\">{renderTextWithLinks(column)}</p>\n              </div>\n            ))}\n          </div>\n        )}\n        {templateConfig.showDocument && section.documentUrl && (\n          <div className=\"deezer-card\">\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\n              <div>\n                <p className=\"deezer-subtitle\">Visionneuse documentaire</p>\n                <p className=\"deezer-subtitle\">Source SharePoint â€¢ {section.documentType?.toUpperCase() || 'DOC'}</p>\n              </div>\n              <a\n                href={section.documentUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"deezer-subtitle\"\n              >\n                Ouvrir dans un nouvel onglet\n              </a>\n            </div>\n            {['jpg', 'png'].includes(section.documentType) ? (\n              <img\n                src={section.documentUrl}\n                alt={`Document ${section.title || 'section personnalisÃ©e'}`}\n                className=\"mt-4 max-h-96 w-full rounded-xl border border-white/10 object-contain\"\n                loading=\"lazy\"\n                decoding=\"async\"\n              />\n            ) : (\n              <iframe\n                title={`Document ${section.title || 'section personnalisÃ©e'}`}\n                src={resolveDocumentEmbedSrc(section.documentUrl, section.documentType)}\n                className=\"mt-4 h-80 w-full rounded-xl border border-white/10\"\n                loading=\"lazy\"\n              />\n            )}\n          </div>\n        )}\n        {templateConfig.showItems && Array.isArray(section.items) && section.items.length > 0 && (\n          <ul className=\"deezer-list\">\n            {section.items.map((item, itemIndex) => (\n              <li key={`${section.id}-item-${itemIndex}`}>{renderTextWithLinks(item)}</li>\n            ))}\n          </ul>\n        )}\n      </section>\n    );\n  }, []);\n\n  const renderCustomSectionEditorial = useCallback((section, index) => {\n    if (!section) {\n      return null;\n    }\n\n    const templateConfig = resolveTemplateConfig(section.type);\n    const columnCount = resolveCustomSectionColumnCount(section.columnCount, section.columns);\n    const columns = normalizeCustomSectionColumns(section.columns, columnCount);\n    const activeColumns = columns.filter(column => column.trim().length > 0);\n\n    const badgeLabel = section.accent || 'Badge';\n    const headerBadgeLabel = templateConfig.showBadge\n      ? badgeLabel\n      : `Bloc personnalisÃ© #${index + 1}`;\n\n    return (\n      <section\n        key={section.id}\n        className=\"editorial-section editorial-section--custom\"\n        data-showcase-section={section.type || 'custom'}\n      >\n        <div className=\"editorial-section__header\">\n          {templateConfig.showAccent && (\n            <p className=\"editorial-eyebrow\">{renderTextWithLinks(section.accent || 'Section additionnelle')}</p>\n          )}\n          <h2 className=\"editorial-section__title\">{renderTextWithLinks(section.title || 'Section personnalisÃ©e')}</h2>\n          {templateConfig.showBadge && (\n            <span className=\"editorial-badge\">{renderTextWithLinks(headerBadgeLabel)}</span>\n          )}\n        </div>\n        {templateConfig.showSubtitle && section.subtitle && (\n          <p className=\"editorial-subtitle\">{renderTextWithLinks(section.subtitle)}</p>\n        )}\n        {templateConfig.showDescription && section.description && (\n          <p className=\"editorial-card__text\">{renderTextWithLinks(section.description)}</p>\n        )}\n        {templateConfig.showColumns && activeColumns.length > 0 && (\n          <div\n            className=\"editorial-grid\"\n            style={{ gridTemplateColumns: `repeat(${Math.min(columnCount, activeColumns.length)}, minmax(0, 1fr))` }}\n          >\n            {activeColumns.map((column, columnIndex) => (\n              <div key={`${section.id}-column-${columnIndex}`} className=\"editorial-card\">\n                <p className=\"editorial-card__text\">{renderTextWithLinks(column)}</p>\n              </div>\n            ))}\n          </div>\n        )}\n        {templateConfig.showDocument && section.documentUrl && (\n          <div className=\"editorial-card editorial-card--document\">\n            <div className=\"editorial-document__header\">\n              <div>\n                <p className=\"editorial-card__kicker\">Visionneuse documentaire</p>\n                <p className=\"editorial-card__caption\">Source SharePoint â€¢ {section.documentType?.toUpperCase() || 'DOC'}</p>\n              </div>\n              <a\n                href={section.documentUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"editorial-link\"\n              >\n                Ouvrir dans un nouvel onglet\n              </a>\n            </div>\n            {['jpg', 'png'].includes(section.documentType) ? (\n              <img\n                src={section.documentUrl}\n                alt={`Document ${section.title || 'section personnalisÃ©e'}`}\n                className=\"editorial-document__media\"\n                loading=\"lazy\"\n                decoding=\"async\"\n              />\n            ) : (\n              <iframe\n                title={`Document ${section.title || 'section personnalisÃ©e'}`}\n                src={resolveDocumentEmbedSrc(section.documentUrl, section.documentType)}\n                className=\"editorial-document__media\"\n                loading=\"lazy\"\n              />\n            )}\n          </div>\n        )}\n        {templateConfig.showItems && Array.isArray(section.items) && section.items.length > 0 && (\n          <ul className=\"editorial-list\">\n            {section.items.map((item, itemIndex) => (\n              <li key={`${section.id}-item-${itemIndex}`}>{renderTextWithLinks(item)}</li>\n            ))}\n          </ul>\n        )}\n      </section>\n    );\n  }, []);\n\n  const orderedSections = useMemo(() => {\n    const sections = [];\n    sectionOrder.forEach((sectionId, index) => {\n      if (!shouldDisplaySection(sectionId)) {\n        return;\n      }\n\n      const activeRenderCustomSection = isDeezerTheme\n        ? renderCustomSectionDeezer\n        : isEditorialTheme\n          ? renderCustomSectionEditorial\n          : isFibclotTheme\n            ? renderCustomSectionFibclot\n            : renderCustomSection;\n      if (customSectionMap.has(sectionId)) {\n        const renderedCustom = activeRenderCustomSection(customSectionMap.get(sectionId), index);\n        if (renderedCustom) {\n          sections.push(renderedCustom);\n        }\n        return;\n      }\n\n      const rendered = (\n        isDeezerTheme\n          ? renderDeezerSection\n          : isEditorialTheme\n            ? renderEditorialSection\n            : isFibclotTheme\n              ? renderFibclotSection\n              : renderBaseSection\n      )(sectionId, index);\n      if (rendered) {\n        sections.push(rendered);\n      }\n    });\n\n    return sections;\n  }, [\n    customSectionMap,\n    isDeezerTheme,\n    isEditorialTheme,\n    isFibclotTheme,\n    renderBaseSection,\n    renderCustomSection,\n    renderCustomSectionFibclot,\n    renderCustomSectionDeezer,\n    renderCustomSectionEditorial,\n    renderDeezerSection,\n    renderEditorialSection,\n    renderFibclotSection,\n    sectionOrder,\n    shouldDisplaySection\n  ]);\n\n  const sectionDescriptors = useMemo(() => {\n    return sectionOrder.map((sectionId) => {\n      const custom = customSectionMap.get(sectionId);\n      if (custom) {\n        return {\n          id: sectionId,\n          title: custom.title || 'Bloc personnalisÃ©',\n          subtitle: 'Section personnalisÃ©e',\n          isCustom: true\n        };\n      }\n\n      const option = SHOWCASE_SECTION_OPTIONS.find(section => section.id === sectionId);\n      return {\n        id: sectionId,\n        title: option?.label || sectionId,\n        subtitle: 'Section standard',\n        isCustom: false\n      };\n    });\n  }, [customSectionMap, sectionOrder]);\n\n  const selectedTemplate = SECTION_TEMPLATES[selectedTemplateIndex] || SECTION_TEMPLATES[0];\n  const selectedTemplateConfig = resolveTemplateConfig(selectedTemplate?.id);\n  const templateAccentClasses = {\n    highlight: 'from-blue-500/80 via-cyan-400/70 to-emerald-300/70',\n    'aurora-section__inner': 'from-sky-500/80 via-indigo-400/70 to-fuchsia-300/70',\n    columns: 'from-indigo-500/80 via-purple-400/70 to-fuchsia-300/70',\n    'document-viewer': 'from-emerald-500/80 via-teal-400/70 to-sky-300/70',\n    story: 'from-amber-400/80 via-orange-300/70 to-rose-300/70',\n    checklist: 'from-lime-500/80 via-emerald-400/70 to-teal-300/70'\n  };\n  const selectedTemplateAccent =\n    templateAccentClasses[selectedTemplate?.id] || templateAccentClasses.highlight;\n\n  const renderTemplateThumbnail = (templateId) => {\n    switch (templateId) {\n      case 'aurora-section__inner':\n        return (\n          <div className=\"mt-4 space-y-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <div className=\"h-3 w-24 rounded-full bg-sky-200\" />\n              <div className=\"h-5 w-12 rounded-full bg-indigo-100\" />\n            </div>\n            <div className=\"flex items-end justify-between rounded-2xl bg-slate-50 px-4 py-6\">\n              <div className=\"space-y-2\">\n                <div className=\"h-2 w-24 rounded-full bg-gray-200\" />\n                <div className=\"h-2 w-16 rounded-full bg-gray-100\" />\n              </div>\n              <div className=\"text-2xl font-semibold text-indigo-400\">98%</div>\n            </div>\n          </div>\n        );\n      case 'columns':\n        return (\n          <div className=\"mt-4 grid grid-cols-3 gap-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"col-span-3 h-3 rounded-full bg-gradient-to-r from-indigo-500/80 via-purple-400/70 to-fuchsia-300/70\" />\n            {Array.from({ length: 3 }).map((_, index) => (\n              <div key={`columns-preview-${index}`} className=\"rounded-lg bg-gray-50 p-2\">\n                <div className=\"flex h-16 items-end justify-center gap-1\">\n                  <div className=\"h-10 w-2 rounded-full bg-indigo-200\" />\n                  <div className=\"h-14 w-2 rounded-full bg-purple-200\" />\n                  <div className=\"h-12 w-2 rounded-full bg-fuchsia-200\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        );\n      case 'document-viewer':\n        return (\n          <div className=\"mt-4 space-y-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <div className=\"h-3 w-28 rounded-full bg-gray-200\" />\n              <div className=\"h-3 w-16 rounded-full bg-emerald-100\" />\n            </div>\n            <div className=\"h-2 w-40 rounded-full bg-gray-100\" />\n            <div className=\"h-28 rounded-xl border border-emerald-100 bg-gradient-to-br from-emerald-50 to-emerald-100\" />\n          </div>\n        );\n      case 'story':\n        return (\n          <div className=\"mt-4 space-y-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"h-3 w-32 rounded-full bg-amber-300/80\" />\n            <div className=\"space-y-2\">\n              <div className=\"h-2 rounded-full bg-gray-100\" />\n              <div className=\"h-2 w-11/12 rounded-full bg-gray-100\" />\n              <div className=\"h-2 w-10/12 rounded-full bg-gray-100\" />\n              <div className=\"h-2 w-9/12 rounded-full bg-gray-100\" />\n            </div>\n          </div>\n        );\n      case 'checklist':\n        return (\n          <div className=\"mt-4 space-y-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"h-3 w-28 rounded-full bg-lime-300/80\" />\n            <div className=\"space-y-2\">\n              {Array.from({ length: 4 }).map((_, index) => (\n                <div key={`checklist-preview-${index}`} className=\"flex items-center gap-2\">\n                  <div className=\"h-3 w-3 rounded-full bg-emerald-400/80\" />\n                  <div className=\"h-2 w-full rounded-full bg-gray-100\" />\n                </div>\n              ))}\n            </div>\n          </div>\n        );\n      case 'highlight':\n      default:\n        return (\n          <div className=\"mt-4 space-y-3 rounded-xl bg-white p-4 shadow-inner\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <div className=\"h-3 w-24 rounded-full bg-blue-200\" />\n              <div className=\"h-6 w-12 rounded-full bg-blue-100\" />\n            </div>\n            <div className=\"flex h-20 items-end justify-center gap-3 rounded-xl bg-blue-50\">\n              <div className=\"h-16 w-6 rounded-lg bg-blue-200\" />\n              <div className=\"h-20 w-6 rounded-lg bg-blue-100\" />\n              <div className=\"h-12 w-6 rounded-lg bg-blue-200\" />\n            </div>\n            <div className=\"h-2 w-3/4 rounded-full bg-gray-200\" />\n          </div>\n        );\n    }\n  };\n\n  const previewClassName = isDeezerTheme\n    ? 'deezer-sections'\n    : isEditorialTheme\n      ? 'editorial-sections'\n      : isFibclotTheme\n        ? 'fibclot-sections'\n        : 'aurora-sections';\n\n  const previewContent = shouldShowPreview ? (\n    <div className={previewClassName} data-tour-id=\"showcase-preview\">\n      {orderedSections}\n    </div>\n  ) : (\n    <div className=\"aurora-preview-placeholder\">\n      <h2 className=\"aurora-preview-placeholder__title\">Mode Ã©dition activÃ©</h2>\n      <p className=\"aurora-preview-placeholder__text\">\n        Le rendu est temporairement masquÃ© pendant vos ajustements.\n      </p>\n    </div>\n  );\n\n  const sectionModal = isSectionModalOpen ? (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4\">\n      <div className=\"absolute inset-0\" onClick={handleCloseSectionModal} aria-hidden=\"true\" />\n      <div\n        className=\"relative z-10 w-full max-w-4xl max-h-[calc(100vh-2rem)] overflow-y-auto rounded-2xl bg-white p-6 shadow-2xl\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n      >\n        <div className=\"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between\">\n          <div>\n            <p className=\"aurora-eyebrow aurora-eyebrow--soft\">Nouvelle section</p>\n            <h3 className=\"text-xl font-bold text-gray-900\">Choisissez un modÃ¨le puis complÃ©tez son contenu</h3>\n            <p className=\"text-sm text-gray-600\">Les miniatures donnent un aperÃ§u rapide du rendu final.</p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleCloseSectionModal}\n            className=\"rounded-full border border-gray-200 px-3 py-1 text-sm text-gray-600 transition hover:border-gray-300 hover:text-gray-800\"\n          >\n            Fermer\n          </button>\n        </div>\n\n        {sectionModalStep === 'templates' ? (\n          <div className=\"mt-6 space-y-4\">\n            <div className=\"flex flex-col items-center gap-4 md:flex-row md:items-stretch\">\n              <button\n                type=\"button\"\n                onClick={() => handleTemplateNavigation(-1)}\n                className=\"flex h-12 w-12 items-center justify-center rounded-full border border-gray-200 text-gray-700 transition hover:border-blue-200 hover:text-blue-700\"\n                aria-label=\"ModÃ¨le prÃ©cÃ©dent\"\n              >\n                â†\n              </button>\n              <div className=\"flex-1 rounded-2xl border border-gray-200 bg-gradient-to-br from-white to-gray-50 p-5 shadow-sm\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <div>\n                    <p className=\"text-xs uppercase tracking-wide text-gray-500\">ModÃ¨le {selectedTemplateIndex + 1}/{SECTION_TEMPLATES.length}</p>\n                    <h4 className=\"text-lg font-semibold text-gray-900\">{selectedTemplate?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">{selectedTemplate?.description}</p>\n                  </div>\n                  <div className={`h-12 w-24 rounded-lg bg-gradient-to-r ${selectedTemplateAccent} shadow-inner`} />\n                </div>\n                {renderTemplateThumbnail(selectedTemplate?.id)}\n              </div>\n              <button\n                type=\"button\"\n                onClick={() => handleTemplateNavigation(1)}\n                className=\"flex h-12 w-12 items-center justify-center rounded-full border border-gray-200 text-gray-700 transition hover:border-blue-200 hover:text-blue-700\"\n                aria-label=\"ModÃ¨le suivant\"\n              >\n                â†’\n              </button>\n            </div>\n            <div className=\"flex flex-wrap justify-end gap-2\">\n              <button\n                type=\"button\"\n                onClick={handleCloseSectionModal}\n                className=\"rounded-full border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-gray-300\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleConfirmTemplateChoice}\n                className=\"rounded-full border border-blue-200 bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700\"\n              >\n                Valider ce modÃ¨le\n              </button>\n            </div>\n          </div>\n        ) : (\n          <form onSubmit={handleSubmitNewSection} className=\"mt-6 space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-1\">\n                <label htmlFor=\"section-title\" className=\"text-sm font-medium text-gray-800\">Titre</label>\n                <RichTextEditor\n                  id=\"section-title\"\n                  value={sectionDraft.title}\n                  onChange={(nextValue) => handleSectionDraftChange('title', nextValue)}\n                  placeholder={selectedTemplate?.placeholder?.title || 'Titre du bloc'}\n                  compact\n                  ariaLabel=\"Titre de la section\"\n                />\n              </div>\n              {selectedTemplateConfig.showSubtitle && (\n                <div className=\"space-y-1\">\n                  <label htmlFor=\"section-subtitle\" className=\"text-sm font-medium text-gray-800\">Sous-titre</label>\n                  <RichTextEditor\n                    id=\"section-subtitle\"\n                    value={sectionDraft.subtitle}\n                    onChange={(nextValue) => handleSectionDraftChange('subtitle', nextValue)}\n                    placeholder={selectedTemplate?.placeholder?.subtitle || 'ComplÃ©ment de contexte'}\n                    compact\n                    ariaLabel=\"Sous-titre de la section\"\n                  />\n                </div>\n              )}\n              {selectedTemplateConfig.showBadge && (\n                <div className=\"space-y-1\">\n                  <label htmlFor=\"section-badge\" className=\"text-sm font-medium text-gray-800\">Badge</label>\n                  <RichTextEditor\n                    id=\"section-badge\"\n                    value={sectionDraft.accent}\n                    onChange={(nextValue) => handleSectionDraftChange('accent', nextValue)}\n                    placeholder={selectedTemplate?.placeholder?.badge || 'Badge'}\n                    compact\n                    ariaLabel=\"Badge de la section\"\n                  />\n                </div>\n              )}\n              {selectedTemplateConfig.showAccent && (\n                <div className=\"space-y-1\">\n                  <label htmlFor=\"section-accent\" className=\"text-sm font-medium text-gray-800\">Sous-titre d'accroche (optionnel)</label>\n                  <RichTextEditor\n                    id=\"section-accent\"\n                    value={sectionDraft.accent}\n                    onChange={(nextValue) => handleSectionDraftChange('accent', nextValue)}\n                    placeholder=\"Sous-titre court\"\n                    compact\n                    ariaLabel=\"Accroche de la section\"\n                  />\n                </div>\n              )}\n            </div>\n            {selectedTemplateConfig.showDescription && (\n              <div className=\"space-y-1\">\n                <label htmlFor=\"section-description\" className=\"text-sm font-medium text-gray-800\">Description</label>\n                <RichTextEditor\n                  id=\"section-description\"\n                  value={sectionDraft.description}\n                  onChange={(nextValue) => handleSectionDraftChange('description', nextValue)}\n                  placeholder={selectedTemplate?.placeholder?.description || 'Expliquez le contenu principal de cette section'}\n                  ariaLabel=\"Description de la section\"\n                />\n              </div>\n            )}\n            {selectedTemplateConfig.showColumns && (\n              <>\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-1\">\n                    <label htmlFor=\"section-column-count\" className=\"text-sm font-medium text-gray-800\">Nombre de colonnes</label>\n                    <select\n                      id=\"section-column-count\"\n                      value={sectionDraft.columnCount}\n                      onChange={(event) => handleSectionDraftColumnCountChange(event.target.value)}\n                      className=\"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-400 focus:ring focus:ring-blue-100\"\n                    >\n                      {Array.from({ length: MAX_CUSTOM_SECTION_COLUMNS }, (_, index) => (\n                        <option key={`section-column-count-${index + 1}`} value={index + 1}>\n                          {index + 1} colonne{index + 1 > 1 ? 's' : ''}\n                        </option>\n                      ))}\n                    </select>\n                    <p className=\"text-xs text-gray-500\">Les colonnes se rÃ©organisent selon la largeur disponible.</p>\n                  </div>\n                </div>\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  {sectionDraft.columns.map((column, columnIndex) => (\n                    <div key={`section-draft-column-${columnIndex}`} className=\"space-y-1\">\n                      <label\n                        htmlFor={`section-column-${columnIndex}`}\n                        className=\"text-sm font-medium text-gray-800\"\n                      >\n                        Contenu colonne {columnIndex + 1}\n                      </label>\n                      <RichTextEditor\n                        id={`section-column-${columnIndex}`}\n                        value={column}\n                        onChange={(nextValue) => handleSectionDraftColumnChange(columnIndex, nextValue)}\n                        placeholder={`Contenu de la colonne ${columnIndex + 1}`}\n                        compact\n                        ariaLabel={`Contenu colonne ${columnIndex + 1}`}\n                      />\n                    </div>\n                  ))}\n                </div>\n              </>\n            )}\n            {selectedTemplateConfig.showDocument && (\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <div className=\"space-y-1\">\n                  <label htmlFor=\"section-document-url\" className=\"text-sm font-medium text-gray-800\">\n                    Lien SharePoint du document\n                  </label>\n                  <input\n                    id=\"section-document-url\"\n                    type=\"url\"\n                    value={sectionDraft.documentUrl}\n                    onChange={(event) => {\n                      const nextValue = event.target.value;\n                      handleSectionDraftChange('documentUrl', nextValue);\n                      handleSharePointWarning(nextValue);\n                    }}\n                    className=\"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 shadow-sm focus:border-blue-400 focus:ring focus:ring-blue-100\"\n                    placeholder={selectedTemplate?.placeholder?.documentUrl || 'https://votre-tenant.sharepoint.com/...'}\n                  />\n                  <p className=\"text-xs text-gray-500\">\n                    Utilisez un lien SharePoint accessible ou un lien dâ€™intÃ©gration Office pour les PPTX.\n                  </p>\n                </div>\n                <div className=\"space-y-1\">\n                  <label htmlFor=\"section-document-type\" className=\"text-sm font-medium text-gray-800\">\n                    Type de document\n                  </label>\n                  <select\n                    id=\"section-document-type\"\n                    value={sectionDraft.documentType}\n                    onChange={(event) => handleSectionDraftChange('documentType', event.target.value)}\n                    className=\"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-400 focus:ring focus:ring-blue-100\"\n                  >\n                    {DOCUMENT_VIEWER_TYPES.map(type => (\n                      <option key={type.id} value={type.id}>\n                        {type.label}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              </div>\n            )}\n            {selectedTemplateConfig.showItems && (\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium text-gray-800\">\n                  Liste (chaque Ã©lÃ©ment peut Ãªtre enrichi)\n                </label>\n                {Array.isArray(sectionDraft.items) && sectionDraft.items.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {sectionDraft.items.map((item, itemIndex) => (\n                      <div key={`section-draft-item-${itemIndex}`} className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <p className=\"text-xs font-semibold text-gray-500\">Ã‰lÃ©ment {itemIndex + 1}</p>\n                          <button\n                            type=\"button\"\n                            onClick={() => handleSectionDraftItemRemove(itemIndex)}\n                            className=\"inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-1 text-xs text-gray-600 hover:border-red-200 hover:text-red-600\"\n                          >\n                            <Trash2 className=\"h-3 w-3\" />\n                            Supprimer\n                          </button>\n                        </div>\n                        <RichTextEditor\n                          id={`section-items-${itemIndex}`}\n                          value={item}\n                          onChange={(nextValue) => handleSectionDraftItemChange(itemIndex, nextValue)}\n                          placeholder=\"Ã‰lÃ©ment de liste\"\n                          compact\n                          ariaLabel={`Ã‰lÃ©ment de liste ${itemIndex + 1}`}\n                        />\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-xs text-gray-500\">Aucun Ã©lÃ©ment ajoutÃ© pour le moment.</p>\n                )}\n                <button\n                  type=\"button\"\n                  onClick={handleSectionDraftItemAdd}\n                  className=\"inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:border-blue-200 hover:text-blue-700\"\n                >\n                  <Plus className=\"h-4 w-4\" />\n                  Ajouter un Ã©lÃ©ment\n                </button>\n              </div>\n            )}\n            <div className=\"flex flex-wrap justify-between gap-2\">\n              <button\n                type=\"button\"\n                onClick={handleBackToTemplates}\n                className=\"rounded-full border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-gray-300\"\n              >\n                Retour aux modÃ¨les\n              </button>\n              <div className=\"flex flex-wrap gap-2\">\n                <button\n                  type=\"button\"\n                  onClick={handleCloseSectionModal}\n                  className=\"rounded-full border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 transition hover:border-gray-300\"\n                >\n                  Annuler\n                </button>\n                <button\n                  type=\"submit\"\n                  className=\"rounded-full border border-blue-200 bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700\"\n                >\n                  Ajouter la section\n                </button>\n              </div>\n            </div>\n          </form>\n        )}\n      </div>\n    </div>\n  ) : null;\n  const sharePointWarningModal = isSharePointWarningOpen ? (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4\">\n      <div className=\"absolute inset-0\" onClick={handleCloseSharePointWarning} aria-hidden=\"true\" />\n      <div\n        className=\"relative z-10 w-full max-w-lg rounded-2xl bg-white p-6 shadow-2xl\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-label=\"Avertissement SharePoint\"\n      >\n        <div className=\"flex items-start justify-between gap-4\">\n          <div>\n            <p className=\"text-sm font-semibold uppercase tracking-wide text-amber-500\">Avertissement</p>\n            <h3 className=\"mt-2 text-xl font-bold text-gray-900\">Fichier SharePoint dÃ©tectÃ©</h3>\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleCloseSharePointWarning}\n            className=\"rounded-full border border-gray-200 px-3 py-1 text-sm text-gray-600 transition hover:border-gray-300 hover:text-gray-800\"\n          >\n            Fermer\n          </button>\n        </div>\n        <p className=\"mt-4 text-sm text-gray-600\">\n          VÃ©rifiez que le fichier SharePoint est bien partagÃ© aux collaborateurs du LFB avant de valider son ajout.\n        </p>\n        <div className=\"mt-6 flex justify-end\">\n          <button\n            type=\"button\"\n            onClick={handleCloseSharePointWarning}\n            className=\"rounded-full border border-amber-200 bg-amber-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-amber-600\"\n          >\n            J'ai vÃ©rifiÃ©\n          </button>\n        </div>\n      </div>\n    </div>\n  ) : null;\n\n  const modeSelectionPanel = resolvedDisplayModeLock ? null : (\n    <div\n      className=\"mb-6 rounded-2xl border border-gray-200 bg-white/80 shadow-sm backdrop-blur\"\n      data-tour-id=\"showcase-display-modes\"\n    >\n      <div\n        className=\"flex flex-col gap-3 p-4 sm:flex-row sm:items-center sm:justify-between\"\n        role=\"group\"\n        aria-label=\"SÃ©lection du mode d'utilisation\"\n      >\n        <div className=\"space-y-1\">\n          <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">SÃ©lection du mode d'utilisation</p>\n          <p className=\"text-sm text-gray-600\">\n            Choisissez entre l'affichage complet ou Light pour ajuster la vitrine.\n          </p>\n        </div>\n        <div className=\"flex flex-wrap items-center gap-2\">\n          <button\n            type=\"button\"\n            onClick={() => handleDisplayModeChange('light')}\n            className={`inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-medium transition ${\n              isLightMode\n                ? 'border-blue-200 bg-blue-50 text-blue-700 shadow-sm'\n                : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'\n            }`}\n            aria-pressed={isLightMode}\n          >\n            Mode Light\n            <span className=\"text-xs text-gray-500\">({selectedLightSectionsCount}/{sectionOrder.length})</span>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => handleDisplayModeChange('full')}\n            className={`inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-medium transition ${\n              !isLightMode\n                ? 'border-blue-200 bg-blue-50 text-blue-700 shadow-sm'\n                : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'\n            }`}\n            aria-pressed={!isLightMode}\n          >\n            Mode complet\n          </button>\n          <button\n            type=\"button\"\n            onClick={handleOpenLightConfig}\n            className=\"inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm transition hover:border-blue-200 hover:text-blue-700\"\n          >\n            Configurer\n          </button>\n        </div>\n      </div>\n\n      {isLightConfigOpen && (\n        <div className=\"border-t border-gray-200 p-4\">\n          <div className=\"flex flex-col gap-4\">\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n              <div>\n                <p className=\"text-sm font-semibold text-gray-800\">Sections visibles en mode Light</p>\n                <p className=\"text-xs text-gray-600\">DÃ©cochez les sections Ã  masquer dans l'affichage allÃ©gÃ©.</p>\n              </div>\n              <div className=\"flex flex-wrap gap-2\">\n                <button\n                  type=\"button\"\n                  onClick={handleSelectAllSections}\n                  className=\"rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-700 transition hover:border-blue-200 hover:text-blue-700\"\n                >\n                  Tout sÃ©lectionner\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelLightConfig}\n                  className=\"rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-700 transition hover:border-gray-300\"\n                >\n                  Annuler\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleValidateLightConfig}\n                  className=\"rounded-full border border-blue-200 bg-blue-600 px-3 py-1 text-xs font-medium text-white shadow-sm transition hover:bg-blue-700\"\n                >\n                  Valider\n                </button>\n              </div>\n            </div>\n\n            <div className=\"grid gap-2 sm:grid-cols-2 lg:grid-cols-3\">\n              {SHOWCASE_SECTION_OPTIONS.map(section => {\n                const checkboxId = `light-section-${section.id}`;\n                const isChecked = pendingLightSections[section.id] !== false;\n                return (\n                  <label\n                    key={section.id}\n                    htmlFor={checkboxId}\n                    className=\"flex cursor-pointer items-start gap-3 rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm transition hover:border-blue-200\"\n                  >\n                    <input\n                      id={checkboxId}\n                      name={checkboxId}\n                      type=\"checkbox\"\n                      checked={isChecked}\n                      onChange={() => handleTogglePendingSection(section.id)}\n                      className=\"mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                    />\n                    <span className=\"text-sm text-gray-800\">{section.label}</span>\n                  </label>\n                );\n              })}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n\n  const editPanel = isEditing && canEdit ? (\n    <form\n      id={formId}\n      onSubmit={handleSubmitEdit}\n      className=\"aurora-edit-panel\"\n      data-tour-id=\"showcase-edit-panel\"\n    >\n      <div className=\"aurora-edit-panel__header\">\n        <div>\n          <p className=\"aurora-eyebrow aurora-eyebrow--soft\">Mode Ã©dition actif</p>\n          <h3 className=\"aurora-edit-panel__title\">Ajustez les informations prÃ©sentÃ©es dans la vitrine</h3>\n        </div>\n        <p className=\"aurora-edit-panel__intro\">\n          Chaque modification sera appliquÃ©e aux rÃ©ponses du questionnaire correspondant.\n        </p>\n      </div>\n      <div className=\"mb-6 rounded-2xl border border-gray-200 bg-gray-50/60 p-4 shadow-inner\">\n        <div className=\"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between\">\n          <div>\n            <p className=\"aurora-eyebrow aurora-eyebrow--soft\">Organisation des sections</p>\n            <h4 className=\"text-lg font-semibold text-gray-900\">RÃ©organisez et ajoutez de nouveaux blocs</h4>\n            <p className=\"text-sm text-gray-600\">Glissez-dÃ©posez pour changer l'ordre ou utilisez le bouton + pour insÃ©rer une nouvelle section.</p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <button\n              type=\"button\"\n              onClick={() => handleOpenSectionModal(0)}\n              className=\"hidden h-10 w-10 items-center justify-center rounded-full border border-dashed border-gray-300 text-gray-600 transition hover:border-blue-300 hover:text-blue-600 sm:inline-flex\"\n              aria-label=\"Ajouter une section au dÃ©but\"\n            >\n              <Plus className=\"h-5 w-5\" />\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => handleOpenSectionModal(sectionOrder.length)}\n              className=\"inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700\"\n            >\n              <Plus className=\"h-4 w-4\" />\n              Nouvelle section\n            </button>\n          </div>\n        </div>\n        <ol className=\"mt-4 space-y-3\">\n          {sectionDescriptors.map((section, index) => {\n            const isTarget = sectionDragState.targetIndex === index;\n            return (\n              <li key={section.id} className=\"space-y-2\">\n                <div\n                  draggable\n                  onDragStart={(event) => handleSectionDragStart(index, event)}\n                  onDragEnter={() => handleSectionDragEnter(index)}\n                  onDragOver={handleSectionDragOver}\n                  onDragLeave={(event) => handleSectionDragLeave(index, event)}\n                  onDrop={(event) => handleSectionDrop(index, event)}\n                  className={`flex items-center justify-between gap-3 rounded-xl border bg-white p-3 shadow-sm transition ${\n                    isTarget ? 'border-blue-400 shadow-md ring-1 ring-blue-100' : 'border-gray-200'\n                  }`}\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"flex h-10 w-10 items-center justify-center rounded-full border border-dashed border-gray-300 text-gray-500\">\n                      â˜°\n                    </span>\n                    <div>\n                      <p className=\"text-sm font-semibold text-gray-900\">{renderTextWithLinks(section.title)}</p>\n                      <p className=\"text-xs text-gray-500\">{section.subtitle}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <button\n                      type=\"button\"\n                      onClick={() => handleOpenSectionModal(index + 1)}\n                      className=\"flex h-9 w-9 items-center justify-center rounded-full border border-dashed border-gray-300 text-gray-600 transition hover:border-blue-300 hover:text-blue-600\"\n                      aria-label=\"Ajouter une section Ã  cet endroit\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                    </button>\n                    {section.isCustom && (\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemoveCustomSection(section.id)}\n                        className=\"flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 text-gray-600 transition hover:border-red-200 hover:text-red-600\"\n                        aria-label=\"Supprimer cette section personnalisÃ©e\"\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </button>\n                    )}\n                  </div>\n                </div>\n              </li>\n            );\n          })}\n        </ol>\n      </div>\n      <div className=\"aurora-edit-panel__grid\">\n        {editFormBlocks.map((block) => {\n          if (block.type === 'custom') {\n            const section = block.section;\n            const templateConfig = resolveTemplateConfig(section.type);\n            const sectionTitle = section.title || 'Section personnalisÃ©e';\n            const annotationSectionId = section.type || 'custom';\n\n            return (\n              <div\n                key={`custom-section-${section.id}`}\n                className=\"aurora-field aurora-field--wide\"\n                data-annotation-target-section={annotationSectionId}\n              >\n                <div className=\"flex flex-col gap-1\">\n                  <p className=\"aurora-field__label\">{renderTextWithLinks(sectionTitle)}</p>\n                  <p className=\"text-xs text-gray-500\">Bloc personnalisÃ©</p>\n                </div>\n                <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-title`} className=\"text-sm font-medium text-gray-800\">\n                      Titre\n                    </label>\n                    <RichTextEditor\n                      id={`custom-section-${section.id}-title`}\n                      value={section.title || ''}\n                      onChange={(nextValue) => handleCustomSectionFieldChange(section.id, 'title', nextValue)}\n                      placeholder=\"Titre du bloc\"\n                      compact\n                      ariaLabel=\"Titre du bloc\"\n                    />\n                  </div>\n                </div>\n                {templateConfig.showSubtitle && (\n                  <div className=\"space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-subtitle`} className=\"text-sm font-medium text-gray-800\">\n                      Sous-titre\n                    </label>\n                    <RichTextEditor\n                      id={`custom-section-${section.id}-subtitle`}\n                      value={section.subtitle || ''}\n                      onChange={(nextValue) => handleCustomSectionFieldChange(section.id, 'subtitle', nextValue)}\n                      placeholder=\"ComplÃ©ment de contexte\"\n                      compact\n                      ariaLabel=\"Sous-titre du bloc\"\n                    />\n                  </div>\n                )}\n                {templateConfig.showBadge && (\n                  <div className=\"space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-badge`} className=\"text-sm font-medium text-gray-800\">\n                      Badge\n                    </label>\n                    <RichTextEditor\n                      id={`custom-section-${section.id}-badge`}\n                      value={section.accent || ''}\n                      onChange={(nextValue) => handleCustomSectionFieldChange(section.id, 'accent', nextValue)}\n                      placeholder=\"Badge\"\n                      compact\n                      ariaLabel=\"Badge du bloc\"\n                    />\n                  </div>\n                )}\n                {templateConfig.showAccent && (\n                  <div className=\"space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-accent`} className=\"text-sm font-medium text-gray-800\">\n                      Sous-titre d'accroche (optionnel)\n                    </label>\n                    <RichTextEditor\n                      id={`custom-section-${section.id}-accent`}\n                      value={section.accent || ''}\n                      onChange={(nextValue) => handleCustomSectionFieldChange(section.id, 'accent', nextValue)}\n                      placeholder=\"Sous-titre court\"\n                      compact\n                      ariaLabel=\"Accroche du bloc\"\n                    />\n                  </div>\n                )}\n                {templateConfig.showColumns && (\n                  <div className=\"space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-column-count`} className=\"text-sm font-medium text-gray-800\">\n                      Nombre de colonnes\n                    </label>\n                    <select\n                      id={`custom-section-${section.id}-column-count`}\n                      value={resolveCustomSectionColumnCount(section.columnCount, section.columns)}\n                      onChange={(event) => handleCustomSectionColumnCountChange(section.id, event.target.value)}\n                      className=\"aurora-form-control\"\n                    >\n                      {Array.from({ length: MAX_CUSTOM_SECTION_COLUMNS }, (_, index) => (\n                        <option key={`custom-section-${section.id}-column-${index + 1}`} value={index + 1}>\n                          {index + 1} colonne{index + 1 > 1 ? 's' : ''}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                )}\n                {templateConfig.showDocument && (\n                  <>\n                    <div className=\"space-y-1\">\n                      <label htmlFor={`custom-section-${section.id}-document-url`} className=\"text-sm font-medium text-gray-800\">\n                        Lien SharePoint du document\n                      </label>\n                      <input\n                        id={`custom-section-${section.id}-document-url`}\n                        type=\"url\"\n                        value={section.documentUrl || ''}\n                        onChange={(event) => {\n                          const nextValue = event.target.value;\n                          handleCustomSectionFieldChange(section.id, 'documentUrl', nextValue);\n                          handleSharePointWarning(nextValue);\n                        }}\n                        className=\"aurora-form-control\"\n                        placeholder=\"https://votre-tenant.sharepoint.com/...\"\n                      />\n                    </div>\n                    <div className=\"space-y-1\">\n                      <label htmlFor={`custom-section-${section.id}-document-type`} className=\"text-sm font-medium text-gray-800\">\n                        Type de document\n                      </label>\n                      <select\n                        id={`custom-section-${section.id}-document-type`}\n                        value={section.documentType || 'pdf'}\n                        onChange={(event) => handleCustomSectionFieldChange(section.id, 'documentType', event.target.value)}\n                        className=\"aurora-form-control\"\n                      >\n                        {DOCUMENT_VIEWER_TYPES.map(type => (\n                          <option key={type.id} value={type.id}>\n                            {type.label}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  </>\n                )}\n                {templateConfig.showDescription && (\n                  <div className=\"mt-4 space-y-1\">\n                    <label htmlFor={`custom-section-${section.id}-description`} className=\"text-sm font-medium text-gray-800\">\n                      Description\n                    </label>\n                    <RichTextEditor\n                      id={`custom-section-${section.id}-description`}\n                      value={section.description || ''}\n                      onChange={(nextValue) => handleCustomSectionFieldChange(section.id, 'description', nextValue)}\n                      placeholder=\"Expliquez le contenu principal de cette section\"\n                      ariaLabel=\"Description de la section\"\n                    />\n                  </div>\n                )}\n                {templateConfig.showColumns && (\n                  <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n                    {normalizeCustomSectionColumns(section.columns, resolveCustomSectionColumnCount(section.columnCount, section.columns))\n                      .map((column, columnIndex) => (\n                        <div key={`${section.id}-column-${columnIndex}`} className=\"space-y-1\">\n                          <label\n                            htmlFor={`custom-section-${section.id}-column-${columnIndex}`}\n                            className=\"text-sm font-medium text-gray-800\"\n                          >\n                            Contenu colonne {columnIndex + 1}\n                          </label>\n                          <RichTextEditor\n                            id={`custom-section-${section.id}-column-${columnIndex}`}\n                            value={column}\n                            onChange={(nextValue) => handleCustomSectionColumnChange(section.id, columnIndex, nextValue)}\n                            placeholder={`Contenu de la colonne ${columnIndex + 1}`}\n                            compact\n                            ariaLabel={`Contenu colonne ${columnIndex + 1}`}\n                          />\n                        </div>\n                      ))}\n                  </div>\n                )}\n                {templateConfig.showItems && (\n                  <div className=\"mt-4 space-y-3\">\n                    <label className=\"text-sm font-medium text-gray-800\">\n                      Liste (chaque Ã©lÃ©ment peut Ãªtre enrichi)\n                    </label>\n                    {Array.isArray(section.items) && section.items.length > 0 ? (\n                      <div className=\"space-y-3\">\n                        {section.items.map((item, itemIndex) => (\n                          <div key={`${section.id}-item-${itemIndex}`} className=\"space-y-2\">\n                            <div className=\"flex items-center justify-between\">\n                              <p className=\"text-xs font-semibold text-gray-500\">Ã‰lÃ©ment {itemIndex + 1}</p>\n                              <button\n                                type=\"button\"\n                                onClick={() => handleCustomSectionItemRemove(section.id, itemIndex)}\n                                className=\"inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-1 text-xs text-gray-600 hover:border-red-200 hover:text-red-600\"\n                              >\n                                <Trash2 className=\"h-3 w-3\" />\n                                Supprimer\n                              </button>\n                            </div>\n                            <RichTextEditor\n                              id={`custom-section-${section.id}-items-${itemIndex}`}\n                              value={item}\n                              onChange={(nextValue) => handleCustomSectionItemChange(section.id, itemIndex, nextValue)}\n                              placeholder=\"Ã‰lÃ©ment de liste\"\n                              compact\n                              ariaLabel={`Ã‰lÃ©ment de liste ${itemIndex + 1}`}\n                            />\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <p className=\"text-xs text-gray-500\">Aucun Ã©lÃ©ment ajoutÃ© pour le moment.</p>\n                    )}\n                    <button\n                      type=\"button\"\n                      onClick={() => handleCustomSectionItemAdd(section.id)}\n                      className=\"inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:border-blue-200 hover:text-blue-700\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                      Ajouter un Ã©lÃ©ment\n                    </button>\n                  </div>\n                )}\n              </div>\n            );\n          }\n\n          const field = block.field;\n          const fieldId = field.id;\n          const question = field.question;\n          const type = question?.type || field.fallbackType || 'text';\n          const label = question?.question || field.fallbackLabel || fieldId;\n          const fieldValue = draftValues[fieldId];\n          const options = Array.isArray(question?.options) ? question.options : [];\n          const isLong = type === 'long_text';\n          const isRichText = type === 'text' || type === 'long_text';\n          const isMulti = type === 'multi_choice';\n          const isChoice = type === 'choice';\n          const isDate = type === 'date';\n          const isMilestoneList = type === 'milestone_list';\n          const isMultiWithOptions = isMulti && options.length > 0;\n          const isMultiFreeform = isMulti && !isMultiWithOptions;\n          const isChoiceWithOptions = isChoice && options.length > 0;\n          const selectedValues = Array.isArray(fieldValue) ? fieldValue : [];\n          const textValue = typeof fieldValue === 'string' ? fieldValue : '';\n          const placeholder =\n            typeof question?.placeholder === 'string' && question.placeholder.trim() !== ''\n              ? question.placeholder.trim()\n              : isLong\n                ? 'Ajoutez ici un texte riche pour la vitrine'\n                : 'Saisissez un texte riche ou un lien';\n          const helperText = isMilestoneList\n            ? 'Ajoutez une date (optionnelle) et un descriptif pour chaque jalon.'\n            : isMultiWithOptions\n              ? 'SÃ©lectionnez une ou plusieurs options.'\n              : isMultiFreeform\n                ? 'Indiquez une valeur par ligne.'\n                : ['problemPainPoints', 'solutionBenefits', 'teamCoreMembers', 'visionStatement'].includes(fieldId)\n                  ? 'Utilisez une ligne par Ã©lÃ©ment pour une meilleure mise en forme.'\n                  : null;\n\n          const milestoneDraftEntries = isMilestoneList && Array.isArray(fieldValue) ? fieldValue : [];\n\n          const updateMilestoneDraft = (updater) => {\n            handleFieldChange(fieldId, previousValue => {\n              const previousEntries = Array.isArray(previousValue)\n                ? previousValue.map(entry => ({\n                    date: typeof entry?.date === 'string' ? entry.date : '',\n                    description: typeof entry?.description === 'string' ? entry.description : ''\n                  }))\n                : [];\n              const nextEntries = typeof updater === 'function' ? updater(previousEntries) : updater;\n              return Array.isArray(nextEntries) ? nextEntries : [];\n            });\n          };\n\n          const handleMilestoneDraftChange = (index, fieldName, value) => {\n            updateMilestoneDraft(entries => {\n              const nextEntries = entries.map((entry, entryIndex) => (\n                entryIndex === index ? { ...entry, [fieldName]: value } : entry\n              ));\n              return nextEntries;\n            });\n          };\n\n          const handleMilestoneDraftRemoval = (index) => {\n            updateMilestoneDraft(entries => entries.filter((_, entryIndex) => entryIndex !== index));\n          };\n\n          const handleMilestoneDraftAddition = () => {\n            updateMilestoneDraft(entries => [...entries, { date: '', description: '' }]);\n          };\n\n          const handleMilestoneDragStart = (index, event) => {\n            if (event?.dataTransfer) {\n              event.dataTransfer.effectAllowed = 'move';\n              try {\n                event.dataTransfer.setData('text/plain', String(index));\n              } catch (_error) {\n                // Certains navigateurs peuvent empÃªcher l'Ã©criture : on ignore l'erreur.\n              }\n            }\n\n            setMilestoneDragState({\n              fieldId,\n              sourceIndex: index,\n              targetIndex: index\n            });\n          };\n\n          const handleMilestoneDragEnter = (index) => {\n            setMilestoneDragState(previous => {\n              if (previous.fieldId !== fieldId || previous.targetIndex === index) {\n                return previous;\n              }\n\n              return {\n                ...previous,\n                targetIndex: index\n              };\n            });\n          };\n\n          const handleMilestoneDragLeave = (index, event) => {\n            if (event?.currentTarget?.contains(event?.relatedTarget)) {\n              return;\n            }\n\n            setMilestoneDragState(previous => {\n              if (previous.fieldId !== fieldId || previous.targetIndex !== index) {\n                return previous;\n              }\n\n              return {\n                ...previous,\n                targetIndex: previous.sourceIndex\n              };\n            });\n          };\n\n          const handleMilestoneDragOver = (event) => {\n            if (milestoneDragState.fieldId === fieldId) {\n              event.preventDefault();\n              if (event?.dataTransfer) {\n                event.dataTransfer.dropEffect = 'move';\n              }\n            }\n          };\n\n          const handleMilestoneDrop = (index, event) => {\n            if (milestoneDragState.fieldId !== fieldId) {\n              return;\n            }\n\n            event.preventDefault();\n            event.stopPropagation();\n\n            setMilestoneDragState(previous => {\n              if (previous.fieldId !== fieldId || typeof previous.sourceIndex !== 'number') {\n                return createEmptyMilestoneDragState();\n              }\n\n              const rawTargetIndex = typeof index === 'number' ? index : previous.targetIndex;\n\n              if (typeof rawTargetIndex !== 'number') {\n                return createEmptyMilestoneDragState();\n              }\n\n              updateMilestoneDraft(entries => {\n                if (!Array.isArray(entries) || entries.length <= 1) {\n                  return Array.isArray(entries) ? entries : [];\n                }\n\n                const boundedSourceIndex = Math.max(0, Math.min(entries.length - 1, previous.sourceIndex));\n                const maxTargetIndex = entries.length;\n                const normalizedTargetIndex = Math.max(0, Math.min(maxTargetIndex, rawTargetIndex));\n\n                let insertionIndex = normalizedTargetIndex;\n                if (boundedSourceIndex < normalizedTargetIndex) {\n                  insertionIndex = normalizedTargetIndex - 1;\n                }\n\n                const workingEntries = entries.slice();\n                const [movedEntry] = workingEntries.splice(boundedSourceIndex, 1);\n\n                if (!movedEntry) {\n                  return entries;\n                }\n\n                const safeInsertionIndex = Math.max(0, Math.min(workingEntries.length, insertionIndex));\n                workingEntries.splice(safeInsertionIndex, 0, movedEntry);\n\n                return workingEntries;\n              });\n\n              return createEmptyMilestoneDragState();\n            });\n          };\n\n          const handleMilestoneDragEnd = () => {\n            resetMilestoneDragState();\n          };\n\n          const isDropTargetAtEnd =\n            milestoneDragState.fieldId === fieldId && milestoneDragState.targetIndex === milestoneDraftEntries.length;\n\n          const annotationSectionId = FIELD_SECTION_MAP[fieldId];\n\n          return (\n            <div\n              key={fieldId}\n              className={`aurora-field${isLong || isMulti || isMilestoneList ? ' aurora-field--wide' : ''}`}\n              data-annotation-target-section={annotationSectionId || undefined}\n            >\n              <label htmlFor={`showcase-edit-${fieldId}`} className=\"aurora-field__label\">\n                {label}\n              </label>\n              {isMilestoneList ? (\n                <div className=\"aurora-milestone-list\">\n                  {milestoneDraftEntries.length === 0 && (\n                    <p className=\"aurora-field__helper\">Aucun jalon n'a encore Ã©tÃ© ajoutÃ©.</p>\n                  )}\n                  {milestoneDraftEntries.map((entry, index) => {\n                    const dateInputId = `showcase-edit-${fieldId}-date-${index}`;\n                    const descriptionInputId = `showcase-edit-${fieldId}-description-${index}`;\n                    const isCurrentDragging =\n                      milestoneDragState.fieldId === fieldId && milestoneDragState.sourceIndex === index;\n                    const isCurrentDropTarget =\n                      milestoneDragState.fieldId === fieldId &&\n                      milestoneDragState.targetIndex === index &&\n                      milestoneDragState.sourceIndex !== index;\n                    const milestoneRowClasses = [\n                      'aurora-milestone-row',\n                      isCurrentDragging ? 'aurora-milestone-row--dragging' : '',\n                      isCurrentDropTarget ? 'aurora-milestone-row--drop-target' : ''\n                    ]\n                      .filter(Boolean)\n                      .join(' ');\n\n                    return (\n                      <div\n                        key={dateInputId}\n                        className={milestoneRowClasses}\n                        draggable={milestoneDraftEntries.length > 1}\n                        onDragStart={event => handleMilestoneDragStart(index, event)}\n                        onDragEnter={() => handleMilestoneDragEnter(index)}\n                        onDragLeave={event => handleMilestoneDragLeave(index, event)}\n                        onDragOver={handleMilestoneDragOver}\n                        onDrop={event => handleMilestoneDrop(index, event)}\n                        onDragEnd={handleMilestoneDragEnd}\n                        aria-grabbed={isCurrentDragging ? 'true' : 'false'}\n                      >\n                        <div className=\"aurora-milestone-row__date\">\n                          <label htmlFor={dateInputId} className=\"aurora-milestone-label\">\n                            Date\n                          </label>\n                          <input\n                            id={dateInputId}\n                            type=\"date\"\n                            value={typeof entry?.date === 'string' ? entry.date : ''}\n                            onChange={event => handleMilestoneDraftChange(index, 'date', event.target.value)}\n                            className=\"aurora-form-control\"\n                          />\n                        </div>\n                        <div className=\"aurora-milestone-row__description\">\n                          <label htmlFor={descriptionInputId} className=\"aurora-milestone-label\">\n                            Description\n                          </label>\n                          <input\n                            id={descriptionInputId}\n                            type=\"text\"\n                            value={typeof entry?.description === 'string' ? entry.description : ''}\n                            onChange={event => handleMilestoneDraftChange(index, 'description', event.target.value)}\n                            className=\"aurora-form-control\"\n                          />\n                        </div>\n                        <button\n                          type=\"button\"\n                          onClick={() => handleMilestoneDraftRemoval(index)}\n                          className=\"aurora-milestone-remove\"\n                        >\n                          <Trash2 className=\"aurora-milestone-remove__icon\" />\n                          Supprimer\n                        </button>\n                      </div>\n                    );\n                  })}\n                  <button\n                    type=\"button\"\n                    onClick={handleMilestoneDraftAddition}\n                    className={`aurora-milestone-add${isDropTargetAtEnd ? ' aurora-milestone-add--drop-target' : ''}`}\n                    onDragEnter={() => handleMilestoneDragEnter(milestoneDraftEntries.length)}\n                    onDragLeave={event => handleMilestoneDragLeave(milestoneDraftEntries.length, event)}\n                    onDragOver={handleMilestoneDragOver}\n                    onDrop={event => handleMilestoneDrop(milestoneDraftEntries.length, event)}\n                  >\n                    <Plus className=\"aurora-milestone-add__icon\" />\n                    Ajouter un jalon\n                  </button>\n                </div>\n              ) : isDate ? (\n                <input\n                  id={`showcase-edit-${fieldId}`}\n                  type=\"date\"\n                  value={typeof fieldValue === 'string' ? fieldValue : ''}\n                  onChange={event => handleFieldChange(fieldId, event.target.value)}\n                  className=\"aurora-form-control\"\n                />\n              ) : isMultiWithOptions ? (\n                <div className=\"aurora-option-grid\">\n                  {options.map((option, optionIndex) => {\n                    const optionId = `showcase-edit-${fieldId}-option-${optionIndex}`;\n                    const isChecked = selectedValues.includes(option);\n\n                    return (\n                      <label\n                        key={optionId}\n                        htmlFor={optionId}\n                        className={`aurora-option${isChecked ? ' aurora-option--active' : ''}`}\n                      >\n                        <input\n                          id={optionId}\n                          type=\"checkbox\"\n                          value={option}\n                          checked={isChecked}\n                          onChange={event => {\n                            const { checked } = event.target;\n                            handleFieldChange(fieldId, previousValue => {\n                              const previousSelections = Array.isArray(previousValue) ? previousValue : [];\n                              const selectionSet = new Set(previousSelections);\n\n                              if (checked) {\n                                selectionSet.add(option);\n                              } else {\n                                selectionSet.delete(option);\n                              }\n\n                              if (options.length > 0) {\n                                return options.filter(choice => selectionSet.has(choice));\n                              }\n\n                              return Array.from(selectionSet);\n                            });\n                          }}\n                          className=\"aurora-option__checkbox\"\n                        />\n                        <span className=\"aurora-option__text\">{option}</span>\n                      </label>\n                    );\n                  })}\n                </div>\n              ) : isChoiceWithOptions ? (\n                <select\n                  id={`showcase-edit-${fieldId}`}\n                  value={textValue}\n                  onChange={event => handleFieldChange(fieldId, event.target.value)}\n                  className=\"aurora-form-control\"\n                >\n                  <option value=\"\">SÃ©lectionnez une option</option>\n                  {options.map(option => (\n                    <option key={option} value={option}>\n                      {option}\n                    </option>\n                  ))}\n                </select>\n              ) : isRichText ? (\n                <RichTextEditor\n                  id={`showcase-edit-${fieldId}`}\n                  value={textValue}\n                  onChange={(nextValue) => handleFieldChange(fieldId, nextValue)}\n                  placeholder={placeholder}\n                  compact={!isLong}\n                  ariaLabel={`${label} (Ã©dition riche)`}\n                />\n              ) : isMultiFreeform ? (\n                <textarea\n                  id={`showcase-edit-${fieldId}`}\n                  value={textValue}\n                  onChange={event => handleFieldChange(fieldId, event.target.value)}\n                  rows={isMultiFreeform ? 4 : 5}\n                  className=\"aurora-form-control aurora-form-control--textarea\"\n                />\n              ) : (\n                <input\n                  id={`showcase-edit-${fieldId}`}\n                  type=\"text\"\n                  value={textValue}\n                  onChange={event => handleFieldChange(fieldId, event.target.value)}\n                  className=\"aurora-form-control\"\n                />\n              )}\n              {helperText && <p className=\"aurora-field__helper\">{helperText}</p>}\n            </div>\n          );\n        })}\n      </div>\n      <div className=\"aurora-edit-panel__actions\">\n        <button type=\"button\" onClick={handleCancelEditing} className=\"aurora-button aurora-button--ghost\">\n          Annuler\n        </button>\n        <button\n          type=\"submit\"\n          className=\"aurora-button aurora-button--primary\"\n          data-tour-id=\"showcase-save-edits\"\n        >\n          <CheckCircle className=\"aurora-button__icon\" />\n          Enregistrer les modifications\n        </button>\n      </div>\n    </form>\n  ) : null;\n\n  const editBar =\n    canEdit && !isEditing ? (\n      <div className=\"aurora-edit-bar\">\n        <button\n          type=\"button\"\n          onClick={handleStartEditing}\n          className=\"aurora-button aurora-button--outline aurora-edit-bar__trigger\"\n          data-tour-id=\"showcase-edit-trigger\"\n        >\n          <Edit className=\"aurora-button__icon\" />\n          Modifier\n        </button>\n      </div>\n    ) : null;\n\n  const content = (\n    <>\n      {modeSelectionPanel}\n      {editBar}\n      {editPanel}\n      {sectionModal}\n      {sharePointWarningModal}\n      {previewContent}\n    </>\n  );\n\n  const shellClassName = isDeezerTheme\n    ? 'deezer-shell'\n    : isEditorialTheme\n      ? 'editorial-shell'\n      : isFibclotTheme\n        ? 'fibclot-shell'\n        : 'aurora-shell';\n  const shellStandaloneClassName = isDeezerTheme\n    ? 'deezer-shell--standalone'\n    : isEditorialTheme\n      ? 'editorial-shell--standalone'\n      : isFibclotTheme\n        ? 'fibclot-shell--standalone'\n        : 'aurora-shell--standalone';\n\n  if (renderInStandalone) {\n    return (\n      <div\n        data-showcase-scope\n        data-showcase-theme={showcaseThemeId}\n        data-showcase-layout={showcaseLayout}\n        className={`${shellClassName} ${shellStandaloneClassName}`}\n        style={showcaseThemeVariables}\n      >\n        {content}\n      </div>\n    );\n  }\n\n  return (\n    <section\n      data-showcase-scope\n      data-showcase-theme={showcaseThemeId}\n      data-showcase-layout={showcaseLayout}\n      className={shellClassName}\n      style={showcaseThemeVariables}\n      aria-label=\"Vitrine marketing du projet\"\n    >\n      {content}\n    </section>\n  );\n};\n",
  "src/components/QuestionEditor.jsx": "import React, { useEffect, useRef, useState } from '../react.js';\nimport {\n  Plus,\n  Trash2,\n  GripVertical,\n  Clipboard,\n  Compass,\n  Target,\n  Lightbulb,\n  CheckCircle\n} from './icons.js';\nimport { applyConditionGroups, normalizeConditionGroups } from '../utils/conditionGroups.js';\nimport { ensureOperatorForType, getOperatorOptionsForType } from '../utils/operatorOptions.js';\n\nexport const QuestionEditor = ({ question, onSave, onCancel, allQuestions }) => {\n  const ensureGuidance = (guidance) => {\n    if (!guidance || typeof guidance !== 'object') {\n      return { objective: '', details: '', tips: [] };\n    }\n\n    return {\n      objective: guidance.objective || '',\n      details: guidance.details || '',\n      tips: Array.isArray(guidance.tips) ? guidance.tips : []\n    };\n  };\n\n  const getDefaultPlaceholder = (type) => {\n    if (type === 'text') {\n      return 'Saisissez une rÃ©ponse en une ligne';\n    }\n    if (type === 'long_text') {\n      return 'Renseignez ici les informations dÃ©taillÃ©es...';\n    }\n    return '';\n  };\n\n  const buildDefaultRankingConfig = (previousConfig = null) => {\n    if (previousConfig && typeof previousConfig === 'object') {\n      return {\n        title: previousConfig.title || 'Base de donnÃ©es',\n        criteria: Array.isArray(previousConfig.criteria) && previousConfig.criteria.length > 0\n          ? previousConfig.criteria\n          : [\n              { id: 'critere-1', label: 'CritÃ¨re 1' },\n              { id: 'critere-2', label: 'CritÃ¨re 2' },\n              { id: 'critere-3', label: 'CritÃ¨re 3' }\n            ],\n        entries: Array.isArray(previousConfig.entries) ? previousConfig.entries : []\n      };\n    }\n\n    return {\n      title: 'Base de donnÃ©es',\n      criteria: [\n        { id: 'critere-1', label: 'CritÃ¨re 1' },\n        { id: 'critere-2', label: 'CritÃ¨re 2' },\n        { id: 'critere-3', label: 'CritÃ¨re 3' }\n      ],\n      entries: []\n    };\n  };\n\n  const sanitizeConditionGroups = (groups) => {\n    return Array.isArray(groups)\n      ? groups.map(group => ({\n          ...group,\n          conditions: Array.isArray(group.conditions)\n            ? group.conditions.map(condition => {\n                const question = allQuestions.find(q => q.id === condition?.question);\n                const questionType = question?.type || 'choice';\n                return {\n                  ...condition,\n                  operator: ensureOperatorForType(questionType, condition?.operator)\n                };\n              })\n            : []\n        }))\n      : [];\n  };\n\n  const buildQuestionState = (source) => {\n    const rankingConfig = buildDefaultRankingConfig(source.rankingConfig);\n\n    const base = {\n      ...source,\n      type: source.type || 'choice',\n      options: source.options || [],\n      guidance: ensureGuidance(source.guidance),\n      placeholder: typeof source.placeholder === 'string' ? source.placeholder : '',\n      numberUnit: typeof source.numberUnit === 'string' ? source.numberUnit : '',\n      rankingConfig\n    };\n\n    const groups = sanitizeConditionGroups(normalizeConditionGroups(base));\n    return applyConditionGroups(base, groups);\n  };\n\n  const [editedQuestion, setEditedQuestion] = useState(() => buildQuestionState(question));\n  useEffect(() => {\n    setEditedQuestion(buildQuestionState(question));\n  }, [question]);\n\n  const [draggedOptionIndex, setDraggedOptionIndex] = useState(null);\n  const [dragOverIndex, setDragOverIndex] = useState(null);\n  const questionType = editedQuestion.type || 'choice';\n  const typeUsesOptions = questionType === 'choice' || questionType === 'multi_choice';\n  const normalizedGuidance = ensureGuidance(editedQuestion.guidance);\n\n  const updateGuidanceField = (field, value) => {\n    setEditedQuestion(prev => ({\n      ...prev,\n      guidance: {\n        ...ensureGuidance(prev.guidance),\n        [field]: value\n      }\n    }));\n  };\n\n  const addGuidanceTip = () => {\n    setEditedQuestion(prev => {\n      const current = ensureGuidance(prev.guidance);\n      return {\n        ...prev,\n        guidance: {\n          ...current,\n          tips: [...current.tips, '']\n        }\n      };\n    });\n  };\n\n  const updateGuidanceTip = (index, value) => {\n    setEditedQuestion(prev => {\n      const current = ensureGuidance(prev.guidance);\n      const newTips = [...current.tips];\n      newTips[index] = value;\n      return {\n        ...prev,\n        guidance: {\n          ...current,\n          tips: newTips\n        }\n      };\n    });\n  };\n\n  const deleteGuidanceTip = (index) => {\n    setEditedQuestion(prev => {\n      const current = ensureGuidance(prev.guidance);\n      return {\n        ...prev,\n        guidance: {\n          ...current,\n          tips: current.tips.filter((_, i) => i !== index)\n        }\n      };\n    });\n  };\n\n  const handleTypeChange = (newType) => {\n    if (newType === 'choice' || newType === 'multi_choice') {\n      setEditedQuestion(prev => ({\n        ...prev,\n        type: newType,\n        options:\n          prev.options && prev.options.length > 0\n            ? prev.options\n            : ['Option 1', 'Option 2']\n      }));\n      return;\n    }\n\n    if (newType === 'ranking') {\n      setEditedQuestion(prev => ({\n        ...prev,\n        type: newType,\n        rankingConfig: buildDefaultRankingConfig(prev.rankingConfig),\n        options: []\n      }));\n      return;\n    }\n\n    setEditedQuestion(prev => ({\n      ...prev,\n      type: newType,\n      options: [],\n      placeholder: (newType === 'text' || newType === 'long_text')\n        ? (prev.placeholder && prev.placeholder.trim() !== ''\n          ? prev.placeholder\n          : getDefaultPlaceholder(newType))\n        : '',\n      numberUnit: newType === 'number'\n        ? (typeof prev.numberUnit === 'string' ? prev.numberUnit : '')\n        : ''\n    }));\n  };\n\n  const reorderOptions = (fromIndex, toIndex) => {\n    if (fromIndex === toIndex) return;\n\n    setEditedQuestion(prev => {\n      const newOptions = [...prev.options];\n      const [moved] = newOptions.splice(fromIndex, 1);\n      newOptions.splice(toIndex, 0, moved);\n\n      return {\n        ...prev,\n        options: newOptions\n      };\n    });\n  };\n\n  const handleDragStart = (event, index) => {\n    if (event?.dataTransfer) {\n      event.dataTransfer.effectAllowed = 'move';\n      event.dataTransfer.setData('text/plain', String(index));\n    }\n    setDraggedOptionIndex(index);\n    setDragOverIndex(index);\n  };\n\n  const handleDragEnter = (index) => {\n    if (draggedOptionIndex === null || draggedOptionIndex === index) return;\n    reorderOptions(draggedOptionIndex, index);\n    setDraggedOptionIndex(index);\n    setDragOverIndex(index);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedOptionIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const updateRankingConfig = (updater) => {\n    setEditedQuestion(prev => {\n      const baseConfig = buildDefaultRankingConfig(prev.rankingConfig);\n      const nextConfig = typeof updater === 'function' ? updater(baseConfig) : updater;\n\n      return {\n        ...prev,\n        rankingConfig: buildDefaultRankingConfig(nextConfig)\n      };\n    });\n  };\n\n  const addRankingCriterion = () => {\n    updateRankingConfig(config => {\n      const newId = `critere-${config.criteria.length + 1}`;\n      return {\n        ...config,\n        criteria: [...config.criteria, { id: newId, label: `CritÃ¨re ${config.criteria.length + 1}` }]\n      };\n    });\n  };\n\n  const updateRankingCriterion = (index, field, value) => {\n    updateRankingConfig(config => {\n      const updated = [...config.criteria];\n      const target = updated[index];\n      if (!target) return config;\n\n      const next = {\n        ...target,\n        [field]: value\n      };\n\n      if (field === 'label' && (!next.id || next.id.startsWith('critere-'))) {\n        next.id = value.toLowerCase().replace(/\\s+/g, '-').replace(/[^a-z0-9_-]/gi, '') || next.id;\n      }\n\n      updated[index] = next;\n\n      return {\n        ...config,\n        criteria: updated\n      };\n    });\n  };\n\n  const deleteRankingCriterion = (index) => {\n    updateRankingConfig(config => {\n      const updatedCriteria = config.criteria.filter((_, idx) => idx !== index);\n      const removed = config.criteria[index];\n      if (!removed) {\n        return { ...config, criteria: updatedCriteria };\n      }\n\n      const cleanedEntries = (config.entries || []).map(entry => {\n        const nextScores = { ...entry.scores };\n        delete nextScores[removed.id];\n        return { ...entry, scores: nextScores };\n      });\n\n      return {\n        ...config,\n        criteria: updatedCriteria,\n        entries: cleanedEntries\n      };\n    });\n  };\n\n  const addRankingEntry = () => {\n    updateRankingConfig(config => ({\n      ...config,\n      entries: [\n        ...config.entries,\n        {\n          id: `entree-${config.entries.length + 1}`,\n          name: `Option ${config.entries.length + 1}`,\n          contact: '',\n          website: '',\n          notes: '',\n          previousProject: '',\n          opinion: '',\n          scores: {}\n        }\n      ]\n    }));\n  };\n\n  const updateRankingEntry = (index, field, value) => {\n    updateRankingConfig(config => {\n      const entries = [...config.entries];\n      const target = entries[index];\n      if (!target) return config;\n\n      entries[index] = {\n        ...target,\n        [field]: value\n      };\n\n      return {\n        ...config,\n        entries\n      };\n    });\n  };\n\n  const updateRankingScore = (entryIndex, criterionId, value) => {\n    const parsedValue = Number(value);\n    const sanitized = Number.isFinite(parsedValue) ? Math.max(0, parsedValue) : 0;\n\n    updateRankingConfig(config => {\n      const entries = [...config.entries];\n      const target = entries[entryIndex];\n      if (!target) return config;\n\n      entries[entryIndex] = {\n        ...target,\n        scores: {\n          ...target.scores,\n          [criterionId]: sanitized\n        }\n      };\n\n      return {\n        ...config,\n        entries\n      };\n    });\n  };\n\n  const deleteRankingEntry = (index) => {\n    updateRankingConfig(config => ({\n      ...config,\n      entries: config.entries.filter((_, idx) => idx !== index)\n    }));\n  };\n\n  const updateConditionGroupsState = (updater) => {\n    setEditedQuestion(prev => {\n      const currentGroups = Array.isArray(prev.conditionGroups) ? prev.conditionGroups : [];\n      const nextGroups = sanitizeConditionGroups(updater(currentGroups));\n      return applyConditionGroups(prev, nextGroups);\n    });\n  };\n\n  const addConditionGroup = () => {\n    updateConditionGroupsState(groups => ([\n      ...groups,\n      {\n        logic: 'all',\n        conditions: [{ question: '', operator: 'equals', value: '' }]\n      }\n    ]));\n  };\n\n  const updateConditionGroupLogic = (groupIndex, logic) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      updated[groupIndex] = {\n        ...target,\n        logic: logic === 'any' ? 'any' : 'all'\n      };\n      return updated;\n    });\n  };\n\n  const addConditionToGroup = (groupIndex) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      updated[groupIndex] = {\n        ...target,\n        conditions: [...target.conditions, { question: '', operator: 'equals', value: '' }]\n      };\n      return updated;\n    });\n  };\n\n  const updateConditionInGroup = (groupIndex, conditionIndex, field, value) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = [...(target.conditions || [])];\n      const condition = { ...conditions[conditionIndex] };\n\n      if (field === 'question') {\n        condition.question = value;\n      } else if (field === 'operator') {\n        condition.operator = value;\n      } else {\n        condition[field] = value;\n      }\n\n      const linkedQuestion = allQuestions.find(q => q.id === condition.question);\n      const linkedType = linkedQuestion?.type || 'choice';\n      condition.operator = ensureOperatorForType(linkedType, condition.operator);\n\n      conditions[conditionIndex] = condition;\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    });\n  };\n\n  const deleteConditionFromGroup = (groupIndex, conditionIndex) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = (target.conditions || []).filter((_, idx) => idx !== conditionIndex);\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    });\n  };\n\n  const deleteConditionGroup = (groupIndex) => {\n    updateConditionGroupsState(groups => groups.filter((_, idx) => idx !== groupIndex));\n  };\n\n  const addOption = () => {\n    setEditedQuestion({\n      ...editedQuestion,\n      options: [...editedQuestion.options, 'Nouvelle option']\n    });\n  };\n\n  const updateOption = (index, value) => {\n    const newOptions = [...editedQuestion.options];\n    newOptions[index] = value;\n    setEditedQuestion({ ...editedQuestion, options: newOptions });\n  };\n\n  const deleteOption = (index) => {\n    if (editedQuestion.options.length > 1) {\n      setEditedQuestion({\n        ...editedQuestion,\n        options: editedQuestion.options.filter((_, i) => i !== index)\n      });\n    }\n  };\n\n  // Filtrer les questions pour ne pas inclure la question en cours d'Ã©dition\n  const availableQuestions = allQuestions.filter(q => q.id !== editedQuestion.id);\n  const conditionGroups = Array.isArray(editedQuestion.conditionGroups) ? editedQuestion.conditionGroups : [];\n  const dialogTitleId = 'question-editor-title';\n\n  const handleSave = () => {\n    const sanitizedQuestion = applyConditionGroups(editedQuestion, conditionGroups);\n    const unitLabel = typeof editedQuestion.numberUnit === 'string'\n      ? editedQuestion.numberUnit.trim()\n      : '';\n\n    onSave({\n      ...sanitizedQuestion,\n      numberUnit: unitLabel\n    });\n  };\n\n  const overlayRef = useRef(null);\n  const titleRef = useRef(null);\n\n  useEffect(() => {\n    if (overlayRef.current) {\n      overlayRef.current.scrollTo({ top: 0 });\n    }\n\n    if (titleRef.current) {\n      titleRef.current.focus();\n    }\n  }, []);\n\n  return (\n    <div\n      ref={overlayRef}\n      className=\"fixed inset-0 bg-black bg-opacity-50 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto\"\n      role=\"presentation\"\n    >\n      <div\n        className=\"bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-4 sm:my-8 overflow-y-auto hv-surface hv-modal-panel\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby={dialogTitleId}\n      >\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-8 py-6 rounded-t-2xl hv-surface\">\n          <div className=\"flex justify-between items-center\">\n            <h2\n              id={dialogTitleId}\n              ref={titleRef}\n              tabIndex={-1}\n              className=\"text-3xl font-bold text-gray-800 focus:outline-none\"\n            >\n              Ã‰dition de question\n            </h2>\n            <div className=\"flex space-x-3\">\n              <button\n                type=\"button\"\n                onClick={onCancel}\n                className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium text-gray-700 transition-all hv-button\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleSave}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all hv-button hv-button-primary\"\n              >\n                Enregistrer\n              </button>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"px-8 py-6 space-y-8\">\n          {/* Informations de base */}\n          <div>\n            <h3 className=\"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2\">\n              <Clipboard className=\"w-5 h-5 text-blue-500\" />\n              Informations de base\n            </h3>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Identifiant de la question</label>\n                <input\n                  type=\"text\"\n                  value={editedQuestion.id}\n                  disabled\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500\"\n                />\n                <p className=\"text-xs text-gray-500 mt-1\">L'identifiant ne peut pas Ãªtre modifiÃ©</p>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Texte de la question</label>\n                <textarea\n                  value={editedQuestion.question}\n                  onChange={(e) => setEditedQuestion({ ...editedQuestion, question: e.target.value })}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows=\"2\"\n                  placeholder=\"Ex: Quel est le pÃ©rimÃ¨tre de votre projet ?\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Type de question</label>\n                <select\n                  value={questionType}\n                  onChange={(e) => handleTypeChange(e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                >\n                  <option value=\"choice\">Liste de choix</option>\n                  <option value=\"date\">Date</option>\n                  <option value=\"multi_choice\">Choix multiples</option>\n                  <option value=\"ranking\">Classement de critÃ¨res</option>\n                  <option value=\"number\">Valeur numÃ©rique</option>\n                  <option value=\"url\">Lien URL</option>\n                  <option value=\"file\">Fichier</option>\n                  <option value=\"text\">Texte libre (1 ligne)</option>\n                  <option value=\"long_text\">Texte libre (plusieurs lignes)</option>\n                  <option value=\"milestone_list\">Liste de jalons (date + description)</option>\n                </select>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  Choisissez le format adaptÃ© : liste simple ou multiple, date, jalons structurÃ©s, valeurs numÃ©riques, URL, fichier ou zone de texte libre.\n                </p>\n              </div>\n\n              {(questionType === 'text' || questionType === 'long_text') && (\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Placeholder du champ</label>\n                  {questionType === 'long_text' ? (\n                    <textarea\n                      value={editedQuestion.placeholder || ''}\n                      onChange={(e) => setEditedQuestion(prev => ({ ...prev, placeholder: e.target.value }))}\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                      rows=\"2\"\n                      placeholder={getDefaultPlaceholder(questionType)}\n                    />\n                  ) : (\n                    <input\n                      type=\"text\"\n                      value={editedQuestion.placeholder || ''}\n                      onChange={(e) => setEditedQuestion(prev => ({ ...prev, placeholder: e.target.value }))}\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                      placeholder={getDefaultPlaceholder(questionType)}\n                    />\n                  )}\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    Personnalisez le texte indicatif affichÃ© dans le champ de rÃ©ponse. Laissez vide pour utiliser la formulation par dÃ©faut.\n                  </p>\n                </div>\n              )}\n\n              {questionType === 'number' && (\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">UnitÃ© de mesure affichÃ©e</label>\n                  <input\n                    type=\"text\"\n                    value={editedQuestion.numberUnit || ''}\n                    onChange={(e) => setEditedQuestion(prev => ({ ...prev, numberUnit: e.target.value }))}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"Ex : Kâ‚¬, %, jours\"\n                  />\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    Ce libellÃ© s&apos;affiche Ã  droite du champ numÃ©rique pour prÃ©ciser l&apos;unitÃ© attendue (optionnel).\n                  </p>\n                </div>\n              )}\n\n              <div className=\"flex items-center\">\n                <input\n                  type=\"checkbox\"\n                  checked={editedQuestion.required}\n                  onChange={(e) => setEditedQuestion({ ...editedQuestion, required: e.target.checked })}\n                  className=\"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500\"\n                />\n                <label className=\"ml-2 text-sm font-medium text-gray-700\">\n                  Question obligatoire\n                </label>\n              </div>\n            </div>\n          </div>\n\n          {/* Options de rÃ©ponse */}\n          <div>\n            {typeUsesOptions ? (\n              <>\n                <div className=\"flex justify-between items-center mb-4\">\n                  <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n                    <CheckCircle className=\"w-5 h-5 text-emerald-600\" />\n                    {questionType === 'multi_choice'\n                      ? 'Options de sÃ©lection multiple'\n                      : 'Options de rÃ©ponse'}\n                  </h3>\n                  <button\n                    onClick={addOption}\n                    className=\"flex items-center px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all text-sm font-medium\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Ajouter une option\n                  </button>\n                </div>\n\n                <p className=\"text-xs text-gray-500 mb-3\">\n                  Glissez-dÃ©posez les options pour modifier leur ordre d'affichage.\n                  {questionType === 'multi_choice' && ' Les rÃ©pondants pourront sÃ©lectionner plusieurs valeurs.'}\n                </p>\n\n                <div className=\"space-y-2\">\n                  {editedQuestion.options.map((option, idx) => (\n                    <div\n                      key={idx}\n                      className={`flex items-center space-x-2 rounded-lg border border-transparent bg-white p-2 transition-colors ${\n                        dragOverIndex === idx ? 'border-blue-200 bg-blue-50 shadow' : 'shadow-sm'\n                      }`}\n                      onDragOver={(e) => {\n                        e.preventDefault();\n                        setDragOverIndex(idx);\n                      }}\n                      onDragEnter={() => handleDragEnter(idx)}\n                      onDragLeave={(e) => {\n                        e.preventDefault();\n                        if (draggedOptionIndex !== idx) {\n                          setDragOverIndex(null);\n                        }\n                      }}\n                      onDrop={(e) => {\n                        e.preventDefault();\n                        handleDragEnd();\n                      }}\n                      onDragEnd={handleDragEnd}\n                    >\n                      <button\n                        type=\"button\"\n                        draggable\n                        onDragStart={(event) => handleDragStart(event, idx)}\n                        className=\"cursor-grab px-2 py-3 text-gray-400 hover:text-blue-600 focus:outline-none\"\n                        aria-label={`RÃ©ordonner l'option ${idx + 1}`}\n                      >\n                        <GripVertical className=\"w-4 h-4\" />\n                      </button>\n                      <span className=\"text-gray-500 font-medium w-6 text-center\">{idx + 1}.</span>\n                      <input\n                        type=\"text\"\n                        value={option}\n                        onChange={(e) => updateOption(idx, e.target.value)}\n                        className=\"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\n                        placeholder=\"Texte de l'option...\"\n                      />\n                      <button\n                        onClick={() => deleteOption(idx)}\n                        disabled={editedQuestion.options.length === 1}\n                        className=\"p-2 text-red-600 hover:bg-red-50 rounded transition-all disabled:opacity-30 disabled:cursor-not-allowed\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              </>\n            ) : (\n              <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700\">\n                Ce type de question ne nÃ©cessite pas de liste d'options prÃ©dÃ©finies.\n              </div>\n            )}\n          </div>\n\n          {questionType === 'ranking' && (\n            <div className=\"border-t border-gray-200 pt-6 mt-6 space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n                  <Compass className=\"w-5 h-5 text-indigo-500\" />\n                  Base de donnÃ©es de recommandation\n                </h3>\n                <button\n                  type=\"button\"\n                  onClick={addRankingEntry}\n                  className=\"flex items-center px-3 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-all text-sm font-medium\"\n                >\n                  <Plus className=\"w-4 h-4 mr-1\" />\n                  Ajouter une entrÃ©e\n                </button>\n              </div>\n\n              <div className=\"grid gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Titre affichÃ© dans le rapport</label>\n                  <input\n                    type=\"text\"\n                    value={editedQuestion.rankingConfig?.title || ''}\n                    onChange={(e) => updateRankingConfig(config => ({ ...config, title: e.target.value }))}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent\"\n                    placeholder=\"Ex : Agences partenaires\"\n                  />\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    Ce libellÃ© sera utilisÃ© comme titre de la section dans le rapport Compliance.\n                  </p>\n                </div>\n\n                <div className=\"bg-white border border-gray-200 rounded-lg p-4 shadow-sm\">\n                  <div className=\"flex items-center justify-between mb-3\">\n                    <h4 className=\"text-lg font-semibold text-gray-800 flex items-center gap-2\">\n                      <Target className=\"w-5 h-5 text-indigo-500\" />\n                      CritÃ¨res Ã  classer\n                    </h4>\n                    <button\n                      type=\"button\"\n                      onClick={addRankingCriterion}\n                      className=\"flex items-center px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 rounded-lg hover:bg-indigo-50 text-sm\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" /> Ajouter\n                    </button>\n                  </div>\n                  {editedQuestion.rankingConfig?.criteria?.length > 0 ? (\n                    <div className=\"space-y-2\">\n                      {editedQuestion.rankingConfig.criteria.map((criterion, idx) => (\n                        <div key={criterion.id || idx} className=\"flex flex-col sm:flex-row sm:items-center gap-3 p-3 rounded-lg border border-gray-200\">\n                          <div className=\"flex-1\">\n                            <label className=\"block text-xs font-semibold text-gray-600\">LibellÃ©</label>\n                            <input\n                              type=\"text\"\n                              value={criterion.label || ''}\n                              onChange={(e) => updateRankingCriterion(idx, 'label', e.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                              placeholder={`CritÃ¨re ${idx + 1}`}\n                            />\n                          </div>\n                          <div className=\"sm:w-48\">\n                            <label className=\"block text-xs font-semibold text-gray-600\">Identifiant</label>\n                            <input\n                              type=\"text\"\n                              value={criterion.id || ''}\n                              onChange={(e) => updateRankingCriterion(idx, 'id', e.target.value)}\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                              placeholder=\"id-technique\"\n                            />\n                          </div>\n                          <button\n                            type=\"button\"\n                            onClick={() => deleteRankingCriterion(idx)}\n                            className=\"self-start p-2 text-red-600 hover:bg-red-50 rounded\"\n                            aria-label={`Supprimer le critÃ¨re ${criterion.label || idx + 1}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-gray-600\">Ajoutez au moins un critÃ¨re pour activer le classement.</p>\n                  )}\n                </div>\n\n                <div className=\"bg-white border border-gray-200 rounded-lg p-4 shadow-sm\">\n                  <div className=\"flex items-center justify-between gap-2 mb-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Lightbulb className=\"w-5 h-5 text-amber-500\" />\n                      <h4 className=\"text-lg font-semibold text-gray-800\">EntrÃ©es de la base</h4>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={addRankingEntry}\n                      className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition\"\n                    >\n                      <Plus className=\"w-4 h-4\" />\n                      Ajouter\n                    </button>\n                  </div>\n\n                  {editedQuestion.rankingConfig?.entries?.length === 0 ? (\n                    <p className=\"text-sm text-gray-600\">Aucune entrÃ©e pour le moment. Ajoutez vos agences ou options pour alimenter les recommandations.</p>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      {editedQuestion.rankingConfig.entries.map((entry, entryIdx) => (\n                        <div key={entry.id || entryIdx} className=\"border border-gray-200 rounded-lg p-4 space-y-3\">\n                          <div className=\"flex flex-col sm:flex-row sm:items-start gap-3\">\n                            <div className=\"flex-1\">\n                              <label className=\"block text-xs font-semibold text-gray-600\">Nom de l'entrÃ©e</label>\n                              <input\n                                type=\"text\"\n                                value={entry.name || ''}\n                                onChange={(e) => updateRankingEntry(entryIdx, 'name', e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                placeholder=\"Nom de l'agence\"\n                              />\n                            </div>\n                            <div className=\"sm:w-48\">\n                              <label className=\"block text-xs font-semibold text-gray-600\">Contact</label>\n                              <input\n                                type=\"text\"\n                                value={entry.contact || ''}\n                                onChange={(e) => updateRankingEntry(entryIdx, 'contact', e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                placeholder=\"email ou nom\"\n                              />\n                            </div>\n                            <div className=\"sm:w-48\">\n                              <label className=\"block text-xs font-semibold text-gray-600\">Site web</label>\n                              <input\n                                type=\"text\"\n                                value={entry.website || ''}\n                                onChange={(e) => updateRankingEntry(entryIdx, 'website', e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                placeholder=\"https://...\"\n                              />\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteRankingEntry(entryIdx)}\n                              className=\"self-start p-2 text-red-600 hover:bg-red-50 rounded\"\n                              aria-label={`Supprimer l'entrÃ©e ${entry.name || entryIdx + 1}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </button>\n                          </div>\n\n                          <div className=\"grid gap-3 sm:grid-cols-2\">\n                            <div>\n                              <label className=\"block text-xs font-semibold text-gray-600\">RÃ©alisations rÃ©centes</label>\n                              <input\n                                type=\"text\"\n                                value={entry.previousProject || ''}\n                                onChange={(e) => updateRankingEntry(entryIdx, 'previousProject', e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                placeholder=\"Projet livrÃ©, clients...\"\n                              />\n                            </div>\n                            <div>\n                              <label className=\"block text-xs font-semibold text-gray-600\">Avis global</label>\n                              <input\n                                type=\"text\"\n                                value={entry.opinion || ''}\n                                onChange={(e) => updateRankingEntry(entryIdx, 'opinion', e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                placeholder=\"Notation ou synthÃ¨se\"\n                              />\n                            </div>\n                          </div>\n\n                          <div>\n                            <label className=\"block text-xs font-semibold text-gray-600 mb-2\">Scores par critÃ¨re</label>\n                            <div className=\"grid gap-2 sm:grid-cols-2 md:grid-cols-3\">\n                              {(editedQuestion.rankingConfig?.criteria || []).map(criterion => {\n                                const inputId = `${entry.id || entryIdx}-${criterion.id}`;\n                                return (\n                                  <div key={inputId} className=\"flex flex-col gap-1\">\n                                    <label htmlFor={inputId} className=\"text-xs text-gray-600\">{criterion.label}</label>\n                                    <input\n                                      id={inputId}\n                                      type=\"number\"\n                                      min=\"0\"\n                                      max=\"5\"\n                                      value={entry?.scores?.[criterion.id] ?? ''}\n                                      onChange={(e) => updateRankingScore(entryIdx, criterion.id, e.target.value)}\n                                      className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                                      placeholder=\"0 Ã  5\"\n                                    />\n                                  </div>\n                                );\n                              })}\n                            </div>\n                          </div>\n\n                          <div>\n                            <label className=\"block text-xs font-semibold text-gray-600\">Notes internes</label>\n                            <textarea\n                              value={entry.notes || ''}\n                              onChange={(e) => updateRankingEntry(entryIdx, 'notes', e.target.value)}\n                              rows=\"2\"\n                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500\"\n                              placeholder=\"Points forts, spÃ©cificitÃ©s, limites...\"\n                            />\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Guidage contextuel */}\n          <div>\n            <h3 className=\"text-xl font-bold text-gray-800 mb-3 flex items-center gap-2\">\n              <Compass className=\"w-5 h-5 text-blue-500\" />\n              Guidage contextuel\n            </h3>\n            <p className=\"text-sm text-gray-600 mb-4\">\n              Renseignez les informations d'aide affichÃ©es au chef de projet pour expliquer la question.\n            </p>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Objectif pÃ©dagogique</label>\n                <input\n                  type=\"text\"\n                  value={normalizedGuidance.objective}\n                  onChange={(e) => updateGuidanceField('objective', e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"Pourquoi cette question est posÃ©e...\"\n                />\n              </div>\n\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Message principal</label>\n                <textarea\n                  value={normalizedGuidance.details}\n                  onChange={(e) => updateGuidanceField('details', e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows=\"3\"\n                  placeholder=\"PrÃ©cisez le contexte, les impacts compliance ou les attentes...\"\n                />\n              </div>\n            </div>\n\n            <div className=\"mt-4\">\n              <div className=\"flex justify-between items-center mb-2\">\n                <span className=\"text-sm font-medium text-gray-700\">Conseils pratiques</span>\n                <button\n                  type=\"button\"\n                  onClick={addGuidanceTip}\n                  className=\"flex items-center px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all\"\n                >\n                  <Plus className=\"w-3 h-3 mr-1\" />\n                  Ajouter un conseil\n                </button>\n              </div>\n\n              {normalizedGuidance.tips.length === 0 ? (\n                <p className=\"text-xs text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4\">\n                  Ajoutez un ou plusieurs conseils opÃ©rationnels pour aider le chef de projet Ã  rÃ©pondre correctement.\n                </p>\n              ) : (\n                <div className=\"space-y-2\">\n                  {normalizedGuidance.tips.map((tip, idx) => (\n                    <div key={idx} className=\"flex items-center space-x-2\">\n                      <span className=\"text-gray-400 text-sm w-6\">#{idx + 1}</span>\n                      <input\n                        type=\"text\"\n                        value={tip}\n                        onChange={(e) => updateGuidanceTip(idx, e.target.value)}\n                        className=\"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500\"\n                        placeholder=\"Conseil pratique...\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => deleteGuidanceTip(idx)}\n                        className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Conditions d'affichage */}\n          <div>\n            <div className=\"flex justify-between items-center mb-4\">\n              <div>\n                <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n                  <Target className=\"w-5 h-5 text-blue-500\" />\n                  Conditions d'affichage\n                </h3>\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  DÃ©finissez quand cette question doit apparaÃ®tre dans le questionnaire\n                </p>\n              </div>\n              <button\n                type=\"button\"\n                onClick={addConditionGroup}\n                className=\"flex items-center px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all text-sm font-medium\"\n              >\n                <Plus className=\"w-4 h-4 mr-1\" />\n                Ajouter un groupe\n              </button>\n            </div>\n\n            {conditionGroups.length === 0 ? (\n              <div className=\"bg-gray-50 rounded-lg p-6 text-center\">\n                <p className=\"text-gray-600 mb-2\">Cette question s'affiche toujours</p>\n                <p className=\"text-sm text-gray-500\">\n                  CrÃ©ez un groupe pour afficher cette question uniquement dans certains cas\n                </p>\n                <div className=\"mt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={addConditionGroup}\n                    className=\"inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    CrÃ©er un groupe de conditions\n                  </button>\n                </div>\n              </div>\n            ) : (\n              <div>\n                <div className=\"bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200\">\n                  {conditionGroups.length === 1 ? (\n                    (() => {\n                      const logic = conditionGroups[0].logic === 'any' ? 'any' : 'all';\n                      const logicLabel = logic === 'any' ? 'OU' : 'ET';\n                      const logicDescription = logic === 'any'\n                        ? 'au moins une des conditions ci-dessous est remplie'\n                        : 'toutes les conditions ci-dessous sont remplies';\n\n                      return (\n                        <p className=\"text-sm text-blue-900\">\n                          <strong className=\"inline-flex items-center gap-2\">\n                            <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                            Logique :\n                          </strong>{' '}\n                          Cette question s'affichera si{' '}\n                          <strong className=\"text-blue-700\">{logicDescription}</strong>{' '}\n                          (logique {logicLabel}).\n                        </p>\n                      );\n                    })()\n                  ) : (\n                    <div className=\"space-y-2 text-sm text-blue-900\">\n                      <p>\n                        <strong className=\"inline-flex items-center gap-2\">\n                          <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                          Logique :\n                        </strong>{' '}\n                        Cette question s'affiche lorsque{' '}\n                        <strong className=\"text-blue-700\">chaque groupe de conditions</strong> ci-dessous est validÃ© (logique globale <strong>ET</strong>).\n                      </p>\n                      <p>\n                        Ã€ l'intÃ©rieur d'un groupe, choisissez si{' '}\n                        <strong className=\"text-blue-700\">toutes</strong> les conditions doivent Ãªtre vraies (ET) ou si{' '}\n                        <strong className=\"text-blue-700\">au moins une</strong> suffit (OU).\n                      </p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"space-y-6\">\n                  {conditionGroups.map((group, groupIdx) => {\n                    const logic = group.logic === 'any' ? 'any' : 'all';\n                    const conditions = Array.isArray(group.conditions) ? group.conditions : [];\n                    const connectorLabel = logic === 'any' ? 'OU' : 'ET';\n\n                    return (\n                      <div key={groupIdx}>\n                        {groupIdx > 0 && (\n                          <div className=\"flex justify-center -mb-3\" aria-hidden=\"true\">\n                            <span className=\"bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow\">\n                              ET\n                            </span>\n                          </div>\n                        )}\n                        <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200\">\n                          <div className=\"flex flex-wrap items-center gap-3 mb-4\">\n                            <span className=\"text-sm font-semibold text-gray-700\">\n                              Groupe {groupIdx + 1}\n                            </span>\n                            <div className=\"flex items-center gap-2 text-xs text-green-800 uppercase tracking-wide\">\n                              <span className=\"font-semibold\">Logique interne</span>\n                              <select\n                                value={logic}\n                                onChange={(e) => updateConditionGroupLogic(groupIdx, e.target.value)}\n                                className=\"px-3 py-1.5 border border-green-200 rounded-lg bg-white text-xs focus:ring-2 focus:ring-green-400\"\n                              >\n                                <option value=\"all\">Toutes les conditions (ET)</option>\n                                <option value=\"any\">Au moins une condition (OU)</option>\n                              </select>\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteConditionGroup(groupIdx)}\n                              className=\"ml-auto p-2 text-red-600 hover:bg-red-50 rounded transition-all\"\n                              aria-label={`Supprimer le groupe ${groupIdx + 1}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </button>\n                          </div>\n\n                          {conditions.length === 0 ? (\n                            <div className=\"bg-white border border-dashed border-green-200 rounded-lg p-4 text-sm text-green-700\">\n                              <p>Ajoutez une condition pour dÃ©finir ce groupe.</p>\n                              <button\n                                type=\"button\"\n                                onClick={() => addConditionToGroup(groupIdx)}\n                                className=\"mt-3 inline-flex items-center px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all text-sm font-medium\"\n                              >\n                                <Plus className=\"w-4 h-4 mr-1\" />\n                                Ajouter une condition\n                              </button>\n                            </div>\n                          ) : (\n                            <div className=\"space-y-3\">\n                              {conditions.map((condition, idx) => (\n                                <div key={idx} className=\"bg-white rounded-lg border border-green-200 p-4 shadow-sm\">\n                                  <div className=\"flex items-center space-x-3 mb-3\">\n                                    {idx > 0 && (\n                                      <span className=\"bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold\">\n                                        {connectorLabel}\n                                      </span>\n                                    )}\n                                    <span className=\"text-sm font-semibold text-gray-700\">\n                                      Condition {idx + 1}\n                                    </span>\n                                    <button\n                                      type=\"button\"\n                                      onClick={() => deleteConditionFromGroup(groupIdx, idx)}\n                                      className=\"ml-auto p-1 text-red-600 hover:bg-red-50 rounded transition-all\"\n                                    >\n                                      <Trash2 className=\"w-4 h-4\" />\n                                    </button>\n                                  </div>\n\n                                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n                                    <div>\n                                      <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n                                        Si la question\n                                      </label>\n                                      <select\n                                        value={condition.question}\n                                        onChange={(e) => updateConditionInGroup(groupIdx, idx, 'question', e.target.value)}\n                                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500\"\n                                      >\n                                        <option value=\"\">SÃ©lectionner...</option>\n                                        {availableQuestions.map(q => (\n                                          <option key={q.id} value={q.id}>\n                                            {q.id} - {q.question ?? ''}\n                                          </option>\n                                        ))}\n                                      </select>\n                                    </div>\n\n                                    <div>\n                                      <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n                                        OpÃ©rateur\n                                      </label>\n                                      {(() => {\n                                        const selectedQuestion = allQuestions.find(q => q.id === condition.question);\n                                        const selectedType = selectedQuestion?.type || 'choice';\n                                        const operatorOptions = getOperatorOptionsForType(selectedType);\n                                        const operatorValue = ensureOperatorForType(selectedType, condition.operator);\n                                        return (\n                                          <select\n                                            value={operatorValue}\n                                            onChange={(e) => updateConditionInGroup(groupIdx, idx, 'operator', e.target.value)}\n                                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500\"\n                                          >\n                                            {operatorOptions.map(option => (\n                                              <option key={option.value} value={option.value}>{option.label}</option>\n                                            ))}\n                                          </select>\n                                        );\n                                      })()}\n                                    </div>\n\n                                    <div>\n                                      <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n                                        Valeur\n                                      </label>\n                                      {(() => {\n                                        if (!condition.question) {\n                                          return (\n                                            <input\n                                              type=\"text\"\n                                              value={condition.value}\n                                              onChange={(e) => updateConditionInGroup(groupIdx, idx, 'value', e.target.value)}\n                                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500\"\n                                              placeholder=\"Valeur...\"\n                                            />\n                                          );\n                                        }\n\n                                        const selectedQuestion = allQuestions.find(q => q.id === condition.question);\n                                        const selectedType = selectedQuestion?.type || 'choice';\n                                        const usesOptions = ['choice', 'multi_choice'].includes(selectedType);\n\n                                        if (usesOptions) {\n                                          return (\n                                            <select\n                                              value={condition.value}\n                                              onChange={(e) => updateConditionInGroup(groupIdx, idx, 'value', e.target.value)}\n                                              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500\"\n                                            >\n                                              <option value=\"\">SÃ©lectionner...</option>\n                                              {(selectedQuestion?.options || []).map((opt, i) => (\n                                                <option key={i} value={opt}>{opt}</option>\n                                              ))}\n                                            </select>\n                                          );\n                                        }\n\n                                        const inputType = selectedType === 'number' ? 'number' : 'text';\n                                        const placeholder =\n                                          selectedType === 'date'\n                                            ? 'AAAA-MM-JJ'\n                                            : selectedType === 'url'\n                                              ? 'https://...'\n                                              : 'Valeur...';\n\n                                        return (\n                                          <input\n                                            type={inputType}\n                                            value={condition.value}\n                                            onChange={(e) => updateConditionInGroup(groupIdx, idx, 'value', e.target.value)}\n                                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500\"\n                                            placeholder={placeholder}\n                                          />\n                                        );\n                                      })()}\n                                    </div>\n                                  </div>\n                                </div>\n                              ))}\n\n                              <div className=\"flex justify-end\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => addConditionToGroup(groupIdx)}\n                                  className=\"inline-flex items-center px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all text-sm font-medium\"\n                                >\n                                  <Plus className=\"w-4 h-4 mr-1\" />\n                                  Ajouter une condition\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n",
  "src/components/QuestionnaireScreen.jsx": "import React, { useEffect, useMemo, useRef, useState } from '../react.js';\nimport {\n  Info,\n  Calendar,\n  CheckCircle,\n  ChevronLeft,\n  ChevronRight,\n  AlertTriangle,\n  Save,\n  Plus,\n  Trash2\n} from './icons.js';\nimport { formatAnswer } from '../utils/questions.js';\nimport { normalizeConditionGroups } from '../utils/conditionGroups.js';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { RichTextEditor } from './RichTextEditor.jsx';\nimport { normalizeRankingConfig } from '../utils/ranking.js';\n\nconst OPERATOR_LABELS = {\n  equals: 'est Ã©gal Ã ',\n  not_equals: 'est diffÃ©rent de',\n  contains: 'contient',\n  lt: 'est infÃ©rieur Ã ',\n  lte: 'est infÃ©rieur ou Ã©gal Ã ',\n  gt: 'est supÃ©rieur Ã ',\n  gte: 'est supÃ©rieur ou Ã©gal Ã '\n};\n\nconst normalizeMilestoneDrafts = (value) => {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n\n  return value.map(item => ({\n    date: typeof item?.date === 'string' ? item.date : '',\n    description: typeof item?.description === 'string' ? item.description : ''\n  }));\n};\n\nconst isMilestoneDraftEmpty = (entry) => {\n  const date = typeof entry?.date === 'string' ? entry.date.trim() : '';\n  const description = typeof entry?.description === 'string' ? entry.description.trim() : '';\n\n  return date.length === 0 && description.length === 0;\n};\n\nconst areMilestoneDraftsEqual = (first, second) => {\n  if (!Array.isArray(first) || !Array.isArray(second)) {\n    return false;\n  }\n\n  if (first.length !== second.length) {\n    return false;\n  }\n\n  return first.every((entry, index) => {\n    const counterpart = second[index];\n\n    if (!counterpart) {\n      return false;\n    }\n\n    const entryDate = typeof entry?.date === 'string' ? entry.date : '';\n    const entryDescription = typeof entry?.description === 'string' ? entry.description : '';\n    const counterpartDate = typeof counterpart?.date === 'string' ? counterpart.date : '';\n    const counterpartDescription =\n      typeof counterpart?.description === 'string' ? counterpart.description : '';\n\n    return entryDate === counterpartDate && entryDescription === counterpartDescription;\n  });\n};\n\nconst sanitizeMilestonesForAnswer = (drafts) => {\n  if (!Array.isArray(drafts)) {\n    return [];\n  }\n\n  return drafts\n    .map(item => ({\n      date: typeof item?.date === 'string' ? item.date.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(entry => entry.date.length > 0 || entry.description.length > 0);\n};\n\nexport const QuestionnaireScreen = ({\n  questions,\n  currentIndex,\n  answers,\n  onAnswer,\n  onNext,\n  onBack,\n  allQuestions,\n  onNavigateToQuestion,\n  onSaveDraft,\n  saveFeedback,\n  onDismissSaveFeedback,\n  validationError,\n  tourContext = null,\n  onReturnToSynthesis,\n  isReturnToSynthesisRequested = false,\n  onFinish\n}) => {\n  const currentQuestion = questions[currentIndex];\n  const questionBank = allQuestions || questions;\n\n  if (!currentQuestion) {\n    return null;\n  }\n\n  const progress = ((currentIndex + 1) / questions.length) * 100;\n  const remainingQuestions = Math.max(questions.length - (currentIndex + 1), 0);\n  const remainingLabel = remainingQuestions === 0\n    ? 'Aucune question restante'\n    : `${remainingQuestions} question${remainingQuestions > 1 ? 's' : ''} restante${remainingQuestions > 1 ? 's' : ''}`;\n  const questionType = currentQuestion.type || 'choice';\n  const currentAnswer = answers[currentQuestion.id];\n  const multiSelection = Array.isArray(currentAnswer) ? currentAnswer : [];\n  const rankingConfig = useMemo(\n    () => normalizeRankingConfig(currentQuestion.rankingConfig || {}),\n    [currentQuestion.rankingConfig]\n  );\n  const rankingAnswer = useMemo(() => {\n    const rawPrioritized = Array.isArray(currentAnswer?.prioritized) ? currentAnswer.prioritized : [];\n    const rawIgnored = Array.isArray(currentAnswer?.ignored) ? currentAnswer.ignored : [];\n\n    const validCriteria = rankingConfig.criteria.map(item => item.id);\n    const prioritized = rawPrioritized.filter(id => validCriteria.includes(id));\n    const ignored = rawIgnored.filter(id => validCriteria.includes(id));\n\n    return {\n      prioritized,\n      ignored\n    };\n  }, [currentAnswer, rankingConfig]);\n  const [showGuidance, setShowGuidance] = useState(false);\n  const [milestoneDrafts, setMilestoneDrafts] = useState(() => normalizeMilestoneDrafts(currentAnswer));\n  const milestoneQuestionIdRef = useRef(questionType === 'milestone_list' ? currentQuestion.id : null);\n  const questionTextId = `question-${currentQuestion.id}`;\n  const instructionsId = `instructions-${currentQuestion.id}`;\n  const guidancePanelId = `guidance-${currentQuestion.id}`;\n  const progressLabelId = `progress-label-${currentQuestion.id}`;\n  const hasValidationError = validationError?.questionId === currentQuestion.id;\n  const hasSaveFeedback = Boolean(saveFeedback?.message);\n  const isSaveSuccess = saveFeedback?.status === 'success';\n  const relatedQuestionEntries = useMemo(() => {\n    if (!isReturnToSynthesisRequested) {\n      return [];\n    }\n\n    const currentQuestionId = currentQuestion.id;\n\n    return questions\n      .map((question, index) => ({ question, index }))\n      .filter(({ question }) => question?.id && question.id !== currentQuestionId)\n      .filter(({ question }) => normalizeConditionGroups(question).some(group =>\n        group.conditions.some(condition => condition.question === currentQuestionId)\n      ))\n      .filter(({ index }) => index > currentIndex);\n  }, [currentIndex, currentQuestion.id, isReturnToSynthesisRequested, questions]);\n  const hasLinkedQuestions = relatedQuestionEntries.length > 0;\n  const nextLinkedQuestion = relatedQuestionEntries[0]?.question || null;\n  const shouldShowNextButton = !isReturnToSynthesisRequested || hasLinkedQuestions;\n  const shouldShowFinishButton = !isReturnToSynthesisRequested || hasLinkedQuestions;\n  const handleLinkedQuestionNext = () => {\n    if (nextLinkedQuestion && typeof onNavigateToQuestion === 'function') {\n      onNavigateToQuestion(nextLinkedQuestion.id);\n      return;\n    }\n\n    onNext();\n  };\n\n  useEffect(() => {\n    setShowGuidance(false);\n  }, [currentQuestion.id]);\n\n  useEffect(() => {\n    if (questionType !== 'milestone_list') {\n      milestoneQuestionIdRef.current = null;\n      setMilestoneDrafts([]);\n      return;\n    }\n\n    const normalizedAnswer = normalizeMilestoneDrafts(currentAnswer);\n    const previousQuestionId = milestoneQuestionIdRef.current;\n    milestoneQuestionIdRef.current = currentQuestion.id;\n\n    setMilestoneDrafts(previousDrafts => {\n      if (previousQuestionId !== currentQuestion.id) {\n        return normalizedAnswer;\n      }\n\n      if (\n        normalizedAnswer.length === 0 &&\n        Array.isArray(previousDrafts) &&\n        previousDrafts.length > 0 &&\n        previousDrafts.every(isMilestoneDraftEmpty)\n      ) {\n        return previousDrafts;\n      }\n\n      const normalizedPreviousDrafts = normalizeMilestoneDrafts(previousDrafts);\n\n      if (\n        normalizedPreviousDrafts.length > normalizedAnswer.length &&\n        areMilestoneDraftsEqual(\n          sanitizeMilestonesForAnswer(normalizedPreviousDrafts),\n          normalizedAnswer\n        )\n      ) {\n        return previousDrafts;\n      }\n\n      if (areMilestoneDraftsEqual(normalizedPreviousDrafts, normalizedAnswer)) {\n        return previousDrafts;\n      }\n\n      return normalizedAnswer;\n    });\n  }, [currentAnswer, currentQuestion.id, questionType]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (tourContext.activeStep === 'question-guidance') {\n      setShowGuidance(true);\n    } else if (tourContext.activeStep !== 'question-guidance' && showGuidance) {\n      setShowGuidance(false);\n    }\n  }, [tourContext, showGuidance]);\n\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const { activeStep } = tourContext;\n    let selector = null;\n\n    if (activeStep === 'question-guidance') {\n      selector = '[data-tour-id=\"question-guidance-toggle\"]';\n    } else if (activeStep === 'question-save') {\n      selector = '[data-tour-id=\"question-save-draft\"]';\n    }\n\n    if (selector) {\n      const element = document.querySelector(selector);\n      if (element && typeof element.scrollIntoView === 'function') {\n        element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n      }\n    }\n  }, [tourContext]);\n\n  const guidance = currentQuestion.guidance || {};\n  const guidanceTips = useMemo(() => (\n    Array.isArray(guidance.tips)\n      ? guidance.tips.filter(tip => typeof tip === 'string' && tip.trim() !== '')\n      : []\n  ), [guidance]);\n\n  const conditionSummaries = useMemo(() => {\n    const conditionGroups = normalizeConditionGroups(currentQuestion);\n    return conditionGroups.map((group, groupIdx) => {\n      const logic = group.logic === 'any' ? 'any' : 'all';\n      const conditions = (group.conditions || []).map(condition => {\n        const referenceQuestion = questionBank.find(q => q.id === condition.question);\n        const label = referenceQuestion?.question || `Question ${condition.question}`;\n        const formattedAnswer = formatAnswer(referenceQuestion, answers[condition.question]);\n\n        return {\n          label,\n          operator: OPERATOR_LABELS[condition.operator] || condition.operator,\n          value: condition.value,\n          answer: formattedAnswer\n        };\n      });\n\n      return {\n        logic,\n        conditions,\n        groupIdx\n      };\n    });\n  }, [answers, currentQuestion, questionBank]);\n\n  const hasConditions = useMemo(\n    () => conditionSummaries.some(summary => summary.conditions.length > 0),\n    [conditionSummaries]\n  );\n\n  const hasGuidanceContent = useMemo(() => {\n    const hasObjective = typeof guidance.objective === 'string' && guidance.objective.trim() !== '';\n    const hasDetails = typeof guidance.details === 'string' && guidance.details.trim() !== '';\n\n    return hasObjective || hasDetails || guidanceTips.length > 0 || hasConditions;\n  }, [guidance, guidanceTips, hasConditions]);\n\n  const rankingPrioritized = useMemo(() => {\n    if (questionType !== 'ranking') {\n      return [];\n    }\n\n    const defaultOrder = rankingConfig.criteria.map(item => item.id);\n    return rankingAnswer.prioritized.length > 0 ? rankingAnswer.prioritized : defaultOrder;\n  }, [questionType, rankingAnswer.prioritized, rankingConfig.criteria]);\n\n  const rankingIgnoredSet = useMemo(() => new Set(questionType === 'ranking' ? rankingAnswer.ignored : []), [questionType, rankingAnswer.ignored]);\n\n  const handleRankingMove = (criterionId, direction) => {\n    const currentOrder = rankingPrioritized;\n    const currentIndex = currentOrder.indexOf(criterionId);\n    if (currentIndex === -1) return;\n\n    const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;\n    if (targetIndex < 0 || targetIndex >= currentOrder.length) return;\n\n    const nextOrder = [...currentOrder];\n    const [moved] = nextOrder.splice(currentIndex, 1);\n    nextOrder.splice(targetIndex, 0, moved);\n\n    onAnswer(currentQuestion.id, {\n      prioritized: nextOrder,\n      ignored: rankingAnswer.ignored\n    });\n  };\n\n  const handleRankingToggleIgnored = (criterionId) => {\n    const isIgnored = rankingIgnoredSet.has(criterionId);\n    const nextIgnored = isIgnored\n      ? rankingAnswer.ignored.filter(id => id !== criterionId)\n      : [...rankingAnswer.ignored, criterionId];\n\n    const nextPrioritized = isIgnored\n      ? (rankingAnswer.prioritized.length > 0\n        ? rankingAnswer.prioritized\n        : rankingConfig.criteria.map(item => item.id))\n      : rankingPrioritized.filter(id => id !== criterionId);\n\n    if (!isIgnored && nextPrioritized.length === 0) {\n      nextPrioritized.push(...rankingConfig.criteria.map(item => item.id).filter(id => id !== criterionId));\n    }\n\n    onAnswer(currentQuestion.id, {\n      prioritized: nextPrioritized,\n      ignored: nextIgnored\n    });\n  };\n\n  const handleRankingReset = () => {\n    const defaultOrder = rankingConfig.criteria.map(item => item.id);\n    onAnswer(currentQuestion.id, { prioritized: defaultOrder, ignored: [] });\n  };\n\n  const renderQuestionInput = () => {\n    switch (questionType) {\n      case 'date':\n        return (\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-date`}>\n              <span className=\"flex items-center\">\n                <Calendar className=\"w-4 h-4 mr-2\" />\n                SÃ©lectionnez une date\n              </span>\n            </label>\n            <input\n              type=\"date\"\n              value={currentAnswer ?? ''}\n              onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n              id={`${currentQuestion.id}-date`}\n              aria-describedby={currentIndex === 0 ? instructionsId : undefined}\n              className=\"w-full px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Utilisez le sÃ©lecteur ou le format AAAA-MM-JJ pour garantir une analyse correcte.\n            </p>\n          </div>\n        );\n      case 'choice':\n        return (\n          <fieldset className=\"space-y-3 mb-8\" aria-describedby={currentIndex === 0 ? instructionsId : undefined}>\n            <legend className=\"sr-only\">{currentQuestion.question}</legend>\n            {currentQuestion.options.map((option, idx) => {\n              const isSelected = answers[currentQuestion.id] === option;\n              const optionId = `${currentQuestion.id}-option-${idx}`;\n\n              return (\n                <label\n                  key={idx}\n                  htmlFor={optionId}\n                  className={`w-full p-3 sm:p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between rounded-xl border-2 transition-all duration-200 cursor-pointer hv-focus-ring ${\n                    isSelected\n                      ? 'border-blue-600 bg-blue-50 text-blue-900'\n                      : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'\n                  }`}\n                >\n                  <div className=\"flex items-center\">\n                    <input\n                      type=\"radio\"\n                      id={optionId}\n                      name={currentQuestion.id}\n                      value={option}\n                      checked={isSelected}\n                      onChange={() => onAnswer(currentQuestion.id, option)}\n                      className=\"w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500 hv-focus-ring\"\n                    />\n                    <span className=\"ml-3 font-medium text-sm sm:text-base\">{option}</span>\n                  </div>\n                  {isSelected && <CheckCircle className=\"w-5 h-5 text-blue-600 self-end sm:self-auto\" />}\n                </label>\n              );\n            })}\n          </fieldset>\n        );\n      case 'multi_choice':\n        return (\n          <div className=\"space-y-3 mb-8\">\n            {currentQuestion.options.map((option, idx) => {\n              const isSelected = multiSelection.includes(option);\n              const optionId = `${currentQuestion.id}-multi-option-${idx}`;\n\n              const toggleOption = () => {\n                if (isSelected) {\n                  onAnswer(\n                    currentQuestion.id,\n                    multiSelection.filter(item => item !== option)\n                  );\n                } else {\n                  onAnswer(currentQuestion.id, [...multiSelection, option]);\n                }\n              };\n\n              return (\n                <label\n                  key={idx}\n                  htmlFor={optionId}\n                  className={`w-full p-3 sm:p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between rounded-xl border-2 transition-all duration-200 cursor-pointer hv-focus-ring ${\n                    isSelected\n                      ? 'border-blue-600 bg-blue-50 text-blue-900'\n                      : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'\n                  }`}\n                >\n                  <div className=\"flex items-center\">\n                    <input\n                      type=\"checkbox\"\n                      checked={isSelected}\n                      onChange={toggleOption}\n                      id={optionId}\n                      className=\"w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 hv-focus-ring\"\n                    />\n                    <span className=\"ml-3 font-medium text-sm sm:text-base\">{option}</span>\n                  </div>\n                  {isSelected && <CheckCircle className=\"w-5 h-5 text-blue-600 self-end sm:self-auto\" />}\n                </label>\n              );\n            })}\n          </div>\n        );\n      case 'ranking': {\n        const orderedCriteria = rankingPrioritized\n          .map(id => rankingConfig.criteria.find(criterion => criterion.id === id))\n          .filter(Boolean);\n        const ignoredCriteria = rankingConfig.criteria.filter(criterion => rankingIgnoredSet.has(criterion.id));\n\n        return (\n          <div className=\"space-y-4 mb-8\" data-tour-id=\"question-main-content\">\n            <p className=\"text-sm text-gray-600\">\n              Classez les critÃ¨res du plus important au moins important et indiquez ceux qui sont sans importance pour vous.\n            </p>\n\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\n              <span className=\"text-xs text-gray-500\">Utilisez les flÃ¨ches pour ajuster l'ordre.</span>\n              <button\n                type=\"button\"\n                onClick={handleRankingReset}\n                className=\"inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50\"\n              >\n                RÃ©initialiser l'ordre\n              </button>\n            </div>\n\n            <div className=\"space-y-3\">\n              {orderedCriteria.map((criterion, index) => {\n                const isFirst = index === 0;\n                const isLast = index === orderedCriteria.length - 1;\n\n                return (\n                  <div\n                    key={criterion.id}\n                    className=\"flex items-center gap-3 p-3 rounded-xl border-2 border-gray-200 bg-white hover:border-blue-200 hv-focus-ring\"\n                  >\n                    <div className=\"flex flex-col gap-1\">\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRankingMove(criterion.id, 'up')}\n                        disabled={isFirst}\n                        className=\"px-2 py-1 text-xs font-semibold border rounded-lg disabled:opacity-40 hover:bg-blue-50\"\n                        aria-label={`Monter ${criterion.label}`}\n                      >\n                        â†‘\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRankingMove(criterion.id, 'down')}\n                        disabled={isLast}\n                        className=\"px-2 py-1 text-xs font-semibold border rounded-lg disabled:opacity-40 hover:bg-blue-50\"\n                        aria-label={`Descendre ${criterion.label}`}\n                      >\n                        â†“\n                      </button>\n                    </div>\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-semibold text-gray-800\">{index + 1}. {criterion.label}</p>\n                      {criterion.description && <p className=\"text-xs text-gray-500\">{criterion.description}</p>}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleRankingToggleIgnored(criterion.id)}\n                      className={`text-xs font-medium px-3 py-2 rounded-lg border transition ${\n                        rankingIgnoredSet.has(criterion.id)\n                          ? 'border-gray-300 text-gray-600 bg-gray-50'\n                          : 'border-red-200 text-red-600 hover:bg-red-50'\n                      }`}\n                    >\n                      {rankingIgnoredSet.has(criterion.id) ? 'Reprendre en compte' : 'Sans importance'}\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n\n            {ignoredCriteria.length > 0 && (\n              <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-3\">\n                <p className=\"text-sm font-semibold text-gray-700 mb-2\">CritÃ¨res sans importance</p>\n                <div className=\"flex flex-wrap gap-2\">\n                  {ignoredCriteria.map(criterion => (\n                    <button\n                      key={criterion.id}\n                      type=\"button\"\n                      onClick={() => handleRankingToggleIgnored(criterion.id)}\n                      className=\"inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium border border-gray-300 rounded-full bg-white hover:border-blue-300\"\n                    >\n                      {criterion.label}\n                      <span className=\"text-blue-600\">(rÃ©intÃ©grer)</span>\n                    </button>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n      }\n      case 'milestone_list': {\n        const handleMilestoneUpdate = (updater) => {\n          setMilestoneDrafts(prev => {\n            const nextDrafts = typeof updater === 'function' ? updater(prev) : updater;\n            const sanitized = sanitizeMilestonesForAnswer(nextDrafts);\n            onAnswer(currentQuestion.id, sanitized);\n            return nextDrafts;\n          });\n        };\n\n        const handleMilestoneFieldChange = (index, field, value) => {\n          handleMilestoneUpdate(prev => {\n            const nextDrafts = prev.map((entry, entryIndex) => {\n              if (entryIndex !== index) {\n                return entry;\n              }\n\n              return {\n                ...entry,\n                [field]: value\n              };\n            });\n\n            return nextDrafts;\n          });\n        };\n\n        const handleMilestoneRemoval = (index) => {\n          handleMilestoneUpdate(prev => prev.filter((_, entryIndex) => entryIndex !== index));\n        };\n\n        const handleAddMilestone = () => {\n          handleMilestoneUpdate(prev => [...prev, { date: '', description: '' }]);\n        };\n\n        const emptyState = milestoneDrafts.length === 0;\n\n        return (\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <fieldset className=\"space-y-4\" aria-describedby={currentIndex === 0 ? instructionsId : undefined}>\n              <legend className=\"sr-only\">{currentQuestion.question}</legend>\n              {emptyState && (\n                <p className=\"text-sm text-gray-600\">\n                  Ajoutez vos prochains jalons pour prÃ©parer la feuille de route.\n                </p>\n              )}\n              {milestoneDrafts.map((entry, index) => {\n                const dateInputId = `${currentQuestion.id}-milestone-${index}-date`;\n                const descriptionInputId = `${currentQuestion.id}-milestone-${index}-description`;\n\n                return (\n                  <div\n                    key={`milestone-${index}`}\n                    className=\"p-4 border-2 border-gray-200 rounded-xl space-y-4 sm:space-y-0 sm:flex sm:items-end sm:gap-4\"\n                  >\n                    <div className=\"sm:w-40\">\n                      <label htmlFor={dateInputId} className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        Date du jalon\n                      </label>\n                      <input\n                        id={dateInputId}\n                        type=\"date\"\n                        value={entry.date || ''}\n                        onChange={(event) => handleMilestoneFieldChange(index, 'date', event.target.value)}\n                        className=\"w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n                      />\n                    </div>\n                    <div className=\"flex-1\">\n                      <label htmlFor={descriptionInputId} className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        Description\n                      </label>\n                      <input\n                        id={descriptionInputId}\n                        type=\"text\"\n                        value={entry.description || ''}\n                        onChange={(event) => handleMilestoneFieldChange(index, 'description', event.target.value)}\n                        className=\"w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n                      />\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleMilestoneRemoval(index)}\n                      className=\"inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-red-600 border border-red-200 rounded-lg hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2\"\n                    >\n                      <Trash2 className=\"w-4 h-4 mr-2\" />\n                      Supprimer\n                    </button>\n                  </div>\n                );\n              })}\n            </fieldset>\n            <button\n              type=\"button\"\n              onClick={handleAddMilestone}\n              className=\"mt-4 inline-flex items-center px-4 py-2 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Ajouter un jalon\n            </button>\n          </div>\n        );\n      }\n      case 'text':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-text`}>\n              Renseignez votre rÃ©ponse\n            </label>\n            <RichTextEditor\n              id={`${currentQuestion.id}-text`}\n              value={currentAnswer ?? ''}\n              onChange={(nextValue) => onAnswer(currentQuestion.id, nextValue)}\n              placeholder={\n                typeof currentQuestion.placeholder === 'string' && currentQuestion.placeholder.trim() !== ''\n                  ? currentQuestion.placeholder.trim()\n                  : 'Saisissez une rÃ©ponse enrichie (liens cliquables)'\n              }\n              compact\n              ariaLabel=\"Zone de rÃ©ponse en texte libre\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">Utilisez ce champ pour des rÃ©ponses courtes avec mise en forme.</p>\n          </div>\n        );\n      case 'long_text':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-long-text`}>\n              DÃ©crivez les Ã©lÃ©ments pertinents\n            </label>\n            <RichTextEditor\n              id={`${currentQuestion.id}-long-text`}\n              value={currentAnswer ?? ''}\n              onChange={(nextValue) => onAnswer(currentQuestion.id, nextValue)}\n              placeholder={\n                typeof currentQuestion.placeholder === 'string' && currentQuestion.placeholder.trim() !== ''\n                  ? currentQuestion.placeholder.trim()\n                  : 'Renseignez ici les informations dÃ©taillÃ©es (liens HTML autorisÃ©s)'\n              }\n              ariaLabel=\"Zone de texte long en Ã©dition riche\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">Ce champ accepte plusieurs lignes et vos liens restent cliquables.</p>\n          </div>\n        );\n      case 'number': {\n        const unitLabel =\n          typeof currentQuestion.numberUnit === 'string' && currentQuestion.numberUnit.trim() !== ''\n            ? currentQuestion.numberUnit.trim()\n            : '';\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-number`}>\n              Renseignez une valeur numÃ©rique\n            </label>\n            <div className={`flex items-center gap-3 ${unitLabel ? 'flex-wrap sm:flex-nowrap' : ''}`}>\n              <input\n                type=\"number\"\n                inputMode=\"decimal\"\n                value={currentAnswer ?? ''}\n                onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n                id={`${currentQuestion.id}-number`}\n                className=\"w-full flex-1 min-w-0 px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n              />\n              {unitLabel && (\n                <span className=\"inline-flex items-center px-4 py-2.5 sm:py-3 border-2 border-blue-100 bg-blue-50 text-sm font-semibold text-blue-700 rounded-xl whitespace-nowrap\">\n                  {unitLabel}\n                </span>\n              )}\n            </div>\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Vous pouvez saisir un nombre entier ou dÃ©cimal.\n            </p>\n          </div>\n        );\n      }\n      case 'url':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-url`}>\n              Indiquez une adresse URL\n            </label>\n            <input\n              type=\"url\"\n              value={currentAnswer ?? ''}\n              onChange={(e) => onAnswer(currentQuestion.id, e.target.value)}\n              placeholder=\"https://exemple.com\"\n              id={`${currentQuestion.id}-url`}\n              className=\"w-full px-4 py-2.5 sm:py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hv-focus-ring\"\n            />\n            <p className=\"text-xs text-gray-500 mt-2\">\n              Incluez le protocole (https://) pour une URL valide.\n            </p>\n          </div>\n        );\n      case 'file':\n        return (\n          <div className=\"mb-8\">\n            <label className=\"block text-sm sm:text-base font-medium text-gray-700 mb-3\" htmlFor={`${currentQuestion.id}-file`}>\n              TÃ©lÃ©versez un fichier de rÃ©fÃ©rence\n            </label>\n            <input\n              type=\"file\"\n              onChange={(e) => {\n                const file = e.target.files && e.target.files[0];\n                if (file) {\n                  onAnswer(currentQuestion.id, {\n                    name: file.name,\n                    size: file.size,\n                    type: file.type\n                  });\n                } else {\n                  onAnswer(currentQuestion.id, null);\n                }\n              }}\n              id={`${currentQuestion.id}-file`}\n              className=\"w-full focus:outline-none hv-focus-ring\"\n            />\n            {currentAnswer && (\n              <p className=\"text-xs text-gray-500 mt-2\">\n                {(() => {\n                  const size = typeof currentAnswer.size === 'number'\n                    ? ` (${Math.round(currentAnswer.size / 1024)} Ko)`\n                    : '';\n                  return `Fichier sÃ©lectionnÃ© : ${currentAnswer.name}${size}`;\n                })()}\n              </p>\n            )}\n          </div>\n        );\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 px-4 py-6 sm:px-8 sm:py-10 hv-background\">\n      <div className=\"max-w-3xl mx-auto\">\n        <div className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 hv-surface\">\n          <div className=\"mb-8\">\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-2\">\n              <span id={progressLabelId} className=\"text-sm font-medium text-gray-600 hv-text-muted\" aria-live=\"polite\">\n                Question {currentIndex + 1} sur {questions.length}\n              </span>\n              <span className=\"text-sm font-medium text-blue-600 sm:text-right\" aria-live=\"polite\">\n                {remainingLabel}\n              </span>\n            </div>\n            <div\n              className=\"w-full bg-gray-200 rounded-full h-2 hv-progress\"\n              role=\"progressbar\"\n              aria-valuenow={Math.round(progress)}\n              aria-valuemin={0}\n              aria-valuemax={100}\n              aria-valuetext={remainingLabel}\n              aria-labelledby={progressLabelId}\n            >\n              <span\n                className=\"block bg-blue-600 h-2 rounded-full transition-all duration-300 hv-progress-indicator\"\n                style={{ width: `${progress}%` }}\n              />\n            </div>\n            {currentIndex === 0 && (\n              <p id={instructionsId} className=\"text-xs text-gray-500 mt-2 flex items-center hv-text-muted\">\n                <Info className=\"w-3 h-3 mr-1\" />\n                Certaines questions peuvent apparaÃ®tre en fonction de vos rÃ©ponses\n              </p>\n            )}\n            {currentIndex === 0 && (\n              <p className=\"mt-4 text-xs italic text-gray-400\">\n                Le LFB traite les donnÃ©es recueillies pour gÃ©rer les projets Ã  soumettre aux Ã©quipes compliance.{' '}\n                <a\n                  href=\"./mentions-legales.html\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"underline hover:text-gray-500\"\n                >\n                  En savoir plus sur vos donnÃ©es et vos droits\n                </a>\n              </p>\n            )}\n          </div>\n\n          {hasSaveFeedback && (\n            <div className=\"mb-6\" role=\"status\" aria-live=\"polite\">\n              <div\n                className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${\n                  isSaveSuccess\n                    ? 'border-emerald-200 bg-emerald-50 text-emerald-700'\n                    : 'border-red-200 bg-red-50 text-red-700'\n                }`}\n              >\n                {isSaveSuccess ? (\n                  <CheckCircle className=\"mt-0.5 h-5 w-5\" />\n                ) : (\n                  <AlertTriangle className=\"mt-0.5 h-5 w-5\" />\n                )}\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\">{saveFeedback.message}</p>\n                </div>\n                {typeof onDismissSaveFeedback === 'function' && (\n                  <button\n                    type=\"button\"\n                    onClick={onDismissSaveFeedback}\n                    className=\"text-xs font-semibold uppercase tracking-wide text-current hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-current rounded\"\n                  >\n                    Fermer\n                  </button>\n                )}\n              </div>\n            </div>\n          )}\n\n          <div className=\"mb-8\" data-tour-id=\"question-main-content\">\n            <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\n              <h2 id={questionTextId} className=\"text-2xl font-bold text-gray-800 sm:text-3xl\">\n                {currentQuestion.question}\n              </h2>\n              {!currentQuestion.required && (\n                <span className=\"inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-wide bg-gray-100 text-gray-600 rounded-full border border-gray-200 hv-badge self-start\">\n                  RÃ©ponse facultative\n                </span>\n              )}\n              {hasGuidanceContent && (\n                <button\n                  type=\"button\"\n                  onClick={() => setShowGuidance(prev => !prev)}\n                  className={`inline-flex items-center justify-center w-full sm:w-auto px-4 py-2 text-sm font-medium rounded-lg border transition-all hv-button hv-focus-ring ${\n                    showGuidance\n                      ? 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700'\n                      : 'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100'\n                  }`}\n                  aria-expanded={showGuidance}\n                  aria-controls={guidancePanelId}\n                  data-tour-id=\"question-guidance-toggle\"\n                >\n                  <Info className=\"w-4 h-4 mr-2\" />\n                  {showGuidance ? \"Masquer l'aide\" : 'Comprendre cette question'}\n                </button>\n              )}\n            </div>\n\n            {hasGuidanceContent && showGuidance && (\n              <div\n                id={guidancePanelId}\n                className=\"mt-4 bg-blue-50 border border-blue-200 rounded-2xl p-5 text-sm text-gray-700 hv-surface\"\n                role=\"region\"\n                aria-label=\"Aide contextuelle\"\n              >\n                <div className=\"flex items-start\">\n                  <div className=\"mr-3 mt-0.5 text-blue-600\">\n                    <Info className=\"w-5 h-5\" />\n                  </div>\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h3 className=\"text-base font-semibold text-blue-700\">Guidage contextuel</h3>\n                      {guidance.objective && (\n                        <p className=\"mt-1 text-gray-700\">{renderTextWithLinks(guidance.objective)}</p>\n                      )}\n                    </div>\n\n                    {guidance.details && (\n                      <p className=\"text-gray-700 leading-relaxed\">{renderTextWithLinks(guidance.details)}</p>\n                    )}\n\n                    {hasConditions && (\n                      <div>\n                        <h4 className=\"text-xs font-semibold uppercase tracking-wide text-blue-700\">Pourquoi cette question apparaÃ®t</h4>\n                        {conditionSummaries.length === 1 ? (\n                          (() => {\n                            const logic = conditionSummaries[0].logic === 'any' ? 'any' : 'all';\n                            return (\n                              <p className=\"text-xs text-blue-600 mt-1\">\n                                Elle s'affiche lorsque {logic === 'any'\n                                  ? \"au moins une des conditions suivantes est remplie\"\n                                  : 'toutes les conditions suivantes sont remplies'}.\n                              </p>\n                            );\n                          })()\n                        ) : (\n                          <div className=\"text-xs text-blue-600 mt-1 space-y-1\">\n                            <p>\n                              Cette question apparaÃ®t lorsque{' '}\n                              <strong className=\"text-blue-700\">chaque groupe de conditions</strong> ci-dessous est vÃ©rifiÃ©.\n                            </p>\n                            <p>\n                              Ã€ l'intÃ©rieur de chaque groupe, suivez la logique indiquÃ©e (ET ou OU) pour les conditions listÃ©es.\n                            </p>\n                          </div>\n                        )}\n                        <div className=\"mt-3 space-y-3\">\n                          {conditionSummaries.map((groupSummary, idx) => {\n                            const logicLabel = groupSummary.logic === 'any' ? 'OU' : 'ET';\n                            const connectorLabel = groupSummary.logic === 'any' ? 'OU' : 'ET';\n\n                            if (groupSummary.conditions.length === 0) {\n                              return null;\n                            }\n\n                            return (\n                              <div key={`condition-group-${idx}`} className=\"bg-white border border-blue-100 rounded-xl p-3 hv-surface\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                  <span className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">\n                                    Groupe {idx + 1}\n                                  </span>\n                                  <span className=\"text-[11px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full\">\n                                    Logique {logicLabel}\n                                  </span>\n                                  {idx > 0 && (\n                                    <span className=\"ml-auto text-[11px] font-semibold text-blue-600 uppercase tracking-wide\">\n                                      ET avec prÃ©cÃ©dent\n                                    </span>\n                                  )}\n                                </div>\n                                <ul className=\"space-y-2\">\n                                  {groupSummary.conditions.map((item, conditionIdx) => (\n                                    <li key={`${item.label}-${conditionIdx}`} className=\"text-sm text-gray-700\">\n                                      <p className=\"font-medium text-gray-800\">\n                                        {conditionIdx > 0 && (\n                                          <span className=\"inline-flex items-center px-2 py-0.5 mr-2 text-[11px] font-semibold uppercase tracking-wide rounded-full bg-blue-100 text-blue-700\">\n                                            {connectorLabel}\n                                          </span>\n                                        )}\n                                        {item.label} {item.operator} \"{item.value}\"\n                                      </p>\n                                      {item.answer && (\n                                        <p className=\"text-xs text-gray-500 mt-1\">\n                                          Votre rÃ©ponse :{' '}\n                                          <span className=\"font-medium text-gray-700\">\n                                            {renderTextWithLinks(item.answer)}\n                                          </span>\n                                        </p>\n                                      )}\n                                    </li>\n                                  ))}\n                                </ul>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      </div>\n                    )}\n\n                    {guidanceTips.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-semibold uppercase tracking-wide text-blue-700\">Conseils pratiques</h4>\n                        <ul className=\"mt-2 space-y-2 list-disc list-inside text-sm text-gray-700\">\n                          {guidanceTips.map((tip, idx) => (\n                            <li key={idx}>{renderTextWithLinks(tip)}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {hasValidationError && (\n            <div className=\"mb-6\" role=\"alert\" aria-live=\"assertive\">\n              <div className=\"flex items-start space-x-3 rounded-xl border border-red-200 bg-red-50 p-4 text-red-700 hv-surface\">\n                <AlertTriangle className=\"w-5 h-5 mt-0.5\" />\n                <div>\n                  <p className=\"text-sm font-semibold\">RÃ©ponse obligatoire manquante</p>\n                  <p className=\"text-sm\">{validationError?.message}</p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {isReturnToSynthesisRequested && (\n            <div\n              className=\"mb-4 flex items-start gap-3 rounded-xl border border-blue-200 bg-blue-50 p-4 text-sm text-blue-800\"\n              role=\"status\"\n              aria-live=\"polite\"\n            >\n              <Info className=\"mt-0.5 h-5 w-5\" />\n              <p>Modification depuis le rapport Compliance. Validez vos changements pour y retourner.</p>\n            </div>\n          )}\n\n          {renderQuestionInput()}\n\n          <div\n            className={`flex flex-col-reverse gap-3 sm:flex-row sm:items-center ${\n              currentIndex === 0 && !onSaveDraft\n                ? 'sm:justify-end'\n                : 'sm:justify-between'\n            }`}\n            data-tour-id=\"questionnaire-finish\"\n          >\n            {currentIndex > 0 && (\n              <button\n                type=\"button\"\n                onClick={onBack}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                <ChevronLeft className=\"w-5 h-5 mr-2\" />\n                PrÃ©cÃ©dent\n              </button>\n            )}\n\n            {onSaveDraft && (\n              <button\n                type=\"button\"\n                onClick={onSaveDraft}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"question-save-draft\"\n              >\n                <Save className=\"w-5 h-5 mr-2\" />\n                Enregistrer le projet\n              </button>\n            )}\n\n            {onReturnToSynthesis && (\n              <button\n                type=\"button\"\n                onClick={onReturnToSynthesis}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                <CheckCircle className=\"w-5 h-5 mr-2\" />\n                Valider et revenir au rapport\n              </button>\n            )}\n\n            {shouldShowNextButton && (\n              <button\n                type=\"button\"\n                onClick={isReturnToSynthesisRequested ? handleLinkedQuestionNext : onNext}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n              >\n                {currentIndex === questions.length - 1 ? 'Voir la synthÃ¨se' : 'Suivant'}\n                <ChevronRight className=\"w-5 h-5 ml-2\" />\n              </button>\n            )}\n\n            {currentIndex < questions.length - 1 && onFinish && shouldShowFinishButton && (\n              <button\n                type=\"button\"\n                onClick={onFinish}\n                className=\"flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 transition-all hv-button w-full sm:w-auto text-sm sm:text-base\"\n              >\n                Fin\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n",
  "src/components/RichTextEditor.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\nimport { sanitizeRichText } from '../utils/richText.js';\n\nconst BUTTON_BASE_CLASSES =\n  'inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1';\nconst LIST_BUTTON_CLASSES =\n  'inline-flex items-center gap-3 px-3 py-1.5 text-sm font-semibold rounded-full border border-gray-300 text-gray-900 bg-white shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1';\n\nconst commandIsAvailable = () => typeof document !== 'undefined' && typeof document.execCommand === 'function';\n\nconst normalizeValue = (value) => (typeof value === 'string' ? value : '');\n\nexport const RichTextEditor = ({\n  id,\n  value,\n  onChange,\n  placeholder = 'Commencez votre saisie (texte riche et liens autorisÃ©s)',\n  compact = false,\n  ariaLabel\n}) => {\n  const editorRef = useRef(null);\n  const linkTextInputRef = useRef(null);\n  const selectionRangeRef = useRef(null);\n  const selectedTextRef = useRef('');\n  const [htmlValue, setHtmlValue] = useState(() => normalizeValue(value));\n  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);\n  const [linkText, setLinkText] = useState('');\n  const [linkUrl, setLinkUrl] = useState('https://');\n  const [linkError, setLinkError] = useState('');\n\n  useEffect(() => {\n    setHtmlValue(normalizeValue(value));\n  }, [value]);\n\n  useEffect(() => {\n    const normalized = normalizeValue(value);\n    setHtmlValue(normalized);\n\n    if (!editorRef.current) {\n      return;\n    }\n\n    const isFocused =\n      typeof document !== 'undefined' && document.activeElement === editorRef.current;\n\n    if (isFocused) {\n      return;\n    }\n\n    if (editorRef.current.innerHTML !== normalized) {\n      editorRef.current.innerHTML = normalized || '';\n    }\n  }, [value]);\n\n  useEffect(() => {\n    if (isLinkModalOpen && linkTextInputRef.current) {\n      linkTextInputRef.current.focus();\n    }\n  }, [isLinkModalOpen]);\n\n  const emitChange = useCallback(\n    (nextValue) => {\n      const sanitized = sanitizeRichText(nextValue || '');\n      setHtmlValue(sanitized);\n      onChange?.(sanitized);\n      return sanitized;\n    },\n    [onChange]\n  );\n\n  const syncEditorHtml = useCallback((sanitized) => {\n    if (!editorRef.current) {\n      return;\n    }\n\n    if (editorRef.current.innerHTML === sanitized) {\n      return;\n    }\n\n    editorRef.current.innerHTML = sanitized || '';\n\n    if (typeof document !== 'undefined' && document.activeElement === editorRef.current) {\n      const selection = typeof window !== 'undefined' && typeof window.getSelection === 'function'\n        ? window.getSelection()\n        : null;\n      if (selection) {\n        const range = document.createRange();\n        range.selectNodeContents(editorRef.current);\n        range.collapse(false);\n        selection.removeAllRanges();\n        selection.addRange(range);\n      }\n    }\n  }, []);\n\n  const handleInput = useCallback(() => {\n    const sanitized = emitChange(editorRef.current?.innerHTML || '');\n    syncEditorHtml(sanitized);\n  }, [emitChange, syncEditorHtml]);\n\n  const handleBlur = useCallback(() => {\n    const sanitized = emitChange(editorRef.current?.innerHTML || '');\n\n    if (editorRef.current && editorRef.current.innerHTML !== sanitized) {\n      editorRef.current.innerHTML = sanitized || '';\n    }\n  }, [emitChange]);\n\n  const handlePaste = useCallback(\n    (event) => {\n      if (!event?.clipboardData) {\n        return;\n      }\n\n      const text = event.clipboardData.getData('text/plain');\n      if (commandIsAvailable()) {\n        event.preventDefault();\n        document.execCommand('insertText', false, text);\n        handleInput();\n      }\n    },\n    [handleInput]\n  );\n\n  const applyCommand = useCallback(\n    (command, argument = null) => {\n      if (!commandIsAvailable()) {\n        return;\n      }\n\n      document.execCommand(command, false, argument);\n      handleInput();\n    },\n    [handleInput]\n  );\n\n  const captureSelection = useCallback(() => {\n    if (typeof window === 'undefined' || !editorRef.current) {\n      return '';\n    }\n\n    const selection = typeof window.getSelection === 'function' ? window.getSelection() : null;\n    if (!selection || selection.rangeCount === 0) {\n      return '';\n    }\n\n    const range = selection.getRangeAt(0);\n    if (!editorRef.current.contains(range.commonAncestorContainer)) {\n      return '';\n    }\n\n    selectionRangeRef.current = range;\n    const selectedText = selection.toString() || '';\n    selectedTextRef.current = selectedText;\n    return selectedText;\n  }, []);\n\n  const handleAddLink = useCallback(() => {\n    if (typeof window === 'undefined' || !commandIsAvailable()) {\n      return;\n    }\n\n    const selectedText = captureSelection();\n    const normalizedSelectedText = selectedText || selectedTextRef.current || '';\n    setLinkText(normalizedSelectedText);\n    setLinkUrl('https://');\n    setLinkError('');\n    setIsLinkModalOpen(true);\n  }, [captureSelection]);\n\n  const handleCloseLinkModal = useCallback(() => {\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, []);\n\n  const handleConfirmLink = useCallback((event) => {\n    event?.preventDefault?.();\n\n    const trimmedUrl = linkUrl.trim();\n    if (!/^https?:\\/\\//i.test(trimmedUrl)) {\n      setLinkError('Veuillez saisir une URL valide (https://...)');\n      return;\n    }\n\n    const normalizedDisplayText = linkText.trim() || selectedTextRef.current || trimmedUrl;\n    const linkHtml = `<a href=\"${trimmedUrl}\" target=\"_blank\" rel=\"noopener noreferrer\">${normalizedDisplayText}</a>`;\n\n    if (typeof window !== 'undefined' && selectionRangeRef.current && typeof window.getSelection === 'function') {\n      const selection = window.getSelection();\n      if (selection) {\n        selection.removeAllRanges();\n        selection.addRange(selectionRangeRef.current);\n      }\n    }\n\n    applyCommand('insertHTML', linkHtml);\n    setIsLinkModalOpen(false);\n    setLinkError('');\n  }, [applyCommand, linkText, linkUrl]);\n\n  const minHeight = useMemo(() => (compact ? 120 : 180), [compact]);\n  const showPlaceholder = !htmlValue;\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex flex-wrap gap-2\">\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('bold')}>\n          <span className=\"font-semibold\">G</span>\n          <span className=\"sr-only\">Mettre en gras</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('italic')}>\n          <span className=\"italic\">I</span>\n          <span className=\"sr-only\">Italique</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('underline')}>\n          <span className=\"underline\">U</span>\n          <span className=\"sr-only\">Souligner</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('insertUnorderedList')}>\n          <svg\n            aria-hidden=\"true\"\n            fill=\"#000000\"\n            height=\"20px\"\n            width=\"20px\"\n            version=\"1.1\"\n            id=\"Icons\"\n            xmlns=\"http://www.w3.org/2000/svg\"\n            xmlnsXlink=\"http://www.w3.org/1999/xlink\"\n            viewBox=\"0 0 32 32\"\n            xmlSpace=\"preserve\"\n          >\n            <g id=\"SVGRepo_bgCarrier\" strokeWidth=\"0\" />\n            <g id=\"SVGRepo_tracerCarrier\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n            <g id=\"SVGRepo_iconCarrier\">\n              <g>\n                <path d=\"M11,8h18c0.6,0,1-0.4,1-1s-0.4-1-1-1H11c-0.6,0-1,0.4-1,1S10.4,8,11,8z\" />\n                <path d=\"M11,17h11c0.6,0,1-0.4,1-1s-0.4-1-1-1H11c-0.6,0-1,0.4-1,1S10.4,17,11,17z\" />\n                <path d=\"M29,24H11c-0.6,0-1,0.4-1,1s0.4,1,1,1h18c0.6,0,1-0.4,1-1S29.6,24,29,24z\" />\n                <path d=\"M5,4C3.3,4,2,5.3,2,7s1.3,3,3,3s3-1.3,3-3S6.7,4,5,4z\" />\n                <path d=\"M5,13c-1.7,0-3,1.3-3,3s1.3,3,3,3s3-1.3,3-3S6.7,13,5,13z\" />\n                <path d=\"M5,22c-1.7,0-3,1.3-3,3s1.3,3,3,3s3-1.3,3-3S6.7,22,5,22z\" />\n              </g>\n            </g>\n          </svg>\n          <span className=\"sr-only\">Liste Ã  puces</span>\n        </button>\n        <button\n          type=\"button\"\n          className={BUTTON_BASE_CLASSES}\n          onMouseDown={(event) => {\n            if (event.button !== 0) {\n              return;\n            }\n            captureSelection();\n          }}\n          onClick={handleAddLink}\n        >\n          <span aria-hidden=\"true\">ðŸ”—</span>\n          <span className=\"sr-only\">InsÃ©rer un lien</span>\n        </button>\n        <button type=\"button\" className={BUTTON_BASE_CLASSES} onClick={() => applyCommand('removeFormat')}>\n          <span aria-hidden=\"true\">âŸ²</span>\n          <span className=\"sr-only\">Nettoyer la mise en forme</span>\n        </button>\n      </div>\n      <div className=\"relative\">\n        {showPlaceholder && (\n          <div\n            className=\"pointer-events-none absolute inset-0 px-4 py-3 text-sm text-gray-500 select-none leading-relaxed\"\n            style={{ pointerEvents: 'none', userSelect: 'none' }}\n          >\n            {placeholder}\n          </div>\n        )}\n        <div\n          id={id}\n          ref={editorRef}\n          className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[120px] prose prose-sm max-w-none hv-focus-ring hv-richtext\"\n          style={{ minHeight }}\n          contentEditable={true}\n          suppressContentEditableWarning\n          onInput={handleInput}\n          onBlur={handleBlur}\n          onPaste={handlePaste}\n          onKeyUp={handleInput}\n          onCompositionEnd={handleInput}\n          tabIndex={0}\n          role=\"textbox\"\n          aria-label={ariaLabel || placeholder}\n        />\n      </div>\n      {isLinkModalOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6\">\n          <div className=\"absolute inset-0 bg-gray-900/50\" onClick={handleCloseLinkModal} aria-hidden=\"true\" />\n          <div\n            className=\"relative w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl\"\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby={`${id}-link-modal-title`}\n          >\n            <h3 id={`${id}-link-modal-title`} className=\"text-lg font-semibold text-gray-900\">\n              InsÃ©rer un lien\n            </h3>\n            <p className=\"mt-1 text-sm text-gray-500\">\n              Renseignez le texte Ã  afficher et lâ€™URL complÃ¨te (https://).\n            </p>\n            <div className=\"mt-4 space-y-4\">\n              <div>\n                <label htmlFor={`${id}-link-text`} className=\"block text-sm font-medium text-gray-700\">\n                  Texte du lien\n                </label>\n                <input\n                  id={`${id}-link-text`}\n                  ref={linkTextInputRef}\n                  type=\"text\"\n                  value={linkText}\n                  onChange={(event) => setLinkText(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"Ex : DÃ©couvrir le document\"\n                />\n              </div>\n              <div>\n                <label htmlFor={`${id}-link-url`} className=\"block text-sm font-medium text-gray-700\">\n                  URL\n                </label>\n                <input\n                  id={`${id}-link-url`}\n                  type=\"url\"\n                  value={linkUrl}\n                  onChange={(event) => setLinkUrl(event.target.value)}\n                  className=\"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"https://exemple.com\"\n                />\n                {linkError && <p className=\"mt-2 text-sm text-red-600\">{linkError}</p>}\n              </div>\n            </div>\n            <div className=\"mt-6 flex flex-wrap justify-end gap-3\">\n              <button\n                type=\"button\"\n                onClick={handleCloseLinkModal}\n                className=\"rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleConfirmLink}\n                className=\"rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700\"\n              >\n                InsÃ©rer le lien\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/RuleEditor.jsx": "import React, { useEffect, useRef, useState } from '../react.js';\nimport {\n  Plus,\n  Trash2,\n  CheckCircle,\n  Clipboard,\n  Target,\n  Lightbulb,\n  Users,\n  FileText,\n  AlertTriangle\n} from './icons.js';\nimport {\n  applyRuleConditionGroups,\n  normalizeRuleConditionGroups,\n  sanitizeRuleCondition,\n  createEmptyQuestionCondition,\n  createEmptyTimingCondition\n} from '../utils/ruleConditions.js';\nimport { ensureOperatorForType, getOperatorOptionsForType } from '../utils/operatorOptions.js';\nimport {\n  sanitizeRiskTimingConstraint,\n  sanitizeTeamQuestionEntry,\n  sanitizeTeamQuestionsByTeam\n} from '../utils/rules.js';\n\nconst RISK_PRIORITY_OPTIONS = [\n  'A rÃ©aliser',\n  'A anticiper',\n  'A particuliÃ¨rement anticiper'\n];\n\nconst normalizeRiskEntry = (risk, availableTeams = []) => {\n  const safeTeams = Array.isArray(availableTeams) ? availableTeams : [];\n  const fallbackTeam = safeTeams[0] || '';\n\n  const normalized = {\n    description: '',\n    level: 'Moyen',\n    mitigation: '',\n    priority: 'A rÃ©aliser',\n    teamId: fallbackTeam,\n    ...risk\n  };\n\n  if (!RISK_PRIORITY_OPTIONS.includes(normalized.priority)) {\n    normalized.priority = 'A rÃ©aliser';\n  }\n\n  if (normalized.level !== 'Faible' && normalized.level !== 'Moyen' && normalized.level !== 'Ã‰levÃ©') {\n    normalized.level = 'Moyen';\n  }\n\n  if (!safeTeams.includes(normalized.teamId)) {\n    normalized.teamId = fallbackTeam || '';\n  }\n\n  return {\n    ...normalized,\n    timingConstraint: sanitizeRiskTimingConstraint(normalized?.timingConstraint)\n  };\n};\n\nconst normalizeRiskList = (risks, availableTeams = []) => {\n  if (!Array.isArray(risks)) {\n    return [];\n  }\n\n  return risks.map((risk) => normalizeRiskEntry(risk, availableTeams));\n};\n\nexport const RuleEditor = ({ rule, onSave, onCancel, questions, teams }) => {\n  const overlayRef = useRef(null);\n  const titleRef = useRef(null);\n\n  useEffect(() => {\n    if (overlayRef.current) {\n      overlayRef.current.scrollTo({ top: 0 });\n    }\n\n    if (titleRef.current) {\n      titleRef.current.focus();\n    }\n  }, []);\n\n  const sanitizeConditionGroups = (groups) => {\n    return Array.isArray(groups)\n      ? groups.map(group => ({\n          ...group,\n          conditions: Array.isArray(group.conditions)\n            ? group.conditions.map(condition => {\n                if (condition?.type === 'timing') {\n                  const { complianceProfiles: _discardedComplianceProfiles, ...restTiming } = condition || {};\n                  return restTiming;\n                }\n\n                const question = questions.find(q => q.id === condition?.question);\n                const questionType = question?.type || 'choice';\n                return {\n                  ...condition,\n                  operator: ensureOperatorForType(questionType, condition?.operator)\n                };\n              })\n            : []\n        }))\n      : [];\n  };\n\n  const buildRuleState = (source) => {\n    const sanitizedSource = source || {};\n    const { priority: _discardedPriority, ...rest } = sanitizedSource;\n    const teamsList = Array.isArray(rest.teams) ? rest.teams : [];\n\n    const base = {\n      ...rest,\n      conditionLogic: rest.conditionLogic === 'any' ? 'any' : 'all',\n      conditions: Array.isArray(rest.conditions)\n        ? rest.conditions.map(sanitizeRuleCondition)\n        : [],\n      conditionGroups: Array.isArray(rest.conditionGroups) ? rest.conditionGroups : [],\n      teams: teamsList,\n      questions: sanitizeTeamQuestionsByTeam(rest.questions || {}),\n      risks: normalizeRiskList(rest.risks, teamsList)\n    };\n\n    const groups = sanitizeConditionGroups(normalizeRuleConditionGroups(base));\n    return applyRuleConditionGroups(base, groups);\n  };\n\n  const [editedRule, setEditedRule] = useState(() => buildRuleState(rule));\n\n  useEffect(() => {\n    setEditedRule(buildRuleState(rule));\n  }, [rule]);\n\n  const conditionGroups = Array.isArray(editedRule.conditionGroups)\n    ? editedRule.conditionGroups\n    : [];\n\n  const updateConditionGroupsState = (updater) => {\n    setEditedRule(prev => {\n      const currentGroups = Array.isArray(prev.conditionGroups) ? prev.conditionGroups : [];\n      const nextGroups = sanitizeConditionGroups(updater(currentGroups));\n      return applyRuleConditionGroups(prev, nextGroups);\n    });\n  };\n\n  const addConditionGroup = () => {\n    updateConditionGroupsState(groups => ([\n      ...groups,\n      { logic: 'all', conditions: [createEmptyQuestionCondition()] }\n    ]));\n  };\n\n  const updateConditionGroupLogic = (groupIndex, logic) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      updated[groupIndex] = {\n        ...target,\n        logic: logic === 'any' ? 'any' : 'all'\n      };\n      return updated;\n    });\n  };\n\n  const deleteConditionGroup = (groupIndex) => {\n    updateConditionGroupsState(groups => groups.filter((_, idx) => idx !== groupIndex));\n  };\n\n  const withUpdatedCondition = (groups, groupIndex, conditionIndex, updater) => {\n    const updated = [...groups];\n    const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n    const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n    const currentCondition = sanitizeRuleCondition(\n      conditions[conditionIndex] || createEmptyQuestionCondition()\n    );\n    const updatedCondition = sanitizeRuleCondition(\n      updater ? updater(currentCondition) || currentCondition : currentCondition\n    );\n    const question = questions.find(q => q.id === updatedCondition.question);\n    const questionType = question?.type || 'choice';\n    const nextCondition = updatedCondition.type === 'timing'\n      ? updatedCondition\n      : { ...updatedCondition, operator: ensureOperatorForType(questionType, updatedCondition.operator) };\n    conditions[conditionIndex] = nextCondition;\n    updated[groupIndex] = { ...target, conditions };\n    return updated;\n  };\n\n  const addConditionToGroup = (groupIndex) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n      conditions.push(createEmptyQuestionCondition());\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    });\n  };\n\n  const updateConditionField = (groupIndex, conditionIndex, field, value) => {\n    updateConditionGroupsState(groups =>\n      withUpdatedCondition(groups, groupIndex, conditionIndex, condition => ({\n        ...condition,\n        [field]: value\n      }))\n    );\n  };\n\n  const deleteConditionFromGroup = (groupIndex, conditionIndex) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = Array.isArray(target.conditions)\n        ? target.conditions.filter((_, idx) => idx !== conditionIndex)\n        : [];\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    });\n  };\n\n  const handleConditionTypeChange = (groupIndex, conditionIndex, type) => {\n    updateConditionGroupsState(groups => {\n      const updated = [...groups];\n      const target = updated[groupIndex] || { logic: 'all', conditions: [] };\n      const conditions = Array.isArray(target.conditions) ? [...target.conditions] : [];\n      const normalizedType = type === 'timing' ? 'timing' : 'question';\n      conditions[conditionIndex] = normalizedType === 'timing'\n        ? createEmptyTimingCondition()\n        : createEmptyQuestionCondition();\n      updated[groupIndex] = { ...target, conditions };\n      return updated;\n    });\n  };\n\n  const toggleTeam = (teamId) => {\n    const currentTeams = Array.isArray(editedRule.teams) ? editedRule.teams : [];\n    const newTeams = currentTeams.includes(teamId)\n      ? currentTeams.filter(t => t !== teamId)\n      : [...currentTeams, teamId];\n    const normalizedRisks = normalizeRiskList(editedRule.risks, newTeams);\n    setEditedRule({ ...editedRule, teams: newTeams, risks: normalizedRisks });\n  };\n\n  const addQuestionForTeam = (teamId) => {\n    setEditedRule(prev => {\n      const currentQuestions = typeof prev.questions === 'object' && prev.questions !== null\n        ? { ...prev.questions }\n        : {};\n      const existing = Array.isArray(currentQuestions[teamId])\n        ? [...currentQuestions[teamId]]\n        : [];\n      existing.push(sanitizeTeamQuestionEntry({ text: '' }));\n      currentQuestions[teamId] = existing;\n      return { ...prev, questions: currentQuestions };\n    });\n  };\n\n  const updateTeamQuestion = (teamId, index, value) => {\n    setEditedRule(prev => {\n      const currentQuestions = typeof prev.questions === 'object' && prev.questions !== null\n        ? { ...prev.questions }\n        : {};\n      const existing = Array.isArray(currentQuestions[teamId])\n        ? [...currentQuestions[teamId]]\n        : [];\n      const currentEntry = sanitizeTeamQuestionEntry(existing[index] || {});\n      existing[index] = { ...currentEntry, text: value };\n      currentQuestions[teamId] = existing;\n      return { ...prev, questions: currentQuestions };\n    });\n  };\n\n  const deleteTeamQuestion = (teamId, index) => {\n    setEditedRule(prev => {\n      const currentQuestions = typeof prev.questions === 'object' && prev.questions !== null\n        ? { ...prev.questions }\n        : {};\n      const existing = Array.isArray(currentQuestions[teamId])\n        ? currentQuestions[teamId].filter((_, i) => i !== index)\n        : [];\n      currentQuestions[teamId] = existing;\n      return { ...prev, questions: currentQuestions };\n    });\n  };\n\n  const updateTeamQuestionTiming = (teamId, index, updates) => {\n    setEditedRule(prev => {\n      const currentQuestions = typeof prev.questions === 'object' && prev.questions !== null\n        ? { ...prev.questions }\n        : {};\n      const existing = Array.isArray(currentQuestions[teamId])\n        ? [...currentQuestions[teamId]]\n        : [];\n      const currentEntry = sanitizeTeamQuestionEntry(existing[index] || {});\n      const mergedConstraint = {\n        ...currentEntry.timingConstraint,\n        ...(typeof updates === 'function'\n          ? updates(currentEntry.timingConstraint)\n          : updates)\n      };\n      existing[index] = {\n        ...currentEntry,\n        timingConstraint: sanitizeRiskTimingConstraint(mergedConstraint)\n      };\n      currentQuestions[teamId] = existing;\n      return { ...prev, questions: currentQuestions };\n    });\n  };\n\n  const addRisk = () => {\n    const teamsForRisk = Array.isArray(editedRule.teams) ? editedRule.teams : [];\n    const fallbackTeam = teamsForRisk[0] || '';\n    const newRisk = normalizeRiskEntry({\n      description: '',\n      level: 'Moyen',\n      mitigation: '',\n      priority: 'A rÃ©aliser',\n      teamId: fallbackTeam,\n      timingConstraint: sanitizeRiskTimingConstraint()\n    }, teamsForRisk);\n\n    const existingRisks = Array.isArray(editedRule.risks) ? editedRule.risks : [];\n    setEditedRule({\n      ...editedRule,\n      risks: [...existingRisks, newRisk]\n    });\n  };\n\n  const updateRisk = (index, field, value) => {\n    const currentRisks = Array.isArray(editedRule.risks) ? [...editedRule.risks] : [];\n    const baseRisk = normalizeRiskEntry(currentRisks[index] || {}, editedRule.teams);\n    currentRisks[index] = { ...baseRisk, [field]: value };\n    const normalizedRisks = normalizeRiskList(currentRisks, editedRule.teams);\n    setEditedRule({ ...editedRule, risks: normalizedRisks });\n  };\n\n  const deleteRisk = (index) => {\n    setEditedRule({\n      ...editedRule,\n      risks: editedRule.risks.filter((_, i) => i !== index)\n    });\n  };\n\n  const updateRiskTimingConstraint = (index, updates) => {\n    setEditedRule(prev => {\n      const currentRisks = Array.isArray(prev.risks) ? [...prev.risks] : [];\n      const baseRisk = normalizeRiskEntry(currentRisks[index] || {}, prev.teams);\n      const mergedConstraint = {\n        ...baseRisk.timingConstraint,\n        ...(typeof updates === 'function' ? updates(baseRisk.timingConstraint) : updates)\n      };\n      baseRisk.timingConstraint = sanitizeRiskTimingConstraint(mergedConstraint);\n      currentRisks[index] = baseRisk;\n      const normalizedRisks = normalizeRiskList(currentRisks, prev.teams);\n      return { ...prev, risks: normalizedRisks };\n    });\n  };\n\n  const dateQuestions = questions.filter(q => (q.type || 'choice') === 'date');\n  const dialogTitleId = 'rule-editor-title';\n\n  return (\n    <div\n      ref={overlayRef}\n      className=\"fixed inset-0 bg-black bg-opacity-50 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto\"\n      role=\"presentation\"\n    >\n      <div\n        className=\"bg-white rounded-2xl shadow-2xl max-w-5xl w-full my-4 sm:my-8 overflow-y-auto hv-surface hv-modal-panel\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby={dialogTitleId}\n      >\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-8 py-6 rounded-t-2xl hv-surface\">\n          <div className=\"flex justify-between items-center\">\n            <h2\n              id={dialogTitleId}\n              ref={titleRef}\n              tabIndex={-1}\n              className=\"text-3xl font-bold text-gray-800 focus:outline-none\"\n            >\n              Ã‰dition de rÃ¨gle\n            </h2>\n            <div className=\"flex space-x-3\">\n              <button\n                type=\"button\"\n                onClick={onCancel}\n                className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium text-gray-700 transition-all hv-button\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  const normalizedRisks = normalizeRiskList(editedRule.risks, editedRule.teams);\n                  onSave(\n                    applyRuleConditionGroups(\n                      {\n                        ...editedRule,\n                        questions: sanitizeTeamQuestionsByTeam(editedRule.questions),\n                        risks: normalizedRisks\n                      },\n                      conditionGroups\n                    )\n                  );\n                }}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all hv-button hv-button-primary\"\n              >\n                Enregistrer\n              </button>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"px-8 py-6 space-y-8\">\n          {/* Informations gÃ©nÃ©rales */}\n          <div>\n            <h3 className=\"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2\">\n              <Clipboard className=\"w-5 h-5 text-blue-500\" />\n              Informations gÃ©nÃ©rales\n            </h3>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Nom de la rÃ¨gle</label>\n                <input\n                  type=\"text\"\n                  value={editedRule.name}\n                  onChange={(e) => setEditedRule({ ...editedRule, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"Ex: Projet digital avec donnÃ©es de santÃ©\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Conditions */}\n          <div>\n            <div className=\"flex justify-between items-center mb-4\">\n              <div>\n                <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n                  <Target className=\"w-5 h-5 text-blue-500\" />\n                  Conditions de dÃ©clenchement\n                </h3>\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  DÃ©finissez dans quels cas cette rÃ¨gle doit s'activer automatiquement.\n                </p>\n              </div>\n              <button\n                type=\"button\"\n                onClick={addConditionGroup}\n                className=\"flex items-center px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all text-sm font-medium\"\n              >\n                <Plus className=\"w-4 h-4 mr-1\" />\n                Ajouter un groupe\n              </button>\n            </div>\n\n            {conditionGroups.length === 0 ? (\n              <div className=\"bg-gray-50 rounded-lg p-6 text-center\">\n                <p className=\"text-gray-600 mb-2\">\n                  Cette rÃ¨gle est toujours dÃ©clenchÃ©e pour le moment.\n                </p>\n                <p className=\"text-sm text-gray-500\">\n                  CrÃ©ez un groupe pour spÃ©cifier des conditions de dÃ©clenchement.\n                </p>\n                <div className=\"mt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={addConditionGroup}\n                    className=\"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    CrÃ©er un groupe de conditions\n                  </button>\n                </div>\n              </div>\n            ) : (\n              <div>\n                <div className=\"bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200\">\n                  {conditionGroups.length === 1 ? (\n                    (() => {\n                      const logic = conditionGroups[0].logic === 'any' ? 'any' : 'all';\n                      const logicLabel = logic === 'any' ? 'OU' : 'ET';\n                      const logicDescription = logic === 'any'\n                        ? 'au moins une des conditions ci-dessous est remplie'\n                        : 'toutes les conditions ci-dessous sont remplies';\n\n                      return (\n                        <p className=\"text-sm text-blue-900\">\n                          <strong className=\"inline-flex items-center gap-2\">\n                            <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                            Logique :\n                          </strong>{' '}\n                          Cette rÃ¨gle se dÃ©clenchera si{' '}\n                          <strong className=\"text-blue-700\">{logicDescription}</strong>{' '}\n                          (logique {logicLabel}).\n                        </p>\n                      );\n                    })()\n                  ) : (\n                    <div className=\"space-y-2 text-sm text-blue-900\">\n                      <p>\n                        <strong className=\"inline-flex items-center gap-2\">\n                          <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                          Logique :\n                        </strong>{' '}\n                        La rÃ¨gle se dÃ©clenche lorsque{' '}\n                        <strong className=\"text-blue-700\">chaque groupe de conditions</strong> ci-dessous est validÃ© (logique globale <strong>ET</strong>).\n                      </p>\n                      <p>\n                        Ã€ l'intÃ©rieur d'un groupe, choisissez si{' '}\n                        <strong className=\"text-blue-700\">toutes</strong> les conditions doivent Ãªtre vraies (ET) ou si{' '}\n                        <strong className=\"text-blue-700\">au moins une</strong> suffit (OU).\n                      </p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"space-y-6\">\n                  {conditionGroups.map((group, groupIdx) => {\n                    const logic = group.logic === 'any' ? 'any' : 'all';\n                    const conditions = Array.isArray(group.conditions) ? group.conditions : [];\n                    const connectorLabel = logic === 'any' ? 'OU' : 'ET';\n\n                    return (\n                      <div key={groupIdx}>\n                        {groupIdx > 0 && (\n                          <div className=\"flex justify-center -mb-3\" aria-hidden=\"true\">\n                            <span className=\"bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow\">\n                              ET\n                            </span>\n                          </div>\n                        )}\n\n                        <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200\">\n                          <div className=\"flex flex-wrap items-center gap-3 mb-4\">\n                            <span className=\"text-sm font-semibold text-gray-700\">\n                              Groupe {groupIdx + 1}\n                            </span>\n                            <div className=\"flex items-center gap-2 text-xs text-blue-800 uppercase tracking-wide\">\n                              <span className=\"font-semibold\">Logique interne</span>\n                              <select\n                                value={logic}\n                                onChange={(e) => updateConditionGroupLogic(groupIdx, e.target.value)}\n                                className=\"px-3 py-1.5 border border-blue-200 rounded-lg bg-white text-xs focus:ring-2 focus:ring-blue-500\"\n                              >\n                                <option value=\"all\">Toutes les conditions (ET)</option>\n                                <option value=\"any\">Au moins une condition (OU)</option>\n                              </select>\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() => deleteConditionGroup(groupIdx)}\n                              className=\"ml-auto p-2 text-red-600 hover:bg-red-50 rounded transition-all\"\n                              aria-label={`Supprimer le groupe ${groupIdx + 1}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </button>\n                          </div>\n\n                          {conditions.length === 0 ? (\n                            <div className=\"bg-white border border-dashed border-blue-200 rounded-lg p-4 text-sm text-blue-700\">\n                              <p>Ajoutez une condition pour dÃ©finir ce groupe.</p>\n                              <button\n                                type=\"button\"\n                                onClick={() => addConditionToGroup(groupIdx)}\n                                className=\"mt-3 inline-flex items-center px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all text-sm font-medium\"\n                              >\n                                <Plus className=\"w-4 h-4 mr-1\" />\n                                Ajouter une condition\n                              </button>\n                            </div>\n                          ) : (\n                            <div className=\"space-y-4\">\n                              {conditions.map((condition, conditionIdx) => {\n                                const conditionType = condition.type === 'timing' ? 'timing' : 'question';\n                                const selectedQuestion = questions.find(q => q.id === condition.question);\n                                const selectedQuestionType = selectedQuestion?.type || 'choice';\n                                const usesOptions = ['choice', 'multi_choice'].includes(selectedQuestionType);\n                                const inputType = selectedQuestionType === 'number'\n                                  ? 'number'\n                                  : selectedQuestionType === 'date'\n                                    ? 'date'\n                                    : 'text';\n                                const placeholder = selectedQuestionType === 'date'\n                                  ? 'AAAA-MM-JJ'\n                                  : selectedQuestionType === 'url'\n                                    ? 'https://...'\n                                    : 'Valeur (texte, date, etc.)';\n\n                                return (\n                                  <div key={conditionIdx} className=\"bg-white rounded-lg border border-blue-200 p-4 shadow-sm\">\n                                    <div className=\"flex flex-wrap items-center gap-3 mb-3\">\n                                      {conditionIdx > 0 && (\n                                        <span className=\"bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold\">\n                                          {connectorLabel}\n                                        </span>\n                                      )}\n                                      <span className=\"text-sm font-semibold text-gray-700\">\n                                        Condition {conditionIdx + 1}\n                                      </span>\n                                      <select\n                                        value={conditionType}\n                                        onChange={(e) => handleConditionTypeChange(groupIdx, conditionIdx, e.target.value)}\n                                        className=\"px-3 py-2 border border-blue-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-blue-500\"\n                                      >\n                                        <option value=\"question\">BasÃ©e sur une rÃ©ponse</option>\n                                        <option value=\"timing\">Comparaison de dates</option>\n                                      </select>\n                                      <button\n                                        type=\"button\"\n                                        onClick={() => deleteConditionFromGroup(groupIdx, conditionIdx)}\n                                        className=\"ml-auto p-1 text-red-600 hover:bg-red-50 rounded transition-all\"\n                                      >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                      </button>\n                                    </div>\n\n                                    {conditionType === 'timing' ? (\n                                      <div className=\"space-y-4\">\n                                        {dateQuestions.length >= 2 ? (\n                                          <>\n                                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                              <div>\n                                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date de dÃ©part</label>\n                                                <select\n                                                  value={condition.startQuestion}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'startQuestion', e.target.value)}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                >\n                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                  {dateQuestions.map(q => (\n                                                    <option key={q.id} value={q.id}>{q.id} - {q.question ?? ''}</option>\n                                                  ))}\n                                                </select>\n                                              </div>\n\n                                              <div>\n                                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date d'arrivÃ©e</label>\n                                                <select\n                                                  value={condition.endQuestion}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'endQuestion', e.target.value)}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                >\n                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                  {dateQuestions.map(q => (\n                                                    <option key={q.id} value={q.id}>{q.id} - {q.question ?? ''}</option>\n                                                  ))}\n                                                </select>\n                                              </div>\n                                            </div>\n\n                                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                              <div>\n                                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">DurÃ©e minimale (semaines)</label>\n                                                <input\n                                                  type=\"number\"\n                                                  min=\"0\"\n                                                  value={condition.minimumWeeks ?? ''}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'minimumWeeks', e.target.value === '' ? undefined : Number(e.target.value))}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                  placeholder=\"Ex: 8\"\n                                                />\n                                              </div>\n\n                                              <div>\n                                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">DurÃ©e maximale (semaines - optionnel)</label>\n                                                <input\n                                                  type=\"number\"\n                                                  min=\"0\"\n                                                  value={condition.maximumWeeks ?? ''}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'maximumWeeks', e.target.value === '' ? undefined : Number(e.target.value))}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                  placeholder=\"Laisser vide si non concernÃ©\"\n                                                />\n                                              </div>\n                                            </div>\n\n                                            <p className=\"text-xs text-gray-500\">\n                                              La rÃ¨gle sera valide si la durÃ©e entre les deux dates respecte les contraintes dÃ©finies.\n                                            </p>\n\n                                          </>\n                                        ) : (\n                                          <div className=\"bg-white border border-dashed border-blue-200 rounded-lg p-4 text-sm text-blue-700\">\n                                            Ajoutez au moins deux questions de type date pour configurer cette condition temporelle.\n                                          </div>\n                                        )}\n                                      </div>\n                                    ) : (\n                                      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n                                        <div>\n                                          <label className=\"block text-xs font-medium text-gray-600 mb-1\">Question</label>\n                                          <select\n                                            value={condition.question}\n                                            onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'question', e.target.value)}\n                                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                          >\n                                            <option value=\"\">SÃ©lectionner...</option>\n                                            {questions.map(q => (\n                                              <option key={q.id} value={q.id}>{q.id} - {q.question ?? ''}</option>\n                                            ))}\n                                          </select>\n                                        </div>\n\n                                        <div>\n                                          <label className=\"block text-xs font-medium text-gray-600 mb-1\">OpÃ©rateur</label>\n                                          {(() => {\n                                            const operatorOptions = getOperatorOptionsForType(selectedQuestionType);\n                                            const operatorValue = ensureOperatorForType(selectedQuestionType, condition.operator);\n                                            return (\n                                              <select\n                                                value={operatorValue}\n                                                onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'operator', e.target.value)}\n                                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                              >\n                                                {operatorOptions.map(option => (\n                                                  <option key={option.value} value={option.value}>{option.label}</option>\n                                                ))}\n                                              </select>\n                                            );\n                                          })()}\n                                        </div>\n\n                                        <div>\n                                          <label className=\"block text-xs font-medium text-gray-600 mb-1\">Valeur</label>\n                                          {(() => {\n                                            if (!condition.question) {\n                                              return (\n                                                <input\n                                                  type=\"text\"\n                                                  value={condition.value}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'value', e.target.value)}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                  placeholder=\"Valeur (texte, date, etc.)\"\n                                                />\n                                              );\n                                            }\n\n                                            if (usesOptions) {\n                                              return (\n                                                <select\n                                                  value={condition.value}\n                                                  onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'value', e.target.value)}\n                                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                >\n                                                  <option value=\"\">SÃ©lectionner...</option>\n                                                  {(selectedQuestion?.options || []).map((opt, i) => (\n                                                    <option key={i} value={opt}>{opt}</option>\n                                                  ))}\n                                                </select>\n                                              );\n                                            }\n\n                                            return (\n                                              <input\n                                                type={inputType}\n                                                value={condition.value}\n                                                onChange={(e) => updateConditionField(groupIdx, conditionIdx, 'value', e.target.value)}\n                                                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                                placeholder={placeholder}\n                                              />\n                                            );\n                                          })()}\n                                        </div>\n                                      </div>\n                                    )}\n                                  </div>\n                                );\n                              })}\n\n                              <div className=\"pt-3 border-t border-blue-100 flex justify-end\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => addConditionToGroup(groupIdx)}\n                                  className=\"flex items-center px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all text-sm font-medium\"\n                                >\n                                  <Plus className=\"w-4 h-4 mr-1\" />\n                                  Ajouter une condition\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n          {/* Ã‰quipes Ã  dÃ©clencher */}\n          <div>\n            <h3 className=\"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2\">\n              <Users className=\"w-5 h-5 text-blue-500\" />\n              Ã‰quipes compliance Ã  dÃ©clencher\n            </h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              {teams.map(team => (\n                <button\n                  key={team.id}\n                  onClick={() => toggleTeam(team.id)}\n                  className={`p-4 rounded-lg border-2 text-left transition-all ${\n                    editedRule.teams.includes(team.id)\n                      ? 'border-blue-600 bg-blue-50'\n                      : 'border-gray-200 hover:border-blue-300'\n                  }`}\n                >\n                  <div className=\"flex items-center\">\n                    <div className={`w-5 h-5 rounded border-2 mr-3 flex items-center justify-center ${\n                      editedRule.teams.includes(team.id)\n                        ? 'border-blue-600 bg-blue-600 text-white'\n                        : 'border-gray-300'\n                    }`}>\n                      {editedRule.teams.includes(team.id) && (\n                        <CheckCircle className=\"w-4 h-4\" />\n                      )}\n                    </div>\n                    <div>\n                      <div className=\"font-semibold text-gray-800\">{team.name}</div>\n                    </div>\n                  </div>\n                </button>\n              ))}\n            </div>\n          </div>\n\n          {/* Questions par Ã©quipe */}\n          <div>\n            <h3 className=\"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2\">\n              <FileText className=\"w-5 h-5 text-blue-500\" />\n              Questions Ã  prÃ©parer par Ã©quipe\n            </h3>\n            {editedRule.teams.length === 0 ? (\n              <div className=\"text-sm text-gray-500 italic\">\n                SÃ©lectionnez au moins une Ã©quipe pour dÃ©finir les questions.\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {editedRule.teams.map(teamId => (\n                  <div key={teamId} className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\n                    <div className=\"flex justify-between items-center mb-3\">\n                      <h4 className=\"text-sm font-semibold text-gray-700\">\n                        {teams.find(team => team.id === teamId)?.name || teamId}\n                      </h4>\n                      <button\n                        onClick={() => addQuestionForTeam(teamId)}\n                        className=\"flex items-center px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all\"\n                      >\n                        <Plus className=\"w-3 h-3 mr-1\" />\n                        Ajouter une question\n                      </button>\n                    </div>\n                    {(editedRule.questions[teamId] || []).length > 0 ? (\n                      <div className=\"space-y-2\">\n                        {(editedRule.questions[teamId] || []).map((questionEntry, idx) => {\n                          const sanitizedEntry = sanitizeTeamQuestionEntry(questionEntry);\n                          const timingConstraint = sanitizeRiskTimingConstraint(\n                            sanitizedEntry.timingConstraint\n                          );\n                          const hasDateQuestions = dateQuestions.length >= 2;\n                          const toggleDisabled = !hasDateQuestions && !timingConstraint.enabled;\n                          const isToggleChecked = Boolean(timingConstraint.enabled);\n\n                          return (\n                            <div key={idx} className=\"border border-gray-200 rounded-lg p-3 bg-white space-y-3\">\n                              <div className=\"flex items-center space-x-2\">\n                                <input\n                                  type=\"text\"\n                                  value={sanitizedEntry.text}\n                                  onChange={(e) => updateTeamQuestion(teamId, idx, e.target.value)}\n                                  className=\"flex-1 px-3 py-2 border border-gray-300 rounded text-sm\"\n                                  placeholder=\"Question pour l'Ã©quipe...\"\n                                />\n                                <button\n                                  onClick={() => deleteTeamQuestion(teamId, idx)}\n                                  className=\"p-2 text-red-600 hover:bg-red-50 rounded transition-all\"\n                                  aria-label=\"Supprimer la question\"\n                                >\n                                  <Trash2 className=\"w-4 h-4\" />\n                                </button>\n                              </div>\n\n                              <div className=\"border-t border-gray-100 pt-3\">\n                                <div className=\"flex items-center justify-between gap-3\">\n                                  <div>\n                                    <p className=\"text-xs font-medium text-gray-600\">\n                                      Associer au non-respect d'un dÃ©lai minimum\n                                    </p>\n                                    <p className=\"text-xs text-gray-500 leading-snug\">\n                                      Utilise deux questions de type Â« date Â» pour vÃ©rifier le dÃ©lai rÃ©el.\n                                    </p>\n                                  </div>\n                                  <label\n                                    className={`inline-flex items-center gap-2 text-xs font-medium ${\n                                      toggleDisabled ? 'text-gray-400' : 'text-gray-700'\n                                    }`}\n                                  >\n                                    <input\n                                      type=\"checkbox\"\n                                      className=\"rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                      checked={isToggleChecked}\n                                      onChange={(event) =>\n                                        updateTeamQuestionTiming(teamId, idx, { enabled: event.target.checked })\n                                      }\n                                      disabled={toggleDisabled}\n                                    />\n                                    <span>{isToggleChecked ? 'ActivÃ©' : 'DÃ©sactivÃ©'}</span>\n                                  </label>\n                                </div>\n\n                                {!hasDateQuestions ? (\n                                  <p className=\"mt-2 text-xs text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-lg px-3 py-2\">\n                                    Ajoutez au moins deux questions de type date pour pouvoir contrÃ´ler un dÃ©lai minimum.\n                                  </p>\n                                ) : isToggleChecked ? (\n                                  <div className=\"mt-3 space-y-3\">\n                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                      <div>\n                                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date de dÃ©part</label>\n                                        <select\n                                          value={timingConstraint.startQuestion}\n                                          onChange={(e) =>\n                                            updateTeamQuestionTiming(teamId, idx, { startQuestion: e.target.value })\n                                          }\n                                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                        >\n                                          <option value=\"\">SÃ©lectionner...</option>\n                                          {dateQuestions.map(question => (\n                                            <option key={question.id} value={question.id}>\n                                              {question.id} â€“ {question.question || 'Question sans intitulÃ©'}\n                                            </option>\n                                          ))}\n                                        </select>\n                                      </div>\n                                      <div>\n                                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date de fin</label>\n                                        <select\n                                          value={timingConstraint.endQuestion}\n                                          onChange={(e) =>\n                                            updateTeamQuestionTiming(teamId, idx, { endQuestion: e.target.value })\n                                          }\n                                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                        >\n                                          <option value=\"\">SÃ©lectionner...</option>\n                                          {dateQuestions.map(question => (\n                                            <option key={question.id} value={question.id}>\n                                              {question.id} â€“ {question.question || 'Question sans intitulÃ©'}\n                                            </option>\n                                          ))}\n                                        </select>\n                                      </div>\n                                    </div>\n\n                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                      <div>\n                                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Minimum (semaines)</label>\n                                        <input\n                                          type=\"number\"\n                                          min=\"0\"\n                                          step=\"0.1\"\n                                          value={timingConstraint.minimumWeeks ?? ''}\n                                          onChange={(e) => {\n                                            const rawValue = e.target.value;\n                                            updateTeamQuestionTiming(teamId, idx, {\n                                              minimumWeeks: rawValue === '' ? undefined : Number(rawValue)\n                                            });\n                                          }}\n                                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                          placeholder=\"Ex: 4\"\n                                        />\n                                      </div>\n                                      <div>\n                                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Minimum (jours)</label>\n                                        <input\n                                          type=\"number\"\n                                          min=\"0\"\n                                          step=\"1\"\n                                          value={timingConstraint.minimumDays ?? ''}\n                                          onChange={(e) => {\n                                            const rawValue = e.target.value;\n                                            updateTeamQuestionTiming(teamId, idx, {\n                                              minimumDays: rawValue === '' ? undefined : Number(rawValue)\n                                            });\n                                          }}\n                                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                          placeholder=\"Ex: 90\"\n                                        />\n                                      </div>\n                                    </div>\n\n                                    <p className=\"text-[11px] text-gray-500\">\n                                      La question sera affichÃ©e uniquement si le dÃ©lai constatÃ© est infÃ©rieur au minimum dÃ©fini.\n                                    </p>\n                                  </div>\n                                ) : null}\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    ) : (\n                      <p className=\"text-sm text-gray-500 italic\">Aucune question dÃ©finie</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Risques */}\n          <div>\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n                <AlertTriangle className=\"w-5 h-5 text-red-500\" />\n                Risques associÃ©s\n              </h3>\n              <button\n                onClick={addRisk}\n                className=\"flex items-center px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all text-sm font-medium\"\n              >\n                <Plus className=\"w-4 h-4 mr-1\" />\n                Ajouter un risque\n              </button>\n            </div>\n\n            {editedRule.risks.length === 0 ? (\n              <div className=\"text-sm text-gray-500 italic\">\n                Aucun risque dÃ©fini pour cette rÃ¨gle.\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {editedRule.risks.map((risk, idx) => {\n                  const timingConstraint = sanitizeRiskTimingConstraint(risk.timingConstraint);\n                  const hasDateQuestions = dateQuestions.length >= 2;\n                  const toggleDisabled = !hasDateQuestions && !timingConstraint.enabled;\n                  const isToggleChecked = Boolean(timingConstraint.enabled);\n\n                  return (\n                    <div key={idx} className=\"bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4 border border-red-200\">\n                      <div className=\"flex items-center mb-3\">\n                        <span className=\"text-sm font-semibold text-gray-700\">Risque {idx + 1}</span>\n                        <button\n                          onClick={() => deleteRisk(idx)}\n                          className=\"p-1 text-red-600 hover:bg-red-50 rounded transition-all ml-auto\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n\n                      <div className=\"space-y-3\">\n                        <div>\n                          <label className=\"block text-xs font-medium text-gray-600 mb-1\">Description du risque</label>\n                          <input\n                            type=\"text\"\n                            value={risk.description}\n                            onChange={(e) => updateRisk(idx, 'description', e.target.value)}\n                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                            placeholder=\"Ex: Non-conformitÃ© RGPD sur les donnÃ©es de santÃ©\"\n                          />\n                        </div>\n\n                        <div>\n                          <label className=\"block text-xs font-medium text-gray-600 mb-1\">Ã‰quipe rÃ©fÃ©rente</label>\n                          <select\n                            value={risk.teamId}\n                            onChange={(e) => updateRisk(idx, 'teamId', e.target.value)}\n                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                            disabled={editedRule.teams.length === 0}\n                          >\n                            {editedRule.teams.length === 0 ? (\n                              <option value=\"\">Aucune Ã©quipe disponible</option>\n                            ) : (\n                              <>\n                                {editedRule.teams.map(teamId => (\n                                  <option key={teamId} value={teamId}>\n                                    {teams.find(team => team.id === teamId)?.name || teamId}\n                                  </option>\n                                ))}\n                              </>\n                            )}\n                          </select>\n                          {editedRule.teams.length === 0 && (\n                            <p className=\"text-xs text-gray-500 mt-1 italic\">\n                              SÃ©lectionnez une Ã©quipe dans la section prÃ©cÃ©dente pour associer ce risque.\n                            </p>\n                          )}\n                        </div>\n\n                      <div>\n                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Niveau de criticitÃ©</label>\n                        <select\n                          value={risk.level}\n                          onChange={(e) => updateRisk(idx, 'level', e.target.value)}\n                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                        >\n                          <option value=\"Faible\">Faible (niveau vert)</option>\n                          <option value=\"Moyen\">Moyen (niveau orange)</option>\n                          <option value=\"Ã‰levÃ©\">Ã‰levÃ© (niveau rouge)</option>\n                        </select>\n                      </div>\n\n                      <div>\n                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">PrioritÃ© du risque</label>\n                        <select\n                          value={risk.priority}\n                          onChange={(e) => updateRisk(idx, 'priority', e.target.value)}\n                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                        >\n                          {RISK_PRIORITY_OPTIONS.map(option => (\n                            <option key={option} value={option}>\n                              {option}\n                            </option>\n                          ))}\n                        </select>\n                      </div>\n\n                      <div>\n                        <label className=\"block text-xs font-medium text-gray-600 mb-1\">Actions de mitigation</label>\n                        <textarea\n                          value={risk.mitigation}\n                          onChange={(e) => updateRisk(idx, 'mitigation', e.target.value)}\n                          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                          rows=\"2\"\n                          placeholder=\"Ex: RÃ©aliser une DPIA et hÃ©berger sur un serveur HDS\"\n                        />\n                      </div>\n\n                      <div className=\"border-t border-red-100 pt-3\">\n                        <div className=\"flex items-center justify-between gap-3\">\n                          <div>\n                            <p className=\"text-xs font-medium text-gray-600\">\n                              Associer au non-respect d'un dÃ©lai minimum\n                            </p>\n                            <p className=\"text-xs text-gray-500 leading-snug\">\n                              Utilise deux questions de type Â« date Â» pour vÃ©rifier le dÃ©lai rÃ©el.\n                            </p>\n                          </div>\n                          <label className={`inline-flex items-center gap-2 text-xs font-medium ${toggleDisabled ? 'text-gray-400' : 'text-gray-700'}`}>\n                            <input\n                              type=\"checkbox\"\n                              className=\"rounded border-gray-300 text-red-500 focus:ring-red-400\"\n                              checked={isToggleChecked}\n                              onChange={(event) => updateRiskTimingConstraint(idx, { enabled: event.target.checked })}\n                              disabled={toggleDisabled}\n                            />\n                            <span>{isToggleChecked ? 'ActivÃ©' : 'DÃ©sactivÃ©'}</span>\n                          </label>\n                        </div>\n\n                        {!hasDateQuestions ? (\n                          <p className=\"mt-2 text-xs text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2\">\n                            Ajoutez au moins deux questions de type date pour pouvoir contrÃ´ler un dÃ©lai minimum.\n                          </p>\n                        ) : isToggleChecked ? (\n                          <div className=\"mt-3 space-y-3\">\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div>\n                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date de dÃ©part</label>\n                                <select\n                                  value={timingConstraint.startQuestion}\n                                  onChange={(e) => updateRiskTimingConstraint(idx, { startQuestion: e.target.value })}\n                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                >\n                                  <option value=\"\">SÃ©lectionner...</option>\n                                  {dateQuestions.map(question => (\n                                    <option key={question.id} value={question.id}>\n                                      {question.id} â€“ {question.question || 'Question sans intitulÃ©'}\n                                    </option>\n                                  ))}\n                                </select>\n                              </div>\n                              <div>\n                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Date de fin</label>\n                                <select\n                                  value={timingConstraint.endQuestion}\n                                  onChange={(e) => updateRiskTimingConstraint(idx, { endQuestion: e.target.value })}\n                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                >\n                                  <option value=\"\">SÃ©lectionner...</option>\n                                  {dateQuestions.map(question => (\n                                    <option key={question.id} value={question.id}>\n                                      {question.id} â€“ {question.question || 'Question sans intitulÃ©'}\n                                    </option>\n                                  ))}\n                                </select>\n                              </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div>\n                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Minimum (semaines)</label>\n                                <input\n                                  type=\"number\"\n                                  min=\"0\"\n                                  step=\"0.1\"\n                                  value={timingConstraint.minimumWeeks ?? ''}\n                                  onChange={(e) => {\n                                    const rawValue = e.target.value;\n                                    updateRiskTimingConstraint(idx, { minimumWeeks: rawValue === '' ? undefined : Number(rawValue) });\n                                  }}\n                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                  placeholder=\"Ex: 4\"\n                                />\n                              </div>\n                              <div>\n                                <label className=\"block text-xs font-medium text-gray-600 mb-1\">Minimum (jours)</label>\n                                <input\n                                  type=\"number\"\n                                  min=\"0\"\n                                  step=\"1\"\n                                  value={timingConstraint.minimumDays ?? ''}\n                                  onChange={(e) => {\n                                    const rawValue = e.target.value;\n                                    updateRiskTimingConstraint(idx, { minimumDays: rawValue === '' ? undefined : Number(rawValue) });\n                                  }}\n                                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500\"\n                                  placeholder=\"Ex: 90\"\n                                />\n                              </div>\n                            </div>\n\n                            <p className=\"text-[11px] text-gray-500\">\n                              Le risque sera signalÃ© si le dÃ©lai rÃ©el est infÃ©rieur Ã  l'un des minimums renseignÃ©s.\n                            </p>\n                          </div>\n                        ) : null}\n                      </div>\n                    </div>\n                  </div>\n                  );\n                })}\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n",
  "src/components/SynthesisReport.jsx": "import React, { useState, useCallback, useEffect, useRef, useMemo } from '../react.js';\nimport {\n  FileText,\n  Users,\n  AlertTriangle,\n  Send,\n  Sparkles,\n  CheckCircle,\n  Save,\n  Mail,\n  Info,\n  Edit\n} from './icons.js';\nimport { formatAnswer } from '../utils/questions.js';\nimport { computeRankingRecommendations, normalizeRankingConfig } from '../utils/ranking.js';\nimport { renderTextWithLinks } from '../utils/linkify.js';\nimport { ProjectShowcase } from './ProjectShowcase.jsx';\nimport { extractProjectName } from '../utils/projects.js';\nimport {\n  buildProjectExport,\n  downloadProjectJson,\n  getTeamPriority,\n  sanitizeFileName\n} from '../utils/projectExport.js';\nimport {\n  DEFAULT_COMMITTEE_ID,\n  getTriggeredValidationCommittees,\n  normalizeValidationCommitteeConfig\n} from '../utils/validationCommittee.js';\nimport { formatTeamContacts, normalizeTeamContacts } from '../utils/teamContacts.js';\n\nconst escapeHtml = (value) => {\n  if (value === null || value === undefined) {\n    return '';\n  }\n\n  return String(value)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n};\n\nconst formatNumber = (value, options = {}) => {\n  return Number(value).toLocaleString('fr-FR', options);\n};\n\nconst normalizeEmail = (value) => (typeof value === 'string' ? value.trim().toLowerCase() : '');\n\nconst formatTimestamp = (value) => {\n  if (!value) {\n    return '';\n  }\n\n  try {\n    return new Date(value).toLocaleString('fr-FR', {\n      day: '2-digit',\n      month: 'short',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  } catch (error) {\n    return '';\n  }\n};\n\nconst formatCriterionScore = (value) => {\n  const numeric = Number(value);\n  if (!Number.isFinite(numeric)) {\n    return 'â€”';\n  }\n\n  if (numeric >= 3) return '+++';\n  if (numeric >= 2) return '++';\n  if (numeric >= 1) return '+';\n  return 'â€”';\n};\n\nconst COMPLIANCE_COMMENTS_KEY = '__compliance_team_comments__';\nconst COMMENT_STATUS_OPTIONS = [\n  {\n    value: 'validated',\n    label: 'ValidÃ©',\n    badgeClass: 'bg-emerald-100 text-emerald-800 border-emerald-200'\n  },\n  {\n    value: 'validated_with_conditions',\n    label: 'ValidÃ© sous conditions',\n    badgeClass: 'bg-amber-100 text-amber-800 border-amber-200'\n  },\n  {\n    value: 'pending_information',\n    label: \"En attente d'informations\",\n    badgeClass: 'bg-blue-100 text-blue-800 border-blue-200'\n  },\n  {\n    value: 'not_concerned',\n    label: 'Non-concernÃ©',\n    badgeClass: 'bg-gray-100 text-gray-700 border-gray-200'\n  },\n  {\n    value: 'rejected',\n    label: 'RefusÃ©',\n    badgeClass: 'bg-red-100 text-red-800 border-red-200'\n  }\n];\n\nconst formatWeeksValue = (weeks) => {\n  if (weeks === undefined || weeks === null) {\n    return '-';\n  }\n\n  const rounded = Math.round(weeks * 10) / 10;\n  const hasDecimal = Math.abs(rounded - Math.round(rounded)) > 0.0001;\n\n  return `${formatNumber(rounded, {\n    minimumFractionDigits: hasDecimal ? 1 : 0,\n    maximumFractionDigits: hasDecimal ? 1 : 0\n  })} sem.`;\n};\n\nconst formatDaysValue = (days) => {\n  if (days === undefined || days === null) {\n    return '-';\n  }\n\n  return `${formatNumber(Math.round(days))} j.`;\n};\n\nconst formatRiskScore = (score) => {\n  if (typeof score !== 'number' || Number.isNaN(score)) {\n    return null;\n  }\n\n  const sanitized = Math.max(0, score);\n  const hasDecimals = Math.abs(sanitized - Math.round(sanitized)) > 0.0001;\n\n  return formatNumber(sanitized, {\n    minimumFractionDigits: hasDecimals ? 1 : 0,\n    maximumFractionDigits: hasDecimals ? 2 : 0\n  });\n};\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nconst getCommentStatusMeta = (status) =>\n  COMMENT_STATUS_OPTIONS.find((option) => option.value === status) || null;\n\nconst normalizeCommentEntry = (entry) => {\n  const comment = typeof entry?.comment === 'string' ? entry.comment : '';\n  const statusCandidate = typeof entry?.status === 'string' ? entry.status : '';\n  const status = COMMENT_STATUS_OPTIONS.some((option) => option.value === statusCandidate)\n    ? statusCandidate\n    : '';\n  const replies = Array.isArray(entry?.replies)\n    ? entry.replies\n        .map((reply, index) => ({\n          id: typeof reply?.id === 'string' && reply.id.trim().length > 0\n            ? reply.id\n            : `reply-${index}`,\n          message: typeof reply?.message === 'string' ? reply.message : '',\n          authorName: typeof reply?.authorName === 'string' ? reply.authorName : '',\n          authorEmail: typeof reply?.authorEmail === 'string' ? reply.authorEmail : '',\n          createdAt: typeof reply?.createdAt === 'string' ? reply.createdAt : ''\n        }))\n        .filter((reply) => reply.message.trim().length > 0 || reply.authorName || reply.authorEmail)\n    : [];\n\n  return {\n    comment,\n    status,\n    replies\n  };\n};\n\nconst normalizeComplianceComments = (value) => {\n  if (value && typeof value === 'object' && !Array.isArray(value)) {\n    const teams = value.teams && typeof value.teams === 'object' ? value.teams : {};\n    const committees =\n      value.committees && typeof value.committees === 'object' ? value.committees : {};\n    const legacyCommittee =\n      value.committee && typeof value.committee === 'object' ? value.committee : null;\n\n    return {\n      teams,\n      committees: legacyCommittee && !committees[DEFAULT_COMMITTEE_ID]\n        ? {\n          ...committees,\n          [DEFAULT_COMMITTEE_ID]: legacyCommittee\n        }\n        : committees,\n      legacy: typeof value.legacy === 'string' ? value.legacy : ''\n    };\n  }\n\n  if (typeof value === 'string') {\n    return {\n      teams: {},\n      committees: {},\n      legacy: value\n    };\n  }\n\n  return {\n    teams: {},\n    committees: {},\n    legacy: ''\n  };\n};\n\nconst buildComplianceCommentDrafts = (comments, teams, committees) => {\n  const teamDrafts = {};\n  const committeeDrafts = {};\n\n  (Array.isArray(teams) ? teams : []).forEach((team) => {\n    if (!team?.id) {\n      return;\n    }\n    teamDrafts[team.id] = normalizeCommentEntry(comments?.teams?.[team.id]);\n  });\n\n  (Array.isArray(committees) ? committees : []).forEach((committee) => {\n    if (!committee?.id) {\n      return;\n    }\n    committeeDrafts[committee.id] = normalizeCommentEntry(comments?.committees?.[committee.id]);\n  });\n\n  return {\n    teams: teamDrafts,\n    committees: committeeDrafts\n  };\n};\n\nconst MISSING_INFO_LABEL = 'Information Ã  complÃ©ter';\n\nconst formatOverviewValue = (question, answer) => {\n  const formatted = formatAnswer(question, answer);\n\n  if (typeof formatted === 'string') {\n    if (formatted.trim().length > 0) {\n      return formatted;\n    }\n  } else if (formatted) {\n    return formatted;\n  }\n\n  return question?.required ? MISSING_INFO_LABEL : '';\n};\n\nconst formatRiskTimingViolation = (violation) => {\n  if (!violation) {\n    return '';\n  }\n\n  const actualParts = [];\n  if (typeof violation.actualWeeks === 'number') {\n    actualParts.push(formatWeeksValue(violation.actualWeeks));\n  }\n  if (typeof violation.actualDays === 'number') {\n    actualParts.push(formatDaysValue(violation.actualDays));\n  }\n\n  const requiredParts = [];\n  if (typeof violation.requiredWeeks === 'number') {\n    requiredParts.push(`${formatNumber(violation.requiredWeeks)} sem.`);\n  }\n  if (typeof violation.requiredDays === 'number') {\n    requiredParts.push(`${formatNumber(violation.requiredDays)} j.`);\n  }\n\n  if (actualParts.length === 0 && requiredParts.length === 0) {\n    return '';\n  }\n\n  const actualText = actualParts.length > 0 ? actualParts.join(' / ') : 'non calculÃ©';\n\n  if (requiredParts.length === 0) {\n    return `DÃ©lai constatÃ© : ${actualText}.`;\n  }\n\n  return `DÃ©lai constatÃ© : ${actualText} â€“ minimum requis : ${requiredParts.join(' / ')}`;\n};\n\nconst formatTimingRequirementSummary = (questionBank, constraint) => {\n  if (!constraint || typeof constraint !== 'object') {\n    return '';\n  }\n\n  const startId = constraint.startQuestion;\n  const endId = constraint.endQuestion;\n  const minimumWeeks =\n    typeof constraint.minimumWeeks === 'number' ? constraint.minimumWeeks : undefined;\n  const minimumDays =\n    typeof constraint.minimumDays === 'number' ? constraint.minimumDays : undefined;\n\n  const startLabel = resolveQuestionLabel(questionBank, startId);\n  const endLabel = resolveQuestionLabel(questionBank, endId);\n\n  const startDisplay = startLabel || startId || '';\n  const endDisplay = endLabel || endId || '';\n\n  const requirementParts = [];\n  if (minimumWeeks !== undefined) {\n    requirementParts.push(`${formatNumber(minimumWeeks)} sem.`);\n  }\n  if (minimumDays !== undefined) {\n    requirementParts.push(`${formatNumber(minimumDays)} j.`);\n  }\n\n  const hasRequirement = requirementParts.length > 0;\n  const hasStart = startDisplay.length > 0;\n  const hasEnd = endDisplay.length > 0;\n\n  if (!hasRequirement && !hasStart && !hasEnd) {\n    return '';\n  }\n\n  if (hasRequirement && hasStart && hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} entre Â« ${startDisplay} Â» et Â« ${endDisplay} Â».`;\n  }\n\n  if (hasRequirement && hasStart && !hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} aprÃ¨s Â« ${startDisplay} Â».`;\n  }\n\n  if (hasRequirement && !hasStart && hasEnd) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} avant Â« ${endDisplay} Â».`;\n  }\n\n  if (hasRequirement) {\n    return `Respecter un dÃ©lai minimal de ${requirementParts.join(' / ')} avant la prochaine Ã©tape.`;\n  }\n\n  if (hasStart && hasEnd) {\n    return `Surveiller le dÃ©lai entre Â« ${startDisplay} Â» et Â« ${endDisplay} Â».`;\n  }\n\n  if (hasStart || hasEnd) {\n    return `Surveiller la date Â« ${hasStart ? startDisplay : endDisplay} Â».`;\n  }\n\n  return '';\n};\n\nconst formatVigilanceStatusMessage = (alert) => {\n  if (!alert || typeof alert !== 'object') {\n    return '';\n  }\n\n  if (alert.status === 'unknown') {\n    return \"Dates manquantes : renseignez-les pour vÃ©rifier ce dÃ©lai.\";\n  }\n\n  if (alert.status === 'satisfied' && alert.diff) {\n    const parts = [];\n    if (typeof alert.diff.diffInWeeks === 'number') {\n      parts.push(formatWeeksValue(alert.diff.diffInWeeks));\n    }\n    if (typeof alert.diff.diffInDays === 'number') {\n      parts.push(formatDaysValue(alert.diff.diffInDays));\n    }\n\n    if (parts.length === 0) {\n      return 'DÃ©lai dÃ©clarÃ© conforme. Anticiper pour Ã©viter lâ€™alerte.';\n    }\n\n    return `DÃ©lai constatÃ© : ${parts.join(' / ')} â€” anticiper pour Ã©viter lâ€™alerte.`;\n  }\n\n  return '';\n};\n\nconst resolveQuestionLabel = (questionBank, questionId) => {\n  if (!questionId) {\n    return '';\n  }\n\n  const collection = Array.isArray(questionBank) ? questionBank : [];\n  const match = collection.find(question => question?.id === questionId);\n\n  return match?.question || questionId;\n};\n\nconst normalizeTeamQuestionForDisplay = (entry) => {\n  if (typeof entry === 'string') {\n    return { text: entry, timingViolation: null };\n  }\n\n  if (entry && typeof entry === 'object') {\n    return {\n      text: typeof entry.text === 'string' ? entry.text : '',\n      timingViolation:\n        entry.timingViolation && typeof entry.timingViolation === 'object'\n          ? entry.timingViolation\n          : null\n    };\n  }\n\n  return { text: '', timingViolation: null };\n};\n\nconst formatTeamQuestionTimingMessage = (questionBank, violation) => {\n  if (!violation) {\n    return '';\n  }\n\n  const base = formatRiskTimingViolation(violation);\n  if (!base) {\n    return '';\n  }\n\n  const startLabel = resolveQuestionLabel(questionBank, violation.startQuestion);\n  const endLabel = resolveQuestionLabel(questionBank, violation.endQuestion);\n\n  if (startLabel || endLabel) {\n    const safeStart = startLabel || violation.startQuestion || 'dÃ©but';\n    const safeEnd = endLabel || violation.endQuestion || 'fin';\n    return `DÃ©lai entre Â« ${safeStart} Â» et Â« ${safeEnd} Â» â€” ${base}`;\n  }\n\n  return base;\n};\n\nconst formatAsHtmlText = (value) => {\n  return escapeHtml(value).replace(/\\r?\\n/g, '<br />');\n};\n\nconst buildEmailHtml = ({\n  projectName,\n  questions,\n  answers,\n  analysis,\n  relevantTeams\n}) => {\n  const title = projectName || 'Projet sans nom';\n  const answeredQuestions = questions.filter(question => {\n    const value = answers[question.id];\n    if (value === null || value === undefined) {\n      return false;\n    }\n\n    if (Array.isArray(value)) {\n      return value.length > 0;\n    }\n\n    if (typeof value === 'string') {\n      return value.trim().length > 0;\n    }\n\n    return true;\n  });\n\n  const risks = Array.isArray(analysis?.risks) ? analysis.risks : [];\n  const vigilanceAlerts = Array.isArray(analysis?.timeline?.vigilance)\n    ? analysis.timeline.vigilance.filter(alert => alert && alert.status !== 'breach')\n    : [];\n\n  const overviewSection = answeredQuestions.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Vue d'ensemble du projet\n          </h2>\n          <table style=\"width:100%; border-collapse:collapse; background-color:#f9fafb; border-radius:12px; overflow:hidden;\">\n            <tbody>\n              ${answeredQuestions\n                .map(question => {\n                  const questionLabel = escapeHtml(question.question);\n                  const formattedAnswer = formatAsHtmlText(formatAnswer(question, answers[question.id]));\n                  return `\n                    <tr>\n                      <td style=\"width:40%; padding:12px 16px; font-size:13px; font-weight:700; color:#001f3f; border-bottom:1px solid #e5e7eb;\">\n                        ${questionLabel}\n                      </td>\n                      <td style=\"padding:12px 16px; font-size:14px; font-weight:600; color:#1f2937; border-bottom:1px solid #e5e7eb;\">\n                        ${formattedAnswer || '<span style=\"color:#9ca3af;\">Non renseignÃ©</span>'}\n                      </td>\n                    </tr>\n                  `;\n                })\n                .join('')}\n            </tbody>\n          </table>\n        </div>\n      `\n    : '';\n\n  const teamSection = relevantTeams.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Ã‰quipes Ã  mobiliser\n          </h2>\n          ${relevantTeams\n            .map(team => {\n              const teamPriority = getTeamPriority(analysis, team.id);\n              const teamQuestions = analysis.questions?.[team.id] || [];\n              const teamContactLabel = formatTeamContacts(team, ', ');\n              const contact = teamContactLabel\n                ? `<span style=\"color:#4b5563;\"> | Contacts : ${escapeHtml(teamContactLabel)}</span>`\n                : '';\n\n              const formattedTeamQuestions = Array.isArray(teamQuestions)\n                ? teamQuestions\n                    .map(normalizeTeamQuestionForDisplay)\n                    .filter(question => (question.text || '').trim().length > 0)\n                : [];\n\n              const questionsHtml = formattedTeamQuestions.length\n                ? `\n                    <div style=\"margin-top:8px;\">\n                      <span style=\"font-size:13px; color:#4b5563; font-weight:600;\">Points Ã  prÃ©parer :</span>\n                      <ul style=\"margin:8px 0 0; padding-left:18px; list-style-type:disc; color:#4b5563; font-size:13px;\">\n                        ${formattedTeamQuestions\n                          .map(question => {\n                            const timingMessage = formatTeamQuestionTimingMessage(questions, question.timingViolation);\n                            const timingHtml = timingMessage\n                              ? `<div style=\"margin-top:4px; font-size:12px; color:#b45309;\">âš ï¸ ${escapeHtml(timingMessage)}</div>`\n                              : '';\n                            return `<li>${escapeHtml(question.text)}${timingHtml}</li>`;\n                          })\n                          .join('')}\n                      </ul>\n                    </div>\n                  `\n                : '';\n\n              return `\n                <div style=\"border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#f9fafb;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#1f2937;\">\n                    ${escapeHtml(team.name)} â€” PrioritÃ© : ${escapeHtml(teamPriority)}${contact}\n                  </div>\n                  ${questionsHtml}\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  const riskSection = risks.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Risques identifiÃ©s et actions\n          </h2>\n          ${risks\n            .map(risk => {\n              const timingInfo = formatRiskTimingViolation(risk.timingViolation);\n\n              return `\n                <div style=\"border:1px solid #fee2e2; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#fef2f2;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#b91c1c;\">\n                    ${escapeHtml(risk.level)} â€” PrioritÃ© : ${escapeHtml(risk.priority)}\n                  </div>\n                  <p style=\"margin:8px 0 4px; font-size:14px; color:#4b5563;\">\n                    <strong>Description :</strong> ${formatAsHtmlText(risk.description)}\n                  </p>\n                  ${timingInfo\n                    ? `<p style=\"margin:0 0 6px; font-size:13px; color:#b91c1c;\">${escapeHtml(timingInfo)}</p>`\n                    : ''}\n                  <p style=\"margin:0; font-size:14px; color:#4b5563;\">\n                    <strong>Mitigation :</strong> ${formatAsHtmlText(risk.mitigation)}\n                  </p>\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  const vigilanceSection = vigilanceAlerts.length\n    ? `\n        <div style=\"margin-bottom:24px;\">\n          <h2 style=\"font-size:18px; font-weight:600; color:#1f2937; margin-bottom:12px;\">\n            Points de vigilance\n          </h2>\n          ${vigilanceAlerts\n            .map(alert => {\n              const requirementSummary = formatTimingRequirementSummary(questions, alert.timingConstraint);\n              const statusMessage = formatVigilanceStatusMessage(alert);\n              const title = alert.riskDescription && alert.riskDescription.trim().length > 0\n                ? alert.riskDescription\n                : alert.ruleName;\n\n              return `\n                <div style=\"border:1px solid #bbf7d0; border-radius:12px; padding:16px; margin-bottom:12px; background-color:#ecfdf5;\">\n                  <div style=\"font-size:15px; font-weight:600; color:#047857;\">\n                    ${escapeHtml(alert.ruleName)}${alert.priority ? ` â€” PrioritÃ© : ${escapeHtml(alert.priority)}` : ''}\n                  </div>\n                  <p style=\"margin:8px 0 4px; font-size:14px; color:#064e3b; font-weight:600;\">\n                    ${formatAsHtmlText(title)}\n                  </p>\n                  ${requirementSummary\n                    ? `<p style=\"margin:0 0 6px; font-size:13px; color:#047857;\">${escapeHtml(requirementSummary)}</p>`\n                    : ''}\n                  ${statusMessage\n                    ? `<p style=\"margin:0; font-size:12px; color:#1f2937;\">${escapeHtml(statusMessage)}</p>`\n                    : ''}\n                </div>\n              `;\n            })\n            .join('')}\n        </div>\n      `\n    : '';\n\n  return `<!DOCTYPE html>\n    <html lang=\"fr\">\n      <head>\n        <meta charset=\"UTF-8\" />\n        <title>${escapeHtml(title)}</title>\n      </head>\n      <body style=\"margin:0; padding:0; background-color:#f3f4f6; font-family:'Segoe UI', Arial, sans-serif; color:#1f2937;\">\n        <div style=\"max-width:720px; margin:0 auto; padding:32px 24px;\">\n          <div style=\"background-color:#ffffff; border-radius:20px; padding:32px; box-shadow:0 10px 30px rgba(15, 23, 42, 0.08); border:1px solid #e5e7eb;\">\n            <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;\">\n              <div>\n                <h1 style=\"font-size:24px; color:#111827; margin:0 0 6px;\">SynthÃ¨se</h1>\n                <p style=\"margin:0; color:#4b5563; font-size:14px;\">${escapeHtml(title)}</p>\n              </div>\n              <div style=\"padding:10px 16px; background-color:#eff6ff; color:#1d4ed8; border-radius:9999px; font-weight:600; font-size:14px;\">\n                ComplexitÃ© : ${escapeHtml(analysis.complexity)}\n              </div>\n            </div>\n            <p style=\"margin:0 0 20px; font-size:14px; color:#1f2937;\">\n              Bonjour Ã©quipe Compliance, un nouveau projet a Ã©tÃ© soumis pour revue. Vous trouverez ci-dessous les informations principales.\n            </p>\n            ${overviewSection}\n            ${teamSection}\n            ${riskSection}\n            ${vigilanceSection}\n          </div>\n        </div>\n      </body>\n    </html>`;\n};\n\nconst decodeHtmlEntities = (text) =>\n  text\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\");\n\nconst buildPlainTextEmail = (html) => {\n  if (!html) {\n    return '';\n  }\n\n  let text = html\n    .replace(/<!DOCTYPE[^>]*>/gi, '')\n    .replace(/<head[\\s\\S]*?<\\/head>/gi, '')\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, '')\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, '');\n\n  text = text\n    .replace(/<br\\s*\\/?\\s*>/gi, '\\n')\n    .replace(/<\\/(?:p|div|section|article)\\s*>/gi, '\\n\\n')\n    .replace(/<\\/(?:h[1-6])\\s*>/gi, '\\n')\n    .replace(/<\\/(?:ul|ol)\\s*>/gi, '\\n')\n    .replace(/<li\\s*>/gi, 'â€¢ ')\n    .replace(/<\\/(?:tr)\\s*>/gi, '\\n')\n    .replace(/<\\/(?:td|th)\\s*>/gi, '\\t');\n\n  text = text.replace(/<[^>]+>/g, '');\n  text = decodeHtmlEntities(text);\n\n  text = text\n    .replace(/\\r/g, '')\n    .replace(/\\t+/g, ' ')\n    .replace(/[ \\t]+\\n/g, '\\n')\n    .replace(/\\n[ \\t]+/g, '\\n')\n    .replace(/\\n{3,}/g, '\\n\\n');\n\n  return text.trim();\n};\n\nconst normalizeRecipients = (recipients) => {\n  const uniqueRecipients = new Map();\n  (Array.isArray(recipients) ? recipients : []).forEach((recipient) => {\n    if (typeof recipient !== 'string') {\n      return;\n    }\n    const trimmed = recipient.trim();\n    if (!trimmed) {\n      return;\n    }\n    const key = trimmed.toLowerCase();\n    if (!uniqueRecipients.has(key)) {\n      uniqueRecipients.set(key, trimmed);\n    }\n  });\n  return Array.from(uniqueRecipients.values());\n};\n\nconst buildMailtoLink = ({ projectName, relevantTeams, committees, body }) => {\n  const teamRecipients = relevantTeams.flatMap((team) => normalizeTeamContacts(team));\n  const committeeRecipients = (Array.isArray(committees) ? committees : []).flatMap((committee) =>\n    Array.isArray(committee?.emails) ? committee.emails : []\n  );\n  const recipients = normalizeRecipients([...teamRecipients, ...committeeRecipients]);\n\n  const toField = recipients.join(',');\n  const subject = projectName || 'Projet compliance';\n  const normalizedBody = (body || '').replace(/\\r?\\n/g, '\\r\\n');\n  const encodedParams = [];\n\n  if (subject) {\n    encodedParams.push(`subject=${encodeURIComponent(subject)}`);\n  }\n\n  if (normalizedBody) {\n    encodedParams.push(`body=${encodeURIComponent(normalizedBody)}`);\n  }\n\n  const prefix = toField ? `mailto:${toField}` : 'mailto:';\n  const query = encodedParams.join('&');\n\n  return query ? `${prefix}?${query}` : prefix;\n};\n\nexport const SynthesisReport = ({\n  answers,\n  analysis,\n  teams,\n  questions,\n  projectStatus,\n  projectId,\n  projectName: providedProjectName,\n  onOpenProjectShowcase,\n  isProjectEditable = true,\n  onRestart,\n  onBack,\n  onUpdateAnswers,\n  onUpdateComplianceComments,\n  currentUser = null,\n  sharedMembers = [],\n  onShareProjectMember,\n  onRemoveProjectMember,\n  onSubmitProject,\n  onNavigateToQuestion,\n  onSaveDraft,\n  saveFeedback,\n  onDismissSaveFeedback,\n  isAdminMode = false,\n  tourContext = null,\n  hasIncompleteAnswers = false,\n  validationCommitteeConfig = null\n}) => {\n  const [isShowcaseFallbackOpen, setIsShowcaseFallbackOpen] = useState(false);\n  const showcaseFallbackRef = useRef(null);\n  const [attachmentReminder, setAttachmentReminder] = useState(null);\n  const reminderCloseButtonRef = useRef(null);\n  const complianceCommentFeedbackTimeoutRef = useRef(null);\n  const [expandedThreads, setExpandedThreads] = useState({});\n  const [complianceReplyDrafts, setComplianceReplyDrafts] = useState({});\n  const [shareMemberDraft, setShareMemberDraft] = useState('');\n  const [shareMemberFeedback, setShareMemberFeedback] = useState('');\n  useEffect(() => {\n    if (!tourContext?.isActive) {\n      return;\n    }\n\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    const stepToSelectorMap = {\n      'compliance-report': '[data-tour-id=\"synthesis-summary\"]',\n      'compliance-report-top': '[data-tour-id=\"synthesis-summary\"]',\n      'compliance-teams': '[data-tour-id=\"synthesis-teams\"]',\n      'compliance-risks': '[data-tour-id=\"synthesis-risks\"]'\n    };\n\n    const selector = stepToSelectorMap[tourContext.activeStep];\n    if (!selector) {\n      return;\n    }\n\n    const element = document.querySelector(selector);\n    if (element && typeof element.scrollIntoView === 'function') {\n      element.scrollIntoView({ behavior: 'smooth', block: 'start' });\n    }\n  }, [tourContext]);\n  const relevantTeams = teams.filter(team => (analysis?.teams || []).includes(team.id));\n  const hasSaveFeedback = Boolean(saveFeedback?.message);\n  const isSaveSuccess = saveFeedback?.status === 'success';\n  const complianceComments = useMemo(\n    () => normalizeComplianceComments(answers?.[COMPLIANCE_COMMENTS_KEY]),\n    [answers]\n  );\n  const [complianceCommentDrafts, setComplianceCommentDrafts] = useState(() =>\n    buildComplianceCommentDrafts(complianceComments, relevantTeams, [])\n  );\n  const [complianceCommentFeedback, setComplianceCommentFeedback] = useState(null);\n  const updateComplianceComments =\n    typeof onUpdateComplianceComments === 'function' ? onUpdateComplianceComments : onUpdateAnswers;\n  const canSaveComplianceComment = typeof updateComplianceComments === 'function';\n  const currentUserEmail = useMemo(\n    () => normalizeEmail(currentUser?.mail || currentUser?.userPrincipalName || ''),\n    [currentUser]\n  );\n  const currentUserDisplayName = useMemo(() => {\n    const firstName = typeof currentUser?.givenName === 'string' ? currentUser.givenName.trim() : '';\n    const lastName = typeof currentUser?.surname === 'string' ? currentUser.surname.trim() : '';\n    const combined = `${firstName} ${lastName}`.trim();\n    if (combined) {\n      return combined;\n    }\n    const displayName = typeof currentUser?.displayName === 'string' ? currentUser.displayName.trim() : '';\n    if (displayName) {\n      return displayName;\n    }\n    return currentUserEmail;\n  }, [currentUser, currentUserEmail]);\n  const complianceTeamIdsForUser = useMemo(() => {\n    if (!currentUserEmail) {\n      return new Set();\n    }\n\n    const matched = new Set();\n    relevantTeams.forEach((team) => {\n      const contacts = normalizeTeamContacts(team);\n      const isMember = contacts.some((contact) => normalizeEmail(contact) === currentUserEmail);\n      if (isMember && team?.id) {\n        matched.add(team.id);\n      }\n    });\n    return matched;\n  }, [currentUserEmail, relevantTeams]);\n  const normalizedSharedMembers = useMemo(\n    () => (Array.isArray(sharedMembers) ? sharedMembers.filter(Boolean) : []),\n    [sharedMembers]\n  );\n  const normalizedValidationCommitteeConfig = useMemo(\n    () => normalizeValidationCommitteeConfig(validationCommitteeConfig),\n    [validationCommitteeConfig]\n  );\n  const validationCommittees = normalizedValidationCommitteeConfig.committees;\n  const triggeredValidationCommittees = useMemo(\n    () =>\n      getTriggeredValidationCommittees(normalizedValidationCommitteeConfig, {\n        answers,\n        analysis,\n        relevantTeams\n      }),\n    [analysis, answers, normalizedValidationCommitteeConfig, relevantTeams]\n  );\n  const requiredValidationCommittees = useMemo(\n    () => triggeredValidationCommittees.filter((committee) => committee.commentRequired),\n    [triggeredValidationCommittees]\n  );\n\n  const resolveTeamLabel = useCallback(\n    (teamId) => {\n      if (!teamId) {\n        return '';\n      }\n\n      const teamMatch = teams.find(team => team?.id === teamId);\n      return teamMatch?.name || teamId;\n    },\n    [teams]\n  );\n\n  const normalizedProjectStatus =\n    typeof projectStatus === 'string' ? projectStatus.toLowerCase() : null;\n  const statusLabelMap = {\n    draft: 'Brouillon',\n    submitted: 'Soumis'\n  };\n  const statusClassMap = {\n    draft: 'bg-yellow-100 text-yellow-800 border border-yellow-200',\n    submitted: 'bg-emerald-100 text-emerald-800 border border-emerald-200'\n  };\n  const projectStatusLabel = normalizedProjectStatus\n    ? statusLabelMap[normalizedProjectStatus] || projectStatus\n    : null;\n  const projectStatusClasses = normalizedProjectStatus\n    ? statusClassMap[normalizedProjectStatus] || 'bg-gray-100 text-gray-700 border border-gray-200'\n    : '';\n\n  const priorityColors = {\n    'A particuliÃ¨rement anticiper': 'bg-red-100 text-red-800 border-red-300',\n    'A anticiper': 'bg-orange-100 text-orange-800 border-orange-300',\n    'A rÃ©aliser': 'bg-blue-100 text-blue-800 border-blue-300'\n  };\n\n  const riskColors = {\n    Ã‰levÃ©: 'bg-red-50 border-red-300 text-red-900',\n    Moyen: 'bg-orange-50 border-orange-300 text-orange-900',\n    Faible: 'bg-green-50 border-green-300 text-green-900'\n  };\n\n  const vigilanceStatusClasses = {\n    satisfied: 'bg-emerald-50 border-emerald-300 text-emerald-900',\n    unknown: 'bg-emerald-50 border-emerald-200 text-emerald-900',\n    breach: 'bg-red-50 border-red-300 text-red-900'\n  };\n\n  const complexityColors = {\n    Ã‰levÃ©: 'text-red-600',\n    Moyen: 'text-orange-600',\n    Faible: 'text-green-600'\n  };\n\n  const formattedRiskScore = formatRiskScore(analysis?.riskScore);\n\n  const rankingQuestions = useMemo(\n    () => (Array.isArray(questions) ? questions.filter(question => question?.type === 'ranking') : []),\n    [questions]\n  );\n\n  const rankingResults = useMemo(() => {\n    return rankingQuestions\n      .map(question => {\n        const config = normalizeRankingConfig(question.rankingConfig || {});\n        const answer = answers?.[question.id];\n        const recommendations = computeRankingRecommendations(answer, config, 3);\n        const formattedAnswer = formatAnswer(question, answer);\n        const prioritizedOrder = Array.isArray(answer?.prioritized)\n          ? answer.prioritized\n          : config.criteria.map(item => item.id);\n        const ignoredSet = new Set(Array.isArray(answer?.ignored) ? answer.ignored : []);\n        const orderedCriteria = prioritizedOrder\n          .map(id => config.criteria.find(criterion => criterion.id === id))\n          .filter(Boolean)\n          .filter(criterion => !ignoredSet.has(criterion.id));\n        const ignoredCriteria = config.criteria.filter(criterion => ignoredSet.has(criterion.id));\n\n        return {\n          question,\n          config,\n          recommendations,\n          formattedAnswer,\n          orderedCriteria,\n          ignoredCriteria\n        };\n      })\n      .filter(entry => entry.recommendations.length > 0 && entry.formattedAnswer);\n  }, [answers, rankingQuestions]);\n\n  const timelineDetails = analysis?.timeline?.details || [];\n  const vigilanceAlerts = (Array.isArray(analysis?.timeline?.vigilance)\n    ? analysis.timeline.vigilance\n    : [])\n    .filter(alert => alert && alert.status !== 'breach')\n    .map(alert => ({\n      ...alert,\n      requirementSummary: formatTimingRequirementSummary(questions, alert.timingConstraint),\n      statusMessage: formatVigilanceStatusMessage(alert)\n    }));\n\n  const extractedProjectName = extractProjectName(answers, questions);\n  const effectiveProjectName =\n    typeof providedProjectName === 'string' && providedProjectName.trim().length > 0\n      ? providedProjectName.trim()\n      : extractedProjectName;\n\n  const scrollShowcaseIntoView = useCallback(() => {\n    const node = showcaseFallbackRef.current;\n\n    if (node) {\n      if (typeof node.scrollIntoView === 'function') {\n        node.scrollIntoView({ behavior: 'smooth', block: 'start' });\n        return;\n      }\n    }\n\n    if (typeof window !== 'undefined' && typeof window.scrollTo === 'function') {\n      window.scrollTo({ top: 0, behavior: 'smooth' });\n    }\n  }, [showcaseFallbackRef]);\n\n  useEffect(() => {\n    if (!isShowcaseFallbackOpen) {\n      return;\n    }\n\n    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\n      window.requestAnimationFrame(() => {\n        scrollShowcaseIntoView();\n      });\n    } else {\n      scrollShowcaseIntoView();\n    }\n  }, [isShowcaseFallbackOpen, scrollShowcaseIntoView]);\n\n  useEffect(() => {\n    if (!attachmentReminder) {\n      return;\n    }\n\n    if (\n      reminderCloseButtonRef.current\n      && typeof reminderCloseButtonRef.current.focus === 'function'\n    ) {\n      reminderCloseButtonRef.current.focus();\n    }\n  }, [attachmentReminder]);\n\n  useEffect(() => {\n    setComplianceCommentDrafts(\n      buildComplianceCommentDrafts(complianceComments, relevantTeams, validationCommittees)\n    );\n  }, [complianceComments, relevantTeams, validationCommittees]);\n\n  useEffect(() => {\n    return () => {\n      if (complianceCommentFeedbackTimeoutRef.current) {\n        clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const scheduleComplianceFeedback = useCallback((targetId, message) => {\n    if (complianceCommentFeedbackTimeoutRef.current) {\n      clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n    }\n\n    setComplianceCommentFeedback({ targetId, message });\n\n    complianceCommentFeedbackTimeoutRef.current = setTimeout(() => {\n      setComplianceCommentFeedback(null);\n    }, 4000);\n  }, []);\n\n  const handleComplianceCommentSubmit = useCallback(\n    ({ event, targetId, targetType }) => {\n      if (event && typeof event.preventDefault === 'function') {\n        event.preventDefault();\n      }\n\n      if (!canSaveComplianceComment) {\n        return;\n      }\n\n      const isCommittee = targetType === 'committee';\n      const currentEntry = isCommittee\n        ? complianceCommentDrafts.committees?.[targetId]\n        : complianceCommentDrafts.teams?.[targetId];\n\n      if (!currentEntry) {\n        return;\n      }\n\n      const normalizedDraft =\n        typeof currentEntry.comment === 'string' ? currentEntry.comment.replace(/\\r\\n/g, '\\n') : '';\n      const trimmedDraft = normalizedDraft.trim();\n      const nextEntry = {\n        comment: trimmedDraft,\n        status: currentEntry.status,\n        replies: Array.isArray(currentEntry.replies) ? currentEntry.replies : []\n      };\n\n      const nextComments = {\n        teams: { ...(complianceComments?.teams || {}) },\n        committees: { ...(complianceComments?.committees || {}) },\n        legacy: complianceComments?.legacy || ''\n      };\n\n      if (isCommittee && targetId) {\n        nextComments.committees[targetId] = nextEntry;\n      } else if (targetId) {\n        nextComments.teams[targetId] = nextEntry;\n      }\n\n      updateComplianceComments({\n        [COMPLIANCE_COMMENTS_KEY]: nextComments\n      });\n\n      setComplianceCommentDrafts((prev) => {\n        const nextDrafts = {\n          ...prev,\n          teams: { ...(prev?.teams || {}) },\n          committees: { ...(prev?.committees || {}) }\n        };\n        if (isCommittee && targetId) {\n          nextDrafts.committees[targetId] = nextEntry;\n        } else if (targetId) {\n          nextDrafts.teams[targetId] = nextEntry;\n        }\n        return nextDrafts;\n      });\n\n      scheduleComplianceFeedback(\n        `${targetType}-${targetId || 'committee'}`,\n        trimmedDraft.length > 0 ? 'Commentaire enregistrÃ©.' : 'Commentaire effacÃ©.'\n      );\n    },\n    [\n      canSaveComplianceComment,\n      complianceCommentDrafts,\n      complianceComments,\n      updateComplianceComments,\n      scheduleComplianceFeedback\n    ]\n  );\n\n  const handleComplianceCommentChange = useCallback(\n    ({ targetId, targetType, field, value }) => {\n      setComplianceCommentDrafts((prev) => {\n        const nextDrafts = {\n          ...prev,\n          teams: { ...(prev?.teams || {}) },\n          committees: { ...(prev?.committees || {}) }\n        };\n        if (targetType === 'committee' && targetId) {\n          nextDrafts.committees[targetId] = {\n            ...prev?.committees?.[targetId],\n            [field]: value\n          };\n        } else if (targetId) {\n          nextDrafts.teams[targetId] = {\n            ...prev?.teams?.[targetId],\n            [field]: value\n          };\n        }\n        return nextDrafts;\n      });\n\n      if (complianceCommentFeedback) {\n        if (complianceCommentFeedbackTimeoutRef.current) {\n          clearTimeout(complianceCommentFeedbackTimeoutRef.current);\n          complianceCommentFeedbackTimeoutRef.current = null;\n        }\n        setComplianceCommentFeedback(null);\n      }\n    },\n    [complianceCommentFeedback]\n  );\n\n  const handleComplianceReplyChange = useCallback((threadKey, value) => {\n    setComplianceReplyDrafts(prev => ({\n      ...prev,\n      [threadKey]: value\n    }));\n  }, []);\n\n  const handleComplianceReplySubmit = useCallback(\n    ({ targetId, targetType }) => {\n      if (!canSaveComplianceComment) {\n        return;\n      }\n\n      const threadKey = `${targetType}-${targetId}`;\n      const draft = complianceReplyDrafts[threadKey] || '';\n      const trimmed = draft.trim();\n\n      if (!trimmed) {\n        return;\n      }\n\n      const sourceEntry = targetType === 'committee'\n        ? complianceComments.committees?.[targetId]\n        : complianceComments.teams?.[targetId];\n      const normalizedEntry = normalizeCommentEntry(sourceEntry);\n      const reply = {\n        id: `reply-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n        message: trimmed,\n        authorName: currentUserDisplayName || 'Utilisateur',\n        authorEmail: currentUserEmail,\n        createdAt: new Date().toISOString()\n      };\n      const nextEntry = {\n        ...normalizedEntry,\n        replies: [...(normalizedEntry.replies || []), reply]\n      };\n\n      const nextComments = {\n        teams: { ...(complianceComments?.teams || {}) },\n        committees: { ...(complianceComments?.committees || {}) },\n        legacy: complianceComments?.legacy || ''\n      };\n\n      if (targetType === 'committee') {\n        nextComments.committees[targetId] = nextEntry;\n      } else {\n        nextComments.teams[targetId] = nextEntry;\n      }\n\n      updateComplianceComments({\n        [COMPLIANCE_COMMENTS_KEY]: nextComments\n      });\n\n      setComplianceReplyDrafts(prev => ({\n        ...prev,\n        [threadKey]: ''\n      }));\n\n      scheduleComplianceFeedback(threadKey, 'RÃ©ponse ajoutÃ©e.');\n    },\n    [\n      canSaveComplianceComment,\n      complianceComments,\n      complianceReplyDrafts,\n      currentUserDisplayName,\n      currentUserEmail,\n      updateComplianceComments,\n      scheduleComplianceFeedback\n    ]\n  );\n\n  const shouldCollapseThread = useCallback((messages) => {\n    if (!Array.isArray(messages)) {\n      return false;\n    }\n\n    if (messages.length > 3) {\n      return true;\n    }\n\n    const totalLength = messages.reduce((sum, message) => sum + (message.message || '').length, 0);\n    const hasLongMessage = messages.some((message) => (message.message || '').length > 280);\n\n    return totalLength > 600 || hasLongMessage;\n  }, []);\n\n  const getThreadMessages = useCallback((entry, authorLabel) => {\n    const normalized = normalizeCommentEntry(entry);\n    const messages = [];\n\n    if (normalized.comment.trim().length > 0) {\n      messages.push({\n        id: `comment-${authorLabel || 'team'}`,\n        message: normalized.comment,\n        authorName: authorLabel || 'Ã‰quipe compliance',\n        createdAt: ''\n      });\n    }\n\n    normalized.replies.forEach((reply) => {\n      messages.push({\n        id: reply.id,\n        message: reply.message,\n        authorName: reply.authorName || reply.authorEmail || 'Utilisateur',\n        createdAt: reply.createdAt\n      });\n    });\n\n    return messages;\n  }, []);\n\n  const toggleThreadExpanded = useCallback((threadKey) => {\n    setExpandedThreads(prev => ({\n      ...prev,\n      [threadKey]: true\n    }));\n  }, []);\n\n  const handleShareMemberAdd = useCallback(() => {\n    if (typeof onShareProjectMember !== 'function') {\n      return;\n    }\n\n    const normalized = normalizeEmail(shareMemberDraft);\n    if (!normalized) {\n      setShareMemberFeedback('Veuillez saisir une adresse e-mail valide.');\n      return;\n    }\n\n    onShareProjectMember(normalized);\n    setShareMemberDraft('');\n    setShareMemberFeedback(`${normalized} ajoutÃ© Ã  l'Ã©quipe.`);\n  }, [onShareProjectMember, shareMemberDraft]);\n\n  const handleShareMemberRemove = useCallback((email) => {\n    if (typeof onRemoveProjectMember !== 'function') {\n      return;\n    }\n\n    onRemoveProjectMember(email);\n  }, [onRemoveProjectMember]);\n\n  const handleOpenShowcase = useCallback(() => {\n    if (typeof onOpenProjectShowcase === 'function') {\n      onOpenProjectShowcase({\n        projectId,\n        projectName: effectiveProjectName,\n        status: projectStatus,\n        answers,\n        analysis,\n        relevantTeams,\n        questions,\n        timelineDetails\n      });\n      return;\n    }\n\n    setIsShowcaseFallbackOpen(true);\n\n    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\n      window.requestAnimationFrame(() => {\n        scrollShowcaseIntoView();\n      });\n    } else {\n      scrollShowcaseIntoView();\n    }\n  }, [\n    analysis,\n    answers,\n    effectiveProjectName,\n    onOpenProjectShowcase,\n    projectId,\n    projectStatus,\n    questions,\n    relevantTeams,\n    scrollShowcaseIntoView,\n    timelineDetails\n  ]);\n\n  const handleCloseShowcase = useCallback(() => {\n    setIsShowcaseFallbackOpen(false);\n  }, []);\n\n  const handleDismissAttachmentReminder = useCallback(() => {\n    setAttachmentReminder(null);\n  }, []);\n\n  const legacyComplianceComment = complianceComments.legacy?.trim() || '';\n  const hasLegacyComplianceComment = legacyComplianceComment.length > 0;\n  const committeeCommentMap = useMemo(() => {\n    const nextMap = {};\n    validationCommittees.forEach((committee) => {\n      if (!committee?.id) {\n        return;\n      }\n      nextMap[committee.id] = normalizeCommentEntry(complianceComments.committees?.[committee.id]);\n    });\n    return nextMap;\n  }, [complianceComments.committees, validationCommittees]);\n  const triggeredCommitteeIds = useMemo(\n    () => new Set(triggeredValidationCommittees.map((committee) => committee.id)),\n    [triggeredValidationCommittees]\n  );\n  const requiredCommitteeIds = useMemo(\n    () => new Set(requiredValidationCommittees.map((committee) => committee.id)),\n    [requiredValidationCommittees]\n  );\n  const committeesToDisplay = validationCommittees.filter((committee) => {\n    if (isAdminMode) {\n      return true;\n    }\n    const hasComment = committeeCommentMap[committee.id]?.comment?.trim().length > 0;\n    return triggeredCommitteeIds.has(committee.id) || hasComment;\n  });\n  const shouldShowCommitteeSection = committeesToDisplay.length > 0;\n  const shouldShowComplianceCommentsSection =\n    isAdminMode || relevantTeams.length > 0 || shouldShowCommitteeSection || hasLegacyComplianceComment;\n\n  const getComplianceFeedbackMessage = useCallback(\n    (targetId) => (complianceCommentFeedback?.targetId === targetId ? complianceCommentFeedback.message : null),\n    [complianceCommentFeedback]\n  );\n\n  const handleSaveProject = useCallback(() => {\n    if (!onSubmitProject) {\n      return;\n    }\n\n    onSubmitProject({\n      projectName: effectiveProjectName,\n      answers,\n      analysis,\n      relevantTeams,\n      timelineDetails\n    });\n  }, [analysis, answers, effectiveProjectName, onSubmitProject, relevantTeams, timelineDetails]);\n\n  const handleDownloadProject = useCallback(() => {\n    if (!onSaveDraft) {\n      return;\n    }\n\n    onSaveDraft({\n      projectName: effectiveProjectName,\n      answers,\n      analysis,\n      questions,\n      relevantTeams,\n      timelineDetails,\n      lastQuestionIndex: questions.length > 0 ? questions.length - 1 : 0\n    });\n  }, [analysis, answers, effectiveProjectName, onSaveDraft, questions, relevantTeams, timelineDetails]);\n\n  const handleSubmitByEmail = useCallback(async () => {\n    const emailHtml = buildEmailHtml({\n      projectName: effectiveProjectName,\n      questions,\n      answers,\n      analysis,\n      relevantTeams\n    });\n    const emailText = buildPlainTextEmail(emailHtml);\n    const projectExport = buildProjectExport({\n      projectName: effectiveProjectName,\n      answers\n    });\n\n    let projectJson = '';\n    try {\n      projectJson = JSON.stringify(projectExport, null, 2);\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[SynthesisReport] Impossible de sÃ©rialiser le projet :', error);\n      }\n      projectJson = JSON.stringify(\n        {\n          version: 1,\n          project: {\n            name: projectExport.project.name,\n            answers: {}\n          }\n        },\n        null,\n        2\n      );\n    }\n\n    const fileNameBase = sanitizeFileName(effectiveProjectName || 'Projet compliance');\n    const fileName = `${fileNameBase}.json`;\n    const subject = effectiveProjectName || 'Projet compliance';\n\n    if (typeof navigator !== 'undefined' && typeof navigator.share === 'function' && typeof File === 'function') {\n      try {\n        const projectFile = new File([projectJson], fileName, {\n          type: 'application/json'\n        });\n        const canShare =\n          typeof navigator.canShare === 'function'\n            ? navigator.canShare({ files: [projectFile] })\n            : true;\n\n        if (canShare) {\n          await navigator.share({\n            title: subject,\n            text: `${emailText}\\n\\nFichier du projet : ${fileName}`,\n            files: [projectFile]\n          });\n          return;\n        }\n      } catch (error) {\n        if (error && error.name === 'AbortError') {\n          return;\n        }\n\n        if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n          console.warn('[SynthesisReport] Partage du projet impossible :', error);\n        }\n      }\n    }\n\n    downloadProjectJson(projectJson, { projectName: effectiveProjectName });\n    setAttachmentReminder({ fileName });\n\n    const fallbackBody = `${emailText}\\n\\nFichier du projet : ${fileName}\\nLe fichier JSON a Ã©tÃ© tÃ©lÃ©chargÃ© automatiquement ; merci de l'ajouter en piÃ¨ce jointe avant envoi.`;\n    const mailtoLink = buildMailtoLink({\n      projectName: effectiveProjectName,\n      relevantTeams,\n      committees: triggeredValidationCommittees,\n      body: fallbackBody\n    });\n    if (typeof window !== 'undefined') {\n      window.location.href = mailtoLink;\n    }\n  }, [\n    analysis,\n    answers,\n    effectiveProjectName,\n    questions,\n    relevantTeams,\n    triggeredValidationCommittees,\n    timelineDetails,\n    setAttachmentReminder\n  ]);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 px-4 py-6 sm:px-8 sm:py-10 hv-background\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div\n          className=\"bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6 hv-surface\"\n          role=\"region\"\n          aria-label=\"SynthÃ¨se du projet\"\n          data-tour-id=\"synthesis-summary\"\n        >\n          <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6\">\n            <div className=\"flex flex-col gap-2\">\n              <h1 className=\"text-3xl font-bold text-gray-800 sm:text-4xl\">SynthÃ¨se</h1>\n              {projectStatusLabel && (\n                <span\n                  className={`inline-flex items-center self-start rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide ${projectStatusClasses}`}\n                >\n                  Statut : {projectStatusLabel}\n                </span>\n              )}\n              {!isProjectEditable && (\n                <p className=\"text-sm text-gray-500\">\n                  Ce projet n'est pas en mode brouillon. Les modifications sont dÃ©sactivÃ©es dans cette vue.\n                </p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:gap-3 w-full lg:w-auto\">\n              {onBack && (\n                <button\n                  type=\"button\"\n                  onClick={onBack}\n                  className=\"px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg font-medium text-gray-700 transition-all hv-button hv-focus-ring w-full sm:w-auto justify-center text-sm sm:text-base\"\n                >\n                  Retour au questionnaire\n                </button>\n              )}\n              {onSaveDraft && (\n                <button\n                  type=\"button\"\n                  onClick={handleDownloadProject}\n                  className=\"px-4 py-2 bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-focus-ring w-full sm:w-auto text-sm sm:text-base\"\n                  data-tour-id=\"synthesis-save\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Sauvegarder le projet\n                </button>\n              )}\n              <button\n                type=\"button\"\n                onClick={handleSubmitByEmail}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-button-primary w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"synthesis-submit\"\n              >\n                <Send className=\"w-4 h-4 mr-2\" />\n                Soumettre par e-mail\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleOpenShowcase}\n                className=\"px-4 py-2 bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 rounded-lg font-medium transition-all flex items-center justify-center hv-button hv-focus-ring w-full sm:w-auto text-sm sm:text-base\"\n                data-tour-id=\"synthesis-showcase\"\n              >\n                <Sparkles className=\"w-4 h-4 mr-2\" />\n                Vitrine du projet\n              </button>\n            </div>\n          </div>\n\n          {(onShareProjectMember || onRemoveProjectMember) && (\n            <div className=\"mb-6 rounded-xl border border-gray-200 bg-gray-50 p-4\">\n              <div>\n                <h2 className=\"text-sm font-semibold uppercase tracking-wide text-gray-600\">\n                  Partage du projet\n                </h2>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  Ajoutez un membre de lâ€™Ã©quipe pour quâ€™il retrouve aussi ce projet dans sa liste.\n                </p>\n              </div>\n              <div className=\"mt-3 flex flex-col gap-3 sm:flex-row sm:items-center\">\n                <input\n                  type=\"email\"\n                  value={shareMemberDraft}\n                  onChange={(event) => setShareMemberDraft(event.target.value)}\n                  placeholder=\"prenom.nom@lfb.fr\"\n                  className=\"flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={handleShareMemberAdd}\n                  className=\"px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700\"\n                >\n                  Ajouter\n                </button>\n              </div>\n              {shareMemberFeedback && (\n                <p className=\"mt-2 text-xs text-emerald-600\">{shareMemberFeedback}</p>\n              )}\n              {normalizedSharedMembers.length > 0 && (\n                <div className=\"mt-3 flex flex-wrap gap-2\">\n                  {normalizedSharedMembers.map((member) => (\n                    <span\n                      key={member}\n                      className=\"inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700\"\n                    >\n                      {member}\n                      {typeof onRemoveProjectMember === 'function' && (\n                        <button\n                          type=\"button\"\n                          onClick={() => handleShareMemberRemove(member)}\n                          className=\"rounded-full p-0.5 text-blue-700 hover:bg-blue-100\"\n                          aria-label={`Retirer ${member}`}\n                        >\n                          Ã—\n                        </button>\n                      )}\n                    </span>\n                  ))}\n                </div>\n              )}\n            </div>\n          )}\n\n          {hasSaveFeedback && (\n            <div className=\"mb-6\" role=\"status\" aria-live=\"polite\">\n              <div\n                className={`flex items-start gap-3 rounded-xl border p-4 text-sm ${\n                  isSaveSuccess\n                    ? 'border-emerald-200 bg-emerald-50 text-emerald-700'\n                    : 'border-red-200 bg-red-50 text-red-700'\n                }`}\n              >\n                {isSaveSuccess ? (\n                  <CheckCircle className=\"mt-0.5 h-5 w-5\" />\n                ) : (\n                  <AlertTriangle className=\"mt-0.5 h-5 w-5\" />\n                )}\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\">{saveFeedback.message}</p>\n                </div>\n                {typeof onDismissSaveFeedback === 'function' && (\n                  <button\n                    type=\"button\"\n                    onClick={onDismissSaveFeedback}\n                    className=\"text-xs font-semibold uppercase tracking-wide text-current hover:underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-current rounded\"\n                  >\n                    Fermer\n                  </button>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Vue d'ensemble */}\n          <section className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 sm:p-6 mb-8 border border-blue-200 hv-surface\" aria-labelledby=\"overview-heading\">\n            <h2 id=\"overview-heading\" className=\"text-xl font-bold text-gray-800 mb-4 flex items-center\">\n              <FileText className=\"w-6 h-6 mr-2 text-blue-600\" />\n              Vue d'ensemble du projet\n            </h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {questions.map(q => {\n                const answerValue = answers[q.id];\n                const shouldRenderCard = isAnswerProvided(answerValue) || q.required;\n\n                if (!shouldRenderCard) {\n                  return null;\n                }\n\n                const displayValue = formatOverviewValue(q, answerValue);\n\n                return (\n                  <div key={q.id} className=\"bg-white rounded-lg p-4 border border-gray-200 hv-surface\">\n                    <div className=\"flex items-start justify-between gap-3 mb-1\">\n                      <p className=\"text-sm text-gray-600\">{q.question}</p>\n                      {typeof onNavigateToQuestion === 'function' && isProjectEditable && (\n                        <button\n                          type=\"button\"\n                          onClick={() => onNavigateToQuestion(q.id)}\n                          className=\"flex items-center justify-center w-8 h-8 rounded-full border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 transition-colors hv-button hv-focus-ring\"\n                          aria-label={`Modifier la rÃ©ponse pour Â« ${q.question} Â»`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </button>\n                      )}\n                    </div>\n                    {(() => {\n                      const resolvedValue = displayValue || MISSING_INFO_LABEL;\n                      const isMissingInfo = resolvedValue === MISSING_INFO_LABEL;\n                      return (\n                        <p\n                          className={`font-semibold whitespace-pre-line ${\n                            isMissingInfo ? 'text-rose-600' : 'text-gray-900'\n                          }`}\n                        >\n                          {renderTextWithLinks(resolvedValue)}\n                        </p>\n                      );\n                    })()}\n                  </div>\n                );\n              })}\n            </div>\n            <div className=\"mt-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between bg-white rounded-lg p-4 border border-gray-200 hv-surface\" role=\"status\" aria-live=\"polite\">\n              <span className=\"font-medium text-gray-700\">Niveau de complexitÃ© compliance :</span>\n              <span className={`text-xl font-bold ${complexityColors[analysis.complexity] || 'text-blue-600'}`}>\n                {analysis.complexity}\n              </span>\n            </div>\n            {analysis?.complexityRule?.description && (\n              <p className=\"mt-3 bg-white border border-gray-200 rounded-lg p-3 text-sm text-gray-600 hv-surface\">\n                {analysis.complexityRule.description}\n              </p>\n            )}\n            {formattedRiskScore && (\n              <p className=\"mt-3 text-sm text-gray-500\">\n                Score de risque total : {formattedRiskScore}\n              </p>\n            )}\n          </section>\n\n\n          {/* Ã‰quipes Ã  solliciter */}\n          <section className=\"mb-8\" aria-labelledby=\"teams-heading\" data-tour-id=\"synthesis-teams\">\n            <h2 id=\"teams-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n              <Users className=\"w-6 h-6 mr-2 text-blue-600\" />\n              Ã‰quipes Ã  solliciter ({relevantTeams.length})\n            </h2>\n            {hasIncompleteAnswers && (\n              <div className=\"mb-4 flex items-start gap-3 rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-sm text-yellow-800\">\n                <Info className=\"mt-0.5 h-5 w-5\" />\n                <p>En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.</p>\n              </div>\n            )}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {relevantTeams.map(team => {\n                const teamPriority = getTeamPriority(analysis, team.id);\n                const teamQuestions = analysis.questions?.[team.id];\n                const teamContactLabel = formatTeamContacts(team, ' Â· ');\n                const formattedTeamQuestions = Array.isArray(teamQuestions)\n                  ? teamQuestions\n                      .map(normalizeTeamQuestionForDisplay)\n                      .filter(question => (question.text || '').trim().length > 0)\n                  : [];\n\n                return (\n                  <div key={team.id} className=\"bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-blue-300 transition-all hv-surface\" role=\"article\" aria-label={`Ã‰quipe ${team.name}`}>\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <h3 className=\"text-lg font-bold text-gray-800\">{team.name}</h3>\n                      <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityColors[teamPriority]}`}>\n                        {teamPriority}\n                      </span>\n                    </div>\n                    <p className=\"text-sm text-gray-600 mb-3\">{renderTextWithLinks(team.expertise)}</p>\n                    {teamContactLabel && (\n                      <div className=\"mt-2 text-sm text-blue-600 font-medium flex items-center gap-2\">\n                        <Mail className=\"w-4 h-4\" />\n                        {renderTextWithLinks(teamContactLabel)}\n                      </div>\n                    )}\n\n                    {formattedTeamQuestions.length > 0 && (\n                      <div className=\"mt-4\">\n                        <h4 className=\"text-sm font-semibold text-gray-800 mb-2\">Points Ã  prÃ©parer :</h4>\n                        <ul className=\"space-y-1\">\n                          {formattedTeamQuestions.map((question, idx) => {\n                            const timingMessage = formatTeamQuestionTimingMessage(questions, question.timingViolation);\n                            return (\n                              <li key={idx} className=\"text-sm text-gray-700 flex flex-col\">\n                                <div className=\"flex\">\n                                  <span className=\"text-blue-500 mr-2\">â€¢</span>\n                                  <span>{renderTextWithLinks(question.text)}</span>\n                                </div>\n                                {timingMessage && (\n                                  <span className=\"ml-5 text-xs text-yellow-600 mt-1\">âš ï¸ {timingMessage}</span>\n                                )}\n                              </li>\n                            );\n                          })}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </section>\n\n          <div data-tour-id=\"synthesis-risks\" className=\"space-y-8\">\n            {/* Risques identifiÃ©s */}\n            <section aria-labelledby=\"risks-heading\">\n              <h2 id=\"risks-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n                <AlertTriangle className=\"w-6 h-6 mr-2 text-red-500\" />\n                Risques identifiÃ©s ({analysis.risks.length})\n              </h2>\n              {hasIncompleteAnswers && (\n                <div className=\"mb-4 flex items-start gap-3 rounded-lg border border-yellow-200 bg-yellow-50 p-4 text-sm text-yellow-800\">\n                  <Info className=\"mt-0.5 h-5 w-5\" />\n                  <p>En attente de lâ€™ensemble des informations sur le projet pour une Ã©valuation complÃ¨te.</p>\n                </div>\n              )}\n              <div className=\"space-y-3\">\n                {analysis.risks.map((risk, idx) => {\n                  const timingViolationMessage = formatRiskTimingViolation(risk.timingViolation);\n\n                  return (\n                    <div\n                      key={idx}\n                      className={`p-4 rounded-xl border hv-surface ${riskColors[risk.level]}`}\n                      role=\"article\"\n                      aria-label={`Risque ${risk.level}`}\n                    >\n                      <div className=\"flex flex-wrap items-center justify-between gap-2 mb-2\">\n                        <span className=\"text-sm font-semibold text-gray-700\">{risk.level}</span>\n                        <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityColors[risk.priority]}`}>\n                          {risk.priority}\n                        </span>\n                      </div>\n                      <p className=\"text-gray-800 font-medium\">{renderTextWithLinks(risk.description)}</p>\n                      {timingViolationMessage && (\n                        <p className=\"text-xs text-red-600 mt-2\">{timingViolationMessage}</p>\n                      )}\n                      <p className=\"text-xs text-gray-600 mt-2\">\n                        <span className=\"font-semibold text-gray-700\">Ã‰quipe rÃ©fÃ©rente :</span>{' '}\n                        {(() => {\n                          const associatedTeam = teams.find(team => {\n                            if (risk.teamId) {\n                              return team.id === risk.teamId;\n                            }\n                            if (Array.isArray(risk.teams)) {\n                              return risk.teams.includes(team.id);\n                            }\n                            return false;\n                          });\n\n                          if (associatedTeam) {\n                            return associatedTeam.name;\n                          }\n\n                          if (risk.teamId) {\n                            return risk.teamId;\n                          }\n\n                          if (Array.isArray(risk.teams) && risk.teams.length > 0) {\n                            return risk.teams[0];\n                          }\n\n                          return 'Non renseignÃ©e';\n                        })()}\n                      </p>\n                      <p className=\"text-sm text-gray-600 mt-2\">\n                        <span className=\"font-semibold text-gray-700\">Mitigation :</span>{' '}\n                        {renderTextWithLinks(risk.mitigation)}\n                      </p>\n                    </div>\n                  );\n                })}\n              </div>\n            </section>\n\n            {rankingResults.map(result => (\n              <section key={result.question.id} aria-labelledby={`ranking-${result.question.id}`} className=\"mt-8\">\n                <h3\n                  id={`ranking-${result.question.id}`}\n                  className=\"text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2\"\n                >\n                  <Sparkles className=\"w-5 h-5 text-indigo-600\" />\n                  {result.config.title}\n                </h3>\n                <p className=\"text-sm text-gray-600 mb-4\">PrioritÃ©s dÃ©clarÃ©es : {result.formattedAnswer}</p>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  {result.recommendations.map(recommendation => (\n                    <article\n                      key={recommendation.id}\n                      className=\"p-4 border border-gray-200 rounded-xl bg-white shadow-sm space-y-3 hv-surface\"\n                      aria-label={`Recommandation ${recommendation.name}`}\n                    >\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div>\n                          <h4 className=\"text-lg font-semibold text-gray-900\">{recommendation.name}</h4>\n                          {recommendation.previousProject && (\n                            <p className=\"text-xs text-gray-600\">Projet rÃ©cent : {recommendation.previousProject}</p>\n                          )}\n                          {recommendation.opinion && (\n                            <p className=\"text-xs text-gray-600\">Avis global : {recommendation.opinion}</p>\n                          )}\n                        </div>\n                        <div className=\"text-right\">\n                          <span className=\"text-xs font-semibold text-gray-500 uppercase\">Score</span>\n                          <p className=\"text-xl font-bold text-indigo-700\">{formatNumber(recommendation.score, { maximumFractionDigits: 1 })}</p>\n                        </div>\n                      </div>\n\n                      <div className=\"flex flex-wrap gap-2\">\n                        {result.orderedCriteria.map(criterion => (\n                          <span\n                            key={`${recommendation.id}-${criterion.id}`}\n                            className=\"inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100\"\n                          >\n                            {criterion.label} : <span className=\"text-gray-900\">{formatCriterionScore(recommendation.scores?.[criterion.id])}</span>\n                          </span>\n                        ))}\n                        {result.ignoredCriteria.map(criterion => (\n                          <span\n                            key={`${recommendation.id}-${criterion.id}-ignored`}\n                            className=\"inline-flex items-center gap-1 px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-500 border border-gray-200\"\n                          >\n                            {criterion.label} : sans importance\n                          </span>\n                        ))}\n                      </div>\n\n                      <div className=\"flex flex-col gap-1 text-sm text-gray-700\">\n                        {recommendation.contact && (\n                          <div className=\"flex items-center gap-2 text-blue-700\">\n                            <Mail className=\"w-4 h-4\" />\n                            {renderTextWithLinks(recommendation.contact)}\n                          </div>\n                        )}\n                        {recommendation.website && (\n                          <a\n                            href={recommendation.website}\n                            className=\"text-sm text-blue-600 underline\"\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                          >\n                            Consulter le site\n                          </a>\n                        )}\n                        {recommendation.notes && (\n                          <p className=\"text-xs text-gray-600 mt-1\">{renderTextWithLinks(recommendation.notes)}</p>\n                        )}\n                      </div>\n                    </article>\n                  ))}\n                </div>\n              </section>\n            ))}\n\n            {vigilanceAlerts.length > 0 && (\n              <section aria-labelledby=\"vigilance-heading\" className=\"mt-8\">\n                <h2 id=\"vigilance-heading\" className=\"text-2xl font-bold text-gray-800 mb-4 flex items-center\">\n                  <CheckCircle className=\"w-6 h-6 mr-2 text-emerald-500\" />\n                  Points de vigilance ({vigilanceAlerts.length})\n                </h2>\n                <div className=\"space-y-3\">\n                  {vigilanceAlerts.map(alert => {\n                    const priorityClass = priorityColors[alert.priority] || 'bg-emerald-100 text-emerald-800 border-emerald-300';\n                    const statusClass = vigilanceStatusClasses[alert.status] || vigilanceStatusClasses.unknown;\n                    const title = alert.riskDescription && alert.riskDescription.trim().length > 0\n                      ? alert.riskDescription\n                      : alert.ruleName;\n                    const teamLabel = resolveTeamLabel(alert.teamId);\n\n                    return (\n                      <div\n                        key={alert.id || `${alert.ruleId}-${alert.riskId || 'risk'}`}\n                        className={`p-4 rounded-xl border hv-surface ${statusClass}`}\n                        role=\"article\"\n                        aria-label={`Point de vigilance ${alert.ruleName}`}\n                      >\n                        <div className=\"flex flex-wrap items-center justify-between gap-2 mb-2\">\n                          <span className=\"text-sm font-semibold text-gray-700\">{alert.ruleName}</span>\n                          {alert.priority && (\n                            <span className={`px-3 py-1 rounded-full text-xs font-semibold border hv-badge ${priorityClass}`}>\n                              {alert.priority}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-gray-800 font-medium\">{renderTextWithLinks(title)}</p>\n                        {alert.requirementSummary && (\n                          <p className=\"text-xs text-emerald-800 mt-2\">{alert.requirementSummary}</p>\n                        )}\n                        {alert.statusMessage && (\n                          <p className=\"text-xs text-gray-600 mt-2\">{alert.statusMessage}</p>\n                        )}\n                        {teamLabel && (\n                          <p className=\"text-xs text-gray-600 mt-2\">\n                            <span className=\"font-semibold text-gray-700\">Ã‰quipe rÃ©fÃ©rente :</span>{' '}\n                            {teamLabel}\n                          </p>\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              </section>\n            )}\n          </div>\n\n          {shouldShowComplianceCommentsSection && (\n            <section className=\"mt-8\" aria-labelledby=\"compliance-comments-heading\">\n              <div className=\"bg-white rounded-xl border border-blue-200 p-6 hv-surface space-y-6\">\n                <div className=\"flex items-center\">\n                  <Info className=\"w-6 h-6 mr-2 text-blue-600\" />\n                  <h2 id=\"compliance-comments-heading\" className=\"text-2xl font-bold text-gray-800\">\n                    Commentaire des experts sujets\n                  </h2>\n                </div>\n\n                {relevantTeams.length === 0 ? (\n                  <p className=\"text-sm text-gray-500\">\n                    Aucune Ã©quipe compliance nâ€™est sollicitÃ©e pour ce projet.\n                  </p>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {relevantTeams.map((team) => {\n                      const storedEntry = normalizeCommentEntry(complianceComments.teams?.[team.id]);\n                      const draftEntry = complianceCommentDrafts.teams?.[team.id] || storedEntry;\n                      const statusMeta = getCommentStatusMeta(isAdminMode ? draftEntry.status : storedEntry.status);\n                      const isDirty =\n                        draftEntry.comment !== storedEntry.comment || draftEntry.status !== storedEntry.status;\n                      const feedbackMessage = getComplianceFeedbackMessage(`team-${team.id}`);\n                      const teamContactLabel = formatTeamContacts(team, ' Â· ');\n                      const canEditTeamComment = isAdminMode || complianceTeamIdsForUser.has(team.id);\n                      const threadKey = `team-${team.id}`;\n                      const threadMessages = getThreadMessages(storedEntry, team.name);\n                      const isThreadExpanded = Boolean(expandedThreads[threadKey]);\n                      const shouldCollapse = !isThreadExpanded && shouldCollapseThread(threadMessages);\n                      const visibleMessages = shouldCollapse ? threadMessages.slice(0, 2) : threadMessages;\n\n                      return (\n                        <article key={`compliance-comment-${team.id}`} className=\"rounded-xl border border-gray-200 p-4 bg-gray-50\">\n                          <div className=\"flex flex-wrap items-start justify-between gap-2\">\n                            <div>\n                              <h3 className=\"text-base font-semibold text-gray-800\">{team.name}</h3>\n                              {teamContactLabel && (\n                                <p className=\"text-xs text-gray-500\">{teamContactLabel}</p>\n                              )}\n                            </div>\n                            {statusMeta && (\n                              <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${statusMeta.badgeClass}`}>\n                                {statusMeta.label}\n                              </span>\n                            )}\n                          </div>\n\n                          {canEditTeamComment ? (\n                            <form\n                              onSubmit={(event) =>\n                                handleComplianceCommentSubmit({ event, targetId: team.id, targetType: 'team' })\n                              }\n                              className=\"mt-4 space-y-3\"\n                            >\n                              <div>\n                                <label className=\"block text-sm font-medium text-gray-700\" htmlFor={`compliance-status-${team.id}`}>\n                                  Statut\n                                </label>\n                                <select\n                                  id={`compliance-status-${team.id}`}\n                                  value={draftEntry.status}\n                                  onChange={(event) =>\n                                    handleComplianceCommentChange({\n                                      targetId: team.id,\n                                      targetType: 'team',\n                                      field: 'status',\n                                      value: event.target.value\n                                    })\n                                  }\n                                  className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                >\n                                  <option value=\"\">SÃ©lectionner un statut</option>\n                                  {COMMENT_STATUS_OPTIONS.map((option) => (\n                                    <option key={`status-${team.id}-${option.value}`} value={option.value}>\n                                      {option.label}\n                                    </option>\n                                  ))}\n                                </select>\n                              </div>\n                              <div>\n                                <label className=\"block text-sm font-medium text-gray-700\" htmlFor={`compliance-comment-${team.id}`}>\n                                  Commentaire\n                                </label>\n                                <textarea\n                                  id={`compliance-comment-${team.id}`}\n                                  rows={4}\n                                  className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200\"\n                                  placeholder=\"Ajoutez ici vos recommandations ou points d'attention...\"\n                                  value={draftEntry.comment}\n                                  onChange={(event) =>\n                                    handleComplianceCommentChange({\n                                      targetId: team.id,\n                                      targetType: 'team',\n                                      field: 'comment',\n                                      value: event.target.value\n                                    })\n                                  }\n                                />\n                              </div>\n                              <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n                                <p className=\"text-xs text-gray-500\">\n                                  Ces commentaires sont enregistrÃ©s dans le rapport compliance du projet.\n                                </p>\n                                <div className=\"flex flex-col sm:flex-row sm:items-center gap-2\">\n                                  <button\n                                    type=\"submit\"\n                                    className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all hv-button ${\n                                      canSaveComplianceComment && isDirty\n                                        ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                                        : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                                    }`}\n                                    disabled={!canSaveComplianceComment || !isDirty}\n                                  >\n                                    Enregistrer le commentaire\n                                  </button>\n                                  {feedbackMessage && (\n                                    <span className=\"text-xs font-medium text-emerald-700\">\n                                      {feedbackMessage}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                            </form>\n                          ) : null}\n\n                          <div className=\"mt-4 space-y-3\">\n                            {visibleMessages.length > 0 ? (\n                              <div className=\"space-y-3\">\n                                {visibleMessages.map((message) => {\n                                  const trimmedMessage = message.message.trim();\n                                  const isTruncated = shouldCollapse && trimmedMessage.length > 240;\n                                  const preview = isTruncated ? `${trimmedMessage.slice(0, 220)}â€¦` : trimmedMessage;\n                                  return (\n                                    <div key={message.id} className=\"rounded-lg bg-white border border-gray-200 p-3\">\n                                      <div className=\"flex items-center justify-between gap-2 text-xs text-gray-500\">\n                                        <span className=\"font-semibold text-gray-700\">{message.authorName}</span>\n                                        {message.createdAt && <span>{formatTimestamp(message.createdAt)}</span>}\n                                      </div>\n                                      <p className=\"mt-2 text-sm text-gray-700 whitespace-pre-line\">\n                                        {renderTextWithLinks(preview)}\n                                      </p>\n                                    </div>\n                                  );\n                                })}\n                                {shouldCollapse && (\n                                  <button\n                                    type=\"button\"\n                                    onClick={() => toggleThreadExpanded(threadKey)}\n                                    className=\"text-xs font-semibold text-blue-600 hover:text-blue-700\"\n                                  >\n                                    Voir plus\n                                  </button>\n                                )}\n                              </div>\n                            ) : (\n                              <p className=\"text-sm text-gray-500\">\n                                Aucun commentaire communiquÃ© pour le moment.\n                              </p>\n                            )}\n                            <div className=\"border-t border-gray-200 pt-3\">\n                              <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide\">\n                                RÃ©pondre\n                              </label>\n                              <textarea\n                                rows={3}\n                                value={complianceReplyDrafts[threadKey] || ''}\n                                onChange={(event) => handleComplianceReplyChange(threadKey, event.target.value)}\n                                className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Votre rÃ©ponse...\"\n                              />\n                              <div className=\"mt-2 flex items-center gap-3\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() => handleComplianceReplySubmit({ targetId: team.id, targetType: 'team' })}\n                                  className={`px-3 py-2 rounded-lg text-xs font-semibold transition-all ${\n                                    canSaveComplianceComment && (complianceReplyDrafts[threadKey] || '').trim().length > 0\n                                      ? 'bg-blue-600 text-white hover:bg-blue-700'\n                                      : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                                  }`}\n                                  disabled={\n                                    !canSaveComplianceComment\n                                    || (complianceReplyDrafts[threadKey] || '').trim().length === 0\n                                  }\n                                >\n                                  Envoyer la rÃ©ponse\n                                </button>\n                                {feedbackMessage && (\n                                  <span className=\"text-xs font-medium text-emerald-700\">\n                                    {feedbackMessage}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </article>\n                      );\n                    })}\n                  </div>\n                )}\n\n                {shouldShowCommitteeSection && (\n                  <div className=\"space-y-4\">\n                    {requiredValidationCommittees.length > 0 && (\n                      <div className=\"rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800\">\n                        <p className=\"font-medium\">ComitÃ©(s) requis pour ce projet :</p>\n                        <ul className=\"mt-2 list-disc pl-5 space-y-1\">\n                          {requiredValidationCommittees.map((committee) => (\n                            <li key={`required-${committee.id}`}>{committee.name}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n                    {committeesToDisplay.map((committee) => {\n                      const committeeCommentEntry = committeeCommentMap[committee.id] || normalizeCommentEntry();\n                      const committeeDraft = complianceCommentDrafts.committees?.[committee.id] || committeeCommentEntry;\n                      const feedbackMessage = getComplianceFeedbackMessage(`committee-${committee.id}`);\n                      const committeeStatusMeta = getCommentStatusMeta(\n                        isAdminMode ? committeeDraft.status : committeeCommentEntry.status\n                      );\n                      const isRequired = requiredCommitteeIds.has(committee.id);\n                      const isDirty =\n                        committeeDraft.comment !== committeeCommentEntry.comment\n                        || committeeDraft.status !== committeeCommentEntry.status;\n                      const threadKey = `committee-${committee.id}`;\n                      const threadMessages = getThreadMessages(committeeCommentEntry, committee.name);\n                      const isThreadExpanded = Boolean(expandedThreads[threadKey]);\n                      const shouldCollapse = !isThreadExpanded && shouldCollapseThread(threadMessages);\n                      const visibleMessages = shouldCollapse ? threadMessages.slice(0, 2) : threadMessages;\n\n                      return (\n                        <article key={committee.id} className=\"rounded-xl border border-gray-200 p-4 bg-gray-50\">\n                          <div className=\"flex flex-wrap items-start justify-between gap-2\">\n                            <div>\n                              <h3 className=\"text-base font-semibold text-gray-800\">{committee.name}</h3>\n                              <p className=\"text-xs text-gray-500\">\n                                {isRequired\n                                  ? 'Commentaire requis selon la configuration.'\n                                  : 'Commentaire optionnel selon la configuration.'}\n                              </p>\n                            </div>\n                            {committeeStatusMeta && (\n                              <span\n                                className={`px-3 py-1 rounded-full text-xs font-semibold border ${committeeStatusMeta.badgeClass}`}\n                              >\n                                {committeeStatusMeta.label}\n                              </span>\n                            )}\n                          </div>\n\n                          {isAdminMode ? (\n                            <form\n                              onSubmit={(event) =>\n                                handleComplianceCommentSubmit({\n                                  event,\n                                  targetId: committee.id,\n                                  targetType: 'committee'\n                                })\n                              }\n                              className=\"mt-4 space-y-3\"\n                            >\n                              <div>\n                                <label\n                                  className=\"block text-sm font-medium text-gray-700\"\n                                  htmlFor={`compliance-committee-status-${committee.id}`}\n                                >\n                                  Statut\n                                </label>\n                                <select\n                                  id={`compliance-committee-status-${committee.id}`}\n                                  value={committeeDraft.status}\n                                  onChange={(event) =>\n                                    handleComplianceCommentChange({\n                                      targetId: committee.id,\n                                      targetType: 'committee',\n                                      field: 'status',\n                                      value: event.target.value\n                                    })\n                                  }\n                                  className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200\"\n                                >\n                                  <option value=\"\">SÃ©lectionner un statut</option>\n                                  {COMMENT_STATUS_OPTIONS.map((option) => (\n                                    <option key={`status-committee-${committee.id}-${option.value}`} value={option.value}>\n                                      {option.label}\n                                    </option>\n                                  ))}\n                                </select>\n                              </div>\n                              <div>\n                                <label\n                                  className=\"block text-sm font-medium text-gray-700\"\n                                  htmlFor={`compliance-committee-comment-${committee.id}`}\n                                >\n                                  Commentaire\n                                </label>\n                                <textarea\n                                  id={`compliance-committee-comment-${committee.id}`}\n                                  rows={4}\n                                  className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200\"\n                                  placeholder=\"Ajoutez ici les dÃ©cisions ou arbitrages du comitÃ©...\"\n                                  value={committeeDraft.comment}\n                                  onChange={(event) =>\n                                    handleComplianceCommentChange({\n                                      targetId: committee.id,\n                                      targetType: 'committee',\n                                      field: 'comment',\n                                      value: event.target.value\n                                    })\n                                  }\n                                />\n                              </div>\n                              <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n                                <p className=\"text-xs text-gray-500\">\n                                  Le commentaire du comitÃ© est enregistrÃ© dans le rapport projet.\n                                </p>\n                                <div className=\"flex flex-col sm:flex-row sm:items-center gap-2\">\n                                  <button\n                                    type=\"submit\"\n                                    className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all hv-button ${\n                                      canSaveComplianceComment && isDirty\n                                        ? 'bg-blue-600 text-white hover:bg-blue-700 hv-button-primary'\n                                        : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                                    }`}\n                                    disabled={!canSaveComplianceComment || !isDirty}\n                                  >\n                                    Enregistrer le commentaire\n                                  </button>\n                                  {feedbackMessage && (\n                                    <span className=\"text-xs font-medium text-emerald-700\">\n                                      {feedbackMessage}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                            </form>\n                          ) : null}\n\n                          <div className=\"mt-4 space-y-3\">\n                            {visibleMessages.length > 0 ? (\n                              <div className=\"space-y-3\">\n                                {visibleMessages.map((message) => {\n                                  const trimmedMessage = message.message.trim();\n                                  const isTruncated = shouldCollapse && trimmedMessage.length > 240;\n                                  const preview = isTruncated ? `${trimmedMessage.slice(0, 220)}â€¦` : trimmedMessage;\n                                  return (\n                                    <div key={message.id} className=\"rounded-lg bg-white border border-gray-200 p-3\">\n                                      <div className=\"flex items-center justify-between gap-2 text-xs text-gray-500\">\n                                        <span className=\"font-semibold text-gray-700\">{message.authorName}</span>\n                                        {message.createdAt && <span>{formatTimestamp(message.createdAt)}</span>}\n                                      </div>\n                                      <p className=\"mt-2 text-sm text-gray-700 whitespace-pre-line\">\n                                        {renderTextWithLinks(preview)}\n                                      </p>\n                                    </div>\n                                  );\n                                })}\n                                {shouldCollapse && (\n                                  <button\n                                    type=\"button\"\n                                    onClick={() => toggleThreadExpanded(threadKey)}\n                                    className=\"text-xs font-semibold text-blue-600 hover:text-blue-700\"\n                                  >\n                                    Voir plus\n                                  </button>\n                                )}\n                              </div>\n                            ) : (\n                              <p className=\"text-sm text-gray-500\">\n                                Aucun commentaire du comitÃ© pour le moment.\n                              </p>\n                            )}\n                            <div className=\"border-t border-gray-200 pt-3\">\n                              <label className=\"block text-xs font-semibold text-gray-600 uppercase tracking-wide\">\n                                RÃ©pondre\n                              </label>\n                              <textarea\n                                rows={3}\n                                value={complianceReplyDrafts[threadKey] || ''}\n                                onChange={(event) => handleComplianceReplyChange(threadKey, event.target.value)}\n                                className=\"mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200\"\n                                placeholder=\"Votre rÃ©ponse...\"\n                              />\n                              <div className=\"mt-2 flex items-center gap-3\">\n                                <button\n                                  type=\"button\"\n                                  onClick={() =>\n                                    handleComplianceReplySubmit({ targetId: committee.id, targetType: 'committee' })\n                                  }\n                                  className={`px-3 py-2 rounded-lg text-xs font-semibold transition-all ${\n                                    canSaveComplianceComment && (complianceReplyDrafts[threadKey] || '').trim().length > 0\n                                      ? 'bg-blue-600 text-white hover:bg-blue-700'\n                                      : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                                  }`}\n                                  disabled={\n                                    !canSaveComplianceComment\n                                    || (complianceReplyDrafts[threadKey] || '').trim().length === 0\n                                  }\n                                >\n                                  Envoyer la rÃ©ponse\n                                </button>\n                                {feedbackMessage && (\n                                  <span className=\"text-xs font-medium text-emerald-700\">\n                                    {feedbackMessage}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </article>\n                      );\n                    })}\n                  </div>\n                )}\n\n                {hasLegacyComplianceComment && (\n                  <div className=\"rounded-xl border border-dashed border-gray-300 p-4 text-sm text-gray-600\">\n                    <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500\">\n                      Commentaire historique\n                    </p>\n                    <p className=\"mt-2 whitespace-pre-line text-gray-700\">\n                      {renderTextWithLinks(legacyComplianceComment)}\n                    </p>\n                  </div>\n                )}\n              </div>\n            </section>\n          )}\n        </div>\n      </div>\n      {isShowcaseFallbackOpen && (\n        <div ref={showcaseFallbackRef}>\n          <ProjectShowcase\n            projectName={effectiveProjectName}\n            onClose={handleCloseShowcase}\n            analysis={analysis}\n            relevantTeams={relevantTeams}\n            questions={questions}\n            answers={answers}\n            timelineDetails={timelineDetails}\n            onUpdateAnswers={onUpdateAnswers}\n          />\n        </div>\n      )}\n      {attachmentReminder && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black bg-opacity-50\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"attachment-reminder-title\"\n        >\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 sm:p-8 space-y-4 hv-surface hv-modal-panel\">\n            <div className=\"flex items-center justify-center\">\n              <Mail className=\"w-10 h-10 text-blue-600\" aria-hidden=\"true\" />\n            </div>\n            <div className=\"text-center\">\n              <h2 id=\"attachment-reminder-title\" className=\"text-xl font-semibold text-gray-800\">\n                N'oubliez pas la piÃ¨ce jointe JSON\n              </h2>\n              <p className=\"mt-3 text-sm text-gray-600\">\n                Le fichier{' '}\n                <span className=\"font-medium text-gray-900\">{attachmentReminder.fileName}</span>\n                {' '}vient d'Ãªtre tÃ©lÃ©chargÃ©. Ajoutez-le en piÃ¨ce jointe de votre e-mail aux Ã©quipes compliance pour garantir\n                l'intÃ©gration du projet dans la base de donnÃ©es.\n              </p>\n            </div>\n            <div className=\"flex justify-center\">\n              <button\n                type=\"button\"\n                onClick={handleDismissAttachmentReminder}\n                ref={reminderCloseButtonRef}\n                className=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hv-button hv-button-primary\"\n              >\n                Compris\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
  "src/components/VirtualizedList.jsx": "import React, { useCallback, useEffect, useMemo, useRef, useState } from '../react.js';\n\nconst DEFAULT_ESTIMATED_HEIGHT = 280;\nconst DEFAULT_OVERSCAN = 4;\n\nconst getKeyFromProp = (itemKey) => {\n  if (typeof itemKey === 'function') {\n    return itemKey;\n  }\n\n  if (typeof itemKey === 'string') {\n    return (item) => (item ? item[itemKey] : undefined);\n  }\n\n  return (_item, index) => index;\n};\n\nconst findStartIndex = (offsets, sizes, offset) => {\n  let low = 0;\n  let high = offsets.length - 1;\n\n  while (low <= high) {\n    const mid = Math.floor((low + high) / 2);\n    const itemStart = offsets[mid];\n    const itemEnd = itemStart + sizes[mid];\n\n    if (itemEnd < offset) {\n      low = mid + 1;\n    } else {\n      high = mid - 1;\n    }\n  }\n\n  return Math.max(0, Math.min(low, offsets.length - 1));\n};\n\nconst findEndIndex = (offsets, sizes, offset) => {\n  let low = 0;\n  let high = offsets.length - 1;\n\n  while (low <= high) {\n    const mid = Math.floor((low + high) / 2);\n    const itemStart = offsets[mid];\n\n    if (itemStart > offset) {\n      high = mid - 1;\n    } else {\n      low = mid + 1;\n    }\n  }\n\n  return Math.max(0, Math.min(low, offsets.length - 1));\n};\n\nexport const VirtualizedList = ({\n  items = [],\n  itemKey,\n  estimatedItemHeight = DEFAULT_ESTIMATED_HEIGHT,\n  overscan = DEFAULT_OVERSCAN,\n  className,\n  role,\n  renderItem\n}) => {\n  const containerRef = useRef(null);\n  const sizeMapRef = useRef(new Map());\n  const rafRef = useRef(null);\n  const [measureVersion, setMeasureVersion] = useState(0);\n  const [viewportState, setViewportState] = useState({\n    scrollTop: 0,\n    viewportHeight: 0,\n    listTop: 0\n  });\n\n  const resolveKey = useMemo(() => getKeyFromProp(itemKey), [itemKey]);\n  const itemKeys = useMemo(\n    () => items.map((item, index) => resolveKey(item, index)),\n    [items, resolveKey]\n  );\n\n  const itemSizes = useMemo(\n    () => itemKeys.map((key) => sizeMapRef.current.get(key) || estimatedItemHeight),\n    [itemKeys, estimatedItemHeight, measureVersion]\n  );\n\n  const itemOffsets = useMemo(() => {\n    const offsets = [];\n    let currentOffset = 0;\n    for (let index = 0; index < itemSizes.length; index += 1) {\n      offsets.push(currentOffset);\n      currentOffset += itemSizes[index];\n    }\n    return offsets;\n  }, [itemSizes]);\n\n  const totalHeight = itemOffsets.length\n    ? itemOffsets[itemOffsets.length - 1] + itemSizes[itemSizes.length - 1]\n    : 0;\n\n  const handleViewportUpdate = useCallback(() => {\n    if (!containerRef.current) {\n      return;\n    }\n\n    const rect = containerRef.current.getBoundingClientRect();\n    const scrollTop = window.scrollY || window.pageYOffset || 0;\n    const listTop = scrollTop + rect.top;\n    const viewportHeight = window.innerHeight || rect.height || 0;\n\n    setViewportState((prev) => {\n      if (\n        prev.scrollTop === scrollTop &&\n        prev.listTop === listTop &&\n        prev.viewportHeight === viewportHeight\n      ) {\n        return prev;\n      }\n      return { scrollTop, listTop, viewportHeight };\n    });\n  }, []);\n\n  const scheduleViewportUpdate = useCallback(() => {\n    if (rafRef.current) {\n      return;\n    }\n\n    rafRef.current = window.requestAnimationFrame(() => {\n      rafRef.current = null;\n      handleViewportUpdate();\n    });\n  }, [handleViewportUpdate]);\n\n  useEffect(() => {\n    handleViewportUpdate();\n  }, [handleViewportUpdate, items.length]);\n\n  useEffect(() => {\n    window.addEventListener('scroll', scheduleViewportUpdate, { passive: true });\n    window.addEventListener('resize', scheduleViewportUpdate);\n\n    return () => {\n      window.removeEventListener('scroll', scheduleViewportUpdate);\n      window.removeEventListener('resize', scheduleViewportUpdate);\n      if (rafRef.current) {\n        window.cancelAnimationFrame(rafRef.current);\n        rafRef.current = null;\n      }\n    };\n  }, [scheduleViewportUpdate]);\n\n  const updateItemSize = useCallback((key, nextSize) => {\n    if (key === undefined || key === null || !Number.isFinite(nextSize) || nextSize <= 0) {\n      return;\n    }\n\n    const previous = sizeMapRef.current.get(key);\n    if (previous !== nextSize) {\n      sizeMapRef.current.set(key, nextSize);\n      setMeasureVersion((prev) => prev + 1);\n    }\n  }, []);\n\n  const overscanPx = overscan * estimatedItemHeight;\n  const relativeScrollTop = Math.max(0, viewportState.scrollTop - viewportState.listTop);\n  const startOffset = Math.max(0, relativeScrollTop - overscanPx);\n  const endOffset = relativeScrollTop + viewportState.viewportHeight + overscanPx;\n\n  const startIndex = itemOffsets.length ? findStartIndex(itemOffsets, itemSizes, startOffset) : 0;\n  const endIndex = itemOffsets.length ? findEndIndex(itemOffsets, itemSizes, endOffset) : -1;\n\n  const visibleItems = [];\n  for (let index = startIndex; index <= endIndex; index += 1) {\n    if (!items[index]) {\n      continue;\n    }\n\n    visibleItems.push({\n      key: itemKeys[index],\n      item: items[index],\n      index,\n      top: itemOffsets[index]\n    });\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={className}\n      role={role}\n      style={{ position: 'relative', minHeight: totalHeight }}\n    >\n      {visibleItems.map(({ key, item, index, top }) => (\n        <VirtualizedRow\n          key={key ?? index}\n          itemKey={key ?? index}\n          top={top}\n          onSize={updateItemSize}\n        >\n          {renderItem(item, index)}\n        </VirtualizedRow>\n      ))}\n    </div>\n  );\n};\n\nconst VirtualizedRow = ({ children, itemKey, top, onSize }) => {\n  const rowRef = useRef(null);\n\n  useEffect(() => {\n    if (!rowRef.current) {\n      return undefined;\n    }\n\n    const element = rowRef.current;\n    const measure = () => {\n      const height = element.getBoundingClientRect().height;\n      onSize(itemKey, height);\n    };\n\n    measure();\n\n    let observer;\n    if (typeof ResizeObserver !== 'undefined') {\n      observer = new ResizeObserver(() => {\n        measure();\n      });\n      observer.observe(element);\n    }\n\n    return () => {\n      if (observer) {\n        observer.disconnect();\n      }\n    };\n  }, [itemKey, onSize]);\n\n  return (\n    <div ref={rowRef} style={{ position: 'absolute', top, left: 0, right: 0 }}>\n      {children}\n    </div>\n  );\n};\n",
  "src/components/icons.js": "import React from '../react.js';\n\nconst createIcon = (children) => {\n  return ({ className = '', size = 16, strokeWidth = 1.5, ...props }) => (\n    <svg\n      className={className}\n      width={size}\n      height={size}\n      viewBox=\"0 0 24 24\"\n      fill=\"none\"\n      stroke=\"currentColor\"\n      strokeWidth={strokeWidth}\n      strokeLinecap=\"round\"\n      strokeLinejoin=\"round\"\n      aria-hidden=\"true\"\n      focusable=\"false\"\n      {...props}\n    >\n      {typeof children === 'function' ? children({ size, strokeWidth }) : children}\n    </svg>\n  );\n};\n\nexport const ChevronRight = createIcon(\n  <polyline points=\"9 6 15 12 9 18\" />\n);\n\nexport const ChevronLeft = createIcon(\n  <polyline points=\"15 6 9 12 15 18\" />\n);\n\nexport const AlertTriangle = createIcon(\n  <React.Fragment>\n    <path d=\"M10.29 3.86L3.18 16.4a2 2 0 001.71 3h14.22a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z\" />\n    <path d=\"M12 9v4\" />\n    <circle cx=\"12\" cy=\"17\" r=\"0.6\" fill=\"currentColor\" stroke=\"none\" />\n  </React.Fragment>\n);\n\nexport const CheckCircle = createIcon(\n  <React.Fragment>\n    <circle cx=\"12\" cy=\"12\" r=\"9\" />\n    <polyline points=\"8 12 11 15 16 9\" />\n  </React.Fragment>\n);\n\nexport const Settings = createIcon(\n  <React.Fragment>\n    <path d=\"M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06A1.65 1.65 0 004.6 15a1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.6a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09A1.65 1.65 0 0015 4.6a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z\" />\n    <circle cx=\"12\" cy=\"12\" r=\"3\" />\n  </React.Fragment>\n);\n\nexport const Lock = createIcon(\n  <React.Fragment>\n    <rect x=\"5\" y=\"11\" width=\"14\" height=\"10\" rx=\"2\" />\n    <path d=\"M7 11V8a5 5 0 1110 0v3\" />\n  </React.Fragment>\n);\n\nexport const FileText = createIcon(\n  <React.Fragment>\n    <path d=\"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z\" />\n    <polyline points=\"14 2 14 8 20 8\" />\n    <line x1=\"8\" y1=\"13\" x2=\"16\" y2=\"13\" />\n    <line x1=\"8\" y1=\"17\" x2=\"16\" y2=\"17\" />\n  </React.Fragment>\n);\n\nexport const Users = createIcon(\n  <React.Fragment>\n    <path d=\"M17 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2\" />\n    <circle cx=\"9\" cy=\"7\" r=\"4\" />\n    <path d=\"M23 21v-2a4 4 0 00-3-3.87\" />\n    <path d=\"M16 3.13a4 4 0 010 7.75\" />\n  </React.Fragment>\n);\n\nexport const Calendar = createIcon(\n  <React.Fragment>\n    <rect x=\"3\" y=\"4\" width=\"18\" height=\"18\" rx=\"2\" />\n    <line x1=\"16\" y1=\"2\" x2=\"16\" y2=\"6\" />\n    <line x1=\"8\" y1=\"2\" x2=\"8\" y2=\"6\" />\n    <line x1=\"3\" y1=\"10\" x2=\"21\" y2=\"10\" />\n  </React.Fragment>\n);\n\nexport const Info = createIcon(\n  <React.Fragment>\n    <circle cx=\"12\" cy=\"12\" r=\"9\" />\n    <line x1=\"12\" y1=\"10\" x2=\"12\" y2=\"16\" />\n    <circle cx=\"12\" cy=\"7\" r=\"0.6\" fill=\"currentColor\" stroke=\"none\" />\n  </React.Fragment>\n);\n\nexport const Edit = createIcon(\n  <React.Fragment>\n    <path d=\"M4 17.5V20h2.5l9.86-9.86a1.77 1.77 0 00-2.5-2.5z\" />\n    <path d=\"M13.5 6.5l2.5 2.5\" />\n  </React.Fragment>\n);\n\nexport const Plus = createIcon(\n  <React.Fragment>\n    <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\" />\n    <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\" />\n  </React.Fragment>\n);\n\nexport const Trash2 = createIcon(\n  <React.Fragment>\n    <polyline points=\"3 6 5 6 21 6\" />\n    <path d=\"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6\" />\n    <line x1=\"10\" y1=\"11\" x2=\"10\" y2=\"17\" />\n    <line x1=\"14\" y1=\"11\" x2=\"14\" y2=\"17\" />\n    <path d=\"M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2\" />\n  </React.Fragment>\n);\n\nexport const Eye = createIcon(\n  <React.Fragment>\n    <path d=\"M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z\" />\n    <circle cx=\"12\" cy=\"12\" r=\"3\" />\n  </React.Fragment>\n);\n\nexport const GripVertical = createIcon(\n  <React.Fragment>\n    <circle cx=\"9\" cy=\"6\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n    <circle cx=\"15\" cy=\"6\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n    <circle cx=\"9\" cy=\"12\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n    <circle cx=\"15\" cy=\"12\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n    <circle cx=\"9\" cy=\"18\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n    <circle cx=\"15\" cy=\"18\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n  </React.Fragment>\n);\n\nexport const ArrowUp = createIcon(\n  <React.Fragment>\n    <line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"5\" />\n    <polyline points=\"5 12 12 5 19 12\" />\n  </React.Fragment>\n);\n\nexport const ArrowDown = createIcon(\n  <React.Fragment>\n    <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\" />\n    <polyline points=\"5 12 12 19 19 12\" />\n  </React.Fragment>\n);\n\nexport const Send = createIcon(\n  <React.Fragment>\n    <rect x=\"3\" y=\"5\" width=\"18\" height=\"14\" rx=\"2\" />\n    <polyline points=\"3 7 12 13 21 7\" />\n  </React.Fragment>\n);\n\nexport const Link = createIcon(\n  <React.Fragment>\n    <path d=\"M10 13a5 5 0 007.07 0l2.12-2.12a5 5 0 00-7.07-7.07L11 4.93\" />\n    <path d=\"M14 11a5 5 0 00-7.07 0L4.8 13.07a5 5 0 107.07 7.07L13 19.07\" />\n  </React.Fragment>\n);\n\nexport const Sparkles = createIcon(\n  <React.Fragment>\n    <path d=\"M5 3v4\" />\n    <path d=\"M3 5h4\" />\n    <path d=\"M17 15v4\" />\n    <path d=\"M15 17h4\" />\n    <path d=\"M12 7l1.5 4.5L18 13l-4.5 1.5L12 19l-1.5-4.5L6 13l4.5-1.5L12 7z\" />\n  </React.Fragment>\n);\n\nexport const Target = createIcon(\n  <React.Fragment>\n    <circle cx=\"12\" cy=\"12\" r=\"9\" />\n    <circle cx=\"12\" cy=\"12\" r=\"5\" />\n    <circle cx=\"12\" cy=\"12\" r=\"2\" />\n  </React.Fragment>\n);\n\nexport const Rocket = createIcon(\n  <React.Fragment>\n    <path d=\"M12 2c-3 2-5 6-5 10 0 5.5 5 10 5 10s5-4.5 5-10c0-4-2-8-5-10z\" />\n    <circle cx=\"12\" cy=\"10\" r=\"2\" />\n    <path d=\"M9 14l-3 3 4 1 1 4 3-3\" />\n    <path d=\"M15 14l3 3-4 1\" />\n  </React.Fragment>\n);\n\nexport const Compass = createIcon(\n  <React.Fragment>\n    <circle cx=\"12\" cy=\"12\" r=\"9\" />\n    <polygon points=\"12 7 16 12 12 17 8 12\" />\n    <circle cx=\"12\" cy=\"12\" r=\"1\" fill=\"currentColor\" stroke=\"none\" />\n  </React.Fragment>\n);\n\nexport const Close = createIcon(\n  <React.Fragment>\n    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n    <line x1=\"6\" y1=\"18\" x2=\"18\" y2=\"6\" />\n  </React.Fragment>\n);\n\nexport const Download = createIcon(\n  <React.Fragment>\n    <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\" />\n    <polyline points=\"8 11 12 15 16 11\" />\n    <path d=\"M5 19h14\" />\n  </React.Fragment>\n);\n\nexport const Copy = createIcon(\n  <React.Fragment>\n    <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" />\n    <path d=\"M5 15V5a2 2 0 012-2h10\" />\n  </React.Fragment>\n);\n\nexport const Upload = createIcon(\n  <React.Fragment>\n    <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"9\" />\n    <polyline points=\"8 13 12 9 16 13\" />\n    <path d=\"M5 5h14\" />\n  </React.Fragment>\n);\n\nexport const Save = createIcon(\n  <React.Fragment>\n    <path d=\"M5 3h11l3 3v14a1 1 0 01-1 1H6a1 1 0 01-1-1V3z\" />\n    <rect x=\"9\" y=\"13\" width=\"6\" height=\"5\" />\n    <path d=\"M7 3v6h8V3\" />\n  </React.Fragment>\n);\n\nexport const Clipboard = createIcon(\n  <React.Fragment>\n    <rect x=\"5\" y=\"4\" width=\"14\" height=\"18\" rx=\"2\" />\n    <path d=\"M9 2h6a1 1 0 011 1v2a1 1 0 01-1 1H9a1 1 0 01-1-1V3a1 1 0 011-1z\" />\n    <line x1=\"9\" y1=\"10\" x2=\"15\" y2=\"10\" />\n    <line x1=\"9\" y1=\"14\" x2=\"13\" y2=\"14\" />\n  </React.Fragment>\n);\n\nexport const Lightbulb = createIcon(\n  <React.Fragment>\n    <path d=\"M9 18h6\" />\n    <path d=\"M10 22h4\" />\n    <path d=\"M12 2a7 7 0 00-7 7c0 2.76 1.68 4.67 3 6a4 4 0 012 3v2h4v-2a4 4 0 012-3c1.32-1.33 3-3.24 3-6a7 7 0 00-7-7z\" />\n  </React.Fragment>\n);\n\nexport const Mail = createIcon(\n  <React.Fragment>\n    <rect x=\"3\" y=\"5\" width=\"18\" height=\"14\" rx=\"2\" />\n    <polyline points=\"3 7 12 13 21 7\" />\n  </React.Fragment>\n);\n\nexport const MessageSquare = createIcon(\n  <React.Fragment>\n    <path d=\"M21 15a2 2 0 01-2 2H7l-4 3V5a2 2 0 012-2h14a2 2 0 012 2z\" />\n  </React.Fragment>\n);\n\nexport const Pause = createIcon(\n  <React.Fragment>\n    <rect x=\"6\" y=\"4\" width=\"4\" height=\"16\" rx=\"1\" />\n    <rect x=\"14\" y=\"4\" width=\"4\" height=\"16\" rx=\"1\" />\n  </React.Fragment>\n);\n\nexport const Play = createIcon(\n  <React.Fragment>\n    <polygon points=\"6 4 20 12 6 20 6 4\" />\n  </React.Fragment>\n);\n\nexport { createIcon };\n",
  "src/data/adminEmails.js": "export const initialAdminEmails = [\n  \"antoine.lassauge@lfb.fr\"\n];\n",
  "src/data/demoProject.js": "import { initialQuestions } from './questions.js';\nimport { initialRules } from './rules.js';\nimport { initialRiskLevelRules } from './riskLevelRules.js';\nimport { initialRiskWeights } from './riskWeights.js';\nimport { analyzeAnswers } from '../utils/rules.js';\n\nconst COMPLIANCE_COMMENTS_KEY = '__compliance_team_comments__';\n\nconst demoProjectAnswers = {\n  projectName: 'Plasma 360',\n  showcaseTheme: 'Universel',\n  projectSlogan: 'Du don Ã  la vie : dÃ©couvrez comment chaque goutte de plasma devient un traitement vital',\n  targetAudience: ['Grand public', 'Patients', 'Professionnels de santÃ©'],\n  problemPainPoints:\n    'Les professionnels de santÃ© manquent souvent de supports pÃ©dagogiques simples et fiables pour expliquer Ã  leurs patients comment les mÃ©dicaments dÃ©rivÃ©s du plasma sont fabriquÃ©s.\\nLe grand public a une perception floue du lien entre le don de plasma et la production de traitements : le processus industriel leur semble abstrait.',\n  solutionDescription:\n    'Plasma360 est une plateforme web immersive et Ã©ducative qui raconte le parcours du plasma, depuis le don jusquâ€™au mÃ©dicament final.\\nLe site propose :\\n- Une expÃ©rience interactive et visuelle retraÃ§ant Ã©tape par Ã©tape le processus de fractionnement.\\n- Deux parcours de navigation : un mode grand public, simple et narratif, et un mode professionnel, plus technique et structurÃ©.\\n- Des vidÃ©os immersives tournÃ©es sur les sites du LFB.\\n- Une bibliothÃ¨que de contenus avec infographies, fiches explicatives et ressources tÃ©lÃ©chargeables.',\n  solutionBenefits:\n    'Une meilleure comprÃ©hension du rÃ´le du LFB et de la valeur du plasma comme matiÃ¨re premiÃ¨re vitale.\\nUne valorisation du savoir-faire industriel franÃ§ais, avec des contenus authentiques et validÃ©s.\\nUn outil de communication rÃ©utilisable pour la formation, la sensibilisation et les relations institutionnelles.\\nUn renforcement de la confiance entre le LFB, les professionnels de santÃ© et le grand public.',\n  solutionComparison:\n    'Plasma360 se distingue par son format interactif et immersif, lÃ  oÃ¹ la plupart des ressources actuelles se limitent Ã  des documents statiques ou des vidÃ©os isolÃ©es.\\nLe site proposera une double lecture adaptÃ©e Ã  chaque public, des contenus validÃ©s scientifiquement et un ancrage fort sur le savoir-faire industriel franÃ§ais.',\n  innovationProcess:\n    'Renforcer la comprÃ©hension et la confiance envers les mÃ©dicaments dÃ©rivÃ©s du plasma.\\nValoriser la mission sociÃ©tale et le rÃ´le industriel du LFB.\\nAccroÃ®tre la notoriÃ©tÃ© du LFB auprÃ¨s des professionnels et du grand public.\\nCrÃ©er un actif digital durable, rÃ©utilisable pour la formation et la communication.',\n  visionStatement:\n    'Nombre de visiteurs uniques mensuels.\\nTemps moyen passÃ© sur les pages.\\nTaux de complÃ©tion du parcours interactif.\\nNombre de tÃ©lÃ©chargements de ressources et de quiz complÃ©tÃ©s.\\nMentions ou citations du site sur les rÃ©seaux sociaux et dans la presse spÃ©cialisÃ©e.',\n  campaignKickoffDate: '2025-11-03',\n  launchDate: '2025-12-20',\n  roadmapMilestones: [\n    {\n      date: '2025-10-01',\n      description: 'Validation du concept et du budget'\n    },\n    {\n      date: '2025-10-15',\n      description: 'Atelier immersif avec les Ã©quipes mÃ©tiers pour dÃ©finir le parcours interactif'\n    },\n    {\n      date: '2025-11-05',\n      description: 'Production des contenus vidÃ©os et rÃ©daction des fiches pÃ©dagogiques'\n    },\n    {\n      date: '2025-11-25',\n      description: 'Recette utilisateur sur un panel mixte grand public / professionnels'\n    }\n  ],\n  teamLead: 'Bertrand Darieux',\n  teamLeadTeam: 'Marketing',\n  teamCoreMembers:\n    'Julien Morel - Directeur du site de production de Lille\\nClaire Martin - Responsable MÃ©dicale\\nSophie Leclerc - Responsable Communication Digitale\\nStudio Nova - Agence de communication scientifique et design interactif',\n  ProjectType: ['Support d\\'information / sensibilisation'],\n  q11: ['Site internet', 'Communication sur les rÃ©seaux sociaux'],\n  q3: ['Oui - DonnÃ©es personnelles standard'],\n  q13: 'Oui',\n  q10: ['Prestataire de service', 'Professionnel de santÃ© (via contrat Ã  mettre en place)'],\n  BUDGET: '30'\n};\n\ndemoProjectAnswers[COMPLIANCE_COMMENTS_KEY] = {\n  teams: {\n    com: {\n      comment:\n        'Le dispositif de communication est validÃ© sous rÃ©serve de soumettre les visuels finaux pour contrÃ´le.',\n      status: 'validated_with_conditions'\n    },\n    legal: {\n      comment: 'Le parcours contractuel est conforme aux exigences rÃ©glementaires.',\n      status: 'validated'\n    }\n  },\n  committees: {\n    'committee-default': {\n      comment: 'Le comitÃ© valide le lancement avec un suivi mensuel des indicateurs de risque.',\n      status: 'validated'\n    }\n  }\n};\n\nconst DEMO_VERSION = 1;\nconst DEMO_TIMESTAMP = '2025-10-19T06:08:36.021Z';\n\nexport const createDemoProject = ({\n  questions = initialQuestions,\n  rules = initialRules,\n  riskLevelRules = initialRiskLevelRules,\n  riskWeights = initialRiskWeights\n} = {}) => {\n  const analysis = analyzeAnswers(demoProjectAnswers, rules, riskLevelRules, riskWeights);\n  const totalQuestions = Array.isArray(questions) ? questions.length : Object.keys(demoProjectAnswers).length;\n  const sanitizedTotal = totalQuestions > 0 ? totalQuestions : Object.keys(demoProjectAnswers).length;\n\n  return {\n    id: 'demo-project',\n    version: DEMO_VERSION,\n    projectName: demoProjectAnswers.projectName,\n    answers: { ...demoProjectAnswers },\n    metadata: {\n      version: DEMO_VERSION,\n      generatedAt: DEMO_TIMESTAMP,\n      project: {\n        name: demoProjectAnswers.projectName,\n        projectName: demoProjectAnswers.projectName,\n        answers: { ...demoProjectAnswers }\n      }\n    },\n    analysis,\n    status: 'submitted',\n    generatedAt: DEMO_TIMESTAMP,\n    lastUpdated: DEMO_TIMESTAMP,\n    submittedAt: DEMO_TIMESTAMP,\n    lastQuestionIndex: sanitizedTotal > 0 ? sanitizedTotal - 1 : 0,\n    totalQuestions: sanitizedTotal,\n    answeredQuestions: sanitizedTotal,\n    isDemo: true\n  };\n};\n\nexport const demoProjectAnswersSnapshot = { ...demoProjectAnswers };\n",
  "src/data/inspirationProjects.js": "export const initialInspirationProjects = [\n  {\n    id: 'inspiration-aurora',\n    title: 'Aurora Care Hub',\n    labName: 'Laboratoire Aurora',\n    target: 'Patient',\n    typology: 'Digital',\n    therapeuticArea: 'Immunologie',\n    country: 'France',\n    description:\n      \"Programme digital de suivi pour amÃ©liorer l'observance des patients atteints de maladies auto-immunes.\",\n    link: 'https://example.com/aurora-care',\n    documents: [\n      {\n        name: 'PrÃ©sentation du programme',\n        url: 'https://example.com/docs/aurora-care.pdf'\n      }\n    ],\n    review:\n      \"Excellente dÃ©monstration d'un parcours patient digital avec des contenus Ã©ducatifs ciblÃ©s.\",\n    visibility: 'shared',\n    createdAt: '2024-03-12T09:00:00.000Z',\n    updatedAt: '2024-03-12T09:00:00.000Z'\n  }\n];\n",
  "src/data/onboardingTour.js": "export const initialOnboardingTourConfig = {\n  \"allowClose\": true,\n  \"showStepDots\": true,\n  \"labels\": {\n    \"next\": \"Suivant\",\n    \"prev\": \"PrÃ©cÃ©dent\",\n    \"close\": \"Fermer\",\n    \"finish\": \"Terminer\"\n  },\n  \"steps\": [\n    {\n      \"id\": \"welcome\",\n      \"target\": \"#tour-onboarding-anchor\",\n      \"title\": \"Bienvenue sur Project Navigator\",\n      \"content\": \"DÃ©couvrons ensemble comment cadrer votre projet pas Ã  pas.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": false,\n      \"actions\": [\n        {\n          \"id\": \"path-full\",\n          \"label\": \"Parcours complet\",\n          \"action\": \"next\",\n          \"stepId\": \"\",\n          \"variant\": \"primary\"\n        },\n        {\n          \"id\": \"path-showcase\",\n          \"label\": \"Voir la vitrine\",\n          \"action\": \"goTo\",\n          \"stepId\": \"showcase-top\",\n          \"variant\": \"ghost\"\n        }\n      ]\n    },\n    {\n      \"id\": \"create-project\",\n      \"target\": \"[data-tour-id=\\\"home-create-project\\\"]\",\n      \"title\": \"Lancer un nouveau projet\",\n      \"content\": \"Cliquez ici pour dÃ©marrer. Nous allons utiliser un projet de dÃ©monstration pour lâ€™exemple.\",\n      \"placement\": \"bottom\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"question-overview\",\n      \"target\": \"[data-tour-id=\\\"question-main-content\\\"]\",\n      \"title\": \"RÃ©pondre aux questions\",\n      \"content\": \"Renseignez les informations demandÃ©es Ã©tape par Ã©tape pour qualifier votre initiative.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"question-guidance\",\n      \"target\": \"[data-tour-id=\\\"question-guidance-toggle\\\"]\",\n      \"title\": \"Comprendre chaque question\",\n      \"content\": \"Chaque Ã©tape propose des conseils contextualisÃ©s pour rÃ©pondre sereinement.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"project-save-anytime\",\n      \"target\": \"[data-tour-id=\\\"question-save-draft\\\"]\",\n      \"title\": \"Sauvegarder Ã  tout moment\",\n      \"content\": \"TÃ©lÃ©chargez un brouillon de votre projet quand vous le souhaitez et rechargez-le depuis lâ€™accueil. Attention, il n'y a pas de sauvegarde automatique.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"questionnaire-finish\",\n      \"target\": \"[data-tour-id=\\\"questionnaire-finish\\\"]\",\n      \"title\": \"Fin du formulaire\",\n      \"content\": \"Sur la derniÃ¨re question, cliquez sur â€œVoir la synthÃ¨seâ€ pour accÃ©der au rapport complet.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-report-top\",\n      \"target\": \"[data-tour-id=\\\"synthesis-summary\\\"]\",\n      \"title\": \"Lire le rapport de compliance\",\n      \"content\": \"Retrouvez ici le rÃ©sumÃ© du projet avec l'ensemble des informations que vous avez remplies. Vous pouvez revenir en arriÃ¨re pour les modifier.\",\n      \"placement\": \"\",\n      \"scrollIntoViewOptions\": {\n        \"behavior\": \"smooth\",\n        \"block\": \"start\",\n        \"inline\": \"nearest\"\n      },\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-teams\",\n      \"target\": \"[data-tour-id=\\\"synthesis-teams\\\"]\",\n      \"title\": \"Identifier les Ã©quipes compliance\",\n      \"content\": \"Visualisez les interlocuteurs clÃ©s, leurs prioritÃ©s et les questions Ã  anticiper pour prÃ©parer vos Ã©changes.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-risks\",\n      \"target\": \"[data-tour-id=\\\"synthesis-risks\\\"]\",\n      \"title\": \"Risques et points de vigilance\",\n      \"content\": \"Analysez les risques identifiÃ©s et les points de vigilance compliance Ã  adresser en prioritÃ©.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-submit\",\n      \"target\": \"[data-tour-id=\\\"synthesis-submit\\\"]\",\n      \"title\": \"Soumettre le projet\",\n      \"content\": \"Envoyez votre rapport directement par e-mail aux Ã©quipes concernÃ©es.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-save\",\n      \"target\": \"[data-tour-id=\\\"synthesis-save\\\"]\",\n      \"title\": \"Sauvegarder depuis la synthÃ¨se\",\n      \"content\": \"TÃ©lÃ©chargez le fichier du projet pour le partager ou le reprendre ultÃ©rieurement.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"compliance-showcase-button\",\n      \"target\": \"[data-tour-id=\\\"synthesis-showcase\\\"]\",\n      \"title\": \"Ouvrir la vitrine du projet\",\n      \"content\": \"AccÃ©dez Ã  la vitrine du projet gÃ©nÃ©rÃ©e automatiquement pour prÃ©senter votre initiative.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-top\",\n      \"target\": \"[data-tour-id=\\\"showcase-hero\\\"]\",\n      \"title\": \"PrÃ©senter votre projet\",\n      \"content\": \"Parcourez la vitrine prÃ©sentant votre projet avec une mise en page le mettant en valeur. Parfait pour une prÃ©sentation Ã  votre manager !\",\n      \"placement\": \"\",\n      \"scrollIntoViewOptions\": {\n        \"behavior\": \"smooth\",\n        \"block\": \"center\",\n        \"inline\": \"nearest\"\n      },\n      \"scrollDuration\": 5200,\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-bottom\",\n      \"target\": \"[data-tour-id=\\\"showcase-roadmap\\\"]\",\n      \"title\": \"Explorer la suite de la vitrine\",\n      \"content\": \"Vous retrouvez sur la vitrine les jalons de votre projet mais Ã©galement les alertes liÃ©es Ã  des problÃ©matiques de respect de certains dÃ©lais.\",\n      \"placement\": \"\",\n      \"scrollIntoViewOptions\": {\n        \"behavior\": \"smooth\",\n        \"block\": \"center\",\n        \"inline\": \"nearest\"\n      },\n      \"scrollDuration\": 3200,\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-edit-trigger\",\n      \"target\": \"[data-tour-id=\\\"showcase-edit-trigger\\\"]\",\n      \"title\": \"Modifier la vitrine\",\n      \"content\": \"Activez le mode Ã©dition pour ajuster les contenus avant diffusion.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-edit\",\n      \"target\": \"[data-tour-id=\\\"showcase-edit-panel\\\"]\",\n      \"title\": \"Personnaliser la vitrine\",\n      \"content\": \"Adaptez textes, messages clÃ©s et jalons pour reflÃ©ter fidÃ¨lement votre projet. Ses informations sont automatiquement mise Ã  jour dans le rapport de compliance.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-custom-sections\",\n      \"target\": \"[data-tour-id=\\\"showcase-edit-panel\\\"]\",\n      \"title\": \"CrÃ©er des sections personnalisÃ©es\",\n      \"content\": \"Ajoutez des sections sur-mesure avec diffÃ©rents modÃ¨les : listes, colonnes, accroches et mÃªme des blocs qui intÃ¨grent des documents (PDF, slides, etc.).\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-save-edits\",\n      \"target\": \"[data-tour-id=\\\"showcase-save-edits\\\"]\",\n      \"title\": \"Enregistrer les modifications\",\n      \"content\": \"Validez vos ajustements pour mettre Ã  jour immÃ©diatement la vitrine.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-display-modes\",\n      \"target\": \"[data-tour-id=\\\"showcase-display-modes\\\"]\",\n      \"title\": \"Choisir lâ€™affichage & activer les commentaires\",\n      \"content\": \"SÃ©lectionnez un affichage Light ou complet pour masquer certaines informations pendant vos prÃ©sentations. Lors du partage, vous pouvez aussi autoriser les commentaires : des post-its fictifs illustrent le rÃ©sultat.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-comments\",\n      \"target\": \"[data-tour-id=\\\"showcase-hero\\\"]\",\n      \"title\": \"Les commentaires\",\n      \"content\": \"La vitrine peut Ãªtre commentÃ©e : les post-its sâ€™affichent directement sur la vitrine pour recueillir les retours des parties prenantes.\",\n      \"placement\": \"bottom\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"showcase-back-to-report\",\n      \"target\": \"[data-tour-id=\\\"showcase-back-to-report\\\"]\",\n      \"title\": \"Retourner Ã  la synthÃ¨se\",\n      \"content\": \"Revenez au rapport de synthÃ¨se pour poursuivre votre prÃ©paration et Ã©ventuellement enregistrer la derniÃ¨re version de votre projet.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"project-import\",\n      \"target\": \"[data-tour-id=\\\"home-import-project\\\"]\",\n      \"title\": \"Charger un projet existant\",\n      \"content\": \"Vous pouvez importer un projet enregistrer pour reprendre son Ã©dition avant soumission Ã  la compliance.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    },\n    {\n      \"id\": \"project-filters\",\n      \"target\": \"[data-tour-id=\\\"home-filters\\\"]\",\n      \"title\": \"DÃ©couvrir les projets\",\n      \"content\": \"Filtrez les initiatives par nom, Ã©quipe ou date et laissez vous inspirer.\",\n      \"placement\": \"\",\n      \"showDefaultButtons\": true,\n      \"actions\": []\n    }\n  ]\n};\n",
  "src/data/questions.js": "export const initialQuestions = [\n  {\n    \"id\": \"projectName\",\n    \"type\": \"text\",\n    \"question\": \"Quel est le nom du projet ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Nommer clairement l'initiative pour qu'elle soit mÃ©morisÃ©e dÃ¨s les premiÃ¨res secondes.\",\n      \"details\": \"Le nom affichÃ© dans la vitrine du projet sert de repÃ¨re pour toutes les Ã©quipes qui contribuent au pitch.\",\n      \"tips\": [\n        \"Renseignez le nom officiel ou celui que vous souhaitez tester auprÃ¨s des parties prenantes.\",\n        \"Si un nom de code interne existe, ajoutez-le entre parenthÃ¨ses pour faciliter le suivi.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Titre principal affichÃ© dans la vitrine du projet.\"\n    }\n  },\n  {\n    \"id\": \"teamLead\",\n    \"type\": \"text\",\n    \"question\": \"Qui lead ce projet ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier l'interlocuteur principal pour les Ã©changes compliance\",\n      \"details\": \"Cette information permet aux Ã©quipes expertes de contacter la bonne personne pour clarifier les Ã©lÃ©ments du dossier.\",\n      \"tips\": [\n        \"Renseignez le prÃ©nom et le nom\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Bloc Â« Lead du projet Â» dans la section Ã©quipe.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"teamLeadTeam\",\n    \"type\": \"choice\",\n    \"question\": \"Ã‰quipe Ã  laquelle cette personne appartient\",\n    \"options\": [\n      \"Marketing\",\n      \"MÃ©dical\",\n      \"AccÃ¨s\",\n      \"Vente\",\n      \"Digital\",\n      \"Autre\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"PrÃ©ciser le rattachement du lead pour fluidifier les validations.\",\n      \"details\": \"Cette information sâ€™affiche en complÃ©ment du lead pour aider les interlocuteurs Ã  identifier le bon canal.\",\n      \"tips\": [\n        \"SÃ©lectionnez lâ€™Ã©quipe principale du lead.\",\n        \"PrÃ©cisez une double appartenance dans vos notes internes si nÃ©cessaire.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Mention du rattachement du lead dans la section Ã©quipe.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"ProjectType\",\n    \"type\": \"multi_choice\",\n    \"question\": \"De quel type de projet s'agit-il ?\",\n    \"options\": [\n      \"Parrainage / Partenariat\",\n      \"Support d'information / sensibilisation\",\n      \"Outil d'aide Ã  la dÃ©cision\",\n      \"Outil d'optimisation de la prise en charge des patients\",\n      \"Autre\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Identifier le type de projet pour connaitre les procÃ©dures applicables\",\n      \"details\": \"En fonction de la catÃ©gorie du projet sÃ©lectionnÃ©, nous vous poserons des questions supplÃ©mentaires pour affiner le projet et ainsi vous guider au mieux\",\n      \"tips\": [\n        \"En cas de doute, sÃ©lectionner les diffÃ©rentes catÃ©gories applicables\"\n      ]\n    }\n  },\n  {\n    \"id\": \"targetAudience\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Ã€ qui s'adresse votre projet ?\",\n    \"options\": [\n      \"Grand public\",\n      \"Patients\",\n      \"Professionnels de santÃ©\",\n      \"Acheteurs\",\n      \"Collaborateurs du LFB\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier les destinataires du projet\",\n      \"details\": \"En fonction de la cible, les rÃ¨gles de validation ne seront pas les mÃªmes\",\n      \"tips\": [\n        \"Choisissez l'ensemble des personnes auxquelles votre projet s'adresse\",\n        \"Ne sÃ©lectionnez \\\"Interne Ã  LFB\\\" que si le projet s'adresse aux collaborateurs du LFB (ex : un site intranet)\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Badge Â« Audience principale Â» dans le bandeau de la vitrine.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"showcaseTheme\",\n    \"type\": \"choice\",\n    \"question\": \"Quel thÃ¨me souhaitez-vous pour la vitrine ?\",\n    \"options\": [\n      \"Universel\",\n      \"Produit\",\n      \"Cupertino\",\n      \"Lumen\",\n      \"Voyage\",\n      \"Arena\",\n      \"Prism\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"SÃ©lectionner la palette de couleurs qui servira de base Ã  la vitrine du projet.\",\n      \"details\": \"Chaque thÃ¨me peut Ãªtre ajustÃ© dans le back-office grÃ¢ce aux color-pickers (fond, dÃ©gradÃ©s, accents). Choisissez celui qui correspond le mieux Ã  votre projet.\",\n      \"tips\": [\n        \"Universel : reprend l'identitÃ© visuelle actuelle de la vitrine.\",\n        \"Produit : palette solaire et contrastÃ©e pour valoriser une offre produit.\",\n        \"Cupertino : minimalisme lumineux inspirÃ© dâ€™Apple.\",\n        \"Lumen : dÃ©gradÃ©s nÃ©on et profondeur faÃ§on Stripe.\",\n        \"Voyage : chaleur AirBnB, accent corail et accueil doux.\",\n        \"Arena : contrastes sportifs et Ã©nergie Nike.\",\n        \"Prism : gradients vibrants inspirÃ©s dâ€™Instagram.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Pilote les couleurs et dÃ©gradÃ©s utilisÃ©s dans l'ensemble de la vitrine.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"projectSlogan\",\n    \"type\": \"text\",\n    \"question\": \"Quel slogan pour votre projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"RÃ©sumer l'accroche en moins de 10 mots pour capter l'attention immÃ©diatement.\",\n      \"details\": \"Le slogan apparaÃ®t dans la hero section et doit Ãªtre simple, mÃ©morable et orientÃ© bÃ©nÃ©fice.\",\n      \"tips\": [\n        \"Utilisez un verbe dâ€™action qui Ã©voque le rÃ©sultat attendu.\",\n        \"PrÃ©fÃ©rez un ton conversationnel : adressez-vous directement Ã  votre audience.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"hero\"\n      ],\n      \"usage\": \"Promesse courte situÃ©e sous le nom du projet.\"\n    }\n  },\n  {\n    \"id\": \"problemPainPoints\",\n    \"type\": \"long_text\",\n    \"question\": \"Listez 2 Ã  3 besoins concrets vÃ©cus par vos utilisateurs et que votre projet vient solutionner.\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Montrer que vous comprenez les besoins prioritaires de votre audience.\",\n      \"details\": \"Chaque besoin sâ€™affichera comme un bullet point pour renforcer lâ€™empathie.\",\n      \"tips\": [\n        \"Utilisez une ligne par besoin pour faciliter la lecture.\",\n        \"DÃ©crivez la situation vÃ©cue plutÃ´t que la solution souhaitÃ©e.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"problem\"\n      ],\n      \"usage\": \"Liste des irritants principaux affichÃ©e dans la colonne de gauche.\"\n    }\n  },\n  {\n    \"id\": \"solutionDescription\",\n    \"type\": \"long_text\",\n    \"question\": \"DÃ©crivez en quoi consiste votre solution.\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Clarifier lâ€™expÃ©rience proposÃ©e avant de dÃ©tailler les bÃ©nÃ©fices.\",\n      \"details\": \"Cette description introduit la section â€œSolutionâ€ et doit rester simple Ã  comprendre.\",\n      \"tips\": [\n        \"Structurez en 2-3 phrases : quoi, pour qui, comment.\",\n        \"Ã‰vitez le vocabulaire interne : imaginez que vous prÃ©sentez le concept Ã  un prospect.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Bloc Â« ExpÃ©rience proposÃ©e Â» dans la partie solution.\"\n    }\n  },\n  {\n    \"id\": \"q11\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Quels sont les livrables associÃ©s au projet ?\",\n    \"options\": [\n      \"Site internet\",\n      \"Communication sur les rÃ©seaux sociaux\",\n      \"Application mobile / web app\",\n      \"MatÃ©riel promotionnel\",\n      \"MatÃ©riel environnement\",\n      \"Publication scientifique\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"\",\n      \"details\": \"\",\n      \"tips\": []\n    }\n  },\n  {\n    \"id\": \"q3\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Collectez-vous des donnÃ©es dans le cadre de votre projet / solution ?\",\n    \"options\": [\n      \"Oui - DonnÃ©es de santÃ©\",\n      \"Oui - Autre donnÃ©es sensibles\",\n      \"Oui - DonnÃ©es personnelles standard\",\n      \"Non\"\n    ],\n    \"required\": true,\n    \"conditions\": [\n      {\n        \"question\": \"q11\",\n        \"operator\": \"contains\",\n        \"value\": \"Site internet\"\n      },\n      {\n        \"question\": \"q11\",\n        \"operator\": \"contains\",\n        \"value\": \"Application mobile / web app\"\n      }\n    ],\n    \"guidance\": {\n      \"objective\": \"Qualifier la nature des donnÃ©es personnelles manipulÃ©es.\",\n      \"details\": \"Les donnÃ©es de santÃ© impliquent une analyse d'impact renforcÃ©e (DPIA), un hÃ©bergement certifiÃ© HDS et des clauses contractuelles spÃ©cifiques.\",\n      \"tips\": [\n        \"Si la collecte est incertaine, retenez l'hypothÃ¨se la plus protectrice pour planifier les validations.\"\n      ]\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": [\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"q11\",\n            \"operator\": \"contains\",\n            \"value\": \"Site internet\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"contains\",\n            \"value\": \"Application mobile / web app\"\n          }\n        ]\n      }\n    ],\n    \"conditionLogic\": \"any\"\n  },\n  {\n    \"id\": \"q13\",\n    \"type\": \"choice\",\n    \"question\": \"Votre solution contiendra-t-elle des champs libres ?\",\n    \"options\": [\n      \"Oui\",\n      \"Non\"\n    ],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Grand public\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Patients\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Professionnels de santÃ©\"\n          },\n          {\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Acheteurs\"\n          }\n        ]\n      },\n      {\n        \"logic\": \"any\",\n        \"conditions\": [\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Site internet\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Application mobile / web app\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"MatÃ©riel promotionnel\"\n          },\n          {\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"MatÃ©riel environnement\"\n          }\n        ]\n      }\n    ],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Les champs libres peuvent crÃ©er des obligations de PV\",\n      \"details\": \"DÃ¨s lors qu'un champs libre est prÃ©sent, il convient de mettre en place un systÃ¨me de monitoring\",\n      \"tips\": [\n        \"Les champs libres ne sont pas problÃ©matiques en soi ! Il convient juste de mettre les bons contrÃ´les en place\"\n      ]\n    }\n  },\n  {\n    \"id\": \"solutionBenefits\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels bÃ©nÃ©fices tangibles votre solution apporte-t-elle ?\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Mettre en avant les rÃ©sultats obtenus plutÃ´t que les fonctionnalitÃ©s.\",\n      \"details\": \"Chaque ligne sera transformÃ©e en bÃ©nÃ©fice clÃ© dans la vitrine.\",\n      \"tips\": [\n        \"RÃ©digez une phrase par bÃ©nÃ©fice, orientÃ©e rÃ©sultat (â€œGain de 2h par semaineâ€).\",\n        \"Priorisez les bÃ©nÃ©fices les plus diffÃ©renciants pour votre audience.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Liste des bÃ©nÃ©fices clÃ©s dans la section solution.\"\n    }\n  },\n  {\n    \"id\": \"solutionComparison\",\n    \"type\": \"long_text\",\n    \"question\": \"En quoi cette solution se distingue-t-elle des alternatives actuelles ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Souligner la diffÃ©renciation sans dÃ©nigrer la concurrence.\",\n      \"details\": \"Cette rÃ©ponse apparaÃ®t dans la section â€œSolutionâ€ comme une comparaison subtile.\",\n      \"tips\": [\n        \"Comparez-vous Ã  un comportement ou Ã  une solution existante plutÃ´t quâ€™Ã  un concurrent direct.\",\n        \"Appuyez-vous sur un bÃ©nÃ©fice mesurable ou une expÃ©rience utilisateur plus fluide.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"solution\"\n      ],\n      \"usage\": \"Bloc Â« Pourquoi câ€™est diffÃ©rent Â» dans la section solution.\"\n    }\n  },\n  {\n    \"id\": \"q10\",\n    \"type\": \"multi_choice\",\n    \"question\": \"Allez-vous impliquer un ou plusieurs partenaires ?\",\n    \"options\": [\n      \"Prestataire de service\",\n      \"Etablissement de santÃ©\",\n      \"Professionnel de santÃ© (via contrat Ã  mettre en place)\",\n      \"SociÃ©tÃ© savante / association de PDS\",\n      \"Association de patients\"\n    ],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"guidance\": {\n      \"objective\": \"Anticiper l'implication de prestataires externes et les contrÃ´les associÃ©s\",\n      \"details\": \"Les partenariats imposent une revue juridique des contrats, et parfois des dÃ©lais supplÃ©mentaires liÃ©s Ã  des obligations de dÃ©claration / demande d'autorisation aux autoritÃ©s\",\n      \"tips\": []\n    }\n  },\n  {\n    \"id\": \"BUDGET\",\n    \"type\": \"number\",\n    \"question\": \"Quel est le coÃ»t estimÃ© du projet ? (en Kâ‚¬)\",\n    \"options\": [],\n    \"required\": true,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [],\n    \"placeholder\": \"\",\n    \"numberUnit\": \"Kâ‚¬\",\n    \"guidance\": {\n      \"objective\": \"\",\n      \"details\": \"\",\n      \"tips\": []\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"impact\"\n      ],\n      \"usage\": \"Carte Â« Budget estimÃ© Â» dans la section impact.\"\n    }\n  },\n  {\n    \"id\": \"innovationProcess\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels sont vos objectifs derriÃ¨res ce projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier l'intÃ©rÃªt business du projet\",\n      \"details\": \"Cette rÃ©ponse vous permet de mettre en avant la valeur gÃ©nÃ©rÃ©e du projet pour le LFB\",\n      \"tips\": [\n        \"Soyez prÃ©cis dans la description de votre objectif\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"innovation\"\n      ],\n      \"usage\": \"Encart explicatif sur le fonctionnement de lâ€™innovation.\"\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"visionStatement\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels indicateurs allez-vous suivre pour mesurer l'impact du projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Montrer comment vous suivrez concrÃ¨tement la crÃ©ation de valeur.\",\n      \"details\": \"Chaque indicateur sâ€™affichera comme un point clÃ© dans la section impact pour rassurer les parties prenantes.\",\n      \"tips\": [\n        \"Listez une mÃ©trique par ligne (quantitative ou qualitative).\",\n        \"PrÃ©cisez la cible ou la frÃ©quence de suivi lorsque câ€™est pertinent.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"impact\"\n      ],\n      \"usage\": \"Citation de conclusion dans la section impact.\"\n    }\n  },\n  {\n    \"id\": \"campaignKickoffDate\",\n    \"type\": \"date\",\n    \"question\": \"Ã€ quelle date allez-vous soumettre ce projet Ã  la compliance ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Poser le jalon officiel de passage en revue compliance.\",\n      \"details\": \"Cette date permet dâ€™anticiper les Ã©changes de validation et le temps de traitement.\",\n      \"tips\": [\n        \"Indiquez la date dâ€™envoi du dossier complet Ã  la compliance.\",\n        \"Mettez Ã  jour la date dÃ¨s quâ€™un nouveau crÃ©neau est confirmÃ©.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Point de dÃ©part utilisÃ© pour calculer le runway et les prochaines Ã©tapes.\"\n    }\n  },\n  {\n    \"id\": \"launchDate\",\n    \"type\": \"date\",\n    \"question\": \"Quelle est la date de lancement souhaitÃ©e ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Aligner toutes les parties prenantes sur la cible de lancement.\",\n      \"details\": \"AssociÃ©e Ã  la date de soumission compliance, cette information permet de vÃ©rifier la faisabilitÃ© du planning.\",\n      \"tips\": [\n        \"Renseignez la premiÃ¨re date de mise en avant (Ã©vÃ©nement, publication, annonce).\",\n        \"Si la date nâ€™est pas figÃ©e, indiquez lâ€™hypothÃ¨se la plus rÃ©aliste pour planifier les ressources.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Date cible utilisÃ©e pour le calcul du runway et du calendrier.\"\n    }\n  },\n  {\n    \"id\": \"roadmapMilestones\",\n    \"type\": \"milestone_list\",\n    \"question\": \"Quels jalons clÃ©s souhaitez-vous mettre en avant ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Projeter les Ã©tapes majeures Ã  venir pour synchroniser les parties prenantes.\",\n      \"details\": \"Chaque jalon affichera une date et un descriptif dans la section feuille de route de la vitrine.\",\n      \"tips\": [\n        \"Utilisez un format AAAA-MM-JJ pour les dates afin de faciliter la lecture.\",\n        \"Formulez des descriptions actionnables : validation, lancement partiel, publication clÃ©, etc.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"timeline\"\n      ],\n      \"usage\": \"Liste de jalons personnalisÃ©s dans la section Â« Les prochains jalons Â».\"\n    }\n  },\n  {\n    \"id\": \"teamCoreMembers\",\n    \"type\": \"long_text\",\n    \"question\": \"Quels sont les membres de l'Ã©quipe projet ?\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Mettre en avant la complÃ©mentaritÃ© de lâ€™Ã©quipe.\",\n      \"details\": \"Chaque ligne sera affichÃ©e comme un membre du â€œcollectif moteurâ€.\",\n      \"tips\": [\n        \"Mentionnez pour chaque personne le rÃ´le ou lâ€™expertise apportÃ©e.\",\n        \"Incluez Ã©ventuellement les partenaires ou experts externes essentiels.\"\n      ]\n    },\n    \"showcase\": {\n      \"sections\": [\n        \"team\"\n      ],\n      \"usage\": \"Liste Â« Collectif moteur Â» dans la section Ã©quipe.\"\n    },\n    \"placeholder\": \"PrÃ©nom Nom - Poste de la personne\\nPrÃ©nom Nom - Poste de la personne\",\n    \"conditionGroups\": []\n  },\n  {\n    \"id\": \"agencyRanking\",\n    \"type\": \"ranking\",\n    \"question\": \"Classez vos critÃ¨res pour sÃ©lectionner une agence mÃ©dicale partenaire\",\n    \"options\": [],\n    \"required\": false,\n    \"conditions\": [],\n    \"conditionLogic\": \"all\",\n    \"guidance\": {\n      \"objective\": \"Identifier rapidement l'agence qui correspond le mieux Ã  vos attentes.\",\n      \"details\": \"Ordonnez les critÃ¨res par importance et mettez de cÃ´tÃ© ceux qui n'ont aucune incidence pour vous.\",\n      \"tips\": [\n        \"Pensez aux compÃ©tences clÃ©s attendues (scientifique, crÃ©ativitÃ©, international...).\",\n        \"Marquez les critÃ¨res non pertinents comme \\\"sans importance\\\" pour affiner la recommandation.\"\n      ]\n    },\n    \"rankingConfig\": {\n      \"title\": \"Prestataires prÃ©-identifiÃ©s\",\n      \"criteria\": [\n        { \"id\": \"international\", \"label\": \"International\" },\n        { \"id\": \"scientific\", \"label\": \"Contenu scientifique\" },\n        { \"id\": \"creativity\", \"label\": \"CrÃ©ativitÃ©\" },\n        { \"id\": \"price\", \"label\": \"Prix\" },\n        { \"id\": \"opinion\", \"label\": \"Avis global\" }\n      ],\n      \"entries\": [\n        {\n          \"id\": \"a-a\",\n          \"name\": \"A+A\",\n          \"scores\": { \"international\": 3, \"scientific\": 3, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"antoine.ada@aa.com\",\n          \"website\": \"https://www.adhealth.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"+++\",\n          \"notes\": \"Positionnement premium et solide rÃ©seau international.\"\n        },\n        {\n          \"id\": \"adahealth\",\n          \"name\": \"ADAHealth\",\n          \"scores\": { \"international\": 1, \"scientific\": 2, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"robin.benard@adhealth.com\",\n          \"website\": \"https://www.adhealth.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Agence crÃ©ative avec appÃ©tence digitale.\"\n        },\n        {\n          \"id\": \"anna-purna\",\n          \"name\": \"Anna Purna\",\n          \"scores\": { \"international\": 2, \"scientific\": 2, \"creativity\": 3, \"price\": 3, \"opinion\": 2 },\n          \"contact\": \"l.esperanza@annapurna8000.com\",\n          \"website\": \"https://www.agence-annapurna.com\",\n          \"previousProject\": \"\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Approche Ã©quilibrÃ©e entre rigueur mÃ©dicale et crÃ©ativitÃ©.\"\n        },\n        {\n          \"id\": \"arsenal-cdm\",\n          \"name\": \"Arsenal CDM\",\n          \"scores\": { \"international\": 1, \"scientific\": 1, \"creativity\": 1, \"price\": 1, \"opinion\": 1 },\n          \"contact\": \"cherry@cdmparis.com\",\n          \"website\": \"https://www.cdmparis.com\",\n          \"previousProject\": \"FitCLOT / CLOTTAFACT\",\n          \"opinionText\": \"++\",\n          \"notes\": \"Historique sur des projets clotting, bonne connaissance du secteur.\"\n        }\n      ]\n    },\n    \"placeholder\": \"\",\n    \"conditionGroups\": []\n  }\n];\n",
  "src/data/riskLevelRules.js": "export const initialRiskLevelRules = [\n  {\n    \"id\": \"risk_low\",\n    \"label\": \"Faible\",\n    \"minRisks\": 0,\n    \"maxRisks\": 3,\n    \"description\": \"Suivi standard avec un point de validation suffisant.\",\n    \"maxScore\": 3\n  },\n  {\n    \"id\": \"risk_medium\",\n    \"label\": \"ModÃ©rÃ©e\",\n    \"minRisks\": 4,\n    \"maxRisks\": 9,\n    \"description\": \"Coordination accrue avec les Ã©quipes expertes.\",\n    \"minScore\": 4,\n    \"maxScore\": 9\n  },\n  {\n    \"id\": \"risk_high\",\n    \"label\": \"Ã‰levÃ©e\",\n    \"minRisks\": 10,\n    \"maxRisks\": null,\n    \"description\": \"Plan dâ€™actions prioritaire Ã  piloter avec le sponsor compliance.\",\n    \"minScore\": 10\n  }\n];\n",
  "src/data/riskWeights.js": "import { DEFAULT_RISK_WEIGHTING } from '../utils/risk.js';\n\nexport const initialRiskWeights = {\n  low: DEFAULT_RISK_WEIGHTING.low,\n  medium: DEFAULT_RISK_WEIGHTING.medium,\n  high: DEFAULT_RISK_WEIGHTING.high\n};\n",
  "src/data/rules.js": "export const initialRules = [\n  {\n    \"id\": \"rule1\",\n    \"name\": \"Projet externe digital avec professionnels de santÃ©\",\n    \"conditions\": [\n      {\n        \"type\": \"question\",\n        \"question\": \"targetAudience\",\n        \"operator\": \"equals\",\n        \"value\": \"Professionnels de santÃ©\"\n      },\n      {\n        \"type\": \"question\",\n        \"question\": \"q11\",\n        \"operator\": \"equals\",\n        \"value\": \"Site internet\"\n      }\n    ],\n    \"teams\": [\n      \"bpp\",\n      \"it\",\n      \"legal\",\n      \"privacy\"\n    ],\n    \"questions\": {\n      \"bpp\": [\n        \"Le contenu a-t-il Ã©tÃ© validÃ© mÃ©dicalement ?\",\n        \"Le site internet contient-t-il des mentions de nos produits ? \",\n        \"Y-a-t-il un contrÃ´le d'accÃ¨s pour le limiter aux PDS ? \"\n      ],\n      \"it\": [\n        \"OÃ¹ le site sera hÃ©bergÃ© ?\"\n      ],\n      \"legal\": [\n        \"Il conviendra d'utiliser le modÃ¨le de mentions lÃ©gales disponibles ici : https://google.fr\"\n      ],\n      \"privacy\": [\n        \"Pensez bien Ã  ajouter le bandeau cookie\"\n      ]\n    },\n    \"risks\": [\n      {\n        \"description\": \"Communication non conforme aux bonnes pratiques promotionnelles\",\n        \"level\": \"Moyen\",\n        \"mitigation\": \"Validation BPP avant tout dÃ©ploiement\",\n        \"priority\": \"A particuliÃ¨rement anticiper\",\n        \"teamId\": \"bpp\"\n      }\n    ],\n    \"conditionLogic\": \"all\",\n    \"conditionGroups\": [\n      {\n        \"logic\": \"all\",\n        \"conditions\": [\n          {\n            \"type\": \"question\",\n            \"question\": \"targetAudience\",\n            \"operator\": \"equals\",\n            \"value\": \"Professionnels de santÃ©\"\n          },\n          {\n            \"type\": \"question\",\n            \"question\": \"q11\",\n            \"operator\": \"equals\",\n            \"value\": \"Site internet\"\n          }\n        ]\n      }\n    ]\n  },\n  {\n    \"id\": \"rule4\",\n    \"name\": \"RÃ©munÃ©ration PDS\",\n    \"conditions\": [\n      {\n        \"type\": \"question\",\n        \"question\": \"q10\",\n        \"operator\": \"equals\",\n        \"value\": \"Professionnel de santÃ© (via contrat Ã  mettre en place)\"\n      }\n    ],\n    \"conditionGroups\": [\n      {\n        \"logic\": \"all\",\n        \"conditions\": [\n          {\n            \"type\": \"question\",\n            \"question\": \"q10\",\n            \"operator\": \"equals\",\n            \"value\": \"Professionnel de santÃ© (via contrat Ã  mettre en place)\"\n          }\n        ]\n      }\n    ],\n    \"conditionLogic\": \"all\",\n    \"teams\": [\n      \"Ethics\"\n    ],\n    \"questions\": {},\n    \"risks\": [\n      {\n        \"description\": \"DÃ©claration/Autorisation du contrat avec un PDS\",\n        \"level\": \"Moyen\",\n        \"mitigation\": \"Si le contrat avec le PDS est > Ã  2000â‚¬, il convient de soumettre la demande l'autorisation Ã  l'instance ordinale au moins 8 semaines avant le dÃ©but du contrat. En dessous de 2000â‚¬, c'est un rÃ©gime de dÃ©claration (8 jours ouvrables).\",\n        \"priority\": \"A particuliÃ¨rement anticiper\",\n        \"teamId\": \"Ethics\",\n        \"timingConstraint\": {\n          \"enabled\": true,\n          \"startQuestion\": \"campaignKickoffDate\",\n          \"endQuestion\": \"launchDate\",\n          \"minimumWeeks\": 10\n        }\n      }\n    ]\n  },\n  {\n    \"id\": \"rule5\",\n    \"name\": \"DonnÃ©es de santÃ©\",\n    \"conditions\": [\n      {\n        \"type\": \"question\",\n        \"question\": \"q3\",\n        \"operator\": \"equals\",\n        \"value\": \"Oui - DonnÃ©es de santÃ©\"\n      }\n    ],\n    \"conditionGroups\": [\n      {\n        \"logic\": \"all\",\n        \"conditions\": [\n          {\n            \"type\": \"question\",\n            \"question\": \"q3\",\n            \"operator\": \"equals\",\n            \"value\": \"Oui - DonnÃ©es de santÃ©\"\n          }\n        ]\n      }\n    ],\n    \"conditionLogic\": \"all\",\n    \"teams\": [\n      \"privacy\"\n    ],\n    \"questions\": {},\n    \"risks\": [\n      {\n        \"description\": \"Contraites spÃ©cifiques en cas de donnÃ©es de santÃ©\",\n        \"level\": \"Ã‰levÃ©\",\n        \"mitigation\": \"En cas de collecte/traitement de donnÃ©es de santÃ©, des dÃ©clarations 6 mois avant le lancement peuvent Ãªtre requises, sauf Ã  rentrer dans des rÃ©fÃ©rentiels dÃ©jÃ  dÃ©finis. Pensez Ã  contacter au plus vite le DPO\",\n        \"priority\": \"A particuliÃ¨rement anticiper\",\n        \"teamId\": \"privacy\",\n        \"timingConstraint\": {\n          \"enabled\": true,\n          \"startQuestion\": \"campaignKickoffDate\",\n          \"endQuestion\": \"launchDate\",\n          \"minimumWeeks\": 26\n        }\n      }\n    ]\n  }\n];\n",
  "src/data/showcaseThemes.js": "export const initialShowcaseThemes = [\n  {\n    id: 'universel',\n    label: 'Universel',\n    description: 'Palette actuelle de la vitrine, Ã©quilibrÃ©e entre bleu profond et reflets cyan.',\n    layout: 'aurora',\n    aliases: ['Universel'],\n    palette: {\n      backgroundStart: '#020309',\n      backgroundMid: '#050b18',\n      backgroundEnd: '#020309',\n      glowPrimary: '#3b82f6',\n      glowSecondary: '#0ea5e9',\n      accentPrimary: '#2563eb',\n      accentSecondary: '#06b6d4',\n      surface: '#0b1223',\n      surfaceLight: '#f8fafc',\n      surfaceLightAlt: '#e2e8f0',\n      border: '#94a3b8',\n      inkStrong: '#0f172a',\n      inkSoft: '#1e293b',\n      inkMuted: '#475569',\n      inkSubtle: '#94a3b8',\n      textPrimary: '#f8fafc',\n      textSecondary: '#e2e8f0',\n      highlight: '#93c5fd',\n      titleGradientStart: '#93c5fd',\n      titleGradientMid: '#c084fc',\n      titleGradientEnd: '#0ea5e9',\n      ctaStart: '#1e3a8a',\n      ctaEnd: '#0f766e',\n      ctaText: '#ecfeff',\n      heroBackgroundStart: '#000000',\n      heroBackgroundMid: '#090d15',\n      heroBackgroundEnd: '#0b1f2c',\n      panelSoftStart: '#101728',\n      panelSoftEnd: '#1b2230',\n      panelStrongStart: '#0b2f41',\n      panelStrongEnd: '#0e5560',\n      statusOkStart: '#d1fae5',\n      statusOkEnd: '#a7f3d0',\n      statusWarnStart: '#ecfdf5',\n      statusWarnEnd: '#d1fae5',\n      statusAlertStart: '#fee2e2',\n      statusAlertEnd: '#fecaca',\n      statusAlertStrongStart: '#f05959',\n      statusAlertStrongEnd: '#be1717',\n      statusOkText: '#064e3b',\n      statusWarnText: '#064e3b',\n      statusAlertText: '#7f1d1d'\n    }\n  },\n  {\n    id: 'deezer',\n    label: 'Deezer',\n    description: 'Univers sombre et vibrant inspirÃ© des plateformes musicales, avec nÃ©ons et pulsations.',\n    layout: 'deezer',\n    aliases: ['Deezer', 'Music'],\n    palette: {\n      backgroundStart: '#06060a',\n      backgroundMid: '#0d0d16',\n      backgroundEnd: '#141425',\n      glowPrimary: '#ff5500',\n      glowSecondary: '#ff1f6b',\n      accentPrimary: '#ff5500',\n      accentSecondary: '#ff1f6b',\n      surface: '#111122',\n      surfaceLight: '#f8fafc',\n      surfaceLightAlt: '#dbe2ff',\n      border: '#ff1f6b',\n      inkStrong: '#0b0b10',\n      inkSoft: '#10101a',\n      inkMuted: '#4c4c6f',\n      inkSubtle: '#6b6b8c',\n      textPrimary: '#f8fafc',\n      textSecondary: '#dbe2ff',\n      highlight: '#ff8a34',\n      titleGradientStart: '#ff5500',\n      titleGradientMid: '#ff1f6b',\n      titleGradientEnd: '#7c3aed',\n      ctaStart: '#ff5500',\n      ctaEnd: '#ff1f6b',\n      ctaText: '#0b0b10',\n      heroBackgroundStart: '#06060a',\n      heroBackgroundMid: '#0d0d16',\n      heroBackgroundEnd: '#141425',\n      panelSoftStart: '#0f0f1c',\n      panelSoftEnd: '#151529',\n      panelStrongStart: '#1f1f35',\n      panelStrongEnd: '#2b2b4b',\n      statusOkStart: '#dcfce7',\n      statusOkEnd: '#bbf7d0',\n      statusWarnStart: '#fef3c7',\n      statusWarnEnd: '#fde68a',\n      statusAlertStart: '#fee2e2',\n      statusAlertEnd: '#fecaca',\n      statusAlertStrongStart: '#ff1f6b',\n      statusAlertStrongEnd: '#ff5500',\n      statusOkText: '#166534',\n      statusWarnText: '#92400e',\n      statusAlertText: '#991b1b'\n    }\n  },\n  {\n    id: 'cevenfacta',\n    label: 'Cevenfacta',\n    description: 'Palette Cevenfacta basÃ©e sur les tons charbon, ardoise et orange signature.',\n    layout: 'editorial',\n    aliases: ['Cevenfacta', 'SevenFacta', 'Cevens'],\n    palette: {\n      backgroundStart: '#121110',\n      backgroundMid: '#1f1d1b',\n      backgroundEnd: '#2e2a25',\n      glowPrimary: '#d74022',\n      glowSecondary: '#5c6670',\n      accentPrimary: '#d74022',\n      accentSecondary: '#5c6670',\n      surface: '#1b1917',\n      surfaceLight: '#f8fafc',\n      surfaceLightAlt: '#e2e8f0',\n      border: '#5c6670',\n      inkStrong: '#1a1714',\n      inkSoft: '#2e2a25',\n      inkMuted: '#6b7280',\n      inkSubtle: '#9ca3af',\n      textPrimary: '#f8fafc',\n      textSecondary: '#e5e7eb',\n      highlight: '#f97316',\n      titleGradientStart: '#d74022',\n      titleGradientMid: '#f97316',\n      titleGradientEnd: '#5c6670',\n      ctaStart: '#b9371e',\n      ctaEnd: '#f97316',\n      ctaText: '#ffffff',\n      heroBackgroundStart: '#0f0e0d',\n      heroBackgroundMid: '#1c1a18',\n      heroBackgroundEnd: '#2e2a25',\n      panelSoftStart: '#1a1715',\n      panelSoftEnd: '#262320',\n      panelStrongStart: '#2e2a25',\n      panelStrongEnd: '#3f3a34',\n      statusOkStart: '#ecfdf5',\n      statusOkEnd: '#d1fae5',\n      statusWarnStart: '#fef3c7',\n      statusWarnEnd: '#fde68a',\n      statusAlertStart: '#fee2e2',\n      statusAlertEnd: '#fecaca',\n      statusAlertStrongStart: '#d74022',\n      statusAlertStrongEnd: '#9a3412',\n      statusOkText: '#065f46',\n      statusWarnText: '#92400e',\n      statusAlertText: '#7f1d1d'\n    }\n  },\n  {\n    id: 'fibclot',\n    label: 'Fibclot',\n    description: 'Univers Fibclot clair et graphique, inspirÃ© des tons olive, turquoise et orange.',\n    layout: 'fibclot',\n    aliases: ['Fibclot', 'FibCLOT'],\n    palette: {\n      backgroundStart: '#f9f7f0',\n      backgroundMid: '#efede7',\n      backgroundEnd: '#e7e6e6',\n      glowPrimary: '#7f9026',\n      glowSecondary: '#2db7c2',\n      accentPrimary: '#7f9026',\n      accentSecondary: '#2db7c2',\n      surface: '#f3f2ec',\n      surfaceLight: '#ffffff',\n      surfaceLightAlt: '#f2f0ea',\n      border: '#4a4949',\n      inkStrong: '#2b2a29',\n      inkSoft: '#4a4949',\n      inkMuted: '#6b6b6b',\n      inkSubtle: '#9a9a9a',\n      textPrimary: '#2b2a29',\n      textSecondary: '#4a4949',\n      highlight: '#fa9d27',\n      titleGradientStart: '#7f9026',\n      titleGradientMid: '#fa9d27',\n      titleGradientEnd: '#2db7c2',\n      ctaStart: '#7f9026',\n      ctaEnd: '#2db7c2',\n      ctaText: '#ffffff',\n      heroBackgroundStart: '#fdfbf5',\n      heroBackgroundMid: '#f3f1e9',\n      heroBackgroundEnd: '#e7e6e6',\n      panelSoftStart: '#ffffff',\n      panelSoftEnd: '#f0eee6',\n      panelStrongStart: '#f5f3ec',\n      panelStrongEnd: '#e7e6e6',\n      statusOkStart: '#e4f0d1',\n      statusOkEnd: '#d6e6b7',\n      statusWarnStart: '#fff3d6',\n      statusWarnEnd: '#ffe2a6',\n      statusAlertStart: '#fde4e4',\n      statusAlertEnd: '#f7b5b5',\n      statusAlertStrongStart: '#cd1719',\n      statusAlertStrongEnd: '#a51314',\n      statusOkText: '#3c4b11',\n      statusWarnText: '#7a4b00',\n      statusAlertText: '#7a1d1d'\n    }\n  },\n  {\n    id: 'iqymune',\n    label: 'IqYmune',\n    description: 'Palette QBD/IqYmune violette avec accents rose et cyan.',\n    layout: 'editorial',\n    aliases: ['IqYmune', 'IQYMUNE', 'QBD'],\n    palette: {\n      backgroundStart: '#1a1430',\n      backgroundMid: '#2a1e4f',\n      backgroundEnd: '#3b2b68',\n      glowPrimary: '#644696',\n      glowSecondary: '#00b7ff',\n      accentPrimary: '#644696',\n      accentSecondary: '#dd2397',\n      surface: '#231a3a',\n      surfaceLight: '#f8fafc',\n      surfaceLightAlt: '#e2e8f0',\n      border: '#b6008d',\n      inkStrong: '#1b1b22',\n      inkSoft: '#2a2440',\n      inkMuted: '#4b5563',\n      inkSubtle: '#94a3b8',\n      textPrimary: '#f8fafc',\n      textSecondary: '#e2e8f0',\n      highlight: '#00b7ff',\n      titleGradientStart: '#644696',\n      titleGradientMid: '#dd2397',\n      titleGradientEnd: '#00b7ff',\n      ctaStart: '#dd2397',\n      ctaEnd: '#00b7ff',\n      ctaText: '#0b1020',\n      heroBackgroundStart: '#170f2a',\n      heroBackgroundMid: '#251847',\n      heroBackgroundEnd: '#372660',\n      panelSoftStart: '#221a36',\n      panelSoftEnd: '#2c2344',\n      panelStrongStart: '#3a2c5d',\n      panelStrongEnd: '#4a3475',\n      statusOkStart: '#ecfdf5',\n      statusOkEnd: '#d1fae5',\n      statusWarnStart: '#fffbeb',\n      statusWarnEnd: '#fef3c7',\n      statusAlertStart: '#fee2e2',\n      statusAlertEnd: '#fecaca',\n      statusAlertStrongStart: '#e2231a',\n      statusAlertStrongEnd: '#b91c1c',\n      statusOkText: '#065f46',\n      statusWarnText: '#92400e',\n      statusAlertText: '#7f1d1d'\n    }\n  }\n];\n",
  "src/data/teams.js": "export const initialTeams = [\n  {\n    \"id\": \"bpp\",\n    \"name\": \"Bonnes Pratiques Promotionnelles\",\n    \"contacts\": [\"bpp@lfb.com\", \"bpp-support@lfb.com\"],\n    \"expertise\": \"ConformitÃ© rÃ©glementaire des communications pour Ã©viter tout risque de promotion non adaptÃ©e\"\n  },\n  {\n    \"id\": \"it\",\n    \"name\": \"IT & SÃ©curitÃ©\",\n    \"contacts\": [\"it-security@lfb.com\", \"support-it@lfb.com\"],\n    \"expertise\": \"Ã‰valuer la sÃ©curitÃ© et la robustesse technique du projet\"\n  },\n  {\n    \"id\": \"legal\",\n    \"name\": \"Juridique\",\n    \"contacts\": [\"legal@lfb.com\", \"juridique-conseil@lfb.com\"],\n    \"expertise\": \"SÃ©curiser les aspects contractuels et la conformitÃ© rÃ©glementaire des documents et relations\"\n  },\n  {\n    \"id\": \"privacy\",\n    \"name\": \"Privacy & RGPD\",\n    \"contacts\": [\"privacy@lfb.com\", \"dpo@lfb.com\"],\n    \"expertise\": \"Protection des donnÃ©es personnelles et conformitÃ© RGPD\"\n  },\n  {\n    \"id\": \"procurement\",\n    \"name\": \"Achat\",\n    \"contacts\": [\"achat@company.com\", \"procurement@company.com\"],\n    \"expertise\": \"Garantir que les prestataires respectent les procÃ©dures Ã©thiques et financiÃ¨res\"\n  },\n  {\n    \"id\": \"pv\",\n    \"name\": \"Pharmacovigilance\",\n    \"contacts\": [\"pv@company.com\", \"pharmacovigilance@company.com\"],\n    \"expertise\": \"Garantir la remontÃ©e des Ã©vÃ©nements indÃ©sirables liÃ©s Ã  un produit\"\n  },\n  {\n    \"id\": \"com\",\n    \"name\": \"Communication\",\n    \"contacts\": [\"communication@company.com\", \"brand@company.com\"],\n    \"expertise\": \"Sâ€™assurer du respect des guidelines visuelles et de la rÃ©putation de lâ€™entreprise\"\n  },\n  {\n    \"id\": \"Ethics\",\n    \"name\": \"Ethique & Compliance\",\n    \"contacts\": [\"ethique@company.com\", \"compliance@company.com\"],\n    \"expertise\": \"Garantir la conformitÃ© globale du projet Ã  la rÃ©glementation interne et externe (dont Loi d'Encadrement des Avantages)\"\n  }\n];\n",
  "src/data/validationCommitteeConfig.js": "export const initialValidationCommitteeConfig = {\n  enabled: true,\n  committees: [\n    {\n      id: 'committee-default',\n      name: 'ComitÃ© de validation',\n      commentRequired: true,\n      emails: ['comite.validation@company.com', 'secretariat.validation@company.com'],\n      ruleTriggers: {\n        matchMode: 'any',\n        ruleIds: []\n      },\n      conditionGroups: [],\n      riskTriggers: {\n        minRiskScore: null\n      },\n      teamTriggers: {\n        minTeamsCount: null\n      }\n    }\n  ]\n};\n",
  "src/main.jsx": "import React from './react.js';\nimport { ReactDOM } from './react.js';\nimport { App } from './App.jsx';\n\nconst rootElement = document.getElementById('root');\n\nif (rootElement && ReactDOM) {\n  if (typeof ReactDOM.createRoot === 'function') {\n    const root = ReactDOM.createRoot(rootElement);\n    root.render(<App />);\n  } else if (typeof ReactDOM.render === 'function') {\n    ReactDOM.render(<App />, rootElement);\n  } else {\n    console.error('Aucune mÃ©thode de rendu ReactDOM disponible.');\n  }\n}\n",
  "src/module-loader.js": "(function (global) {\n  if (!global.Babel) {\n    throw new Error('Babel doit Ãªtre chargÃ© avant le module loader.');\n  }\n\n  const moduleCache = Object.create(null);\n  const LOCAL_STORAGE_NAMESPACE = 'module-cache:';\n  const CACHE_VERSION = '1';\n\n  const isAbsoluteUrl = url => /^(?:[a-z]+:)?\\/\\//i.test(url);\n\n  const manifest = global.__COMPLIANCE_NAVIGATOR_MANIFEST__;\n\n  const supportsLocalStorage = (() => {\n    try {\n      const { localStorage } = global;\n      if (!localStorage) {\n        return false;\n      }\n\n      const testKey = `${LOCAL_STORAGE_NAMESPACE}__test__`;\n      localStorage.setItem(testKey, '1');\n      localStorage.removeItem(testKey);\n      return true;\n    } catch (error) {\n      return false;\n    }\n  })();\n\n  const readCacheRecord = (url, sourceHash) => {\n    if (!supportsLocalStorage) {\n      return null;\n    }\n\n    try {\n      const serialized = global.localStorage.getItem(`${LOCAL_STORAGE_NAMESPACE}${url}`);\n      if (!serialized) {\n        return null;\n      }\n\n      const parsed = JSON.parse(serialized);\n      if (!parsed || parsed.version !== CACHE_VERSION || parsed.hash !== sourceHash) {\n        return null;\n      }\n\n      return typeof parsed.code === 'string' ? parsed.code : null;\n    } catch (error) {\n      return null;\n    }\n  };\n\n  const writeCacheRecord = (url, sourceHash, code) => {\n    if (!supportsLocalStorage) {\n      return;\n    }\n\n    try {\n      const payload = {\n        version: CACHE_VERSION,\n        hash: sourceHash,\n        code\n      };\n      global.localStorage.setItem(`${LOCAL_STORAGE_NAMESPACE}${url}`, JSON.stringify(payload));\n    } catch (error) {\n      try {\n        global.localStorage.removeItem(`${LOCAL_STORAGE_NAMESPACE}${url}`);\n      } catch (cleanupError) {\n        // no-op\n      }\n    }\n  };\n\n  const computeSourceHash = (source) => {\n    if (typeof source !== 'string' || source.length === 0) {\n      return '0';\n    }\n\n    let hash = 0;\n    for (let index = 0; index < source.length; index += 1) {\n      hash = (hash * 31 + source.charCodeAt(index)) >>> 0;\n    }\n\n    return `${CACHE_VERSION}:${hash.toString(16)}`;\n  };\n\n  const isFileProtocol = global.location && global.location.protocol === 'file:';\n\n  const toRelativeFromRoot = (absoluteUrl) => {\n    if (!global.location || !absoluteUrl) {\n      return null;\n    }\n\n    try {\n      const parsedUrl = new URL(absoluteUrl);\n      const baseDirectory = new URL('.', global.location.href).pathname;\n      let relativePath = parsedUrl.pathname;\n\n      if (baseDirectory && relativePath.startsWith(baseDirectory)) {\n        relativePath = relativePath.slice(baseDirectory.length);\n      } else {\n        relativePath = relativePath.replace(/^\\//, '');\n      }\n\n      return relativePath || null;\n    } catch (error) {\n      return null;\n    }\n  };\n\n  const fetchFromManifest = (url) => {\n    if (!isFileProtocol || !manifest || typeof manifest !== 'object') {\n      return null;\n    }\n\n    const relativePath = toRelativeFromRoot(url);\n    if (!relativePath) {\n      return null;\n    }\n\n    return manifest[relativePath] || manifest[`./${relativePath}`] || null;\n  };\n\n  const fetchSourceSync = url => {\n    const manifestSource = fetchFromManifest(url);\n    if (typeof manifestSource === 'string') {\n      return manifestSource;\n    }\n\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', url, false);\n    xhr.send(null);\n\n    const isSuccessfulStatus = xhr.status >= 200 && xhr.status < 400;\n    const canAllowStatusZero = isFileProtocol && xhr.status === 0 && typeof xhr.responseText === 'string';\n\n    if (!isSuccessfulStatus && !canAllowStatusZero) {\n      throw new Error(`Impossible de charger le module \"${url}\" (statut ${xhr.status}).`);\n    }\n\n    return xhr.responseText;\n  };\n\n  const normalizeModuleUrl = (value) => {\n    if (typeof value !== 'string') {\n      return '';\n    }\n\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return '';\n    }\n\n    return trimmed.split('#')[0].split('?')[0];\n  };\n\n  const isJsonModule = (url) => normalizeModuleUrl(url).toLowerCase().endsWith('.json');\n\n  const transformSource = (url, source) => {\n    if (isJsonModule(url)) {\n      const parsed = JSON.parse(source);\n      return `module.exports = ${JSON.stringify(parsed)};`;\n    }\n\n    const sourceHash = computeSourceHash(source);\n    const cached = readCacheRecord(url, sourceHash);\n    if (cached) {\n      return cached;\n    }\n\n    const transformed = global.Babel.transform(source, {\n      presets: [\n        [\n          'env',\n          {\n            modules: 'commonjs',\n            exclude: ['transform-regenerator', 'transform-async-to-generator']\n          }\n        ],\n        'react'\n      ],\n      sourceType: 'module'\n    }).code;\n\n    if (typeof transformed === 'string' && transformed.length > 0) {\n      writeCacheRecord(url, sourceHash, transformed);\n    }\n\n    return transformed;\n  };\n\n  const normalizeUrl = (specifier, baseUrl) => {\n    if (isAbsoluteUrl(specifier)) {\n      return specifier;\n    }\n\n    const resolvedUrl = new URL(specifier, baseUrl);\n    return resolvedUrl.href;\n  };\n\n  const loadModule = url => {\n    if (moduleCache[url]) {\n      return moduleCache[url].exports;\n    }\n\n    const source = fetchSourceSync(url);\n    const transformed = transformSource(url, source);\n\n    const module = { exports: {} };\n    moduleCache[url] = module;\n\n    const dirname = url.slice(0, url.lastIndexOf('/') + 1) || url;\n\n    const localRequire = specifier => {\n      const childUrl = normalizeUrl(specifier, dirname);\n      return loadModule(childUrl);\n    };\n\n    const factory = new Function('require', 'module', 'exports', 'global',\n      `${transformed}\\n//# sourceURL=${url}`\n    );\n\n    try {\n      factory(localRequire, module, module.exports, global);\n    } catch (error) {\n      delete moduleCache[url];\n      throw error;\n    }\n\n    return module.exports;\n  };\n\n  global.ModuleLoader = {\n    import(modulePath) {\n      const entryUrl = normalizeUrl(modulePath, global.location.href);\n      return loadModule(entryUrl);\n    }\n  };\n})(window);\n",
  "src/react.js": "const ReactGlobal = window.React;\n\nif (!ReactGlobal) {\n  throw new Error('React global not found. Assurez-vous que React est chargÃ© avant les modules.');\n}\n\nconst ReactDOMGlobal = window.ReactDOM;\n\nexport const React = ReactGlobal;\nexport const ReactDOM = ReactDOMGlobal;\nexport const {\n  useState,\n  useEffect,\n  useMemo,\n  useCallback,\n  useRef,\n  useLayoutEffect,\n  lazy,\n  Suspense\n} = ReactGlobal;\n\nexport default ReactGlobal;\n",
  "src/utils/conditionGroups.js": "export const sanitizeCondition = (condition = {}) => {\n  return {\n    question: condition.question || '',\n    operator: condition.operator || 'equals',\n    value: condition.value ?? ''\n  };\n};\n\nexport const sanitizeConditionGroup = (group = {}, conditionSanitizer = sanitizeCondition) => {\n  const logic = group.logic === 'any' ? 'any' : 'all';\n  const conditions = Array.isArray(group.conditions)\n    ? group.conditions.map(conditionSanitizer)\n    : [];\n\n  return {\n    logic,\n    conditions\n  };\n};\n\nexport const normalizeConditionGroups = (entity = {}, conditionSanitizer = sanitizeCondition) => {\n  const rawGroups = Array.isArray(entity.conditionGroups) ? entity.conditionGroups : null;\n\n  if (rawGroups && rawGroups.length > 0) {\n    return rawGroups.map(group => sanitizeConditionGroup(group, conditionSanitizer));\n  }\n\n  const fallbackConditions = Array.isArray(entity.conditions) ? entity.conditions : [];\n  if (fallbackConditions.length === 0) {\n    return [];\n  }\n\n  return [\n    sanitizeConditionGroup({\n      logic: entity.conditionLogic === 'any' ? 'any' : 'all',\n      conditions: fallbackConditions\n    }, conditionSanitizer)\n  ];\n};\n\nexport const applyConditionGroups = (entity = {}, groups = [], conditionSanitizer = sanitizeCondition) => {\n  const sanitizedGroups = Array.isArray(groups)\n    ? groups.map(group => sanitizeConditionGroup(group, conditionSanitizer))\n    : [];\n\n  const hasSingleGroup = sanitizedGroups.length === 1;\n  const legacyConditions = hasSingleGroup ? sanitizedGroups[0].conditions : [];\n  const legacyLogic = hasSingleGroup ? sanitizedGroups[0].logic : 'all';\n\n  return {\n    ...entity,\n    conditionGroups: sanitizedGroups,\n    conditions: legacyConditions,\n    conditionLogic: legacyLogic\n  };\n};\n\nexport const hasAnyConditions = (entity = {}, conditionSanitizer = sanitizeCondition) => {\n  return normalizeConditionGroups(entity, conditionSanitizer).some(group => group.conditions.length > 0);\n};\n",
  "src/utils/externalInspirationsLoader.js": "const DIRECTORY_PATH = './submitted-inspirations/';\nconst SEQUENTIAL_PREFIX = 'inspiration';\nconst SEQUENTIAL_MAX_ATTEMPTS = 200;\nconst SEQUENTIAL_MAX_CONSECUTIVE_MISSES = 5;\n\nconst isFileProtocol = () =>\n  typeof window !== 'undefined' && window.location && window.location.protocol === 'file:';\n\nconst fetchWithXmlHttpRequest = (url) => new Promise((resolve) => {\n  if (typeof XMLHttpRequest === 'undefined') {\n    resolve(null);\n    return;\n  }\n\n  try {\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', url, true);\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState !== 4) {\n        return;\n      }\n\n      const isSuccessfulStatus = xhr.status >= 200 && xhr.status < 400;\n      const canAllowStatusZero = isFileProtocol() && xhr.status === 0 && typeof xhr.responseText === 'string';\n\n      if (isSuccessfulStatus || canAllowStatusZero) {\n        resolve(typeof xhr.responseText === 'string' ? xhr.responseText : null);\n        return;\n      }\n\n      resolve(null);\n    };\n\n    xhr.onerror = () => resolve(null);\n    xhr.send(null);\n  } catch (error) {\n    resolve(null);\n  }\n});\n\nconst fetchText = async (url) => {\n  try {\n    const response = await fetch(url, { cache: 'no-cache' });\n    if (response.ok) {\n      return await response.text();\n    }\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalInspirationsLoader] Ressource texte introuvable :', url, error);\n    }\n  }\n\n  if (isFileProtocol()) {\n    const fallbackText = await fetchWithXmlHttpRequest(url);\n    if (typeof fallbackText === 'string') {\n      return fallbackText;\n    }\n  }\n\n  return null;\n};\n\nconst fetchJson = async (url) => {\n  const text = await fetchText(url);\n\n  if (typeof text !== 'string') {\n    return null;\n  }\n\n  try {\n    return JSON.parse(text);\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalInspirationsLoader] JSON introuvable :', url, error);\n    }\n    return null;\n  }\n};\n\nconst toChecksum = (sourceId, payload) => {\n  try {\n    return JSON.stringify({ sourceId, payload });\n  } catch (error) {\n    return `${sourceId}:${Date.now()}`;\n  }\n};\n\nconst normalizeDocuments = (documents) =>\n  Array.isArray(documents)\n    ? documents\n        .map((doc) => ({\n          name: typeof doc?.name === 'string' ? doc.name.trim() : '',\n          url: typeof doc?.url === 'string' ? doc.url.trim() : ''\n        }))\n        .filter((doc) => doc.name.length > 0 || doc.url.length > 0)\n    : [];\n\nconst normalizeInspirationPayload = (payload, sourceId) => {\n  if (!payload || typeof payload !== 'object' || Array.isArray(payload)) {\n    return null;\n  }\n\n  const raw = payload.inspiration && typeof payload.inspiration === 'object'\n    ? payload.inspiration\n    : payload.project && typeof payload.project === 'object'\n      ? payload.project\n      : payload;\n\n  if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {\n    return null;\n  }\n\n  const id = typeof raw.id === 'string' && raw.id.trim().length > 0\n    ? raw.id\n    : `external-${sourceId}`;\n\n  return {\n    ...raw,\n    id,\n    title: typeof raw.title === 'string' ? raw.title : raw.name || raw.projectName || 'Inspiration importÃ©e',\n    labName: typeof raw.labName === 'string' ? raw.labName : '',\n    target: typeof raw.target === 'string' ? raw.target : '',\n    typology: typeof raw.typology === 'string' ? raw.typology : '',\n    therapeuticArea: typeof raw.therapeuticArea === 'string' ? raw.therapeuticArea : '',\n    country: typeof raw.country === 'string' ? raw.country : '',\n    description: typeof raw.description === 'string' ? raw.description : '',\n    link: typeof raw.link === 'string' ? raw.link : '',\n    review: typeof raw.review === 'string' ? raw.review : '',\n    documents: normalizeDocuments(raw.documents),\n    visibility: raw.visibility === 'shared' ? 'shared' : 'personal',\n    createdAt: typeof raw.createdAt === 'string' ? raw.createdAt : new Date().toISOString(),\n    updatedAt: typeof raw.updatedAt === 'string' ? raw.updatedAt : new Date().toISOString()\n  };\n};\n\nexport const loadSubmittedInspirationsFromDirectory = async () => {\n  const entries = [];\n  let index = 1;\n  let misses = 0;\n\n  while (index <= SEQUENTIAL_MAX_ATTEMPTS && misses < SEQUENTIAL_MAX_CONSECUTIVE_MISSES) {\n    const filename = `${SEQUENTIAL_PREFIX}${index}.json`;\n    const url = `${DIRECTORY_PATH}${filename}`;\n    const payload = await fetchJson(url);\n\n    if (payload) {\n      const sourceId = filename;\n      const project = normalizeInspirationPayload(payload, sourceId);\n      if (project) {\n        const checksum = toChecksum(sourceId, project);\n        entries.push({\n          sourceId,\n          project: {\n            ...project,\n            externalSourceId: sourceId,\n            externalSourceChecksum: checksum\n          },\n          checksum\n        });\n      }\n      misses = 0;\n    } else {\n      misses += 1;\n    }\n\n    index += 1;\n  }\n\n  return entries;\n};\n",
  "src/utils/externalProjectsLoader.js": "import { extractProjectName } from './projects.js';\nimport { analyzeAnswers } from './rules.js';\nimport { normalizeProjectEntry } from './projectNormalization.js';\nimport { sanitizeFileName } from './projectExport.js';\n\nconst DIRECTORY_PATH = './submitted-projects/';\nconst MANIFEST_CANDIDATES = ['index.json', 'manifest.json', 'projects.json'];\nconst SEQUENTIAL_PREFIX = 'projet';\nconst SEQUENTIAL_MAX_ATTEMPTS = 100;\nconst SEQUENTIAL_MAX_CONSECUTIVE_MISSES = 5;\n\nconst isFileProtocol = () =>\n  typeof window !== 'undefined' && window.location && window.location.protocol === 'file:';\n\nconst fetchWithXmlHttpRequest = (url) => new Promise((resolve) => {\n  if (typeof XMLHttpRequest === 'undefined') {\n    resolve(null);\n    return;\n  }\n\n  try {\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', url, true);\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState !== 4) {\n        return;\n      }\n\n      const isSuccessfulStatus = xhr.status >= 200 && xhr.status < 400;\n      const canAllowStatusZero = isFileProtocol() && xhr.status === 0 && typeof xhr.responseText === 'string';\n\n      if (isSuccessfulStatus || canAllowStatusZero) {\n        resolve(typeof xhr.responseText === 'string' ? xhr.responseText : null);\n        return;\n      }\n\n      resolve(null);\n    };\n\n    xhr.onerror = () => resolve(null);\n    xhr.send(null);\n  } catch (error) {\n    resolve(null);\n  }\n});\n\nconst fetchText = async (url) => {\n  try {\n    const response = await fetch(url, { cache: 'no-cache' });\n    if (response.ok) {\n      return await response.text();\n    }\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalProjectsLoader] Ressource texte introuvable :', url, error);\n    }\n  }\n\n  if (isFileProtocol()) {\n    const fallbackText = await fetchWithXmlHttpRequest(url);\n    if (typeof fallbackText === 'string') {\n      return fallbackText;\n    }\n  }\n\n  return null;\n};\n\nconst fetchJson = async (url) => {\n  const text = await fetchText(url);\n\n  if (typeof text !== 'string') {\n    return null;\n  }\n\n  try {\n    return JSON.parse(text);\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalProjectsLoader] JSON introuvable :', url, error);\n    }\n    return null;\n  }\n};\n\nconst sanitizeRelativePath = (value) => {\n  if (typeof value !== 'string') {\n    return null;\n  }\n\n  let normalized = value.trim();\n  if (!normalized) {\n    return null;\n  }\n\n  try {\n    const parsed = new URL(normalized, window.location.href);\n    const basePath = new URL('.', window.location.href).pathname;\n    let candidate = parsed.pathname;\n\n    if (basePath && basePath !== '/' && candidate.startsWith(basePath)) {\n      candidate = candidate.slice(basePath.length);\n    }\n\n    normalized = candidate.replace(/^[./]+/, '');\n  } catch (error) {\n    normalized = normalized.replace(/^\\.\\//, '').replace(/^\\//, '');\n  }\n\n  if (normalized.includes('..')) {\n    return null;\n  }\n\n  return normalized;\n};\n\nconst deduplicate = (items) => {\n  const seen = new Set();\n  const result = [];\n\n  items.forEach(item => {\n    if (!item || seen.has(item)) {\n      return;\n    }\n    seen.add(item);\n    result.push(item);\n  });\n\n  return result;\n};\n\nconst getPredeclaredSnapshot = () => {\n  if (typeof window === 'undefined') {\n    return { files: [], inlineProjects: [], payloads: new Map() };\n  }\n\n  const snapshot = window.__COMPLIANCE_NAVIGATOR_SUBMITTED_PROJECTS__;\n\n  const files = Array.isArray(snapshot && snapshot.files)\n    ? snapshot.files\n        .filter(item => typeof item === 'string')\n        .map(item => sanitizeRelativePath(item))\n        .filter(Boolean)\n    : [];\n\n  const payloads = new Map();\n  if (snapshot && snapshot.payloads && typeof snapshot.payloads === 'object') {\n    Object.entries(snapshot.payloads).forEach(([key, value]) => {\n      const normalizedKey = sanitizeRelativePath(key);\n      if (normalizedKey) {\n        payloads.set(normalizedKey, value);\n      }\n    });\n  }\n\n  if (files.length === 0 && payloads.size === 0) {\n    return { files: [], inlineProjects: [], payloads: new Map() };\n  }\n\n  return { files: deduplicate(files), inlineProjects: [], payloads };\n};\n\nconst extractFilesFromManifest = (manifest) => {\n  if (!manifest) {\n    return { files: [], inlineProjects: [] };\n  }\n\n  if (Array.isArray(manifest)) {\n    if (manifest.every(entry => typeof entry === 'string')) {\n      return { files: manifest, inlineProjects: [] };\n    }\n\n    if (manifest.every(entry => entry && typeof entry === 'object' && !Array.isArray(entry))) {\n      return { files: [], inlineProjects: manifest };\n    }\n  }\n\n  if (typeof manifest === 'object') {\n    const files = Array.isArray(manifest.files) ? manifest.files : [];\n    const projects = Array.isArray(manifest.projects) ? manifest.projects : [];\n\n    if (files.length > 0 || projects.length > 0) {\n      return { files, inlineProjects: projects };\n    }\n  }\n\n  return { files: [], inlineProjects: [] };\n};\n\nconst extractFilesFromDirectoryListing = (html) => {\n  if (typeof DOMParser === 'undefined') {\n    return [];\n  }\n\n  try {\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(html, 'text/html');\n    const anchors = Array.from(doc.querySelectorAll('a[href]'));\n    const candidates = anchors\n      .map(anchor => anchor.getAttribute('href'))\n      .filter(Boolean)\n      .map(href => href.split('?')[0])\n      .filter(href => /\\.json$/i.test(href));\n\n    return deduplicate(candidates.map(sanitizeRelativePath).filter(Boolean));\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalProjectsLoader] Impossible de lire le listing :', error);\n    }\n    return [];\n  }\n};\n\nconst toChecksum = (sourceId, payload) => {\n  try {\n    return JSON.stringify({ sourceId, payload });\n  } catch (error) {\n    return `${sourceId}:${Date.now()}`;\n  }\n};\n\nconst normalizeAnswers = (value) => {\n  if (!value || typeof value !== 'object' || Array.isArray(value)) {\n    return {};\n  }\n  return value;\n};\n\nconst extractProjectPayload = (rawProject) => {\n  if (!rawProject || typeof rawProject !== 'object' || Array.isArray(rawProject)) {\n    return null;\n  }\n\n  if (rawProject.project && typeof rawProject.project === 'object') {\n    return {\n      id: rawProject.project.id || rawProject.project.projectId,\n      projectName:\n        rawProject.project.projectName ||\n        rawProject.project.name ||\n        rawProject.project.title ||\n        rawProject.project.projet ||\n        rawProject.project.nom,\n      answers: normalizeAnswers(rawProject.project.answers),\n      submittedAt:\n        rawProject.project.submittedAt ||\n        rawProject.project.submitted_at ||\n        rawProject.generatedAt ||\n        rawProject.createdAt ||\n        rawProject.project.generatedAt,\n      lastUpdated:\n        rawProject.project.lastUpdated ||\n        rawProject.project.updatedAt ||\n        rawProject.updatedAt,\n      metadata: rawProject\n    };\n  }\n\n  if (rawProject.answers && typeof rawProject.answers === 'object') {\n    return {\n      id: rawProject.id || rawProject.projectId,\n      projectName:\n        rawProject.projectName ||\n        rawProject.name ||\n        rawProject.title,\n      answers: normalizeAnswers(rawProject.answers),\n      submittedAt:\n        rawProject.submittedAt ||\n        rawProject.submitted_at ||\n        rawProject.createdAt,\n      lastUpdated: rawProject.lastUpdated || rawProject.updatedAt,\n      metadata: rawProject\n    };\n  }\n\n  return null;\n};\n\nconst buildUniqueId = (candidates, usedIds) => {\n  for (const candidate of candidates) {\n    if (!candidate || typeof candidate !== 'string') {\n      continue;\n    }\n\n    const sanitized = sanitizeFileName(candidate, '').toLowerCase();\n    if (!sanitized) {\n      continue;\n    }\n\n    let unique = sanitized;\n    let suffix = 2;\n    while (usedIds.has(unique)) {\n      unique = `${sanitized}-${suffix}`;\n      suffix += 1;\n    }\n\n    usedIds.add(unique);\n    return unique;\n  }\n\n  let index = 1;\n  let fallback = `imported-${index}`;\n  while (usedIds.has(fallback)) {\n    index += 1;\n    fallback = `imported-${index}`;\n  }\n\n  usedIds.add(fallback);\n  return fallback;\n};\n\nconst buildProjectEntry = (\n  payload,\n  sourceId,\n  {\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    fallbackQuestionsLength,\n    usedIds\n  }\n) => {\n  const extracted = extractProjectPayload(payload);\n  if (!extracted) {\n    return null;\n  }\n\n  const answers = extracted.answers;\n  const inferredName =\n    extracted.projectName ||\n    extractProjectName(answers, questions) ||\n    'Projet importÃ©';\n\n  const candidatesForId = [\n    payload.id,\n    extracted.id,\n    inferredName,\n    sourceId.replace(/\\.json$/i, '')\n  ];\n\n  const projectId = buildUniqueId(candidatesForId, usedIds);\n  const analysis = analyzeAnswers(answers, rules, riskLevelRules, riskWeights);\n  const submittedAt =\n    extracted.submittedAt ||\n    payload.submittedAt ||\n    payload.generatedAt ||\n    payload.createdAt ||\n    null;\n  const lastUpdated =\n    extracted.lastUpdated ||\n    payload.lastUpdated ||\n    payload.updatedAt ||\n    submittedAt;\n\n  const normalizedProject = normalizeProjectEntry({\n    id: projectId,\n    projectName: inferredName,\n    answers,\n    analysis,\n    status: 'submitted',\n    submittedAt,\n    lastUpdated,\n    externalSourceId: sourceId,\n    externalSourceChecksum: toChecksum(sourceId, payload),\n    isImported: true\n  }, fallbackQuestionsLength);\n\n  return normalizedProject;\n};\n\nconst loadProjectsFromFiles = async (files, context, preloadedPayloads = new Map()) => {\n  const results = [];\n\n  for (const file of files) {\n    const relativePath = sanitizeRelativePath(file);\n    if (!relativePath) {\n      continue;\n    }\n\n    const url = `${DIRECTORY_PATH}${relativePath}`;\n    let payload = null;\n\n    if (preloadedPayloads.has(relativePath)) {\n      try {\n        payload = JSON.parse(JSON.stringify(preloadedPayloads.get(relativePath)));\n      } catch (error) {\n        payload = preloadedPayloads.get(relativePath);\n      }\n    } else {\n      payload = await fetchJson(url);\n    }\n\n    if (!payload) {\n      continue;\n    }\n\n    const project = buildProjectEntry(payload, relativePath, context);\n    if (!project) {\n      continue;\n    }\n\n    results.push({\n      project,\n      sourceId: relativePath,\n      checksum: project.externalSourceChecksum\n    });\n  }\n\n  return results;\n};\n\nconst loadInlineProjects = (projects = [], context) => {\n  return projects\n    .map((payload, index) => {\n      const sourceId = `inline-${index + 1}`;\n      const project = buildProjectEntry(payload, sourceId, context);\n      if (!project) {\n        return null;\n      }\n\n      return {\n        project,\n        sourceId,\n        checksum: project.externalSourceChecksum\n      };\n    })\n    .filter(Boolean);\n};\n\nconst discoverSequentiallyNamedProjects = async () => {\n  const files = [];\n  const payloads = new Map();\n\n  let consecutiveMisses = 0;\n\n  for (let index = 1; index <= SEQUENTIAL_MAX_ATTEMPTS; index += 1) {\n    const candidate = `${SEQUENTIAL_PREFIX}${index}.json`;\n    const relativePath = sanitizeRelativePath(candidate);\n\n    if (!relativePath) {\n      continue;\n    }\n\n    const payload = await fetchJson(`${DIRECTORY_PATH}${relativePath}`);\n\n    if (payload) {\n      files.push(relativePath);\n      payloads.set(relativePath, payload);\n      consecutiveMisses = 0;\n      continue;\n    }\n\n    consecutiveMisses += 1;\n\n    if (consecutiveMisses >= SEQUENTIAL_MAX_CONSECUTIVE_MISSES) {\n      break;\n    }\n  }\n\n  return { files, payloads };\n};\n\nconst discoverProjectFiles = async () => {\n  const snapshot = getPredeclaredSnapshot();\n  if (snapshot.files.length > 0 || snapshot.payloads.size > 0 || snapshot.inlineProjects.length > 0) {\n    return snapshot;\n  }\n\n  for (const manifestFile of MANIFEST_CANDIDATES) {\n    const manifest = await fetchJson(`${DIRECTORY_PATH}${manifestFile}`);\n    const { files, inlineProjects } = extractFilesFromManifest(manifest);\n    if (files.length > 0 || inlineProjects.length > 0) {\n      return { files: deduplicate(files), inlineProjects, payloads: new Map() };\n    }\n  }\n\n  const htmlListing = await fetchText(DIRECTORY_PATH);\n  const discoveredFiles = htmlListing\n    ? extractFilesFromDirectoryListing(htmlListing)\n    : [];\n  const sequentialDiscovery = await discoverSequentiallyNamedProjects();\n  const files = deduplicate([...discoveredFiles, ...sequentialDiscovery.files]);\n\n  return {\n    files,\n    inlineProjects: [],\n    payloads: sequentialDiscovery.payloads\n  };\n};\n\nexport const loadSubmittedProjectsFromDirectory = async ({\n  questions,\n  rules,\n  riskLevelRules,\n  riskWeights,\n  fallbackQuestionsLength,\n  existingProjects = []\n} = {}) => {\n  if (typeof window === 'undefined' || typeof fetch !== 'function') {\n    return [];\n  }\n\n  const usedIds = new Set(\n    Array.isArray(existingProjects)\n      ? existingProjects.map(project => project && project.id).filter(Boolean)\n      : []\n  );\n\n  const context = {\n    questions,\n    rules,\n    riskLevelRules,\n    riskWeights,\n    fallbackQuestionsLength,\n    usedIds\n  };\n\n  try {\n    const { files, inlineProjects, payloads } = await discoverProjectFiles();\n    const inlineResults = loadInlineProjects(inlineProjects, context);\n    const fileResults = await loadProjectsFromFiles(files, context, payloads);\n\n    return [...inlineResults, ...fileResults];\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[externalProjectsLoader] Chargement impossible :', error);\n    }\n    return [];\n  }\n};\n\n",
  "src/utils/inspirationConfig.js": "const DEFAULT_INSPIRATION_FILTERS = {\n  fields: [\n    {\n      id: 'labName',\n      label: 'Nom du labo',\n      type: 'select',\n      enabled: true,\n      sourceQuestionId: 'labName'\n    },\n    {\n      id: 'target',\n      label: 'Cible du projet',\n      type: 'select',\n      enabled: true,\n      options: ['PS', 'Patient', 'GP'],\n      sourceQuestionId: 'target'\n    },\n    {\n      id: 'typology',\n      label: 'Typologie',\n      type: 'select',\n      enabled: true,\n      options: ['Digital', 'Print'],\n      sourceQuestionId: 'typology'\n    },\n    {\n      id: 'therapeuticArea',\n      label: 'Aire thÃ©rapeutique',\n      type: 'select',\n      enabled: true,\n      options: ['Immunologie', 'HÃ©mostase', 'Soins intensifs'],\n      sourceQuestionId: 'therapeuticArea'\n    },\n    {\n      id: 'country',\n      label: 'Pays',\n      type: 'select',\n      enabled: true,\n      options: ['France', 'Europe', 'Ã‰tats-Unis', 'Autre'],\n      sourceQuestionId: 'country'\n    }\n  ]\n};\n\nconst DEFAULT_INSPIRATION_FORM_FIELDS = {\n  fields: [\n    {\n      id: 'title',\n      label: 'Titre du projet',\n      type: 'text',\n      required: true,\n      enabled: true\n    },\n    {\n      id: 'labName',\n      label: 'Nom du laboratoire / association',\n      type: 'text',\n      required: true,\n      enabled: true\n    },\n    {\n      id: 'target',\n      label: 'Cible du projet',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['PS', 'Patient', 'GP']\n    },\n    {\n      id: 'typology',\n      label: 'Typologie',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['Digital', 'Print']\n    },\n    {\n      id: 'therapeuticArea',\n      label: 'Aire thÃ©rapeutique',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['Immunologie', 'HÃ©mostase', 'Soins intensifs']\n    },\n    {\n      id: 'country',\n      label: 'Pays',\n      type: 'select',\n      required: true,\n      enabled: true,\n      options: ['France', 'Europe', 'Ã‰tats-Unis', 'Autre']\n    },\n    {\n      id: 'description',\n      label: 'Description du projet',\n      type: 'long_text',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'link',\n      label: 'Lien utile',\n      type: 'url',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'documents',\n      label: 'Documents',\n      type: 'documents',\n      required: false,\n      enabled: true\n    },\n    {\n      id: 'review',\n      label: 'Avis sur le projet',\n      type: 'long_text',\n      required: false,\n      enabled: true\n    }\n  ]\n};\n\nconst clone = (value) => {\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch (error) {\n    return value;\n  }\n};\n\nconst sanitizeIdentifier = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : '';\n};\n\nconst sanitizeLabel = (label, fallback) => {\n  if (typeof label !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = label.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst sanitizeBoolean = (value, fallback = true) => {\n  if (typeof value === 'boolean') {\n    return value;\n  }\n  return fallback;\n};\n\nconst sanitizeOptionsList = (options) => {\n  if (!Array.isArray(options)) {\n    return [];\n  }\n\n  return options\n    .map((option) => (typeof option === 'string' ? option.trim() : ''))\n    .filter(Boolean);\n};\n\nconst sanitizeEmptyOptionLabel = (value, fallback = 'Toutes les valeurs') => {\n  if (typeof value !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst normalizeFilterField = (field) => {\n  if (!field || typeof field !== 'object') {\n    return null;\n  }\n\n  const id = sanitizeIdentifier(field.id);\n  if (!id) {\n    return null;\n  }\n\n  const rawType = typeof field.type === 'string' ? field.type : 'text';\n  const type = rawType === 'select' ? 'select' : 'text';\n\n  const normalized = {\n    id,\n    label: sanitizeLabel(field.label, id),\n    type,\n    enabled: sanitizeBoolean(field.enabled, true)\n  };\n\n  const sourceQuestionId = sanitizeIdentifier(field.sourceQuestionId);\n  if (sourceQuestionId) {\n    normalized.sourceQuestionId = sourceQuestionId;\n  }\n\n  if (type === 'select') {\n    normalized.options = sanitizeOptionsList(field.options);\n    if (Object.prototype.hasOwnProperty.call(field, 'emptyOptionLabel')) {\n      normalized.emptyOptionLabel = sanitizeEmptyOptionLabel(field.emptyOptionLabel);\n    }\n  }\n\n  return normalized;\n};\n\nconst normalizeFormField = (field) => {\n  if (!field || typeof field !== 'object') {\n    return null;\n  }\n\n  const id = sanitizeIdentifier(field.id);\n  if (!id) {\n    return null;\n  }\n\n  const type = typeof field.type === 'string' ? field.type : 'text';\n\n  const normalized = {\n    id,\n    label: sanitizeLabel(field.label, id),\n    type,\n    enabled: sanitizeBoolean(field.enabled, true)\n  };\n\n  if (typeof field.required === 'boolean') {\n    normalized.required = field.required;\n  }\n\n  if (typeof field.placeholder === 'string') {\n    normalized.placeholder = field.placeholder;\n  }\n\n  if (type === 'select' || type === 'multi_select') {\n    normalized.options = sanitizeOptionsList(field.options);\n  }\n\n  return normalized;\n};\n\nconst normalizeFilterConfig = (config, fallback) => {\n  if (!config || typeof config !== 'object') {\n    return clone(fallback);\n  }\n\n  if (!Array.isArray(config.fields)) {\n    return clone(fallback);\n  }\n\n  const fields = config.fields.map(normalizeFilterField).filter(Boolean);\n  return { fields };\n};\n\nconst normalizeFormConfig = (config, fallback) => {\n  const base = config && typeof config === 'object' ? config : {};\n  const fields = Array.isArray(base.fields) ? base.fields.map(normalizeFormField).filter(Boolean) : [];\n\n  if (fields.length === 0) {\n    return clone(fallback);\n  }\n\n  return { fields };\n};\n\nexport const createDefaultInspirationFiltersConfig = () => clone(DEFAULT_INSPIRATION_FILTERS);\n\nexport const createDefaultInspirationFormConfig = () => clone(DEFAULT_INSPIRATION_FORM_FIELDS);\n\nexport const normalizeInspirationFiltersConfig = (config) =>\n  normalizeFilterConfig(config, DEFAULT_INSPIRATION_FILTERS);\n\nexport const normalizeInspirationFormConfig = (config) =>\n  normalizeFormConfig(config, DEFAULT_INSPIRATION_FORM_FIELDS);\n\nexport const resetInspirationFiltersConfig = () => createDefaultInspirationFiltersConfig();\n\nexport const resetInspirationFormConfig = () => createDefaultInspirationFormConfig();\n\nexport const updateInspirationFilterField = (config, fieldId, updates) => {\n  const normalized = normalizeInspirationFiltersConfig(config);\n  const nextFields = normalized.fields.map((field) => {\n    if (field.id !== fieldId) {\n      return field;\n    }\n\n    const updated = { ...field };\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'label')) {\n      updated.label = updates.label;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'enabled')) {\n      updated.enabled = updates.enabled;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'type')) {\n      updated.type = updates.type === 'select' ? 'select' : 'text';\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'options') && updated.type === 'select') {\n      updated.options = updates.options;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'emptyOptionLabel') && updated.type === 'select') {\n      updated.emptyOptionLabel = updates.emptyOptionLabel;\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'sourceQuestionId')) {\n      updated.sourceQuestionId = updates.sourceQuestionId;\n    }\n\n    return normalizeFilterField(updated) || field;\n  });\n\n  return { ...normalized, fields: nextFields };\n};\n\nexport const updateInspirationFormField = (config, fieldId, updates) => {\n  const normalized = normalizeInspirationFormConfig(config);\n  const nextFields = normalized.fields.map((field) => {\n    if (field.id !== fieldId) {\n      return field;\n    }\n\n    const updated = { ...field, ...updates };\n    return normalizeFormField(updated) || field;\n  });\n\n  return { ...normalized, fields: nextFields };\n};\n",
  "src/utils/inspirationExport.js": "const INSPIRATION_INDEX_STORAGE_KEY = 'complianceNavigatorInspirationExportIndex';\n\nconst getStoredInspirationIndex = () => {\n  if (typeof window === 'undefined' || !window.localStorage) {\n    return null;\n  }\n\n  try {\n    const raw = window.localStorage.getItem(INSPIRATION_INDEX_STORAGE_KEY);\n    if (!raw) {\n      return null;\n    }\n    const parsed = Number.parseInt(raw, 10);\n    return Number.isFinite(parsed) && parsed > 0 ? parsed : null;\n  } catch (error) {\n    return null;\n  }\n};\n\nconst storeNextInspirationIndex = (value) => {\n  if (typeof window === 'undefined' || !window.localStorage) {\n    return;\n  }\n\n  try {\n    window.localStorage.setItem(INSPIRATION_INDEX_STORAGE_KEY, String(value));\n  } catch (error) {\n    // Ignore storage failures.\n  }\n};\n\nexport const getNextInspirationExportIndex = () => {\n  const stored = getStoredInspirationIndex();\n  return stored || 1;\n};\n\nexport const buildInspirationExport = (project) => {\n  const payload = project && typeof project === 'object' ? project : {};\n  const { externalSourceId, externalSourceChecksum, ...cleaned } = payload;\n\n  return {\n    version: 1,\n    generatedAt: new Date().toISOString(),\n    inspiration: cleaned\n  };\n};\n\nexport const downloadInspirationJson = (project, { index } = {}) => {\n  if (!project) {\n    return false;\n  }\n\n  const exportPayload = buildInspirationExport(project);\n  let jsonString = '';\n\n  try {\n    jsonString = JSON.stringify(exportPayload, null, 2);\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[inspirationExport] Impossible de sÃ©rialiser l\\'inspiration :', error);\n    }\n    return false;\n  }\n\n  if (\n    typeof document === 'undefined'\n    || typeof URL === 'undefined'\n    || typeof URL.createObjectURL !== 'function'\n    || typeof Blob === 'undefined'\n  ) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[inspirationExport] Environnement incompatible avec le tÃ©lÃ©chargement de fichiers.');\n    }\n    return false;\n  }\n\n  const safeIndex = Number.isFinite(index) && index > 0 ? index : getNextInspirationExportIndex();\n  const fileName = `inspiration${safeIndex}.json`;\n\n  try {\n    const blob = new Blob([jsonString], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = fileName;\n    anchor.style.display = 'none';\n    document.body.appendChild(anchor);\n    anchor.click();\n    document.body.removeChild(anchor);\n    setTimeout(() => {\n      if (typeof URL.revokeObjectURL === 'function') {\n        URL.revokeObjectURL(url);\n      }\n    }, 0);\n    storeNextInspirationIndex(safeIndex + 1);\n    return true;\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[inspirationExport] TÃ©lÃ©chargement de l\\'inspiration impossible :', error);\n    }\n    return false;\n  }\n};\n\nexport const exportInspirationToFile = (project) => downloadInspirationJson(project);\n",
  "src/utils/linkify.js": "import React from '../react.js';\nimport { sanitizeRichText } from './richText.js';\n\nconst URL_REGEX = /(https?:\\/\\/[^\\s]+)/g;\nconst TRAILING_PUNCTUATION_REGEX = /[)\\]\\}.,;!?]+$/;\n\nconst renderWithDomSanitizer = (text) => {\n  if (typeof DOMParser === 'undefined' || typeof document === 'undefined') {\n    return null;\n  }\n\n  const sanitized = sanitizeRichText(text);\n\n  if (typeof sanitized !== 'string' || sanitized.length === 0) {\n    return null;\n  }\n\n  return <span className=\"hv-richtext\" dangerouslySetInnerHTML={{ __html: sanitized }} />;\n};\n\nconst renderWithoutDomParser = (text) => {\n  const matches = Array.from(text.matchAll(URL_REGEX));\n\n  if (matches.length === 0) {\n    return text;\n  }\n\n  const elements = [];\n  let lastIndex = 0;\n\n  matches.forEach((match, matchIdx) => {\n    const fullMatch = match[0];\n    const offset = match.index ?? 0;\n\n    if (offset > lastIndex) {\n      elements.push(text.slice(lastIndex, offset));\n    }\n\n    let url = fullMatch;\n    const trailingMatch = url.match(TRAILING_PUNCTUATION_REGEX);\n    let trailing = '';\n\n    if (trailingMatch) {\n      url = url.slice(0, -trailingMatch[0].length);\n      trailing = trailingMatch[0];\n    }\n\n    elements.push(\n      <a\n        key={`link-${offset}-${matchIdx}`}\n        href={url}\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        className=\"text-blue-600 underline\"\n      >\n        {url}\n      </a>\n    );\n\n    if (trailing) {\n      elements.push(trailing);\n    }\n\n    lastIndex = offset + fullMatch.length;\n  });\n\n  if (lastIndex < text.length) {\n    elements.push(text.slice(lastIndex));\n  }\n\n  return elements;\n};\n\nexport const renderTextWithLinks = (text) => {\n  if (typeof text !== 'string' || text.length === 0) {\n    return text;\n  }\n\n  const rendered = renderWithDomSanitizer(text);\n\n  if (rendered !== null) {\n    return rendered;\n  }\n\n  return renderWithoutDomParser(text);\n};\n",
  "src/utils/onboarding.js": "import { initialOnboardingTourConfig } from '../data/onboardingTour.js';\n\nconst DEFAULT_ACTION_VARIANT = 'ghost';\nconst ALLOWED_ACTIONS = new Set(['next', 'prev', 'close', 'finish', 'goTo']);\nconst ALLOWED_HIGHLIGHT_SCOPES = new Set(['target', 'page']);\n\nconst sanitizeString = (value, fallback = '') =>\n  typeof value === 'string' ? value.trim() : fallback;\n\nconst sanitizeText = (value, fallback = '') => {\n  if (typeof value !== 'string') {\n    return fallback;\n  }\n\n  return value.trim().length > 0 ? value : fallback;\n};\n\nconst normalizeStepId = (value, index) => {\n  const candidate = sanitizeString(value);\n  if (candidate) {\n    return candidate;\n  }\n  return `step-${index + 1}`;\n};\n\nexport const createOnboardingStep = (index = 0) => ({\n  id: `step-${index + 1}`,\n  target: '#tour-onboarding-anchor',\n  title: 'Nouvelle Ã©tape',\n  content: '',\n  placement: 'bottom',\n  highlightScope: 'target',\n  showDefaultButtons: true,\n  actions: []\n});\n\nexport const createOnboardingAction = () => ({\n  id: `action-${Date.now().toString(36)}`,\n  label: 'Nouvelle action',\n  action: 'next',\n  stepId: '',\n  variant: 'ghost'\n});\n\nexport const normalizeOnboardingConfig = (config, fallback = initialOnboardingTourConfig) => {\n  const base = config && typeof config === 'object' ? config : fallback;\n  const fallbackLabels = fallback?.labels || {};\n  const labels = base?.labels || {};\n\n  const steps = Array.isArray(base?.steps) ? base.steps : Array.isArray(fallback?.steps) ? fallback.steps : [];\n\n  return {\n    allowClose: typeof base?.allowClose === 'boolean' ? base.allowClose : fallback?.allowClose ?? true,\n    showStepDots: typeof base?.showStepDots === 'boolean' ? base.showStepDots : fallback?.showStepDots ?? true,\n    labels: {\n      next: sanitizeText(labels.next, sanitizeText(fallbackLabels.next, 'Suivant')),\n      prev: sanitizeText(labels.prev, sanitizeText(fallbackLabels.prev, 'PrÃ©cÃ©dent')),\n      close: sanitizeText(labels.close, sanitizeText(fallbackLabels.close, 'Fermer')),\n      finish: sanitizeText(labels.finish, sanitizeText(fallbackLabels.finish, 'Terminer'))\n    },\n    steps: steps.map((step, index) => {\n      const fallbackStep = fallback?.steps?.[index] || {};\n      const rawStep = step && typeof step === 'object' ? step : fallbackStep;\n      const actions = Array.isArray(rawStep?.actions) ? rawStep.actions : [];\n\n      return {\n        id: normalizeStepId(rawStep?.id, index),\n        target: sanitizeString(rawStep?.target, sanitizeString(fallbackStep?.target)),\n        title: sanitizeText(rawStep?.title, sanitizeText(fallbackStep?.title)),\n        content: sanitizeText(rawStep?.content, sanitizeText(fallbackStep?.content)),\n        placement: sanitizeString(rawStep?.placement, sanitizeString(fallbackStep?.placement)),\n        highlightScope: ALLOWED_HIGHLIGHT_SCOPES.has(rawStep?.highlightScope)\n          ? rawStep.highlightScope\n          : ALLOWED_HIGHLIGHT_SCOPES.has(fallbackStep?.highlightScope)\n            ? fallbackStep.highlightScope\n            : 'target',\n        highlightPadding: typeof rawStep?.highlightPadding === 'number'\n          ? rawStep.highlightPadding\n          : fallbackStep?.highlightPadding,\n        scrollIntoViewOptions: rawStep?.scrollIntoViewOptions || fallbackStep?.scrollIntoViewOptions,\n        scrollDuration: rawStep?.scrollDuration || fallbackStep?.scrollDuration,\n        showDefaultButtons: rawStep?.showDefaultButtons !== false,\n        actions: actions\n          .filter(action => action && typeof action === 'object')\n          .map((action) => ({\n            id: sanitizeString(action.id) || `action-${index}-${Date.now().toString(36)}`,\n            label: sanitizeText(action.label, 'Action'),\n            action: ALLOWED_ACTIONS.has(action.action) ? action.action : 'next',\n            stepId: sanitizeString(action.stepId),\n            variant: sanitizeString(action.variant, DEFAULT_ACTION_VARIANT)\n          }))\n      };\n    })\n  };\n};\n",
  "src/utils/operatorOptions.js": "const TEXT_OPERATOR_OPTIONS = [\n  { value: 'equals', label: 'Est Ã©gal Ã  (=)' },\n  { value: 'not_equals', label: 'Est diffÃ©rent de (â‰ )' },\n  { value: 'contains', label: 'Contient' }\n];\n\nconst NUMBER_OPERATOR_OPTIONS = [\n  { value: 'lt', label: 'InfÃ©rieur (<)' },\n  { value: 'lte', label: 'InfÃ©rieur ou Ã©gal (â‰¤)' },\n  { value: 'equals', label: 'Ã‰gal (=)' },\n  { value: 'gte', label: 'SupÃ©rieur ou Ã©gal (â‰¥)' },\n  { value: 'gt', label: 'SupÃ©rieur (>)' }\n];\n\nconst OPERATOR_LABELS = {\n  equals: 'est Ã©gal Ã ',\n  not_equals: 'est diffÃ©rent de',\n  contains: 'contient',\n  lt: 'est infÃ©rieur Ã ',\n  lte: 'est infÃ©rieur ou Ã©gal Ã ',\n  gt: 'est supÃ©rieur Ã ',\n  gte: 'est supÃ©rieur ou Ã©gal Ã '\n};\n\nexport const getOperatorOptionsForType = (questionType = 'choice') => {\n  return questionType === 'number' ? NUMBER_OPERATOR_OPTIONS : TEXT_OPERATOR_OPTIONS;\n};\n\nexport const ensureOperatorForType = (questionType = 'choice', operator = 'equals') => {\n  const options = getOperatorOptionsForType(questionType);\n  if (options.some(option => option.value === operator)) {\n    return operator;\n  }\n\n  return options.length > 0 ? options[0].value : 'equals';\n};\n\nexport const getOperatorLabel = (operator) => {\n  return OPERATOR_LABELS[operator] || operator || '=';\n};\n\nexport const getOperatorOptions = () => {\n  return {\n    text: TEXT_OPERATOR_OPTIONS,\n    number: NUMBER_OPERATOR_OPTIONS\n  };\n};\n",
  "src/utils/projectExport.js": "export const sanitizeFileName = (value, fallback = 'projet-compliance') => {\n  if (typeof value !== 'string') {\n    return fallback;\n  }\n\n  let normalized = value.trim();\n  if (normalized.length === 0) {\n    return fallback;\n  }\n\n  try {\n    normalized = normalized.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n  } catch (error) {\n    normalized = normalized.replace(/[^\\w\\s-]/g, '');\n  }\n\n  const sanitized = normalized\n    .replace(/[^a-zA-Z0-9-_]+/g, '-')\n    .replace(/-{2,}/g, '-')\n    .replace(/^-+|-+$/g, '')\n    .slice(0, 60);\n\n  return sanitized.length > 0 ? sanitized : fallback;\n};\n\nexport const getTeamPriority = (analysis, teamId) => {\n  if (!analysis) {\n    return 'A rÃ©aliser';\n  }\n\n  const priorityWeights = {\n    'A rÃ©aliser': 1,\n    'A anticiper': 2,\n    'A particuliÃ¨rement anticiper': 3\n  };\n\n  const getWeight = (priority) => priorityWeights[priority] || 0;\n\n  const risks = Array.isArray(analysis.risks) ? analysis.risks : [];\n  let bestPriority = 'A rÃ©aliser';\n\n  risks.forEach(risk => {\n    const associatedTeams = new Set();\n\n    if (risk?.teamId) {\n      associatedTeams.add(risk.teamId);\n    }\n\n    if (Array.isArray(risk?.teams)) {\n      risk.teams.forEach(team => associatedTeams.add(team));\n    }\n\n    if (!associatedTeams.has(teamId)) {\n      return;\n    }\n\n    const riskPriority = risk?.priority || 'A rÃ©aliser';\n    if (getWeight(riskPriority) > getWeight(bestPriority)) {\n      bestPriority = riskPriority;\n    }\n  });\n\n  return bestPriority;\n};\n\nexport const buildProjectExport = ({ projectName, answers } = {}) => {\n  const normalizedAnswers =\n    answers && typeof answers === 'object' ? answers : {};\n\n  return {\n    version: 1,\n    generatedAt: new Date().toISOString(),\n    project: {\n      name: projectName || 'Projet sans nom',\n      answers: normalizedAnswers\n    }\n  };\n};\n\nexport const downloadProjectJson = (projectData, { projectName } = {}) => {\n  let jsonString = '';\n  let inferredName = projectName;\n\n  if (typeof projectData === 'string') {\n    jsonString = projectData;\n  } else if (projectData) {\n    inferredName = inferredName || projectData?.project?.name;\n    try {\n      jsonString = JSON.stringify(projectData, null, 2);\n    } catch (error) {\n      if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error('[projectExport] Impossible de sÃ©rialiser le projet :', error);\n      }\n      jsonString = JSON.stringify(\n        {\n          version: 1,\n          project: {\n            name: projectData?.project?.name || 'Projet sans nom',\n            answers: {}\n          }\n        },\n        null,\n        2\n      );\n    }\n  }\n\n  if (!jsonString) {\n    return false;\n  }\n\n  const fileNameBase = sanitizeFileName(inferredName || 'Projet compliance');\n  const fileName = `${fileNameBase}.json`;\n\n  if (\n    typeof document === 'undefined'\n    || typeof URL === 'undefined'\n    || typeof URL.createObjectURL !== 'function'\n    || typeof Blob === 'undefined'\n  ) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[projectExport] Environnement incompatible avec le tÃ©lÃ©chargement de fichiers.');\n    }\n    return false;\n  }\n\n  try {\n    const blob = new Blob([jsonString], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const anchor = document.createElement('a');\n    anchor.href = url;\n    anchor.download = fileName;\n    anchor.style.display = 'none';\n    document.body.appendChild(anchor);\n    anchor.click();\n    document.body.removeChild(anchor);\n    setTimeout(() => {\n      if (typeof URL.revokeObjectURL === 'function') {\n        URL.revokeObjectURL(url);\n      }\n    }, 0);\n    return true;\n  } catch (error) {\n    if (typeof console !== 'undefined' && typeof console.warn === 'function') {\n      console.warn('[projectExport] TÃ©lÃ©chargement du projet impossible :', error);\n    }\n    return false;\n  }\n};\n\nexport const exportProjectToFile = ({ projectName, answers } = {}) => {\n  const exportPayload = buildProjectExport({\n    projectName,\n    answers\n  });\n\n  return downloadProjectJson(exportPayload, { projectName });\n};\n",
  "src/utils/projectFilters.js": "const DEFAULT_FIELDS = [\n  {\n    id: 'projectName',\n    label: 'Titre du projet',\n    type: 'text',\n    enabled: true,\n    sourceQuestionId: 'projectName'\n  },\n  {\n    id: 'teamLead',\n    label: 'Lead du projet',\n    type: 'text',\n    enabled: true,\n    sourceQuestionId: 'teamLead'\n  },\n  {\n    id: 'teamLeadTeam',\n    label: 'Ã‰quipe du lead projet',\n    type: 'select',\n    enabled: true,\n    sourceQuestionId: 'teamLeadTeam',\n    emptyOptionLabel: 'Toutes les Ã©quipes'\n  },\n  {\n    id: 'dateOrder',\n    label: 'Ordre des projets',\n    type: 'sort',\n    enabled: true,\n    defaultValue: 'desc'\n  }\n];\n\nconst DEFAULT_SORT_VALUE = 'desc';\n\nconst DEFAULT_FIELD_MAP = new Map(DEFAULT_FIELDS.map((field) => [field.id, field]));\n\nconst sanitizeIdentifier = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : '';\n};\n\nexport const createDefaultProjectFiltersConfig = () => ({\n  fields: DEFAULT_FIELDS.map((field) => ({ ...field })),\n  sortOrder: DEFAULT_SORT_VALUE\n});\n\nconst sanitizeLabel = (label, fallback) => {\n  if (typeof label !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = label.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst sanitizeBoolean = (value, fallback = true) => {\n  if (typeof value === 'boolean') {\n    return value;\n  }\n  return fallback;\n};\n\nconst sanitizeSortValue = (value, fallback = DEFAULT_SORT_VALUE) => {\n  return value === 'asc' || value === 'desc' ? value : fallback;\n};\n\nconst sanitizeEmptyOptionLabel = (value, fallback) => {\n  if (typeof value !== 'string') {\n    return fallback;\n  }\n\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : fallback;\n};\n\nconst sanitizeOptionsList = (options) => {\n  if (!Array.isArray(options)) {\n    return undefined;\n  }\n\n  const sanitized = Array.from(\n    new Set(\n      options\n        .map((option) => (typeof option === 'string' ? option.trim() : ''))\n        .filter((option) => option.length > 0)\n    )\n  );\n\n  return sanitized.length > 0 ? sanitized : undefined;\n};\n\nexport const normalizeProjectFilterConfig = (config) => {\n  const base = createDefaultProjectFiltersConfig();\n\n  if (!config || typeof config !== 'object') {\n    return base;\n  }\n\n  const normalizedFields = [];\n  const seenIds = new Set();\n\n  if (Array.isArray(config.fields)) {\n    config.fields.forEach((field) => {\n      if (!field || typeof field !== 'object') {\n        return;\n      }\n\n      const rawId = sanitizeIdentifier(field.id);\n      if (rawId.length === 0 || seenIds.has(rawId)) {\n        return;\n      }\n\n      const defaultField = DEFAULT_FIELD_MAP.get(rawId);\n\n      if (defaultField) {\n        const normalizedField = {\n          ...defaultField,\n          label: sanitizeLabel(field.label, defaultField.label),\n          enabled: sanitizeBoolean(field.enabled, defaultField.enabled)\n        };\n\n        if (defaultField.type === 'sort') {\n          normalizedField.defaultValue = sanitizeSortValue(\n            field.defaultValue,\n            defaultField.defaultValue || DEFAULT_SORT_VALUE\n          );\n        }\n\n        if (defaultField.sourceQuestionId) {\n          normalizedField.sourceQuestionId = sanitizeIdentifier(field.sourceQuestionId) || defaultField.sourceQuestionId;\n        }\n\n        if (defaultField.type === 'select') {\n          normalizedField.emptyOptionLabel = sanitizeEmptyOptionLabel(\n            field.emptyOptionLabel,\n            defaultField.emptyOptionLabel || 'Toutes les valeurs'\n          );\n          const presetOptions = sanitizeOptionsList(field.options);\n          if (presetOptions) {\n            normalizedField.options = presetOptions;\n          }\n        }\n\n        normalizedFields.push(normalizedField);\n        seenIds.add(rawId);\n        return;\n      }\n\n      const normalizedType = field.type === 'select' ? 'select' : 'text';\n      const sourceQuestionId = sanitizeIdentifier(field.sourceQuestionId) || rawId;\n      const normalizedField = {\n        id: rawId,\n        label: sanitizeLabel(field.label, 'Filtre personnalisÃ©'),\n        type: normalizedType,\n        enabled: sanitizeBoolean(field.enabled, true)\n      };\n\n      if (normalizedType === 'select') {\n        normalizedField.emptyOptionLabel = sanitizeEmptyOptionLabel(\n          field.emptyOptionLabel,\n          'Toutes les valeurs'\n        );\n        const presetOptions = sanitizeOptionsList(field.options);\n        if (presetOptions) {\n          normalizedField.options = presetOptions;\n        }\n      }\n\n      if (sourceQuestionId) {\n        normalizedField.sourceQuestionId = sourceQuestionId;\n      }\n\n      normalizedFields.push(normalizedField);\n      seenIds.add(rawId);\n    });\n  }\n\n  if (normalizedFields.length === 0) {\n    return {\n      fields: [],\n      sortOrder: sanitizeSortValue(config.sortOrder, DEFAULT_SORT_VALUE)\n    };\n  }\n\n  const sortField = normalizedFields.find((field) => field && field.type === 'sort');\n  const sortOrder = sanitizeSortValue(config.sortOrder, DEFAULT_SORT_VALUE);\n\n  if (sortField && sortField.type === 'sort') {\n    sortField.defaultValue = sanitizeSortValue(\n      sortField.defaultValue,\n      DEFAULT_FIELD_MAP.get(sortField.id)?.defaultValue || DEFAULT_SORT_VALUE\n    );\n  }\n\n  return {\n    fields: normalizedFields,\n    sortOrder\n  };\n};\n\nexport const updateProjectFilterField = (config, fieldId, updates = {}) => {\n  const normalized = normalizeProjectFilterConfig(config);\n  const fields = normalized.fields.map((field) => {\n    if (field.id !== fieldId) {\n      return field;\n    }\n\n    const patch = { ...field };\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'label')) {\n      patch.label = sanitizeLabel(updates.label, field.label);\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'enabled')) {\n      patch.enabled = sanitizeBoolean(updates.enabled, field.enabled);\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'type')) {\n      const normalizedType = updates.type === 'select' ? 'select' : updates.type === 'sort' ? 'sort' : 'text';\n      patch.type = normalizedType;\n\n      if (normalizedType === 'sort') {\n        patch.defaultValue = sanitizeSortValue(updates.defaultValue, field.defaultValue || DEFAULT_SORT_VALUE);\n      } else if (normalizedType === 'select') {\n        patch.emptyOptionLabel = sanitizeEmptyOptionLabel(\n          updates.emptyOptionLabel,\n          field.emptyOptionLabel || 'Toutes les valeurs'\n        );\n        const presetOptions = sanitizeOptionsList(updates.options);\n        if (presetOptions) {\n          patch.options = presetOptions;\n        } else {\n          delete patch.options;\n        }\n      } else {\n        delete patch.emptyOptionLabel;\n        delete patch.options;\n      }\n    }\n\n    if (field.type === 'sort' && Object.prototype.hasOwnProperty.call(updates, 'defaultValue')) {\n      patch.defaultValue = sanitizeSortValue(updates.defaultValue, field.defaultValue);\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'emptyOptionLabel') && field.type === 'select') {\n      patch.emptyOptionLabel = sanitizeEmptyOptionLabel(\n        updates.emptyOptionLabel,\n        field.emptyOptionLabel || 'Toutes les valeurs'\n      );\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'options') && field.type === 'select') {\n      const presetOptions = sanitizeOptionsList(updates.options);\n      if (presetOptions) {\n        patch.options = presetOptions;\n      } else {\n        delete patch.options;\n      }\n    }\n\n    if (Object.prototype.hasOwnProperty.call(updates, 'sourceQuestionId')) {\n      const sanitizedSource = sanitizeIdentifier(updates.sourceQuestionId);\n      if (sanitizedSource) {\n        patch.sourceQuestionId = sanitizedSource;\n      } else {\n        delete patch.sourceQuestionId;\n      }\n    }\n\n    return patch;\n  });\n\n  return {\n    ...normalized,\n    fields\n  };\n};\n\nexport const resetProjectFiltersConfig = () => createDefaultProjectFiltersConfig();\n",
  "src/utils/projectNormalization.js": "import { initialQuestions } from '../data/questions.js';\nimport { shouldShowQuestion } from './questions.js';\n\nconst isAnswerProvided = (value) => {\n  if (Array.isArray(value)) {\n    return value.length > 0;\n  }\n\n  if (typeof value === 'string') {\n    return value.trim().length > 0;\n  }\n\n  return value !== null && value !== undefined;\n};\n\nexport const normalizeProjectEntry = (\n  project = {},\n  fallbackQuestionsLength = initialQuestions.length\n) => {\n  const answers = typeof project.answers === 'object' && project.answers !== null\n    ? project.answers\n    : {};\n\n  const questionCatalog = Array.isArray(project.availableQuestions)\n    ? project.availableQuestions\n    : Array.isArray(project.questions)\n      ? project.questions\n      : initialQuestions;\n\n  const visibleQuestions = questionCatalog.filter(question => {\n    if (!question || typeof question !== 'object') {\n      return false;\n    }\n\n    return shouldShowQuestion(question, answers);\n  });\n  const derivedTotalQuestions = visibleQuestions.length;\n  const derivedAnsweredQuestions = visibleQuestions.length > 0\n    ? visibleQuestions.filter(question => {\n      if (!question || typeof question.id === 'undefined') {\n        return false;\n      }\n\n      return isAnswerProvided(answers[question.id]);\n    }).length\n    : Object.keys(answers).length;\n\n  const computedTotalQuestions =\n    typeof project.totalQuestions === 'number' && project.totalQuestions > 0\n      ? project.totalQuestions\n      : derivedTotalQuestions > 0\n        ? derivedTotalQuestions\n        : fallbackQuestionsLength > 0\n          ? fallbackQuestionsLength\n          : Object.keys(answers).length;\n\n  const answeredQuestionsCount =\n    typeof project.answeredQuestions === 'number'\n      ? project.answeredQuestions\n      : derivedAnsweredQuestions;\n\n  let lastQuestionIndex =\n    typeof project.lastQuestionIndex === 'number'\n      ? project.lastQuestionIndex\n      : computedTotalQuestions > 0\n        ? computedTotalQuestions - 1\n        : 0;\n\n  if (computedTotalQuestions > 0) {\n    lastQuestionIndex = Math.min(Math.max(lastQuestionIndex, 0), computedTotalQuestions - 1);\n  }\n\n  const lastUpdated = project.lastUpdated || project.submittedAt || null;\n  const submittedAt = project.submittedAt || project.lastUpdated || null;\n\n  return {\n    status: 'submitted',\n    ...project,\n    status: project.status || 'submitted',\n    lastUpdated,\n    submittedAt,\n    totalQuestions: computedTotalQuestions,\n    answeredQuestions: Math.min(\n      answeredQuestionsCount,\n      computedTotalQuestions || answeredQuestionsCount\n    ),\n    lastQuestionIndex\n  };\n};\n\nexport const normalizeProjectsCollection = (\n  projects,\n  fallbackQuestionsLength = initialQuestions.length\n) => {\n  if (!Array.isArray(projects)) {\n    return null;\n  }\n\n  return projects.map(project => normalizeProjectEntry(project, fallbackQuestionsLength));\n};\n\n",
  "src/utils/projects.js": "export const extractProjectName = (answers, questions) => {\n  if (!answers || !questions) {\n    return '';\n  }\n\n  const preferredKeys = ['projectName', 'project_name', 'nomProjet', 'nom_projet'];\n\n  for (const key of preferredKeys) {\n    const value = answers[key];\n    if (typeof value === 'string' && value.trim().length > 0) {\n      return value.trim();\n    }\n  }\n\n  const matchingQuestion = questions.find(question => {\n    if (!question || !question.question) {\n      return false;\n    }\n\n    const text = question.question.toLowerCase();\n    return (\n      text.includes('nom') &&\n      text.includes('projet') &&\n      typeof answers[question.id] === 'string' &&\n      answers[question.id].trim() !== ''\n    );\n  });\n\n  if (matchingQuestion) {\n    return answers[matchingQuestion.id].trim();\n  }\n\n  return '';\n};\n",
  "src/utils/questions.js": "import { normalizeConditionGroups } from './conditionGroups.js';\nimport { formatRankingAnswer } from './ranking.js';\n\nconst normalizeAnswerForComparison = (answer) => {\n  if (Array.isArray(answer)) {\n    return answer;\n  }\n\n  if (answer && typeof answer === 'object') {\n    if (typeof answer.value !== 'undefined') {\n      return answer.value;\n    }\n\n    if (typeof answer.name !== 'undefined') {\n      return answer.name;\n    }\n  }\n\n  return answer;\n};\n\nconst toNumber = (value) => {\n  if (value === null || value === undefined || value === '') {\n    return null;\n  }\n\n  const parsed = Number(value);\n  return Number.isNaN(parsed) ? null : parsed;\n};\n\nconst evaluateQuestionCondition = (condition, answers) => {\n  const rawAnswer = answers[condition.question];\n  if (Array.isArray(rawAnswer) && rawAnswer.length === 0) return false;\n  if (rawAnswer === null || rawAnswer === undefined || rawAnswer === '') return false;\n\n  const answer = normalizeAnswerForComparison(rawAnswer);\n\n  switch (condition.operator) {\n    case 'equals':\n      if (Array.isArray(answer)) {\n        return answer.includes(condition.value);\n      }\n      return answer === condition.value;\n    case 'not_equals':\n      if (Array.isArray(answer)) {\n        return !answer.includes(condition.value);\n      }\n      return answer !== condition.value;\n    case 'contains':\n      if (Array.isArray(answer)) {\n        return answer.includes(condition.value);\n      }\n      if (typeof answer === 'string') {\n        return answer.includes(condition.value);\n      }\n      return false;\n    case 'lt':\n    case 'lte':\n    case 'gt':\n    case 'gte': {\n      if (Array.isArray(answer)) {\n        return false;\n      }\n\n      const answerNumber = toNumber(answer);\n      const expectedNumber = toNumber(condition.value);\n\n      if (answerNumber === null || expectedNumber === null) {\n        return false;\n      }\n\n      switch (condition.operator) {\n        case 'lt':\n          return answerNumber < expectedNumber;\n        case 'lte':\n          return answerNumber <= expectedNumber;\n        case 'gt':\n          return answerNumber > expectedNumber;\n        case 'gte':\n          return answerNumber >= expectedNumber;\n        default:\n          return false;\n      }\n    }\n    default:\n      return false;\n  }\n};\n\nexport const shouldShowQuestion = (question, answers) => {\n  const conditionGroups = normalizeConditionGroups(question);\n\n  if (conditionGroups.length === 0) {\n    return true;\n  }\n\n  return conditionGroups.every(group => {\n    const groupConditions = Array.isArray(group.conditions) ? group.conditions : [];\n    if (groupConditions.length === 0) {\n      return true;\n    }\n\n    const logic = group.logic === 'any' ? 'any' : 'all';\n\n    if (logic === 'any') {\n      return groupConditions.some(condition => evaluateQuestionCondition(condition, answers));\n    }\n\n    return groupConditions.every(condition => evaluateQuestionCondition(condition, answers));\n  });\n};\n\nexport const formatAnswer = (question, answer) => {\n  if (answer === null || answer === undefined) {\n    return '';\n  }\n\n  const questionType = (question && question.type) || 'choice';\n\n  if (questionType === 'date') {\n    const parsed = new Date(answer);\n    if (Number.isNaN(parsed.getTime())) {\n      return String(answer);\n    }\n\n    return new Intl.DateTimeFormat('fr-FR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric'\n    }).format(parsed);\n  }\n\n  if (questionType === 'milestone_list') {\n    const entries = Array.isArray(answer) ? answer : [];\n\n    const formattedEntries = entries\n      .map(item => {\n        const rawDate = typeof item?.date === 'string' ? item.date.trim() : '';\n        const rawDescription = typeof item?.description === 'string' ? item.description.trim() : '';\n\n        if (!rawDate && !rawDescription) {\n          return null;\n        }\n\n        let formattedDate = '';\n\n        if (rawDate) {\n          const parsed = new Date(rawDate);\n          formattedDate = Number.isNaN(parsed.getTime())\n            ? rawDate\n            : new Intl.DateTimeFormat('fr-FR', {\n              day: '2-digit',\n              month: '2-digit',\n              year: 'numeric'\n            }).format(parsed);\n        }\n\n        if (formattedDate && rawDescription) {\n          return `${formattedDate} â€” ${rawDescription}`;\n        }\n\n        return formattedDate || rawDescription;\n      })\n      .filter(Boolean);\n\n    return formattedEntries.join('\\n');\n  }\n\n  if (questionType === 'multi_choice' && Array.isArray(answer)) {\n    return answer.join(', ');\n  }\n\n  if (questionType === 'ranking') {\n    const criteria = Array.isArray(question?.rankingConfig?.criteria)\n      ? question.rankingConfig.criteria\n      : [];\n    return formatRankingAnswer(answer, criteria);\n  }\n\n  if (questionType === 'file' && answer && typeof answer === 'object') {\n    const size = typeof answer.size === 'number' ? ` (${Math.round(answer.size / 1024)} Ko)` : '';\n    return `${answer.name || 'Fichier joint'}${size}`;\n  }\n\n  return Array.isArray(answer) ? answer.join(', ') : String(answer);\n};\n\nexport { normalizeAnswerForComparison };\n",
  "src/utils/ranking.js": "const DEFAULT_WEIGHTS = [5, 4, 3, 2, 1];\n\nconst normalizeCriteria = (criteria) => {\n  if (!Array.isArray(criteria)) {\n    return [];\n  }\n\n  return criteria\n    .map(item => ({\n      id: typeof item?.id === 'string' && item.id.trim() !== ''\n        ? item.id.trim()\n        : (typeof item?.label === 'string' ? item.label.trim().toLowerCase().replace(/\\s+/g, '-') : ''),\n      label: typeof item?.label === 'string' ? item.label.trim() : '',\n      description: typeof item?.description === 'string' ? item.description.trim() : ''\n    }))\n    .filter(item => item.id && item.label);\n};\n\nconst normalizeEntries = (entries) => {\n  if (!Array.isArray(entries)) {\n    return [];\n  }\n\n  return entries\n    .map(entry => {\n      const id = typeof entry?.id === 'string' && entry.id.trim() !== ''\n        ? entry.id.trim()\n        : (typeof entry?.name === 'string' ? entry.name.trim().toLowerCase().replace(/\\s+/g, '-') : '');\n\n      const name = typeof entry?.name === 'string' ? entry.name.trim() : '';\n\n      if (!id || !name) {\n        return null;\n      }\n\n      const normalizedScores = {};\n      Object.entries(entry.scores || {}).forEach(([criterionId, score]) => {\n        const parsed = Number(score);\n        normalizedScores[criterionId] = Number.isFinite(parsed) ? Math.max(0, parsed) : 0;\n      });\n\n      return {\n        id,\n        name,\n        scores: normalizedScores,\n        contact: typeof entry?.contact === 'string' ? entry.contact.trim() : '',\n        website: typeof entry?.website === 'string' ? entry.website.trim() : '',\n        notes: typeof entry?.notes === 'string' ? entry.notes.trim() : '',\n        previousProject: typeof entry?.previousProject === 'string' ? entry.previousProject.trim() : '',\n        opinion: typeof entry?.opinionText === 'string'\n          ? entry.opinionText.trim()\n          : (typeof entry?.opinion === 'string' ? entry.opinion.trim() : '')\n      };\n    })\n    .filter(Boolean);\n};\n\nexport const normalizeRankingConfig = (config) => {\n  const title = typeof config?.title === 'string' && config.title.trim() !== ''\n    ? config.title.trim()\n    : 'Base de donnÃ©es';\n\n  const criteria = normalizeCriteria(config?.criteria);\n  const entries = normalizeEntries(config?.entries);\n\n  return { title, criteria, entries };\n};\n\nconst buildWeightMap = (criteriaOrder = []) => {\n  if (!Array.isArray(criteriaOrder)) {\n    return {};\n  }\n\n  const weights = {};\n  criteriaOrder.forEach((criterionId, index) => {\n    const weight = DEFAULT_WEIGHTS[index] ?? Math.max(DEFAULT_WEIGHTS[DEFAULT_WEIGHTS.length - 1] - index + DEFAULT_WEIGHTS.length - 1, 1);\n    weights[criterionId] = weight;\n  });\n  return weights;\n};\n\nconst computeEntryScore = (entry, weightMap, ignoredCriteria) => {\n  if (!entry) {\n    return 0;\n  }\n\n  const ignored = new Set(Array.isArray(ignoredCriteria) ? ignoredCriteria : []);\n\n  return Object.entries(weightMap).reduce((total, [criterionId, weight]) => {\n    if (!criterionId || ignored.has(criterionId)) {\n      return total;\n    }\n\n    const score = Number(entry.scores?.[criterionId]);\n    const sanitizedScore = Number.isFinite(score) ? score : 0;\n    return total + sanitizedScore * weight;\n  }, 0);\n};\n\nexport const computeRankingRecommendations = (answer, config, limit = 3) => {\n  if (!config) {\n    return [];\n  }\n\n  const normalizedConfig = normalizeRankingConfig(config);\n  const criteriaOrder = Array.isArray(answer?.prioritized)\n    ? answer.prioritized.filter(id => normalizedConfig.criteria.some(criterion => criterion.id === id))\n    : [];\n  const ignoredCriteria = Array.isArray(answer?.ignored)\n    ? answer.ignored.filter(id => normalizedConfig.criteria.some(criterion => criterion.id === id))\n    : [];\n\n  if (criteriaOrder.length === 0 && ignoredCriteria.length === 0) {\n    return [];\n  }\n\n  const weightMap = buildWeightMap(criteriaOrder);\n\n  const scoredEntries = normalizedConfig.entries.map(entry => ({\n    ...entry,\n    score: computeEntryScore(entry, weightMap, ignoredCriteria)\n  }));\n\n  const sorted = scoredEntries\n    .filter(entry => entry.score > 0)\n    .sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));\n\n  return sorted.slice(0, Math.max(1, limit)).map(entry => ({\n    id: entry.id,\n    name: entry.name,\n    contact: entry.contact,\n    website: entry.website,\n    notes: entry.notes,\n    previousProject: entry.previousProject,\n    opinion: entry.opinion,\n    score: entry.score,\n    scores: entry.scores\n  }));\n};\n\nexport const formatRankingAnswer = (answer, criteria) => {\n  if (!answer) {\n    return '';\n  }\n\n  const ordered = Array.isArray(answer.prioritized) ? answer.prioritized : [];\n  const ignored = Array.isArray(answer.ignored) ? answer.ignored : [];\n\n  if (ordered.length === 0 && ignored.length === 0) {\n    return '';\n  }\n\n  const criteriaById = new Map((criteria || []).map(item => [item.id, item.label]));\n\n  const priorities = ordered\n    .map(id => criteriaById.get(id))\n    .filter(Boolean)\n    .map((label, index) => `${index + 1}. ${label}`)\n    .join(' \\u2192 ');\n\n  const ignoredLabels = ignored\n    .map(id => criteriaById.get(id))\n    .filter(Boolean);\n\n  if (ignoredLabels.length === 0) {\n    return priorities;\n  }\n\n  return `${priorities} (sans importance : ${ignoredLabels.join(', ')})`;\n};\n",
  "src/utils/richText.js": "import React from '../react.js';\n\nconst URL_REGEX = /(https?:\\/\\/[^\\s<]+)/gi;\nconst TRAILING_PUNCTUATION_REGEX = /[)\\]\\}.,;!?]+$/;\nconst ALLOWED_TAGS = new Set(['b', 'strong', 'i', 'em', 'u', 'p', 'br', 'ul', 'ol', 'li', 'a']);\n\nconst ensureAllowedAnchor = (node) => {\n  if (!node || node.nodeName?.toLowerCase() !== 'a') {\n    return;\n  }\n\n  const href = node.getAttribute('href') || '';\n  const isHttpLink = /^https?:\\/\\//i.test(href);\n\n  if (!isHttpLink) {\n    node.removeAttribute('href');\n  } else {\n    node.setAttribute('href', href);\n  }\n\n  node.setAttribute('target', '_blank');\n  node.setAttribute('rel', 'noopener noreferrer');\n\n  Array.from(node.attributes || []).forEach(attribute => {\n    const name = attribute?.name?.toLowerCase();\n    if (!['href', 'target', 'rel'].includes(name)) {\n      node.removeAttribute(attribute.name);\n    }\n  });\n};\n\nconst linkifyTextNode = (node, documentContext) => {\n  if (!node || node.nodeType !== 3) {\n    return;\n  }\n\n  const textContent = node.textContent || '';\n  const matches = Array.from(textContent.matchAll(URL_REGEX));\n\n  if (matches.length === 0) {\n    return;\n  }\n\n  const fragment = documentContext.createDocumentFragment();\n  let lastIndex = 0;\n\n  matches.forEach(match => {\n    const fullMatch = match[0];\n    const offset = match.index ?? 0;\n\n    if (offset > lastIndex) {\n      fragment.appendChild(documentContext.createTextNode(textContent.slice(lastIndex, offset)));\n    }\n\n    let url = fullMatch;\n    const trailingMatch = url.match(TRAILING_PUNCTUATION_REGEX);\n    let trailing = '';\n\n    if (trailingMatch) {\n      url = url.slice(0, -trailingMatch[0].length);\n      trailing = trailingMatch[0];\n    }\n\n    const anchor = documentContext.createElement('a');\n    anchor.textContent = url;\n    anchor.href = url;\n    anchor.target = '_blank';\n    anchor.rel = 'noopener noreferrer';\n    fragment.appendChild(anchor);\n\n    if (trailing) {\n      fragment.appendChild(documentContext.createTextNode(trailing));\n    }\n\n    lastIndex = offset + fullMatch.length;\n  });\n\n  if (lastIndex < textContent.length) {\n    fragment.appendChild(documentContext.createTextNode(textContent.slice(lastIndex)));\n  }\n\n  node.replaceWith(fragment);\n};\n\nconst sanitizeNode = (node, documentContext) => {\n  if (!node) {\n    return;\n  }\n\n  const nodeType = node.nodeType;\n\n  if (nodeType === 3) {\n    linkifyTextNode(node, documentContext);\n    return;\n  }\n\n  if (nodeType !== 1) {\n    node.remove();\n    return;\n  }\n\n  const tagName = node.nodeName?.toLowerCase();\n\n  if (!ALLOWED_TAGS.has(tagName)) {\n    const parent = node.parentNode;\n    if (!parent) {\n      return;\n    }\n\n    while (node.firstChild) {\n      parent.insertBefore(node.firstChild, node);\n    }\n    parent.removeChild(node);\n    return;\n  }\n\n  if (tagName === 'a') {\n    ensureAllowedAnchor(node);\n  } else {\n    Array.from(node.attributes || []).forEach(attribute => {\n      node.removeAttribute(attribute.name);\n    });\n  }\n\n  Array.from(node.childNodes || []).forEach(child => sanitizeNode(child, documentContext));\n};\n\nexport const sanitizeRichText = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  const trimmed = value.trim();\n  if (trimmed.length === 0) {\n    return '';\n  }\n\n  if (typeof DOMParser === 'undefined' || typeof document === 'undefined') {\n    return trimmed;\n  }\n\n  const parser = new DOMParser();\n  const parsedDocument = parser.parseFromString('<div></div>', 'text/html');\n  const container = parsedDocument.createElement('div');\n  const hasHtmlTags = /<\\/?[a-z][\\s\\S]*>/i.test(trimmed);\n  const normalizedInput = hasHtmlTags\n    ? trimmed\n    : trimmed.replace(/\\r\\n/g, '\\n').split('\\n').join('<br />');\n\n  container.innerHTML = normalizedInput;\n\n  Array.from(container.childNodes || []).forEach(child => sanitizeNode(child, parsedDocument));\n\n  return container.innerHTML;\n};\n\nexport const renderRichText = (value) => {\n  if (typeof value !== 'string' || value.length === 0) {\n    return value;\n  }\n\n  const sanitizedHtml = sanitizeRichText(value);\n\n  if (!sanitizedHtml) {\n    return '';\n  }\n\n  return <span className=\"hv-richtext\" dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />;\n};\n",
  "src/utils/risk.js": "const removeDiacritics = (value) => {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  return value\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .toLowerCase()\n    .trim();\n};\n\nexport const DEFAULT_RISK_WEIGHTING = Object.freeze({\n  low: 1,\n  medium: 3,\n  high: 5\n});\n\nconst sanitizeWeightValue = (value, fallback) => {\n  const parsed = Number(value);\n  if (Number.isFinite(parsed) && parsed >= 0) {\n    return parsed;\n  }\n  return fallback;\n};\n\nexport const normalizeRiskWeighting = (weighting) => {\n  const base = typeof weighting === 'object' && weighting !== null\n    ? weighting\n    : {};\n\n  return {\n    low: sanitizeWeightValue(base.low, DEFAULT_RISK_WEIGHTING.low),\n    medium: sanitizeWeightValue(base.medium, DEFAULT_RISK_WEIGHTING.medium),\n    high: sanitizeWeightValue(base.high, DEFAULT_RISK_WEIGHTING.high)\n  };\n};\n\nexport const getRiskWeightKey = (level) => {\n  const normalized = removeDiacritics(level);\n\n  if (normalized.includes('eleve') || normalized.includes('haut') || normalized.includes('critique')) {\n    return 'high';\n  }\n\n  if (\n    normalized.includes('moyen') ||\n    normalized.includes('modere') ||\n    normalized.includes('moderee') ||\n    normalized.includes('intermediaire')\n  ) {\n    return 'medium';\n  }\n\n  if (normalized.includes('faible') || normalized.includes('bas') || normalized.includes('mineur')) {\n    return 'low';\n  }\n\n  if (normalized.includes('fort')) {\n    return 'high';\n  }\n\n  return 'medium';\n};\n\nexport const getRiskWeightValue = (level, weighting) => {\n  const normalizedWeighting = normalizeRiskWeighting(weighting);\n  const key = getRiskWeightKey(level);\n  return normalizedWeighting[key] ?? normalizedWeighting.low;\n};\n\nexport const computeRiskScore = (risks, weighting) => {\n  const normalizedWeighting = normalizeRiskWeighting(weighting);\n\n  if (!Array.isArray(risks) || risks.length === 0) {\n    return 0;\n  }\n\n  return risks.reduce((total, risk) => {\n    const key = getRiskWeightKey(risk?.level);\n    const weight = normalizedWeighting[key] ?? normalizedWeighting.low;\n    return total + weight;\n  }, 0);\n};\n",
  "src/utils/ruleConditions.js": "import { applyConditionGroups, normalizeConditionGroups } from './conditionGroups.js';\n\nconst toNumber = (value) => {\n  if (value === undefined || value === null || value === '') {\n    return undefined;\n  }\n\n  const parsed = Number(value);\n  return Number.isNaN(parsed) ? undefined : parsed;\n};\n\nexport const sanitizeRuleCondition = (condition = {}) => {\n  const type = condition.type === 'timing' ? 'timing' : 'question';\n\n  if (type === 'timing') {\n    return {\n      type: 'timing',\n      startQuestion: condition.startQuestion || '',\n      endQuestion: condition.endQuestion || '',\n      minimumWeeks: toNumber(condition.minimumWeeks),\n      maximumWeeks: toNumber(condition.maximumWeeks),\n      minimumDays: toNumber(condition.minimumDays),\n      maximumDays: toNumber(condition.maximumDays)\n    };\n  }\n\n  return {\n    type: 'question',\n    question: condition.question || '',\n    operator: condition.operator || 'equals',\n    value: condition.value ?? ''\n  };\n};\n\nexport const normalizeRuleConditionGroups = (entity = {}) => {\n  return normalizeConditionGroups(entity, sanitizeRuleCondition);\n};\n\nexport const applyRuleConditionGroups = (entity = {}, groups = []) => {\n  return applyConditionGroups(entity, groups, sanitizeRuleCondition);\n};\n\nexport const createEmptyQuestionCondition = () => {\n  return sanitizeRuleCondition({\n    type: 'question',\n    question: '',\n    operator: 'equals',\n    value: ''\n  });\n};\n\nexport const createEmptyTimingCondition = () => {\n  return sanitizeRuleCondition({\n    type: 'timing',\n    startQuestion: '',\n    endQuestion: '',\n    minimumWeeks: undefined,\n    maximumWeeks: undefined,\n    minimumDays: undefined,\n    maximumDays: undefined\n  });\n};\n",
  "src/utils/rules.js": "import { normalizeAnswerForComparison } from './questions.js';\nimport { normalizeConditionGroups } from './conditionGroups.js';\nimport { sanitizeRuleCondition } from './ruleConditions.js';\nimport { getRiskWeightKey, normalizeRiskWeighting } from './risk.js';\n\nconst DEFAULT_COMPLEXITY_RULES = [\n  { id: 'default_low', label: 'Faible', minRisks: 0, maxRisks: 1, minScore: 0, maxScore: 1 },\n  { id: 'default_medium', label: 'ModÃ©rÃ©e', minRisks: 2, maxRisks: 3, minScore: 2, maxScore: 3 },\n  { id: 'default_high', label: 'Ã‰levÃ©e', minRisks: 4, maxRisks: null, minScore: 4, maxScore: null }\n];\n\nconst normalizeRiskLevelRules = (rules) => {\n  if (!Array.isArray(rules) || rules.length === 0) {\n    return DEFAULT_COMPLEXITY_RULES;\n  }\n\n  const sanitizeScore = (input, fallback, { allowNull = false } = {}) => {\n    if (allowNull && (input === null || input === undefined || input === '')) {\n      return null;\n    }\n\n    const parsed = Number(input);\n\n    if (!Number.isFinite(parsed)) {\n      return fallback;\n    }\n\n    return parsed < 0 ? 0 : parsed;\n  };\n\n  return rules\n    .map((rule, index) => {\n      const minScore = sanitizeScore(\n        rule?.minScore !== undefined ? rule.minScore : rule?.minRisks,\n        0\n      );\n      const maxScore = sanitizeScore(\n        rule?.maxScore !== undefined ? rule.maxScore : rule?.maxRisks,\n        null,\n        { allowNull: true }\n      );\n\n      return {\n        id: rule?.id || `risk_level_${index + 1}`,\n        label: typeof rule?.label === 'string' && rule.label.trim() !== ''\n          ? rule.label.trim()\n          : `Niveau ${index + 1}`,\n        description: typeof rule?.description === 'string'\n          ? rule.description.trim()\n          : '',\n        minScore,\n        maxScore,\n        minRisks: minScore,\n        maxRisks: maxScore\n      };\n    })\n    .sort((a, b) => {\n      if (a.minScore !== b.minScore) {\n        return a.minScore - b.minScore;\n      }\n\n      const aMax = a.maxScore === null ? Number.POSITIVE_INFINITY : a.maxScore;\n      const bMax = b.maxScore === null ? Number.POSITIVE_INFINITY : b.maxScore;\n\n      if (aMax !== bMax) {\n        return aMax - bMax;\n      }\n\n      return a.id.localeCompare(b.id);\n    });\n};\n\nconst resolveComplexityLevel = (riskScore, riskLevelRules) => {\n  const normalizedRules = normalizeRiskLevelRules(riskLevelRules);\n  const firstRule = normalizedRules[0];\n\n  for (let index = 0; index < normalizedRules.length; index += 1) {\n    const rule = normalizedRules[index];\n    const matchesMinimum = riskScore >= rule.minScore;\n    const matchesMaximum =\n      rule.maxScore === null || rule.maxScore === undefined\n        ? true\n        : riskScore <= rule.maxScore;\n\n    if (matchesMinimum && matchesMaximum) {\n      return { label: rule.label, rule };\n    }\n  }\n\n  const fallback = riskScore < (firstRule?.minScore ?? 0)\n    ? firstRule\n    : normalizedRules[normalizedRules.length - 1];\n  return { label: fallback?.label || 'ModÃ©rÃ©e', rule: fallback || null };\n};\n\nconst toOptionalNonNegativeNumber = (value) => {\n  if (value === undefined || value === null || value === '') {\n    return undefined;\n  }\n\n  const parsed = Number(value);\n  if (Number.isNaN(parsed) || !Number.isFinite(parsed)) {\n    return undefined;\n  }\n\n  return parsed < 0 ? 0 : parsed;\n};\n\nconst sanitizeTimingConstraint = (constraint = {}) => {\n  const enabled = Boolean(constraint?.enabled);\n  const startQuestion = typeof constraint?.startQuestion === 'string' ? constraint.startQuestion : '';\n  const endQuestion = typeof constraint?.endQuestion === 'string' ? constraint.endQuestion : '';\n\n  return {\n    enabled,\n    startQuestion,\n    endQuestion,\n    minimumWeeks: toOptionalNonNegativeNumber(constraint?.minimumWeeks),\n    minimumDays: toOptionalNonNegativeNumber(constraint?.minimumDays)\n  };\n};\n\nconst sanitizeRiskTimingConstraint = (constraint = {}) => sanitizeTimingConstraint(constraint);\n\nconst sanitizeTeamQuestionEntry = (entry) => {\n  if (typeof entry === 'string') {\n    return {\n      text: entry,\n      timingConstraint: sanitizeTimingConstraint()\n    };\n  }\n\n  if (!entry || typeof entry !== 'object') {\n    return {\n      text: '',\n      timingConstraint: sanitizeTimingConstraint()\n    };\n  }\n\n  const { text, timingConstraint, ...rest } = entry;\n\n  return {\n    ...rest,\n    text: typeof text === 'string' ? text : '',\n    timingConstraint: sanitizeTimingConstraint(timingConstraint)\n  };\n};\n\nconst sanitizeTeamQuestionsByTeam = (input) => {\n  if (!input || typeof input !== 'object') {\n    return {};\n  }\n\n  return Object.entries(input).reduce((accumulator, [teamId, questions]) => {\n    if (!teamId) {\n      return accumulator;\n    }\n\n    const entries = Array.isArray(questions)\n      ? questions.map(sanitizeTeamQuestionEntry)\n      : [];\n\n    return { ...accumulator, [teamId]: entries };\n  }, {});\n};\n\nconst matchesCondition = (condition, answers) => {\n  if (!condition || !condition.question) {\n    return true;\n  }\n\n  const rawAnswer = answers[condition.question];\n  if (rawAnswer === null || rawAnswer === undefined || rawAnswer === '') {\n    return false;\n  }\n\n  const answer = normalizeAnswerForComparison(rawAnswer);\n  const operator = condition.operator || 'equals';\n  const expected = condition.value;\n\n  const toNumber = (value) => {\n    if (value === null || value === undefined || value === '') {\n      return null;\n    }\n\n    const parsed = Number(value);\n    return Number.isNaN(parsed) ? null : parsed;\n  };\n\n  switch (operator) {\n    case 'equals':\n      if (Array.isArray(answer)) {\n        return answer.includes(expected);\n      }\n      return answer === expected;\n    case 'not_equals':\n      if (Array.isArray(answer)) {\n        return !answer.includes(expected);\n      }\n      return answer !== expected;\n    case 'contains':\n      if (Array.isArray(answer)) {\n        return answer.includes(expected);\n      }\n      if (typeof answer === 'string') {\n        return answer.toLowerCase().includes(String(expected).toLowerCase());\n      }\n      return false;\n    case 'lt':\n    case 'lte':\n    case 'gt':\n    case 'gte': {\n      if (Array.isArray(answer)) {\n        return false;\n      }\n\n      const answerNumber = toNumber(answer);\n      const expectedNumber = toNumber(expected);\n\n      if (answerNumber === null || expectedNumber === null) {\n        return false;\n      }\n\n      switch (operator) {\n        case 'lt':\n          return answerNumber < expectedNumber;\n        case 'lte':\n          return answerNumber <= expectedNumber;\n        case 'gt':\n          return answerNumber > expectedNumber;\n        case 'gte':\n          return answerNumber >= expectedNumber;\n        default:\n          return false;\n      }\n    }\n    default:\n      return false;\n  }\n};\n\nconst matchesConditionGroup = (conditions, answers, logic = 'all') => {\n  if (!conditions || conditions.length === 0) {\n    return true;\n  }\n\n  const normalizedLogic = logic === 'any' ? 'any' : 'all';\n\n  if (normalizedLogic === 'any') {\n    return conditions.some(condition => matchesCondition(condition, answers));\n  }\n\n  return conditions.every(condition => matchesCondition(condition, answers));\n};\n\nconst computeTimingDiff = (condition, answers) => {\n  if (!condition.startQuestion || !condition.endQuestion) {\n    return null;\n  }\n\n  const startAnswer = answers[condition.startQuestion];\n  const endAnswer = answers[condition.endQuestion];\n\n  if (!startAnswer || !endAnswer) {\n    return null;\n  }\n\n  const startDate = new Date(startAnswer);\n  const endDate = new Date(endAnswer);\n\n  if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {\n    return null;\n  }\n\n  const diffInMs = endDate.getTime() - startDate.getTime();\n  if (diffInMs < 0) {\n    return null;\n  }\n\n  const diffInDays = diffInMs / (1000 * 60 * 60 * 24);\n\n  return {\n    startDate,\n    endDate,\n    diffInDays,\n    diffInWeeks: diffInDays / 7\n  };\n};\n\nconst normalizeTimingRequirement = (value) => {\n  if (value === undefined || value === null || value === '') {\n    return {};\n  }\n\n  if (typeof value === 'number') {\n    return { minimumWeeks: value };\n  }\n\n  if (typeof value === 'string') {\n    const parsed = Number(value);\n    return Number.isNaN(parsed) ? {} : { minimumWeeks: parsed };\n  }\n\n  if (typeof value === 'object') {\n    const result = {};\n\n    if (typeof value.minimumWeeks === 'number') {\n      result.minimumWeeks = value.minimumWeeks;\n    } else if (typeof value.minimumWeeks === 'string' && value.minimumWeeks.trim() !== '') {\n      const parsed = Number(value.minimumWeeks);\n      if (!Number.isNaN(parsed)) {\n        result.minimumWeeks = parsed;\n      }\n    }\n\n    if (typeof value.minimumDays === 'number') {\n      result.minimumDays = value.minimumDays;\n    } else if (typeof value.minimumDays === 'string' && value.minimumDays.trim() !== '') {\n      const parsed = Number(value.minimumDays);\n      if (!Number.isNaN(parsed)) {\n        result.minimumDays = parsed;\n      }\n    }\n\n    return result;\n  }\n\n  return {};\n};\n\nexport const evaluateRule = (rule, answers) => {\n  const timingContexts = [];\n  const conditionGroups = normalizeConditionGroups(rule, sanitizeRuleCondition);\n\n  const evaluateTimingCondition = (condition) => {\n    const diff = computeTimingDiff(condition, answers);\n\n    if (!diff) {\n      timingContexts.push({\n        type: 'timing',\n        diff: null,\n        profiles: [],\n        satisfied: false,\n        startQuestion: condition.startQuestion,\n        endQuestion: condition.endQuestion\n      });\n      return false;\n    }\n\n    const normalizedProfiles = [];\n\n    let satisfied = true;\n\n    normalizedProfiles.forEach(profile => {\n      Object.values(profile.requirements).forEach(requirement => {\n        if (requirement.minimumDays !== undefined && diff.diffInDays < requirement.minimumDays) {\n          satisfied = false;\n        }\n\n        if (requirement.minimumWeeks !== undefined && diff.diffInWeeks < requirement.minimumWeeks) {\n          satisfied = false;\n        }\n      });\n    });\n\n    if (typeof condition.minimumWeeks === 'number' && diff.diffInWeeks < condition.minimumWeeks) {\n      satisfied = false;\n    }\n\n    if (typeof condition.maximumWeeks === 'number' && diff.diffInWeeks > condition.maximumWeeks) {\n      satisfied = false;\n    }\n\n    if (typeof condition.minimumDays === 'number' && diff.diffInDays < condition.minimumDays) {\n      satisfied = false;\n    }\n\n    if (typeof condition.maximumDays === 'number' && diff.diffInDays > condition.maximumDays) {\n      satisfied = false;\n    }\n\n    timingContexts.push({\n      type: 'timing',\n      diff,\n      profiles: normalizedProfiles,\n      satisfied,\n      startQuestion: condition.startQuestion,\n      endQuestion: condition.endQuestion\n    });\n\n    return satisfied;\n  };\n\n  const evaluateSingleCondition = (condition) => {\n    const conditionType = condition.type || 'question';\n\n    if (conditionType === 'timing') {\n      return evaluateTimingCondition(condition);\n    }\n\n    return matchesCondition(condition, answers);\n  };\n\n  const groupResults = conditionGroups.map(group => {\n    const conditions = Array.isArray(group.conditions) ? group.conditions : [];\n    if (conditions.length === 0) {\n      return true;\n    }\n\n    const logic = group.logic === 'any' ? 'any' : 'all';\n    const results = conditions.map(evaluateSingleCondition);\n\n    return logic === 'any' ? results.some(Boolean) : results.every(Boolean);\n  });\n\n  const triggered = conditionGroups.length === 0\n    ? true\n    : groupResults.every(Boolean);\n\n  return { triggered, timingContexts };\n};\n\nexport const analyzeAnswers = (answers, rules, riskLevelRules, riskWeighting) => {\n  const normalizedRiskWeighting = normalizeRiskWeighting(riskWeighting);\n  const evaluations = rules.map(rule => ({ rule, evaluation: evaluateRule(rule, answers) }));\n\n  const teamsSet = new Set();\n  const allQuestions = {};\n  const allRisks = [];\n  const timelineByTeam = {};\n  const timingDetails = [];\n  const vigilanceAlerts = [];\n\n  evaluations.forEach(({ rule, evaluation }) => {\n    if (!evaluation.triggered) {\n      return;\n    }\n\n    rule.teams.forEach(teamId => teamsSet.add(teamId));\n\n    Object.entries(rule.questions).forEach(([teamId, questions]) => {\n      if (!teamId) {\n        return;\n      }\n\n      const entries = Array.isArray(questions)\n        ? questions.map(sanitizeTeamQuestionEntry)\n        : [];\n\n      entries.forEach(entry => {\n        if (!entry) {\n          return;\n        }\n\n        const rawText = typeof entry.text === 'string' ? entry.text : '';\n        const trimmedText = rawText.trim();\n        const timingConstraint = sanitizeTimingConstraint(entry.timingConstraint);\n\n        if (timingConstraint.enabled) {\n          const diff = computeTimingDiff(timingConstraint, answers);\n\n          if (!diff) {\n            return;\n          }\n\n          if (trimmedText.length === 0) {\n            return;\n          }\n\n          const requiredWeeks = typeof timingConstraint.minimumWeeks === 'number'\n            ? timingConstraint.minimumWeeks\n            : undefined;\n          const requiredDays = typeof timingConstraint.minimumDays === 'number'\n            ? timingConstraint.minimumDays\n            : undefined;\n          const meetsWeeks = requiredWeeks === undefined || diff.diffInWeeks >= requiredWeeks;\n          const meetsDays = requiredDays === undefined || diff.diffInDays >= requiredDays;\n\n          if (meetsWeeks && meetsDays) {\n            return;\n          }\n\n          if (!allQuestions[teamId]) {\n            allQuestions[teamId] = [];\n          }\n\n          allQuestions[teamId].push({\n            text: rawText,\n            timingViolation: {\n              startQuestion: timingConstraint.startQuestion,\n              endQuestion: timingConstraint.endQuestion,\n              requiredWeeks,\n              requiredDays,\n              actualWeeks: diff.diffInWeeks,\n              actualDays: diff.diffInDays,\n              meetsWeeks,\n              meetsDays\n            }\n          });\n\n          teamsSet.add(teamId);\n          return;\n        }\n\n        if (trimmedText.length === 0) {\n          return;\n        }\n\n        if (!allQuestions[teamId]) {\n          allQuestions[teamId] = [];\n        }\n\n        allQuestions[teamId].push({ text: rawText, timingViolation: null });\n        teamsSet.add(teamId);\n      });\n    });\n\n    const processedRisks = (Array.isArray(rule.risks) ? rule.risks : [])\n      .map((risk, riskIndex) => {\n        const ruleTeams = Array.isArray(rule.teams) ? rule.teams : [];\n        const preferredTeam = typeof risk?.teamId === 'string' && risk.teamId\n          ? risk.teamId\n          : (ruleTeams[0] || '');\n        const timingConstraint = sanitizeRiskTimingConstraint(risk?.timingConstraint);\n\n          const baseRisk = {\n            ...risk,\n            priority: risk?.priority || 'A rÃ©aliser',\n            teamId: preferredTeam,\n            teams: preferredTeam ? [preferredTeam] : [],\n            ruleId: rule.id,\n            ruleName: rule.name,\n            timingConstraint\n          };\n\n          const weightKey = getRiskWeightKey(baseRisk.level);\n          const weight = normalizedRiskWeighting[weightKey] ?? normalizedRiskWeighting.low;\n          const weightedRisk = { ...baseRisk, weight };\n\n          if (!timingConstraint.enabled) {\n            if (preferredTeam) {\n              teamsSet.add(preferredTeam);\n            }\n            return weightedRisk;\n          }\n\n          const diff = computeTimingDiff(timingConstraint, answers);\n          const requiredWeeks = typeof timingConstraint.minimumWeeks === 'number'\n            ? timingConstraint.minimumWeeks\n            : undefined;\n          const requiredDays = typeof timingConstraint.minimumDays === 'number'\n            ? timingConstraint.minimumDays\n            : undefined;\n\n          const alertId = risk?.id\n            ? `${rule.id}__${risk.id}`\n            : `${rule.id}__risk_${riskIndex}`;\n\n          if (!diff) {\n            vigilanceAlerts.push({\n              id: alertId,\n              ruleId: rule.id,\n              ruleName: rule.name,\n              riskId: risk?.id ?? null,\n              riskDescription: typeof risk?.description === 'string' ? risk.description : '',\n              level: weightedRisk.level,\n              priority: weightedRisk.priority,\n              mitigation: typeof weightedRisk.mitigation === 'string' ? weightedRisk.mitigation : '',\n              teamId: preferredTeam,\n              teams: Array.isArray(weightedRisk.teams) && weightedRisk.teams.length > 0\n                ? weightedRisk.teams\n                : preferredTeam\n                  ? [preferredTeam]\n                  : [],\n              timingConstraint,\n              requiredWeeks,\n              requiredDays,\n              diff: null,\n              status: 'unknown'\n            });\n            return null;\n          }\n\n          const meetsWeeks = requiredWeeks === undefined || diff.diffInWeeks >= requiredWeeks;\n          const meetsDays = requiredDays === undefined || diff.diffInDays >= requiredDays;\n          const satisfied = meetsWeeks && meetsDays;\n\n          vigilanceAlerts.push({\n            id: alertId,\n            ruleId: rule.id,\n            ruleName: rule.name,\n            riskId: risk?.id ?? null,\n            riskDescription: typeof risk?.description === 'string' ? risk.description : '',\n            level: weightedRisk.level,\n            priority: weightedRisk.priority,\n            mitigation: typeof weightedRisk.mitigation === 'string' ? weightedRisk.mitigation : '',\n            teamId: preferredTeam,\n            teams: Array.isArray(weightedRisk.teams) && weightedRisk.teams.length > 0\n              ? weightedRisk.teams\n              : preferredTeam\n                ? [preferredTeam]\n                : [],\n            timingConstraint,\n            requiredWeeks,\n            requiredDays,\n            diff,\n            status: satisfied ? 'satisfied' : 'breach'\n          });\n\n          if (satisfied) {\n            return null;\n          }\n\n          if (preferredTeam) {\n            teamsSet.add(preferredTeam);\n          }\n\n          const timingViolation = {\n            startQuestion: timingConstraint.startQuestion,\n            endQuestion: timingConstraint.endQuestion,\n            requiredWeeks,\n            requiredDays,\n            actualWeeks: diff.diffInWeeks,\n            actualDays: diff.diffInDays,\n            meetsWeeks,\n            meetsDays\n          };\n\n          timingDetails.push({\n            ruleId: rule.id,\n            ruleName: rule.name,\n            riskId: risk?.id ?? null,\n            riskDescription: typeof risk?.description === 'string' ? risk.description : '',\n            satisfied: false,\n            diff,\n            profiles: [],\n            source: 'risk',\n            timingViolation\n          });\n\n          return {\n            ...weightedRisk,\n            timingViolation\n          };\n        })\n      .filter(Boolean);\n\n    allRisks.push(...processedRisks);\n\n    evaluation.timingContexts.forEach(context => {\n      if (!context || !context.diff) {\n        timingDetails.push({\n          ruleId: rule.id,\n          ruleName: rule.name,\n          satisfied: context?.satisfied ?? false,\n          diff: null,\n          profiles: []\n        });\n        return;\n      }\n\n      const { diff } = context;\n      const contextEntry = {\n        ruleId: rule.id,\n        ruleName: rule.name,\n        satisfied: context.satisfied,\n        diff,\n        profiles: context.profiles\n      };\n\n      timingDetails.push(contextEntry);\n\n      context.profiles.forEach(profile => {\n        Object.entries(profile.requirements || {}).forEach(([teamId, requirement]) => {\n          if (!teamId) return;\n\n          const normalized = normalizeTimingRequirement(requirement);\n          const hasRequirement =\n            normalized.minimumWeeks !== undefined || normalized.minimumDays !== undefined;\n\n          if (!hasRequirement) {\n            return;\n          }\n\n          if (!timelineByTeam[teamId]) {\n            timelineByTeam[teamId] = [];\n          }\n\n          const meetsWeeks =\n            normalized.minimumWeeks === undefined || diff.diffInWeeks >= normalized.minimumWeeks;\n          const meetsDays =\n            normalized.minimumDays === undefined || diff.diffInDays >= normalized.minimumDays;\n\n          timelineByTeam[teamId].push({\n            profileId: profile.id,\n            profileLabel: profile.label,\n            description: profile.description,\n            requiredWeeks: normalized.minimumWeeks,\n            requiredDays: normalized.minimumDays,\n            actualWeeks: diff.diffInWeeks,\n            actualDays: diff.diffInDays,\n            satisfied: meetsWeeks && meetsDays\n          });\n        });\n      });\n    });\n  });\n\n  const riskScore = allRisks.reduce((total, risk) => {\n    const contribution = Number.isFinite(risk?.weight) ? risk.weight : 0;\n    return total + contribution;\n  }, 0);\n\n  const { label: complexity, rule: complexityRule } = resolveComplexityLevel(riskScore, riskLevelRules);\n\n  return {\n    triggeredRules: evaluations.filter(({ evaluation }) => evaluation.triggered).map(({ rule }) => rule),\n    teams: Array.from(teamsSet),\n    questions: allQuestions,\n    risks: allRisks,\n    riskScore,\n    timeline: {\n      byTeam: timelineByTeam,\n      details: timingDetails,\n      vigilance: vigilanceAlerts\n    },\n    complexity,\n    complexityRule\n  };\n};\n\nexport {\n  matchesCondition,\n  matchesConditionGroup,\n  computeTimingDiff,\n  normalizeTimingRequirement,\n  sanitizeRiskTimingConstraint,\n  sanitizeTimingConstraint,\n  sanitizeTeamQuestionEntry,\n  sanitizeTeamQuestionsByTeam\n};\n",
  "src/utils/storage.js": "export const STORAGE_KEY = 'complianceNavigatorState';\n// DÃ©sactivation temporaire de la persistance locale.\nconst ENABLE_PERSISTENCE = false;\n\nexport const loadPersistedState = () => {\n  if (\n    !ENABLE_PERSISTENCE ||\n    typeof window === 'undefined' ||\n    !window.localStorage\n  ) {\n    return null;\n  }\n\n  try {\n    const raw = window.localStorage.getItem(STORAGE_KEY);\n    if (!raw) {\n      return null;\n    }\n    return JSON.parse(raw);\n  } catch (error) {\n    console.warn(\"Impossible de charger l'Ã©tat sauvegardÃ© :\", error);\n    return null;\n  }\n};\n\nexport const persistState = (state) => {\n  if (\n    !ENABLE_PERSISTENCE ||\n    typeof window === 'undefined' ||\n    !window.localStorage\n  ) {\n    return;\n  }\n\n  try {\n    window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));\n  } catch (error) {\n    console.warn(\"Impossible de sauvegarder l'Ã©tat :\", error);\n  }\n};\n",
  "src/utils/teamContacts.js": "export const normalizeTeamContacts = (team) => {\n  if (!team) {\n    return [];\n  }\n\n  const rawContacts = Array.isArray(team.contacts)\n    ? team.contacts\n    : Array.isArray(team.contact)\n      ? team.contact\n      : typeof team.contact === 'string'\n        ? team.contact.split(/[,;\\n]/)\n        : [];\n\n  return rawContacts\n    .map((entry) => (typeof entry === 'string' ? entry.trim() : ''))\n    .filter((entry) => entry.length > 0);\n};\n\nexport const formatTeamContacts = (team, separator = ', ') =>\n  normalizeTeamContacts(team).join(separator);\n\nexport const parseTeamContacts = (value) => {\n  if (Array.isArray(value)) {\n    return value\n      .map((entry) => (typeof entry === 'string' ? entry.trim() : ''))\n      .filter((entry) => entry.length > 0);\n  }\n\n  if (typeof value !== 'string') {\n    return [];\n  }\n\n  return value\n    .split(/[,;\\n]/)\n    .map((entry) => entry.trim())\n    .filter((entry) => entry.length > 0);\n};\n",
  "src/utils/validationCommittee.js": "import { normalizeRuleConditionGroups, applyRuleConditionGroups } from './ruleConditions.js';\nimport { evaluateRule } from './rules.js';\n\nexport const DEFAULT_COMMITTEE_ID = 'committee-default';\n\nconst sanitizeTextValue = (value) => (typeof value === 'string' ? value.trim() : '');\n\nconst normalizeEmails = (value) => {\n  if (Array.isArray(value)) {\n    return value\n      .map((entry) => sanitizeTextValue(entry))\n      .filter((entry) => entry.length > 0);\n  }\n\n  if (typeof value === 'string') {\n    return value\n      .split(/[,;\\n]/)\n      .map((entry) => entry.trim())\n      .filter((entry) => entry.length > 0);\n  }\n\n  return [];\n};\n\nconst normalizeRuleTriggers = (value) => {\n  const ruleIds = Array.isArray(value?.ruleIds)\n    ? value.ruleIds.filter((id) => typeof id === 'string' && id.trim().length > 0)\n    : [];\n  const matchMode = value?.matchMode === 'all' ? 'all' : 'any';\n\n  return {\n    matchMode,\n    ruleIds\n  };\n};\n\nconst normalizeRiskTriggers = (value) => {\n  const rawMinRiskScore = value?.minRiskScore;\n  const minRiskScore = rawMinRiskScore === null || rawMinRiskScore === undefined || rawMinRiskScore === ''\n    ? null\n    : Number.isFinite(Number(rawMinRiskScore))\n      ? Math.max(0, Number(rawMinRiskScore))\n      : null;\n\n  return {\n    minRiskScore\n  };\n};\n\nconst normalizeTeamTriggers = (value) => {\n  const rawMinTeamsCount = value?.minTeamsCount;\n  const minTeamsCount = rawMinTeamsCount === null || rawMinTeamsCount === undefined || rawMinTeamsCount === ''\n    ? null\n    : Number.isFinite(Number(rawMinTeamsCount))\n      ? Math.max(1, Number(rawMinTeamsCount))\n      : null;\n\n  return {\n    minTeamsCount\n  };\n};\n\nconst normalizeCommentRequirement = (value) => value !== false;\n\nconst normalizeCommittee = (value = {}, index = 0) => {\n  const id = sanitizeTextValue(value?.id) || `committee-${index + 1}`;\n  const name = sanitizeTextValue(value?.name) || `ComitÃ© ${index + 1}`;\n  const emails = normalizeEmails(value?.emails ?? value?.contacts);\n  const conditionGroups = normalizeRuleConditionGroups(value);\n\n  return applyRuleConditionGroups(\n    {\n      id,\n      name,\n      emails,\n      commentRequired: normalizeCommentRequirement(value?.commentRequired),\n      ruleTriggers: normalizeRuleTriggers(value?.ruleTriggers),\n      riskTriggers: normalizeRiskTriggers(value?.riskTriggers),\n      teamTriggers: normalizeTeamTriggers(value?.teamTriggers)\n    },\n    conditionGroups\n  );\n};\n\nconst buildDefaultCommittee = (value = {}) =>\n  normalizeCommittee(\n    {\n      id: DEFAULT_COMMITTEE_ID,\n      name: 'ComitÃ© de validation',\n      ...value\n    },\n    0\n  );\n\nexport const normalizeValidationCommitteeConfig = (value = {}) => {\n  const hasCommittees = Array.isArray(value?.committees);\n  const committees = hasCommittees\n    ? value.committees.map((committee, index) => normalizeCommittee(committee, index))\n    : [buildDefaultCommittee(value)];\n\n  return {\n    enabled: value?.enabled !== false,\n    committees\n  };\n};\n\nconst getMinimumRiskScore = (risks) => {\n  if (!Array.isArray(risks) || risks.length === 0) {\n    return 0;\n  }\n\n  const weights = risks\n    .map((risk) => (Number.isFinite(risk?.weight) ? risk.weight : null))\n    .filter((weight) => weight !== null);\n\n  if (weights.length === 0) {\n    return 0;\n  }\n\n  return Math.min(...weights);\n};\n\nconst shouldTriggerCommittee = (committee, context = {}) => {\n  const analysis = context?.analysis || {};\n  const answers = context?.answers || {};\n  const relevantTeams = Array.isArray(context?.relevantTeams) ? context.relevantTeams : [];\n  const risks = Array.isArray(analysis?.risks) ? analysis.risks : [];\n  const triggeredRuleIds = Array.isArray(analysis?.triggeredRules)\n    ? analysis.triggeredRules\n        .map((rule) => rule?.id)\n        .filter((id) => typeof id === 'string')\n    : [];\n  const conditionGroups = normalizeRuleConditionGroups(committee);\n  const hasConditionTriggers = conditionGroups.some((group) => group.conditions.length > 0);\n\n  const triggers = [];\n\n  if (committee.ruleTriggers.ruleIds.length > 0) {\n    const ruleMatches = committee.ruleTriggers.ruleIds.map((ruleId) => triggeredRuleIds.includes(ruleId));\n    triggers.push(\n      ruleMatches.some(Boolean)\n    );\n  }\n\n  if (committee.riskTriggers.minRiskScore !== null && committee.riskTriggers.minRiskScore !== undefined) {\n    const minimumRiskScore = getMinimumRiskScore(risks);\n    triggers.push(minimumRiskScore >= committee.riskTriggers.minRiskScore);\n  }\n\n  if (committee.teamTriggers.minTeamsCount) {\n    triggers.push(relevantTeams.length >= committee.teamTriggers.minTeamsCount);\n  }\n\n  if (hasConditionTriggers) {\n    const evaluation = evaluateRule({ ...committee, conditionGroups }, answers);\n    triggers.push(evaluation.triggered);\n  }\n\n  return triggers.some(Boolean);\n};\n\nexport const getTriggeredValidationCommittees = (config, context = {}) => {\n  const normalized = normalizeValidationCommitteeConfig(config);\n  if (!normalized.enabled) {\n    return [];\n  }\n\n  return normalized.committees.filter((committee) => shouldTriggerCommittee(committee, context));\n};\n\nexport const shouldRequireValidationCommittee = (config, context = {}) =>\n  getTriggeredValidationCommittees(config, context).some((committee) => committee.commentRequired);\n"
};
