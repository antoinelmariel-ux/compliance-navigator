const fs = require('fs');
const path = require('path');

const ROOT_DIR = path.resolve(__dirname, '..');
const SRC_DIR = path.join(ROOT_DIR, 'src');
const OUTPUT_FILE = path.join(SRC_DIR, 'module-manifest.js');

const ALLOWED_EXTENSIONS = new Set(['.js', '.jsx']);
const EXCLUDED_SEGMENTS = ['vendor'];
const EXCLUDED_FILES = ['module-manifest.js'];

const isAllowedFile = (filePath) => {
  const ext = path.extname(filePath).toLowerCase();
  return ALLOWED_EXTENSIONS.has(ext);
};

const isExcluded = (filePath) =>
  EXCLUDED_SEGMENTS.some(segment => filePath.split(path.sep).includes(segment));

const listFiles = (dir) => {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  return entries.flatMap(entry => {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      return listFiles(fullPath);
    }
    if (entry.isFile() && isAllowedFile(fullPath) && !isExcluded(fullPath) && !EXCLUDED_FILES.includes(entry.name)) {
      return [fullPath];
    }
    return [];
  });
};

const toRelativeWebPath = (filePath) =>
  path.relative(ROOT_DIR, filePath).split(path.sep).join('/');

const buildManifest = () => {
  const files = listFiles(SRC_DIR);
  const manifest = {};

  files.forEach(filePath => {
    const relativePath = toRelativeWebPath(filePath);
    const source = fs.readFileSync(filePath, 'utf8');
    manifest[relativePath] = source;
  });

  return manifest;
};

const writeManifestFile = (manifest) => {
  const banner = '/* Auto-generated by scripts/generate-module-manifest.js */';
  const content = `${banner}\nwindow.__COMPLIANCE_NAVIGATOR_MANIFEST__ = ${JSON.stringify(manifest, null, 2)};\n`;
  fs.writeFileSync(OUTPUT_FILE, content, 'utf8');
};

const manifest = buildManifest();
writeManifestFile(manifest);

console.log(`Manifest généré avec ${Object.keys(manifest).length} entrées dans ${OUTPUT_FILE}`);
